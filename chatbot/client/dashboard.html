<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>EINFO - √úbungsleiter Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: #0f172a; color: #e2e8f0; }
    
    .header {
      background: #1e293b;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #334155;
    }
    .header h1 { font-size: 1.25rem; }
    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 500;
    }
    .status-badge.active { background: #22c55e; color: #000; }
    .status-badge.inactive { background: #64748b; }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      padding: 1rem;
    }
    
    .card {
      background: #1e293b;
      border-radius: 0.75rem;
      padding: 1rem;
      border: 1px solid #334155;
    }
    .card h2 {
      font-size: 0.875rem;
      color: #94a3b8;
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }
    .stat-item {
      background: #0f172a;
      padding: 0.75rem;
      border-radius: 0.5rem;
      text-align: center;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #38bdf8;
    }
    .stat-label {
      font-size: 0.75rem;
      color: #64748b;
      margin-top: 0.25rem;
    }
    
    .role-list { list-style: none; }
    .role-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      border-radius: 0.375rem;
      margin-bottom: 0.25rem;
    }
    .role-item.active { background: rgba(34, 197, 94, 0.1); }
    .role-item.missing { background: rgba(239, 68, 68, 0.1); }
    .role-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 0.5rem;
    }
    .role-dot.active { background: #22c55e; }
    .role-dot.missing { background: #ef4444; }
    
    .event-log {
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.75rem;
    }
    .event-item {
      padding: 0.375rem 0.5rem;
      border-bottom: 1px solid #334155;
    }
    .event-time { color: #64748b; margin-right: 0.5rem; }
    .event-category { 
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-size: 0.625rem;
      margin-right: 0.5rem;
    }
    .event-category.simulation { background: #3b82f6; }
    .event-category.llm { background: #8b5cf6; }
    .event-category.user { background: #22c55e; }
    .event-category.exercise { background: #f59e0b; }
    
    .btn {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      border: none;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.15s;
    }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-secondary { background: #475569; color: white; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .btn-group { display: flex; gap: 0.5rem; margin-top: 1rem; }
    
    .connected { color: #22c55e; }
    .disconnected { color: #ef4444; }
  </style>
</head>
<body>
  <header class="header">
    <h1>üöí EINFO √úbungsleiter Dashboard</h1>
    <div style="display: flex; align-items: center; gap: 1rem;">
      <span id="sse-status" class="disconnected">‚óè Nicht verbunden</span>
      <span id="exercise-status" class="status-badge inactive">Keine √úbung aktiv</span>
    </div>
  </header>
  
  <main class="grid">
    <!-- √úbungssteuerung -->
    <section class="card">
      <h2>√úbungssteuerung</h2>
      <div id="exercise-info">
        <p style="color: #64748b;">Keine aktive √úbung</p>
      </div>
      <div class="btn-group">
        <button id="btn-start" class="btn btn-primary">√úbung starten</button>
        <button id="btn-pause" class="btn btn-secondary" disabled>Pause</button>
        <button id="btn-end" class="btn btn-danger" disabled>Beenden</button>
      </div>
    </section>
    
    <!-- Live-Statistiken -->
    <section class="card">
      <h2>Live-Statistiken</h2>
      <div class="stat-grid">
        <div class="stat-item">
          <div class="stat-value" id="stat-steps">0</div>
          <div class="stat-label">Sim-Schritte</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-llm">0</div>
          <div class="stat-label">LLM-Aufrufe</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-protocols">0</div>
          <div class="stat-label">Protokolle</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-tasks">0</div>
          <div class="stat-label">Aufgaben</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-incidents">0</div>
          <div class="stat-label">Einsatzstellen</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-duration">0:00</div>
          <div class="stat-label">Dauer</div>
        </div>
      </div>
    </section>
    
    <!-- Rollen-Status -->
    <section class="card">
      <h2>Rollen-Status</h2>
      <ul class="role-list" id="role-list">
        <li class="role-item missing">
          <span><span class="role-dot missing"></span>Lade...</span>
        </li>
      </ul>
    </section>
    
    <!-- Event-Log -->
    <section class="card" style="grid-column: span 2;">
      <h2>Event-Log (Live)</h2>
      <div class="event-log" id="event-log">
        <div class="event-item" style="color: #64748b;">Warte auf Events...</div>
      </div>
    </section>
    
    <!-- Report -->
    <section class="card">
      <h2>Report</h2>
      <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">
        Generiere einen Markdown-Bericht nach √úbungsende.
      </p>
      <button id="btn-report" class="btn btn-secondary" disabled>
        Report generieren
      </button>
    </section>
  </main>

  <script type="module">
    // ============================================================
    // State
    // ============================================================
    let exerciseActive = false;
    let exerciseId = null;
    let statistics = {};
    let eventSource = null;
    let startTime = null;
    let durationInterval = null;

    // ============================================================
    // DOM Elements
    // ============================================================
    const sseStatus = document.getElementById("sse-status");
    const exerciseStatus = document.getElementById("exercise-status");
    const exerciseInfo = document.getElementById("exercise-info");
    const btnStart = document.getElementById("btn-start");
    const btnPause = document.getElementById("btn-pause");
    const btnEnd = document.getElementById("btn-end");
    const btnReport = document.getElementById("btn-report");
    const eventLog = document.getElementById("event-log");
    const roleList = document.getElementById("role-list");

    // Stat elements
    const statSteps = document.getElementById("stat-steps");
    const statLlm = document.getElementById("stat-llm");
    const statProtocols = document.getElementById("stat-protocols");
    const statTasks = document.getElementById("stat-tasks");
    const statIncidents = document.getElementById("stat-incidents");
    const statDuration = document.getElementById("stat-duration");

    // ============================================================
    // SSE Connection
    // ============================================================
    function connectSSE() {
      if (eventSource) {
        eventSource.close();
      }

      eventSource = new EventSource("/api/events");

      eventSource.onopen = () => {
        sseStatus.textContent = "‚óè Verbunden";
        sseStatus.className = "connected";
      };

      eventSource.onerror = () => {
        sseStatus.textContent = "‚óè Nicht verbunden";
        sseStatus.className = "disconnected";
        setTimeout(connectSSE, 5000);
      };

      eventSource.addEventListener("status", (e) => {
        const data = JSON.parse(e.data);
        updateExerciseStatus(data);
      });

      eventSource.addEventListener("exercise_started", (e) => {
        const data = JSON.parse(e.data);
        exerciseActive = true;
        exerciseId = data.exerciseId;
        startTime = Date.now();
        startDurationTimer();
        updateUI();
        addEventToLog("exercise", "√úbung gestartet: " + (data.exerciseName || exerciseId));
      });

      eventSource.addEventListener("exercise_ended", (e) => {
        const data = JSON.parse(e.data);
        exerciseActive = false;
        stopDurationTimer();
        if (data.statistics) {
          statistics = data.statistics;
          updateStats();
        }
        updateUI();
        addEventToLog("exercise", "√úbung beendet");
      });

      eventSource.addEventListener("exercise_paused", () => {
        addEventToLog("exercise", "√úbung pausiert");
      });

      eventSource.addEventListener("exercise_resumed", () => {
        addEventToLog("exercise", "√úbung fortgesetzt");
      });

      // Generic message handler for other events
      eventSource.onmessage = (e) => {
        try {
          const data = JSON.parse(e.data);
          if (data.category) {
            addEventToLog(data.category, data.action || "event");
          }
          if (data.statistics) {
            statistics = data.statistics;
            updateStats();
          }
        } catch {
          // Ignore parse errors
        }
      };
    }

    // ============================================================
    // UI Updates
    // ============================================================
    function updateExerciseStatus(data) {
      exerciseActive = data.active;
      exerciseId = data.exerciseId;
      
      if (data.statistics) {
        statistics = data.statistics;
        updateStats();
      }

      if (data.metadata) {
        exerciseInfo.innerHTML = `
          <p><strong>${data.metadata.exerciseName || "√úbung"}</strong></p>
          <p style="font-size: 0.75rem; color: #64748b;">
            Modus: ${data.metadata.mode || "free"} | 
            Events: ${data.eventCount || 0}
          </p>
        `;
      }

      updateUI();
    }

    function updateUI() {
      if (exerciseActive) {
        exerciseStatus.textContent = "√úbung aktiv";
        exerciseStatus.className = "status-badge active";
        btnStart.disabled = true;
        btnPause.disabled = false;
        btnEnd.disabled = false;
        btnReport.disabled = true;
      } else {
        exerciseStatus.textContent = "Keine √úbung aktiv";
        exerciseStatus.className = "status-badge inactive";
        btnStart.disabled = false;
        btnPause.disabled = true;
        btnEnd.disabled = true;
        btnReport.disabled = statistics.simSteps === 0;
      }
    }

    function updateStats() {
      statSteps.textContent = statistics.simSteps || 0;
      statLlm.textContent = statistics.llmCalls || 0;
      statProtocols.textContent = statistics.protocolsCreated || 0;
      statTasks.textContent = statistics.tasksCreated || 0;
      statIncidents.textContent = statistics.incidentsCreated || 0;
    }

    function addEventToLog(category, message) {
      const time = new Date().toLocaleTimeString("de-DE");
      const item = document.createElement("div");
      item.className = "event-item";
      item.innerHTML = `
        <span class="event-time">${time}</span>
        <span class="event-category ${category}">${category}</span>
        ${message}
      `;
      
      // Remove placeholder if exists
      const placeholder = eventLog.querySelector('[style*="color: #64748b"]');
      if (placeholder) placeholder.remove();
      
      eventLog.insertBefore(item, eventLog.firstChild);
      
      // Limit to 100 entries
      while (eventLog.children.length > 100) {
        eventLog.removeChild(eventLog.lastChild);
      }
    }

    function formatDuration(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      return `${minutes}:${seconds.toString().padStart(2, "0")}`;
    }

    function startDurationTimer() {
      stopDurationTimer();
      durationInterval = setInterval(() => {
        if (startTime) {
          statDuration.textContent = formatDuration(Date.now() - startTime);
        }
      }, 1000);
    }

    function stopDurationTimer() {
      if (durationInterval) {
        clearInterval(durationInterval);
        durationInterval = null;
      }
    }

    // ============================================================
    // API Calls
    // ============================================================
    async function startExercise() {
      const name = prompt("Name der √úbung:", "√úbung " + new Date().toLocaleDateString("de-DE"));
      if (!name) return;

      try {
        const res = await fetch("/api/audit/start", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ exerciseName: name, mode: "free" })
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error);
      } catch (err) {
        alert("Fehler: " + err.message);
      }
    }

    async function pauseExercise() {
      try {
        await fetch("/api/audit/pause", { method: "POST" });
      } catch (err) {
        alert("Fehler: " + err.message);
      }
    }

    async function endExercise() {
      if (!confirm("√úbung wirklich beenden?")) return;
      
      try {
        const res = await fetch("/api/audit/end", { method: "POST" });
        const data = await res.json();
        if (data.ok && data.result) {
          statistics = data.result.statistics || {};
          updateStats();
        }
      } catch (err) {
        alert("Fehler: " + err.message);
      }
    }

    async function generateReport() {
      // Fetch last audit trail and generate markdown
      try {
        const listRes = await fetch("/api/audit/list");
        const listData = await listRes.json();
        
        if (!listData.trails?.length) {
          alert("Keine √úbungsdaten gefunden");
          return;
        }

        const lastTrail = listData.trails[0];
        const trailRes = await fetch(`/api/audit/${lastTrail.exerciseId}`);
        const trailData = await trailRes.json();
        
        if (!trailData.ok) throw new Error("Trail nicht gefunden");

        const trail = trailData.trail;
        const md = generateMarkdownReport(trail);
        
        // Download as file
        const blob = new Blob([md], { type: "text/markdown" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `report_${trail.metadata.exerciseId}.md`;
        a.click();
        URL.revokeObjectURL(url);
        
      } catch (err) {
        alert("Fehler: " + err.message);
      }
    }

    function generateMarkdownReport(trail) {
      const meta = trail.metadata || {};
      const stats = trail.statistics || {};
      const events = trail.events || [];

      let md = `# √úbungsbericht: ${meta.exerciseName || "Unbekannt"}\n\n`;
      md += `**Datum:** ${meta.startedAt ? new Date(meta.startedAt).toLocaleString("de-DE") : "?"}\n`;
      md += `**Ende:** ${meta.endedAt ? new Date(meta.endedAt).toLocaleString("de-DE") : "?"}\n`;
      md += `**Modus:** ${meta.mode || "free"}\n\n`;

      md += `## Statistiken\n\n`;
      md += `| Metrik | Wert |\n`;
      md += `|--------|------|\n`;
      md += `| Simulationsschritte | ${stats.simSteps || 0} |\n`;
      md += `| LLM-Aufrufe | ${stats.llmCalls || 0} |\n`;
      md += `| √ò LLM-Dauer | ${stats.avgLlmDurationMs || 0} ms |\n`;
      md += `| Protokolleintr√§ge | ${stats.protocolsCreated || 0} |\n`;
      md += `| Aufgaben | ${stats.tasksCreated || 0} |\n`;
      md += `| Einsatzstellen | ${stats.incidentsCreated || 0} |\n\n`;

      md += `## Event-Chronologie\n\n`;
      md += `| Zeit | Kategorie | Aktion |\n`;
      md += `|------|-----------|--------|\n`;
      
      for (const event of events.slice(0, 50)) {
        const time = event.timestamp ? new Date(event.timestamp).toLocaleTimeString("de-DE") : "?";
        md += `| ${time} | ${event.category || "?"} | ${event.action || "?"} |\n`;
      }

      if (events.length > 50) {
        md += `\n*... und ${events.length - 50} weitere Events*\n`;
      }

      return md;
    }

    async function loadRoles() {
      try {
        // This would need a roles endpoint - for now show placeholder
        roleList.innerHTML = `
          <li class="role-item active"><span><span class="role-dot active"></span>LdStb</span><span>besetzt</span></li>
          <li class="role-item active"><span><span class="role-dot active"></span>S2</span><span>besetzt</span></li>
          <li class="role-item missing"><span><span class="role-dot missing"></span>S1</span><span>KI</span></li>
          <li class="role-item missing"><span><span class="role-dot missing"></span>S3</span><span>KI</span></li>
          <li class="role-item missing"><span><span class="role-dot missing"></span>S4</span><span>KI</span></li>
          <li class="role-item missing"><span><span class="role-dot missing"></span>S5</span><span>KI</span></li>
          <li class="role-item missing"><span><span class="role-dot missing"></span>S6</span><span>KI</span></li>
        `;
      } catch {
        // Ignore
      }
    }

    // ============================================================
    // Init
    // ============================================================
    btnStart.addEventListener("click", startExercise);
    btnPause.addEventListener("click", pauseExercise);
    btnEnd.addEventListener("click", endExercise);
    btnReport.addEventListener("click", generateReport);

    // Initial load
    connectSSE();
    loadRoles();

    // Fetch initial status
    fetch("/api/audit/status")
      .then(r => r.json())
      .then(data => {
        if (data.ok !== false) {
          updateExerciseStatus(data);
        }
      })
      .catch(() => {});
  </script>
</body>
</html>
