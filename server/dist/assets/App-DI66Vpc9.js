import{u as Ct,j as e,r,a as dn,C as un,b as mn,i as qe,c as Qe,d as hn,e as lt,D as gn,f as pn,g as fn,S as xn,v as bn,h as yn,T as wn,P as vn}from"./index-9_FaDoJ-.js";function ct({cardId:s,vehicle:a,pillWidthPx:i=160,onUnassign:d,onClone:h,near:m=!1,distKm:x=null,readonly:g=!1}){const I=`ass:${s}:${a.id}`,k=g?null:Ct({id:I,data:{type:"assigned",vehicleId:a.id,fromCardId:s}}),O=k?.attributes??{},C=k?.listeners??{},R=k?.setNodeRef??(()=>{}),T=k?.transform??null,B=k?.isDragging??!1,G={width:i,transform:T?`translate3d(${T.x}px, ${T.y}px, 0)`:void 0};return e.jsxs("div",{ref:R,style:G,...O,...C,className:`relative self-start border-2 rounded-2xl bg-white px-2 pr-9 py-1 shadow-sm
                  select-none cursor-grab active:cursor-grabbing
                  ${m?"border-emerald-500 ring-2 ring-emerald-300":"border-red-300"}
                  ${B?"opacity-50":""}`,title:"Ziehen: auf andere Karte verschieben · Doppelklick: klonen",onDoubleClick:()=>{g||h?.(a.id,s)},children:[m&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-0.5 rounded-2xl border-2 border-emerald-400/50 animate-ping"}),e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:a.label||a.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate flex justify-between items-center",children:[e.jsxs("span",{children:[a.ort||"—"," · 👥 ",a.mannschaft??0]}),m&&Number.isFinite(Number(x))&&e.jsxs("span",{className:"absolute top-1 right-8 text-[11px] tabular-nums text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded whitespace-nowrap",children:[Number(x)," Km"]})]}),!g&&e.jsx("button",{type:"button",onMouseDown:q=>q.stopPropagation(),onTouchStart:q=>q.stopPropagation(),onClick:q=>{q.stopPropagation(),d?.(s,a.id)},title:"Einheit entfernen",className:"absolute right-2 top-1/2 -translate-y-1/2 h-6 w-6 rounded-full bg-red-600 text-white shadow flex items-center justify-center","aria-label":"Einheit entfernen",children:e.jsx("svg",{viewBox:"0 0 12 12",width:"12",height:"12","aria-hidden":"true",children:e.jsx("path",{d:"M1 1 L11 11 M11 1 L1 11",stroke:"white",strokeWidth:"2",strokeLinecap:"round"})})})]})}function Nn(s){const{card:a,colId:i,vehiclesById:d,pillWidthPx:h=160,onUnassign:m,onOpenMap:x,onAdvance:g,onEditPersonnelStart:I,editing:k,editingValue:O,setEditingValue:C,onEditPersonnelSave:R,onEditPersonnelCancel:T,onClone:B,onVehiclesIconClick:G,onShowInfo:q,nearIds:V,nearUntilMs:re,distById:N,pulse:E,editable:K=!0}=s,[M,H]=r.useState(i==="in-bearbeitung"),ee=r.useRef((a.assignedVehicles||[]).length),Q=r.useRef(null),J=Date.now()<(re||0),j=K?dn({id:`card:${a.id}`,data:{type:"card",cardId:a.id}}):{attributes:{},listeners:{},setNodeRef:y=>{},transform:null,transition:null,isDragging:!1},{attributes:oe,listeners:L,setNodeRef:me,transform:he,transition:ye,isDragging:p}=j,U={transform:un.Transform.toString(he),transition:ye,opacity:p?.8:1},te=i==="erledigt"?a.everVehicles?.length||0:a.assignedVehicles?.length||0,W=r.useMemo(()=>(a.assignedVehicles||[]).map(y=>d.get(y)).filter(Boolean),[a,d]),z=r.useMemo(()=>i==="erledigt"?Number.isFinite(a?.everPersonnel)?a.everPersonnel:0:Number.isFinite(a?.manualPersonnel)?a.manualPersonnel:W.reduce((y,P)=>y+(P?.mannschaft??0),0),[i,a,W]);r.useEffect(()=>{if(i!=="in-bearbeitung"||!J)return;(a.assignedVehicles||[]).some(P=>V?.has(String(P)))&&H(!0)},[i,J,V,a.assignedVehicles]),r.useEffect(()=>{if(i!=="in-bearbeitung")return;const y=(a.assignedVehicles||[]).length,P=ee.current;y>P&&H(!0),ee.current=y},[i,a.assignedVehicles]),r.useEffect(()=>{if(i==="in-bearbeitung"&&M&&Q.current)try{Q.current.scrollIntoView({behavior:"smooth",block:"nearest"})}catch{}},[i,M]);const ne=()=>{i==="neu"?typeof G=="function"&&G(a,i):(i==="in-bearbeitung"||i==="erledigt")&&H(y=>!y)},Y=()=>{K&&typeof I=="function"&&I(a,z)};return e.jsxs("li",{ref:me,style:U,className:`relative rounded-lg bg-white shadow border transition mx-1
              ${E&&i==="neu"?"ring-2 ring-red-400/60":""}`,children:[E&&i==="neu"&&e.jsxs(e.Fragment,{children:[e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 rounded-lg bg-red-500/10 animate-pulse-inner"}),e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 rounded-lg animate-ping-safe"})]}),e.jsxs("div",{className:"p-3 select-none",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",...oe,...L,children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-semibold text-sm leading-5 truncate",children:a.content}),!!a.ort&&e.jsx("button",{type:"button",onClick:()=>x?.(a.ort),className:"text-[12px] text-blue-700 hover:underline truncate",title:"Ort in Karte öffnen",children:a.ort})]}),e.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[e.jsxs("button",{type:"button",title:i==="neu"?"Nahe Einheiten prüfen":"Einheiten auf-/zuklappen",className:"px-2 py-1 rounded text-[12px] border hover:bg-red-50 flex items-center gap-1",onPointerDown:y=>y.stopPropagation(),onClick:y=>{y.stopPropagation(),y.preventDefault(),ne()},children:["🚒 ",te,(i==="in-bearbeitung"||i==="erledigt")&&e.jsx("span",{children:M?"▾":"▸"})]}),e.jsxs("button",{type:"button",className:"px-2 py-1 rounded text-[12px] border bg-white hover:bg-gray-50",title:"Personalzahl bearbeiten",onPointerDown:y=>y.stopPropagation(),onClick:y=>{y.stopPropagation(),Y()},children:["👥 ",z]}),K&&g&&e.jsx("button",{type:"button",onPointerDown:y=>y.stopPropagation(),onClick:y=>{y.stopPropagation(),g(a)},className:"ml-1 px-2 py-1 rounded text-[12px] border bg-white hover:bg-gray-50",title:"weiter",children:"➔"})]})]}),i==="neu"&&!!W.length&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-1.5",children:W.map(y=>e.jsx(ct,{cardId:a.id,vehicle:y,pillWidthPx:h,onUnassign:m,onClone:B,near:!!V&&J&&V.has(String(y.id)),readonly:!K,distKm:N?.get(String(y.id))??null},`ass-${a.id}-${y.id}`))}),i==="in-bearbeitung"&&M&&!!W.length&&e.jsx("div",{ref:Q,className:"mt-2 flex flex-wrap gap-1.5",children:W.map(y=>e.jsx(ct,{cardId:a.id,vehicle:y,pillWidthPx:h,onUnassign:m,onClone:B,near:!!V&&J&&V.has(String(y.id)),readonly:!K,distKm:N?.get(String(y.id))??null},`ass-${a.id}-${y.id}`))}),i==="erledigt"&&M&&!!a.everVehicles?.length&&e.jsx("ul",{className:"mt-2 text-sm text-gray-700 list-disc list-inside space-y-1",children:a.everVehicles.map(y=>{const P=d.get(y),v=P?.label||P?.id||"Unbekannt",n=P?.ort?` (${P.ort})`:"";return e.jsxs("li",{children:[v,n]},y)})}),K&&k?.cardId===a.id&&e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("input",{type:"number",className:"w-20 border rounded px-2 py-1 text-sm",value:O,onChange:y=>C(y.target.value),placeholder:"Personen"}),e.jsx("button",{className:"px-2 py-1 text-sm rounded bg-emerald-600 text-white",onClick:()=>R(a),children:"Speichern"}),e.jsx("button",{className:"px-2 py-1 text-sm rounded bg-gray-200",onClick:T,children:"Abbrechen"})]}),e.jsxs("div",{className:"mt-2 flex justify-end gap-2",children:[e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Ort in Karte öffnen",onPointerDown:y=>y.stopPropagation(),onClick:y=>{y.stopPropagation(),x?.(a.ort)},children:"Karte"}),e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Einsatz-Info",onPointerDown:y=>y.stopPropagation(),onClick:y=>{y.stopPropagation(),q?.(a)},children:"?"})]})]})]})}function jn({vehicle:s,pillWidthPx:a=160,near:i=!1,distKm:d=null,editable:h=!0}){const m=`veh:${s.id}`,x=h?Ct({id:m,data:{type:"vehicle",vehicleId:s.id}}):null,g=x?.attributes??{},I=x?.listeners??{},k=x?.setNodeRef??(()=>{}),O=x?.transform??null,C=x?.isDragging??!1;return e.jsxs("div",{ref:k,style:{width:a,transform:O?`translate3d(${O.x}px, ${O.y}px, 0)`:void 0},...g,...I,className:`relative max-w-full select-none border-2 ${i?"border-emerald-500":"border-red-300"} rounded-2xl bg-white
                 px-2 py-1 shadow-sm cursor-grab active:cursor-grabbing
                 ${C?"opacity-50":""}`,children:[i&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-0.5 rounded-2xl border-2 border-emerald-400/50 animate-ping"}),e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:s.label||s.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate flex justify-between items-center",children:[e.jsxs("span",{children:[s.ort||"—"," · 👥 ",s.mannschaft??0]}),i&&Number.isFinite(Number(d))&&e.jsxs("span",{className:"absolute top-1 right-1 text-[11px] tabular-nums text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded whitespace-nowrap",children:[Number(d)," Km"]})]})]})}const Sn="";async function ce(s,a,i){const d=await fetch(Sn+a,{method:s,headers:{"Content-Type":"application/json"},body:i===void 0?void 0:JSON.stringify(i),cache:"no-store",credentials:"include"});if(!d.ok)throw new Error(`HTTP ${d.status} ${await d.text().catch(()=>d.statusText)}`);return(d.headers.get("content-type")||"").includes("application/json")?d.json():d.text()}async function le(){return ce("GET","/api/board")}async function dt(){return ce("GET","/api/vehicles")}async function kn(){try{return await ce("GET","/api/types")}catch{return[]}}async function ut(s,a="neu",i=0,d="",h="",m={}){const x={title:s,columnId:a,toIndex:i,ort:d,typ:h};if(m&&typeof m=="object"){const{lat:g,lng:I,latitude:k,longitude:O,...C}=m;Number.isFinite(k)&&(x.latitude=Number(k)),Number.isFinite(O)&&(x.longitude=Number(O)),Number.isFinite(g)&&(x.latitude=Number(g)),Number.isFinite(I)&&(x.longitude=Number(I)),Object.assign(x,C)}return ce("POST","/api/cards",x)}async function De({cardId:s,from:a,to:i,toIndex:d=0}){return ce("POST",`/api/cards/${encodeURIComponent(s)}/move`,{from:a,to:i,toIndex:d})}async function Ge(s,a){return ce("POST",`/api/cards/${encodeURIComponent(s)}/assign`,{vehicleId:a})}async function mt(s,a){return ce("POST",`/api/cards/${encodeURIComponent(s)}/unassign`,{vehicleId:a})}async function In(s,a){return ce("PATCH",`/api/cards/${encodeURIComponent(s)}/personnel`,{manualPersonnel:a})}async function Cn(){return ce("POST","/api/reset",{})}async function En(){return ce("GET","/api/import/auto-config")}async function ht({enabled:s,intervalSec:a}){return ce("POST","/api/import/auto-config",{enabled:s,intervalSec:a})}function Pn(){return"/api/export/pdf"}async function An(s,a){const i=`cardId=${encodeURIComponent(s)}`,h=Number.isFinite(Number(a))&&Number(a)>0?`${i}&radiusKm=${encodeURIComponent(a)}`:i,m=await fetch(`/api/nearby?${h}`,{credentials:"same-origin",cache:"no-store"});if(!m.ok)throw new Error("fetchNearby failed");return m.json()}async function gt(s,a,i,d=null,h="manual"){return ce("PATCH",`/api/vehicles/${encodeURIComponent(s)}/position`,{lat:Number(a),lng:Number(i),incidentId:d,source:h})}async function pt(s){return ce("DELETE",`/api/vehicles/${encodeURIComponent(s)}/position`)}function Tn(s,a){const d=(a.lat-s.lat)*Math.PI/180,h=(a.lng-s.lng)*Math.PI/180,m=Math.sin(d/2)**2+Math.cos(s.lat*Math.PI/180)*Math.cos(a.lat*Math.PI/180)*Math.sin(h/2)**2;return 2*6371*Math.asin(Math.sqrt(m))}function ft(s,a,i){const h=i*Math.PI/180,m=s.lat*Math.PI/180,x=s.lng*Math.PI/180,g=a/6371e3,I=Math.asin(Math.sin(m)*Math.cos(g)+Math.cos(m)*Math.sin(g)*Math.cos(h))*180/Math.PI,k=(x+Math.atan2(Math.sin(h)*Math.sin(g)*Math.cos(m),Math.cos(g)-Math.sin(m)*Math.sin(I*Math.PI/180)))*180/Math.PI;return{lat:I,lng:k}}async function xt(s){if(!s||!window.google?.maps?.Geocoder)return null;const a=new window.google.maps.Geocoder;return new Promise(i=>{a.geocode({address:s,region:"AT"},(d,h)=>{h==="OK"&&d?.[0]?.geometry?.location?i({lat:d[0].geometry.location.lat(),lng:d[0].geometry.location.lng(),formatted:d[0].formatted_address||s}):i(null)})})}const Ee=s=>String(s||"").trim().toLowerCase();async function bt(){try{const s=await fetch("/api/vehicles",{cache:"no-store"});return s.ok?s.json():[]}catch{return[]}}async function yt(){try{const s=await fetch("/api/gps",{cache:"no-store"});if(s.ok)return await s.json()}catch(s){console.error("GPS fetch failed:",s)}return[]}function wt(s){const a=s?.typ||s?.type||"—",i=s?.timestamp?new Date(s.timestamp).toLocaleString("de-AT",{hour12:!1}):"—",d=s?.alerted??"—",h=s?.description??"—",m=s?.additionalAddressInfo||s?.ort||"—",x=[];s?.location&&x.push(String(s.location));const g=Number.isFinite(s?.latitude),I=Number.isFinite(s?.longitude);g&&I&&x.push(`(${s.latitude}, ${s.longitude})`);const k=x.length?x.join(" "):"—";return`
    <div style="min-width:280px">
      <div style="font-weight:700;margin-bottom:4px">${s?.content||"Einsatz"}</div>
      <div><b>Typ:</b> ${a}</div>
      <div><b>Alarmzeit:</b> ${i}</div>
      <div><b>Alarmiert:</b> ${d}</div>
      <div><b>Beschreibung:</b> ${h}</div>
      <div><b>Adresse:</b> ${m}</div>
      <div><b>Location:</b> ${k}</div>
    </div>
  `}const xe=44,vt="/vehicle-red.gif",Mn="/vehicle-gray.png",$n="/vehicle-drive.gif";function Dn({context:s,address:a,onClose:i}){const d=a||s?.card?.ort||s?.address||"",h=!!window.google?.maps,m=r.useRef(null),[x,g]=r.useState(!1),[I,k]=r.useState(""),O=r.useMemo(()=>{const C=s?.card;return C&&Number.isFinite(C?.latitude)&&Number.isFinite(C?.longitude)?{lat:Number(C.latitude),lng:Number(C.longitude)}:null},[s]);if(r.useEffect(()=>{if(!h||!s?.card||!m.current)return;let C=!1,R,T;const B=new Map;let G=null;return(async()=>{try{g(!0),k("");let V=O;if(!V){const p=await xt(s.card.ort);if(C)return;p&&(V={lat:p.lat,lng:p.lng})}if(!V){k("Konnte Einsatz-Position nicht bestimmen.");return}R=new window.google.maps.Map(m.current,{center:V,zoom:18,mapTypeId:"roadmap"}),T=new window.google.maps.InfoWindow;const re=(p,U,te,W,{hover:z=!1}={})=>{const ne={path:"M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z",fillColor:U,fillOpacity:1,strokeColor:"#333",strokeWeight:1,scale:1.2},Y=new window.google.maps.Marker({position:p,map:R,title:te,icon:ne});if(W){const y=()=>{T.setContent(W),T.open(R,Y)};z?(Y.addListener("mouseover",y),Y.addListener("mouseout",()=>T.close())):Y.addListener("click",y)}return Y};re(V,"#d11a1a",s.card.content||"Einsatz",wt(s.card),{hover:!0});const N=[...s?.board?.columns?.neu?.items||[],...s?.board?.columns?.["in-bearbeitung"]?.items||[]],E=new Map;for(const p of N)if(Number.isFinite(p.latitude)&&Number.isFinite(p.longitude))E.set(p.id,{lat:Number(p.latitude),lng:Number(p.longitude)});else if(p.ort){const U=await xt(p.ort);U&&E.set(p.id,{lat:U.lat,lng:U.lng})}for(const p of N){if(p.id===s.card.id)continue;const U=E.get(p.id);U&&re(U,"#1e63d1",p.content||"Einsatz",wt(p),{hover:!0})}const K=new Map;for(const p of N)for(const U of p.assignedVehicles||[])K.set(String(U),p.id);const M=await yt(),H=new Map(M.filter(p=>Number.isFinite(p?.lat)&&Number.isFinite(p?.lng)&&p?.realname).map(p=>[Ee(p.realname),p])),ee=await bt(),Q=new Map(ee.filter(p=>p&&p.source!=="gps"&&Number.isFinite(p.latitude)&&Number.isFinite(p.longitude)).map(p=>[String(p.id),{lat:Number(p.latitude),lng:Number(p.longitude)}])),J=Object.values(s.vehiclesById||{}),j=10,oe=50,L=new Map,me=window.google?.maps?.marker?.AdvancedMarkerElement,he=(p,U,te)=>{if(!p)return Mn;if(!U||!te||!E.has(te))return vt;const W=E.get(te);return Tn(U,W)>.1?$n:vt},ye=(p,U,te,W,z,ne)=>{const Y=he(U,W,z),y=!W;if(me){const P=document.createElement("img");P.src=Y,P.width=xe,P.height=xe,P.alt=te||"",P.decoding="async";const v=new me({map:R,position:p,content:P,title:te});if(y){try{v.draggable=!0}catch{}v.addListener("dragend",async n=>{const l=n?.latLng||v.position,b=typeof l.lat=="function"?l.lat():l.lat,w=typeof l.lng=="function"?l.lng():l.lng;try{await gt(ne,b,w,z,"manual")}catch(_){v.__setPosition(p),console.error("setVehiclePosition failed:",_),alert("Position konnte nicht gespeichert werden.")}})}return v.__setPosition=n=>{v.position=n},v.__setIcon=(n,l,b)=>{P.src=he(n,l,b)},v.__onOver=n=>{P.addEventListener("mouseover",n),P.addEventListener("mouseout",()=>T.close())},v}else{const P=new window.google.maps.Marker({position:p,map:R,title:te,draggable:y,icon:{url:Y,scaledSize:new window.google.maps.Size(xe,xe),anchor:new window.google.maps.Point(xe/2,xe/2)}});return y&&P.addListener("dragend",async v=>{const n=v?.latLng||P.getPosition(),l=typeof n.lat=="function"?n.lat():n.lat,b=typeof n.lng=="function"?n.lng():n.lng;try{await gt(ne,l,b,z,"manual")}catch(w){P.__setPosition(p),console.error("setVehiclePosition failed:",w),alert("Position konnte nicht gespeichert werden.")}}),P.__setPosition=v=>P.setPosition(v),P.__setIcon=(v,n,l)=>P.setIcon({url:he(v,n,l),scaledSize:new window.google.maps.Size(xe,xe),anchor:new window.google.maps.Point(xe/2,xe/2)}),P.__onOver=v=>{P.addListener("mouseover",v),P.addListener("mouseout",()=>T.close())},P}};for(const p of J){const U=String(p.id),te=Ee(`${p?.label||""} ${p?.ort||""}`),W=H.get(te),z=K.get(U);if(!z&&!W)continue;let ne=null,Y=null;if(W)Y={lat:Number(W.lat),lng:Number(W.lng)},ne=Y;else if(Q.has(U))ne=Q.get(U);else if(z&&E.has(z)){const l=E.get(z),w=((L.get(z)||0)+oe)%360;L.set(z,w),ne=ft(l,j,w)}if(!ne)continue;const P=ye(ne,!!z,p.label||p.id,Y,z,U),v=z&&N.find(l=>l.id===z),n=v?`<br/><i>zugeordnet: ${v.content}</i>`:"";P.__onOver(()=>{const l=p?.ort||"";T.setContent(`<div style="min-width:220px"><b>${p.label||p.id}</b>${l?`<br/>${l}`:""}${n}</div>`);const b=me?void 0:P;T.open({map:R,anchor:b,position:ne,shouldFocus:!1})}),B.set(U,P)}R.setCenter(V),R.setZoom(18),G=setInterval(async()=>{const p=await yt(),U=await bt(),te=new Map(U.filter(v=>v&&v.source!=="gps"&&Number.isFinite(v.latitude)&&Number.isFinite(v.longitude)).map(v=>[String(v.id),{lat:Number(v.latitude),lng:Number(v.longitude)}])),W=new Map(p.filter(v=>Number.isFinite(v?.lat)&&Number.isFinite(v?.lng)&&v?.realname).map(v=>[Ee(v.realname),v])),z=new Map;for(const v of[...s?.board?.columns?.neu?.items||[],...s?.board?.columns?.["in-bearbeitung"]?.items||[]])for(const n of v.assignedVehicles||[])z.set(String(n),v.id);const ne=Object.values(s.vehiclesById||{}),Y=new Map;for(const v of ne){const n=String(v.id),l=z.get(n),b=Ee(`${v?.label||""} ${v?.ort||""}`);if(l&&!W.get(b)){const w=Y.get(l)||[];w.push(n),Y.set(l,w)}}for(const[v,n]of Y.entries())n.sort();const y=10,P=50;for(const v of ne){const n=String(v.id),l=B.get(n);if(!l)continue;const b=Ee(`${v?.label||""} ${v?.ort||""}`),w=W.get(b),_=z.get(n);if(w)gpsPos={lat:Number(w.lat),lng:Number(w.lng)},l.__setPosition(gpsPos);else if(te.has(n))l.__setPosition(te.get(n));else if(_&&E.has(_)){const X=((Y.get(_)||[]).indexOf(n)+1)*P%360,ie=E.get(_);l.__setPosition(ft(ie,y,X))}else{const D=B.get(n);D&&(D.setMap?D.setMap(null):D.map&&(D.map=null),B.delete(n));continue}const F=!!_;l.__setIcon(F,gpsPos,_)}},5e3)}catch(V){k(V?.message||"Kartenaufbau fehlgeschlagen.")}finally{g(!1)}})(),()=>{C=!0,G&&clearInterval(G),B.clear()}},[h,s,O]),!h||!s?.card){const C=`https://www.google.com/maps?q=${encodeURIComponent(d)}&output=embed`;return e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:i,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[70vh] p-2",onClick:R=>R.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-semibold text-sm",children:["Karte: ",d]}),e.jsx("button",{className:"px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm",onClick:i,children:"Schließen"})]}),e.jsx("iframe",{title:"maps",className:"w-full h-full rounded-lg border",src:C,loading:"lazy"})]})})}return e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:i,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-5xl h-[75vh] p-2",onClick:C=>C.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-semibold text-sm",children:["Karte: ",s?.card?.content||"Einsatz"," · weitere Einsätze (Neu & In Bearbeitung)"]}),e.jsx("button",{className:"px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm",onClick:i,children:"Schließen"})]}),e.jsx("div",{ref:m,className:"w-full h-full rounded-lg border"}),x&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"px-3 py-1.5 rounded bg-white shadow text-sm",children:"Lade…"})}),!!I&&e.jsx("div",{className:"absolute bottom-3 left-3 px-2 py-1 rounded bg-red-600 text-white text-xs shadow",children:I})]})})}function On({onClose:s,onCreate:a}){const[i,d]=r.useState(""),[h,m]=r.useState(""),[x,g]=r.useState(0),[I,k]=r.useState(!1),[O,C]=r.useState(""),R=async T=>{if(T.preventDefault(),C(""),!i.trim()||!h.trim()){C("Ort und Name sind erforderlich.");return}try{k(!0),await a({ort:i.trim(),label:h.trim(),mannschaft:Number(x)||0}),s()}catch(B){C(B?.message||"Speichern fehlgeschlagen.")}finally{k(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:e.jsxs("form",{onSubmit:R,className:"bg-white rounded-xl shadow-lg p-4 w-[360px] space-y-3",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Einheit anlegen"}),O&&e.jsx("div",{className:"text-sm text-red-600",children:O}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Ort"}),e.jsx("input",{className:"border rounded px-2 py-1 w-full",value:i,onChange:T=>d(T.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Name"}),e.jsx("input",{className:"border rounded px-2 py-1 w-full",value:h,onChange:T=>m(T.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Mannschaft"}),e.jsx("input",{type:"number",min:"0",className:"border rounded px-2 py-1 w-24",value:x,onChange:T=>g(T.target.value)})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:s,className:"px-3 py-1 rounded border",disabled:I,children:"Abbrechen"}),e.jsx("button",{type:"submit",className:"px-3 py-1 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:I,children:I?"Anlegen…":"Anlegen"})]})]})})}let Oe=null;function Et(){const s=document.querySelector('meta[name="google-places-key"]');return(window.GMAPS_API_KEY||s?.content||"").trim()||""}async function Rn(s=Et()){if(window.google?.maps?.places)return!0;if(!s)return!1;if(Oe)return await Oe,!!window.google?.maps?.places;Oe=new Promise((a,i)=>{if(document.getElementById("gmap-places")){const h=()=>{window.google?.maps?.places?a(!0):setTimeout(h,150)};h();return}const d=document.createElement("script");d.id="gmap-places",d.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(s)}&libraries=places&language=de`,d.async=!0,d.defer=!0,d.onload=()=>a(!!window.google?.maps?.places),d.onerror=h=>i(h),document.head.appendChild(d)});try{await Oe}catch{}return!!window.google?.maps?.places}function Pt({debounceMs:s=300,country:a="at",minLength:i=3}={}){const[d,h]=r.useState(""),[m,x]=r.useState([]),[g,I]=r.useState(!1),[k,O]=r.useState(!1),[C,R]=r.useState(null),T=r.useRef(null),B=r.useRef(null),G=r.useRef(null),q=r.useRef(null);r.useEffect(()=>{let M=!1;return(async()=>{const H=await Rn(Et());M||!H||!window.google?.maps?.places||(T.current=new google.maps.places.AutocompleteService,B.current=new google.maps.places.PlacesService(document.createElement("div")),G.current=new google.maps.places.AutocompleteSessionToken,M||O(!0))})(),()=>{M=!0}},[]);const V=r.useCallback(()=>{window.google?.maps?.places&&(G.current=new google.maps.places.AutocompleteSessionToken)},[]),re=r.useRef();r.useEffect(()=>{re.current||(re.current=(M,H)=>{let ee;return(...Q)=>{clearTimeout(ee),ee=setTimeout(()=>M(...Q),H)}})},[]);const N=r.useCallback(async M=>{if(!k||!T.current)return;const H=(M||"").trim();if(!H||H.length<i){x([]);return}I(!0),R(null),T.current.getPlacePredictions({input:H,sessionToken:G.current,componentRestrictions:{country:a},types:["address"]},(ee,Q)=>{if(I(!1),Q!==google.maps.places.PlacesServiceStatus.OK||!ee){x([]),Q&&Q!=="ZERO_RESULTS"&&R(Q);return}x(ee)})},[a,i,k]),E=r.useMemo(()=>re.current?re.current(N,s):()=>{},[N,s]);r.useEffect(()=>{E(d)},[d,E]);const K=r.useCallback((M,H=["formatted_address","geometry","address_components"])=>new Promise((ee,Q)=>{if(!k||!B.current){Q(new Error("Google Places nicht bereit"));return}B.current.getDetails({placeId:M,fields:H,sessionToken:G.current},(J,j)=>{if(j!==google.maps.places.PlacesServiceStatus.OK||!J)return Q(new Error(j||"DETAILS_FAILED"));ee(J)})}),[k]);return{ready:k,query:d,setQuery:h,predictions:m,loading:g,error:C,resetSession:V,getDetailsByPlaceId:K,inputElRef:q}}function Ln({onClose:s,onCreate:a,types:i}){const[d,h]=r.useState(""),[m,x]=r.useState(""),[g,I]=r.useState(!1),k=r.useRef(null),{query:O,setQuery:C,predictions:R,getDetailsByPlaceId:T,resetSession:B,loading:G,error:q}=Pt({country:"at",debounceMs:300,minLength:3});r.useEffect(()=>{setTimeout(()=>k.current?.focus(),0)},[]),r.useEffect(()=>{const N=(m||"").replace(/^T\d+\s*,?\s*/i,"").trim();!d.trim()&&N&&h(N)},[m]);const V=async N=>{N?.preventDefault?.();const E=(m||"").replace(/^T\d+\s*,?\s*/i,"").trim(),K=(d||E).trim();if(K){I(!0);try{await a({title:K,ort:(O||"").trim(),typ:(m||"").trim()}),h(""),C(""),x(""),B(),s?.()}finally{I(!1)}}},re=async N=>{try{const K=(await T(N.place_id,["formatted_address","geometry","address_components","place_id"]))?.formatted_address||N.description;C(K)}catch{C(N.description)}finally{B()}};return e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-3",children:e.jsxs("form",{onSubmit:V,className:"bg-white rounded-xl shadow-lg w-[520px] max-w-full p-4 space-y-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Einsatz anlegen"}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs("select",{ref:k,className:"border rounded px-2 py-1",value:m,onChange:N=>x(N.target.value),children:[e.jsx("option",{value:"",children:"— Typ auswählen —"}),i.map(N=>e.jsx("option",{value:N,children:N},N))]}),e.jsx("input",{className:"border rounded px-2 py-1",placeholder:"Titel (wird aus Typ übernommen)",value:d,onChange:N=>h(N.target.value)}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{className:"border rounded px-2 py-1 w-full",placeholder:"Ort (nur Österreich)",autoComplete:"off",value:O,onChange:N=>C(N.target.value)}),G&&e.jsx("div",{className:"absolute z-10 mt-1 text-xs text-gray-500 bg-white border rounded px-2 py-1",children:"Suche…"}),q&&e.jsxs("div",{className:"absolute z-10 mt-1 text-xs text-red-600 bg-white border rounded px-2 py-1",children:["Fehler: ",String(q)]}),!!R.length&&e.jsx("ul",{className:"absolute z-10 mt-1 w-full max-h-52 overflow-auto bg-white border rounded shadow",children:R.map(N=>e.jsx("li",{className:"px-2 py-1 hover:bg-gray-100 cursor-pointer text-sm",onClick:()=>re(N),title:N.description,children:N.description},N.place_id))})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:s,className:"px-3 py-1 rounded border",disabled:g,children:"Abbrechen"}),e.jsx("button",{className:"px-3 py-1 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:g,children:g?"Anlegen…":"Anlegen"})]})]})})}function _n({colId:s,title:a,bg:i,children:d,editable:h=!0}){if(!h)return e.jsxs("section",{className:`${i} rounded-xl shadow p-3 h-full flex flex-col min-h-0`,children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:a}),d]});const{setNodeRef:m,isOver:x}=mn({id:`col:${s}`,data:{type:"column",colId:s}});return e.jsxs("section",{ref:m,className:`${i} rounded-xl shadow p-3 h-full flex flex-col min-h-0 ${x?"outline outline-2 outline-blue-400":""}`,children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:a}),d]})}function zn({open:s,onClose:a,info:i={}}){if(!s)return null;const d=({label:g,value:I})=>e.jsxs("div",{className:"flex items-start gap-3 py-1",children:[e.jsx("div",{className:"w-32 shrink-0 text-gray-600",children:g}),e.jsx("div",{className:"flex-1 font-medium break-words",children:I??"—"})]}),h=i.timestamp?new Date(i.timestamp).toLocaleString("de-AT",{hour12:!1}):"—",m=[];i.location&&m.push(String(i.location)),Number.isFinite(i.latitude)&&Number.isFinite(i.longitude)&&m.push(`(${i.latitude}, ${i.longitude})`);const x=m.length?m.join(" "):void 0;return e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:a}),e.jsxs("div",{className:"relative z-[101] w-[min(92vw,640px)] rounded-xl bg-white shadow-xl p-4 md:p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg md:text-xl font-bold",children:"Einsatz-Info"}),e.jsx("button",{className:"h-8 w-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center",onClick:a,"aria-label":"Schließen",title:"Schließen",children:e.jsx("svg",{viewBox:"0 0 12 12",width:"14",height:"14","aria-hidden":"true",children:e.jsx("path",{d:"M1 1 L11 11 M11 1 L1 11",stroke:"black",strokeWidth:"2",strokeLinecap:"round"})})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(d,{label:"Typ",value:i.type||i.typ}),e.jsx(d,{label:"Alarmzeit",value:h}),e.jsx(d,{label:"Alarmiert",value:i.alerted}),e.jsx(d,{label:"Beschreibung",value:i.description}),e.jsx(d,{label:"Adresse",value:i.additionalAddressInfo||i.ort}),e.jsx(d,{label:"Location",value:x})]}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx("button",{className:"px-3 py-1.5 rounded-md bg-emerald-600 text-white hover:bg-emerald-700",onClick:a,children:"OK"})})]})]})}let Ze=localStorage.getItem("soundEnabled")==="1",ue=null;const Nt=window.AudioContext||window.webkitAudioContext,We=Nt?new Nt:null;function At(){ue||(ue=new Audio("/sounds/bahnhof.mp3"),ue.preload="auto");const s=async()=>{try{We&&We.state!=="running"&&await We.resume(),ue&&(ue.muted=!0,await ue.play(),ue.pause(),ue.currentTime=0,ue.muted=!1),Ze=!0,localStorage.setItem("soundEnabled","1"),window.removeEventListener("pointerdown",s),window.removeEventListener("keydown",s),window.dispatchEvent(new CustomEvent("sound:unlocked"))}catch{}};Ze||(window.addEventListener("pointerdown",s,{once:!0}),window.addEventListener("keydown",s,{once:!0}))}async function Fn(){if(ue||At(),!Ze){window.dispatchEvent(new CustomEvent("sound:needsUnlock"));return}try{ue.currentTime=0,await ue.play()}catch{}}function Bn(s){const a=(s??"").toString();return a.length>30?a.slice(0,30)+"…":a}function Vn(){const[s,a]=r.useState([]),[i,d]=r.useState(!0),[h,m]=r.useState(!1);r.useEffect(()=>{(async()=>{try{await qe(),m(Qe("protokoll"))}catch{m(!1)}})(),(async()=>{try{const g=await fetch("/api/protocol").then(I=>I.json());a(Array.isArray(g?.items)?g.items:[])}catch{a([])}finally{d(!1)}})()},[]);const x=r.useMemo(()=>[...s].sort((g,I)=>(Number(I.nr)||0)-(Number(g.nr)||0)),[s]);return e.jsxs("div",{className:"p-3 md:p-4 max-w-[1400px] mx-auto h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-3",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:"Protokoll-Übersicht"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("a",{href:"/api/protocol/csv/file",className:"px-3 py-1.5 rounded-md border bg-white",title:"protocol.csv herunterladen",children:"CSV"}),e.jsx("button",{onClick:()=>{h&&(window.location.hash="/protokoll/neu")},className:"px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white",title:h?void 0:"Keine Berechtigung (Meldestelle)",children:"+ Eintrag anlegen"})]})]}),e.jsx("div",{className:"flex-1 overflow-auto border rounded-lg bg-white",children:i?e.jsx("div",{className:"p-4 text-gray-500",children:"Lade…"}):e.jsxs("table",{className:"min-w-[1100px] w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0 z-10",children:e.jsxs("tr",{className:"[&>th]:px-2 [&>th]:py-2 [&>th]:text-left [&>th]:font-semibold border-b",children:[e.jsx("th",{style:{width:28},title:"Druckstatus"}),e.jsx("th",{style:{width:60},children:"NR"}),e.jsx("th",{style:{width:110},children:"Datum"}),e.jsx("th",{style:{width:80},children:"Zeit"}),e.jsx("th",{style:{width:120},children:"Kanal"}),e.jsx("th",{style:{width:110},children:"Richtung"}),e.jsx("th",{style:{width:160},children:"An/Von"}),e.jsx("th",{children:"Information"}),e.jsx("th",{style:{width:260},children:"Meldungstyp"})]})}),e.jsxs("tbody",{className:"[&>tr>td]:px-2 [&>tr>td]:py-2",children:[x.map(g=>{const I=g?.uebermittlungsart||{},k=I.kanal??I.kanalNr??I.art??"",C=[].concat(I.ein?"Eingang":[]).concat(I.aus?"Ausgang":[]).join(" / "),R=Number(g?.printCount)>0;return e.jsxs("tr",{className:"border-b align-top hover:bg-gray-50 cursor-pointer",onClick:()=>{window.location.hash=`/protokoll/edit/${g.nr}`},title:"Zum Bearbeiten öffnen",children:[e.jsx("td",{className:"align-middle",children:R?e.jsx("span",{className:"inline-block w-3 h-3 rounded-full bg-yellow-400",title:`Gedruckt (${g.printCount})`}):null}),e.jsx("td",{className:"font-semibold",children:g.nr}),e.jsx("td",{children:g.datum}),e.jsx("td",{children:g.zeit}),e.jsx("td",{title:k,children:k}),e.jsx("td",{title:C,children:C}),e.jsx("td",{children:g.anvon}),e.jsx("td",{className:"whitespace-pre-wrap",children:Bn(g.information)}),e.jsx("td",{className:"whitespace-pre-wrap",children:g.infoTyp||"—"})]},g.nr)}),!x.length&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"p-4 text-gray-500 italic",children:"— keine Einträge —"})})]})]})})]})}const Je=["EL","LtStb","S1","S2","S3","S4","S5","S6"],be={anvon:"prot_sugg_anvon",kanal:"prot_sugg_kanalNr",verantwortlich:"prot_sugg_ver"};function He(s,a=12){const i=new Set,d=[];for(const h of s){const m=String(h||"").trim();if(!(!m||i.has(m))&&(i.add(m),d.push(m),d.length>=a))break}return d}function jt(s){let a=String(s||"").trim();if(!a)return a;const i=a.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})$/);if(i){const h=i[1].padStart(2,"0"),m=i[2].padStart(2,"0");return`${i[3].length===2?"20"+i[3]:i[3]}-${m}-${h}`}const d=a.match(/^(\d{1,2})(\d{1,2})(\d{2,4})$/);if(d){const h=d[1].padStart(2,"0"),m=d[2].padStart(2,"0");return`${d[3].length===2?"20"+d[3]:d[3].padStart(4,"20")}-${m}-${h}`}return a}function St(s){let a=String(s||"").trim();if(!a)return a;const i=a.match(/^(\d{1,2})(\d{2})$/);if(i)return`${i[1].padStart(2,"0")}:${i[2]}`;const d=a.match(/^(\d{1,2})[:.](\d{1,2})$/);return d?`${d[1].padStart(2,"0")}:${d[2].padStart(2,"0")}`:a}const kt=()=>({datum:new Date().toISOString().slice(0,10),zeit:new Date().toTimeString().slice(0,5),uebermittlungsart:{richtung:"",kanalNr:""},anvon:{richtung:"an",name:""},infoTyp:"Information",information:"",rueckmeldung1:"",rueckmeldung2:"",ergehtAn:[],ergehtAnText:"",lagebericht:"",massnahmen:Array.from({length:5},()=>({massnahme:"",verantwortlich:"",done:!1}))});function It({mode:s="create",editNr:a=null}){const[i,d]=r.useState(!1);r.useEffect(()=>{let n=!0;return(async()=>{try{if(await qe(),!n)return;d(Qe("protokoll"))}catch{if(!n)return;d(!1)}})(),()=>{n=!1}},[]);const[h,m]=r.useState(()=>{const n=Number(a);return Number.isFinite(n)&&n>0?n:null}),x=Number.isFinite(Number(h))&&Number(h)>0,[g,I]=r.useState(x),[k,O]=r.useState(!1),[C,R]=r.useState(null),T=r.useRef(null),B=r.useRef(null),G=r.useRef(!1),q=r.useRef(null),[V,re]=r.useState(null),N=r.useRef(null),E=(n,l,b=2200)=>{re({type:n,text:l}),N.current&&clearTimeout(N.current),N.current=setTimeout(()=>re(null),b)},[K,M]=r.useState([]),[H,ee]=r.useState([]),[Q,J]=r.useState([]);r.useEffect(()=>{try{M(JSON.parse(localStorage.getItem(be.anvon)||"[]")),ee(JSON.parse(localStorage.getItem(be.kanal)||"[]")),J(JSON.parse(localStorage.getItem(be.verantwortlich)||"[]"))}catch{}},[]);const[j,oe]=r.useState(kt()),L=(n,l)=>{const b=Array.isArray(n)?n:String(n).split(".");oe(w=>{const _=structuredClone(w);let F=_;for(let D=0;D<b.length-1;D++)F=F[b[D]];return F[b.at(-1)]=l,_})};r.useEffect(()=>{if(!x){I(!1),setTimeout(()=>B.current?.focus(),0);return}const n=Number(h);!Number.isFinite(n)||n<=0||(async()=>{try{const l=await fetch(`/api/protocol/${n}`).then(b=>b.json());if(l?.ok&&l.item){const b=l.item,w=b.uebermittlungsart||{};let _="",F=b.anvon||"";const D=(b.anvon||"").trim();/^an\s*:/i.test(D)&&(_="an",F=D.replace(/^an\s*:/i,"").trim()),/^von\s*:/i.test(D)&&(_="von",F=D.replace(/^von\s*:/i,"").trim()),oe({datum:b.datum||"",zeit:b.zeit||"",uebermittlungsart:{richtung:w.ein?"ein":w.aus?"aus":"",kanalNr:w.kanalNr||""},anvon:{richtung:_||"an",name:F},infoTyp:b.infoTyp||"Information",information:b.information||"",rueckmeldung1:b.rueckmeldung1||"",rueckmeldung2:b.rueckmeldung2||"",ergehtAn:Array.isArray(b.ergehtAn)?b.ergehtAn:[],ergehtAnText:b.ergehtAnText||"",lagebericht:b.lagebericht||"",massnahmen:Array.from({length:5},(Z,X)=>{const ie=b.massnahmen?.[X]||{};return{massnahme:ie.massnahme||"",verantwortlich:ie.verantwortlich||"",done:!!ie.done}})}),R(b.id||null),setTimeout(()=>B.current?.focus(),0)}}finally{I(!1)}})()},[x,h]),r.useEffect(()=>{const n=()=>{const w=document.activeElement;w&&typeof w.blur=="function"&&w.blur()},l=w=>setTimeout(w,0),b=w=>{if(w.repeat)return;const _=(w.key||"").toLowerCase(),F=w.ctrlKey||w.metaKey;if(F&&!w.shiftKey&&_==="s"){if(w.preventDefault(),w.stopPropagation(),!i){E?.("error","Keine Berechtigung (Meldestelle)");return}if(G.current)return;G.current=!0,l(async()=>{n(),await new Promise(D=>setTimeout(D,0)),z().finally(()=>G.current=!1)});return}if(F&&(w.shiftKey&&_==="s"||_==="enter")){if(w.preventDefault(),w.stopPropagation(),!i){E?.("error","Keine Berechtigung (Meldestelle)");return}if(G.current)return;G.current=!0,l(async()=>{n(),await new Promise(D=>setTimeout(D,0)),ne().finally(()=>G.current=!1)});return}_==="escape"&&(w.preventDefault(),w.stopPropagation(),l(()=>te()))};return window.addEventListener("keydown",b,!0),document.addEventListener("keydown",b,!0),()=>{window.removeEventListener("keydown",b,!0),document.removeEventListener("keydown",b,!0)}},[]);const[me,he]=r.useState(!1),ye=r.useRef(null);function p(){const n=Array.isArray(j?.ergehtAn)?[...j.ergehtAn]:[],l=(j?.ergehtAnText||"").trim();return l&&n.push(l),n}const U=async()=>{if(!i){E?.("error","Keine Berechtigung zum Drucken/Speichern");return}if(me)return;const n=p();if(!n.length){E?.("error","Bitte Empfänger wählen oder 'Sonstiger Empfänger' ausfüllen.");return}he(!0);try{const l=await W();if(!l)throw new Error("Speichern fehlgeschlagen");m(l);const w=(await fetch(`/api/protocol/${l}`).then(X=>X.json()))?.item;if(!w)throw new Error("Datensatz für Druck nicht gefunden");E?.("info","PDF wird serverseitig erzeugt …");const _=await fetch(`/api/protocol/${l}/print`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({recipients:n,data:w})}).then(X=>X.json());if(!_?.ok||!_?.fileUrl)throw new Error(_?.error||"PDF-Erzeugung fehlgeschlagen");let F=ye.current;F||(F=document.createElement("iframe"),F.style.position="fixed",F.style.width="0",F.style.height="0",F.style.border="0",F.style.visibility="hidden",document.body.appendChild(F),ye.current=F);const D=`${_.fileUrl}#toolbar=0&navpanes=0&scrollbar=0`;F.onload=()=>{try{setTimeout(()=>{F.contentWindow?.focus(),F.contentWindow?.print()},100)}catch{window.open(D,"_blank","noopener,noreferrer")?.focus()}},F.src=D;const Z=Number(_?.pages)||n.length;E?.("success",`Druck gestartet (${Z} Seite${Z>1?"n":""})`)}catch(l){E?.("error",`Drucken fehlgeschlagen: ${l.message||l}`)}finally{he(!1)}},te=()=>{window.location.hash="/protokoll"},W=async()=>{const n=q.current?new FormData(q.current):null,l=structuredClone(j);l.datum=jt(n?.get("datum")||j.datum),l.zeit=St(n?.get("zeit")||j.zeit);const b=(n?.get("anvonDir")||j.anvon.richtung||"").toString(),w=(n?.get("anvonName")||j.anvon.name||"").toString();l.anvon={richtung:b,name:w};const _=(n?.get("richtung")||j.uebermittlungsart.richtung||"").toString();l.uebermittlungsart.richtung=_,l.uebermittlungsart.kanalNr=(n?.get("kanalNr")||j.uebermittlungsart.kanalNr||"").toString(),l.information=(n?.get("information")||j.information||"").toString(),l.rueckmeldung1=(n?.get("rueckmeldung1")||j.rueckmeldung1||"").toString(),l.rueckmeldung2=(n?.get("rueckmeldung2")||j.rueckmeldung2||"").toString(),l.ergehtAnText=(n?.get("ergehtAnText")||j.ergehtAnText||"").toString(),l.infoTyp=(n?.get("infoTyp")||j.infoTyp||"Information").toString();const F=n?Array.from(n.getAll("ergehtAn")).map(String):j.ergehtAn;l.ergehtAn=F.length?F:j.ergehtAn,l.massnahmen=l.massnahmen.map((Z,X)=>{const ie=n?n.get(`m_done_${X}`)!==null:Z.done;return{massnahme:(n?.get(`m_massnahme_${X}`)||Z.massnahme||"").toString(),verantwortlich:(n?.get(`m_verantwortlich_${X}`)||Z.verantwortlich||"").toString(),done:!!ie}});const D={...l,uebermittlungsart:{kanalNr:(l.uebermittlungsart.kanalNr||"").trim(),ein:l.uebermittlungsart.richtung==="ein",aus:l.uebermittlungsart.richtung==="aus"},anvon:l.anvon.richtung?`${l.anvon.richtung==="an"?"An":"Von"}: ${l.anvon.name}`.trim():l.anvon.name.trim()};try{const Z=He([D.anvon,...JSON.parse(localStorage.getItem(be.anvon)||"[]")]),X=He([D.uebermittlungsart.kanalNr,...JSON.parse(localStorage.getItem(be.kanal)||"[]")]),ie=[...l.massnahmen.map(Re=>Re.verantwortlich).filter(Boolean),...JSON.parse(localStorage.getItem(be.verantwortlich)||"[]")],Ie=He(ie);localStorage.setItem(be.anvon,JSON.stringify(Z)),localStorage.setItem(be.kanal,JSON.stringify(X)),localStorage.setItem(be.verantwortlich,JSON.stringify(Ie)),M(Z),ee(X),J(Ie)}catch{}if(x){const Z=await fetch(`/api/protocol/${h}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(D)}).then(X=>X.json());if(!Z?.ok)throw new Error(Z?.error||"Speichern fehlgeschlagen");return m(Z.nr),R(Z.id||C||null),Z.nr}else{const Z=await fetch("/api/protocol",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(D)}).then(X=>X.json());if(!Z?.ok)throw new Error(Z?.error||"Speichern fehlgeschlagen");return m(Z.nr),R(Z.id||null),Z.nr}},z=async()=>{if(!i){E?.("error","Keine Berechtigung (Meldestelle)");return}if(!k){O(!0);try{await W()&&(window.location.hash="/protokoll")}catch(n){E("error","Fehler beim Speichern: "+n.message,4e3)}finally{O(!1)}}},ne=async()=>{if(!i){E?.("error","Keine Berechtigung (Meldestelle)");return}if(!k){O(!0);try{const n=await W();n&&(E("success",`Gespeichert (NR ${n}) – neuer Eintrag`),oe(kt()),m(null),R(null),setTimeout(()=>B.current?.focus(),0))}catch(n){E("error","Fehler beim Speichern: "+n.message,4e3)}finally{O(!1)}}},Y=n=>{const l=(n.key||"").toLowerCase(),b=n.ctrlKey||n.metaKey;n.repeat||(b&&!n.shiftKey&&l==="s"?(n.preventDefault(),n.stopPropagation(),z()):b&&(n.shiftKey&&l==="s"||l==="enter")&&(n.preventDefault(),n.stopPropagation(),ne()))},y=n=>{if(n.preventDefault(),!i){E?.("error","Keine Berechtigung (Meldestelle)");return}z()};if(g)return e.jsx("div",{className:"p-4",children:"Lade…"});const P=Je.every(n=>j.ergehtAn.includes(n)),v=n=>L("ergehtAn",n?[...Je]:[]);return e.jsxs("div",{className:"mx-auto w-full max-w-[1100px] relative",children:[e.jsx("div",{className:"prot-actionbar sticky top-0 z-30 -mx-2 md:mx-0 px-2 md:px-0",children:e.jsxs("div",{className:"bg-white/95 backdrop-blur border-b rounded-t-xl px-3 py-2 flex items-center justify-between shadow-sm",children:[e.jsx("div",{className:"text-sm font-semibold",children:x?`Protokoll – Bearbeiten (NR ${h??"—"})`:"Protokoll – Neuer Eintrag"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:te,className:"px-3 py-1.5 rounded-md border",title:"Maske schließen und zur Übersicht wechseln (ESC)",children:"Abbrechen"}),e.jsx("button",{type:"button",onClick:ne,disabled:k,className:"px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white disabled:opacity-60",title:"Speichern und neue Maske (Strg+Shift+S oder Strg+Enter)",children:"Speichern/Neu"}),e.jsx("button",{type:"button",onClick:z,disabled:k,className:"px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-60",title:"Speichern und schließen (Strg+S)",children:k?"Speichern…":"Speichern"}),e.jsx("button",{type:"button",onClick:U,disabled:me,className:"px-3 py-1.5 rounded-md border bg-white hover:bg-gray-50 disabled:opacity-60",title:"Formular drucken – Anzahl gemäß 'ergeht an' + 'Sonstiger Empfänger'",children:me?"Drucken…":"Drucken"})]})]})}),V&&e.jsx("div",{className:"fixed right-3 top-3 z-40",children:e.jsx("div",{className:"px-3 py-2 rounded shadow text-white "+(V.type==="success"?"bg-emerald-600":V.type==="error"?"bg-rose-600":"bg-slate-600"),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{children:V.text}),e.jsx("button",{className:"opacity-80 hover:opacity-100",onClick:()=>re(null),title:"Meldung schließen",children:"✕"})]})})}),e.jsx("style",{children:`
        @media print {
          * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          .prot-actionbar { display: none !important; }
          html, body { margin: 0 !important; }
          @page { size: A4; margin: 12mm; }
        }
      `}),e.jsxs("form",{ref:q,onKeyDown:Y,onSubmit:y,className:"bg-white border-2 rounded-b-xl overflow-hidden shadow",children:[e.jsxs("div",{className:"grid grid-cols-12",children:[e.jsx("div",{className:"col-span-9 p-6 border-b-2",children:e.jsx("div",{className:"text-3xl font-extrabold tracking-wide",children:"MELDUNG/INFORMATION"})}),e.jsxs("div",{className:"col-span-3 border-l-2",children:[e.jsx("div",{className:"p-3 text-xs text-gray-600 border-b-2",children:"PROTOKOLL-NR"}),e.jsx("div",{className:"p-6 text-center text-4xl font-bold",children:h??"—"})]}),e.jsx("div",{className:"col-span-12 border-y-2 p-2",children:e.jsxs("div",{className:"grid grid-cols-12 gap-0",children:[e.jsxs("div",{className:"col-span-6 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Datum"}),e.jsx("input",{name:"datum",type:"text",className:"border rounded px-2 h-9 w-full",placeholder:"yyyy-mm-dd",value:j.datum,onChange:n=>L("datum",n.target.value),onBlur:n=>L("datum",jt(n.target.value)),title:"Datum (auch 101025 oder 10.10.2025 möglich)"})]}),e.jsxs("div",{className:"col-span-3 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Uhrzeit"}),e.jsx("input",{name:"zeit",type:"text",className:"border rounded px-2 h-9 w-full",placeholder:"hh:mm",value:j.zeit,onChange:n=>L("zeit",n.target.value),onBlur:n=>L("zeit",St(n.target.value)),title:"Uhrzeit (915, 09:15 oder 0915 möglich)"})]}),e.jsxs("div",{className:"col-span-3 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Typ"}),e.jsxs("div",{className:"grid grid-cols-3 gap-x-6 h-9 items-center",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{ref:B,type:"radio",name:"infoTyp",value:"Information",checked:j.infoTyp==="Information",onChange:()=>L("infoTyp","Information")}),e.jsx("span",{children:"Info"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"infoTyp",value:"Auftrag",checked:j.infoTyp==="Auftrag",onChange:()=>L("infoTyp","Auftrag")}),e.jsx("span",{children:"Auftrag"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"infoTyp",value:"Lagemeldung",checked:j.infoTyp==="Lagemeldung",onChange:()=>L("infoTyp","Lagemeldung")}),e.jsx("span",{children:"Lage"})]})]})]})]})}),e.jsx("div",{className:"col-span-12 border-y-2 p-2",children:e.jsxs("div",{className:"grid grid-cols-12 gap-0 items-end",children:[e.jsxs("div",{className:"col-span-6 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"An/Von"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{ref:T,name:"anvonName",className:"border rounded px-2 h-9 w-full flex-1",placeholder:"Name / Stelle",list:"dl-anvon",value:j.anvon.name,onChange:n=>{let l=n.target.value;const b=l.trim();/^an\s*:/i.test(b)?(L(["anvon","richtung"],"an"),l=b.replace(/^an\s*:/i,"").trim()):/^von\s*:/i.test(b)&&(L(["anvon","richtung"],"von"),l=b.replace(/^von\s*:/i,"").trim()),L(["anvon","name"],l)},title:'Optional mit Präfix "an: …" oder "von: …"'}),e.jsxs("div",{className:"flex items-center gap-4 pl-2 min-w-[140px] shrink-0",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"anvonDir",value:"an",checked:j.anvon.richtung==="an",onChange:()=>L(["anvon","richtung"],"an")}),e.jsx("span",{children:"An"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"anvonDir",value:"von",checked:j.anvon.richtung==="von",onChange:()=>L(["anvon","richtung"],"von")}),e.jsx("span",{children:"Von"})]})]})]}),e.jsx("datalist",{id:"dl-anvon",children:K.map(n=>e.jsx("option",{value:n},n))})]}),e.jsxs("div",{className:"col-span-3 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Kanal"}),e.jsx("input",{name:"kanalNr",className:"border rounded px-2 h-9 w-full",list:"dl-kanal",value:j.uebermittlungsart.kanalNr,onChange:n=>L(["uebermittlungsart","kanalNr"],n.target.value),title:"z. B. Funkkanal, Telefonnummer, E-Mail-Kürzel …"}),e.jsx("datalist",{id:"dl-kanal",children:H.map(n=>e.jsx("option",{value:n},n))})]}),e.jsxs("div",{className:"col-span-3 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Richtung"}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-6 h-9 items-center",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",title:"Meldung wurde empfangen",children:[e.jsx("input",{type:"radio",name:"richtung",value:"ein",checked:j.uebermittlungsart.richtung==="ein",onChange:()=>L(["uebermittlungsart","richtung"],"ein")}),e.jsx("span",{children:"Eingang"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",title:"Meldung wurde gesendet",children:[e.jsx("input",{type:"radio",name:"richtung",value:"aus",checked:j.uebermittlungsart.richtung==="aus",onChange:()=>L(["uebermittlungsart","richtung"],"aus")}),e.jsx("span",{children:"Ausgang"})]})]})]})]})}),e.jsxs("div",{className:"col-span-12 border-y-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Information/Auftrag"}),e.jsx("textarea",{name:"information",className:"border rounded px-2 py-2 w-full min-h-[160px]",value:j.information,onChange:n=>L("information",n.target.value),title:"Sachverhalt / Meldetext"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Rückmeldung 1"}),e.jsx("input",{name:"rueckmeldung1",className:"border rounded px-2 h-9 w-full",value:j.rueckmeldung1,onChange:n=>L("rueckmeldung1",n.target.value),title:"erste Rückmeldung"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Rückmeldung 2"}),e.jsx("input",{name:"rueckmeldung2",className:"border rounded px-2 h-9 w-full",value:j.rueckmeldung2,onChange:n=>L("rueckmeldung2",n.target.value),title:"zweite Rückmeldung"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-2",children:"ergeht an:"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 mr-3",title:"Alle Empfänger auswählen / abwählen",children:[e.jsx("input",{type:"checkbox",checked:P,onChange:n=>v(n.target.checked)}),e.jsx("span",{children:"Alle"})]}),Je.map(n=>e.jsxs("label",{className:"inline-flex items-center gap-2 mr-3",children:[e.jsx("input",{tabIndex:-1,type:"checkbox",name:"ergehtAn",value:n,checked:j.ergehtAn.includes(n),onChange:()=>{const l=new Set(j.ergehtAn);l.has(n)?l.delete(n):l.add(n),L("ergehtAn",[...l])},title:`Empfänger ${n} ${j.ergehtAn.includes(n)?"entfernen":"hinzufügen"}`}),e.jsx("span",{children:n})]},n)),e.jsx("span",{className:"ml-2 text-xs text-gray-600",children:"sonstiger Empfänger:"}),e.jsx("input",{name:"ergehtAnText",className:"border rounded px-2 h-9",value:j.ergehtAnText,onChange:n=>L("ergehtAnText",n.target.value),placeholder:"Name/Gruppe"})]})]}),e.jsxs("div",{className:"col-span-12 border-t-2",children:[e.jsxs("div",{className:"grid grid-cols-12 bg-gray-50 border-b-2",children:[e.jsx("div",{className:"col-span-6 p-2 font-semibold border-r",children:"Maßnahme"}),e.jsx("div",{className:"col-span-5 p-2 font-semibold border-r",children:"Verantwortlich"}),e.jsx("div",{className:"col-span-1 p-2 font-semibold text-center",children:"Erledigt"})]}),j.massnahmen.map((n,l)=>e.jsxs("div",{className:"grid grid-cols-12 border-t",children:[e.jsx("div",{className:"col-span-6 p-2 border-r",children:e.jsx("input",{name:`m_massnahme_${l}`,className:"w-full border rounded px-2 h-9",value:n.massnahme,onChange:b=>{const w=[...j.massnahmen];w[l]={...n,massnahme:b.target.value},L("massnahmen",w)},title:`Maßnahme ${l+1}`})}),e.jsx("div",{className:"col-span-5 p-2 border-r",children:e.jsx("input",{name:`m_verantwortlich_${l}`,className:"w-full border rounded px-2 h-9",list:"dl-ver",value:n.verantwortlich,onChange:b=>{const w=[...j.massnahmen];w[l]={...n,verantwortlich:b.target.value},L("massnahmen",w)},title:`Verantwortlich ${l+1}`})}),e.jsx("div",{className:"col-span-1 p-2 flex items-center justify-center",children:e.jsx("input",{tabIndex:-1,type:"checkbox",name:`m_done_${l}`,value:"1",checked:!!n.done,onChange:b=>{const w=[...j.massnahmen];w[l]={...n,done:b.target.checked},L("massnahmen",w)},title:"Erledigt umschalten"})})]},l)),e.jsx("datalist",{id:"dl-ver",children:Q.map(n=>e.jsx("option",{value:n},n))})]})]}),e.jsx("button",{type:"submit",className:"hidden",children:"submit"})]})]})}function Kn({disabled:s=!1}){const[a,i]=r.useState(!1),[d,h]=r.useState(!1),[m,x]=r.useState(""),[g,I]=r.useState({remainingMin:null,idleMinutes:null,lastActivityIso:null,autoStopMin:null}),[k,O]=r.useState({lastLoadedIso:null,file:"list_filtered.json"}),[C,R]=r.useState(!1),[T,B]=r.useState(30),[G,q]=r.useState(null),V=r.useRef(!1),re=async()=>{try{const[N,E,K]=await Promise.all([fetch("/api/ff/status",{credentials:"include",cache:"no-store"}).then(M=>M.json()).catch(()=>({running:!1})),fetch("/api/ff/creds",{credentials:"include",cache:"no-store"}).then(M=>M.json()).catch(()=>({has:!1})),fetch("/api/import/auto-config",{credentials:"include",cache:"no-store"}).then(M=>M.json()).catch(()=>({enabled:!1,intervalSec:30}))]);i(!!N.running),h(!!E.has),R(!!K.enabled),B(Number(K.intervalSec||30)),V.current||(V.current=!0,E.has||x("Keine globalen Fetcher-Zugangsdaten. Bitte als Admin unter /user-admin setzen."))}catch{}};return r.useEffect(()=>{re();const N=setInterval(re,3e3);return()=>clearInterval(N)},[]),r.useEffect(()=>{let N;const E=async()=>{try{const K=await fetch("/api/activity/status",{credentials:"include",cache:"no-store"});if(K.ok){const M=await K.json(),H=Number(M.idleMinutes),ee=Number(M.autoStopMin),Q=Math.max(0,Math.ceil(ee-H));I({remainingMin:Q,idleMinutes:H,lastActivityIso:M.lastActivityIso,autoStopMin:ee}),i(!!M.fetcher?.running),O({lastLoadedIso:M.import?.lastLoadedIso??null,file:M.import?.file||"list_filtered.json"})}}catch{}};return E(),N=setInterval(E,1e3),()=>clearInterval(N)},[]),r.useEffect(()=>{let N;const E=()=>{if(!C||!k.lastLoadedIso){q(null);return}const M=new Date(k.lastLoadedIso).getTime()+T*1e3,H=Math.max(0,Math.ceil((M-Date.now())/1e3));q(H)};return E(),N=setInterval(E,1e3),()=>clearInterval(N)},[C,T,k.lastLoadedIso]),e.jsxs("div",{className:`flex items-center h-9 gap-2 ${s?"opacity-60 pointer-events-none":""}`,style:{alignItems:"center"},children:[e.jsx("span",{className:`sync-chip ${C?"active":""}`,title:C?"Auto-Import Countdown":"Auto-Import ist deaktiviert",style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:"110px",minWidth:"110px",textAlign:"center"},children:C?`⟳ in ${G??"–"}s`:"⏸ manuell"}),m&&e.jsx("span",{style:{color:"#dc2626",fontSize:12,marginLeft:8},children:m}),a&&g.remainingMin!=null&&g.remainingMin<=15&&e.jsxs("div",{title:`Letzte Aktivität: ${g.lastActivityIso?new Date(g.lastActivityIso).toLocaleString():"–"} • Inaktiv: ${g.idleMinutes?.toFixed?.(1)} min • Limit: ${g.autoStopMin} min`,className:"ml-2 inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border "+(g.remainingMin<=5?"bg-red-50 text-red-700 border-red-300":g.remainingMin<=15?"bg-amber-50 text-amber-700 border-amber-300":"bg-blue-50 text-blue-700 border-blue-300"),children:[e.jsx("span",{className:"mr-2 h-2 w-2 rounded-full bg-current",style:{animation:"pulse 1.5s ease-in-out infinite"}}),e.jsxs("span",{children:["Auto-Import stoppt in ",e.jsxs("b",{children:[g.remainingMin," min"]})]})]}),e.jsx("div",{title:`Quelle: ${k.file}`,className:"ml-2 inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border bg-white text-gray-700",style:{borderColor:"#cbd5e1"},children:e.jsxs("span",{children:["Zuletzt geladen:"," ",e.jsx("b",{children:k.lastLoadedIso?new Date(k.lastLoadedIso).toLocaleTimeString("de-AT",{hour12:!1}):"–"})]})})]})}function Un(){const[s]=r.useState(.9);return s}const Gn=s=>`card:${s}`,Ne=!0;async function Wn(s){if(!s||!window.google?.maps?.Geocoder)return null;const a=new google.maps.Geocoder;return new Promise(i=>{a.geocode({address:s,region:"AT"},(d,h)=>{if(h==="OK"&&d&&d[0]){const m=d[0],x=m.geometry?.location;i({lat:x?.lat?.(),lng:x?.lng?.(),formatted:m.formatted_address||s})}else i(null)})})}function Hn(){Un();const[s,a]=r.useState(!1);r.useEffect(()=>{qe().then(()=>a(!0))},[]);const i=s&&Qe("einsatzboard"),d=!i,[h,m]=r.useState(null),[x,g]=r.useState([]),[I,k]=r.useState([]),[O,C]=r.useState(""),[R,T]=r.useState(""),[B,G]=r.useState(""),[q,V]=r.useState(null),[re,N]=r.useState(null),[E,K]=r.useState(""),[M,H]=r.useState(!1),[ee,Q]=r.useState(!1),[J,j]=r.useState(!1),[oe,L]=r.useState(30),[me,he]=r.useState(!1),[ye,p]=r.useState(!1),[U,te]=r.useState(!1),[W,z]=r.useState(null),ne=t=>{z(t),te(!0)},[Y,y]=r.useState(window.location.hash);r.useEffect(()=>{const t=()=>y(window.location.hash);return window.addEventListener("hashchange",t),()=>window.removeEventListener("hashchange",t)},[]);const P=Y.replace(/^#/,""),[v,n]=r.useState(()=>new Set),[l,b]=r.useState(0),w=r.useRef(0),_=r.useRef(new Set),[F,D]=r.useState(0);r.useEffect(()=>{document.title="Einsatzstellen-Übersicht-Feuerwehr",At()},[]),r.useEffect(()=>{if(!i)return;if(!J){D(0);return}const t=setInterval(()=>D(o=>o+1),1e3);return()=>clearInterval(t)},[Ne,J]);const Z=J?Math.max(0,oe-F%Math.max(1,oe)):0,{query:X,setQuery:ie,predictions:Ie,getDetailsByPlaceId:Re,resetSession:Pe,loading:Tt,error:Ye}=Pt({country:"at",debounceMs:300,minLength:3}),Ae=r.useRef(null);r.useEffect(()=>{document.title="Einsatzstellen-Übersicht-Feuerwehr"},[]),r.useEffect(()=>{(async()=>{const[t,o,c]=await Promise.all([le(),dt(),kn()]);m(t),g(o),k(Array.isArray(c)?c:[]);try{const u=await En();j(!!u.enabled),L(Number(u.intervalSec)||30),Te.current=et(t)}catch{}D(0)})()},[Ne]),r.useEffect(()=>{J&&(async()=>{try{(await fetch("/api/ff/status",{credentials:"include",cache:"no-store"}).then(o=>o.json()).catch(()=>({running:!1}))).running||await fetch("/api/ff/start",{method:"POST",credentials:"include"})}catch{}})()},[Ne,J,oe]),r.useEffect(()=>{T(X||"")},[X]),r.useEffect(()=>{let t;const o=Math.max(5,Math.min(60,J?8:15)),c=async()=>{try{const u=new Set(Te.current),f=await le();m(f),tt({oldIds:u,newBoard:f,pulseMs:8e3})}catch{}t=setTimeout(c,o*1e3)};return t=setTimeout(c,o*1e3),()=>clearTimeout(t)},[Ne,J]),r.useEffect(()=>{const t=o=>{o.altKey&&(o.key==="e"||o.key==="E")&&(o.preventDefault(),p(!0),Pe())};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[Ne,Pe]);const de=h??{columns:{neu:{items:[]},"in-bearbeitung":{items:[]},erledigt:{items:[]}}},Mt=10;function $t(t){try{const o=t?.columns||{};return[(o.neu?.items||[]).length,(o["in-bearbeitung"]?.items||[]).length,(o.erledigt?.items||[]).length].some(u=>u>=Mt)}catch{return!1}}r.useEffect(()=>{const t=$t(de);document.documentElement.classList.toggle("ui-dense",t)},[de]);const[Le,Xe]=r.useState(new Set),Te=r.useRef(new Set);r.useEffect(()=>{if(!Le.size)return;const t=setTimeout(()=>Xe(new Set),9e3);return()=>clearTimeout(t)},[Le]);function et(t){const o=new Set;if(!t?.columns)return o;for(const c of Object.keys(t.columns))for(const u of t.columns[c].items||[])o.add(String(u.id));return o}function tt({oldIds:t,newBoard:o,pulseMs:c=8e3}){const u=Date.now(),f=et(o),S=new Set;for(const $ of f)t.has($)||S.add($);const A=new Set([...S].filter($=>!_.current.has(String($))));for(const $ of S)_.current.delete(String($));if(A.size>0&&(Xe(A),b(u+c),u>=w.current))try{Fn()}catch{}Te.current=f}const[_e,nt]=r.useState(!1),Dt=async()=>{if(!_e){nt(!0);try{const t=new Set(Te.current),o=await fetch("/api/import/trigger",{method:"POST"});if(!o.ok){const u=await o.text().catch(()=>"");throw new Error(`Import fehlgeschlagen (HTTP ${o.status}) ${u}`)}const c=await le();m(c),tt({oldIds:t,newBoard:c,pulseMs:8e3}),D(0)}catch(t){alert(t.message||"Import fehlgeschlagen.")}finally{nt(!1)}}},[Ot,st]=r.useState(!1),Rt=t=>String(t).replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function Lt(t,o){const c=String(o).match(/^(.*?)-(\d+)$/),u=c?c[1]:String(o);let f=c?parseInt(c[2],10):1;for(const S of t){const A=String(S.label||"").match(new RegExp("^"+Rt(u)+"-(\\d+)$"));if(!A)continue;const $=parseInt(A[1],10);Number.isFinite($)&&$>f&&(f=$)}return`${u}-${f+1}`}async function _t(t,o){if(Ot)return;const c=ve.get(t);if(c){st(!0);try{const u=Lt(x,c.label||c.id),f=await fetch("/api/vehicles",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ort:c.ort||"",label:u,mannschaft:0})}),S=await f.json().catch(()=>({}));if(!f.ok||S?.error)throw new Error(S?.error||"Clone fehlgeschlagen");const $=await(await fetch("/api/vehicles")).json();g($);let ae=S?.vehicle?.id;ae||(ae=$.find(we=>we.label===u&&we.ort===(c.ort||"")&&Number(we.mannschaft)===0)?.id),o&&ae&&await Ge(o,ae),m(await le())}catch(u){alert(u.message||"Clone fehlgeschlagen")}finally{st(!1)}}}const ve=r.useMemo(()=>new Map(x.map(t=>[t.id,t])),[x]),[rt,at]=r.useState(new Map),zt=r.useMemo(()=>{const t={};for(const[o,c]of ve.entries())t[o]=c;return t},[ve]),it=r.useMemo(()=>{const t=new Set,o=de?.columns||{};for(const c of Object.keys(o))for(const u of o[c].items||[])for(const f of u.assignedVehicles||[])t.add(f);return t},[de]),je=r.useMemo(()=>x.filter(t=>t&&typeof t.id<"u"&&!it.has(t.id)),[x,it]),pe=r.useMemo(()=>{const t={};for(const o of je){const c=o.ort||"Unbekannt";(t[c]??=[]).push(o)}for(const o of Object.keys(t))t[o].sort((c,u)=>(c.label||c.id).localeCompare(u.label||u.id));return Object.entries(t).sort((o,c)=>o[0].localeCompare(c[0]))},[je]);r.useEffect(()=>{if(localStorage.getItem("ff_collapsed_groups")||!pe.length)return;const o=pe.map(([c])=>c);Me(new Set(o)),localStorage.setItem("ff_collapsed_groups",JSON.stringify(o))},[Ne,pe]),r.useEffect(()=>{let t=setInterval(async()=>{try{const o=await fetch("/api/activity/status",{cache:"no-store"}).then(c=>c.json());typeof o?.auto?.enabled=="boolean"&&o.auto.enabled!==J&&j(!!o.auto.enabled)}catch{}},3e3);return()=>clearInterval(t)},[Ne,J]);function ze(t,o){for(const c of["neu","in-bearbeitung","erledigt"])if((t.columns[c].items||[]).some(u=>u?.id===o))return c;return null}function Ft(t,o){for(const c of["neu","in-bearbeitung","erledigt"]){const u=(t.columns[c].items||[]).find(f=>f?.id===o);if(u)return u}return null}function Fe(t){const o=de?.columns?.[t]?.items||[];if(t==="erledigt"){const f=o.reduce((A,$)=>A+($.everVehicles?.length||0),0),S=o.reduce((A,$)=>A+(Number.isFinite($?.everPersonnel)?$.everPersonnel:0),0);return{cards:o.length,units:f,persons:S}}const c=o.reduce((f,S)=>f+(S.assignedVehicles?.length||0),0),u=o.reduce((f,S)=>Number.isFinite(S?.manualPersonnel)?f+S.manualPersonnel:f+(S.assignedVehicles||[]).reduce((A,$)=>A+(ve.get($)?.mannschaft??0),0),0);return{cards:o.length,units:c,persons:u}}const Bt=Fe("neu"),Vt=Fe("in-bearbeitung"),Kt=Fe("erledigt"),Ut=async()=>{const t=B.replace(/^T\d+\s*,?\s*/i,"").trim(),o=(O||t).trim();if(!o){alert("Bitte Typ oder Titel angeben.");return}const c={id:`tmp-${Math.random().toString(36).slice(2,10)}`,content:o,createdAt:new Date().toISOString(),statusSince:new Date().toISOString(),assignedVehicles:[],everVehicles:[],everPersonnel:0,ort:(R||"").trim(),typ:B.trim()};H(!0),m(u=>{if(!u)return u;const f=structuredClone(u);return f.columns.neu.items.unshift(c),f});try{let u=null;const f=Ae.current;if(f?.geometry?.location?.lat&&f?.geometry?.location?.lng)u={lat:f.geometry.location.lat(),lng:f.geometry.location.lng()};else if(c.ort){const A=await Wn(c.ort);A&&(u={lat:A.lat,lng:A.lng})}const S=await ut(o,"neu",0,c.ort,c.typ,u??void 0);w.current=Date.now(),S?.card?.id!=null&&_.current.add(String(S.card.id)),m(A=>{if(!A)return A;const $=structuredClone(A),ae=$.columns.neu.items,ke=ae.findIndex(we=>we?.id===c.id);return ke>=0?ae[ke]=S.card:ae.unshift(S.card),$}),C(""),ie(""),T(""),G(""),Ae.current=null,Pe()}catch{m(u=>{if(!u)return u;const f=structuredClone(u);return f.columns.neu.items=f.columns.neu.items.filter(S=>S?.id!==c.id),f}),alert("Einsatz konnte nicht angelegt werden.")}finally{H(!1)}},Gt=async t=>{try{const o=await Re(t.place_id,["formatted_address","geometry","address_components","place_id"]);Ae.current=o||null;const c=o?.formatted_address||t.description;ie(c),T(c)}catch(o){console.error("Place details failed:",o),Ae.current=null,ie(t.description),T(t.description)}finally{Pe()}},Be=t=>String(t||"").split(/[;,\n]/).map(o=>o.trim()).filter(Boolean),ge=t=>String(t||"").normalize?.("NFD").replace?.(new RegExp("\\p{Diacritic}","gu"),"").replace(/^\s*FF\s+/i,"").replace(/[._\-\/]+/g," ").replace(/\s+/g," ").toLowerCase().trim();function Wt(t,o,c,u){const f=Be(t?.alerted).map(ge);if(f.length)for(const S of o){const A=f.some(ae=>ge(S?.ort)===ae),$=f.some(ae=>ge(S?.label)===ae);if(A||$){const ae=String(S.id);c.add(ae),u.has(ae)||u.set(ae,null)}}}async function Jt(t,o){if(!(o!=="neu"||!t?.id))try{const c=await An(t.id),u=new Set((c?.units||[]).map(se=>String(se.unitId)));if(t?.alerted){const se=Be(t.alerted).map(ge);for(const fe of je){const Ke=se.some(Ue=>ge(fe.ort)===ge(Ue)),Ce=se.some(Ue=>ge(fe.label)===ge(Ue));(Ke||Ce)&&u.add(String(fe.id))}}n(u),b(Date.now()+3e3);const f=new Map;for(const se of c?.units||[]){const fe=Number(se?.distanceKm);f.set(String(se.unitId),Number.isFinite(fe)?fe:null)}u.size===0&&t?.alerted&&Wt(t,je,u,f),at(f);const S=new Set((c?.units||[]).filter(se=>!se.assigned).map(se=>String(se.unitId))),A=new Set(je.map(se=>String(se.id))),$=new Set([...S,...[...u].filter(se=>A.has(se))]),ae=Be(t?.alerted).map(ge),ke=new Set;if(ae.length&&je.length>0)for(const[se,fe]of pe){if(fe.length===0)continue;ae.some(Ce=>ge(se)===ge(Ce))&&ke.add(se)}const we=[];for(const[se,fe]of pe)(fe.some(Ce=>$.has(String(Ce.id)))||ke.has(se))&&we.push(se);qt(we),clearTimeout(pulseTimerRef.current),pulseTimerRef.current=setTimeout(()=>{n(new Set),b(0),at(new Map)},3200)}catch(c){console.error("fetchNearby failed:",c)}}const[ot,Me]=r.useState(()=>{try{const t=localStorage.getItem("ff_collapsed_groups");return new Set(t?JSON.parse(t):[])}catch{return new Set}}),Ht=t=>ot.has(t),Zt=(t,o)=>{Me(c=>{const u=new Set(c);return o?u.add(t):u.delete(t),localStorage.setItem("ff_collapsed_groups",JSON.stringify([...u])),u})},qt=(t=[])=>{Me(()=>{const o=pe.map(([u])=>u),c=new Set(o);for(const u of t)c.delete(u);return localStorage.setItem("ff_collapsed_groups",JSON.stringify([...c])),c})},Qt=(t=!0)=>{Me(()=>{const o=pe.map(([u])=>u),c=t?new Set(o):new Set;return localStorage.setItem("ff_collapsed_groups",JSON.stringify([...c])),c})},Yt=()=>{const t=pe.map(([c])=>c),o=t.length>0&&t.every(c=>ot.has(c));Qt(!o)},[$e,Ve]=r.useState(null),[Xt,Se]=r.useState(null),en=hn(lt(vn,{activationConstraint:{distance:4}}),lt(wn,{activationConstraint:{delay:80,tolerance:6}})),tn=t=>{const o=t?.over;if(!o){Se(null);return}const c=String(o.id||"");if(c.startsWith("col:"))Se(c.slice(4));else if(c.startsWith("card:")){const u=ze(de,c.slice(5));Se(u)}else Se(null)},nn=async t=>{if(d){Se(null),Ve(null);return}Se(null);const{active:o,over:c}=t;if(Ve(null),!o||!c)return;const u=String(o.id||""),f=String(c.id||"");if(u.startsWith("ass:")&&f.startsWith("card:")){const[,S,A]=u.split(":"),$=f.slice(5);if(S&&A&&$&&S!==$)try{await mt(S,A);try{await pt(A)}catch{}await Ge($,A),m(await le())}catch{alert("Einheit konnte nicht umgehängt werden.")}return}if(u.startsWith("veh:")&&f.startsWith("card:")){try{await Ge(f.slice(5),u.slice(4)),m(await le())}catch{alert("Einheit konnte nicht zugewiesen werden.")}return}if(u.startsWith("card:")){const S=u.slice(5),A=ze(de,S);if(!A)return;if(f.startsWith("col:")){const $=f.slice(4);if(A!==$)try{await De({cardId:S,from:A,to:$,toIndex:0}),m(await le())}catch{alert("Statuswechsel konnte nicht gespeichert werden.")}return}if(f.startsWith("card:")){const $=ze(de,f.slice(5));if($)try{await De({cardId:S,from:A,to:$,toIndex:0}),m(await le())}catch{alert("Statuswechsel konnte nicht gespeichert werden.")}}}},sn=async()=>{if(confirm("Board wirklich zurücksetzen?")){Q(!0);try{await Cn(),m(await le())}catch{alert("Reset fehlgeschlagen.")}finally{Q(!1)}}},rn=()=>window.open(Pn(),"_blank","noopener,noreferrer"),an=async()=>{try{const t=await ht({enabled:!J,intervalSec:oe});j(!!t.enabled),L(Number(t.intervalSec)||30),D(0)}catch{alert("Konnte Auto-Import nicht ändern.")}},on=async t=>{const o=Math.max(5,Math.min(3600,Number(t)||30));L(o);try{await ht({enabled:J,intervalSec:o}),D(0)}catch{}},ln=async({title:t,ort:o,typ:c})=>{const u=await ut(t,"neu",0,o,c);w.current=Date.now(),u?.card?.id!=null&&_.current.add(String(u.card.id)),m(f=>{if(!f)return f;const S=structuredClone(f);return S.columns.neu.items.unshift(u.card),S})},cn=t=>{G(t);const o=t.replace(/^T\d+\s*,?\s*/i,"").trim();O.trim()||C(o)};if(P.startsWith("/protokoll/edit/")){const t=P.split("/")[3],o=Number(t);return e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Protokoll – Bearbeiten"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"Zur Übersicht"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(It,{mode:"edit",editNr:o})})]})}return P.startsWith("/protokoll/neu")?e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Protokoll – Eintrag anlegen"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"Zur Übersicht"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(It,{mode:"create"})})]}):P.startsWith("/protokoll")?e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Protokoll"}),e.jsx("button",{onClick:()=>{window.location.hash="/"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"← Zurück"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(Vn,{})})]}):e.jsxs("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden flex flex-col",style:{fontSize:"var(--ui-scale)"},children:[!h&&e.jsx("div",{className:"fixed inset-0 z-10 bg-black/10 backdrop-blur-sm flex items-center justify-center",children:e.jsx("div",{className:"px-4 py-2 rounded-lg bg-white shadow",children:"Lade…"})}),e.jsxs("header",{className:"flex flex-wrap items-center justify-between gap-2 mb-2",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:"Einsatzstellen-Übersicht-Feuerwehr"}),e.jsxs("div",{className:"toolbar flex flex-wrap items-center gap-2",children:[e.jsx("button",{onClick:rn,className:"px-3 py-1.5 rounded-md bg-purple-600 hover:bg-purple-700 text-white",children:"PDF"}),e.jsx("button",{onClick:()=>window.open("/api/log.csv","_blank"),className:"px-3 py-1.5 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white",title:"log.csv herunterladen",children:"Log (CSV)"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-500 hover:bg-gray-600 text-white",children:"Protokoll"}),e.jsx("button",{onClick:Dt,disabled:d||_e,className:"px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-60",title:"Import sofort ausführen",children:_e?"Import…":"Import"}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm px-2 py-1 rounded-md bg-white border",children:[e.jsx("input",{type:"checkbox",checked:J,onChange:an,disabled:d})," Auto-Import"]}),e.jsxs("label",{className:"interval-capsule flex items-center text-sm text-gray-700 bg-gray-50 border border-gray-300 rounded-md overflow-hidden",children:[e.jsx("span",{className:"pl-3 pr-2 select-none",children:"Intervall (s):"}),e.jsx("input",{type:"number",min:"5",max:"3600",value:oe,onChange:t=>on(t.target.value),disabled:d,className:`h-9 w-20 bg-white border-0 rounded-none text-center text-gray-800 
               focus:outline-none focus:ring-0 focus:border-0`})]}),e.jsx(Kn,{autoEnabled:J,remaining:Z,disabled:d}),e.jsx("button",{onClick:sn,disabled:d||ee,className:`px-3 py-1.5 rounded-md text-white ${ee?"bg-gray-400":"bg-gray-700 hover:bg-gray-800"}`,children:ee?"Reset…":"Reset"})]})]}),e.jsxs("section",{className:"mb-2 grid grid-cols-1 md:grid-cols-7 gap-2",children:[e.jsxs("select",{className:"border rounded px-2 py-1 md:col-span-2",value:B,onChange:t=>cn(t.target.value),children:[e.jsx("option",{value:"",children:"— Typ auswählen —"}),I.map(t=>e.jsx("option",{value:t,children:t},t))]}),e.jsx("input",{className:"border rounded px-2 py-1 md:col-span-2",placeholder:"Titel (wird aus Typ übernommen)",value:O,onChange:t=>C(t.target.value)}),e.jsxs("div",{className:"relative md:col-span-2",children:[e.jsx("input",{className:"border rounded px-2 py-1 w-full",placeholder:"Ort (nur Österreich)",autoComplete:"off",value:X,onChange:t=>ie(t.target.value)}),Tt&&e.jsx("div",{className:"absolute z-10 mt-1 text-xs text-gray-500 bg-white border rounded px-2 py-1",children:"Suche…"}),Ye&&e.jsxs("div",{className:"absolute z-10 mt-1 text-xs text-red-600 bg-white border rounded px-2 py-1",children:["Fehler: ",String(Ye)]}),!!Ie.length&&e.jsx("ul",{className:"absolute z-10 mt-1 w-full max-h-52 overflow-auto bg-white border rounded shadow",children:Ie.map(t=>e.jsx("li",{className:"px-2 py-1 hover:bg-gray-100 cursor-pointer text-sm",onClick:()=>Gt(t),title:t.description,children:t.description},t.place_id))})]}),e.jsx("button",{className:"px-3 py-1 rounded bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60",disabled:d||M,onClick:Ut,children:M?"Wird angelegt…":"Einsatz anlegen"})]}),e.jsxs(gn,{sensors:en,collisionDetection:t=>t?.active?.data?.current?.type==="vehicle"?pn(t):fn(t),onDragStart:t=>Ve({type:t?.active?.data?.current?.type,id:t.active.id,data:t?.active?.data?.current}),onDragOver:tn,onDragEnd:nn,children:[e.jsxs("main",{className:"grid grid-cols-1 md:[grid-template-columns:minmax(180px,220px)_repeat(3,minmax(0,1fr))] gap-2 min-h-0 flex-1 overflow-hidden",children:[e.jsxs("section",{className:"bg-white rounded-xl shadow p-3 h-full flex flex-col min-h-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-semibold",children:e.jsx("button",{type:"button",onClick:Yt,title:"Alle Gruppen auf/zu klappen",className:"underline decoration-dotted hover:opacity-80 focus:outline-none",children:"Einheiten (frei)"})}),i&&e.jsx("button",{onClick:()=>he(!0),className:"px-2 py-1 text-sm rounded bg-emerald-600 text-white",children:"+ Einheit"})]}),e.jsxs("div",{className:"overflow-auto pr-1 flex-1 min-h-0 space-y-3",children:[pe.length===0&&e.jsx("div",{className:"text-[0.85rem] text-gray-500 italic",children:"— alle Einheiten sind zugewiesen —"}),pe.map(([t,o])=>{const c=Ht(t);return e.jsxs("div",{className:"border border-blue-400 rounded-md",children:[e.jsxs("button",{type:"button",onClick:()=>Zt(t,!c),className:"w-full flex items-center justify-between px-2 py-2 text-left",title:c?"aufklappen":"zuklappen",children:[e.jsx("span",{className:"text-xs font-semibold text-gray-700",children:t}),e.jsx("span",{className:"group-chip",children:o.length})]}),!c&&e.jsx("div",{className:"px-2 pb-2 grid grid-cols-1 gap-1.5",children:o.map(u=>e.jsx(jn,{editable:i,vehicle:u,pillWidthPx:160,near:v.has(String(u.id))&&Date.now()<l,distKm:rt.get(String(u.id))},u.id))})]},t)})]})]}),[{id:"neu",title:"Neu",bg:"bg-red-100",totals:Bt},{id:"in-bearbeitung",title:"In Bearbeitung",bg:"bg-yellow-100",totals:Vt},{id:"erledigt",title:"Erledigt",bg:"bg-green-100",totals:Kt}].map(({id:t,title:o,bg:c,totals:u})=>e.jsx("div",{className:Xt===t?"drag-over":"",children:e.jsx(_n,{editable:i,colId:t,bg:c,title:e.jsxs("span",{className:"column-header flex items-center justify-between",children:[e.jsx("span",{className:"font-semibold",children:o}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsxs("span",{className:"kpi-badge","data-variant":"units",children:["🚒 ",u.units]}),e.jsxs("span",{className:"kpi-badge","data-variant":"persons",children:["👥 ",u.persons]}),e.jsxs("span",{className:"kpi-badge","data-variant":"cards",children:["⬛ ",u.cards]})]})]}),children:e.jsx("ul",{className:"space-y-2 overflow-y-auto overflow-x-hidden pl-1 pr-2 py-2",style:{maxHeight:"calc(100vh - 260px)"},children:e.jsx(xn,{items:(de.columns[t].items||[]).map(f=>Gn(f.id)),strategy:bn,children:(de.columns[t].items||[]).map(f=>e.jsx(Nn,{editable:i,card:f,colId:t,vehiclesById:ve,distById:rt,pillWidthPx:160,pulse:Le.has(String(f.id))&&Date.now()<l,onUnassign:async(S,A)=>{await mt(S,A);try{await pt(A)}catch{}m(await le())},onOpenMap:S=>V({address:f.ort,card:f,board:de,vehiclesById:zt}),onAdvance:i?async S=>{t==="neu"?(await De({cardId:S.id,from:"neu",to:"in-bearbeitung",toIndex:0}),m(await le())):t==="in-bearbeitung"&&(await De({cardId:S.id,from:"in-bearbeitung",to:"erledigt",toIndex:0}),m(await le()))}:void 0,onEditPersonnelStart:i?(S,A)=>{N({cardId:S.id}),K(A)}:void 0,editing:re,editingValue:E,setEditingValue:K,onEditPersonnelSave:i?async S=>{try{await In(S.id,E===""?null:Number(E)),m(await le())}finally{N(null),K("")}}:void 0,onEditPersonnelCancel:i?()=>{N(null),K("")}:void 0,onClone:_t,onVehiclesIconClick:Jt,nearIds:v,nearUntilMs:l,onShowInfo:ne},f.id))})})})},t))]}),e.jsxs(yn,{dropAnimation:{duration:180,easing:"ease-out"},children:[$e?.type==="vehicle"&&(()=>{const t=ve.get($e?.data?.vehicleId);return t?e.jsx("div",{className:"pointer-events-none",children:e.jsxs("div",{style:{width:160},className:"max-w-full select-none border-2 border-red-300 rounded-2xl bg-white px-2 py-1 shadow-lg",children:[e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:t.label||t.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate",children:[t.ort||"—"," · 👥 ",t.mannschaft??0]})]})}):null})(),$e?.type==="card"&&(()=>{const t=String($e?.id||"").replace(/^card:/,""),o=Ft(de,t);return o?e.jsx("div",{className:"pointer-events-none w-[280px]",children:e.jsxs("div",{className:"rounded-lg bg-white shadow-xl border p-3",children:[e.jsx("div",{className:"font-semibold text-sm mb-1 truncate",children:o.content}),e.jsxs("div",{className:"text-xs text-gray-600",children:[o.assignedVehicles?.length||0," Einheiten •"," ","👥 ",Number.isFinite(o?.manualPersonnel)?o.manualPersonnel:(o.assignedVehicles||[]).reduce((c,u)=>c+(ve.get(u)?.mannschaft??0),0)]})]})}):null})()]})]}),i&&e.jsx("button",{className:"fab",title:"Einsatz anlegen",onClick:()=>p(!0),children:"＋"}),e.jsx("a",{href:"/Hilfe.pdf",target:"_blank",rel:"noopener noreferrer",className:"fixed bottom-4 right-4 px-4 py-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-lg",children:"Hilfe"}),me&&e.jsx(On,{onClose:()=>he(!1),onCreate:async t=>{const o=await fetch("/api/vehicles",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!o.ok){const c=await o.text().catch(()=>String(o.status));throw new Error(`HTTP ${o.status} ${c}`)}g(await dt())}}),ye&&e.jsx(Ln,{onClose:()=>p(!1),onCreate:ln,types:I}),q&&e.jsx(Dn,{context:q,onClose:()=>V(null)}),e.jsx(zn,{open:U,info:W||{},onClose:()=>{te(!1),z(null)}})]})}export{Hn as default};
