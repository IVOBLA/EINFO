import{u as Bn,j as e,r as a,a as Ds,C as zs,s as pn,b as Gt,c as _s,d as On,e as Bs,l as bn,f as Os,g as Vs,h as Us,i as Me,k as Ke,m as Hs,n as xn,o as yn,p as Ot,q as Ks,t as Gs,v as Ws,w as qs,x as wn,y as Zs,z as Js,A as Qs,B as Ys,D as vn,E as bt,P as Sn,S as Nn,F as Xs,G as er,H as tr,I as nr,J as sr,K as rr,L as xt,M as jn,N as An,O as ar,Q as kn,R as Cn,T as Vt,U as ir,V as or,W as lr,X as cr,Y as dr,Z as ur}from"./index-DgRSs-mQ.js";function In({cardId:n,vehicle:s,pillWidthPx:i=160,onUnassign:c,onClone:u,near:b=!1,distKm:m=null,readonly:v=!1}){const k=`ass:${n}:${s.id}`,j=v?null:Bn({id:k,data:{type:"assigned",vehicleId:s.id,fromCardId:n}}),E=j?.attributes??{},z=j?.listeners??{},M=j?.setNodeRef??(()=>{}),$=j?.transform??null,D=j?.isDragging??!1,S={width:i,transform:$?`translate3d(${$.x}px, ${$.y}px, 0)`:void 0};return e.jsxs("div",{ref:M,style:S,...E,...z,className:`relative self-start border-2 rounded-2xl bg-white px-2 pr-9 py-1 shadow-sm
                  select-none ${v?"cursor-not-allowed":"cursor-grab active:cursor-grabbing"}
                  ${b?"border-emerald-500 ring-2 ring-emerald-300":"border-red-300"}
                  ${D?"opacity-50":""}`,title:v?"Einheit kann derzeit nicht verschoben werden":"Ziehen: auf andere Karte verschieben Â· Doppelklick: klonen",onDoubleClick:()=>{v||u?.(s.id,n)},"aria-disabled":v,children:[b&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-0.5 rounded-2xl border-2 border-emerald-400/50 animate-ping"}),e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:s.label||s.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate flex justify-between items-center",children:[e.jsxs("span",{children:[s.ort||"â€”"," Â· ðŸ‘¥ ",s.mannschaft??0]}),b&&Number.isFinite(Number(m))&&e.jsxs("span",{className:"absolute top-1 right-8 text-[11px] tabular-nums text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded whitespace-nowrap",children:[Number(m)," Km"]})]}),!v&&e.jsx("button",{type:"button",onMouseDown:x=>x.stopPropagation(),onTouchStart:x=>x.stopPropagation(),onClick:x=>{x.stopPropagation(),c?.(n,s.id)},title:"Einheit entfernen",className:"absolute right-2 top-1/2 -translate-y-1/2 h-6 w-6 rounded-full bg-red-600 text-white shadow flex items-center justify-center","aria-label":"Einheit entfernen",children:e.jsx("svg",{viewBox:"0 0 12 12",width:"12",height:"12","aria-hidden":"true",children:e.jsx("path",{d:"M1 1 L11 11 M11 1 L1 11",stroke:"white",strokeWidth:"2",strokeLinecap:"round"})})})]})}const En=n=>{const s=String(n||"");return s?/^B/i.test(s)?`B${s.slice(1)}`:/^[A-Za-z]/.test(s)?`B${s.slice(1)}`:`B${s}`:""};function fr(n){const{card:s,colId:i,vehiclesById:c,pillWidthPx:u=160,onUnassign:b,onOpenMap:m,onAdvance:v,onEditPersonnelStart:k,editing:j,editingValue:E,setEditingValue:z,onEditPersonnelSave:M,onEditPersonnelCancel:$,onClone:D,onVehiclesIconClick:S,onShowInfo:x,areaOptions:f=[],areaLabelById:g=new Map,areaColorById:T=new Map,onAreaChange:C,onEditCard:N,nearIds:V,nearUntilMs:_,distById:U,pulse:se,editable:re=!0}=n,[G,H]=a.useState(!1),[J,Q]=a.useState(!1),fe=a.useRef((s.assignedVehicles||[]).length),le=a.useRef(null),K=a.useRef(null),L=Date.now()<(_||0);a.useEffect(()=>{H(!1)},[i]),a.useEffect(()=>()=>{K.current&&(clearTimeout(K.current),K.current=null)},[]);const xe=re?Ds({id:`card:${s.id}`,data:{type:"card",cardId:s.id}}):{attributes:{},listeners:{},setNodeRef:()=>{},transform:null,transition:null,isDragging:!1},{attributes:O,listeners:q,setNodeRef:me,transform:ae,transition:Se,isDragging:he}=xe,A=a.useMemo(()=>{if(!s)return null;const p=typeof s.areaColor=="string"&&s.areaColor?s.areaColor:null;if(s.isArea)return p;if(!s.areaCardId)return null;if(p)return p;const te=String(s.areaCardId);if(T.has(te))return T.get(te)||null;const ke=(f||[]).find(ge=>String(ge.id)===te);return ke?.color?ke.color:null},[s,T,f]),W={transform:zs.Transform.toString(ae),transition:Se,opacity:he?.8:1,borderColor:A||void 0,borderWidth:A?"2px":void 0},ie=i==="erledigt"?s.everVehicles?.length||0:s.assignedVehicles?.length||0,de=a.useMemo(()=>(s.assignedVehicles||[]).map(p=>c.get(p)).filter(Boolean),[s,c]),ye=a.useMemo(()=>i==="erledigt"?Number.isFinite(s?.everPersonnel)?s.everPersonnel:0:Number.isFinite(s?.manualPersonnel)?s.manualPersonnel:de.reduce((p,te)=>p+(te?.mannschaft??0),0),[i,s,de]);a.useEffect(()=>{if(i!=="in-bearbeitung"||!L)return;(s.assignedVehicles||[]).some(te=>V?.has(String(te)))&&H(!0)},[i,L,V,s.assignedVehicles]),a.useEffect(()=>{if(i!=="in-bearbeitung")return;const p=(s.assignedVehicles||[]).length,te=fe.current;p>te&&H(!0),fe.current=p},[i,s.assignedVehicles]),a.useEffect(()=>{if(i==="in-bearbeitung"&&G&&le.current)try{le.current.scrollIntoView({behavior:"smooth",block:"nearest"})}catch{}},[i,G]);const pe=()=>{i==="neu"?typeof S=="function"&&S(s,i):(i==="in-bearbeitung"||i==="erledigt")&&H(p=>!p)},oe=()=>{re&&typeof k=="function"&&k(s,ye)},we=s?.isEditable!==!1,Y=a.useMemo(()=>s?.humanId?s?.isArea?En(s.humanId):String(s.humanId):"",[s?.humanId,s?.isArea]),X=p=>{if(!p)return"";const te=p.humanId?String(p.humanId):"",ke=p.isArea?En(te):te,ge=p.content?String(p.content):"";return[ke,ge].filter(Boolean).join(" â€“ ")||ke||ge||""},ce=a.useMemo(()=>{if(s?.isArea)return X(s);if(!s?.areaCardId)return"";const p=String(s.areaCardId),te=g.get(p);if(te)return te;const ke=(f||[]).find(ge=>String(ge.id)===p);return ke?ke.label:String(s.areaCardId)},[s,g,f]),R=a.useMemo(()=>(f||[]).filter(p=>String(p.id)!==String(s.id)),[f,s.id]),ee=re&&!s.isArea&&typeof C=="function",ve=s.areaCardId?String(s.areaCardId):"",Ne=p=>{ee&&C(s,p)},Te=J||G,Ie=()=>{K.current&&clearTimeout(K.current),K.current=setTimeout(()=>{Q(!0),K.current=null},300)},je=()=>{K.current&&(clearTimeout(K.current),K.current=null),Q(!1)},ue=()=>{K.current&&(clearTimeout(K.current),K.current=null),Q(!0)},Le=()=>{K.current&&(clearTimeout(K.current),K.current=null),Q(!1)},$e=s.isArea?"bg-slate-100 border-slate-200":"bg-white",Ee=s.isArea?"bg-slate-200 hover:bg-slate-300":"bg-white hover:bg-gray-50",Ge=s.isArea?"bg-slate-200 hover:bg-slate-300":"bg-white hover:bg-red-50";return e.jsxs("li",{ref:me,style:W,tabIndex:0,className:`relative rounded-lg shadow border transition mx-1 focus:outline-none ${$e} ${se&&i==="neu"?"ring-2 ring-red-400/60":""}`,onMouseEnter:Ie,onMouseLeave:je,onFocus:ue,onBlur:Le,children:[se&&i==="neu"&&e.jsxs(e.Fragment,{children:[e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 rounded-lg bg-red-500/10 animate-pulse-inner"}),e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 rounded-lg animate-ping-safe"})]}),e.jsxs("div",{className:`p-3 select-none ${s.isArea?"bg-slate-100 rounded-lg":""}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",...O,...q,children:[e.jsxs("div",{className:"min-w-0",children:[Y&&e.jsxs("div",{className:"text-[11px] font-semibold uppercase tracking-wide text-gray-500",children:["Einsatz: ",Y]}),s.isArea&&e.jsx("div",{className:"text-[11px] font-semibold uppercase tracking-wide text-emerald-600",children:"Abschnitt"}),e.jsx("div",{className:"font-semibold text-sm leading-5 truncate",children:s.content}),!!s.ort&&e.jsx("button",{type:"button",onClick:()=>m?.(s.ort),className:"text-[12px] text-blue-700 hover:underline truncate",title:"Ort in Karte Ã¶ffnen",children:s.ort})]}),e.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[e.jsxs("button",{type:"button",title:i==="neu"?"Nahe Einheiten prÃ¼fen":"Einheiten auf-/zuklappen",className:`px-2 py-1 rounded text-[12px] border flex items-center gap-1 ${Ge}`,onPointerDown:p=>p.stopPropagation(),onClick:p=>{p.stopPropagation(),p.preventDefault(),pe()},children:["ðŸš’ ",ie,(i==="in-bearbeitung"||i==="erledigt")&&e.jsx("span",{children:G?"â–¾":"â–¸"})]}),e.jsxs("button",{type:"button",className:`px-2 py-1 rounded text-[12px] border ${Ee}`,title:"Personalzahl bearbeiten",onPointerDown:p=>p.stopPropagation(),onClick:p=>{p.stopPropagation(),oe()},children:["ðŸ‘¥ ",ye]}),re&&v&&e.jsx("button",{type:"button",onPointerDown:p=>p.stopPropagation(),onClick:p=>{p.stopPropagation(),v(s)},className:`ml-1 px-2 py-1 rounded text-[12px] border ${Ee}`,title:"weiter",children:"âž”"})]})]}),e.jsx("div",{className:`mt-0 overflow-hidden transition-all duration-200 ease-in-out ${Te?"max-h-[2000px] opacity-100 pointer-events-auto":"max-h-0 opacity-0 pointer-events-none"}`,children:e.jsxs("div",{className:"pt-2 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-[12px]",children:[e.jsx("span",{className:"text-gray-600 whitespace-nowrap",children:"Abschnitt"}),ee?e.jsxs("select",{className:"border rounded px-2 py-1 text-[12px] min-w-[140px]",value:ve,onChange:p=>Ne(p.target.value),onPointerDown:p=>p.stopPropagation(),children:[e.jsx("option",{value:"",children:"â€” Abschnitt auswÃ¤hlen â€”"}),R.map(p=>e.jsx("option",{value:p.id,children:p.label},p.id))]}):e.jsx("span",{className:"font-medium text-gray-800",children:ce||"â€”"})]}),i==="neu"&&!!de.length&&e.jsx("div",{className:"flex flex-wrap gap-1.5",children:de.map(p=>{const te=p?.available!==!1,ke=p?.groupAvailable!==!1,ge=!re||!te||!ke;return e.jsx(In,{cardId:s.id,vehicle:p,pillWidthPx:u,onUnassign:b,onClone:D,near:!!V&&L&&V.has(String(p.id)),readonly:ge,distKm:U?.get(String(p.id))??null},`ass-${s.id}-${p.id}`)})}),i==="in-bearbeitung"&&G&&!!de.length&&e.jsx("div",{ref:le,className:"flex flex-wrap gap-1.5",children:de.map(p=>{const te=p?.available!==!1,ke=p?.groupAvailable!==!1,ge=!re||!te||!ke;return e.jsx(In,{cardId:s.id,vehicle:p,pillWidthPx:u,onUnassign:b,onClone:D,near:!!V&&L&&V.has(String(p.id)),readonly:ge,distKm:U?.get(String(p.id))??null},`ass-${s.id}-${p.id}`)})}),i==="erledigt"&&G&&!!s.everVehicles?.length&&e.jsx("ul",{className:"text-sm text-gray-700 list-disc list-inside space-y-1",children:s.everVehicles.map(p=>{const te=c.get(p),ke=String(p),ge=s?.everVehicleLabels?.[ke],We=typeof ge=="string"?ge:ge?.label,Be=typeof ge=="object"&&ge?ge.ort:null,nt=te?.label||We||te?.id||"Unbekannt",qe=te?.ort??Be??null,At=qe?` (${qe})`:"";return e.jsxs("li",{children:[nt,At]},p)})}),re&&j?.cardId===s.id&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",className:"w-20 border rounded px-2 py-1 text-sm",value:E,onChange:p=>z(p.target.value),placeholder:"Personen"}),e.jsx("button",{className:"px-2 py-1 text-sm rounded bg-emerald-600 text-white",onClick:()=>M(s),children:"Speichern"}),e.jsx("button",{className:"px-2 py-1 text-sm rounded bg-gray-200",onClick:$,children:"Abbrechen"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[re&&we&&typeof N=="function"&&e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Bearbeiten",onPointerDown:p=>p.stopPropagation(),onClick:p=>{p.stopPropagation(),N(s)},children:"âœŽ"}),e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Ort in Karte Ã¶ffnen",onPointerDown:p=>p.stopPropagation(),onClick:p=>{p.stopPropagation(),m?.(s.ort)},children:"Karte"}),e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Einsatz-Info",onPointerDown:p=>p.stopPropagation(),onClick:p=>{p.stopPropagation(),x?.(s)},children:"?"})]})]})})]})]})}function mr({vehicle:n,pillWidthPx:s=160,near:i=!1,distKm:c=null,editable:u=!0}){const b=`veh:${n.id}`,m=n?.available!==!1,v=n?.groupAvailable!==!1,k=u&&m&&v,j=k?Bn({id:b,data:{type:"vehicle",vehicleId:n.id}}):null,E=j?.attributes??{},z=j?.listeners??{},M=j?.setNodeRef??(()=>{}),$=j?.transform??null,D=j?.isDragging??!1,S=!m||!v,x={width:s,transform:$?`translate3d(${$.x}px, ${$.y}px, 0)`:void 0};return S&&!D&&(x.opacity=.6),e.jsxs("div",{ref:M,style:x,...E,...z,className:`relative max-w-full select-none border-2 ${i?"border-emerald-500":"border-red-300"} rounded-2xl bg-white
                 px-2 py-1 shadow-sm
                 ${k?"cursor-grab active:cursor-grabbing":"cursor-not-allowed"}
                 ${D?"opacity-50":""}
                 ${S?"border-gray-200 bg-gray-100":""}`,"aria-disabled":!k,children:[i&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-0.5 rounded-2xl border-2 border-emerald-400/50 animate-ping"}),e.jsx("div",{className:`text-[13px] font-semibold leading-5 truncate ${S?"text-gray-500":""}`,children:n.label||n.id}),e.jsxs("div",{className:`text-[12px] leading-4 truncate flex justify-between items-center ${S?"text-gray-400":"text-gray-600"}`,children:[e.jsxs("span",{children:[n.ort||"â€”"," Â· ðŸ‘¥ ",n.mannschaft??0]}),i&&Number.isFinite(Number(c))&&e.jsxs("span",{className:"absolute top-1 right-1 text-[11px] tabular-nums text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded whitespace-nowrap",children:[Number(c)," Km"]})]})]})}const Ut=n=>Array.isArray(n?.assignedVehicles)?n.assignedVehicles:Array.isArray(n?.assigned_vehicle_ids)?n.assigned_vehicle_ids:[];function hr(n,s){const c=(s.lat-n.lat)*Math.PI/180,u=(s.lng-n.lng)*Math.PI/180,b=Math.sin(c/2)**2+Math.cos(n.lat*Math.PI/180)*Math.cos(s.lat*Math.PI/180)*Math.sin(u/2)**2;return 2*6371*Math.asin(Math.sqrt(b))}function Ht(n,s,i){const u=i*Math.PI/180,b=n.lat*Math.PI/180,m=n.lng*Math.PI/180,v=s/6371e3,k=Math.asin(Math.sin(b)*Math.cos(v)+Math.cos(b)*Math.sin(v)*Math.cos(u))*180/Math.PI,j=(m+Math.atan2(Math.sin(u)*Math.sin(v)*Math.cos(b),Math.cos(v)-Math.sin(b)*Math.sin(k*Math.PI/180)))*180/Math.PI;return{lat:k,lng:j}}async function Mn(n){if(!n||!window.google?.maps?.Geocoder)return null;const s=new window.google.maps.Geocoder;return new Promise(i=>{s.geocode({address:n,region:"AT"},(c,u)=>{u==="OK"&&c?.[0]?.geometry?.location?i({lat:c[0].geometry.location.lat(),lng:c[0].geometry.location.lng(),formatted:c[0].formatted_address||n}):i(null)})})}const Ve=n=>String(n||"").trim().toLowerCase();async function Pn(){try{const n=await fetch("/api/vehicles",{cache:"no-store",credentials:"include"});if(!n.ok)return[];const s=await n.json();return Array.isArray(s)?s:[]}catch{return[]}}async function Tn(){try{const n=await fetch("/api/board",{cache:"no-store",credentials:"include"});if(!n.ok)return null;const s=await n.json();if(s&&typeof s=="object")return s}catch(n){console.error("Board fetch failed:",n)}return null}function Ln(n,s){const i=new Map;if(Array.isArray(s))for(const c of s)!c||c.id==null||i.set(String(c.id),{...c});if(n&&typeof n=="object")for(const c of Object.values(n)){if(!c||c.id==null)continue;const u=String(c.id),b=i.get(u)||{};i.set(u,{...b,...c})}return[...i.values()]}async function $n(){try{const n=await fetch("/api/gps",{cache:"no-store",credentials:"include"});if(n.ok)return await n.json()}catch(n){console.error("GPS fetch failed:",n)}return[]}function Rn(n){const s=n?.typ||n?.type||"â€”",i=n?.createdAt||n?.timestamp,c=i?new Date(i).toLocaleString("de-AT",{hour12:!1}):"â€”",u=n?.alerted??"â€”",b=n?.description??"â€”",m=n?.additionalAddressInfo||n?.ort||"â€”",v=[];n?.location&&v.push(String(n.location));const k=Number.isFinite(n?.latitude),j=Number.isFinite(n?.longitude);k&&j&&v.push(`(${n.latitude}, ${n.longitude})`);const E=v.length?v.join(" "):"â€”";return`
    <div style="min-width:280px">
      <div style="font-weight:700;margin-bottom:4px">${n?.content||"Einsatz"}</div>
      <div><b>Typ:</b> ${s}</div>
      <div><b>Alarmzeit:</b> ${c}</div>
      <div><b>Alarmiert:</b> ${u}</div>
      <div><b>Beschreibung:</b> ${b}</div>
      <div><b>Adresse:</b> ${m}</div>
      <div><b>Location:</b> ${E}</div>
    </div>
  `}const _e=44,Fn="/vehicle-red.gif",gr="/vehicle-gray.png",pr="/vehicle-drive.gif";function br({context:n,address:s,onClose:i}){const c=s||n?.card?.ort||n?.address||"",u=!!window.google?.maps,b=a.useRef(null),m=a.useRef(!1),[v,k]=a.useState(!1),[j,E]=a.useState(""),z=a.useMemo(()=>{const M=n?.card;return M&&Number.isFinite(M?.latitude)&&Number.isFinite(M?.longitude)?{lat:Number(M.latitude),lng:Number(M.longitude)}:null},[n]);if(a.useEffect(()=>{if(!u||!n?.card||!b.current)return;m.current=!1;let M=!1,$,D;const S=new Map;let x=null;const f=n?.card?.id!=null?String(n.card.id):null;let g=n?.board;const T=async(N,V)=>{if(!(!f||m.current)&&!(!Number.isFinite(N?.lat)||!Number.isFinite(N?.lng)))try{const _={latitude:N.lat,longitude:N.lng};V&&!n?.card?.location&&(_.location=V),await Gt(f,_),m.current=!0}catch(_){console.error("Geocoding-Persistierung fehlgeschlagen:",_)}};return(async()=>{try{if(k(!0),E(""),!g||typeof g!="object"||!g.columns){const A=await Tn();if(M)return;A&&typeof A=="object"&&(g=A)}let N=z;if(!N){const A=await Mn(n.card.ort);if(M)return;A&&(N={lat:A.lat,lng:A.lng},T(N,A.formatted))}N||(N={lat:46.7227,lng:14.0952},E("Einsatz-Position unbekannt â€“ zeige Karte mit Default-Zentrum.")),$=new window.google.maps.Map(b.current,{center:N,zoom:18,mapTypeId:"roadmap"}),D=new window.google.maps.InfoWindow;const V=(A,W,ie,de,{hover:ye=!1}={})=>{const pe={path:"M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z",fillColor:W,fillOpacity:1,strokeColor:"#333",strokeWeight:1,scale:1.2},oe=new window.google.maps.Marker({position:A,map:$,title:ie,icon:pe});if(de){const we=()=>{D.setContent(de),D.open($,oe)};ye?(oe.addListener("mouseover",we),oe.addListener("mouseout",()=>D.close())):oe.addListener("click",we)}return oe};V(N,"#d11a1a",n.card.content||"Einsatz",Rn(n.card),{hover:!0});const _=[],U=new Set,se=A=>{if(!A||A.id==null)return;const W=String(A.id);U.has(W)||(U.add(W),_.push(A))},G=(g||n?.board)?.columns||{};for(const A of G?.neu?.items||[])se(A);for(const A of G?.["in-bearbeitung"]?.items||[])se(A);f&&se(n?.card);const H=new Map;for(const A of _){const W=String(A.id);if(Number.isFinite(A.latitude)&&Number.isFinite(A.longitude))H.set(W,{lat:Number(A.latitude),lng:Number(A.longitude)});else if(A.ort){const ie=await Mn(A.ort);ie&&H.set(W,{lat:ie.lat,lng:ie.lng})}}f&&N&&H.set(f,N);for(const A of _){const W=String(A.id);if(f&&W===f)continue;const ie=H.get(W);ie&&V(ie,"#1e63d1",A.content||"Einsatz",Rn(A),{hover:!0})}const J=new Map;for(const A of _)for(const W of Ut(A))J.set(String(W),String(A.id));const Q=await $n(),fe=new Map(Q.filter(A=>Number.isFinite(A?.lat)&&Number.isFinite(A?.lng)&&A?.realname).map(A=>[Ve(A.realname),A])),le=await Pn(),K=new Map(le.filter(A=>A&&A.source!=="gps"&&Number.isFinite(A.latitude)&&Number.isFinite(A.longitude)).map(A=>[String(A.id),{lat:Number(A.latitude),lng:Number(A.longitude)}])),L=Ln(n.vehiclesById,le),xe=10,O=50,q=new Map,me=window.google?.maps?.marker?.AdvancedMarkerElement,ae=typeof me=="function"&&typeof me?.prototype?.addListener=="function"?me:null,Se=(A,W,ie)=>{if(!A)return gr;if(!W||!ie||!H.has(ie))return Fn;const de=H.get(ie);return hr(W,de)>.1?pr:Fn},he=(A,W,ie,de,ye,pe)=>{const oe=Se(W,de,ye),we=!de;if(ae){const Y=document.createElement("img");Y.src=oe,Y.width=_e,Y.height=_e,Y.alt=ie||"",Y.decoding="async";const X=new ae({map:$,position:A,content:Y,title:ie});if(we){try{X.draggable=!0}catch{}typeof X.addListener=="function"&&X.addListener("dragend",async ce=>{const R=ce?.latLng||X.position,ee=typeof R.lat=="function"?R.lat():R.lat,ve=typeof R.lng=="function"?R.lng():R.lng;try{await pn(pe,ee,ve,ye,"manual")}catch(Ne){X.__setPosition(A),console.error("setVehiclePosition failed:",Ne),alert("Position konnte nicht gespeichert werden.")}})}return X.__setPosition=ce=>{X.position=ce},X.__setIcon=(ce,R,ee)=>{Y.src=Se(ce,R,ee)},X.__onOver=ce=>{Y.addEventListener("mouseover",ce),Y.addEventListener("mouseout",()=>D.close())},X}else{const Y=new window.google.maps.Marker({position:A,map:$,title:ie,draggable:we,icon:{url:oe,scaledSize:new window.google.maps.Size(_e,_e),anchor:new window.google.maps.Point(_e/2,_e/2)}});return we&&Y.addListener("dragend",async X=>{const ce=X?.latLng||Y.getPosition(),R=typeof ce.lat=="function"?ce.lat():ce.lat,ee=typeof ce.lng=="function"?ce.lng():ce.lng;try{await pn(pe,R,ee,ye,"manual")}catch(ve){Y.__setPosition(A),console.error("setVehiclePosition failed:",ve),alert("Position konnte nicht gespeichert werden.")}}),Y.__setPosition=X=>Y.setPosition(X),Y.__setIcon=(X,ce,R)=>Y.setIcon({url:Se(X,ce,R),scaledSize:new window.google.maps.Size(_e,_e),anchor:new window.google.maps.Point(_e/2,_e/2)}),Y.__onOver=X=>{Y.addListener("mouseover",X),Y.addListener("mouseout",()=>D.close())},Y}};for(const A of L){const W=String(A.id),ie=Ve(`${A?.label||""} ${A?.ort||""}`),de=Ve(A?.label||""),ye=Ve(A?.ort||""),pe=fe.get(ie)||fe.get(de)||fe.get(ye),oe=J.get(W),we=K.has(W);if(!oe&&!pe&&!we)continue;let Y=null,X=null;if(pe)X={lat:Number(pe.lat),lng:Number(pe.lng)},Y=X;else if(we)Y=K.get(W);else if(oe){const Ne=H.get(oe)||(f===oe?N:null),Ie=((q.get(oe)||0)+O)%360;q.set(oe,Ie),Ne&&(Y=Ht(Ne,xe,Ie))}if(!Y)continue;const R=he(Y,!!oe,A.label||A.id,X,oe,W),ee=oe&&_.find(Ne=>String(Ne.id)===oe),ve=ee?`<br/><i>zugeordnet: ${ee.content}</i>`:"";R.__onOver(()=>{const Ne=A?.ort||"";D.setContent(`<div style="min-width:220px"><b>${A.label||A.id}</b>${Ne?`<br/>${Ne}`:""}${ve}</div>`);const Te=ae?void 0:R;D.open({map:$,anchor:Te,position:Y,shouldFocus:!1})}),S.set(W,R)}$.setCenter(N),$.setZoom(18),x=setInterval(async()=>{const A=await $n(),W=await Pn();if(!g||typeof g!="object"||!g.columns){const R=await Tn();if(M)return;R&&typeof R=="object"&&(g=R)}const ie=g||n?.board,de=new Map(W.filter(R=>R&&R.source!=="gps"&&Number.isFinite(R.latitude)&&Number.isFinite(R.longitude)).map(R=>[String(R.id),{lat:Number(R.latitude),lng:Number(R.longitude)}])),ye=new Map(A.filter(R=>Number.isFinite(R?.lat)&&Number.isFinite(R?.lng)&&R?.realname).map(R=>[Ve(R.realname),R])),pe=new Map,oe=[...ie?.columns?.neu?.items||[],...ie?.columns?.["in-bearbeitung"]?.items||[]];for(const R of oe){const ee=R?.id!=null?String(R.id):null;if(ee)for(const ve of Ut(R))pe.set(String(ve),ee)}if(f)for(const R of Ut(n.card))pe.set(String(R),f);const we=Ln(n.vehiclesById,W),Y=new Map;for(const R of we){const ee=String(R.id),ve=pe.get(ee),Ne=Ve(`${R?.label||""} ${R?.ort||""}`);if(ve&&!ye.get(Ne)&&!de.has(ee)){const Te=Y.get(ve)||[];Te.push(ee),Y.set(ve,Te)}}for(const[R,ee]of Y.entries())ee.sort();const X=10,ce=50;for(const R of we){const ee=String(R.id),ve=Ve(`${R?.label||""} ${R?.ort||""}`),Ne=Ve(R?.label||""),Te=Ve(R?.ort||""),Ie=ye.get(ve)||ye.get(Ne)||ye.get(Te),je=pe.get(ee);let ue=null;const Le=de.has(ee),$e=!!je||!!Ie||!!Le;let Ee=S.get(ee);if(!Ee&&$e){let p=null;if(Ie)ue={lat:Number(Ie.lat),lng:Number(Ie.lng)},p=ue;else if(Le)p=de.get(ee);else if(je){const te=H.get(je)||(f===je?N:null);if(te){const We=((Y.get(je)||[]).indexOf(ee)+1)*ce%360;p=Ht(te,X,We)}}p&&(Ee=he(p,!!je,R.label||R.id,ue,je,ee),S.set(ee,Ee))}if(!Ee)continue;if(Ie)ue={lat:Number(Ie.lat),lng:Number(Ie.lng)},Ee.__setPosition(ue);else if(de.has(ee))Ee.__setPosition(de.get(ee));else if(je){const p=H.get(je)||(f===je?N:null);if(p){const ge=((Y.get(je)||[]).indexOf(ee)+1)*ce%360;Ee.__setPosition(Ht(p,X,ge))}else{const te=S.get(ee);te&&(te.setMap?te.setMap(null):te.map&&(te.map=null),S.delete(ee));continue}}else{const p=S.get(ee);p&&(p.setMap?p.setMap(null):p.map&&(p.map=null),S.delete(ee));continue}const Ge=!!je;Ee.__setIcon(Ge,ue,je)}},5e3)}catch(N){E(N?.message||"Kartenaufbau fehlgeschlagen.")}finally{k(!1)}})(),()=>{M=!0,x&&clearInterval(x);for(const N of S.values())N?.setMap?N.setMap(null):N&&(N.map=null);S.clear()}},[u,n,z]),!u||!n?.card){const M=`https://www.google.com/maps?q=${encodeURIComponent(c)}&output=embed`;return e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:i,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[70vh] p-2",onClick:$=>$.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-semibold text-sm",children:["Karte: ",c]}),e.jsx("button",{className:"px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm",onClick:i,children:"SchlieÃŸen"})]}),e.jsx("iframe",{title:"maps",className:"w-full h-full rounded-lg border",src:M,loading:"lazy"})]})})}return e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:i,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-5xl h-[75vh] p-2",onClick:M=>M.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-semibold text-sm",children:["Karte: ",n?.card?.content||"Einsatz"," Â· weitere EinsÃ¤tze (Neu & In Bearbeitung)"]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm",onClick:i,children:"SchlieÃŸen"})})]}),e.jsx("div",{ref:b,className:"w-full h-full rounded-lg border"}),v&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"px-3 py-1.5 rounded bg-white shadow text-sm",children:"Ladeâ€¦"})}),!!j&&e.jsx("div",{className:"absolute bottom-3 left-3 px-2 py-1 rounded bg-red-600 text-white text-xs shadow",children:j})]})})}function xr({onClose:n,onCreate:s}){const[i,c]=a.useState(""),[u,b]=a.useState(""),[m,v]=a.useState(0),[k,j]=a.useState(!1),[E,z]=a.useState(""),M=async $=>{if($.preventDefault(),z(""),!i.trim()||!u.trim()){z("Ort und Name sind erforderlich.");return}try{j(!0),await s({ort:i.trim(),label:u.trim(),mannschaft:Number(m)||0}),n()}catch(D){z(D?.message||"Speichern fehlgeschlagen.")}finally{j(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:e.jsxs("form",{onSubmit:M,className:"bg-white rounded-xl shadow-lg p-4 w-[360px] space-y-3",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Einheit anlegen"}),E&&e.jsx("div",{className:"text-sm text-red-600",children:E}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Ort"}),e.jsx("input",{className:"border rounded px-2 py-1 w-full",value:i,onChange:$=>c($.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Name"}),e.jsx("input",{className:"border rounded px-2 py-1 w-full",value:u,onChange:$=>b($.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Mannschaft"}),e.jsx("input",{type:"number",min:"0",className:"border rounded px-2 py-1 w-24",value:m,onChange:$=>v($.target.value)})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:n,className:"px-3 py-1 rounded border",disabled:k,children:"Abbrechen"}),e.jsx("button",{type:"submit",className:"px-3 py-1 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:k,children:k?"Anlegenâ€¦":"Anlegen"})]})]})})}let yt=null;function Wt(){const n=document.querySelector('meta[name="google-places-key"]');return(window.GMAPS_API_KEY||n?.content||"").trim()||""}async function Vn(n=Wt()){if(window.google?.maps?.places)return!0;if(!n)return!1;if(yt)return await yt,!!window.google?.maps?.places;yt=new Promise((s,i)=>{if(document.getElementById("gmap-places")){const u=()=>{window.google?.maps?.places?s(!0):setTimeout(u,150)};u();return}const c=document.createElement("script");c.id="gmap-places",c.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(n)}&libraries=places&language=de`,c.async=!0,c.defer=!0,c.onload=()=>s(!!window.google?.maps?.places),c.onerror=u=>i(u),document.head.appendChild(c)});try{await yt}catch{}return!!window.google?.maps?.places}function yr({debounceMs:n=300,country:s="at",minLength:i=3}={}){const[c,u]=a.useState(""),[b,m]=a.useState([]),[v,k]=a.useState(!1),[j,E]=a.useState(!1),[z,M]=a.useState(null),$=a.useRef(null),D=a.useRef(null),S=a.useRef(null),x=a.useRef(null);a.useEffect(()=>{let _=!1;return(async()=>{const U=await Vn(Wt());_||!U||!window.google?.maps?.places||($.current=new google.maps.places.AutocompleteService,D.current=new google.maps.places.PlacesService(document.createElement("div")),S.current=new google.maps.places.AutocompleteSessionToken,_||E(!0))})(),()=>{_=!0}},[]);const f=a.useCallback(()=>{window.google?.maps?.places&&(S.current=new google.maps.places.AutocompleteSessionToken)},[]),g=a.useRef();a.useEffect(()=>{g.current||(g.current=(_,U)=>{let se;return(...re)=>{clearTimeout(se),se=setTimeout(()=>_(...re),U)}})},[]);const T=a.useCallback(async _=>{if(!j||!$.current)return;const U=(_||"").trim();if(!U||U.length<i){m([]);return}k(!0),M(null),$.current.getPlacePredictions({input:U,sessionToken:S.current,componentRestrictions:{country:s},types:["address"]},(se,re)=>{if(k(!1),re!==google.maps.places.PlacesServiceStatus.OK||!se){m([]),re&&re!=="ZERO_RESULTS"&&M(re);return}m(se)})},[s,i,j]),C=a.useMemo(()=>g.current?g.current(T,n):()=>{},[T,n]);a.useEffect(()=>{C(c)},[c,C]);const N=a.useCallback((_,U=["formatted_address","geometry","address_components"])=>new Promise((se,re)=>{if(!j||!D.current){re(new Error("Google Places nicht bereit"));return}D.current.getDetails({placeId:_,fields:U,sessionToken:S.current},(G,H)=>{if(H!==google.maps.places.PlacesServiceStatus.OK||!G)return re(new Error(H||"DETAILS_FAILED"));se(G)})}),[j]),V=a.useCallback(()=>{m([])},[]);return{ready:j,query:c,setQuery:u,predictions:b,loading:v,error:z,resetSession:f,getDetailsByPlaceId:N,clearPredictions:V,inputElRef:x}}function tt(n){return String(n??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}function wr(){const n=document.querySelector('meta[name="google-places-key"]');return(window.GMAPS_API_KEY||n?.content||"").trim()||void 0}function lt(n){if(!n)return null;if(typeof n=="string"){const s=n.trim().match(/^\s*([+-]?\d+(?:\.\d+)?)\s*,\s*([+-]?\d+(?:\.\d+)?)\s*$/);if(!s)return null;const i=Number(s[1]),c=Number(s[2]);return Number.isFinite(i)&&Number.isFinite(c)?{lat:i,lng:c}:null}if(typeof n=="object"&&n){if(typeof n.lat=="function"&&typeof n.lng=="function"){const c=Number(n.lat()),u=Number(n.lng());if(Number.isFinite(c)&&Number.isFinite(u))return{lat:c,lng:u}}if(typeof n.toJSON=="function"){const c=n.toJSON();if(c&&c!==n){const u=lt(c);if(u)return u}}const s=Number(n.lat??n.latitude),i=Number(n.lng??n.longitude);if(Number.isFinite(s)&&Number.isFinite(i))return{lat:s,lng:i}}return null}async function Un(n){try{const s=String(n||"").trim();if(!s)return null;const i=await fetch(`/api/geocode?q=${encodeURIComponent(s)}`,{credentials:"include",cache:"no-store"});if(!i.ok)return null;const c=await i.json(),u=Number(c?.lat),b=Number(c?.lng);return!Number.isFinite(u)||!Number.isFinite(b)?null:{lat:u,lng:b,formatted:c?.formatted||s}}catch{return null}}function vr({lat:n,lng:s,address:i,apiKey:c,zoom:u=16,size:b="800x400",scale:m=2}){if(Number.isFinite(n)&&Number.isFinite(s)){if(c){const j="https://maps.googleapis.com/maps/api/staticmap",E=`center=${n},${s}&zoom=${u}&size=${b}&scale=${m}&markers=color:red|label:E|${n},${s}&maptype=roadmap`;return`${j}?${E}&key=${c}`}const k=b.toLowerCase().replace("x","x");return`https://staticmap.openstreetmap.de/staticmap.php?center=${n},${s}&zoom=${u}&size=${k}&markers=${n},${s},red-pushpin`}if(c&&i){const k="https://maps.googleapis.com/maps/api/staticmap",j=encodeURIComponent(i),E=`center=${j}&zoom=${u}&size=${b}&scale=${m}&markers=color:red|label:E|${j}&maptype=roadmap`;return`${k}?${E}&key=${c}`}return""}function Hn({title:n,type:s,location:i,timestamp:c,infoRowsHtml:u,mapSrc:b,staticMapUrl:m,notesSection:v,autoPrint:k}){const j=`
    <script>
      // Markiert, wenn Karte (iFrame ODER Bild) bereit ist â€“ z.B. fÃ¼r automatischen Druck
      (function(){
        window.__incidentMapReady = false;

        function markReady(){
          if (window.__incidentMapReady) return;
          window.__incidentMapReady = true;
          try { document.body.setAttribute('data-map-ready', '1'); } catch(e){}
      if (${k?"true":"false"}) {
            // Nur EINMAL drucken
            if (!window.__alreadyPrinted) {
              window.__alreadyPrinted = true;
             setTimeout(() => { try { window.print(); } catch(e){} }, 100);
            }
          }
        }

        function watchIframeOrImage(){
          const frame = document.querySelector('.map-frame iframe');
          const img = document.querySelector('.map-frame img.map-static');

          // Wenn Bild vorhanden â†’ auf Bild warten (fÃ¼r Print wichtig)
          if (img) {
            if (img.complete) {
              markReady();
            } else {
              img.addEventListener('load', markReady, { once: true });
              img.addEventListener('error', markReady, { once: true });
              setTimeout(markReady, 3000); // Fallback
            }
          }

          // Wenn iFrame vorhanden â†’ auch auf iFrame warten (fÃ¼r Screen)
          if (frame) {
            const safeFinish = () => { markReady(); };
            try {
              frame.addEventListener('load', safeFinish, { once: true });
              frame.addEventListener('error', safeFinish, { once: true });
            } catch { /* ignore */ }

            // Cross-Origin iFrame? Dann lieber Timeout
            setTimeout(safeFinish, 3000);
          }

          // Wenn weder Bild noch iFrame: sofort ready
          if (!img && !frame) markReady();
        }

        if (document.readyState === 'complete') watchIframeOrImage();
        else window.addEventListener('load', watchIframeOrImage, { once: true });
      })();
    <\/script>
  `;return`<!DOCTYPE html>
  <html lang="de">
    <head>
      <meta charSet="utf-8" />
      <title>Einsatzdruck â€“ ${tt(n||s||"Neuer Einsatz")}</title>
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <style>
        * { box-sizing: border-box; font-family: "Inter", "Helvetica Neue", Arial, sans-serif; color:#0f172a; }
        body { margin:0; padding:0; background:#e2e8f0; }
        .sheet { max-width: 190mm; margin: 18px auto; background:#fff; border-radius:16px; padding:22px 26px;
                 box-shadow: 0 12px 32px rgba(15,23,42,0.18); }
        header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; }
        header h1 { margin:0; font-size:20px; }
        header span { font-size:12px; color:#475569; }
        section { margin-top:20px; }
        .info { display:flex; flex-direction:column; gap:10px; }
        .row { display:flex; gap:14px; }
        .label { width:120px; font-weight:600; font-size:13px; text-transform:uppercase; letter-spacing:.04em; color:#475569; }
        .value { flex:1; font-size:14px; line-height:1.4; }
        .map-section h2, .notes h2 { font-size:16px; margin:0 0 10px; }
        .map-frame { width:100%; aspect-ratio: 4 / 3; border-radius:14px; overflow:hidden; border:1px solid #cbd5e1; background:#f8fafc; }
        .map-frame iframe { width:100%; height:100%; border:0; display:block; }
        .map-frame img.map-static { width:100%; height:100%; object-fit:cover; display:none; }
        .notes div { font-size:14px; line-height:1.5; white-space:pre-wrap; }
        footer { margin-top:24px; font-size:11px; color:#64748b; text-align:right; }

        @media print {
          body { background:#fff; }
          .sheet { box-shadow:none; margin:0; max-width:unset; width:100%; border-radius:0; }
          @page { size: A4; margin: 12mm; }
          .map-frame iframe { display:none !important; }
          .map-frame img.map-static { display:block !important; }
        }
      </style>
    </head>
    <body>
      <div class="sheet">
        <header>
          <h1>Einsatzinformation</h1>
          <span>Druck erstellt am ${tt(c||"")}</span>
        </header>

        <section class="info">
          ${u||""}
        </section>

        <section class="map-section">
          <h2>Einsatzkarte</h2>
          <div class="map-frame">
            <iframe src="${b}" title="Einsatzkarte" loading="lazy"></iframe>
            <img class="map-static" alt="Einsatzkarte" src="${m}" referrerpolicy="no-referrer" />
          </div>
        </section>

        ${v||""}

        <footer>Einsatzstellen-Ãœbersicht</footer>
      </div>
      ${j}
    </body>
  </html>`}async function Kn({title:n="",type:s="",locationLabel:i="",notes:c="",isArea:u=!1,areaColor:b,areaLabel:m,coordinates:v=null}){const j=new Date().toLocaleString("de-AT",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),E=(n||"").trim(),z=(s||"").trim();let M=(i||"").trim(),$=lt(v);try{if(!$&&M){const C=await Un(M);C&&($={lat:C.lat,lng:C.lng},C.formatted&&(M=C.formatted))}}catch{}const D=$?`${$.lat},${$.lng}`:M||E||z||"Ã–sterreich",S=`https://www.google.com/maps?q=${encodeURIComponent(D)}&output=embed&hl=de&z=15`;let x=vr({lat:$?.lat,lng:$?.lng,address:M||E||z||"Ã–sterreich",apiKey:wr()});x||(x=`https://placehold.co/800x400?text=${encodeURIComponent("Keine Karte verfÃ¼gbar")}`);const f=[["Einsatz",E||z||"â€”"],["Art",z||"â€”"],["Ort",M||"â€”"],...u?[["Bereich",`${tt(m||"Bereich")} ${b?`<span class="color-chip" style="background:${tt(b)}"></span>`:""}`]]:[]].map(([C,N])=>`
      <div class="row">
        <div class="label">${tt(C)}</div>
        <div class="value">${typeof N=="string"?N:N??"â€”"}</div>
      </div>`).join(""),g=c?`<section class="notes"><h2>Hinweise</h2><div>${tt(c)}</div></section>`:"";return{html:Hn({title:E,type:z,location:M,timestamp:j,infoRowsHtml:f,mapSrc:S,staticMapUrl:x,notesSection:g,autoPrint:!1}),title:E,type:z,location:M,timestamp:j,mapSrc:S,staticMapUrl:x,notes:c,isArea:!!u,infoRowsHtml:f,notesSection:g}}async function Gn({title:n="",type:s="",locationLabel:i="",notes:c="",isArea:u=!1,areaColor:b,areaLabel:m,coordinates:v=null,incidentId:k}){const j=await Kn({title:n,type:s,locationLabel:i,notes:c,isArea:u,areaColor:b,areaLabel:m,coordinates:v}),{html:E,title:z,type:M,location:$,timestamp:D,mapSrc:S,staticMapUrl:x,infoRowsHtml:f,notesSection:g}=j;try{const T=document.createElement("iframe");T.style.position="fixed",T.style.right="0",T.style.bottom="0",T.style.width="0",T.style.height="0",T.style.border="0",document.body.appendChild(T);const C=T.contentDocument||T.contentWindow?.document;if(!C)throw new Error("Kein iFrame-Dokument verfÃ¼gbar.");C.open(),C.write(E),C.close();const N=T.contentWindow;let V=!1;const _=()=>{if(!V){V=!0;try{N.focus()}catch{}try{N.print()}catch{}}},U=()=>{if(!V){try{if(!N||!N.document)return void setTimeout(U,150);if(N.__incidentMapReady===!0||N.document.body&&N.document.body.getAttribute("data-map-ready")==="1")return _()}catch{}setTimeout(U,150)}};try{T.addEventListener("load",()=>setTimeout(U,50),{once:!0})}catch{}setTimeout(U,200);return}catch{const C=window.open("","_blank","noopener,noreferrer,width=980,height=1200"),N=Hn({title:z,type:M,location:$,timestamp:D,infoRowsHtml:f,mapSrc:S,staticMapUrl:x,notesSection:g,autoPrint:!0});try{if(C&&C.document)C.document.open(),C.document.write(N),C.document.close();else{const V=new Blob([N],{type:"text/html"}),_=URL.createObjectURL(V);window.location.href=_}}catch{}}}function Sr({onClose:n,onCreate:s,types:i,areaOptions:c=[]}){const u="#2563eb",[b,m]=a.useState(""),[v,k]=a.useState(""),[j,E]=a.useState(!1),[z,M]=a.useState(!1),[$,D]=a.useState(""),[S,x]=a.useState(u),[f,g]=a.useState(""),[T,C]=a.useState(!1),N=a.useRef(null),{query:V,setQuery:_,predictions:U,getDetailsByPlaceId:se,resetSession:re,loading:G,error:H,clearPredictions:J}=yr({country:"at",debounceMs:300,minLength:3});a.useEffect(()=>{setTimeout(()=>N.current?.focus(),0)},[]),a.useEffect(()=>{const L=(v||"").replace(/^T\d+\s*,?\s*/i,"").trim();!b.trim()&&L&&m(L)},[v]);const Q=a.useRef(null);a.useEffect(()=>{z&&(D(""),x(L=>L||u))},[z]);const fe=async L=>{L?.preventDefault?.();const xe=(v||"").replace(/^T\d+\s*,?\s*/i,"").trim(),O=(b||xe).trim();if(O){E(!0);try{let q=null,me=(V||"").trim();const ae=Q.current;if(ae){const he=lt(ae.geometry?.location);he&&(q=he);const A=ae.formatted_address||ae.name||"";A&&(me=A)}if(!q&&me){const he=await Un(me);he&&(q={lat:he.lat,lng:he.lng},he.formatted&&(me=he.formatted))}const Se=(f||"").trim();await s({title:O,ort:(V||"").trim(),typ:(v||"").trim(),isArea:z,areaCardId:z?null:$||null,areaColor:z?S:void 0,coordinates:q,location:me,description:Se}),m(""),_(""),k(""),M(!1),D(""),x(u),g(""),Q.current=null,re(),J(),n?.()}finally{E(!1)}}},le=async L=>{try{const xe=await se(L.place_id,["formatted_address","geometry","address_components","place_id"]),O=xe?.formatted_address||L.description;_(O),Q.current=xe||null}catch{Q.current=null,_(L.description)}finally{re(),J()}},K=async()=>{if(T)return;const L=(v||"").replace(/^T\d+\s*,?\s*/i,"").trim(),xe=(b||L).trim(),O=(V||"").trim(),q=(f||"").trim(),me=c.find(ae=>String(ae.id)===String($));try{C(!0);let ae=O,Se=null;const he=Q.current;if(he){const A=lt(he.geometry?.location);A&&(Se=A);const W=he.formatted_address||he.name||"";W&&(ae=W)}await Gn({title:xe,type:L,locationLabel:ae,notes:q,isArea:z,areaColor:z?S:void 0,areaLabel:!z&&me?me.label:void 0,coordinates:Se,incidentId:xe||L||void 0})}catch(ae){const Se=ae?.message||ae||"Unbekannter Fehler";alert(`Drucken fehlgeschlagen: ${Se}`)}finally{C(!1)}};return e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-3",children:e.jsxs("form",{onSubmit:fe,className:"bg-white rounded-xl shadow-lg w-[520px] max-w-full p-4 space-y-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Einsatz anlegen"}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs("select",{ref:N,className:"border rounded px-2 py-1",value:v,onChange:L=>k(L.target.value),children:[e.jsx("option",{value:"",children:"â€” Typ auswÃ¤hlen â€”"}),(i||[]).map(L=>e.jsx("option",{value:L,children:L},L))]}),e.jsx("input",{className:"border rounded px-2 py-1",placeholder:"Titel (wird aus Typ Ã¼bernommen)",value:b,onChange:L=>m(L.target.value)}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{className:"border rounded px-2 py-1 w-full",placeholder:"Ort (nur Ã–sterreich)",autoComplete:"off",value:V,onChange:L=>{Q.current=null,_(L.target.value)}}),G&&e.jsx("div",{className:"absolute z-10 mt-1 text-xs text-gray-500 bg-white border rounded px-2 py-1",children:"Sucheâ€¦"}),H&&e.jsxs("div",{className:"absolute z-10 mt-1 text-xs text-red-600 bg-white border rounded px-2 py-1",children:["Fehler: ",String(H)]}),!!U.length&&e.jsx("ul",{className:"absolute z-10 mt-1 w-full max-h-52 overflow-auto bg-white border rounded shadow",children:U.map(L=>e.jsx("li",{className:"px-2 py-1 hover:bg-gray-100 cursor-pointer text-sm",onClick:()=>le(L),title:L.description,children:L.description},L.place_id))})]}),e.jsxs("label",{className:"text-sm font-medium text-gray-700",children:["Notiz",e.jsx("textarea",{className:"mt-1 w-full border rounded px-2 py-1 resize-y min-h-[90px]",value:f,onChange:L=>g(L.target.value),disabled:j})]}),e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:z,onChange:L=>M(L.target.checked),disabled:j}),"Abschnitt"]}),!z&&e.jsxs("select",{className:"border rounded px-2 py-1 text-sm",value:$,onChange:L=>D(L.target.value),disabled:j||c.length===0,children:[e.jsx("option",{value:"",children:"â€” Abschnitt auswÃ¤hlen â€”"}),c.map(L=>e.jsx("option",{value:L.id,children:L.label},L.id))]})]}),z&&e.jsxs("div",{className:"flex items-center justify-between gap-3 text-sm text-gray-700",children:[e.jsx("span",{children:"Abschnittsfarbe"}),e.jsx("input",{type:"color",className:"h-9 w-16 border rounded cursor-pointer",value:S,onChange:L=>x(L.target.value),disabled:j})]}),!z&&c.length===0&&e.jsx("p",{className:"text-xs text-gray-500",children:"Noch keine Abschnitte vorhanden."})]}),e.jsxs("div",{className:"flex items-center justify-between gap-2 pt-1",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Informationen und Karte auf A4 drucken"}),e.jsx("button",{type:"button",onClick:K,className:"px-3 py-1 rounded border bg-white hover:bg-gray-50 text-sm disabled:opacity-60",disabled:j||T,children:T?"Druckenâ€¦":"Drucken"})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:n,className:"px-3 py-1 rounded border",disabled:j,children:"Abbrechen"}),e.jsx("button",{className:"px-3 py-1 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:j,children:j?"Anlegenâ€¦":"Anlegen"})]})]})})}function Nr({colId:n,title:s,bg:i,children:c,editable:u=!0}){if(!u)return e.jsxs("section",{className:`${i} rounded-xl shadow p-3 h-full flex flex-col min-h-0`,children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:s}),c]});const{setNodeRef:b,isOver:m}=_s({id:`col:${n}`,data:{type:"column",colId:n}});return e.jsxs("section",{ref:b,className:`${i} rounded-xl shadow p-3 h-full flex flex-col min-h-0 ${m?"outline outline-2 outline-blue-400":""}`,children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:s}),c]})}const jr=n=>{if(n==null)return"";const s=String(n).trim();return s?s.normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9_.-]+/g,"-").replace(/-+/g,"-").replace(/^-+/,"").replace(/-+$/,""):""};function Ar(){const[n,s]=a.useState(!1),[i,c]=a.useState(null),u=a.useCallback(async m=>{if(n)return!1;if(!m)return c({type:"error",message:"Kein Einsatz ausgewÃ¤hlt."}),!1;const v=window.prompt("Bitte E-Mail-Adresse fÃ¼r den Versand eingeben:");if(v==null)return!1;const k=v.trim();if(!k)return c({type:"error",message:"Keine E-Mail-Adresse angegeben."}),!1;if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(k))return c({type:"error",message:"E-Mail-Adresse ist ungÃ¼ltig."}),!1;s(!0),c(null);try{const E=m?.content||"",z=m?.typ||m?.type||"",M=m?.additionalAddressInfo||m?.ort||"",$=m?.description||"",D={lat:m?.latitude??m?.lat??null,lng:m?.longitude??m?.lng??null},S=[m?.humanId,m?.content,m?.id].map(G=>G!=null?String(G).trim():"").find(G=>G),x=await Kn({title:E,type:z,locationLabel:M,notes:$,coordinates:D,isArea:!!m?.isArea,areaColor:m?.areaColor,areaLabel:m?.areaLabel||m?.areaCardLabel}),f=jr(S)||"einsatz",g=x.title||x.type||S||f,T=g?`Einsatzkarte ${g}`:"Einsatzkarte",C=[];x.title&&C.push(`Einsatz: ${x.title}`),x.location&&C.push(`Ort: ${x.location}`),C.push(`Gesendet: ${x.timestamp}`);const V=`Im Anhang finden Sie die aktuelle Einsatzkarte.

${C.join(`
`)}`.trim(),U=`<p>Im Anhang finden Sie die aktuelle Einsatzkarte.</p><ul>${[x.title?`<li><strong>Einsatz:</strong> ${x.title}</li>`:"",x.location?`<li><strong>Ort:</strong> ${x.location}</li>`:"",`<li><strong>Gesendet:</strong> ${x.timestamp}</li>`].filter(Boolean).join("")}</ul>`,se=await fetch(`/api/incidents/${encodeURIComponent(f)}/mail`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({html:x.html,to:k,subject:T,textBody:V,htmlBody:U})}),re=await se.json().catch(()=>null);if(!se.ok||!re?.ok){const G=re?.detail||re?.error||se.statusText||"Versand fehlgeschlagen.";throw new Error(G)}return c({type:"success",message:"E-Mail wurde versendet."}),!0}catch(E){const z=E?.message||"E-Mail-Versand fehlgeschlagen.";return c({type:"error",message:z}),!1}finally{s(!1)}},[n]),b=a.useCallback(()=>c(null),[]);return{mailBusy:n,mailFeedback:i,sendMail:u,resetMailFeedback:b}}const ot="#2563eb";function kr(n={}){const s=n?.humanId?String(n.humanId):"",i=n?.content?String(n.content):"";return[s,i].filter(Boolean).join(" â€“ ")||s||i||"Abschnitt"}function wt(n={}){return{title:n?.content||"",typ:n?.typ||n?.type||"",ort:n?.additionalAddressInfo||n?.ort||"",description:n?.description||"",isArea:!!n?.isArea,areaCardId:n?.isArea?"":n?.areaCardId||"",areaColor:n?.isArea?n?.areaColor||ot:n?.areaColor||""}}function Cr({open:n,onClose:s,info:i={},canEdit:c=!1,onSave:u,areaOptions:b=[],areaLabelById:m=new Map,forceEdit:v=!1,types:k=[]}){if(!n)return null;const j=a.useMemo(()=>i?.isEditable!==!1,[i?.isEditable]),[E,z]=a.useState(!1),[M,$]=a.useState(!1),[D,S]=a.useState(!1),[x,f]=a.useState(()=>wt(i)),[g,T]=a.useState(""),{mailBusy:C,mailFeedback:N,sendMail:V,resetMailFeedback:_}=Ar(),U=i?.timestamp,se=U?new Date(U).toLocaleString("de-AT",{hour12:!1}):"â€”",re=a.useMemo(()=>{const O=[];return i.location&&O.push(String(i.location)),Number.isFinite(i.latitude)&&Number.isFinite(i.longitude)&&O.push(`(${i.latitude}, ${i.longitude})`),O.length?O.join(" "):void 0},[i]),G=a.useMemo(()=>b.filter(O=>O.id!==i?.id),[b,i?.id]),H=a.useMemo(()=>{if(i?.isArea)return kr(i);if(!i?.areaCardId)return"â€”";const O=m.get(i.areaCardId);if(O)return O;const q=b.find(me=>me.id===i.areaCardId);return q?q.label:String(i.areaCardId)},[i,m,b]);a.useEffect(()=>{f(wt(i)),T(""),$(!1),z(!!(v&&c&&j))},[i,v,c,j,n]),a.useEffect(()=>{_()},[i?.id,n,_]);const J=()=>{M||(z(!1),T(""),s?.())},Q=()=>{!c||!j||(f(wt(i)),T(""),z(!0))},fe=()=>{M||(f(wt(i)),T(""),z(!1))},le=async()=>{if(D)return;const O=i?.content||"",q=i?.typ||i?.type||"",me=i?.location||i?.additionalAddressInfo||i?.ort||"",ae=i?.description||"",Se=lt({lat:i?.latitude??i?.lat,lng:i?.longitude??i?.lng}),he=!i?.isArea&&H&&H!=="â€”"?H:"",A=[i?.humanId,i?.content,i?.id].map(W=>W!=null?String(W).trim():"").find(W=>W);S(!0);try{await Gn({title:O,type:q,locationLabel:me,notes:ae,isArea:!!i?.isArea,areaColor:i?.isArea?i?.areaColor||ot:void 0,areaLabel:he||void 0,coordinates:Se,incidentId:A})}catch(W){const ie=W?.message||W||"Drucken fehlgeschlagen.";alert(typeof ie=="string"?ie:String(ie))}finally{S(!1)}},K=async O=>{if(O?.preventDefault?.(),!u||!i?.id){z(!1);return}const q=(x.title||"").trim();if(!q){T("Titel darf nicht leer sein.");return}$(!0),T("");try{await u(i.id,{title:q,typ:(x.typ||"").trim(),ort:(x.ort||"").trim(),description:(x.description||"").trim(),isArea:!!x.isArea,areaCardId:x.isArea?null:x.areaCardId||null,areaColor:x.isArea?x.areaColor||ot:void 0}),z(!1)}catch(me){const ae=me?.message||"Speichern fehlgeschlagen.";T(ae)}finally{$(!1)}},L=({label:O,value:q})=>e.jsxs("div",{className:"flex items-start gap-3 py-1",children:[e.jsx("div",{className:"w-32 shrink-0 text-gray-600",children:O}),e.jsx("div",{className:"flex-1 font-medium break-words",children:q??"â€”"})]}),xe=()=>e.jsxs("form",{onSubmit:K,className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-700",children:["Titel",e.jsx("input",{className:"mt-1 w-full border rounded px-2 py-1",value:x.title,onChange:O=>f(q=>({...q,title:O.target.value})),disabled:M})]}),e.jsxs("label",{className:"text-sm font-medium text-gray-700",children:["Typ",e.jsx("input",{className:"mt-1 w-full border rounded px-2 py-1",value:x.typ,onChange:O=>f(q=>({...q,typ:O.target.value})),list:"incident-info-types",disabled:M}),e.jsx("datalist",{id:"incident-info-types",children:(k||[]).map(O=>e.jsx("option",{value:O},O))})]}),e.jsxs("label",{className:"text-sm font-medium text-gray-700",children:["Ort",e.jsx("input",{className:"mt-1 w-full border rounded px-2 py-1",value:x.ort,onChange:O=>f(q=>({...q,ort:O.target.value})),disabled:M})]}),e.jsxs("label",{className:"text-sm font-medium text-gray-700",children:["Alarmzeit",e.jsx("input",{className:"mt-1 w-full border rounded px-2 py-1 bg-gray-100",value:se,disabled:!0,readOnly:!0})]}),e.jsxs("label",{className:"text-sm font-medium text-gray-700",children:["Notiz",e.jsx("textarea",{className:"mt-1 w-full border rounded px-2 py-1 resize-y min-h-[90px]",value:x.description,onChange:O=>f(q=>({...q,description:O.target.value})),disabled:M})]}),e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:x.isArea,onChange:O=>f(q=>({...q,isArea:O.target.checked,areaCardId:O.target.checked?"":q.areaCardId,areaColor:O.target.checked?q.areaColor||ot:q.areaColor})),disabled:M}),"Abschnitt"]}),!x.isArea&&e.jsxs("select",{className:"border rounded px-2 py-1 text-sm",value:x.areaCardId,onChange:O=>f(q=>({...q,areaCardId:O.target.value})),disabled:M||G.length===0,children:[e.jsx("option",{value:"",children:"â€” Abschnitt auswÃ¤hlen â€”"}),G.map(O=>e.jsx("option",{value:O.id,children:O.label},O.id))]})]}),!x.isArea&&G.length===0&&e.jsx("p",{className:"text-xs text-gray-500",children:"Noch keine Abschnitte vorhanden."}),x.isArea&&e.jsxs("div",{className:"flex items-center justify-between gap-3 text-sm text-gray-700",children:[e.jsx("span",{children:"Farbe"}),e.jsx("input",{type:"color",className:"h-9 w-16 border rounded cursor-pointer",value:x.areaColor||ot,onChange:O=>f(q=>({...q,areaColor:O.target.value})),disabled:M})]})]}),g&&e.jsx("p",{className:"text-sm text-red-600",children:g}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",className:"px-3 py-1.5 rounded border",onClick:fe,disabled:M,children:"Abbrechen"}),e.jsx("button",{type:"submit",className:"px-3 py-1.5 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:M,children:M?"Speichernâ€¦":"Speichern"})]})]});return e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:J}),e.jsxs("div",{className:"relative z-[101] w-[min(92vw,640px)] rounded-xl bg-white shadow-xl p-4 md:p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3 gap-2",children:[e.jsx("h2",{className:"text-lg md:text-xl font-bold",children:"Einsatz-Info"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",className:"px-3 py-1.5 rounded border bg-white text-sm hover:bg-gray-50 disabled:opacity-60",onClick:()=>V(i),disabled:C||!i,children:C?"Sendeâ€¦":"Mail senden"}),c&&j&&!E&&e.jsx("button",{type:"button",className:"px-3 py-1.5 rounded border bg-white text-sm hover:bg-gray-50",onClick:Q,children:"Bearbeiten"}),e.jsx("button",{type:"button",className:"px-3 py-1.5 rounded border bg-white text-sm hover:bg-gray-50 disabled:opacity-60",onClick:le,disabled:D,children:D?"Druckenâ€¦":"Drucken"}),e.jsx("button",{className:"h-8 w-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center",onClick:J,"aria-label":"SchlieÃŸen",title:"SchlieÃŸen",children:e.jsx("svg",{viewBox:"0 0 12 12",width:"14",height:"14","aria-hidden":"true",children:e.jsx("path",{d:"M1 1 L11 11 M11 1 L1 11",stroke:"black",strokeWidth:"2",strokeLinecap:"round"})})})]})]}),N&&e.jsx("div",{className:`mb-3 rounded border px-3 py-2 text-sm ${N.type==="error"?"border-red-200 bg-red-50 text-red-700":"border-emerald-200 bg-emerald-50 text-emerald-700"}`,children:N.message}),E?xe():e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(L,{label:"Titel",value:i.content}),e.jsx(L,{label:"Typ",value:i.typ||i.type}),e.jsx(L,{label:"Einsatz ID",value:i.humanId}),e.jsx(L,{label:"Alarmzeit",value:se}),e.jsx(L,{label:"Alarmiert",value:i.alerted}),e.jsx(L,{label:"Notiz",value:i.description}),e.jsx(L,{label:"Adresse",value:i.additionalAddressInfo||i.ort}),e.jsx(L,{label:"Location",value:re}),e.jsx(L,{label:"Abschnitt",value:i.isArea&&i.areaColor?e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx("span",{className:"h-4 w-4 rounded border",style:{backgroundColor:i.areaColor,borderColor:i.areaColor},"aria-hidden":!0}),H]}):H}),!i.isArea&&i.areaColor&&e.jsx(L,{label:"Farbe",value:e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx("span",{className:"h-4 w-4 rounded border",style:{backgroundColor:i.areaColor,borderColor:i.areaColor},"aria-hidden":!0}),i.areaColor]})})]}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx("button",{className:"px-3 py-1.5 rounded-md bg-emerald-600 text-white hover:bg-emerald-700",onClick:J,children:"OK"})})]})]})]})}const Ir="||",Dn="done:";function St(n){if(n==null)return"";try{return String(n).normalize("NFKC").toLowerCase().replace(/\s+/g," ").trim()}catch{return String(n).toLowerCase().replace(/\s+/g," ").trim()}}function Er(n){if(!n)return"";const s=n.replace(/\s+/g," ").trim();return s.length>200?s.slice(0,200)+"â€¦":s}function Mr(n){const s=String(n||"");if(s==="information"||s.startsWith("information."))return"Information";if(s==="rueckmeldung1"||s.startsWith("rueckmeldung1."))return"RÃ¼ckmeldung";if(s==="lagebericht"||s.startsWith("lagebericht."))return"Lagebericht";if(s.startsWith("otherRecipientConfirmation"))return"EmpfÃ¤ngerbestÃ¤tigung";if(s.startsWith("ergehtAn"))return"Verteiler (ergeht an)";if(s.startsWith("uebermittlungsart"))return"Ãœbermittlungsart";if(s==="datum"||s==="zeit")return"Datum/Zeit";if(s==="zu")return"Zu-Nummer";const i=/^massnahmen\.(\d+)(?:\.(.+))?$/.exec(s);if(i){const c=Number(i[1])+1,u=i[2]||"";return u==="text"?`MaÃŸnahme ${c} Text`:u==="done"?`MaÃŸnahme ${c} Status`:`MaÃŸnahme ${c}${u?` (${u})`:""}`}return s||"Feld"}function Nt(n){if(n===null||typeof n>"u")return"â€”";if(typeof n=="string"){const s=n.replace(/\s+/g," ").trim();return s?s.length>80?s.slice(0,77)+"â€¦":s:"â€”"}if(typeof n=="number"||typeof n=="boolean")return String(n);if(Array.isArray(n)){const s=n.length;return s===0?"[]":`[${s} EintrÃ¤ge]`}if(typeof n=="object"){if(typeof n.text=="string")return Nt(n.text);if(typeof n.name=="string")return Nt(n.name);try{const s=JSON.stringify(n);return s.length>80?s.slice(0,77)+"â€¦":s}catch{return"[Objekt]"}}return String(n)}function Pr(n){const s=Array.isArray(n?.history)?n.history:[];if(!s.length)return null;let i=null;for(let m=s.length-1;m>=0;m--){const v=s[m];if(v&&v.action==="update"&&Array.isArray(v.changes)){i=v;break}}if(!i)return null;const c=Array.isArray(i.changes)?i.changes:[];if(!c.length)return null;const u=[];for(const m of c){const v=Mr(m.path),k=Nt(m.before),j=Nt(m.after);k!==j&&u.push(`${v}: ${k} â†’ ${j}`)}if(!u.length)return null;const b=5;if(u.length>b){const m=u.slice(0,b),v=u.length-b;return m.push(`(+${v} weitere Ã„nderungen)`),m.join(`
`)}return u.join(`
`)}function Wn(n){const s=new Set;if(n==null)return s;const i=String(n),c=St(i);if(c){s.add(c);const b=c.replace(/\s+/g,"");b&&b!==c&&s.add(b)}const u=i.split(/[/()[\]|]+/);for(const b of u){const m=St(b);if(!m)continue;s.add(m);const v=m.replace(/\s+/g,"");v&&v!==m&&s.add(v)}return s}function Tr(n){const s=new Set,i=c=>{if(c!=null)for(const u of Wn(c))s.add(u)};return n&&typeof n=="object"&&(i(n.displayName),i(n.username),i(n.name),i(n.userId),n.id!=null&&i(n.id),i(n.role),n.role&&typeof n.role=="object"&&(i(n.role.id),i(n.role.name),i(n.role.label),i(n.role.displayName))),s}function zn(n){if(typeof n!="string"||!n)return{raw:n??null,base:n??null,doneSignature:null};const s=n.split(Ir),i=s[0]||n;let c=null;for(let u=1;u<s.length;u+=1){const b=s[u];if(b.startsWith(Dn)){const m=b.slice(Dn.length);if(!m)c="";else try{c=decodeURIComponent(m)}catch{c=m}}}return{raw:n,base:i,doneSignature:c}}function Lr(n){return Array.isArray(n)?n.reduce((s,i)=>{if(!i||i.action!=="print")return s;const c=Number(i?.printCount??i?.pages??0);return Number.isFinite(c)&&(s.sum+=Math.max(0,c),s.hasPrintEntries=!0),s},{sum:0,hasPrintEntries:!1}):{sum:0,hasPrintEntries:!1}}function $r(n){const{sum:s,hasPrintEntries:i}=Lr(n?.history);if(i)return s;const c=Number(n?.printCount);return Number.isFinite(c)?Math.max(0,c):0}function Rr({searchTerm:n=""}){const[s,i]=a.useState([]),[c,u]=a.useState(!0),{user:b}=On()||{},m=a.useMemo(()=>Tr(b),[b]),v=a.useMemo(()=>Bs(b),[b]),[k,j]=a.useState({});a.useEffect(()=>{if(!v){j({});return}j(bn(v))},[v]),a.useEffect(()=>{if(!v||typeof window>"u")return()=>{};const S=x=>{x?.key===v&&j(bn(v))};return window.addEventListener("storage",S),()=>{window.removeEventListener("storage",S)}},[v]);const E=a.useCallback((S,x)=>{v&&j(f=>Os(v,S,x,f))},[v]),z=a.useCallback((S,x)=>{E(S.nr,x),window.location.hash=`/protokoll/edit/${S.nr}`},[E]);a.useEffect(()=>{let S=!1,x=null,f=null,g=!0,T=!1;const C=async()=>{if(S||T)return;T=!0,g&&u(!0),x?.abort();const V=new AbortController;x=V;try{const _=await fetch("/api/protocol",{credentials:"include",signal:V.signal});if(!_.ok)throw new Error(`HTTP ${_.status}`);const U=await _.json();if(S||x!==V)return;const se=Array.isArray(U?.items)?U.items:[];i(se)}catch(_){if(S||_?.name==="AbortError")return;g&&i([]),console.warn("[ProtokollOverview] Aktualisierung fehlgeschlagen",_)}finally{!S&&g&&u(!1),g=!1,T=!1}},N=()=>{document.visibilityState==="visible"&&C()};return C(),f=window.setInterval(C,5e3),document.addEventListener("visibilitychange",N),()=>{S=!0,x?.abort(),f&&window.clearInterval(f),document.removeEventListener("visibilitychange",N)}},[]);const M=a.useMemo(()=>St(n),[n]),$=M.length>0,D=a.useMemo(()=>{const S=[...s].sort((f,g)=>(Number(g.nr)||0)-(Number(f.nr)||0));if(!$)return S;const x=f=>St(f).includes(M);return S.filter(f=>{const g=f?.uebermittlungsart||{},T=[].concat(g.ein?"Eingang":[]).concat(g.aus?"Ausgang":[]),C=[f?.nr,f?.zu,f?.datum,f?.zeit,f?.anvon,f?.information,f?.infoTyp,g.kanal,g.kanalNr,g.art,T.join(" / ")];if(Array.isArray(f?.massnahmen))for(const N of f.massnahmen)C.push(N?.massnahme,N?.verantwortlich);return C.some(N=>x(N))})},[s,$,M]);return e.jsx("div",{className:"p-3 md:p-4 h-full flex flex-col w-full",children:e.jsx("div",{className:"flex-1 min-h-0 overflow-auto border rounded-lg bg-white",children:c?e.jsx("div",{className:"p-4 text-gray-500",children:"Ladeâ€¦"}):e.jsxs("table",{className:"min-w-[1100px] w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0 z-10",children:e.jsxs("tr",{className:"[&>th]:px-2 [&>th]:py-2 [&>th]:text-left [&>th]:font-semibold border-b",children:[e.jsx("th",{className:"text-center whitespace-nowrap w-1",children:"âœ“"}),e.jsx("th",{className:"text-center whitespace-nowrap w-1",children:"NR."}),e.jsx("th",{className:"whitespace-nowrap w-1",children:"Druck"}),e.jsx("th",{className:"whitespace-nowrap w-1",children:"Datum"}),e.jsx("th",{className:"whitespace-nowrap w-1",children:"Zeit"}),e.jsx("th",{className:"whitespace-nowrap w-1",children:"Kanal"}),e.jsx("th",{className:"whitespace-nowrap w-1",children:"Richtung"}),e.jsx("th",{className:"whitespace-nowrap w-1",children:"An/Von"}),e.jsx("th",{children:"Information"}),e.jsx("th",{className:"whitespace-nowrap w-1",children:"Meldungstyp"})]})}),e.jsxs("tbody",{className:"[&>tr>td]:px-2 [&>tr>td]:py-2 [&>tr>td]:align-middle",children:[D.map(S=>{const x=S?.uebermittlungsart||{},f=x.kanal??x.kanalNr??x.art??"",T=[].concat(x.ein?"Eingang":[]).concat(x.aus?"Ausgang":[]).join(" / "),C=$r(S),V=(Array.isArray(S?.massnahmen)?S.massnahmen:[]).filter(ue=>`${ue?.massnahme??""} ${ue?.verantwortlich??""}`.trim().length>0),_=V.some(ue=>!ue?.done),U=S?.otherRecipientConfirmation||{},se=String(U?.byRole||"").toUpperCase();U?.confirmed;const G=Vs(S)&&!U?.confirmed,H=Us(S),J=H.token,Q=String(S?.nr??""),fe=Q&&k?k[Q]:null,le=!!v,K=le&&J&&fe!==J,L=zn(J),xe=zn(fe),O=!!L.doneSignature,q=!!xe.doneSignature,me=O&&q&&L.doneSignature===xe.doneSignature,ae=typeof H.by=="string"?H.by:null;let Se=!1;if(ae&&m.size){const ue=Wn(ae);for(const Le of ue)if(m.has(Le)){Se=!0;break}}const W=O&&(!le||!me)||K&&!Se,ie=ae&&ae.trim()?ae.trim():"Unbekannt",de=L.doneSignature&&String(L.doneSignature).trim(),pe=(de?(()=>{const ue=de.split(",").map($e=>$e.trim()).filter(Boolean);return(ue[ue.length-1]||"").replace(/\s*#\d+\s*$/,"").trim()||null})():null)||ie,oe=W?Pr(S):null,we=W?`Erstellt/geÃ¤ndert durch ${pe}`:`GeÃ¤ndert durch ${pe}`,Y=oe?`${we}
${oe}`:we,X=!!U?.confirmed,ce=[`${C}Ã— gedruckt`];if(_&&ce.push("Offene Aufgaben vorhanden"),G&&ce.push("BestÃ¤tigung ausstehend"),U?.confirmed){const ue=se||"BestÃ¤tigt";ce.push(`BestÃ¤tigt durch ${ue}`)}const R=ce.join(" â€¢ "),ee=_?"border-red-500 text-red-600":"border-emerald-500 text-emerald-600",ve=G?"text-gray-400":_?"text-red-600":"";V.length>0;const Ne=!_,Ie=!!U?.confirmed&&Ne,je=["border-b  cursor-pointer",W?"bg-yellow-50 hover:bg-yellow-100":"hover:bg-gray-50",G?"text-gray-400 [&>td]:text-gray-400":""].join(" ");return e.jsxs("tr",{className:je,onClick:()=>z(S,J),title:Y,"aria-label":Y,children:[e.jsx("td",{className:"align-middle text-center",children:Ie?e.jsx("span",{className:"inline-flex items-center justify-center text-emerald-600 text-lg font-semibold",title:"BestÃ¤tigt und alle MaÃŸnahmen erledigt",children:"âœ“"}):null}),e.jsx("td",{className:"align-middle text-center font-semibold whitespace-nowrap",children:(()=>{const ue=S.nr??"â€”",Le=S.zu!==null&&S.zu!==void 0&&String(S.zu).trim()!=="",$e=Le?String(S.zu):"",Ee=Le?`${ue}/${$e}`:`${ue}`;return X?e.jsx("span",{className:`inline-flex items-center justify-center px-3 h-8 rounded-full border-2 text-sm font-semibold ${ee}`,title:R,"aria-label":R,children:Ee}):e.jsx("span",{className:`inline-block text-sm font-semibold ${ve}`,title:R,"aria-label":R,children:Ee})})()}),e.jsx("td",{className:"font-semibold whitespace-nowrap",children:C}),e.jsx("td",{className:"whitespace-nowrap",children:S.datum}),e.jsx("td",{className:"whitespace-nowrap",children:S.zeit}),e.jsx("td",{className:"whitespace-nowrap",title:f,children:f}),e.jsx("td",{className:"whitespace-nowrap",title:T,children:T}),e.jsx("td",{className:"whitespace-nowrap",children:S.anvon}),e.jsx("td",{className:"whitespace-pre-wrap",children:Er(S.information)}),e.jsx("td",{className:"whitespace-nowrap",children:S.infoTyp||"â€”"})]},S.nr)}),!D.length&&e.jsx("tr",{children:e.jsx("td",{colSpan:10,className:"p-4 text-gray-500 italic",children:"â€” keine EintrÃ¤ge â€”"})})]})]})})})}const qn={},Fr=3e3,Dr=1e3;function jt(n,s){const i=Number(n);if(Number.isFinite(i)&&i>0){const c=Math.floor(i);return c>0?c:s}return s}const zr=jt(qn?.VITE_STATUS_POLL_INTERVAL_MS,Fr),_r=jt(qn?.VITE_ACTIVITY_POLL_INTERVAL_MS,Dr);function Br({autoEnabled:n,remaining:s,disabled:i=!1,showTimer:c=!0,showLastLoaded:u=!0,onImportInfo:b}){const[m,v]=a.useState(!1),[k,j]=a.useState(!1),[E,z]=a.useState(""),[M,$]=a.useState({remainingMin:null,idleMinutes:null,lastActivityIso:null,autoStopMin:null}),[D,S]=a.useState({lastLoadedIso:null,file:"list_filtered.json"});a.useEffect(()=>{typeof b=="function"&&b(D)},[D,b]);const[x,f]=a.useState(!1),[g,T]=a.useState(30),[C,N]=a.useState(null),[V,_]=a.useState(zr),[U,se]=a.useState(_r),re=a.useRef(!1),G=async()=>{try{const[Q,fe,le]=await Promise.all([fetch("/api/ff/status",{credentials:"include",cache:"no-store"}).then(K=>K.json()).catch(()=>({running:!1})),fetch("/api/ff/creds",{credentials:"include",cache:"no-store"}).then(K=>K.json()).catch(()=>({has:!1})),fetch("/api/import/auto-config",{credentials:"include",cache:"no-store"}).then(K=>K.json()).catch(()=>({enabled:!1,intervalSec:30}))]);v(!!Q.running),j(!!fe.has),f(!!le.enabled),T(Number(le.intervalSec||30)),_(K=>jt(le.statusPollIntervalMs,K)),se(K=>jt(le.activityPollIntervalMs,K)),re.current||(re.current=!0,fe.has||z("Keine globalen Fetcher-Zugangsdaten. Bitte als Admin unter /user-admin setzen."))}catch{}};a.useEffect(()=>{G();const Q=setInterval(()=>{G()},V);return()=>clearInterval(Q)},[V]),a.useEffect(()=>{const Q=async()=>{try{const le=await fetch("/api/activity/status",{credentials:"include",cache:"no-store"});if(le.ok){const K=await le.json(),L=Number(K.idleMinutes),xe=Number(K.autoStopMin),O=Math.max(0,Math.ceil(xe-L));$({remainingMin:O,idleMinutes:L,lastActivityIso:K.lastActivityIso,autoStopMin:xe}),v(!!K.fetcher?.running),S({lastLoadedIso:K.import?.lastLoadedIso??null,file:K.import?.file||"list_filtered.json"})}}catch{}};Q();const fe=setInterval(()=>{Q()},U);return()=>clearInterval(fe)},[U]),a.useEffect(()=>{let Q;const fe=()=>{if(!x||!D.lastLoadedIso){N(null);return}const K=new Date(D.lastLoadedIso).getTime()+g*1e3,L=Math.max(0,Math.ceil((K-Date.now())/1e3));N(L)};return fe(),Q=setInterval(fe,1e3),()=>clearInterval(Q)},[x,g,D.lastLoadedIso]);const H=typeof n=="boolean"?n:x,J=typeof s=="number"?s:C;return e.jsxs("div",{className:`flex items-center h-9 gap-2 ${i?"opacity-60 pointer-events-none":""}`,style:{alignItems:"center"},children:[c&&e.jsx("span",{className:`sync-chip ${H?"active":""}`,title:H?"Auto-Import Countdown":"Auto-Import ist deaktiviert",style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:"110px",minWidth:"110px",textAlign:"center"},children:H?`âŸ³ in ${J??"â€“"}s`:"â¸ manuell"}),E&&e.jsx("span",{style:{color:"#dc2626",fontSize:12,marginLeft:8},children:E}),m&&M.remainingMin!=null&&M.remainingMin<=15&&e.jsxs("div",{title:`Letzte AktivitÃ¤t: ${M.lastActivityIso?new Date(M.lastActivityIso).toLocaleString():"â€“"} â€¢ Inaktiv: ${M.idleMinutes?.toFixed?.(1)} min â€¢ Limit: ${M.autoStopMin} min`,className:"ml-2 inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border "+(M.remainingMin<=5?"bg-red-50 text-red-700 border-red-300":M.remainingMin<=15?"bg-amber-50 text-amber-700 border-amber-300":"bg-blue-50 text-blue-700 border-blue-300"),children:[e.jsx("span",{className:"mr-2 h-2 w-2 rounded-full bg-current",style:{animation:"pulse 1.5s ease-in-out infinite"}}),e.jsxs("span",{children:["Auto-Import stoppt in ",e.jsxs("b",{children:[M.remainingMin," min"]})]})]}),u&&e.jsx("div",{title:`Quelle: ${D.file}`,className:"ml-2 inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border bg-white text-gray-700",style:{borderColor:"#cbd5e1"},children:e.jsxs("span",{children:["Zuletzt geladen:"," ",e.jsx("b",{children:D.lastLoadedIso?new Date(D.lastLoadedIso).toLocaleTimeString("de-AT",{hour12:!1}):"â€“"})]})})]})}function Or(){const[n,s]=a.useState(.9);return a.useEffect(()=>{const i=()=>{const c=window.innerWidth,u=window.innerHeight,b=Math.min(Math.max(Math.min(c/1440,u/900),.78),.95);s(Number(b.toFixed(2)))};return i(),window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[]),n}function Vr(){try{const n=new URLSearchParams(window.location.search),s=parseFloat(n.get("font"));if(Number.isFinite(s)&&s>=.5&&s<=5)return s}catch{}try{const n=parseFloat(localStorage.getItem("ff_font_scale")||"");if(Number.isFinite(n)&&n>=.5&&n<=5)return n}catch{}return 1.2}const Zn=n=>new Intl.DateTimeFormat("de-AT",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).format(new Date(n||Date.now())),Jn=n=>Array.isArray(n?.assignedVehicles)?n.assignedVehicles.length:0,Qn=(n,s)=>(n?.assignedVehicles||[]).reduce((i,c)=>{const u=s.get(c);return i+(typeof u?.mannschaft=="number"?u.mannschaft:0)},0),Ur=()=>{if(typeof window>"u")return{id:"",label:""};try{const n=new URLSearchParams(window.location.search),s=n.get("bereichId")||n.get("abschnittId")||n.get("areaId")||"",i=n.get("bereich")||n.get("abschnitt")||n.get("area")||"";return{id:String(s||"").trim(),label:String(i||"").trim()}}catch{return{id:"",label:""}}};function Hr({c:n,vehiclesById:s,showBottomCounts:i=!0,headerRight:c,kind:u}){const b=u==="erledigt",m=b?Array.isArray(n?.everVehicles)?n.everVehicles.length:0:Jn(n),v=b?Number.isFinite(n?.everPersonnel)?n.everPersonnel:0:Qn(n,s),k=n?.isArea?"bg-slate-100 border-slate-200":"bg-white";return e.jsxs("div",{className:`border rounded-lg p-2 shadow-sm text-[0.9rem] leading-tight ${k}`,children:[e.jsxs("div",{className:"flex items-start justify-between text-[0.72rem] text-gray-600 mb-1",children:[e.jsx("span",{children:Zn(n.createdAt)}),e.jsx("span",{className:"font-semibold",children:c})]}),e.jsx("div",{className:"font-semibold",children:n.content}),(n.humanId||n.typ||n.ort||n.alerted)&&e.jsxs("div",{className:"text-[0.75rem] text-gray-600 mt-0.5 space-y-0.5",children:[(n.humanId||n.typ)&&e.jsxs("div",{className:"flex flex-wrap items-center gap-x-2 gap-y-0.5",children:[n.humanId&&e.jsx("span",{className:"font-semibold text-gray-700",children:n.humanId}),n.typ&&e.jsxs("span",{children:["ðŸ·ï¸ ",n.typ]})]}),(n.ort||n.alerted)&&e.jsxs("div",{className:"flex flex-wrap items-center gap-x-2 gap-y-0.5",children:[n.ort&&e.jsxs("span",{children:["ðŸ“ ",n.ort]}),n.alerted&&e.jsxs("span",{className:"text-gray-500",children:["ðŸ”” ",n.alerted]})]})]}),i&&e.jsxs("div",{className:"mt-1 text-[0.78rem] text-gray-700 flex items-center gap-2",children:[e.jsxs("span",{children:["ðŸš’ ",m]}),e.jsxs("span",{children:["ðŸ‘¥ ",v]})]})]})}function Kt({title:n,cards:s,vehiclesById:i,kind:c,viewportH:u}){const v=Math.max(160,u-56-40),k=Math.max(1,Math.floor(v/96)),j=k*2,E=k+1,z=Math.max(j+2,E+6);let M="grid-cols-1";s.length>=z?M="grid-cols-3":s.length>=E&&(M="grid-cols-2");const $=x=>Zn(x.statusSince),D=a.useMemo(()=>{let x=0,f=0,g=0,T=0,C=0;for(const N of s)if(x+=1,N?.isArea?f+=1:g+=1,c==="erledigt")T+=Array.isArray(N?.everVehicles)?N.everVehicles.length:0,C+=Number.isFinite(N?.everPersonnel)?N.everPersonnel:0;else{T+=Array.isArray(N?.assignedVehicles)?N.assignedVehicles.length:0;const V=Array.isArray(N?.assignedVehicles)?N.assignedVehicles:[];for(const _ of V){const U=i.get(_);typeof U?.mannschaft=="number"&&(C+=U.mannschaft)}}return{cardCount:x,areaCount:f,incidentCount:g,unitSum:T,personSum:C}},[s,c,i]),S={neu:"bg-red-100","in-bearbeitung":"bg-yellow-100",erledigt:"bg-green-100"}[c]||"bg-gray-100";return e.jsxs("section",{className:`${S} rounded-xl shadow p-3 h-full flex flex-col min-h-0`,children:[e.jsxs("h3",{className:"text-sm font-semibold mb-2",children:[n," â€” â¬› ",D.incidentCount," | ðŸ—ºï¸ ",D.areaCount," | ðŸš’ ",D.unitSum," | ðŸ‘¥ ",D.personSum]}),e.jsx("div",{className:`grid ${M} gap-2 overflow-auto pr-1 flex-1 min-h-0 place-content-start`,children:s.map(x=>e.jsx(Hr,{c:x,vehiclesById:i,headerRight:$(x),showBottomCounts:!0,kind:c},x.id))}),s.length===0&&e.jsx("div",{className:"text-[0.8rem] text-gray-500 italic text-center py-4",children:"â€” keine EintrÃ¤ge â€”"})]})}function Kr(){Or();const[n,s]=a.useState(Vr());a.useEffect(()=>{const f=document.documentElement.style.fontSize||"",g=Math.max(50,Math.min(500,Math.round(n*100)));return document.documentElement.style.fontSize=g+"%",()=>{document.documentElement.style.fontSize=f}},[n]),a.useEffect(()=>{const f=g=>{if(g.key==="ff_font_scale"){const T=parseFloat(g.newValue||"");Number.isFinite(T)&&T>=.5&&T<=5&&s(T)}};return window.addEventListener("storage",f),()=>window.removeEventListener("storage",f)},[]);const[i,c]=a.useState(null),[u,b]=a.useState([]),[m,v]=a.useState(window.innerHeight);a.useEffect(()=>{let f=!0;const g=async()=>{const[N,V]=await Promise.all([Me(),Ke()]);f&&(c(N),b(V))};g();const T=setInterval(g,7e3),C=()=>v(window.innerHeight);return window.addEventListener("resize",C),()=>{f=!1,clearInterval(T),window.removeEventListener("resize",C)}},[]),a.useEffect(()=>{try{const f=new URLSearchParams(window.location.search);if(f.get("print")==="1"||f.get("pdf")==="1"){const g=setTimeout(()=>{window.print()},600);return()=>clearTimeout(g)}}catch{}},[]),a.useEffect(()=>{const f=()=>{try{window.close()}catch{}};return window.addEventListener("afterprint",f),()=>window.removeEventListener("afterprint",f)},[]);const k=a.useMemo(()=>Ur(),[]),j=a.useMemo(()=>new Map(u.map(f=>[f.id,f])),[u]),{columns:E,areaLabel:z}=a.useMemo(()=>{const f={neu:{name:"Neu",items:[]},"in-bearbeitung":{name:"In Bearbeitung",items:[]},erledigt:{name:"Erledigt",items:[]}},g=i?.columns||f,T=J=>{const Q=g[J]||f[J];return{name:Q?.name||f[J].name,items:Array.isArray(Q?.items)?[...Q.items]:[]}},C={neu:T("neu"),"in-bearbeitung":T("in-bearbeitung"),erledigt:T("erledigt")},N=[];for(const J of["neu","in-bearbeitung","erledigt"])for(const Q of g[J]?.items||[])Q?.isArea&&N.push(Q);const V=k.id,_=k.label,U=!!(V||_),se=String(V||"").toLowerCase(),re=String(_||"").toLowerCase();let G=null;if(N.length&&U&&(V&&(G=N.find(J=>String(J?.id)===V)||N.find(J=>String(J?.id||"").toLowerCase()===se)||N.find(J=>String(J?.humanId||"").toLowerCase()===se)),!G&&_&&(G=N.find(J=>String(J?.content||"").toLowerCase()===re)),!G&&_&&(G=N.find(J=>String(J?.content||"").toLowerCase().includes(re)))),G){const J=String(G.id);for(const Q of["neu","in-bearbeitung","erledigt"]){const fe=C[Q]?.items||[];C[Q]={...C[Q],items:fe.filter(le=>le?.isArea?String(le.id)===J:(le?.areaCardId!=null?String(le.areaCardId):"")===J)}}}else if(U)for(const J of["neu","in-bearbeitung","erledigt"])C[J]={...C[J],items:[]};const H=(G?.content||"").trim()||(G?.humanId||"").trim()||U&&(k.label||k.id)||"";return{columns:C,areaLabel:H}},[i,k.id,k.label]),M=a.useMemo(()=>{const f="Einsatzstellen-Ãœbersicht-Feuerwehr";return z?`${f} - ${z}`:f},[z]);a.useEffect(()=>{if(typeof document>"u")return;const f=document.title;return document.title=M,()=>{document.title=f}},[M]);const $=a.useMemo(()=>{let f=0;for(const g of["neu","in-bearbeitung"])for(const T of E[g].items||[])f+=Jn(T);return f},[E]),D=a.useMemo(()=>{let f=0;for(const g of["neu","in-bearbeitung"])for(const T of E[g].items||[])f+=Qn(T,j);return f},[E,j]),S=a.useMemo(()=>{let f=0;for(const g of E.neu.items||[])g?.isArea||(f+=1);for(const g of E["in-bearbeitung"].items||[])g?.isArea||(f+=1);return f},[E]),x=a.useMemo(()=>{let f=S;for(const g of E.erledigt.items||[])g?.isArea||(f+=1);return f},[S,E]);return i?e.jsx("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden",children:e.jsxs("div",{className:"h-full w-full flex flex-col gap-2",children:[e.jsxs("header",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:M}),e.jsxs("div",{className:"text-base md:text-lg font-bold flex flex-wrap gap-4",children:[e.jsxs("span",{children:["ðŸš’ ",$]}),e.jsxs("span",{children:["ðŸ‘¥ ",D]}),e.jsxs("span",{children:["ðŸŸ¡ Aktiv: ",S]}),e.jsxs("span",{children:["ðŸ“¦ Gesamt: ",x]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2 min-h-0 flex-1",children:[e.jsx(Kt,{title:"Neu",cards:E.neu.items,vehiclesById:j,kind:"neu",viewportH:m}),e.jsx(Kt,{title:"In Bearbeitung",cards:E["in-bearbeitung"].items,vehiclesById:j,kind:"in-bearbeitung",viewportH:m}),e.jsx(Kt,{title:"Erledigt",cards:E.erledigt.items,vehiclesById:j,kind:"erledigt",viewportH:m})]})]})}):e.jsx("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden",children:e.jsx("div",{className:"h-full w-full flex items-center justify-center",children:"Ladeâ€¦"})})}const Gr="S2",Wr=3e4,qr=" - *** - NEUE LAGEMELDUNG: ",Zr=" - *** -",_n="Â ".repeat(30);function Jr(){const[n]=a.useState(.9);return n}const Qr=n=>`card:${n}`,He=!0,Yr="#2563eb",Xr=2e4,ea={einsatz:{key:"einsatz",label:"E",title:"Zur EinsatzÃ¼bersicht",onClick:()=>{window.location.href="/"}},aufgaben:{key:"aufgaben",label:"A",title:"Zum Aufgaben-Board",onClick:()=>{window.location.href="/aufgaben"}},meldestelle:{key:"meldestelle",label:"M",title:"Zur Meldestelle",onClick:()=>{window.location.href="/#/protokoll"}}};function vt(n){return Object.values(ea).filter(s=>s.key!==n)}function ta(n){if(typeof n!="string")return null;const s=n.trim();if(!s)return null;const i=s.match(/^(\d+):(\d{1,2})$/);if(i){const v=Number(i[1]),k=Number(i[2]);if(Number.isFinite(v)&&Number.isFinite(k))return(v*60+k)*6e4}const u=s.replace(",",".").toLowerCase().match(/^([0-9]+(?:\.[0-9]+)?)([a-zÃ¤Ã¶Ã¼]*)$/);if(!u)return null;const b=Number(u[1]);if(!Number.isFinite(b)||b<=0)return null;const m=u[2];return!m||m==="m"||m==="min"||m==="mins"||m==="minute"||m==="minuten"?b*6e4:m==="h"||m==="st"||m==="std"||m==="stunde"||m==="stunden"?b*36e5:m==="s"||m==="sek"||m==="sekunde"||m==="sekunden"?b*1e3:m==="d"||m==="tag"||m==="tage"||m==="day"||m==="days"?b*864e5:null}function na({available:n,alerted:s,assigned:i}){return n?i?{container:"border-red-400 bg-white",label:"text-gray-700"}:s?{container:"border-blue-500 bg-blue-50",label:"text-blue-900"}:{container:"border-green-400 bg-white",label:"text-gray-700"}:{container:"border-gray-300 bg-gray-50",label:"text-gray-400"}}function ia(){if(Jr(),typeof window<"u"&&window.location.pathname==="/status")return e.jsx(Kr,{});const n=Hs(),s=n.running||n.paused,[i,c]=a.useState(!1);a.useEffect(()=>{xn().then(()=>c(!0))},[]);const u=i&&yn("einsatzboard"),b=u||i&&Ot("S1"),m=!u,[v,k]=a.useState(null),[j,E]=a.useState([]),[z,M]=a.useState([]),[$,D]=a.useState(new Map),[S,x]=a.useState(new Map),f=a.useRef(new Map),g=a.useRef(new Map),T=a.useRef(new Map),C=a.useRef(new Map),N=a.useCallback(t=>{if(typeof window>"u")return{cancelled:!0};const o=`Bitte Dauer der Nicht-VerfÃ¼gbarkeit fÃ¼r ${t} angeben (z.â€¯B. 30, 2h oder 1:30). Leer lassen fÃ¼r unbegrenzt.`,r=window.prompt(o,"");if(r===null)return{cancelled:!0};const l=r.trim();if(!l)return{cancelled:!1,untilMs:null,untilIso:null};const d=ta(l);if(!Number.isFinite(d)||d<=0)return window.alert("UngÃ¼ltige Dauer. Bitte z.â€¯B. 30, 2h oder 1:30 eingeben."),{cancelled:!0};const h=Date.now()+d;return{cancelled:!1,untilMs:h,untilIso:new Date(h).toISOString()}},[]),V=a.useCallback(async()=>{try{const t=await Ke();E(t)}catch(t){console.error(t)}},[E]),_=a.useCallback((t,o)=>{if(!t||!o)return;const r=Date.parse(o);if(!Number.isFinite(r))return;const l=f.current,d=l.get(t);if(d&&d.untilIso===o)return;d&&(clearTimeout(d.timeout),l.delete(t));const h=r-Date.now(),w=async()=>{f.current.delete(t),g.current.delete(t);try{await kn(t,!0)}catch(I){console.error(I)}await V()};if(h<=0){w();return}const y=setTimeout(w,h);l.set(t,{timeout:y,untilIso:o})},[V]),U=a.useCallback((t,o)=>{if(!t||!o)return;const r=Date.parse(o);if(!Number.isFinite(r))return;const l=T.current,d=l.get(t);if(d&&d.untilIso===o)return;d&&(clearTimeout(d.timeout),l.delete(t));const h=r-Date.now(),w=async()=>{T.current.delete(t),C.current.delete(t);try{await Cn(t,!0)}catch(I){console.error(I)}await V(),D(I=>{const P=new Map(I);return P.set(t,!0),P})};if(h<=0){w();return}const y=setTimeout(w,h);l.set(t,{timeout:y,untilIso:o})},[V,D]);a.useEffect(()=>{const t=f.current,o=new Set;for(const r of j){if(!r)continue;const l=String(r.id??"").trim();if(!l)continue;o.add(l);const d=r.available!==!1&&r.groupAvailable!==!1,h=r.unavailableUntil||g.current.get(l)||null,w=h?Date.parse(h):NaN,y=Number.isFinite(w)?new Date(w).toISOString():null,I=String(r.ort??"").trim();if(($.has(I)?$.get(I):!0)===!1){y?g.current.set(l,y):g.current.delete(l);const F=t.get(l);F&&(clearTimeout(F.timeout),t.delete(l));continue}if(d||!y){const F=t.get(l);F&&(clearTimeout(F.timeout),t.delete(l)),g.current.delete(l);continue}g.current.set(l,y),_(l,y)}for(const[r,l]of Array.from(t.entries()))o.has(r)||(clearTimeout(l.timeout),t.delete(r),g.current.delete(r))},[j,$,_]),a.useEffect(()=>{const t=T.current,o=new Set;for(const[r,l]of $.entries()){const d=String(r||"").trim();if(!d)continue;if(o.add(d),l!==!1){const I=t.get(d);I&&(clearTimeout(I.timeout),t.delete(d)),C.current.delete(d);continue}const h=C.current.get(d)||null,w=h?Date.parse(h):NaN;if(!Number.isFinite(w)){const I=t.get(d);I&&(clearTimeout(I.timeout),t.delete(d)),C.current.delete(d);continue}const y=new Date(w).toISOString();C.current.set(d,y),U(d,y)}for(const[r,l]of Array.from(t.entries()))o.has(r)||(clearTimeout(l.timeout),t.delete(r),C.current.delete(r))},[$,U]),a.useEffect(()=>()=>{for(const{timeout:t}of f.current.values())clearTimeout(t);f.current.clear(),g.current.clear();for(const{timeout:t}of T.current.values())clearTimeout(t);T.current.clear(),C.current.clear()},[]);const se=a.useCallback(t=>{Array.isArray(t)&&D(o=>{let r=!1;const l=new Map(o);for(const d of t){if(!d||!d.ort)continue;const h=String(d.ort),w=d.groupAvailable!==!1;(!l.has(h)||l.get(h)!==w)&&(l.set(h,w),r=!0)}return r?l:o})},[]);a.useEffect(()=>{se(j)},[j,se]);const re=a.useCallback(t=>{const o=Object.entries(t?.availability||{}),r=[],l=new Map;for(const[d,h]of o){const y=!(h===!1||h&&typeof h=="object"&&h.available===!1);let I=null;if(!y){const P=h&&typeof h=="object"?h.until:null;if(typeof P=="string"&&P.trim()){const F=Date.parse(P);!Number.isNaN(F)&&F>Date.now()&&(I=new Date(F).toISOString())}}r.push([d,y]),!y&&I&&l.set(d,I)}C.current=l,D(new Map(r))},[]),G=a.useCallback(t=>{const o=Object.entries(t?.alerted||{});x(new Map(o.map(([r,l])=>[r,l===!0])))},[]),[H,J]=a.useState(""),[Q,fe]=a.useState(""),[le,K]=a.useState(""),{user:L}=On()||{},{roles:xe}=Ks(),O=a.useMemo(()=>xe.some(t=>t==="LTSTB"||t==="LTSTBSTV"),[xe]),[q,me]=a.useState(!1),[ae,Se]=a.useState(!1),[he,A]=a.useState(!1),[W,ie]=a.useState(null),[de,ye]=a.useState(null),[pe,oe]=a.useState(""),[we,Y]=a.useState(!1),[X,ce]=a.useState(!1),[R,ee]=a.useState(30),[ve,Ne]=a.useState(!1),[Te,Ie]=a.useState({lastLoadedIso:null,file:"list_filtered.json"}),[je,ue]=a.useState(!1),[Le,$e]=a.useState(!1),[Ee,Ge]=a.useState(!1),[p,te]=a.useState(null),[ke,ge]=a.useState(!1),We=t=>{te(t),ge(!1),Ge(!0)},Be=a.useRef(null),[nt,qe]=a.useState([]);a.useEffect(()=>{let t=!1;return(async()=>{try{if(await xn(),t)return;const o=yn("protokoll",L),r=!O&&Ot("S3",L);me(o||r),Se(Ot("S3",L)&&O)}catch{if(t)return;me(!1),Se(!1)}})(),()=>{t=!0}},[O,L]);const[At,Yn]=a.useState(window.location.hash);a.useEffect(()=>{const t=()=>Yn(window.location.hash);return window.addEventListener("hashchange",t),()=>window.removeEventListener("hashchange",t)},[]);const ct=At.replace(/^#/,""),[qt,Zt]=a.useState(()=>new Set),[kt,Ct]=a.useState(0),st=a.useRef(null),ze=a.useRef(null),Jt=a.useRef(0),Qt=a.useRef(new Set),Yt=a.useRef(0),Xt=a.useRef(0),dt=a.useRef(null),[Xn,ut]=a.useState(0);a.useEffect(()=>{document.title="Einsatzstellen-Ãœbersicht-Feuerwehr",Gs()},[]),a.useEffect(()=>()=>{ze.current&&(clearTimeout(ze.current),ze.current=null),st.current&&(clearTimeout(st.current),st.current=null)},[]),a.useEffect(()=>{(async()=>{try{await Vn(Wt())}catch{}})()},[]),a.useEffect(()=>{H||(ze.current&&(clearTimeout(ze.current),ze.current=null),he&&A(!1))},[H,he]),a.useEffect(()=>{if(!u)return;if(!X){ut(0);return}const t=setInterval(()=>ut(o=>o+1),1e3);return()=>clearInterval(t)},[He,X]);const es=X?Math.max(0,R-Xn%Math.max(1,R)):0;a.useEffect(()=>{document.title="Einsatzstellen-Ãœbersicht-Feuerwehr"},[]),a.useEffect(()=>{(async()=>{const[t,o,r,l,d]=await Promise.all([Me(),Ke(),Ws(),qs().catch(()=>({availability:{}})),wn().catch(()=>({alerted:{}}))]);k(t),E(o),M(Array.isArray(r)?r:[]),re(l),G(d),Ce(t),Yt.current=Date.now()+Xr;try{const h=await Zs();ce(!!h.enabled),ee(Number(h.intervalSec)||30),Ne(!!h.demoMode)}catch{}ut(0)})()},[He]),a.useEffect(()=>{X&&(async()=>{try{(await fetch("/api/ff/status",{credentials:"include",cache:"no-store"}).then(o=>o.json()).catch(()=>({running:!1}))).running||await fetch("/api/ff/start",{method:"POST",credentials:"include"})}catch{}})()},[He,X,R]),a.useEffect(()=>{let t=!1,o=null,r=0;const l=Math.max(5,Math.min(60,X?8:15)),d=async()=>{const h=++r;try{const w=new Set(Mt.current),y=dt.current,I=await Me();!t&&h===r&&(k(I),ln({oldIds:w,oldBoard:y,newBoard:I,pulseMs:8e3}))}catch{}t||(o=setTimeout(d,l*1e3))};return o=setTimeout(d,l*1e3),()=>{t=!0,o&&clearTimeout(o)}},[He,X]),a.useEffect(()=>{let t=!1,o=null,r=0;const l=Math.max(5,Math.min(60,X?8:15)),d=async()=>{const h=++r;try{const w=await wn();!t&&h===r&&G(w)}catch{}t||(o=setTimeout(d,l*1e3))};return d(),()=>{t=!0,o&&clearTimeout(o)}},[He,X,G]),a.useEffect(()=>{const t=o=>{o.altKey&&(o.key==="e"||o.key==="E")&&(o.preventDefault(),$e(!0))};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[He]);const rt=a.useMemo(()=>Q.trim().toLowerCase(),[Q]),Ze=rt.length>0,Pe=v??{columns:{neu:{items:[]},"in-bearbeitung":{items:[]},erledigt:{items:[]}}},It=a.useMemo(()=>nt.length?`${nt.map(o=>`${qr}${o}${Zr}`).join(_n)}${_n}`:"",[nt]),en=a.useCallback(async()=>{Be.current&&Be.current.abort();const t=new AbortController;Be.current=t;try{const o=await Js(Gr,{signal:t.signal}),l=(Array.isArray(o?.items)?o.items:[]).filter(d=>String(d?.status??"").trim().toLowerCase()==="neu").filter(d=>String(d?.type??"").trim().toLowerCase()==="lagemeldung").map(d=>typeof d?.desc=="string"?d.desc:"").map(d=>d.replace(/\s+/g," ").trim()).filter(Boolean);t.signal.aborted||qe(l)}catch{t.signal.aborted||qe([])}finally{Be.current===t&&(Be.current=null)}},[qe]);a.useEffect(()=>{if(!i)return;const t=()=>{en().catch(()=>{})};t();const o=setInterval(t,Wr);return()=>{clearInterval(o),Be.current&&Be.current.abort()}},[en,i]);const at=a.useMemo(()=>{const t=!!H;if(!t&&!Ze)return Pe;const o=String(H),r={};for(const[l,d]of Object.entries(Pe?.columns||{})){let h=d?.items||[];t&&(h=h.filter(w=>on(w,o))),Ze&&(h=h.filter(w=>rs(w,rt))),r[l]={...d,items:h}}return{...Pe,columns:r}},[Pe,H,Ze,rt]),ts=(t,o=!1)=>{const r=String(t||"");return!o||!r?r:/^B/i.test(r)?`B${r.slice(1)}`:/^[A-Za-z]/.test(r)?`B${r.slice(1)}`:`B${r}`},tn=t=>{if(!t)return"";const o=t.humanId?String(t.humanId):"",r=ts(o,!!t.isArea),l=t.content?String(t.content):"";return[r,l].filter(Boolean).join(" â€“ ")||r||l||""},Je=a.useMemo(()=>{const t=Pe?.columns||{},o=[];for(const r of Object.keys(t))for(const l of t[r]?.items||[])l?.isArea&&o.push(l);return o},[Pe]),Qe=a.useMemo(()=>{const t=new Map;return Je.forEach(o=>{if(!o?.id)return;const r=String(o.id);t.set(r,tn(o))}),t},[Je]),Et=a.useMemo(()=>{const t=new Map;return Je.forEach(o=>{o?.id&&t.set(String(o.id),o.areaColor||null)}),t},[Je]),Ue=a.useMemo(()=>Je.map(t=>({id:String(t.id),label:Qe.get(String(t.id))||tn(t),color:Et.get(String(t.id))||null})),[Je,Qe,Et]);a.useEffect(()=>{if(!H)return;Ue.some(o=>String(o.id)===H)||J("")},[H,Ue]);const nn=a.useMemo(()=>{if(!H)return"";const t=String(H);return Qe.get(t)||Ue.find(o=>String(o.id)===t)?.label||""},[H,Qe,Ue]),sn=(t,o)=>{if(t?.id&&Re(t.id),o){if(k(o),Ce(o),t?.id&&p?.id===t.id){const r=ht(o,t.id);te(r||t)}return}t&&(k(r=>{if(!r)return r;const l=structuredClone(r);for(const d of Object.keys(l.columns||{})){const h=l.columns[d]?.items||[],w=h.findIndex(y=>y?.id===t.id);if(w>=0){h[w]={...h[w],...t};break}}return Ce(l),l}),p?.id===t.id&&te(r=>r?{...r,...t}:t))},ns=10;function ss(t){try{const o=t?.columns||{};return[(o.neu?.items||[]).length,(o["in-bearbeitung"]?.items||[]).length,(o.erledigt?.items||[]).length].some(l=>l>=ns)}catch{return!1}}a.useEffect(()=>{const t=ss(Pe);document.documentElement.classList.toggle("ui-dense",t)},[Pe]);const[it,rn]=a.useState(new Set),Mt=a.useRef(new Set),Ce=t=>{dt.current=t,Mt.current=Pt(t)},Re=(...t)=>{t.map(o=>String(o??"").trim()).filter(Boolean).forEach(o=>Qt.current.add(o))};a.useEffect(()=>{if(!it.size)return;const t=setTimeout(()=>rn(new Set),9e3);return()=>clearTimeout(t)},[it]);function Pt(t){const o=new Set;if(!t?.columns)return o;for(const r of Object.keys(t.columns))for(const l of t.columns[r].items||[])o.add(String(l.id));return o}function Tt(t){return Array.isArray(t)?t.map(Tt):t&&typeof t=="object"?Object.fromEntries(Object.keys(t).sort().map(o=>[o,Tt(t[o])])):t}function ft(t,{ignoreUpdatedAt:o=!1}={}){if(!t||typeof t!="object")return t;const{columnId:r,status:l,updatedAt:d,column:h,...w}=t,y={...w};return!o&&typeof d<"u"&&(y.updatedAt=d),Tt(y)}function an(t){const o=new Map;if(!t?.columns)return o;for(const[r,l]of Object.entries(t.columns))for(const d of l?.items||[])!d||typeof d.id>"u"||d.id===null||o.set(String(d.id),{card:d,columnId:r});return o}function on(t,o){return t?o?t.isArea?String(t.id)===o:t.areaCardId?String(t.areaCardId)===o:!1:!0:!1}function rs(t,o){if(!o)return!0;if(!t)return!1;try{return JSON.stringify(t).toLowerCase().includes(o)}catch{return!1}}function as(t,o){if(!o)return!0;if(!t)return!1;try{return JSON.stringify(t).toLowerCase().includes(o)}catch{return!1}}const is=(t=8e3)=>{A(!0),ze.current&&clearTimeout(ze.current),ze.current=setTimeout(()=>{A(!1),ze.current=null},t)};function ln({oldIds:t,oldBoard:o,newBoard:r,pulseMs:l=8e3}){const d=Date.now(),h=o??dt.current,w=t??Pt(h),y=Pt(r),I=new Set;for(const ne of y)w.has(ne)||I.add(ne);const P=Qt.current,F=new Set([...I].filter(ne=>!P.has(String(ne)))),B=new Set;if(h&&r){const ne=an(h),be=an(r);for(const[Ae,et]of be.entries()){if(!ne.has(Ae)||P.has(String(Ae)))continue;const Bt=ne.get(Ae),Ls=ft(Bt.card),$s=ft(et.card);if(JSON.stringify(Ls)!==JSON.stringify($s)){if(Bt.columnId!==et.columnId){const Rs=ft(Bt.card,{ignoreUpdatedAt:!0}),Fs=ft(et.card,{ignoreUpdatedAt:!0});if(JSON.stringify(Rs)===JSON.stringify(Fs))continue}B.add(Ae)}}}const Z=new Set([...F,...B]);if(Z.size>0){if(d<Yt.current){Ce(r),P.clear();return}if(rn(Z),Xt.current=d,Ct(d+l),H){const ne=String(H);[...Z].some(Ae=>{const et=ht(r,Ae);return et?!on(et,ne):!1})&&is(l)}}Ce(r),P.clear()}a.useEffect(()=>{if(!it.size||!Xt.current||Date.now()<Jt.current)return;let o=requestAnimationFrame(()=>{try{Qs()}catch{}});return()=>cancelAnimationFrame(o)},[it]);const[Lt,cn]=a.useState(!1),os=async()=>{if(!Lt){cn(!0);try{const t=new Set(Mt.current),o=dt.current,r=await fetch("/api/import/trigger",{method:"POST",credentials:"include"});if(!r.ok){const d=await r.text().catch(()=>"");throw new Error(`Import fehlgeschlagen (HTTP ${r.status}) ${d}`)}const l=await Me();k(l),ln({oldIds:t,oldBoard:o,newBoard:l,pulseMs:8e3}),ut(0)}catch(t){alert(t.message||"Import fehlgeschlagen.")}finally{cn(!1)}}},[ls,dn]=a.useState(!1);async function cs(t,o){if(ls)return;const r=Oe.get(t);if(!r)return;const l=String(r.id||""),d=new Set(j.filter(h=>String(h?.cloneOf||"").trim()===l).map(h=>String(h?.id)));dn(!0);try{const h=r.label||r.id,w=await fetch("/api/vehicles",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({ort:r.ort||"",label:h,mannschaft:0,cloneOf:r.id})}),y=await w.json().catch(()=>({}));if(!w.ok||y?.error)throw new Error(y?.error||"Clone fehlgeschlagen");const P=await(await fetch("/api/vehicles",{credentials:"include"})).json();E(P);let F=y?.vehicle?.id;F||(F=P.find(ne=>{if(!ne)return!1;const be=String(ne.id||"");return!be||d.has(be)||String(ne.ort||"")!==String(r.ort||"")?!1:String(ne.cloneOf||"").trim()===l})?.id),o&&F&&(await Vt(o,F),Re(o));const B=await Me();k(B),Ce(B)}catch(h){alert(h.message||"Clone fehlgeschlagen")}finally{dn(!1)}}const Oe=a.useMemo(()=>new Map(j.map(t=>[t.id,t])),[j]);async function ds(t,o){if(!b||!t)return;const r=String(t.id??"").trim();if(!r)return;const l=o===!0,d=t.available!==!1;if(d===l)return;let h=null;if(!l){const I=typeof t.label=="string"&&t.label.trim()?`Einheit ${t.label.trim()}`:"die Einheit",P=N(I);if(P.cancelled)return;h=P.untilIso}const w=g.current.get(r)||null,y=f.current.get(r);y&&(clearTimeout(y.timeout),f.current.delete(r)),l?g.current.delete(r):h?g.current.set(r,h):g.current.delete(r),E(I=>I.map(P=>String(P?.id??"")===r?{...P,available:l,unavailableUntil:h||null}:P));try{const I=await kn(r,l,h);if(l){g.current.delete(r),E(B=>B.map(Z=>String(Z?.id??"")===r?{...Z,unavailableUntil:null}:Z));return}const P=I&&typeof I.until=="string"?I.until:null,F=P?Date.parse(P):NaN;if(Number.isFinite(F)&&F>Date.now()){const B=new Date(F).toISOString();g.current.set(r,B),E(Z=>Z.map(ne=>String(ne?.id??"")===r?{...ne,unavailableUntil:B}:ne)),_(r,B)}else g.current.delete(r),E(B=>B.map(Z=>String(Z?.id??"")===r?{...Z,unavailableUntil:null}:Z))}catch(I){console.error(I),w?(g.current.set(r,w),_(r,w)):g.current.delete(r),E(P=>P.map(F=>String(F?.id??"")===r?{...F,available:d,unavailableUntil:w||null}:F)),alert(I?.message||"VerfÃ¼gbarkeit der Einheit konnte nicht gespeichert werden.")}}async function us(t,o){if(!b)return;const r=String(t??"").trim();if(!r)return;const l=o===!0,d=$.get(r)??!0,h=new Map;for(const P of j)if(String(P?.ort??"")===r){const F=String(P?.id??"");F&&h.set(F,{available:P?.available!==!1,unavailableUntil:typeof P?.unavailableUntil=="string"&&P.unavailableUntil.trim()?P.unavailableUntil:null})}if(d===l)return;let w=null;if(!l){const P=N(`Gruppe ${r}`);if(P.cancelled)return;w=P.untilIso}const y=C.current.get(r)||null,I=T.current.get(r);if(I&&(clearTimeout(I.timeout),T.current.delete(r)),l){C.current.delete(r);for(const[P,F]of h.entries()){const B=F?.unavailableUntil||null;B?g.current.set(P,B):g.current.delete(P)}}else{w?C.current.set(r,w):C.current.delete(r);for(const P of h.keys())w?g.current.set(P,w):g.current.delete(P)}D(P=>{const F=new Map(P);return F.set(r,l),F}),E(P=>P.map(F=>{if(String(F?.ort??"")!==r)return F;const B=String(F?.id??"");if(!B)return F;if(l){const Z=h.get(B),ne=Z?.available??!0,be=Z?.unavailableUntil||null;return{...F,groupAvailable:!0,available:ne,unavailableUntil:be}}return{...F,groupAvailable:!1,available:!1,unavailableUntil:w||null}}));try{const P=await Cn(r,l,w);if(l){C.current.delete(r);return}const F=P&&typeof P.until=="string"?P.until:null,B=F?Date.parse(F):NaN;if(Number.isFinite(B)&&B>Date.now()){const Z=new Date(B).toISOString();C.current.set(r,Z);for(const ne of h.keys())g.current.set(ne,Z);E(ne=>ne.map(be=>String(be?.ort??"")===r?{...be,unavailableUntil:Z,groupAvailable:!1,available:!1}:be)),U(r,Z)}else C.current.delete(r),E(Z=>Z.map(ne=>String(ne?.ort??"")===r?{...ne,unavailableUntil:null,groupAvailable:!1,available:!1}:ne))}catch(P){console.error(P),y?(C.current.set(r,y),U(r,y)):C.current.delete(r),D(F=>{const B=new Map(F);return B.set(r,d),B}),E(F=>F.map(B=>{if(String(B?.ort??"")!==r)return B;const Z=String(B?.id??"");if(!Z)return B;const ne=h.get(Z),be=ne?.available??!0,Ae=ne?.unavailableUntil||null;return Ae?g.current.set(Z,Ae):g.current.delete(Z),{...B,groupAvailable:d,available:d?be:!1,unavailableUntil:d?Ae:null}})),alert(P?.message||"VerfÃ¼gbarkeit der Gruppe konnte nicht gespeichert werden.")}}const $t=a.useMemo(()=>{const t=new Set,o=r=>r===!0||typeof r=="string"&&r.trim().toLowerCase()==="clone";for(const r of j){if(!r||typeof r.id>"u")continue;const l=String(r.id);if(!l)continue;if(typeof r.cloneOf=="string"?r.cloneOf.trim():""){t.add(l);continue}(r.isClone===!0||o(r.clone))&&t.add(l)}return t},[j]),un=t=>$t.has(String(t)),[fn,mn]=a.useState(new Map),fs=a.useMemo(()=>{const t={};for(const[o,r]of Oe.entries())t[o]=r;return t},[Oe]),mt=a.useMemo(()=>{const t=new Set,o=Pe?.columns||{};for(const r of Object.keys(o))for(const l of o[r].items||[])for(const d of l.assignedVehicles||[])t.add(d);return t},[Pe]),ms=a.useMemo(()=>{const t=new Set;for(const o of mt){const r=Oe.get(o),l=typeof r?.ort=="string"?r.ort:"";l&&t.add(l)}return t},[mt,Oe]),Ye=a.useMemo(()=>j.filter(t=>t&&typeof t.id<"u"&&!mt.has(t.id)&&!$t.has(String(t.id))),[j,mt,$t]),Fe=a.useMemo(()=>{const t={};for(const o of Ye){const r=o.ort||"Unbekannt";(t[r]??=[]).push(o)}for(const o of Object.keys(t))t[o].sort((r,l)=>(r.label||r.id).localeCompare(l.label||l.id));return Object.entries(t).sort((o,r)=>o[0].localeCompare(r[0]))},[Ye]),hn=a.useMemo(()=>{if(!Ze)return Fe;const t=[];for(const[o,r]of Fe){const l=r.filter(d=>as(d,rt));l.length>0&&t.push([o,l])}return t},[Fe,Ze,rt]);a.useEffect(()=>{if(localStorage.getItem("ff_collapsed_groups")||!Fe.length)return;const o=Fe.map(([r])=>r);gt(new Set(o)),localStorage.setItem("ff_collapsed_groups",JSON.stringify(o))},[He,Fe]),a.useEffect(()=>{let t=setInterval(async()=>{try{const o=await fetch("/api/activity/status",{cache:"no-store",credentials:"include"}).then(r=>r.json());typeof o?.auto?.enabled=="boolean"&&o.auto.enabled!==X&&ce(!!o.auto.enabled),typeof o?.auto?.demoMode=="boolean"&&o.auto.demoMode!==ve&&Ne(!!o.auto.demoMode)}catch{}},3e3);return()=>clearInterval(t)},[He,X,ve]);function Rt(t,o){for(const r of["neu","in-bearbeitung","erledigt"])if((t.columns[r].items||[]).some(l=>l?.id===o))return r;return null}function ht(t,o){for(const r of["neu","in-bearbeitung","erledigt"]){const l=(t.columns[r].items||[]).find(d=>d?.id===o);if(l)return l}return null}function Ft(t,o){const r=t?.columns?.[o]?.items||[];let l=0,d=0,h=0,w=0;for(const y of r)if(y?.isArea?l+=1:d+=1,o==="erledigt"){const I=Array.isArray(y?.everVehicles)?y.everVehicles:[];h+=I.filter(P=>!un(P)).length,w+=Number.isFinite(y?.everPersonnel)?y.everPersonnel:0}else{const I=Array.isArray(y?.assignedVehicles)?y.assignedVehicles:[];if(h+=I.filter(P=>!un(P)).length,Number.isFinite(y?.manualPersonnel))w+=y.manualPersonnel;else for(const P of I){const F=Oe.get(P);typeof F?.mannschaft=="number"&&(w+=F.mannschaft)}}return{cards:r.length,areas:l,incidents:d,units:h,persons:w}}const hs=Ft(at,"neu"),gs=Ft(at,"in-bearbeitung"),ps=Ft(at,"erledigt"),Dt=t=>String(t||"").split(/[;,\n]/).map(o=>o.trim()).filter(Boolean),De=t=>String(t||"").normalize?.("NFD").replace?.(new RegExp("\\p{Diacritic}","gu"),"").replace(/^\s*FF\s+/i,"").replace(/[._\-\/]+/g," ").replace(/\s+/g," ").toLowerCase().trim();function bs(t,o,r,l){const d=Dt(t?.alerted).map(De);if(d.length)for(const h of o){const w=d.some(I=>De(h?.ort)===I),y=d.some(I=>De(h?.label)===I);if(w||y){const I=String(h.id);r.add(I),l.has(I)||l.set(I,null)}}}async function xs(t,o){if(!(o!=="neu"||!t?.id))try{const r=await ir(t.id);r?.ok||alert(r?.error||"FÃ¼r diesen Einsatz sind keine Koordinaten hinterlegt.");const l=new Set((r?.units||[]).map(B=>String(B.unitId)));if(t?.alerted){const B=Dt(t.alerted).map(De);for(const Z of Ye){const ne=B.some(Ae=>De(Z.ort)===De(Ae)),be=B.some(Ae=>De(Z.label)===De(Ae));(ne||be)&&l.add(String(Z.id))}}Zt(l),Ct(Date.now()+3e3);const d=new Map;for(const B of r?.units||[]){const Z=Number(B?.distanceKm);d.set(String(B.unitId),Number.isFinite(Z)?Z:null)}l.size===0&&t?.alerted&&bs(t,Ye,l,d),mn(d);const h=new Set((r?.units||[]).filter(B=>!B.assigned).map(B=>String(B.unitId))),w=new Set(Ye.map(B=>String(B.id))),y=new Set([...h,...[...l].filter(B=>w.has(B))]),I=Dt(t?.alerted).map(De),P=new Set;if(I.length&&Ye.length>0)for(const[B,Z]of Fe){if(Z.length===0)continue;I.some(be=>De(B)===De(be))&&P.add(B)}const F=[];for(const[B,Z]of Fe)(Z.some(be=>y.has(String(be.id)))||P.has(B))&&F.push(B);vs(F),clearTimeout(st.current),st.current=setTimeout(()=>{Zt(new Set),Ct(0),mn(new Map)},3200)}catch(r){console.error("fetchNearby failed:",r)}}const[gn,gt]=a.useState(()=>{try{const t=localStorage.getItem("ff_collapsed_groups");return new Set(t?JSON.parse(t):[])}catch{return new Set}}),ys=t=>gn.has(t),ws=(t,o)=>{gt(r=>{const l=new Set(r);return o?l.add(t):l.delete(t),localStorage.setItem("ff_collapsed_groups",JSON.stringify([...l])),l})},vs=(t=[])=>{gt(()=>{const o=Fe.map(([l])=>l),r=new Set(o);for(const l of t)r.delete(l);return localStorage.setItem("ff_collapsed_groups",JSON.stringify([...r])),r})},Ss=(t=!0)=>{gt(()=>{const o=Fe.map(([l])=>l),r=t?new Set(o):new Set;return localStorage.setItem("ff_collapsed_groups",JSON.stringify([...r])),r})},Ns=()=>{const t=Fe.map(([r])=>r),o=t.length>0&&t.every(r=>gn.has(r));Ss(!o)},[pt,zt]=a.useState(null),[js,Xe]=a.useState(null),As=Ys(vn(ur,{activationConstraint:{distance:4}}),vn(dr,{activationConstraint:{delay:80,tolerance:6}})),ks=t=>{const o=t?.over;if(!o){Xe(null);return}const r=String(o.id||"");if(r.startsWith("col:"))Xe(r.slice(4));else if(r.startsWith("card:")){const l=Rt(Pe,r.slice(5));Xe(l)}else Xe(null)},_t=()=>window.confirm("Sind sie sicher?"),Cs=async t=>{if(m){Xe(null),zt(null);return}Xe(null);const{active:o,over:r}=t;if(zt(null),!o||!r)return;const l=String(o.id||""),d=String(r.id||"");if(l.startsWith("ass:")&&d.startsWith("card:")){const[,h,w]=l.split(":"),y=d.slice(5);if(h&&w&&y&&h!==y)try{await jn(h,w);try{await An(w)}catch{}await Vt(y,w),Re(h,y);const I=await Me();k(I),Ce(I)}catch{alert("Einheit konnte nicht umgehÃ¤ngt werden.")}return}if(l.startsWith("veh:")&&d.startsWith("card:")){try{await Vt(d.slice(5),l.slice(4)),Re(d.slice(5));const h=await Me();k(h),Ce(h)}catch{alert("Einheit konnte nicht zugewiesen werden.")}return}if(l.startsWith("card:")){const h=l.slice(5),w=Rt(Pe,h);if(!w)return;if(d.startsWith("col:")){const y=d.slice(4);if(w!==y){if(y==="erledigt"&&w!=="erledigt"&&!_t())return;try{if(await xt({cardId:h,from:w,to:y,toIndex:0}),Re(h),y==="erledigt"){const[I,P]=await Promise.all([Me(),Ke()]);k(I),E(P),Ce(I)}else{const I=await Me();k(I),Ce(I)}}catch{alert("Statuswechsel konnte nicht gespeichert werden.")}}return}if(d.startsWith("card:")){const y=Rt(Pe,d.slice(5));if(y){if(y==="erledigt"&&w!=="erledigt"&&!_t())return;try{if(await xt({cardId:h,from:w,to:y,toIndex:0}),Re(h),y==="erledigt"){const[I,P]=await Promise.all([Me(),Ke()]);k(I),E(P),Ce(I)}else{const I=await Me();k(I),Ce(I)}}catch{alert("Statuswechsel konnte nicht gespeichert werden.")}}}}},Is=async()=>{if(confirm("Board wirklich zurÃ¼cksetzen?")){Y(!0);try{await or();const t=await Me();k(t),Ce(t)}catch{alert("Reset fehlgeschlagen.")}finally{Y(!1)}}},Es=()=>window.open(lr(),"_blank","noopener,noreferrer"),Ms=async({title:t,ort:o,typ:r,isArea:l=!1,areaCardId:d=null,areaColor:h,coordinates:w=null,location:y="",description:I=""})=>{const P=l?null:d?String(d):null,F={isArea:!!l,areaCardId:P};l&&(F.areaColor=h||Yr),w&&Number.isFinite(w?.lat)&&Number.isFinite(w?.lng)&&(F.lat=Number(w.lat),F.lng=Number(w.lng));const B=typeof y=="string"?y.trim():"";B&&(F.location=B);const Z=typeof I=="string"?I.trim():"";Z&&(F.description=Z);const ne=await cr(t,"neu",0,o,r,F);Jt.current=Date.now(),ne?.card?.id!=null&&Re(ne.card.id),k(be=>{if(!be)return be;const Ae=structuredClone(be);return Ae.columns.neu.items.unshift(ne.card),Ce(Ae),Ae})},Ps=async(t,o)=>{if(!t?.id)return;const r=o?String(o):null;try{const l=await Gt(t.id,{areaCardId:r});sn(l?.card,l?.board)}catch(l){alert(l?.message||"Abschnitt konnte nicht geÃ¤ndert werden.")}},Ts=async(t,o)=>{try{const r=await Gt(t,o);return sn(r?.card,r?.board),r}catch(r){throw r}};if(ct.startsWith("/protokoll/edit/")){const t=ct.split("/")[3],o=Number(t);return e.jsxs("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden flex flex-col min-h-0 floating-actions-safe-area",children:[e.jsx(bt,{helpHref:"/Hilfe_Meldestelle.pdf",helpTitle:"Hilfe â€“ Meldestelle/Protokoll",onAdd:()=>{window.location.hash="/protokoll/neu"},addTitle:"Neuen Eintrag anlegen",navButtons:vt("meldestelle")}),e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Meldung â€“ Bearbeiten"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"Zur Ãœbersicht"})]}),e.jsx("div",{className:"flex-1 min-h-0 overflow-hidden p-3",children:e.jsx(Sn,{mode:"edit",editNr:o})})]})}return ct.startsWith("/protokoll/neu")?e.jsxs("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden flex flex-col min-h-0 floating-actions-safe-area",children:[e.jsx(bt,{helpHref:"/Hilfe_Meldestelle.pdf",helpTitle:"Hilfe â€“ Meldestelle/Protokoll",onAdd:()=>{window.location.hash="/protokoll/neu"},addTitle:"Neuen Eintrag anlegen",navButtons:vt("meldestelle")}),e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Meldung â€“ Eintrag anlegen"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"Zur Ãœbersicht"})]}),e.jsx("div",{className:"flex-1 min-h-0 overflow-hidden p-3",children:e.jsx(Sn,{mode:"create"})})]}):ct.startsWith("/protokoll")?e.jsxs("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden flex flex-col min-h-0 floating-actions-safe-area",children:[e.jsx(bt,{helpHref:"/Hilfe_Meldestelle.pdf",helpTitle:"Hilfe â€“ Meldestelle/Protokoll",onAdd:()=>{window.location.hash="/protokoll/neu"},addTitle:"Neuen Eintrag anlegen",navButtons:vt("meldestelle")}),e.jsxs("header",{className:"flex flex-wrap items-center justify-between gap-3 p-3 border-b bg-white shadow",children:[e.jsxs("h1",{className:"text-xl font-bold flex items-center gap-2",children:[s&&e.jsx(Nn,{className:"h-5 w-5"}),e.jsx("span",{children:"MeldungsÃ¼bersicht"})]}),e.jsxs("div",{className:"flex flex-1 flex-wrap items-center justify-end gap-2 min-w-0",children:[e.jsx("input",{id:"protocolSearch",type:"search",className:"w-full sm:w-64 md:w-72 lg:w-80 max-w-full px-3 py-2 text-sm rounded-xl border",placeholder:"Sucheâ€¦",value:le,onChange:t=>K(t.target.value),"aria-label":"Suche Meldungen"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("a",{href:"/api/protocol/csv/file",className:"px-3 py-1.5 rounded-md border bg-white",title:"protocol.csv herunterladen",children:"CSV"}),e.jsx("button",{onClick:()=>{!q||ae||(window.location.hash="/protokoll/neu")},disabled:!q||ae,className:`px-3 py-1.5 rounded-md text-white ${!q||ae?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-emerald-600 hover:bg-emerald-700"}`,title:q?ae?"S3 darf nur anlegen, wenn LtStb nicht angemeldet ist":void 0:"Keine Berechtigung (Meldestelle)",children:"+ Eintrag anlegen"})]})]})]}),e.jsx("div",{className:"flex-1 min-h-0 overflow-hidden p-3",children:e.jsx(Rr,{searchTerm:le})})]}):e.jsxs("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden flex flex-col min-h-0 floating-actions-safe-area",style:{fontSize:"var(--ui-scale)"},children:[e.jsx(bt,{helpHref:"/Hilfe.pdf",onAdd:u?()=>$e(!0):void 0,addTitle:"Einsatz anlegen",navButtons:vt("einsatz")}),!v&&e.jsx("div",{className:"fixed inset-0 z-10 bg-black/10 backdrop-blur-sm flex items-center justify-center",children:e.jsx("div",{className:"px-4 py-2 rounded-lg bg-white shadow",children:"Ladeâ€¦"})}),e.jsxs("header",{className:"flex flex-wrap items-center justify-between gap-3 mb-2",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("h1",{className:"text-xl md:text-2xl font-bold flex items-center gap-2",children:[s&&e.jsx(Nn,{className:"h-5 w-5"}),e.jsx("span",{children:"Einsatzstellen-Ãœbersicht-Feuerwehr"})]}),e.jsx("div",{title:`Quelle: ${Te.file||"list_filtered.json"}`,className:"inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border bg-white text-gray-700",style:{borderColor:"#cbd5e1"},children:e.jsxs("span",{children:["Zuletzt geladen: ",e.jsx("b",{children:Te.lastLoadedIso?new Date(Te.lastLoadedIso).toLocaleTimeString("de-AT",{hour12:!1}):"â€“"})]})})]}),It&&e.jsx("div",{className:"flex-1 min-w-[200px] min-h-[2.5rem] max-w-full sm:min-w-[260px]",children:e.jsx("div",{className:"ticker-container w-full h-full flex items-center","aria-live":"polite",children:e.jsx("marquee",{className:"ticker-content",behavior:"scroll",direction:"left",scrollAmount:6,onMouseEnter:t=>{typeof t.target.stop=="function"&&t.target.stop()},onMouseLeave:t=>{typeof t.target.start=="function"&&t.target.start()},children:e.jsx("span",{children:It})},It)})}),e.jsxs("div",{className:"toolbar flex flex-wrap items-center gap-2 justify-end w-full md:w-auto",children:[e.jsxs("label",{className:"flex flex-wrap items-center gap-2 text-sm text-gray-700",htmlFor:"areaFilter",children:[e.jsx("span",{className:"whitespace-nowrap",children:"Filter Abschnitt"}),e.jsxs("select",{id:"areaFilter",className:`border rounded px-2 py-1 shrink-0 min-w-[150px] transition-colors ${H?`bg-red-800 border-red-900 text-white ${he?"filter-pulse":""}`:"bg-white border-gray-300 text-gray-900"}`,value:H,onChange:t=>J(t.target.value),children:[e.jsx("option",{value:"",children:"Alles Anzeigen"}),Ue.map(t=>e.jsx("option",{value:String(t.id),children:t.label},t.id))]})]}),e.jsx("input",{id:"boardSearch",type:"search",className:"w-full sm:w-64 md:w-72 lg:w-80 max-w-full px-3 py-2 text-sm rounded-xl border",placeholder:"Sucheâ€¦",value:Q,onChange:t=>fe(t.target.value),"aria-label":"Suche EinsÃ¤tze"}),e.jsx("button",{onClick:Es,className:"px-3 py-1.5 rounded-md bg-purple-600 hover:bg-purple-700 text-white",children:"PDF"}),e.jsx("button",{onClick:()=>window.open("/api/log.csv","_blank"),className:"px-3 py-1.5 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white",title:"log.csv herunterladen",children:"LogÂ (CSV)"}),e.jsx("button",{onClick:os,disabled:m||Lt,className:"px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-60",title:"Import sofort ausfÃ¼hren",children:Lt?"Importâ€¦":"Import"}),e.jsx(Br,{autoEnabled:X,remaining:es,disabled:m,showTimer:!1,showLastLoaded:!1,onImportInfo:Ie}),ve&&e.jsx("button",{onClick:Is,disabled:m||we,className:`px-3 py-1.5 rounded-md text-white ${we?"bg-gray-400":"bg-gray-700 hover:bg-gray-800"}`,children:we?"Resetâ€¦":"Reset"})]})]}),e.jsxs(Xs,{sensors:As,collisionDetection:t=>t?.active?.data?.current?.type==="vehicle"?er(t):tr(t),onDragStart:t=>zt({type:t?.active?.data?.current?.type,id:t.active.id,data:t?.active?.data?.current}),onDragOver:ks,onDragEnd:Cs,children:[e.jsxs("main",{className:"grid grid-cols-1 md:[grid-template-columns:minmax(180px,220px)_repeat(3,minmax(0,1fr))] gap-2 min-h-0 flex-1 overflow-hidden pr-[var(--fab-safe-margin)]",children:[e.jsx("div",{className:"flex flex-col gap-2 h-full min-h-0",children:e.jsxs("section",{className:"bg-white rounded-xl shadow p-3 flex-1 flex flex-col min-h-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-semibold",children:e.jsx("button",{type:"button",onClick:Ns,title:"Alle Gruppen auf/zu klappen",className:"underline decoration-dotted hover:opacity-80 focus:outline-none",children:"Einheiten (frei)"})}),b&&e.jsx("button",{onClick:()=>ue(!0),className:"px-2 py-1 text-sm rounded bg-emerald-600 text-white",children:"+ Einheit"})]}),e.jsxs("div",{className:"overflow-auto pr-1 flex-1 min-h-0 space-y-3",children:[hn.length===0&&e.jsx("div",{className:"text-[0.85rem] text-gray-500 italic",children:Ze?"Keine Einheiten gefunden.":"â€” alle Einheiten sind zugewiesen â€”"}),hn.map(([t,o])=>{const r=ys(t),l=$.has(t)?$.get(t):!0,d=S.get(t)===!0,h=ms.has(t),w=na({available:l,alerted:d,assigned:h});return e.jsxs("div",{className:`border rounded-md ${w.container}`,children:[e.jsxs("div",{className:"flex items-center justify-between px-2 py-2 gap-2",children:[e.jsx("button",{type:"button",onClick:()=>ws(t,!r),className:"flex-1 flex items-center justify-between gap-2 text-left",title:r?"aufklappen":"zuklappen",children:e.jsx("span",{className:`text-xs font-semibold ${w.label}`,children:t})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("label",{className:"flex items-center gap-1 text-[11px] text-gray-600",title:l?"Gruppe verfÃ¼gbar":"Gruppe deaktiviert",children:[e.jsx("span",{className:"sr-only",children:"Gruppe verfÃ¼gbar"}),e.jsx("input",{type:"checkbox",checked:l,onChange:y=>us(t,y.target.checked),disabled:!b})]}),e.jsx("span",{className:"group-chip",children:o.length})]})]}),!r&&e.jsx("div",{className:"px-2 pb-2 grid grid-cols-1 gap-1.5",children:o.map(y=>{const I=y?.available!==!1,P=$.has(y?.ort||"")?$.get(y?.ort||""):y?.groupAvailable!==!1,F=I&&P,B=P===(y?.groupAvailable!==!1)&&F===I?y:{...y,available:F,groupAvailable:P};return e.jsxs("div",{className:"flex items-center gap-2 justify-between",children:[e.jsx(mr,{editable:u&&F,vehicle:B,pillWidthPx:160,near:qt.has(String(y.id))&&Date.now()<kt,distKm:fn.get(String(y.id))}),e.jsxs("label",{className:"flex items-center gap-1 text-[11px] text-gray-600 shrink-0",title:F?"Einheit verfÃ¼gbar":"Einheit deaktiviert",children:[e.jsx("span",{className:"sr-only",children:"Einheit verfÃ¼gbar"}),e.jsx("input",{type:"checkbox",checked:F,onChange:Z=>ds(y,Z.target.checked),disabled:!b||!P})]})]},y.id)})})]},t)})]})]})}),[{id:"neu",title:"Neu",bg:"bg-red-100",totals:hs},{id:"in-bearbeitung",title:"In Bearbeitung",bg:"bg-yellow-100",totals:gs},{id:"erledigt",title:"Erledigt",bg:"bg-green-100",totals:ps}].map(({id:t,title:o,bg:r,totals:l})=>{const d=nn?`${o}: ${nn}`:o;return e.jsx("div",{className:js===t?"drag-over":"",children:e.jsx(Nr,{editable:u,colId:t,bg:r,title:e.jsxs("span",{className:"column-header flex flex-wrap items-center justify-between gap-2",children:[e.jsx("span",{className:"font-semibold break-words min-w-0",children:d}),e.jsxs("span",{className:"flex flex-wrap items-center gap-1.5 justify-end w-full sm:w-auto",children:[e.jsxs("span",{className:"kpi-badge","data-variant":"incidents",children:["â¬› ",l.incidents]}),e.jsxs("span",{className:"kpi-badge","data-variant":"areas",children:["ðŸ—ºï¸ ",l.areas]}),e.jsxs("span",{className:"kpi-badge","data-variant":"units",children:["ðŸš’ ",l.units]}),e.jsxs("span",{className:"kpi-badge","data-variant":"persons",children:["ðŸ‘¥ ",l.persons]})]})]}),children:e.jsx("ul",{className:"space-y-2 overflow-y-auto overflow-x-hidden pl-1 pr-2 py-2",style:{maxHeight:"calc(100vh - 260px)"},children:e.jsx(nr,{items:(at.columns[t].items||[]).map(h=>Qr(h.id)),strategy:sr,children:(at.columns[t].items||[]).map(h=>e.jsx(fr,{editable:u,card:h,colId:t,vehiclesById:Oe,areaOptions:Ue,areaLabelById:Qe,areaColorById:Et,onAreaChange:u?Ps:void 0,onEditCard:u?w=>{te(w),ge(!0),Ge(!0)}:void 0,distById:fn,pillWidthPx:160,pulse:it.has(String(h.id))&&Date.now()<kt,onUnassign:async(w,y)=>{await jn(w,y);try{await An(y)}catch{}const[I,P]=await Promise.all([Me(),Ke()]);Re(w),k(I),E(P),Ce(I)},onOpenMap:w=>ie({address:h.ort,card:h,board:Pe,vehiclesById:fs}),onAdvance:u?async w=>{if(t==="neu"){await xt({cardId:w.id,from:"neu",to:"in-bearbeitung",toIndex:0}),Re(w.id);const y=await Me();k(y),Ce(y)}else if(t==="in-bearbeitung"){if(!_t())return;await xt({cardId:w.id,from:"in-bearbeitung",to:"erledigt",toIndex:0});const[y,I]=await Promise.all([Me(),Ke()]);Re(w.id),k(y),E(I),Ce(y)}}:void 0,onEditPersonnelStart:u?(w,y)=>{ye({cardId:w.id}),oe(y)}:void 0,editing:de,editingValue:pe,setEditingValue:oe,onEditPersonnelSave:u?async w=>{try{await rr(w.id,pe===""?null:Number(pe)),Re(w.id);const y=await Me();k(y),Ce(y)}finally{ye(null),oe("")}}:void 0,onEditPersonnelCancel:u?()=>{ye(null),oe("")}:void 0,onClone:cs,onVehiclesIconClick:xs,nearIds:qt,nearUntilMs:kt,onShowInfo:We},h.id))})})})},t)})]}),e.jsxs(ar,{dropAnimation:{duration:180,easing:"ease-out"},children:[pt?.type==="vehicle"&&(()=>{const t=Oe.get(pt?.data?.vehicleId);return t?e.jsx("div",{className:"pointer-events-none",children:e.jsxs("div",{style:{width:160},className:"max-w-full select-none border-2 border-red-300 rounded-2xl bg-white px-2 py-1 shadow-lg",children:[e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:t.label||t.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate",children:[t.ort||"â€”"," Â· ðŸ‘¥ ",t.mannschaft??0]})]})}):null})(),pt?.type==="card"&&(()=>{const t=String(pt?.id||"").replace(/^card:/,""),o=ht(Pe,t);return o?e.jsx("div",{className:"pointer-events-none w-[280px]",children:e.jsxs("div",{className:"rounded-lg bg-white shadow-xl border p-3",children:[e.jsx("div",{className:"font-semibold text-sm mb-1 truncate",children:o.content}),e.jsxs("div",{className:"text-xs text-gray-600",children:[o.assignedVehicles?.length||0," Einheiten â€¢"," ","ðŸ‘¥ ",Number.isFinite(o?.manualPersonnel)?o.manualPersonnel:(o.assignedVehicles||[]).reduce((r,l)=>r+(Oe.get(l)?.mannschaft??0),0)]})]})}):null})()]})]}),je&&e.jsx(xr,{onClose:()=>ue(!1),onCreate:async t=>{const o=await fetch("/api/vehicles",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(t)});if(!o.ok){const r=await o.text().catch(()=>String(o.status));throw new Error(`HTTP ${o.status} ${r}`)}E(await Ke())}}),Le&&e.jsx(Sr,{onClose:()=>$e(!1),onCreate:Ms,types:z,areaOptions:Ue}),W&&e.jsx(br,{context:W,onClose:()=>ie(null)}),e.jsx(Cr,{open:Ee,info:p||{},onClose:()=>{Ge(!1),te(null),ge(!1)},canEdit:u,onSave:Ts,areaOptions:Ue,areaLabelById:Qe,forceEdit:ke,types:z})]})}export{ia as default};
