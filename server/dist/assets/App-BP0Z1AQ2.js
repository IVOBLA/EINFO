import{u as Nt,j as e,r,a as sn,C as an,b as rn,c as on,d as st,D as ln,e as cn,f as dn,S as un,v as mn,g as hn,T as gn,P as pn}from"./index-CaDK1wLf.js";function at({cardId:a,vehicle:s,pillWidthPx:l=160,onUnassign:d,onClone:p,near:h=!1,distKm:f=null}){const S=`ass:${a}:${s.id}`,{attributes:j,listeners:I,setNodeRef:D,transform:P,isDragging:L}=Nt({id:S,data:{type:"assigned",vehicleId:s.id,fromCardId:a}}),A={width:l,transform:P?`translate3d(${P.x}px, ${P.y}px, 0)`:void 0};return e.jsxs("div",{ref:D,style:A,...j,...I,className:`relative self-start border-2 rounded-2xl bg-white px-2 pr-9 py-1 shadow-sm
                  select-none cursor-grab active:cursor-grabbing
                  ${h?"border-emerald-500 ring-2 ring-emerald-300":"border-red-300"}
                  ${L?"opacity-50":""}`,title:"Ziehen: auf andere Karte verschieben · Doppelklick: klonen",onDoubleClick:()=>p?.(s.id,a),children:[h&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-0.5 rounded-2xl border-2 border-emerald-400/50 animate-ping"}),e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:s.label||s.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate flex justify-between items-center",children:[e.jsxs("span",{children:[s.ort||"—"," · 👥 ",s.mannschaft??0]}),h&&Number.isFinite(Number(f))&&e.jsxs("span",{className:"absolute top-1 right-8 text-[11px] tabular-nums text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded whitespace-nowrap",children:[Number(f)," Km"]})]}),e.jsx("button",{type:"button",onMouseDown:F=>F.stopPropagation(),onTouchStart:F=>F.stopPropagation(),onClick:F=>{F.stopPropagation(),d?.(a,s.id)},title:"Einheit entfernen",className:"absolute right-2 top-1/2 -translate-y-1/2 h-6 w-6 rounded-full bg-red-600 text-white shadow flex items-center justify-center","aria-label":"Einheit entfernen",children:e.jsx("svg",{viewBox:"0 0 12 12",width:"12",height:"12","aria-hidden":"true",children:e.jsx("path",{d:"M1 1 L11 11 M11 1 L1 11",stroke:"white",strokeWidth:"2",strokeLinecap:"round"})})})]})}function fn(a){const{card:s,colId:l,vehiclesById:d,pillWidthPx:p=160,onUnassign:h,onOpenMap:f,onAdvance:S,onEditPersonnelStart:j,editing:I,editingValue:D,setEditingValue:P,onEditPersonnelSave:L,onEditPersonnelCancel:A,onClone:F,onVehiclesIconClick:J,onShowInfo:ee,nearIds:K,nearUntilMs:B,distById:N,pulse:V}=a,[O,T]=r.useState(l==="in-bearbeitung"),q=r.useRef((s.assignedVehicles||[]).length),H=r.useRef(null),w=Date.now()<(B||0),{attributes:ae,listeners:R,setNodeRef:pe,transform:oe,transition:ce,isDragging:de}=sn({id:`card:${s.id}`,data:{type:"card",cardId:s.id}}),ye={transform:an.Transform.toString(oe),transition:ce,opacity:de?.8:1},b=l==="erledigt"?s.everVehicles?.length||0:s.assignedVehicles?.length||0,$=r.useMemo(()=>(s.assignedVehicles||[]).map(x=>d.get(x)).filter(Boolean),[s,d]),Z=r.useMemo(()=>l==="erledigt"?Number.isFinite(s?.everPersonnel)?s.everPersonnel:0:Number.isFinite(s?.manualPersonnel)?s.manualPersonnel:$.reduce((x,_)=>x+(_?.mannschaft??0),0),[l,s,$]);r.useEffect(()=>{if(l!=="in-bearbeitung"||!w)return;(s.assignedVehicles||[]).some(_=>K?.has(String(_)))&&T(!0)},[l,w,K,s.assignedVehicles]),r.useEffect(()=>{if(l!=="in-bearbeitung")return;const x=(s.assignedVehicles||[]).length,_=q.current;x>_&&T(!0),q.current=x},[l,s.assignedVehicles]),r.useEffect(()=>{if(l==="in-bearbeitung"&&O&&H.current)try{H.current.scrollIntoView({behavior:"smooth",block:"nearest"})}catch{}},[l,O]);const Q=()=>{l==="neu"?typeof J=="function"&&J(s,l):(l==="in-bearbeitung"||l==="erledigt")&&T(x=>!x)},U=()=>{typeof j=="function"&&j(s,Z)};return e.jsxs("li",{ref:pe,style:ye,className:`relative rounded-lg bg-white shadow border transition mx-1
              ${V&&l==="neu"?"ring-2 ring-red-400/60":""}`,children:[V&&l==="neu"&&e.jsxs(e.Fragment,{children:[e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 rounded-lg bg-red-500/10 animate-pulse-inner"}),e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 rounded-lg animate-ping-safe"})]}),e.jsxs("div",{className:"p-3 select-none",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",...ae,...R,children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-semibold text-sm leading-5 truncate",children:s.content}),!!s.ort&&e.jsx("button",{type:"button",onClick:()=>f?.(s.ort),className:"text-[12px] text-blue-700 hover:underline truncate",title:"Ort in Karte öffnen",children:s.ort})]}),e.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[e.jsxs("button",{type:"button",title:l==="neu"?"Nahe Einheiten prüfen":"Einheiten auf-/zuklappen",className:"px-2 py-1 rounded text-[12px] border hover:bg-red-50 flex items-center gap-1",onPointerDown:x=>x.stopPropagation(),onClick:x=>{x.stopPropagation(),x.preventDefault(),Q()},children:["🚒 ",b,(l==="in-bearbeitung"||l==="erledigt")&&e.jsx("span",{children:O?"▾":"▸"})]}),e.jsxs("button",{type:"button",className:"px-2 py-1 rounded text-[12px] border bg-white hover:bg-gray-50",title:"Personalzahl bearbeiten",onPointerDown:x=>x.stopPropagation(),onClick:x=>{x.stopPropagation(),U()},children:["👥 ",Z]}),S&&e.jsx("button",{type:"button",onPointerDown:x=>x.stopPropagation(),onClick:x=>{x.stopPropagation(),S(s)},className:"ml-1 px-2 py-1 rounded text-[12px] border bg-white hover:bg-gray-50",title:"weiter",children:"➔"})]})]}),l==="neu"&&!!$.length&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-1.5",children:$.map(x=>e.jsx(at,{cardId:s.id,vehicle:x,pillWidthPx:p,onUnassign:h,onClone:F,near:!!K&&w&&K.has(String(x.id)),distKm:N?.get(String(x.id))??null},`ass-${s.id}-${x.id}`))}),l==="in-bearbeitung"&&O&&!!$.length&&e.jsx("div",{ref:H,className:"mt-2 flex flex-wrap gap-1.5",children:$.map(x=>e.jsx(at,{cardId:s.id,vehicle:x,pillWidthPx:p,onUnassign:h,onClone:F,near:!!K&&w&&K.has(String(x.id)),distKm:N?.get(String(x.id))??null},`ass-${s.id}-${x.id}`))}),l==="erledigt"&&O&&!!s.everVehicles?.length&&e.jsx("ul",{className:"mt-2 text-sm text-gray-700 list-disc list-inside space-y-1",children:s.everVehicles.map(x=>{const _=d.get(x),te=_?.label||_?.id||"Unbekannt",n=_?.ort?` (${_.ort})`:"";return e.jsxs("li",{children:[te,n]},x)})}),I?.cardId===s.id&&e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("input",{type:"number",className:"w-20 border rounded px-2 py-1 text-sm",value:D,onChange:x=>P(x.target.value),placeholder:"Personen"}),e.jsx("button",{className:"px-2 py-1 text-sm rounded bg-emerald-600 text-white",onClick:()=>L(s),children:"Speichern"}),e.jsx("button",{className:"px-2 py-1 text-sm rounded bg-gray-200",onClick:A,children:"Abbrechen"})]}),e.jsxs("div",{className:"mt-2 flex justify-end gap-2",children:[e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Ort in Karte öffnen",onPointerDown:x=>x.stopPropagation(),onClick:x=>{x.stopPropagation(),f?.(s.ort)},children:"Karte"}),e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Einsatz-Info",onPointerDown:x=>x.stopPropagation(),onClick:x=>{x.stopPropagation(),ee?.(s)},children:"?"})]})]})]})}function xn({vehicle:a,pillWidthPx:s=160,near:l=!1,distKm:d=null}){const p=`veh:${a.id}`,{attributes:h,listeners:f,setNodeRef:S,transform:j,isDragging:I}=Nt({id:p,data:{type:"vehicle",vehicleId:a.id}});return e.jsxs("div",{ref:S,style:{width:s,transform:j?`translate3d(${j.x}px, ${j.y}px, 0)`:void 0},...h,...f,className:`relative max-w-full select-none border-2 ${l?"border-emerald-500":"border-red-300"} rounded-2xl bg-white
                 px-2 py-1 shadow-sm cursor-grab active:cursor-grabbing
                 ${I?"opacity-50":""}`,children:[l&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-0.5 rounded-2xl border-2 border-emerald-400/50 animate-ping"}),e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:a.label||a.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate flex justify-between items-center",children:[e.jsxs("span",{children:[a.ort||"—"," · 👥 ",a.mannschaft??0]}),l&&Number.isFinite(Number(d))&&e.jsxs("span",{className:"absolute top-1 right-1 text-[11px] tabular-nums text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded whitespace-nowrap",children:[Number(d)," Km"]})]})]})}const bn="";async function se(a,s,l){const d=await fetch(bn+s,{method:a,headers:{"Content-Type":"application/json"},body:l===void 0?void 0:JSON.stringify(l),cache:"no-store",credentials:"include"});if(!d.ok)throw new Error(`HTTP ${d.status} ${await d.text().catch(()=>d.statusText)}`);return(d.headers.get("content-type")||"").includes("application/json")?d.json():d.text()}async function ne(){return se("GET","/api/board")}async function rt(){return se("GET","/api/vehicles")}async function yn(){try{return await se("GET","/api/types")}catch{return[]}}async function it(a,s="neu",l=0,d="",p="",h={}){const f={title:a,columnId:s,toIndex:l,ort:d,typ:p};if(h&&typeof h=="object"){const{lat:S,lng:j,latitude:I,longitude:D,...P}=h;Number.isFinite(I)&&(f.latitude=Number(I)),Number.isFinite(D)&&(f.longitude=Number(D)),Number.isFinite(S)&&(f.latitude=Number(S)),Number.isFinite(j)&&(f.longitude=Number(j)),Object.assign(f,P)}return se("POST","/api/cards",f)}async function Me({cardId:a,from:s,to:l,toIndex:d=0}){return se("POST",`/api/cards/${encodeURIComponent(a)}/move`,{from:s,to:l,toIndex:d})}async function Be(a,s){return se("POST",`/api/cards/${encodeURIComponent(a)}/assign`,{vehicleId:s})}async function ot(a,s){return se("POST",`/api/cards/${encodeURIComponent(a)}/unassign`,{vehicleId:s})}async function wn(a,s){return se("PATCH",`/api/cards/${encodeURIComponent(a)}/personnel`,{manualPersonnel:s})}async function vn(){return se("POST","/api/reset",{})}async function Nn(){return se("GET","/api/import/auto-config")}async function lt({enabled:a,intervalSec:s}){return se("POST","/api/import/auto-config",{enabled:a,intervalSec:s})}function jn(){return"/api/export/pdf"}async function Sn(a,s){const l=`cardId=${encodeURIComponent(a)}`,p=Number.isFinite(Number(s))&&Number(s)>0?`${l}&radiusKm=${encodeURIComponent(s)}`:l,h=await fetch(`/api/nearby?${p}`,{credentials:"same-origin",cache:"no-store"});if(!h.ok)throw new Error("fetchNearby failed");return h.json()}async function ct(a,s,l,d=null,p="manual"){return se("PATCH",`/api/vehicles/${encodeURIComponent(a)}/position`,{lat:Number(s),lng:Number(l),incidentId:d,source:p})}async function dt(a){return se("DELETE",`/api/vehicles/${encodeURIComponent(a)}/position`)}function kn(a,s){const d=(s.lat-a.lat)*Math.PI/180,p=(s.lng-a.lng)*Math.PI/180,h=Math.sin(d/2)**2+Math.cos(a.lat*Math.PI/180)*Math.cos(s.lat*Math.PI/180)*Math.sin(p/2)**2;return 2*6371*Math.asin(Math.sqrt(h))}function ut(a,s,l){const p=l*Math.PI/180,h=a.lat*Math.PI/180,f=a.lng*Math.PI/180,S=s/6371e3,j=Math.asin(Math.sin(h)*Math.cos(S)+Math.cos(h)*Math.sin(S)*Math.cos(p))*180/Math.PI,I=(f+Math.atan2(Math.sin(p)*Math.sin(S)*Math.cos(h),Math.cos(S)-Math.sin(h)*Math.sin(j*Math.PI/180)))*180/Math.PI;return{lat:j,lng:I}}async function mt(a){if(!a||!window.google?.maps?.Geocoder)return null;const s=new window.google.maps.Geocoder;return new Promise(l=>{s.geocode({address:a,region:"AT"},(d,p)=>{p==="OK"&&d?.[0]?.geometry?.location?l({lat:d[0].geometry.location.lat(),lng:d[0].geometry.location.lng(),formatted:d[0].formatted_address||a}):l(null)})})}const Ce=a=>String(a||"").trim().toLowerCase();async function ht(){try{const a=await fetch("/api/vehicles",{cache:"no-store"});return a.ok?a.json():[]}catch{return[]}}async function gt(){try{const a=await fetch("/api/gps",{cache:"no-store"});if(a.ok)return await a.json()}catch(a){console.error("GPS fetch failed:",a)}return[]}function pt(a){const s=a?.typ||a?.type||"—",l=a?.timestamp?new Date(a.timestamp).toLocaleString("de-AT",{hour12:!1}):"—",d=a?.alerted??"—",p=a?.description??"—",h=a?.additionalAddressInfo||a?.ort||"—",f=[];a?.location&&f.push(String(a.location));const S=Number.isFinite(a?.latitude),j=Number.isFinite(a?.longitude);S&&j&&f.push(`(${a.latitude}, ${a.longitude})`);const I=f.length?f.join(" "):"—";return`
    <div style="min-width:280px">
      <div style="font-weight:700;margin-bottom:4px">${a?.content||"Einsatz"}</div>
      <div><b>Typ:</b> ${s}</div>
      <div><b>Alarmzeit:</b> ${l}</div>
      <div><b>Alarmiert:</b> ${d}</div>
      <div><b>Beschreibung:</b> ${p}</div>
      <div><b>Adresse:</b> ${h}</div>
      <div><b>Location:</b> ${I}</div>
    </div>
  `}const ge=44,ft="/vehicle-red.gif",In="/vehicle-gray.png",Cn="/vehicle-drive.gif";function En({context:a,address:s,onClose:l}){const d=s||a?.card?.ort||a?.address||"",p=!!window.google?.maps,h=r.useRef(null),[f,S]=r.useState(!1),[j,I]=r.useState(""),D=r.useMemo(()=>{const P=a?.card;return P&&Number.isFinite(P?.latitude)&&Number.isFinite(P?.longitude)?{lat:Number(P.latitude),lng:Number(P.longitude)}:null},[a]);if(r.useEffect(()=>{if(!p||!a?.card||!h.current)return;let P=!1,L,A;const F=new Map;let J=null;return(async()=>{try{S(!0),I("");let K=D;if(!K){const b=await mt(a.card.ort);if(P)return;b&&(K={lat:b.lat,lng:b.lng})}if(!K){I("Konnte Einsatz-Position nicht bestimmen.");return}L=new window.google.maps.Map(h.current,{center:K,zoom:18,mapTypeId:"roadmap"}),A=new window.google.maps.InfoWindow;const B=(b,$,Z,Q,{hover:U=!1}={})=>{const x={path:"M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z",fillColor:$,fillOpacity:1,strokeColor:"#333",strokeWeight:1,scale:1.2},_=new window.google.maps.Marker({position:b,map:L,title:Z,icon:x});if(Q){const te=()=>{A.setContent(Q),A.open(L,_)};U?(_.addListener("mouseover",te),_.addListener("mouseout",()=>A.close())):_.addListener("click",te)}return _};B(K,"#d11a1a",a.card.content||"Einsatz",pt(a.card),{hover:!0});const N=[...a?.board?.columns?.neu?.items||[],...a?.board?.columns?.["in-bearbeitung"]?.items||[]],V=new Map;for(const b of N)if(Number.isFinite(b.latitude)&&Number.isFinite(b.longitude))V.set(b.id,{lat:Number(b.latitude),lng:Number(b.longitude)});else if(b.ort){const $=await mt(b.ort);$&&V.set(b.id,{lat:$.lat,lng:$.lng})}for(const b of N){if(b.id===a.card.id)continue;const $=V.get(b.id);$&&B($,"#1e63d1",b.content||"Einsatz",pt(b),{hover:!0})}const O=new Map;for(const b of N)for(const $ of b.assignedVehicles||[])O.set(String($),b.id);const T=await gt(),q=new Map(T.filter(b=>Number.isFinite(b?.lat)&&Number.isFinite(b?.lng)&&b?.realname).map(b=>[Ce(b.realname),b])),H=await ht(),w=new Map(H.filter(b=>b&&b.source!=="gps"&&Number.isFinite(b.latitude)&&Number.isFinite(b.longitude)).map(b=>[String(b.id),{lat:Number(b.latitude),lng:Number(b.longitude)}])),ae=Object.values(a.vehiclesById||{}),R=10,pe=50,oe=new Map,ce=window.google?.maps?.marker?.AdvancedMarkerElement,de=(b,$,Z)=>{if(!b)return In;if(!$||!Z||!V.has(Z))return ft;const Q=V.get(Z);return kn($,Q)>.1?Cn:ft},ye=(b,$,Z,Q,U,x)=>{const _=de($,Q,U),te=!Q;if(ce){const n=document.createElement("img");n.src=_,n.width=ge,n.height=ge,n.alt=Z||"",n.decoding="async";const i=new ce({map:L,position:b,content:n,title:Z});if(te){try{i.draggable=!0}catch{}i.addListener("dragend",async m=>{const g=m?.latLng||i.position,C=typeof g.lat=="function"?g.lat():g.lat,k=typeof g.lng=="function"?g.lng():g.lng;try{await ct(x,C,k,U,"manual")}catch(z){i.__setPosition(b),console.error("setVehiclePosition failed:",z),alert("Position konnte nicht gespeichert werden.")}})}return i.__setPosition=m=>{i.position=m},i.__setIcon=(m,g,C)=>{n.src=de(m,g,C)},i.__onOver=m=>{n.addEventListener("mouseover",m),n.addEventListener("mouseout",()=>A.close())},i}else{const n=new window.google.maps.Marker({position:b,map:L,title:Z,draggable:te,icon:{url:_,scaledSize:new window.google.maps.Size(ge,ge),anchor:new window.google.maps.Point(ge/2,ge/2)}});return te&&n.addListener("dragend",async i=>{const m=i?.latLng||n.getPosition(),g=typeof m.lat=="function"?m.lat():m.lat,C=typeof m.lng=="function"?m.lng():m.lng;try{await ct(x,g,C,U,"manual")}catch(k){n.__setPosition(b),console.error("setVehiclePosition failed:",k),alert("Position konnte nicht gespeichert werden.")}}),n.__setPosition=i=>n.setPosition(i),n.__setIcon=(i,m,g)=>n.setIcon({url:de(i,m,g),scaledSize:new window.google.maps.Size(ge,ge),anchor:new window.google.maps.Point(ge/2,ge/2)}),n.__onOver=i=>{n.addListener("mouseover",i),n.addListener("mouseout",()=>A.close())},n}};for(const b of ae){const $=String(b.id),Z=Ce(`${b?.label||""} ${b?.ort||""}`),Q=q.get(Z),U=O.get($);if(!U&&!Q)continue;let x=null,_=null;if(Q)_={lat:Number(Q.lat),lng:Number(Q.lng)},x=_;else if(w.has($))x=w.get($);else if(U&&V.has(U)){const g=V.get(U),k=((oe.get(U)||0)+pe)%360;oe.set(U,k),x=ut(g,R,k)}if(!x)continue;const n=ye(x,!!U,b.label||b.id,_,U,$),i=U&&N.find(g=>g.id===U),m=i?`<br/><i>zugeordnet: ${i.content}</i>`:"";n.__onOver(()=>{const g=b?.ort||"";A.setContent(`<div style="min-width:220px"><b>${b.label||b.id}</b>${g?`<br/>${g}`:""}${m}</div>`);const C=ce?void 0:n;A.open({map:L,anchor:C,position:x,shouldFocus:!1})}),F.set($,n)}L.setCenter(K),L.setZoom(18),J=setInterval(async()=>{const b=await gt(),$=await ht(),Z=new Map($.filter(i=>i&&i.source!=="gps"&&Number.isFinite(i.latitude)&&Number.isFinite(i.longitude)).map(i=>[String(i.id),{lat:Number(i.latitude),lng:Number(i.longitude)}])),Q=new Map(b.filter(i=>Number.isFinite(i?.lat)&&Number.isFinite(i?.lng)&&i?.realname).map(i=>[Ce(i.realname),i])),U=new Map;for(const i of[...a?.board?.columns?.neu?.items||[],...a?.board?.columns?.["in-bearbeitung"]?.items||[]])for(const m of i.assignedVehicles||[])U.set(String(m),i.id);const x=Object.values(a.vehiclesById||{}),_=new Map;for(const i of x){const m=String(i.id),g=U.get(m),C=Ce(`${i?.label||""} ${i?.ort||""}`);if(g&&!Q.get(C)){const k=_.get(g)||[];k.push(m),_.set(g,k)}}for(const[i,m]of _.entries())m.sort();const te=10,n=50;for(const i of x){const m=String(i.id),g=F.get(m);if(!g)continue;const C=Ce(`${i?.label||""} ${i?.ort||""}`),k=Q.get(C),z=U.get(m);if(k)gpsPos={lat:Number(k.lat),lng:Number(k.lng)},g.__setPosition(gpsPos);else if(Z.has(m))g.__setPosition(Z.get(m));else if(z&&V.has(z)){const fe=((_.get(z)||[]).indexOf(m)+1)*n%360,Se=V.get(z);g.__setPosition(ut(Se,te,fe))}else{const W=F.get(m);W&&(W.setMap?W.setMap(null):W.map&&(W.map=null),F.delete(m));continue}const G=!!z;g.__setIcon(G,gpsPos,z)}},5e3)}catch(K){I(K?.message||"Kartenaufbau fehlgeschlagen.")}finally{S(!1)}})(),()=>{P=!0,J&&clearInterval(J),F.clear()}},[p,a,D]),!p||!a?.card){const P=`https://www.google.com/maps?q=${encodeURIComponent(d)}&output=embed`;return e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:l,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[70vh] p-2",onClick:L=>L.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-semibold text-sm",children:["Karte: ",d]}),e.jsx("button",{className:"px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm",onClick:l,children:"Schließen"})]}),e.jsx("iframe",{title:"maps",className:"w-full h-full rounded-lg border",src:P,loading:"lazy"})]})})}return e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:l,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-5xl h-[75vh] p-2",onClick:P=>P.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-semibold text-sm",children:["Karte: ",a?.card?.content||"Einsatz"," · weitere Einsätze (Neu & In Bearbeitung)"]}),e.jsx("button",{className:"px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm",onClick:l,children:"Schließen"})]}),e.jsx("div",{ref:h,className:"w-full h-full rounded-lg border"}),f&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"px-3 py-1.5 rounded bg-white shadow text-sm",children:"Lade…"})}),!!j&&e.jsx("div",{className:"absolute bottom-3 left-3 px-2 py-1 rounded bg-red-600 text-white text-xs shadow",children:j})]})})}function Pn({onClose:a,onCreate:s}){const[l,d]=r.useState(""),[p,h]=r.useState(""),[f,S]=r.useState(0),[j,I]=r.useState(!1),[D,P]=r.useState(""),L=async A=>{if(A.preventDefault(),P(""),!l.trim()||!p.trim()){P("Ort und Name sind erforderlich.");return}try{I(!0),await s({ort:l.trim(),label:p.trim(),mannschaft:Number(f)||0}),a()}catch(F){P(F?.message||"Speichern fehlgeschlagen.")}finally{I(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:e.jsxs("form",{onSubmit:L,className:"bg-white rounded-xl shadow-lg p-4 w-[360px] space-y-3",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Einheit anlegen"}),D&&e.jsx("div",{className:"text-sm text-red-600",children:D}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Ort"}),e.jsx("input",{className:"border rounded px-2 py-1 w-full",value:l,onChange:A=>d(A.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Name"}),e.jsx("input",{className:"border rounded px-2 py-1 w-full",value:p,onChange:A=>h(A.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Mannschaft"}),e.jsx("input",{type:"number",min:"0",className:"border rounded px-2 py-1 w-24",value:f,onChange:A=>S(A.target.value)})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:a,className:"px-3 py-1 rounded border",disabled:j,children:"Abbrechen"}),e.jsx("button",{type:"submit",className:"px-3 py-1 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:j,children:j?"Anlegen…":"Anlegen"})]})]})})}let $e=null;function jt(){const a=document.querySelector('meta[name="google-places-key"]');return(window.GMAPS_API_KEY||a?.content||"").trim()||""}async function An(a=jt()){if(window.google?.maps?.places)return!0;if(!a)return!1;if($e)return await $e,!!window.google?.maps?.places;$e=new Promise((s,l)=>{if(document.getElementById("gmap-places")){const p=()=>{window.google?.maps?.places?s(!0):setTimeout(p,150)};p();return}const d=document.createElement("script");d.id="gmap-places",d.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(a)}&libraries=places&language=de`,d.async=!0,d.defer=!0,d.onload=()=>s(!!window.google?.maps?.places),d.onerror=p=>l(p),document.head.appendChild(d)});try{await $e}catch{}return!!window.google?.maps?.places}function St({debounceMs:a=300,country:s="at",minLength:l=3}={}){const[d,p]=r.useState(""),[h,f]=r.useState([]),[S,j]=r.useState(!1),[I,D]=r.useState(!1),[P,L]=r.useState(null),A=r.useRef(null),F=r.useRef(null),J=r.useRef(null),ee=r.useRef(null);r.useEffect(()=>{let T=!1;return(async()=>{const q=await An(jt());T||!q||!window.google?.maps?.places||(A.current=new google.maps.places.AutocompleteService,F.current=new google.maps.places.PlacesService(document.createElement("div")),J.current=new google.maps.places.AutocompleteSessionToken,T||D(!0))})(),()=>{T=!0}},[]);const K=r.useCallback(()=>{window.google?.maps?.places&&(J.current=new google.maps.places.AutocompleteSessionToken)},[]),B=r.useRef();r.useEffect(()=>{B.current||(B.current=(T,q)=>{let H;return(...w)=>{clearTimeout(H),H=setTimeout(()=>T(...w),q)}})},[]);const N=r.useCallback(async T=>{if(!I||!A.current)return;const q=(T||"").trim();if(!q||q.length<l){f([]);return}j(!0),L(null),A.current.getPlacePredictions({input:q,sessionToken:J.current,componentRestrictions:{country:s},types:["address"]},(H,w)=>{if(j(!1),w!==google.maps.places.PlacesServiceStatus.OK||!H){f([]),w&&w!=="ZERO_RESULTS"&&L(w);return}f(H)})},[s,l,I]),V=r.useMemo(()=>B.current?B.current(N,a):()=>{},[N,a]);r.useEffect(()=>{V(d)},[d,V]);const O=r.useCallback((T,q=["formatted_address","geometry","address_components"])=>new Promise((H,w)=>{if(!I||!F.current){w(new Error("Google Places nicht bereit"));return}F.current.getDetails({placeId:T,fields:q,sessionToken:J.current},(ae,R)=>{if(R!==google.maps.places.PlacesServiceStatus.OK||!ae)return w(new Error(R||"DETAILS_FAILED"));H(ae)})}),[I]);return{ready:I,query:d,setQuery:p,predictions:h,loading:S,error:P,resetSession:K,getDetailsByPlaceId:O,inputElRef:ee}}function Tn({onClose:a,onCreate:s,types:l}){const[d,p]=r.useState(""),[h,f]=r.useState(""),[S,j]=r.useState(!1),I=r.useRef(null),{query:D,setQuery:P,predictions:L,getDetailsByPlaceId:A,resetSession:F,loading:J,error:ee}=St({country:"at",debounceMs:300,minLength:3});r.useEffect(()=>{setTimeout(()=>I.current?.focus(),0)},[]),r.useEffect(()=>{const N=(h||"").replace(/^T\d+\s*,?\s*/i,"").trim();!d.trim()&&N&&p(N)},[h]);const K=async N=>{N?.preventDefault?.();const V=(h||"").replace(/^T\d+\s*,?\s*/i,"").trim(),O=(d||V).trim();if(O){j(!0);try{await s({title:O,ort:(D||"").trim(),typ:(h||"").trim()}),p(""),P(""),f(""),F(),a?.()}finally{j(!1)}}},B=async N=>{try{const O=(await A(N.place_id,["formatted_address","geometry","address_components","place_id"]))?.formatted_address||N.description;P(O)}catch{P(N.description)}finally{F()}};return e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-3",children:e.jsxs("form",{onSubmit:K,className:"bg-white rounded-xl shadow-lg w-[520px] max-w-full p-4 space-y-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Einsatz anlegen"}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs("select",{ref:I,className:"border rounded px-2 py-1",value:h,onChange:N=>f(N.target.value),children:[e.jsx("option",{value:"",children:"— Typ auswählen —"}),l.map(N=>e.jsx("option",{value:N,children:N},N))]}),e.jsx("input",{className:"border rounded px-2 py-1",placeholder:"Titel (wird aus Typ übernommen)",value:d,onChange:N=>p(N.target.value)}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{className:"border rounded px-2 py-1 w-full",placeholder:"Ort (nur Österreich)",autoComplete:"off",value:D,onChange:N=>P(N.target.value)}),J&&e.jsx("div",{className:"absolute z-10 mt-1 text-xs text-gray-500 bg-white border rounded px-2 py-1",children:"Suche…"}),ee&&e.jsxs("div",{className:"absolute z-10 mt-1 text-xs text-red-600 bg-white border rounded px-2 py-1",children:["Fehler: ",String(ee)]}),!!L.length&&e.jsx("ul",{className:"absolute z-10 mt-1 w-full max-h-52 overflow-auto bg-white border rounded shadow",children:L.map(N=>e.jsx("li",{className:"px-2 py-1 hover:bg-gray-100 cursor-pointer text-sm",onClick:()=>B(N),title:N.description,children:N.description},N.place_id))})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:a,className:"px-3 py-1 rounded border",disabled:S,children:"Abbrechen"}),e.jsx("button",{className:"px-3 py-1 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:S,children:S?"Anlegen…":"Anlegen"})]})]})})}function Mn({colId:a,title:s,bg:l,children:d}){const{setNodeRef:p,isOver:h}=rn({id:`col:${a}`,data:{type:"column",colId:a}});return e.jsxs("section",{ref:p,className:`${l} rounded-xl shadow p-3 h-full flex flex-col min-h-0 ${h?"outline outline-2 outline-blue-400":""}`,children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:s}),d]})}function $n({open:a,onClose:s,info:l={}}){if(!a)return null;const d=({label:S,value:j})=>e.jsxs("div",{className:"flex items-start gap-3 py-1",children:[e.jsx("div",{className:"w-32 shrink-0 text-gray-600",children:S}),e.jsx("div",{className:"flex-1 font-medium break-words",children:j??"—"})]}),p=l.timestamp?new Date(l.timestamp).toLocaleString("de-AT",{hour12:!1}):"—",h=[];l.location&&h.push(String(l.location)),Number.isFinite(l.latitude)&&Number.isFinite(l.longitude)&&h.push(`(${l.latitude}, ${l.longitude})`);const f=h.length?h.join(" "):void 0;return e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:s}),e.jsxs("div",{className:"relative z-[101] w-[min(92vw,640px)] rounded-xl bg-white shadow-xl p-4 md:p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg md:text-xl font-bold",children:"Einsatz-Info"}),e.jsx("button",{className:"h-8 w-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center",onClick:s,"aria-label":"Schließen",title:"Schließen",children:e.jsx("svg",{viewBox:"0 0 12 12",width:"14",height:"14","aria-hidden":"true",children:e.jsx("path",{d:"M1 1 L11 11 M11 1 L1 11",stroke:"black",strokeWidth:"2",strokeLinecap:"round"})})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(d,{label:"Typ",value:l.type||l.typ}),e.jsx(d,{label:"Alarmzeit",value:p}),e.jsx(d,{label:"Alarmiert",value:l.alerted}),e.jsx(d,{label:"Beschreibung",value:l.description}),e.jsx(d,{label:"Adresse",value:l.additionalAddressInfo||l.ort}),e.jsx(d,{label:"Location",value:f})]}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx("button",{className:"px-3 py-1.5 rounded-md bg-emerald-600 text-white hover:bg-emerald-700",onClick:s,children:"OK"})})]})]})}let Ge=localStorage.getItem("soundEnabled")==="1",ie=null;const xt=window.AudioContext||window.webkitAudioContext,Ve=xt?new xt:null;function kt(){ie||(ie=new Audio("/sounds/bahnhof.mp3"),ie.preload="auto");const a=async()=>{try{Ve&&Ve.state!=="running"&&await Ve.resume(),ie&&(ie.muted=!0,await ie.play(),ie.pause(),ie.currentTime=0,ie.muted=!1),Ge=!0,localStorage.setItem("soundEnabled","1"),window.removeEventListener("pointerdown",a),window.removeEventListener("keydown",a),window.dispatchEvent(new CustomEvent("sound:unlocked"))}catch{}};Ge||(window.addEventListener("pointerdown",a,{once:!0}),window.addEventListener("keydown",a,{once:!0}))}async function On(){if(ie||kt(),!Ge){window.dispatchEvent(new CustomEvent("sound:needsUnlock"));return}try{ie.currentTime=0,await ie.play()}catch{}}function Dn(a){const s=(a??"").toString();return s.length>30?s.slice(0,30)+"…":s}function Rn(){const[a,s]=r.useState([]),[l,d]=r.useState(!0);r.useEffect(()=>{(async()=>{try{const h=await fetch("/api/protocol").then(f=>f.json());s(Array.isArray(h?.items)?h.items:[])}catch{s([])}finally{d(!1)}})()},[]);const p=r.useMemo(()=>[...a].sort((h,f)=>(Number(f.nr)||0)-(Number(h.nr)||0)),[a]);return e.jsxs("div",{className:"p-3 md:p-4 max-w-[1400px] mx-auto h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-3",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:"Protokoll-Übersicht"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("a",{href:"/api/protocol/csv/file",className:"px-3 py-1.5 rounded-md border bg-white",title:"protocol.csv herunterladen",children:"CSV"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll/neu"},className:"px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white",children:"+ Eintrag anlegen"})]})]}),e.jsx("div",{className:"flex-1 overflow-auto border rounded-lg bg-white",children:l?e.jsx("div",{className:"p-4 text-gray-500",children:"Lade…"}):e.jsxs("table",{className:"min-w-[1100px] w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0 z-10",children:e.jsxs("tr",{className:"[&>th]:px-2 [&>th]:py-2 [&>th]:text-left [&>th]:font-semibold border-b",children:[e.jsx("th",{style:{width:28},title:"Druckstatus"}),e.jsx("th",{style:{width:60},children:"NR"}),e.jsx("th",{style:{width:110},children:"Datum"}),e.jsx("th",{style:{width:80},children:"Zeit"}),e.jsx("th",{style:{width:120},children:"Kanal"}),e.jsx("th",{style:{width:110},children:"Richtung"}),e.jsx("th",{style:{width:160},children:"An/Von"}),e.jsx("th",{children:"Information"}),e.jsx("th",{style:{width:260},children:"Meldungstyp"})]})}),e.jsxs("tbody",{className:"[&>tr>td]:px-2 [&>tr>td]:py-2",children:[p.map(h=>{const f=h?.uebermittlungsart||{},S=f.kanal??f.kanalNr??f.art??"",I=[].concat(f.ein?"Eingang":[]).concat(f.aus?"Ausgang":[]).join(" / "),D=Number(h?.printCount)>0;return e.jsxs("tr",{className:"border-b align-top hover:bg-gray-50 cursor-pointer",onClick:()=>{window.location.hash=`/protokoll/edit/${h.nr}`},title:"Zum Bearbeiten öffnen",children:[e.jsx("td",{className:"align-middle",children:D?e.jsx("span",{className:"inline-block w-3 h-3 rounded-full bg-yellow-400",title:`Gedruckt (${h.printCount})`}):null}),e.jsx("td",{className:"font-semibold",children:h.nr}),e.jsx("td",{children:h.datum}),e.jsx("td",{children:h.zeit}),e.jsx("td",{title:S,children:S}),e.jsx("td",{title:I,children:I}),e.jsx("td",{children:h.anvon}),e.jsx("td",{className:"whitespace-pre-wrap",children:Dn(h.information)}),e.jsx("td",{className:"whitespace-pre-wrap",children:h.infoTyp||"—"})]},h.nr)}),!p.length&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"p-4 text-gray-500 italic",children:"— keine Einträge —"})})]})]})})]})}const Ke=["EL","LtStb","S1","S2","S3","S4","S5","S6"],xe={anvon:"prot_sugg_anvon",kanal:"prot_sugg_kanalNr",verantwortlich:"prot_sugg_ver"};function Ue(a,s=12){const l=new Set,d=[];for(const p of a){const h=String(p||"").trim();if(!(!h||l.has(h))&&(l.add(h),d.push(h),d.length>=s))break}return d}function bt(a){let s=String(a||"").trim();if(!s)return s;const l=s.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})$/);if(l){const p=l[1].padStart(2,"0"),h=l[2].padStart(2,"0");return`${l[3].length===2?"20"+l[3]:l[3]}-${h}-${p}`}const d=s.match(/^(\d{1,2})(\d{1,2})(\d{2,4})$/);if(d){const p=d[1].padStart(2,"0"),h=d[2].padStart(2,"0");return`${d[3].length===2?"20"+d[3]:d[3].padStart(4,"20")}-${h}-${p}`}return s}function yt(a){let s=String(a||"").trim();if(!s)return s;const l=s.match(/^(\d{1,2})(\d{2})$/);if(l)return`${l[1].padStart(2,"0")}:${l[2]}`;const d=s.match(/^(\d{1,2})[:.](\d{1,2})$/);return d?`${d[1].padStart(2,"0")}:${d[2].padStart(2,"0")}`:s}const wt=()=>({datum:new Date().toISOString().slice(0,10),zeit:new Date().toTimeString().slice(0,5),uebermittlungsart:{richtung:"",kanalNr:""},anvon:{richtung:"an",name:""},infoTyp:"Information",information:"",rueckmeldung1:"",rueckmeldung2:"",ergehtAn:[],ergehtAnText:"",lagebericht:"",massnahmen:Array.from({length:5},()=>({massnahme:"",verantwortlich:"",done:!1}))});function vt({mode:a="create",editNr:s=null}){const[l,d]=r.useState(()=>{const n=Number(s);return Number.isFinite(n)&&n>0?n:null}),p=Number.isFinite(Number(l))&&Number(l)>0,[h,f]=r.useState(p),[S,j]=r.useState(!1),[I,D]=r.useState(null),P=r.useRef(null),L=r.useRef(null),A=r.useRef(!1),F=r.useRef(null),[J,ee]=r.useState(null),K=r.useRef(null),B=(n,i,m=2200)=>{ee({type:n,text:i}),K.current&&clearTimeout(K.current),K.current=setTimeout(()=>ee(null),m)},[N,V]=r.useState([]),[O,T]=r.useState([]),[q,H]=r.useState([]);r.useEffect(()=>{try{V(JSON.parse(localStorage.getItem(xe.anvon)||"[]")),T(JSON.parse(localStorage.getItem(xe.kanal)||"[]")),H(JSON.parse(localStorage.getItem(xe.verantwortlich)||"[]"))}catch{}},[]);const[w,ae]=r.useState(wt()),R=(n,i)=>{const m=Array.isArray(n)?n:String(n).split(".");ae(g=>{const C=structuredClone(g);let k=C;for(let z=0;z<m.length-1;z++)k=k[m[z]];return k[m.at(-1)]=i,C})};r.useEffect(()=>{if(!p){f(!1),setTimeout(()=>L.current?.focus(),0);return}const n=Number(l);!Number.isFinite(n)||n<=0||(async()=>{try{const i=await fetch(`/api/protocol/${n}`).then(m=>m.json());if(i?.ok&&i.item){const m=i.item,g=m.uebermittlungsart||{};let C="",k=m.anvon||"";const z=(m.anvon||"").trim();/^an\s*:/i.test(z)&&(C="an",k=z.replace(/^an\s*:/i,"").trim()),/^von\s*:/i.test(z)&&(C="von",k=z.replace(/^von\s*:/i,"").trim()),ae({datum:m.datum||"",zeit:m.zeit||"",uebermittlungsart:{richtung:g.ein?"ein":g.aus?"aus":"",kanalNr:g.kanalNr||""},anvon:{richtung:C||"an",name:k},infoTyp:m.infoTyp||"Information",information:m.information||"",rueckmeldung1:m.rueckmeldung1||"",rueckmeldung2:m.rueckmeldung2||"",ergehtAn:Array.isArray(m.ergehtAn)?m.ergehtAn:[],ergehtAnText:m.ergehtAnText||"",lagebericht:m.lagebericht||"",massnahmen:Array.from({length:5},(G,W)=>{const ue=m.massnahmen?.[W]||{};return{massnahme:ue.massnahme||"",verantwortlich:ue.verantwortlich||"",done:!!ue.done}})}),D(m.id||null),setTimeout(()=>L.current?.focus(),0)}}finally{f(!1)}})()},[p,l]),r.useEffect(()=>{const n=()=>{const g=document.activeElement;g&&typeof g.blur=="function"&&g.blur()},i=g=>setTimeout(g,0),m=g=>{if(g.repeat)return;const C=(g.key||"").toLowerCase(),k=g.ctrlKey||g.metaKey;if(k&&!g.shiftKey&&C==="s"){if(g.preventDefault(),g.stopPropagation(),A.current)return;A.current=!0,i(async()=>{n(),await new Promise(z=>setTimeout(z,0)),Z().finally(()=>A.current=!1)});return}if(k&&(g.shiftKey&&C==="s"||C==="enter")){if(g.preventDefault(),g.stopPropagation(),A.current)return;A.current=!0,i(async()=>{n(),await new Promise(z=>setTimeout(z,0)),Q().finally(()=>A.current=!1)});return}C==="escape"&&(g.preventDefault(),g.stopPropagation(),i(()=>b()))};return window.addEventListener("keydown",m,!0),document.addEventListener("keydown",m,!0),()=>{window.removeEventListener("keydown",m,!0),document.removeEventListener("keydown",m,!0)}},[]);const[pe,oe]=r.useState(!1),ce=r.useRef(null);function de(){const n=Array.isArray(w?.ergehtAn)?[...w.ergehtAn]:[],i=(w?.ergehtAnText||"").trim();return i&&n.push(i),n}const ye=async()=>{if(pe)return;const n=de();if(!n.length){B?.("error","Bitte Empfänger wählen oder 'Sonstiger Empfänger' ausfüllen.");return}oe(!0);try{const i=await $();if(!i)throw new Error("Speichern fehlgeschlagen");d(i);const g=(await fetch(`/api/protocol/${i}`).then(W=>W.json()))?.item;if(!g)throw new Error("Datensatz für Druck nicht gefunden");B?.("info","PDF wird serverseitig erzeugt …");const C=await fetch(`/api/protocol/${i}/print`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({recipients:n,data:g})}).then(W=>W.json());if(!C?.ok||!C?.fileUrl)throw new Error(C?.error||"PDF-Erzeugung fehlgeschlagen");let k=ce.current;k||(k=document.createElement("iframe"),k.style.position="fixed",k.style.width="0",k.style.height="0",k.style.border="0",k.style.visibility="hidden",document.body.appendChild(k),ce.current=k);const z=`${C.fileUrl}#toolbar=0&navpanes=0&scrollbar=0`;k.onload=()=>{try{setTimeout(()=>{k.contentWindow?.focus(),k.contentWindow?.print()},100)}catch{window.open(z,"_blank","noopener,noreferrer")?.focus()}},k.src=z;const G=Number(C?.pages)||n.length;B?.("success",`Druck gestartet (${G} Seite${G>1?"n":""})`)}catch(i){B?.("error",`Drucken fehlgeschlagen: ${i.message||i}`)}finally{oe(!1)}},b=()=>{window.location.hash="/protokoll"},$=async()=>{const n=F.current?new FormData(F.current):null,i=structuredClone(w);i.datum=bt(n?.get("datum")||w.datum),i.zeit=yt(n?.get("zeit")||w.zeit);const m=(n?.get("anvonDir")||w.anvon.richtung||"").toString(),g=(n?.get("anvonName")||w.anvon.name||"").toString();i.anvon={richtung:m,name:g};const C=(n?.get("richtung")||w.uebermittlungsart.richtung||"").toString();i.uebermittlungsart.richtung=C,i.uebermittlungsart.kanalNr=(n?.get("kanalNr")||w.uebermittlungsart.kanalNr||"").toString(),i.information=(n?.get("information")||w.information||"").toString(),i.rueckmeldung1=(n?.get("rueckmeldung1")||w.rueckmeldung1||"").toString(),i.rueckmeldung2=(n?.get("rueckmeldung2")||w.rueckmeldung2||"").toString(),i.ergehtAnText=(n?.get("ergehtAnText")||w.ergehtAnText||"").toString(),i.infoTyp=(n?.get("infoTyp")||w.infoTyp||"Information").toString();const k=n?Array.from(n.getAll("ergehtAn")).map(String):w.ergehtAn;i.ergehtAn=k.length?k:w.ergehtAn,i.massnahmen=i.massnahmen.map((G,W)=>{const ue=n?n.get(`m_done_${W}`)!==null:G.done;return{massnahme:(n?.get(`m_massnahme_${W}`)||G.massnahme||"").toString(),verantwortlich:(n?.get(`m_verantwortlich_${W}`)||G.verantwortlich||"").toString(),done:!!ue}});const z={...i,uebermittlungsart:{kanalNr:(i.uebermittlungsart.kanalNr||"").trim(),ein:i.uebermittlungsart.richtung==="ein",aus:i.uebermittlungsart.richtung==="aus"},anvon:i.anvon.richtung?`${i.anvon.richtung==="an"?"An":"Von"}: ${i.anvon.name}`.trim():i.anvon.name.trim()};try{const G=Ue([z.anvon,...JSON.parse(localStorage.getItem(xe.anvon)||"[]")]),W=Ue([z.uebermittlungsart.kanalNr,...JSON.parse(localStorage.getItem(xe.kanal)||"[]")]),ue=[...i.massnahmen.map(Se=>Se.verantwortlich).filter(Boolean),...JSON.parse(localStorage.getItem(xe.verantwortlich)||"[]")],fe=Ue(ue);localStorage.setItem(xe.anvon,JSON.stringify(G)),localStorage.setItem(xe.kanal,JSON.stringify(W)),localStorage.setItem(xe.verantwortlich,JSON.stringify(fe)),V(G),T(W),H(fe)}catch{}if(p){const G=await fetch(`/api/protocol/${l}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(z)}).then(W=>W.json());if(!G?.ok)throw new Error(G?.error||"Speichern fehlgeschlagen");return d(G.nr),D(G.id||I||null),G.nr}else{const G=await fetch("/api/protocol",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(z)}).then(W=>W.json());if(!G?.ok)throw new Error(G?.error||"Speichern fehlgeschlagen");return d(G.nr),D(G.id||null),G.nr}},Z=async()=>{if(!S){j(!0);try{await $()&&(window.location.hash="/protokoll")}catch(n){B("error","Fehler beim Speichern: "+n.message,4e3)}finally{j(!1)}}},Q=async()=>{if(!S){j(!0);try{const n=await $();n&&(B("success",`Gespeichert (NR ${n}) – neuer Eintrag`),ae(wt()),d(null),D(null),setTimeout(()=>L.current?.focus(),0))}catch(n){B("error","Fehler beim Speichern: "+n.message,4e3)}finally{j(!1)}}},U=n=>{const i=(n.key||"").toLowerCase(),m=n.ctrlKey||n.metaKey;n.repeat||(m&&!n.shiftKey&&i==="s"?(n.preventDefault(),n.stopPropagation(),Z()):m&&(n.shiftKey&&i==="s"||i==="enter")&&(n.preventDefault(),n.stopPropagation(),Q()))},x=n=>{n.preventDefault(),Z()};if(h)return e.jsx("div",{className:"p-4",children:"Lade…"});const _=Ke.every(n=>w.ergehtAn.includes(n)),te=n=>R("ergehtAn",n?[...Ke]:[]);return e.jsxs("div",{className:"mx-auto w-full max-w-[1100px] relative",children:[e.jsx("div",{className:"prot-actionbar sticky top-0 z-30 -mx-2 md:mx-0 px-2 md:px-0",children:e.jsxs("div",{className:"bg-white/95 backdrop-blur border-b rounded-t-xl px-3 py-2 flex items-center justify-between shadow-sm",children:[e.jsx("div",{className:"text-sm font-semibold",children:p?`Protokoll – Bearbeiten (NR ${l??"—"})`:"Protokoll – Neuer Eintrag"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:b,className:"px-3 py-1.5 rounded-md border",title:"Maske schließen und zur Übersicht wechseln (ESC)",children:"Abbrechen"}),e.jsx("button",{type:"button",onClick:Q,disabled:S,className:"px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white disabled:opacity-60",title:"Speichern und neue Maske (Strg+Shift+S oder Strg+Enter)",children:"Speichern/Neu"}),e.jsx("button",{type:"button",onClick:Z,disabled:S,className:"px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-60",title:"Speichern und schließen (Strg+S)",children:S?"Speichern…":"Speichern"}),e.jsx("button",{type:"button",onClick:ye,disabled:pe,className:"px-3 py-1.5 rounded-md border bg-white hover:bg-gray-50 disabled:opacity-60",title:"Formular drucken – Anzahl gemäß 'ergeht an' + 'Sonstiger Empfänger'",children:pe?"Drucken…":"Drucken"})]})]})}),J&&e.jsx("div",{className:"fixed right-3 top-3 z-40",children:e.jsx("div",{className:"px-3 py-2 rounded shadow text-white "+(J.type==="success"?"bg-emerald-600":J.type==="error"?"bg-rose-600":"bg-slate-600"),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{children:J.text}),e.jsx("button",{className:"opacity-80 hover:opacity-100",onClick:()=>ee(null),title:"Meldung schließen",children:"✕"})]})})}),e.jsx("style",{children:`
        @media print {
          * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          .prot-actionbar { display: none !important; }
          html, body { margin: 0 !important; }
          @page { size: A4; margin: 12mm; }
        }
      `}),e.jsxs("form",{ref:F,onKeyDown:U,onSubmit:x,className:"bg-white border-2 rounded-b-xl overflow-hidden shadow",children:[e.jsxs("div",{className:"grid grid-cols-12",children:[e.jsx("div",{className:"col-span-9 p-6 border-b-2",children:e.jsx("div",{className:"text-3xl font-extrabold tracking-wide",children:"MELDUNG/INFORMATION"})}),e.jsxs("div",{className:"col-span-3 border-l-2",children:[e.jsx("div",{className:"p-3 text-xs text-gray-600 border-b-2",children:"PROTOKOLL-NR"}),e.jsx("div",{className:"p-6 text-center text-4xl font-bold",children:l??"—"})]}),e.jsx("div",{className:"col-span-12 border-y-2 p-2",children:e.jsxs("div",{className:"grid grid-cols-12 gap-0",children:[e.jsxs("div",{className:"col-span-6 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Datum"}),e.jsx("input",{name:"datum",type:"text",className:"border rounded px-2 h-9 w-full",placeholder:"yyyy-mm-dd",value:w.datum,onChange:n=>R("datum",n.target.value),onBlur:n=>R("datum",bt(n.target.value)),title:"Datum (auch 101025 oder 10.10.2025 möglich)"})]}),e.jsxs("div",{className:"col-span-3 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Uhrzeit"}),e.jsx("input",{name:"zeit",type:"text",className:"border rounded px-2 h-9 w-full",placeholder:"hh:mm",value:w.zeit,onChange:n=>R("zeit",n.target.value),onBlur:n=>R("zeit",yt(n.target.value)),title:"Uhrzeit (915, 09:15 oder 0915 möglich)"})]}),e.jsxs("div",{className:"col-span-3 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Typ"}),e.jsxs("div",{className:"grid grid-cols-3 gap-x-6 h-9 items-center",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{ref:L,type:"radio",name:"infoTyp",value:"Information",checked:w.infoTyp==="Information",onChange:()=>R("infoTyp","Information")}),e.jsx("span",{children:"Info"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"infoTyp",value:"Auftrag",checked:w.infoTyp==="Auftrag",onChange:()=>R("infoTyp","Auftrag")}),e.jsx("span",{children:"Auftrag"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"infoTyp",value:"Lagemeldung",checked:w.infoTyp==="Lagemeldung",onChange:()=>R("infoTyp","Lagemeldung")}),e.jsx("span",{children:"Lage"})]})]})]})]})}),e.jsx("div",{className:"col-span-12 border-y-2 p-2",children:e.jsxs("div",{className:"grid grid-cols-12 gap-0 items-end",children:[e.jsxs("div",{className:"col-span-6 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"An/Von"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{ref:P,name:"anvonName",className:"border rounded px-2 h-9 w-full flex-1",placeholder:"Name / Stelle",list:"dl-anvon",value:w.anvon.name,onChange:n=>{let i=n.target.value;const m=i.trim();/^an\s*:/i.test(m)?(R(["anvon","richtung"],"an"),i=m.replace(/^an\s*:/i,"").trim()):/^von\s*:/i.test(m)&&(R(["anvon","richtung"],"von"),i=m.replace(/^von\s*:/i,"").trim()),R(["anvon","name"],i)},title:'Optional mit Präfix "an: …" oder "von: …"'}),e.jsxs("div",{className:"flex items-center gap-4 pl-2 min-w-[140px] shrink-0",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"anvonDir",value:"an",checked:w.anvon.richtung==="an",onChange:()=>R(["anvon","richtung"],"an")}),e.jsx("span",{children:"An"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"anvonDir",value:"von",checked:w.anvon.richtung==="von",onChange:()=>R(["anvon","richtung"],"von")}),e.jsx("span",{children:"Von"})]})]})]}),e.jsx("datalist",{id:"dl-anvon",children:N.map(n=>e.jsx("option",{value:n},n))})]}),e.jsxs("div",{className:"col-span-3 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Kanal"}),e.jsx("input",{name:"kanalNr",className:"border rounded px-2 h-9 w-full",list:"dl-kanal",value:w.uebermittlungsart.kanalNr,onChange:n=>R(["uebermittlungsart","kanalNr"],n.target.value),title:"z. B. Funkkanal, Telefonnummer, E-Mail-Kürzel …"}),e.jsx("datalist",{id:"dl-kanal",children:O.map(n=>e.jsx("option",{value:n},n))})]}),e.jsxs("div",{className:"col-span-3 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Richtung"}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-6 h-9 items-center",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",title:"Meldung wurde empfangen",children:[e.jsx("input",{type:"radio",name:"richtung",value:"ein",checked:w.uebermittlungsart.richtung==="ein",onChange:()=>R(["uebermittlungsart","richtung"],"ein")}),e.jsx("span",{children:"Eingang"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",title:"Meldung wurde gesendet",children:[e.jsx("input",{type:"radio",name:"richtung",value:"aus",checked:w.uebermittlungsart.richtung==="aus",onChange:()=>R(["uebermittlungsart","richtung"],"aus")}),e.jsx("span",{children:"Ausgang"})]})]})]})]})}),e.jsxs("div",{className:"col-span-12 border-y-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Information/Auftrag"}),e.jsx("textarea",{name:"information",className:"border rounded px-2 py-2 w-full min-h-[160px]",value:w.information,onChange:n=>R("information",n.target.value),title:"Sachverhalt / Meldetext"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Rückmeldung 1"}),e.jsx("input",{name:"rueckmeldung1",className:"border rounded px-2 h-9 w-full",value:w.rueckmeldung1,onChange:n=>R("rueckmeldung1",n.target.value),title:"erste Rückmeldung"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Rückmeldung 2"}),e.jsx("input",{name:"rueckmeldung2",className:"border rounded px-2 h-9 w-full",value:w.rueckmeldung2,onChange:n=>R("rueckmeldung2",n.target.value),title:"zweite Rückmeldung"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-2",children:"ergeht an:"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 mr-3",title:"Alle Empfänger auswählen / abwählen",children:[e.jsx("input",{type:"checkbox",checked:_,onChange:n=>te(n.target.checked)}),e.jsx("span",{children:"Alle"})]}),Ke.map(n=>e.jsxs("label",{className:"inline-flex items-center gap-2 mr-3",children:[e.jsx("input",{tabIndex:-1,type:"checkbox",name:"ergehtAn",value:n,checked:w.ergehtAn.includes(n),onChange:()=>{const i=new Set(w.ergehtAn);i.has(n)?i.delete(n):i.add(n),R("ergehtAn",[...i])},title:`Empfänger ${n} ${w.ergehtAn.includes(n)?"entfernen":"hinzufügen"}`}),e.jsx("span",{children:n})]},n)),e.jsx("span",{className:"ml-2 text-xs text-gray-600",children:"sonstiger Empfänger:"}),e.jsx("input",{name:"ergehtAnText",className:"border rounded px-2 h-9",value:w.ergehtAnText,onChange:n=>R("ergehtAnText",n.target.value),placeholder:"Name/Gruppe"})]})]}),e.jsxs("div",{className:"col-span-12 border-t-2",children:[e.jsxs("div",{className:"grid grid-cols-12 bg-gray-50 border-b-2",children:[e.jsx("div",{className:"col-span-6 p-2 font-semibold border-r",children:"Maßnahme"}),e.jsx("div",{className:"col-span-5 p-2 font-semibold border-r",children:"Verantwortlich"}),e.jsx("div",{className:"col-span-1 p-2 font-semibold text-center",children:"Erledigt"})]}),w.massnahmen.map((n,i)=>e.jsxs("div",{className:"grid grid-cols-12 border-t",children:[e.jsx("div",{className:"col-span-6 p-2 border-r",children:e.jsx("input",{name:`m_massnahme_${i}`,className:"w-full border rounded px-2 h-9",value:n.massnahme,onChange:m=>{const g=[...w.massnahmen];g[i]={...n,massnahme:m.target.value},R("massnahmen",g)},title:`Maßnahme ${i+1}`})}),e.jsx("div",{className:"col-span-5 p-2 border-r",children:e.jsx("input",{name:`m_verantwortlich_${i}`,className:"w-full border rounded px-2 h-9",list:"dl-ver",value:n.verantwortlich,onChange:m=>{const g=[...w.massnahmen];g[i]={...n,verantwortlich:m.target.value},R("massnahmen",g)},title:`Verantwortlich ${i+1}`})}),e.jsx("div",{className:"col-span-1 p-2 flex items-center justify-center",children:e.jsx("input",{tabIndex:-1,type:"checkbox",name:`m_done_${i}`,value:"1",checked:!!n.done,onChange:m=>{const g=[...w.massnahmen];g[i]={...n,done:m.target.checked},R("massnahmen",g)},title:"Erledigt umschalten"})})]},i)),e.jsx("datalist",{id:"dl-ver",children:q.map(n=>e.jsx("option",{value:n},n))})]})]}),e.jsx("button",{type:"submit",className:"hidden",children:"submit"})]})]})}function Ln(){const[a,s]=r.useState(!1),[l,d]=r.useState(!1),[p,h]=r.useState(""),[f,S]=r.useState({remainingMin:null,idleMinutes:null,lastActivityIso:null,autoStopMin:null}),[j,I]=r.useState({lastLoadedIso:null,file:"list_filtered.json"}),[D,P]=r.useState(!1),[L,A]=r.useState(30),[F,J]=r.useState(null),ee=r.useRef(!1),K=async()=>{try{const[B,N,V]=await Promise.all([fetch("/api/ff/status",{credentials:"include",cache:"no-store"}).then(O=>O.json()).catch(()=>({running:!1})),fetch("/api/ff/creds",{credentials:"include",cache:"no-store"}).then(O=>O.json()).catch(()=>({has:!1})),fetch("/api/import/auto-config",{credentials:"include",cache:"no-store"}).then(O=>O.json()).catch(()=>({enabled:!1,intervalSec:30}))]);s(!!B.running),d(!!N.has),P(!!V.enabled),A(Number(V.intervalSec||30)),ee.current||(ee.current=!0,N.has||h("Keine globalen Fetcher-Zugangsdaten. Bitte als Admin unter /user-admin setzen."))}catch{}};return r.useEffect(()=>{K();const B=setInterval(K,3e3);return()=>clearInterval(B)},[]),r.useEffect(()=>{let B;const N=async()=>{try{const V=await fetch("/api/activity/status",{credentials:"include",cache:"no-store"});if(V.ok){const O=await V.json(),T=Number(O.idleMinutes),q=Number(O.autoStopMin),H=Math.max(0,Math.ceil(q-T));S({remainingMin:H,idleMinutes:T,lastActivityIso:O.lastActivityIso,autoStopMin:q}),s(!!O.fetcher?.running),I({lastLoadedIso:O.import?.lastLoadedIso??null,file:O.import?.file||"list_filtered.json"})}}catch{}};return N(),B=setInterval(N,1e3),()=>clearInterval(B)},[]),r.useEffect(()=>{let B;const N=()=>{if(!D||!j.lastLoadedIso){J(null);return}const O=new Date(j.lastLoadedIso).getTime()+L*1e3,T=Math.max(0,Math.ceil((O-Date.now())/1e3));J(T)};return N(),B=setInterval(N,1e3),()=>clearInterval(B)},[D,L,j.lastLoadedIso]),e.jsxs("div",{className:"flex items-center h-9 gap-2",style:{alignItems:"center"},children:[e.jsx("span",{className:`sync-chip ${D?"active":""}`,title:D?"Auto-Import Countdown":"Auto-Import ist deaktiviert",style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:"110px",minWidth:"110px",textAlign:"center"},children:D?`⟳ in ${F??"–"}s`:"⏸ manuell"}),p&&e.jsx("span",{style:{color:"#dc2626",fontSize:12,marginLeft:8},children:p}),a&&f.remainingMin!=null&&f.remainingMin<=15&&e.jsxs("div",{title:`Letzte Aktivität: ${f.lastActivityIso?new Date(f.lastActivityIso).toLocaleString():"–"} • Inaktiv: ${f.idleMinutes?.toFixed?.(1)} min • Limit: ${f.autoStopMin} min`,className:"ml-2 inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border "+(f.remainingMin<=5?"bg-red-50 text-red-700 border-red-300":f.remainingMin<=15?"bg-amber-50 text-amber-700 border-amber-300":"bg-blue-50 text-blue-700 border-blue-300"),children:[e.jsx("span",{className:"mr-2 h-2 w-2 rounded-full bg-current",style:{animation:"pulse 1.5s ease-in-out infinite"}}),e.jsxs("span",{children:["Auto-Import stoppt in ",e.jsxs("b",{children:[f.remainingMin," min"]})]})]}),e.jsx("div",{title:`Quelle: ${j.file}`,className:"ml-2 inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border bg-white text-gray-700",style:{borderColor:"#cbd5e1"},children:e.jsxs("span",{children:["Zuletzt geladen:"," ",e.jsx("b",{children:j.lastLoadedIso?new Date(j.lastLoadedIso).toLocaleTimeString("de-AT",{hour12:!1}):"–"})]})})]})}function _n(){const[a]=r.useState(.9);return a}const zn=a=>`card:${a}`,ve=!0;async function Fn(a){if(!a||!window.google?.maps?.Geocoder)return null;const s=new google.maps.Geocoder;return new Promise(l=>{s.geocode({address:a,region:"AT"},(d,p)=>{if(p==="OK"&&d&&d[0]){const h=d[0],f=h.geometry?.location;l({lat:f?.lat?.(),lng:f?.lng?.(),formatted:h.formatted_address||a})}else l(null)})})}function Vn(){_n();const[a,s]=r.useState(null),[l,d]=r.useState([]),[p,h]=r.useState([]),[f,S]=r.useState(""),[j,I]=r.useState(""),[D,P]=r.useState(""),[L,A]=r.useState(null),[F,J]=r.useState(null),[ee,K]=r.useState(""),[B,N]=r.useState(!1),[V,O]=r.useState(!1),[T,q]=r.useState(!1),[H,w]=r.useState(30),[ae,R]=r.useState(!1),[pe,oe]=r.useState(!1),[ce,de]=r.useState(!1),[ye,b]=r.useState(null),$=t=>{b(t),de(!0)},[Z,Q]=r.useState(window.location.hash);r.useEffect(()=>{const t=()=>Q(window.location.hash);return window.addEventListener("hashchange",t),()=>window.removeEventListener("hashchange",t)},[]);const U=Z.replace(/^#/,""),[x,_]=r.useState(()=>new Set),[te,n]=r.useState(0),i=r.useRef(0),m=r.useRef(new Set),[g,C]=r.useState(0);r.useEffect(()=>{document.title="Einsatzstellen-Übersicht-Feuerwehr",kt()},[]),r.useEffect(()=>{if(!T){C(0);return}const t=setInterval(()=>C(o=>o+1),1e3);return()=>clearInterval(t)},[ve,T]);const k=T?Math.max(0,H-g%Math.max(1,H)):0,{query:z,setQuery:G,predictions:W,getDetailsByPlaceId:ue,resetSession:fe,loading:Se,error:We}=St({country:"at",debounceMs:300,minLength:3}),Ee=r.useRef(null);r.useEffect(()=>{document.title="Einsatzstellen-Übersicht-Feuerwehr"},[]),r.useEffect(()=>{(async()=>{const[t,o,c]=await Promise.all([ne(),rt(),yn()]);s(t),d(o),h(Array.isArray(c)?c:[]);try{const u=await Nn();q(!!u.enabled),w(Number(u.intervalSec)||30),Pe.current=He(t)}catch{}C(0)})()},[ve]),r.useEffect(()=>{T&&(async()=>{try{(await fetch("/api/ff/status",{credentials:"include",cache:"no-store"}).then(o=>o.json()).catch(()=>({running:!1}))).running||await fetch("/api/ff/start",{method:"POST",credentials:"include"})}catch{}})()},[ve,T,H]),r.useEffect(()=>{I(z||"")},[z]),r.useEffect(()=>{let t;const o=Math.max(5,Math.min(60,T?8:15)),c=async()=>{try{const u=new Set(Pe.current),y=await ne();s(y),Ze({oldIds:u,newBoard:y,pulseMs:8e3})}catch{}t=setTimeout(c,o*1e3)};return t=setTimeout(c,o*1e3),()=>clearTimeout(t)},[ve,T]),r.useEffect(()=>{const t=o=>{o.altKey&&(o.key==="e"||o.key==="E")&&(o.preventDefault(),oe(!0),fe())};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[ve,fe]);const re=a??{columns:{neu:{items:[]},"in-bearbeitung":{items:[]},erledigt:{items:[]}}},It=10;function Ct(t){try{const o=t?.columns||{};return[(o.neu?.items||[]).length,(o["in-bearbeitung"]?.items||[]).length,(o.erledigt?.items||[]).length].some(u=>u>=It)}catch{return!1}}r.useEffect(()=>{const t=Ct(re);document.documentElement.classList.toggle("ui-dense",t)},[re]);const[Oe,Je]=r.useState(new Set),Pe=r.useRef(new Set);r.useEffect(()=>{if(!Oe.size)return;const t=setTimeout(()=>Je(new Set),9e3);return()=>clearTimeout(t)},[Oe]);function He(t){const o=new Set;if(!t?.columns)return o;for(const c of Object.keys(t.columns))for(const u of t.columns[c].items||[])o.add(String(u.id));return o}function Ze({oldIds:t,newBoard:o,pulseMs:c=8e3}){const u=Date.now(),y=He(o),v=new Set;for(const M of y)t.has(M)||v.add(M);const E=new Set([...v].filter(M=>!m.current.has(String(M))));for(const M of v)m.current.delete(String(M));if(E.size>0&&(Je(E),n(u+c),u>=i.current))try{On()}catch{}Pe.current=y}const[De,qe]=r.useState(!1),Et=async()=>{if(!De){qe(!0);try{const t=new Set(Pe.current),o=await fetch("/api/import/trigger",{method:"POST"});if(!o.ok){const u=await o.text().catch(()=>"");throw new Error(`Import fehlgeschlagen (HTTP ${o.status}) ${u}`)}const c=await ne();s(c),Ze({oldIds:t,newBoard:c,pulseMs:8e3}),C(0)}catch(t){alert(t.message||"Import fehlgeschlagen.")}finally{qe(!1)}}},[Pt,Qe]=r.useState(!1),At=t=>String(t).replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function Tt(t,o){const c=String(o).match(/^(.*?)-(\d+)$/),u=c?c[1]:String(o);let y=c?parseInt(c[2],10):1;for(const v of t){const E=String(v.label||"").match(new RegExp("^"+At(u)+"-(\\d+)$"));if(!E)continue;const M=parseInt(E[1],10);Number.isFinite(M)&&M>y&&(y=M)}return`${u}-${y+1}`}async function Mt(t,o){if(Pt)return;const c=we.get(t);if(c){Qe(!0);try{const u=Tt(l,c.label||c.id),y=await fetch("/api/vehicles",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ort:c.ort||"",label:u,mannschaft:0})}),v=await y.json().catch(()=>({}));if(!y.ok||v?.error)throw new Error(v?.error||"Clone fehlgeschlagen");const M=await(await fetch("/api/vehicles")).json();d(M);let X=v?.vehicle?.id;X||(X=M.find(be=>be.label===u&&be.ort===(c.ort||"")&&Number(be.mannschaft)===0)?.id),o&&X&&await Be(o,X),s(await ne())}catch(u){alert(u.message||"Clone fehlgeschlagen")}finally{Qe(!1)}}}const we=r.useMemo(()=>new Map(l.map(t=>[t.id,t])),[l]),[Ye,Xe]=r.useState(new Map),$t=r.useMemo(()=>{const t={};for(const[o,c]of we.entries())t[o]=c;return t},[we]),et=r.useMemo(()=>{const t=new Set,o=re?.columns||{};for(const c of Object.keys(o))for(const u of o[c].items||[])for(const y of u.assignedVehicles||[])t.add(y);return t},[re]),Ne=r.useMemo(()=>l.filter(t=>t&&typeof t.id<"u"&&!et.has(t.id)),[l,et]),me=r.useMemo(()=>{const t={};for(const o of Ne){const c=o.ort||"Unbekannt";(t[c]??=[]).push(o)}for(const o of Object.keys(t))t[o].sort((c,u)=>(c.label||c.id).localeCompare(u.label||u.id));return Object.entries(t).sort((o,c)=>o[0].localeCompare(c[0]))},[Ne]);r.useEffect(()=>{if(localStorage.getItem("ff_collapsed_groups")||!me.length)return;const o=me.map(([c])=>c);Ae(new Set(o)),localStorage.setItem("ff_collapsed_groups",JSON.stringify(o))},[ve,me]),r.useEffect(()=>{let t=setInterval(async()=>{try{const o=await fetch("/api/activity/status",{cache:"no-store"}).then(c=>c.json());typeof o?.auto?.enabled=="boolean"&&o.auto.enabled!==T&&q(!!o.auto.enabled)}catch{}},3e3);return()=>clearInterval(t)},[ve,T]);function Re(t,o){for(const c of["neu","in-bearbeitung","erledigt"])if((t.columns[c].items||[]).some(u=>u?.id===o))return c;return null}function Ot(t,o){for(const c of["neu","in-bearbeitung","erledigt"]){const u=(t.columns[c].items||[]).find(y=>y?.id===o);if(u)return u}return null}function Le(t){const o=re?.columns?.[t]?.items||[];if(t==="erledigt"){const y=o.reduce((E,M)=>E+(M.everVehicles?.length||0),0),v=o.reduce((E,M)=>E+(Number.isFinite(M?.everPersonnel)?M.everPersonnel:0),0);return{cards:o.length,units:y,persons:v}}const c=o.reduce((y,v)=>y+(v.assignedVehicles?.length||0),0),u=o.reduce((y,v)=>Number.isFinite(v?.manualPersonnel)?y+v.manualPersonnel:y+(v.assignedVehicles||[]).reduce((E,M)=>E+(we.get(M)?.mannschaft??0),0),0);return{cards:o.length,units:c,persons:u}}const Dt=Le("neu"),Rt=Le("in-bearbeitung"),Lt=Le("erledigt"),_t=async()=>{const t=D.replace(/^T\d+\s*,?\s*/i,"").trim(),o=(f||t).trim();if(!o){alert("Bitte Typ oder Titel angeben.");return}const c={id:`tmp-${Math.random().toString(36).slice(2,10)}`,content:o,createdAt:new Date().toISOString(),statusSince:new Date().toISOString(),assignedVehicles:[],everVehicles:[],everPersonnel:0,ort:(j||"").trim(),typ:D.trim()};N(!0),s(u=>{if(!u)return u;const y=structuredClone(u);return y.columns.neu.items.unshift(c),y});try{let u=null;const y=Ee.current;if(y?.geometry?.location?.lat&&y?.geometry?.location?.lng)u={lat:y.geometry.location.lat(),lng:y.geometry.location.lng()};else if(c.ort){const E=await Fn(c.ort);E&&(u={lat:E.lat,lng:E.lng})}const v=await it(o,"neu",0,c.ort,c.typ,u??void 0);i.current=Date.now(),v?.card?.id!=null&&m.current.add(String(v.card.id)),s(E=>{if(!E)return E;const M=structuredClone(E),X=M.columns.neu.items,je=X.findIndex(be=>be?.id===c.id);return je>=0?X[je]=v.card:X.unshift(v.card),M}),S(""),G(""),I(""),P(""),Ee.current=null,fe()}catch{s(u=>{if(!u)return u;const y=structuredClone(u);return y.columns.neu.items=y.columns.neu.items.filter(v=>v?.id!==c.id),y}),alert("Einsatz konnte nicht angelegt werden.")}finally{N(!1)}},zt=async t=>{try{const o=await ue(t.place_id,["formatted_address","geometry","address_components","place_id"]);Ee.current=o||null;const c=o?.formatted_address||t.description;G(c),I(c)}catch(o){console.error("Place details failed:",o),Ee.current=null,G(t.description),I(t.description)}finally{fe()}},_e=t=>String(t||"").split(/[;,\n]/).map(o=>o.trim()).filter(Boolean),le=t=>String(t||"").normalize?.("NFD").replace?.(new RegExp("\\p{Diacritic}","gu"),"").replace(/^\s*FF\s+/i,"").replace(/[._\-\/]+/g," ").replace(/\s+/g," ").toLowerCase().trim();function Ft(t,o,c,u){const y=_e(t?.alerted).map(le);if(y.length)for(const v of o){const E=y.some(X=>le(v?.ort)===X),M=y.some(X=>le(v?.label)===X);if(E||M){const X=String(v.id);c.add(X),u.has(X)||u.set(X,null)}}}async function Bt(t,o){if(!(o!=="neu"||!t?.id))try{const c=await Sn(t.id),u=new Set((c?.units||[]).map(Y=>String(Y.unitId)));if(t?.alerted){const Y=_e(t.alerted).map(le);for(const he of Ne){const ze=Y.some(Fe=>le(he.ort)===le(Fe)),Ie=Y.some(Fe=>le(he.label)===le(Fe));(ze||Ie)&&u.add(String(he.id))}}_(u),n(Date.now()+3e3);const y=new Map;for(const Y of c?.units||[]){const he=Number(Y?.distanceKm);y.set(String(Y.unitId),Number.isFinite(he)?he:null)}u.size===0&&t?.alerted&&Ft(t,Ne,u,y),Xe(y);const v=new Set((c?.units||[]).filter(Y=>!Y.assigned).map(Y=>String(Y.unitId))),E=new Set(Ne.map(Y=>String(Y.id))),M=new Set([...v,...[...u].filter(Y=>E.has(Y))]),X=_e(t?.alerted).map(le),je=new Set;if(X.length&&Ne.length>0)for(const[Y,he]of me){if(he.length===0)continue;X.some(Ie=>le(Y)===le(Ie))&&je.add(Y)}const be=[];for(const[Y,he]of me)(he.some(Ie=>M.has(String(Ie.id)))||je.has(Y))&&be.push(Y);Ut(be),clearTimeout(pulseTimerRef.current),pulseTimerRef.current=setTimeout(()=>{_(new Set),n(0),Xe(new Map)},3200)}catch(c){console.error("fetchNearby failed:",c)}}const[tt,Ae]=r.useState(()=>{try{const t=localStorage.getItem("ff_collapsed_groups");return new Set(t?JSON.parse(t):[])}catch{return new Set}}),Vt=t=>tt.has(t),Kt=(t,o)=>{Ae(c=>{const u=new Set(c);return o?u.add(t):u.delete(t),localStorage.setItem("ff_collapsed_groups",JSON.stringify([...u])),u})},Ut=(t=[])=>{Ae(()=>{const o=me.map(([u])=>u),c=new Set(o);for(const u of t)c.delete(u);return localStorage.setItem("ff_collapsed_groups",JSON.stringify([...c])),c})},Gt=(t=!0)=>{Ae(()=>{const o=me.map(([u])=>u),c=t?new Set(o):new Set;return localStorage.setItem("ff_collapsed_groups",JSON.stringify([...c])),c})},Wt=()=>{const t=me.map(([c])=>c),o=t.length>0&&t.every(c=>tt.has(c));Gt(!o)},[Te,nt]=r.useState(null),[Jt,ke]=r.useState(null),Ht=on(st(pn,{activationConstraint:{distance:4}}),st(gn,{activationConstraint:{delay:80,tolerance:6}})),Zt=t=>{const o=t?.over;if(!o){ke(null);return}const c=String(o.id||"");if(c.startsWith("col:"))ke(c.slice(4));else if(c.startsWith("card:")){const u=Re(re,c.slice(5));ke(u)}else ke(null)},qt=async t=>{ke(null);const{active:o,over:c}=t;if(nt(null),!o||!c)return;const u=String(o.id||""),y=String(c.id||"");if(u.startsWith("ass:")&&y.startsWith("card:")){const[,v,E]=u.split(":"),M=y.slice(5);if(v&&E&&M&&v!==M)try{await ot(v,E);try{await dt(E)}catch{}await Be(M,E),s(await ne())}catch{alert("Einheit konnte nicht umgehängt werden.")}return}if(u.startsWith("veh:")&&y.startsWith("card:")){try{await Be(y.slice(5),u.slice(4)),s(await ne())}catch{alert("Einheit konnte nicht zugewiesen werden.")}return}if(u.startsWith("card:")){const v=u.slice(5),E=Re(re,v);if(!E)return;if(y.startsWith("col:")){const M=y.slice(4);if(E!==M)try{await Me({cardId:v,from:E,to:M,toIndex:0}),s(await ne())}catch{alert("Statuswechsel konnte nicht gespeichert werden.")}return}if(y.startsWith("card:")){const M=Re(re,y.slice(5));if(M)try{await Me({cardId:v,from:E,to:M,toIndex:0}),s(await ne())}catch{alert("Statuswechsel konnte nicht gespeichert werden.")}}}},Qt=async()=>{if(confirm("Board wirklich zurücksetzen?")){O(!0);try{await vn(),s(await ne())}catch{alert("Reset fehlgeschlagen.")}finally{O(!1)}}},Yt=()=>window.open(jn(),"_blank","noopener,noreferrer"),Xt=async()=>{try{const t=await lt({enabled:!T,intervalSec:H});q(!!t.enabled),w(Number(t.intervalSec)||30),C(0)}catch{alert("Konnte Auto-Import nicht ändern.")}},en=async t=>{const o=Math.max(5,Math.min(3600,Number(t)||30));w(o);try{await lt({enabled:T,intervalSec:o}),C(0)}catch{}},tn=async({title:t,ort:o,typ:c})=>{const u=await it(t,"neu",0,o,c);i.current=Date.now(),u?.card?.id!=null&&m.current.add(String(u.card.id)),s(y=>{if(!y)return y;const v=structuredClone(y);return v.columns.neu.items.unshift(u.card),v})},nn=t=>{P(t);const o=t.replace(/^T\d+\s*,?\s*/i,"").trim();f.trim()||S(o)};if(U.startsWith("/protokoll/edit/")){const t=U.split("/")[3],o=Number(t);return e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Protokoll – Bearbeiten"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"Zur Übersicht"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(vt,{mode:"edit",editNr:o})})]})}return U.startsWith("/protokoll/neu")?e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Protokoll – Eintrag anlegen"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"Zur Übersicht"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(vt,{mode:"create"})})]}):U.startsWith("/protokoll")?e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Protokoll"}),e.jsx("button",{onClick:()=>{window.location.hash="/"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"← Zurück"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(Rn,{})})]}):e.jsxs("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden flex flex-col",style:{fontSize:"var(--ui-scale)"},children:[!a&&e.jsx("div",{className:"fixed inset-0 z-10 bg-black/10 backdrop-blur-sm flex items-center justify-center",children:e.jsx("div",{className:"px-4 py-2 rounded-lg bg-white shadow",children:"Lade…"})}),e.jsxs("header",{className:"flex flex-wrap items-center justify-between gap-2 mb-2",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:"Einsatzstellen-Übersicht-Feuerwehr"}),e.jsxs("div",{className:"toolbar flex flex-wrap items-center gap-2",children:[e.jsx("button",{onClick:Yt,className:"px-3 py-1.5 rounded-md bg-purple-600 hover:bg-purple-700 text-white",children:"PDF"}),e.jsx("button",{onClick:()=>window.open("/api/log.csv","_blank"),className:"px-3 py-1.5 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white",title:"log.csv herunterladen",children:"Log (CSV)"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-500 hover:bg-gray-600 text-white",children:"Protokoll"}),e.jsx("button",{onClick:Et,disabled:De,className:"px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-60",title:"Import sofort ausführen",children:De?"Import…":"Import"}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm px-2 py-1 rounded-md bg-white border",children:[e.jsx("input",{type:"checkbox",checked:T,onChange:Xt})," Auto-Import"]}),e.jsxs("label",{className:"interval-capsule flex items-center text-sm text-gray-700 bg-gray-50 border border-gray-300 rounded-md overflow-hidden",children:[e.jsx("span",{className:"pl-3 pr-2 select-none",children:"Intervall (s):"}),e.jsx("input",{type:"number",min:"5",max:"3600",value:H,onChange:t=>en(t.target.value),className:`h-9 w-20 bg-white border-0 rounded-none text-center text-gray-800 \r
               focus:outline-none focus:ring-0 focus:border-0`})]}),e.jsx(Ln,{autoEnabled:T,remaining:k}),e.jsx("button",{onClick:Qt,disabled:V,className:`px-3 py-1.5 rounded-md text-white ${V?"bg-gray-400":"bg-gray-700 hover:bg-gray-800"}`,children:V?"Reset…":"Reset"})]})]}),e.jsxs("section",{className:"mb-2 grid grid-cols-1 md:grid-cols-7 gap-2",children:[e.jsxs("select",{className:"border rounded px-2 py-1 md:col-span-2",value:D,onChange:t=>nn(t.target.value),children:[e.jsx("option",{value:"",children:"— Typ auswählen —"}),p.map(t=>e.jsx("option",{value:t,children:t},t))]}),e.jsx("input",{className:"border rounded px-2 py-1 md:col-span-2",placeholder:"Titel (wird aus Typ übernommen)",value:f,onChange:t=>S(t.target.value)}),e.jsxs("div",{className:"relative md:col-span-2",children:[e.jsx("input",{className:"border rounded px-2 py-1 w-full",placeholder:"Ort (nur Österreich)",autoComplete:"off",value:z,onChange:t=>G(t.target.value)}),Se&&e.jsx("div",{className:"absolute z-10 mt-1 text-xs text-gray-500 bg-white border rounded px-2 py-1",children:"Suche…"}),We&&e.jsxs("div",{className:"absolute z-10 mt-1 text-xs text-red-600 bg-white border rounded px-2 py-1",children:["Fehler: ",String(We)]}),!!W.length&&e.jsx("ul",{className:"absolute z-10 mt-1 w-full max-h-52 overflow-auto bg-white border rounded shadow",children:W.map(t=>e.jsx("li",{className:"px-2 py-1 hover:bg-gray-100 cursor-pointer text-sm",onClick:()=>zt(t),title:t.description,children:t.description},t.place_id))})]}),e.jsx("button",{className:"px-3 py-1 rounded bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60",disabled:B,onClick:_t,children:B?"Wird angelegt…":"Einsatz anlegen"})]}),e.jsxs(ln,{sensors:Ht,collisionDetection:t=>t?.active?.data?.current?.type==="vehicle"?cn(t):dn(t),onDragStart:t=>nt({type:t?.active?.data?.current?.type,id:t.active.id,data:t?.active?.data?.current}),onDragOver:Zt,onDragEnd:qt,children:[e.jsxs("main",{className:"grid grid-cols-1 md:[grid-template-columns:minmax(180px,220px)_repeat(3,minmax(0,1fr))] gap-2 min-h-0 flex-1 overflow-hidden",children:[e.jsxs("section",{className:"bg-white rounded-xl shadow p-3 h-full flex flex-col min-h-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-semibold",children:e.jsx("button",{type:"button",onClick:Wt,title:"Alle Gruppen auf/zu klappen",className:"underline decoration-dotted hover:opacity-80 focus:outline-none",children:"Einheiten (frei)"})}),e.jsx("button",{onClick:()=>R(!0),className:"px-2 py-1 text-sm rounded bg-emerald-600 text-white",children:"+ Einheit"})]}),e.jsxs("div",{className:"overflow-auto pr-1 flex-1 min-h-0 space-y-3",children:[me.length===0&&e.jsx("div",{className:"text-[0.85rem] text-gray-500 italic",children:"— alle Einheiten sind zugewiesen —"}),me.map(([t,o])=>{const c=Vt(t);return e.jsxs("div",{className:"border border-blue-400 rounded-md",children:[e.jsxs("button",{type:"button",onClick:()=>Kt(t,!c),className:"w-full flex items-center justify-between px-2 py-2 text-left",title:c?"aufklappen":"zuklappen",children:[e.jsx("span",{className:"text-xs font-semibold text-gray-700",children:t}),e.jsx("span",{className:"group-chip",children:o.length})]}),!c&&e.jsx("div",{className:"px-2 pb-2 grid grid-cols-1 gap-1.5",children:o.map(u=>e.jsx(xn,{vehicle:u,pillWidthPx:160,near:x.has(String(u.id))&&Date.now()<te,distKm:Ye.get(String(u.id))},u.id))})]},t)})]})]}),[{id:"neu",title:"Neu",bg:"bg-red-100",totals:Dt},{id:"in-bearbeitung",title:"In Bearbeitung",bg:"bg-yellow-100",totals:Rt},{id:"erledigt",title:"Erledigt",bg:"bg-green-100",totals:Lt}].map(({id:t,title:o,bg:c,totals:u})=>e.jsx("div",{className:Jt===t?"drag-over":"",children:e.jsx(Mn,{colId:t,bg:c,title:e.jsxs("span",{className:"column-header flex items-center justify-between",children:[e.jsx("span",{className:"font-semibold",children:o}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsxs("span",{className:"kpi-badge","data-variant":"units",children:["🚒 ",u.units]}),e.jsxs("span",{className:"kpi-badge","data-variant":"persons",children:["👥 ",u.persons]}),e.jsxs("span",{className:"kpi-badge","data-variant":"cards",children:["⬛ ",u.cards]})]})]}),children:e.jsx("ul",{className:"space-y-2 overflow-y-auto overflow-x-hidden pl-1 pr-2 py-2",style:{maxHeight:"calc(100vh - 260px)"},children:e.jsx(un,{items:(re.columns[t].items||[]).map(y=>zn(y.id)),strategy:mn,children:(re.columns[t].items||[]).map(y=>e.jsx(fn,{card:y,colId:t,vehiclesById:we,distById:Ye,pillWidthPx:160,pulse:Oe.has(String(y.id))&&Date.now()<te,onUnassign:async(v,E)=>{await ot(v,E);try{await dt(E)}catch{}s(await ne())},onOpenMap:v=>A({address:y.ort,card:y,board:re,vehiclesById:$t}),onAdvance:async v=>{t==="neu"?(await Me({cardId:v.id,from:"neu",to:"in-bearbeitung",toIndex:0}),s(await ne())):t==="in-bearbeitung"&&(await Me({cardId:v.id,from:"in-bearbeitung",to:"erledigt",toIndex:0}),s(await ne()))},onEditPersonnelStart:(v,E)=>{J({cardId:v.id}),K(E)},editing:F,editingValue:ee,setEditingValue:K,onEditPersonnelSave:async v=>{try{await wn(v.id,ee===""?null:Number(ee)),s(await ne())}finally{J(null),K("")}},onEditPersonnelCancel:()=>{J(null),K("")},onClone:Mt,onVehiclesIconClick:Bt,nearIds:x,nearUntilMs:te,onShowInfo:$},y.id))})})})},t))]}),e.jsxs(hn,{dropAnimation:{duration:180,easing:"ease-out"},children:[Te?.type==="vehicle"&&(()=>{const t=we.get(Te?.data?.vehicleId);return t?e.jsx("div",{className:"pointer-events-none",children:e.jsxs("div",{style:{width:160},className:"max-w-full select-none border-2 border-red-300 rounded-2xl bg-white px-2 py-1 shadow-lg",children:[e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:t.label||t.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate",children:[t.ort||"—"," · 👥 ",t.mannschaft??0]})]})}):null})(),Te?.type==="card"&&(()=>{const t=String(Te?.id||"").replace(/^card:/,""),o=Ot(re,t);return o?e.jsx("div",{className:"pointer-events-none w-[280px]",children:e.jsxs("div",{className:"rounded-lg bg-white shadow-xl border p-3",children:[e.jsx("div",{className:"font-semibold text-sm mb-1 truncate",children:o.content}),e.jsxs("div",{className:"text-xs text-gray-600",children:[o.assignedVehicles?.length||0," Einheiten •"," ","👥 ",Number.isFinite(o?.manualPersonnel)?o.manualPersonnel:(o.assignedVehicles||[]).reduce((c,u)=>c+(we.get(u)?.mannschaft??0),0)]})]})}):null})()]})]}),e.jsx("button",{className:"fab",title:"Einsatz anlegen",onClick:()=>oe(!0),children:"＋"}),e.jsx("a",{href:"/Hilfe.pdf",target:"_blank",rel:"noopener noreferrer",className:"fixed bottom-4 right-4 px-4 py-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-lg",children:"Hilfe"}),ae&&e.jsx(Pn,{onClose:()=>R(!1),onCreate:async t=>{const o=await fetch("/api/vehicles",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!o.ok){const c=await o.text().catch(()=>String(o.status));throw new Error(`HTTP ${o.status} ${c}`)}d(await rt())}}),pe&&e.jsx(Tn,{onClose:()=>oe(!1),onCreate:tn,types:p}),L&&e.jsx(En,{context:L,onClose:()=>A(null)}),e.jsx($n,{open:ce,info:ye||{},onClose:()=>{de(!1),b(null)}})]})}export{Vn as default};
