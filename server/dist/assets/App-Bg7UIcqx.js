import{u as Ct,j as e,r,a as mn,C as hn,b as gn,i as qe,c as Qe,d as pn,e as fn,f as xn,g as ct,D as bn,h as yn,k as wn,S as vn,v as jn,l as Nn,p as Sn,T as kn,P as Cn}from"./index-Cv_MSc3j.js";function dt({cardId:t,vehicle:a,pillWidthPx:i=160,onUnassign:l,onClone:m,near:g=!1,distKm:h=null,readonly:p=!1}){const S=`ass:${t}:${a.id}`,f=p?null:Ct({id:S,data:{type:"assigned",vehicleId:a.id,fromCardId:t}}),_=f?.attributes??{},P=f?.listeners??{},M=f?.setNodeRef??(()=>{}),R=f?.transform??null,v=f?.isDragging??!1,A={width:i,transform:R?`translate3d(${R.x}px, ${R.y}px, 0)`:void 0};return e.jsxs("div",{ref:M,style:A,..._,...P,className:`relative self-start border-2 rounded-2xl bg-white px-2 pr-9 py-1 shadow-sm
                  select-none cursor-grab active:cursor-grabbing
                  ${g?"border-emerald-500 ring-2 ring-emerald-300":"border-red-300"}
                  ${v?"opacity-50":""}`,title:"Ziehen: auf andere Karte verschieben Â· Doppelklick: klonen",onDoubleClick:()=>{p||m?.(a.id,t)},children:[g&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-0.5 rounded-2xl border-2 border-emerald-400/50 animate-ping"}),e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:a.label||a.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate flex justify-between items-center",children:[e.jsxs("span",{children:[a.ort||"â€”"," Â· ðŸ‘¥ ",a.mannschaft??0]}),g&&Number.isFinite(Number(h))&&e.jsxs("span",{className:"absolute top-1 right-8 text-[11px] tabular-nums text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded whitespace-nowrap",children:[Number(h)," Km"]})]}),!p&&e.jsx("button",{type:"button",onMouseDown:T=>T.stopPropagation(),onTouchStart:T=>T.stopPropagation(),onClick:T=>{T.stopPropagation(),l?.(t,a.id)},title:"Einheit entfernen",className:"absolute right-2 top-1/2 -translate-y-1/2 h-6 w-6 rounded-full bg-red-600 text-white shadow flex items-center justify-center","aria-label":"Einheit entfernen",children:e.jsx("svg",{viewBox:"0 0 12 12",width:"12",height:"12","aria-hidden":"true",children:e.jsx("path",{d:"M1 1 L11 11 M11 1 L1 11",stroke:"white",strokeWidth:"2",strokeLinecap:"round"})})})]})}function In(t){const{card:a,colId:i,vehiclesById:l,pillWidthPx:m=160,onUnassign:g,onOpenMap:h,onAdvance:p,onEditPersonnelStart:S,editing:f,editingValue:_,setEditingValue:P,onEditPersonnelSave:M,onEditPersonnelCancel:R,onClone:v,onVehiclesIconClick:A,onShowInfo:T,nearIds:z,nearUntilMs:q,distById:N,pulse:I,editable:H=!0}=t,[$,Z]=r.useState(i==="in-bearbeitung"),Y=r.useRef((a.assignedVehicles||[]).length),Q=r.useRef(null),ae=Date.now()<(q||0),w=H?mn({id:`card:${a.id}`,data:{type:"card",cardId:a.id}}):{attributes:{},listeners:{},setNodeRef:j=>{},transform:null,transition:null,isDragging:!1},{attributes:de,listeners:F,setNodeRef:oe,transform:he,transition:xe,isDragging:b}=w,K={transform:hn.Transform.toString(he),transition:xe,opacity:b?.8:1},te=i==="erledigt"?a.everVehicles?.length||0:a.assignedVehicles?.length||0,W=r.useMemo(()=>(a.assignedVehicles||[]).map(j=>l.get(j)).filter(Boolean),[a,l]),U=r.useMemo(()=>i==="erledigt"?Number.isFinite(a?.everPersonnel)?a.everPersonnel:0:Number.isFinite(a?.manualPersonnel)?a.manualPersonnel:W.reduce((j,D)=>j+(D?.mannschaft??0),0),[i,a,W]);r.useEffect(()=>{if(i!=="in-bearbeitung"||!ae)return;(a.assignedVehicles||[]).some(D=>z?.has(String(D)))&&Z(!0)},[i,ae,z,a.assignedVehicles]),r.useEffect(()=>{if(i!=="in-bearbeitung")return;const j=(a.assignedVehicles||[]).length,D=Y.current;j>D&&Z(!0),Y.current=j},[i,a.assignedVehicles]),r.useEffect(()=>{if(i==="in-bearbeitung"&&$&&Q.current)try{Q.current.scrollIntoView({behavior:"smooth",block:"nearest"})}catch{}},[i,$]);const X=()=>{i==="neu"?typeof A=="function"&&A(a,i):(i==="in-bearbeitung"||i==="erledigt")&&Z(j=>!j)},ee=()=>{H&&typeof S=="function"&&S(a,U)};return e.jsxs("li",{ref:oe,style:K,className:`relative rounded-lg bg-white shadow border transition mx-1
              ${I&&i==="neu"?"ring-2 ring-red-400/60":""}`,children:[I&&i==="neu"&&e.jsxs(e.Fragment,{children:[e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 rounded-lg bg-red-500/10 animate-pulse-inner"}),e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 rounded-lg animate-ping-safe"})]}),e.jsxs("div",{className:"p-3 select-none",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",...de,...F,children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-semibold text-sm leading-5 truncate",children:a.content}),!!a.ort&&e.jsx("button",{type:"button",onClick:()=>h?.(a.ort),className:"text-[12px] text-blue-700 hover:underline truncate",title:"Ort in Karte Ã¶ffnen",children:a.ort})]}),e.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[e.jsxs("button",{type:"button",title:i==="neu"?"Nahe Einheiten prÃ¼fen":"Einheiten auf-/zuklappen",className:"px-2 py-1 rounded text-[12px] border hover:bg-red-50 flex items-center gap-1",onPointerDown:j=>j.stopPropagation(),onClick:j=>{j.stopPropagation(),j.preventDefault(),X()},children:["ðŸš’ ",te,(i==="in-bearbeitung"||i==="erledigt")&&e.jsx("span",{children:$?"â–¾":"â–¸"})]}),e.jsxs("button",{type:"button",className:"px-2 py-1 rounded text-[12px] border bg-white hover:bg-gray-50",title:"Personalzahl bearbeiten",onPointerDown:j=>j.stopPropagation(),onClick:j=>{j.stopPropagation(),ee()},children:["ðŸ‘¥ ",U]}),H&&p&&e.jsx("button",{type:"button",onPointerDown:j=>j.stopPropagation(),onClick:j=>{j.stopPropagation(),p(a)},className:"ml-1 px-2 py-1 rounded text-[12px] border bg-white hover:bg-gray-50",title:"weiter",children:"âž”"})]})]}),i==="neu"&&!!W.length&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-1.5",children:W.map(j=>e.jsx(dt,{cardId:a.id,vehicle:j,pillWidthPx:m,onUnassign:g,onClone:v,near:!!z&&ae&&z.has(String(j.id)),readonly:!H,distKm:N?.get(String(j.id))??null},`ass-${a.id}-${j.id}`))}),i==="in-bearbeitung"&&$&&!!W.length&&e.jsx("div",{ref:Q,className:"mt-2 flex flex-wrap gap-1.5",children:W.map(j=>e.jsx(dt,{cardId:a.id,vehicle:j,pillWidthPx:m,onUnassign:g,onClone:v,near:!!z&&ae&&z.has(String(j.id)),readonly:!H,distKm:N?.get(String(j.id))??null},`ass-${a.id}-${j.id}`))}),i==="erledigt"&&$&&!!a.everVehicles?.length&&e.jsx("ul",{className:"mt-2 text-sm text-gray-700 list-disc list-inside space-y-1",children:a.everVehicles.map(j=>{const D=l.get(j),k=D?.label||D?.id||"Unbekannt",s=D?.ort?` (${D.ort})`:"";return e.jsxs("li",{children:[k,s]},j)})}),H&&f?.cardId===a.id&&e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("input",{type:"number",className:"w-20 border rounded px-2 py-1 text-sm",value:_,onChange:j=>P(j.target.value),placeholder:"Personen"}),e.jsx("button",{className:"px-2 py-1 text-sm rounded bg-emerald-600 text-white",onClick:()=>M(a),children:"Speichern"}),e.jsx("button",{className:"px-2 py-1 text-sm rounded bg-gray-200",onClick:R,children:"Abbrechen"})]}),e.jsxs("div",{className:"mt-2 flex justify-end gap-2",children:[e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Ort in Karte Ã¶ffnen",onPointerDown:j=>j.stopPropagation(),onClick:j=>{j.stopPropagation(),h?.(a.ort)},children:"Karte"}),e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Einsatz-Info",onPointerDown:j=>j.stopPropagation(),onClick:j=>{j.stopPropagation(),T?.(a)},children:"?"})]})]})]})}function En({vehicle:t,pillWidthPx:a=160,near:i=!1,distKm:l=null,editable:m=!0}){const g=`veh:${t.id}`,h=m?Ct({id:g,data:{type:"vehicle",vehicleId:t.id}}):null,p=h?.attributes??{},S=h?.listeners??{},f=h?.setNodeRef??(()=>{}),_=h?.transform??null,P=h?.isDragging??!1;return e.jsxs("div",{ref:f,style:{width:a,transform:_?`translate3d(${_.x}px, ${_.y}px, 0)`:void 0},...p,...S,className:`relative max-w-full select-none border-2 ${i?"border-emerald-500":"border-red-300"} rounded-2xl bg-white
                 px-2 py-1 shadow-sm cursor-grab active:cursor-grabbing
                 ${P?"opacity-50":""}`,children:[i&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-0.5 rounded-2xl border-2 border-emerald-400/50 animate-ping"}),e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:t.label||t.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate flex justify-between items-center",children:[e.jsxs("span",{children:[t.ort||"â€”"," Â· ðŸ‘¥ ",t.mannschaft??0]}),i&&Number.isFinite(Number(l))&&e.jsxs("span",{className:"absolute top-1 right-1 text-[11px] tabular-nums text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded whitespace-nowrap",children:[Number(l)," Km"]})]})]})}const Pn="";async function le(t,a,i){const l=await fetch(Pn+a,{method:t,headers:{"Content-Type":"application/json"},body:i===void 0?void 0:JSON.stringify(i),cache:"no-store",credentials:"include"});if(!l.ok)throw new Error(`HTTP ${l.status} ${await l.text().catch(()=>l.statusText)}`);return(l.headers.get("content-type")||"").includes("application/json")?l.json():l.text()}async function ie(){return le("GET","/api/board")}async function Ze(){return le("GET","/api/vehicles")}async function An(){try{return await le("GET","/api/types")}catch{return[]}}async function ut(t,a="neu",i=0,l="",m="",g={}){const h={title:t,columnId:a,toIndex:i,ort:l,typ:m};if(g&&typeof g=="object"){const{lat:p,lng:S,latitude:f,longitude:_,...P}=g;Number.isFinite(f)&&(h.latitude=Number(f)),Number.isFinite(_)&&(h.longitude=Number(_)),Number.isFinite(p)&&(h.latitude=Number(p)),Number.isFinite(S)&&(h.longitude=Number(S)),Object.assign(h,P)}return le("POST","/api/cards",h)}async function Re({cardId:t,from:a,to:i,toIndex:l=0}){return le("POST",`/api/cards/${encodeURIComponent(t)}/move`,{from:a,to:i,toIndex:l})}async function He(t,a){return le("POST",`/api/cards/${encodeURIComponent(t)}/assign`,{vehicleId:a})}async function mt(t,a){return le("POST",`/api/cards/${encodeURIComponent(t)}/unassign`,{vehicleId:a})}async function Mn(t,a){return le("PATCH",`/api/cards/${encodeURIComponent(t)}/personnel`,{manualPersonnel:a})}async function Tn(){return le("POST","/api/reset",{})}async function $n(){return le("GET","/api/import/auto-config")}async function ht({enabled:t,intervalSec:a}){return le("POST","/api/import/auto-config",{enabled:t,intervalSec:a})}function Dn(){return"/api/export/pdf"}async function Rn(t,a){const i=`cardId=${encodeURIComponent(t)}`,m=Number.isFinite(Number(a))&&Number(a)>0?`${i}&radiusKm=${encodeURIComponent(a)}`:i,g=await fetch(`/api/nearby?${m}`,{credentials:"same-origin",cache:"no-store"});if(!g.ok)throw new Error("fetchNearby failed");return g.json()}async function gt(t,a,i,l=null,m="manual"){return le("PATCH",`/api/vehicles/${encodeURIComponent(t)}/position`,{lat:Number(a),lng:Number(i),incidentId:l,source:m})}async function pt(t){return le("DELETE",`/api/vehicles/${encodeURIComponent(t)}/position`)}function Ln(t,a){const l=(a.lat-t.lat)*Math.PI/180,m=(a.lng-t.lng)*Math.PI/180,g=Math.sin(l/2)**2+Math.cos(t.lat*Math.PI/180)*Math.cos(a.lat*Math.PI/180)*Math.sin(m/2)**2;return 2*6371*Math.asin(Math.sqrt(g))}function ft(t,a,i){const m=i*Math.PI/180,g=t.lat*Math.PI/180,h=t.lng*Math.PI/180,p=a/6371e3,S=Math.asin(Math.sin(g)*Math.cos(p)+Math.cos(g)*Math.sin(p)*Math.cos(m))*180/Math.PI,f=(h+Math.atan2(Math.sin(m)*Math.sin(p)*Math.cos(g),Math.cos(p)-Math.sin(g)*Math.sin(S*Math.PI/180)))*180/Math.PI;return{lat:S,lng:f}}async function xt(t){if(!t||!window.google?.maps?.Geocoder)return null;const a=new window.google.maps.Geocoder;return new Promise(i=>{a.geocode({address:t,region:"AT"},(l,m)=>{m==="OK"&&l?.[0]?.geometry?.location?i({lat:l[0].geometry.location.lat(),lng:l[0].geometry.location.lng(),formatted:l[0].formatted_address||t}):i(null)})})}const Ie=t=>String(t||"").trim().toLowerCase();async function bt(){try{const t=await fetch("/api/vehicles",{cache:"no-store"});return t.ok?t.json():[]}catch{return[]}}async function yt(){try{const t=await fetch("/api/gps",{cache:"no-store"});if(t.ok)return await t.json()}catch(t){console.error("GPS fetch failed:",t)}return[]}function wt(t){const a=t?.typ||t?.type||"â€”",i=t?.timestamp?new Date(t.timestamp).toLocaleString("de-AT",{hour12:!1}):"â€”",l=t?.alerted??"â€”",m=t?.description??"â€”",g=t?.additionalAddressInfo||t?.ort||"â€”",h=[];t?.location&&h.push(String(t.location));const p=Number.isFinite(t?.latitude),S=Number.isFinite(t?.longitude);p&&S&&h.push(`(${t.latitude}, ${t.longitude})`);const f=h.length?h.join(" "):"â€”";return`
    <div style="min-width:280px">
      <div style="font-weight:700;margin-bottom:4px">${t?.content||"Einsatz"}</div>
      <div><b>Typ:</b> ${a}</div>
      <div><b>Alarmzeit:</b> ${i}</div>
      <div><b>Alarmiert:</b> ${l}</div>
      <div><b>Beschreibung:</b> ${m}</div>
      <div><b>Adresse:</b> ${g}</div>
      <div><b>Location:</b> ${f}</div>
    </div>
  `}const fe=44,vt="/vehicle-red.gif",On="/vehicle-gray.png",_n="/vehicle-drive.gif";function zn({context:t,address:a,onClose:i}){const l=a||t?.card?.ort||t?.address||"",m=!!window.google?.maps,g=r.useRef(null),[h,p]=r.useState(!1),[S,f]=r.useState(""),_=r.useMemo(()=>{const P=t?.card;return P&&Number.isFinite(P?.latitude)&&Number.isFinite(P?.longitude)?{lat:Number(P.latitude),lng:Number(P.longitude)}:null},[t]);if(r.useEffect(()=>{if(!m||!t?.card||!g.current)return;let P=!1,M,R;const v=new Map;let A=null;return(async()=>{try{p(!0),f("");let z=_;if(!z){const b=await xt(t.card.ort);if(P)return;b&&(z={lat:b.lat,lng:b.lng})}if(!z){f("Konnte Einsatz-Position nicht bestimmen.");return}M=new window.google.maps.Map(g.current,{center:z,zoom:18,mapTypeId:"roadmap"}),R=new window.google.maps.InfoWindow;const q=(b,K,te,W,{hover:U=!1}={})=>{const X={path:"M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z",fillColor:K,fillOpacity:1,strokeColor:"#333",strokeWeight:1,scale:1.2},ee=new window.google.maps.Marker({position:b,map:M,title:te,icon:X});if(W){const j=()=>{R.setContent(W),R.open(M,ee)};U?(ee.addListener("mouseover",j),ee.addListener("mouseout",()=>R.close())):ee.addListener("click",j)}return ee};q(z,"#d11a1a",t.card.content||"Einsatz",wt(t.card),{hover:!0});const N=[...t?.board?.columns?.neu?.items||[],...t?.board?.columns?.["in-bearbeitung"]?.items||[]],I=new Map;for(const b of N)if(Number.isFinite(b.latitude)&&Number.isFinite(b.longitude))I.set(b.id,{lat:Number(b.latitude),lng:Number(b.longitude)});else if(b.ort){const K=await xt(b.ort);K&&I.set(b.id,{lat:K.lat,lng:K.lng})}for(const b of N){if(b.id===t.card.id)continue;const K=I.get(b.id);K&&q(K,"#1e63d1",b.content||"Einsatz",wt(b),{hover:!0})}const H=new Map;for(const b of N)for(const K of b.assignedVehicles||[])H.set(String(K),b.id);const $=await yt(),Z=new Map($.filter(b=>Number.isFinite(b?.lat)&&Number.isFinite(b?.lng)&&b?.realname).map(b=>[Ie(b.realname),b])),Y=await bt(),Q=new Map(Y.filter(b=>b&&b.source!=="gps"&&Number.isFinite(b.latitude)&&Number.isFinite(b.longitude)).map(b=>[String(b.id),{lat:Number(b.latitude),lng:Number(b.longitude)}])),ae=Object.values(t.vehiclesById||{}),w=10,de=50,F=new Map,oe=window.google?.maps?.marker?.AdvancedMarkerElement,he=(b,K,te)=>{if(!b)return On;if(!K||!te||!I.has(te))return vt;const W=I.get(te);return Ln(K,W)>.1?_n:vt},xe=(b,K,te,W,U,X)=>{const ee=he(K,W,U),j=!W;if(oe){const D=document.createElement("img");D.src=ee,D.width=fe,D.height=fe,D.alt=te||"",D.decoding="async";const k=new oe({map:M,position:b,content:D,title:te});if(j){try{k.draggable=!0}catch{}k.addListener("dragend",async s=>{const c=s?.latLng||k.position,y=typeof c.lat=="function"?c.lat():c.lat,C=typeof c.lng=="function"?c.lng():c.lng;try{await gt(X,y,C,U,"manual")}catch(B){k.__setPosition(b),console.error("setVehiclePosition failed:",B),alert("Position konnte nicht gespeichert werden.")}})}return k.__setPosition=s=>{k.position=s},k.__setIcon=(s,c,y)=>{D.src=he(s,c,y)},k.__onOver=s=>{D.addEventListener("mouseover",s),D.addEventListener("mouseout",()=>R.close())},k}else{const D=new window.google.maps.Marker({position:b,map:M,title:te,draggable:j,icon:{url:ee,scaledSize:new window.google.maps.Size(fe,fe),anchor:new window.google.maps.Point(fe/2,fe/2)}});return j&&D.addListener("dragend",async k=>{const s=k?.latLng||D.getPosition(),c=typeof s.lat=="function"?s.lat():s.lat,y=typeof s.lng=="function"?s.lng():s.lng;try{await gt(X,c,y,U,"manual")}catch(C){D.__setPosition(b),console.error("setVehiclePosition failed:",C),alert("Position konnte nicht gespeichert werden.")}}),D.__setPosition=k=>D.setPosition(k),D.__setIcon=(k,s,c)=>D.setIcon({url:he(k,s,c),scaledSize:new window.google.maps.Size(fe,fe),anchor:new window.google.maps.Point(fe/2,fe/2)}),D.__onOver=k=>{D.addListener("mouseover",k),D.addListener("mouseout",()=>R.close())},D}};for(const b of ae){const K=String(b.id),te=Ie(`${b?.label||""} ${b?.ort||""}`),W=Z.get(te),U=H.get(K);if(!U&&!W)continue;let X=null,ee=null;if(W)ee={lat:Number(W.lat),lng:Number(W.lng)},X=ee;else if(Q.has(K))X=Q.get(K);else if(U&&I.has(U)){const c=I.get(U),C=((F.get(U)||0)+de)%360;F.set(U,C),X=ft(c,w,C)}if(!X)continue;const D=xe(X,!!U,b.label||b.id,ee,U,K),k=U&&N.find(c=>c.id===U),s=k?`<br/><i>zugeordnet: ${k.content}</i>`:"";D.__onOver(()=>{const c=b?.ort||"";R.setContent(`<div style="min-width:220px"><b>${b.label||b.id}</b>${c?`<br/>${c}`:""}${s}</div>`);const y=oe?void 0:D;R.open({map:M,anchor:y,position:X,shouldFocus:!1})}),v.set(K,D)}M.setCenter(z),M.setZoom(18),A=setInterval(async()=>{const b=await yt(),K=await bt(),te=new Map(K.filter(k=>k&&k.source!=="gps"&&Number.isFinite(k.latitude)&&Number.isFinite(k.longitude)).map(k=>[String(k.id),{lat:Number(k.latitude),lng:Number(k.longitude)}])),W=new Map(b.filter(k=>Number.isFinite(k?.lat)&&Number.isFinite(k?.lng)&&k?.realname).map(k=>[Ie(k.realname),k])),U=new Map;for(const k of[...t?.board?.columns?.neu?.items||[],...t?.board?.columns?.["in-bearbeitung"]?.items||[]])for(const s of k.assignedVehicles||[])U.set(String(s),k.id);const X=Object.values(t.vehiclesById||{}),ee=new Map;for(const k of X){const s=String(k.id),c=U.get(s),y=Ie(`${k?.label||""} ${k?.ort||""}`);if(c&&!W.get(y)){const C=ee.get(c)||[];C.push(s),ee.set(c,C)}}for(const[k,s]of ee.entries())s.sort();const j=10,D=50;for(const k of X){const s=String(k.id),c=v.get(s);if(!c)continue;const y=Ie(`${k?.label||""} ${k?.ort||""}`),C=W.get(y),B=U.get(s);if(C)gpsPos={lat:Number(C.lat),lng:Number(C.lng)},c.__setPosition(gpsPos);else if(te.has(s))c.__setPosition(te.get(s));else if(B&&I.has(B)){const ne=((ee.get(B)||[]).indexOf(s)+1)*D%360,ue=I.get(B);c.__setPosition(ft(ue,j,ne))}else{const J=v.get(s);J&&(J.setMap?J.setMap(null):J.map&&(J.map=null),v.delete(s));continue}const V=!!B;c.__setIcon(V,gpsPos,B)}},5e3)}catch(z){f(z?.message||"Kartenaufbau fehlgeschlagen.")}finally{p(!1)}})(),()=>{P=!0,A&&clearInterval(A),v.clear()}},[m,t,_]),!m||!t?.card){const P=`https://www.google.com/maps?q=${encodeURIComponent(l)}&output=embed`;return e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:i,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[70vh] p-2",onClick:M=>M.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-semibold text-sm",children:["Karte: ",l]}),e.jsx("button",{className:"px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm",onClick:i,children:"SchlieÃŸen"})]}),e.jsx("iframe",{title:"maps",className:"w-full h-full rounded-lg border",src:P,loading:"lazy"})]})})}return e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:i,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-5xl h-[75vh] p-2",onClick:P=>P.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-semibold text-sm",children:["Karte: ",t?.card?.content||"Einsatz"," Â· weitere EinsÃ¤tze (Neu & In Bearbeitung)"]}),e.jsx("button",{className:"px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm",onClick:i,children:"SchlieÃŸen"})]}),e.jsx("div",{ref:g,className:"w-full h-full rounded-lg border"}),h&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"px-3 py-1.5 rounded bg-white shadow text-sm",children:"Ladeâ€¦"})}),!!S&&e.jsx("div",{className:"absolute bottom-3 left-3 px-2 py-1 rounded bg-red-600 text-white text-xs shadow",children:S})]})})}function Fn({onClose:t,onCreate:a}){const[i,l]=r.useState(""),[m,g]=r.useState(""),[h,p]=r.useState(0),[S,f]=r.useState(!1),[_,P]=r.useState(""),M=async R=>{if(R.preventDefault(),P(""),!i.trim()||!m.trim()){P("Ort und Name sind erforderlich.");return}try{f(!0),await a({ort:i.trim(),label:m.trim(),mannschaft:Number(h)||0}),t()}catch(v){P(v?.message||"Speichern fehlgeschlagen.")}finally{f(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:e.jsxs("form",{onSubmit:M,className:"bg-white rounded-xl shadow-lg p-4 w-[360px] space-y-3",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Einheit anlegen"}),_&&e.jsx("div",{className:"text-sm text-red-600",children:_}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Ort"}),e.jsx("input",{className:"border rounded px-2 py-1 w-full",value:i,onChange:R=>l(R.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Name"}),e.jsx("input",{className:"border rounded px-2 py-1 w-full",value:m,onChange:R=>g(R.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Mannschaft"}),e.jsx("input",{type:"number",min:"0",className:"border rounded px-2 py-1 w-24",value:h,onChange:R=>p(R.target.value)})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:t,className:"px-3 py-1 rounded border",disabled:S,children:"Abbrechen"}),e.jsx("button",{type:"submit",className:"px-3 py-1 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:S,children:S?"Anlegenâ€¦":"Anlegen"})]})]})})}let Le=null;function It(){const t=document.querySelector('meta[name="google-places-key"]');return(window.GMAPS_API_KEY||t?.content||"").trim()||""}async function Vn(t=It()){if(window.google?.maps?.places)return!0;if(!t)return!1;if(Le)return await Le,!!window.google?.maps?.places;Le=new Promise((a,i)=>{if(document.getElementById("gmap-places")){const m=()=>{window.google?.maps?.places?a(!0):setTimeout(m,150)};m();return}const l=document.createElement("script");l.id="gmap-places",l.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(t)}&libraries=places&language=de`,l.async=!0,l.defer=!0,l.onload=()=>a(!!window.google?.maps?.places),l.onerror=m=>i(m),document.head.appendChild(l)});try{await Le}catch{}return!!window.google?.maps?.places}function Et({debounceMs:t=300,country:a="at",minLength:i=3}={}){const[l,m]=r.useState(""),[g,h]=r.useState([]),[p,S]=r.useState(!1),[f,_]=r.useState(!1),[P,M]=r.useState(null),R=r.useRef(null),v=r.useRef(null),A=r.useRef(null),T=r.useRef(null);r.useEffect(()=>{let $=!1;return(async()=>{const Z=await Vn(It());$||!Z||!window.google?.maps?.places||(R.current=new google.maps.places.AutocompleteService,v.current=new google.maps.places.PlacesService(document.createElement("div")),A.current=new google.maps.places.AutocompleteSessionToken,$||_(!0))})(),()=>{$=!0}},[]);const z=r.useCallback(()=>{window.google?.maps?.places&&(A.current=new google.maps.places.AutocompleteSessionToken)},[]),q=r.useRef();r.useEffect(()=>{q.current||(q.current=($,Z)=>{let Y;return(...Q)=>{clearTimeout(Y),Y=setTimeout(()=>$(...Q),Z)}})},[]);const N=r.useCallback(async $=>{if(!f||!R.current)return;const Z=($||"").trim();if(!Z||Z.length<i){h([]);return}S(!0),M(null),R.current.getPlacePredictions({input:Z,sessionToken:A.current,componentRestrictions:{country:a},types:["address"]},(Y,Q)=>{if(S(!1),Q!==google.maps.places.PlacesServiceStatus.OK||!Y){h([]),Q&&Q!=="ZERO_RESULTS"&&M(Q);return}h(Y)})},[a,i,f]),I=r.useMemo(()=>q.current?q.current(N,t):()=>{},[N,t]);r.useEffect(()=>{I(l)},[l,I]);const H=r.useCallback(($,Z=["formatted_address","geometry","address_components"])=>new Promise((Y,Q)=>{if(!f||!v.current){Q(new Error("Google Places nicht bereit"));return}v.current.getDetails({placeId:$,fields:Z,sessionToken:A.current},(ae,w)=>{if(w!==google.maps.places.PlacesServiceStatus.OK||!ae)return Q(new Error(w||"DETAILS_FAILED"));Y(ae)})}),[f]);return{ready:f,query:l,setQuery:m,predictions:g,loading:p,error:P,resetSession:z,getDetailsByPlaceId:H,inputElRef:T}}function Bn({onClose:t,onCreate:a,types:i}){const[l,m]=r.useState(""),[g,h]=r.useState(""),[p,S]=r.useState(!1),f=r.useRef(null),{query:_,setQuery:P,predictions:M,getDetailsByPlaceId:R,resetSession:v,loading:A,error:T}=Et({country:"at",debounceMs:300,minLength:3});r.useEffect(()=>{setTimeout(()=>f.current?.focus(),0)},[]),r.useEffect(()=>{const N=(g||"").replace(/^T\d+\s*,?\s*/i,"").trim();!l.trim()&&N&&m(N)},[g]);const z=async N=>{N?.preventDefault?.();const I=(g||"").replace(/^T\d+\s*,?\s*/i,"").trim(),H=(l||I).trim();if(H){S(!0);try{await a({title:H,ort:(_||"").trim(),typ:(g||"").trim()}),m(""),P(""),h(""),v(),t?.()}finally{S(!1)}}},q=async N=>{try{const H=(await R(N.place_id,["formatted_address","geometry","address_components","place_id"]))?.formatted_address||N.description;P(H)}catch{P(N.description)}finally{v()}};return e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-3",children:e.jsxs("form",{onSubmit:z,className:"bg-white rounded-xl shadow-lg w-[520px] max-w-full p-4 space-y-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Einsatz anlegen"}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs("select",{ref:f,className:"border rounded px-2 py-1",value:g,onChange:N=>h(N.target.value),children:[e.jsx("option",{value:"",children:"â€” Typ auswÃ¤hlen â€”"}),i.map(N=>e.jsx("option",{value:N,children:N},N))]}),e.jsx("input",{className:"border rounded px-2 py-1",placeholder:"Titel (wird aus Typ Ã¼bernommen)",value:l,onChange:N=>m(N.target.value)}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{className:"border rounded px-2 py-1 w-full",placeholder:"Ort (nur Ã–sterreich)",autoComplete:"off",value:_,onChange:N=>P(N.target.value)}),A&&e.jsx("div",{className:"absolute z-10 mt-1 text-xs text-gray-500 bg-white border rounded px-2 py-1",children:"Sucheâ€¦"}),T&&e.jsxs("div",{className:"absolute z-10 mt-1 text-xs text-red-600 bg-white border rounded px-2 py-1",children:["Fehler: ",String(T)]}),!!M.length&&e.jsx("ul",{className:"absolute z-10 mt-1 w-full max-h-52 overflow-auto bg-white border rounded shadow",children:M.map(N=>e.jsx("li",{className:"px-2 py-1 hover:bg-gray-100 cursor-pointer text-sm",onClick:()=>q(N),title:N.description,children:N.description},N.place_id))})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:t,className:"px-3 py-1 rounded border",disabled:p,children:"Abbrechen"}),e.jsx("button",{className:"px-3 py-1 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:p,children:p?"Anlegenâ€¦":"Anlegen"})]})]})})}function Kn({colId:t,title:a,bg:i,children:l,editable:m=!0}){if(!m)return e.jsxs("section",{className:`${i} rounded-xl shadow p-3 h-full flex flex-col min-h-0`,children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:a}),l]});const{setNodeRef:g,isOver:h}=gn({id:`col:${t}`,data:{type:"column",colId:t}});return e.jsxs("section",{ref:g,className:`${i} rounded-xl shadow p-3 h-full flex flex-col min-h-0 ${h?"outline outline-2 outline-blue-400":""}`,children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:a}),l]})}function Un({open:t,onClose:a,info:i={}}){if(!t)return null;const l=({label:p,value:S})=>e.jsxs("div",{className:"flex items-start gap-3 py-1",children:[e.jsx("div",{className:"w-32 shrink-0 text-gray-600",children:p}),e.jsx("div",{className:"flex-1 font-medium break-words",children:S??"â€”"})]}),m=i.timestamp?new Date(i.timestamp).toLocaleString("de-AT",{hour12:!1}):"â€”",g=[];i.location&&g.push(String(i.location)),Number.isFinite(i.latitude)&&Number.isFinite(i.longitude)&&g.push(`(${i.latitude}, ${i.longitude})`);const h=g.length?g.join(" "):void 0;return e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:a}),e.jsxs("div",{className:"relative z-[101] w-[min(92vw,640px)] rounded-xl bg-white shadow-xl p-4 md:p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg md:text-xl font-bold",children:"Einsatz-Info"}),e.jsx("button",{className:"h-8 w-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center",onClick:a,"aria-label":"SchlieÃŸen",title:"SchlieÃŸen",children:e.jsx("svg",{viewBox:"0 0 12 12",width:"14",height:"14","aria-hidden":"true",children:e.jsx("path",{d:"M1 1 L11 11 M11 1 L1 11",stroke:"black",strokeWidth:"2",strokeLinecap:"round"})})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(l,{label:"Typ",value:i.type||i.typ}),e.jsx(l,{label:"Alarmzeit",value:m}),e.jsx(l,{label:"Alarmiert",value:i.alerted}),e.jsx(l,{label:"Beschreibung",value:i.description}),e.jsx(l,{label:"Adresse",value:i.additionalAddressInfo||i.ort}),e.jsx(l,{label:"Location",value:h})]}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx("button",{className:"px-3 py-1.5 rounded-md bg-emerald-600 text-white hover:bg-emerald-700",onClick:a,children:"OK"})})]})]})}function Hn(t){const a=(t??"").toString();return a.length>30?a.slice(0,30)+"â€¦":a}function Gn(){const[t,a]=r.useState([]),[i,l]=r.useState(!0),[m,g]=r.useState(!1);r.useEffect(()=>{(async()=>{try{await qe(),g(Qe("protokoll"))}catch{g(!1)}})(),(async()=>{try{const p=await fetch("/api/protocol").then(S=>S.json());a(Array.isArray(p?.items)?p.items:[])}catch{a([])}finally{l(!1)}})()},[]);const h=r.useMemo(()=>[...t].sort((p,S)=>(Number(S.nr)||0)-(Number(p.nr)||0)),[t]);return e.jsxs("div",{className:"p-3 md:p-4 max-w-[1400px] mx-auto h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-3",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:"Protokoll-Ãœbersicht"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("a",{href:"/api/protocol/csv/file",className:"px-3 py-1.5 rounded-md border bg-white",title:"protocol.csv herunterladen",children:"CSV"}),e.jsx("button",{onClick:()=>{m&&(window.location.hash="/protokoll/neu")},className:"px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white",title:m?void 0:"Keine Berechtigung (Meldestelle)",children:"+ Eintrag anlegen"})]})]}),e.jsx("div",{className:"flex-1 overflow-auto border rounded-lg bg-white",children:i?e.jsx("div",{className:"p-4 text-gray-500",children:"Ladeâ€¦"}):e.jsxs("table",{className:"min-w-[1100px] w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0 z-10",children:e.jsxs("tr",{className:"[&>th]:px-2 [&>th]:py-2 [&>th]:text-left [&>th]:font-semibold border-b",children:[e.jsx("th",{style:{width:28},title:"Druckstatus"}),e.jsx("th",{style:{width:60},children:"NR"}),e.jsx("th",{style:{width:110},children:"Datum"}),e.jsx("th",{style:{width:80},children:"Zeit"}),e.jsx("th",{style:{width:120},children:"Kanal"}),e.jsx("th",{style:{width:110},children:"Richtung"}),e.jsx("th",{style:{width:160},children:"An/Von"}),e.jsx("th",{children:"Information"}),e.jsx("th",{style:{width:260},children:"Meldungstyp"})]})}),e.jsxs("tbody",{className:"[&>tr>td]:px-2 [&>tr>td]:py-2",children:[h.map(p=>{const S=p?.uebermittlungsart||{},f=S.kanal??S.kanalNr??S.art??"",P=[].concat(S.ein?"Eingang":[]).concat(S.aus?"Ausgang":[]).join(" / "),M=Number(p?.printCount)>0;return e.jsxs("tr",{className:"border-b align-top hover:bg-gray-50 cursor-pointer",onClick:()=>{window.location.hash=`/protokoll/edit/${p.nr}`},title:"Zum Bearbeiten Ã¶ffnen",children:[e.jsx("td",{className:"align-middle",children:M?e.jsx("span",{className:"inline-block w-3 h-3 rounded-full bg-yellow-400",title:`Gedruckt (${p.printCount})`}):null}),e.jsx("td",{className:"font-semibold",children:p.nr}),e.jsx("td",{children:p.datum}),e.jsx("td",{children:p.zeit}),e.jsx("td",{title:f,children:f}),e.jsx("td",{title:P,children:P}),e.jsx("td",{children:p.anvon}),e.jsx("td",{className:"whitespace-pre-wrap",children:Hn(p.information)}),e.jsx("td",{className:"whitespace-pre-wrap",children:p.infoTyp||"â€”"})]},p.nr)}),!h.length&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"p-4 text-gray-500 italic",children:"â€” keine EintrÃ¤ge â€”"})})]})]})})]})}const Ge=["EL","LtStb","S1","S2","S3","S4","S5","S6"],be={anvon:"prot_sugg_anvon",kanal:"prot_sugg_kanalNr",verantwortlich:"prot_sugg_ver"};function We(t,a=12){const i=new Set,l=[];for(const m of t){const g=String(m||"").trim();if(!(!g||i.has(g))&&(i.add(g),l.push(g),l.length>=a))break}return l}function jt(t){let a=String(t||"").trim();if(!a)return a;const i=a.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})$/);if(i){const m=i[1].padStart(2,"0"),g=i[2].padStart(2,"0");return`${i[3].length===2?"20"+i[3]:i[3]}-${g}-${m}`}const l=a.match(/^(\d{1,2})(\d{1,2})(\d{2,4})$/);if(l){const m=l[1].padStart(2,"0"),g=l[2].padStart(2,"0");return`${l[3].length===2?"20"+l[3]:l[3].padStart(4,"20")}-${g}-${m}`}return a}function Nt(t){let a=String(t||"").trim();if(!a)return a;const i=a.match(/^(\d{1,2})(\d{2})$/);if(i)return`${i[1].padStart(2,"0")}:${i[2]}`;const l=a.match(/^(\d{1,2})[:.](\d{1,2})$/);return l?`${l[1].padStart(2,"0")}:${l[2].padStart(2,"0")}`:a}const St=()=>({datum:new Date().toISOString().slice(0,10),zeit:new Date().toTimeString().slice(0,5),uebermittlungsart:{richtung:"",kanalNr:""},anvon:{richtung:"an",name:""},infoTyp:"Information",information:"",rueckmeldung1:"",rueckmeldung2:"",ergehtAn:[],ergehtAnText:"",lagebericht:"",massnahmen:Array.from({length:5},()=>({massnahme:"",verantwortlich:"",done:!1}))});function kt({mode:t="create",editNr:a=null}){const[i,l]=r.useState(!1);r.useEffect(()=>{let s=!0;return(async()=>{try{if(await qe(),!s)return;l(Qe("protokoll"))}catch{if(!s)return;l(!1)}})(),()=>{s=!1}},[]);const[m,g]=r.useState(()=>{const s=Number(a);return Number.isFinite(s)&&s>0?s:null}),h=Number.isFinite(Number(m))&&Number(m)>0,[p,S]=r.useState(h),[f,_]=r.useState(!1),[P,M]=r.useState(null),R=r.useRef(null),v=r.useRef(null),A=r.useRef(!1),T=r.useRef(null),[z,q]=r.useState(null),N=r.useRef(null),I=(s,c,y=2200)=>{q({type:s,text:c}),N.current&&clearTimeout(N.current),N.current=setTimeout(()=>q(null),y)},[H,$]=r.useState([]),[Z,Y]=r.useState([]),[Q,ae]=r.useState([]);r.useEffect(()=>{try{$(JSON.parse(localStorage.getItem(be.anvon)||"[]")),Y(JSON.parse(localStorage.getItem(be.kanal)||"[]")),ae(JSON.parse(localStorage.getItem(be.verantwortlich)||"[]"))}catch{}},[]);const[w,de]=r.useState(St()),F=(s,c)=>{const y=Array.isArray(s)?s:String(s).split(".");de(C=>{const B=structuredClone(C);let V=B;for(let J=0;J<y.length-1;J++)V=V[y[J]];return V[y.at(-1)]=c,B})};r.useEffect(()=>{if(!h){S(!1),setTimeout(()=>v.current?.focus(),0);return}const s=Number(m);!Number.isFinite(s)||s<=0||(async()=>{try{const c=await fetch(`/api/protocol/${s}`).then(y=>y.json());if(c?.ok&&c.item){const y=c.item,C=y.uebermittlungsart||{};let B="",V=y.anvon||"";const J=(y.anvon||"").trim();/^an\s*:/i.test(J)&&(B="an",V=J.replace(/^an\s*:/i,"").trim()),/^von\s*:/i.test(J)&&(B="von",V=J.replace(/^von\s*:/i,"").trim()),de({datum:y.datum||"",zeit:y.zeit||"",uebermittlungsart:{richtung:C.ein?"ein":C.aus?"aus":"",kanalNr:C.kanalNr||""},anvon:{richtung:B||"an",name:V},infoTyp:y.infoTyp||"Information",information:y.information||"",rueckmeldung1:y.rueckmeldung1||"",rueckmeldung2:y.rueckmeldung2||"",ergehtAn:Array.isArray(y.ergehtAn)?y.ergehtAn:[],ergehtAnText:y.ergehtAnText||"",lagebericht:y.lagebericht||"",massnahmen:Array.from({length:5},(G,ne)=>{const ue=y.massnahmen?.[ne]||{};return{massnahme:ue.massnahme||"",verantwortlich:ue.verantwortlich||"",done:!!ue.done}})}),M(y.id||null),setTimeout(()=>v.current?.focus(),0)}}finally{S(!1)}})()},[h,m]),r.useEffect(()=>{const s=()=>{const C=document.activeElement;C&&typeof C.blur=="function"&&C.blur()},c=C=>setTimeout(C,0),y=C=>{if(C.repeat)return;const B=(C.key||"").toLowerCase(),V=C.ctrlKey||C.metaKey;if(V&&!C.shiftKey&&B==="s"){if(C.preventDefault(),C.stopPropagation(),!i){I?.("error","Keine Berechtigung (Meldestelle)");return}if(A.current)return;A.current=!0,c(async()=>{s(),await new Promise(J=>setTimeout(J,0)),U().finally(()=>A.current=!1)});return}if(V&&(C.shiftKey&&B==="s"||B==="enter")){if(C.preventDefault(),C.stopPropagation(),!i){I?.("error","Keine Berechtigung (Meldestelle)");return}if(A.current)return;A.current=!0,c(async()=>{s(),await new Promise(J=>setTimeout(J,0)),X().finally(()=>A.current=!1)});return}B==="escape"&&(C.preventDefault(),C.stopPropagation(),c(()=>te()))};return window.addEventListener("keydown",y,!0),document.addEventListener("keydown",y,!0),()=>{window.removeEventListener("keydown",y,!0),document.removeEventListener("keydown",y,!0)}},[]);const[oe,he]=r.useState(!1),xe=r.useRef(null);function b(){const s=Array.isArray(w?.ergehtAn)?[...w.ergehtAn]:[],c=(w?.ergehtAnText||"").trim();return c&&s.push(c),s}const K=async()=>{if(!i){I?.("error","Keine Berechtigung zum Drucken/Speichern");return}if(oe)return;const s=b();if(!s.length){I?.("error","Bitte EmpfÃ¤nger wÃ¤hlen oder 'Sonstiger EmpfÃ¤nger' ausfÃ¼llen.");return}he(!0);try{const c=await W();if(!c)throw new Error("Speichern fehlgeschlagen");g(c);const C=(await fetch(`/api/protocol/${c}`).then(ne=>ne.json()))?.item;if(!C)throw new Error("Datensatz fÃ¼r Druck nicht gefunden");I?.("info","PDF wird serverseitig erzeugt â€¦");const B=await fetch(`/api/protocol/${c}/print`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({recipients:s,data:C})}).then(ne=>ne.json());if(!B?.ok||!B?.fileUrl)throw new Error(B?.error||"PDF-Erzeugung fehlgeschlagen");let V=xe.current;V||(V=document.createElement("iframe"),V.style.position="fixed",V.style.width="0",V.style.height="0",V.style.border="0",V.style.visibility="hidden",document.body.appendChild(V),xe.current=V);const J=`${B.fileUrl}#toolbar=0&navpanes=0&scrollbar=0`;V.onload=()=>{try{setTimeout(()=>{V.contentWindow?.focus(),V.contentWindow?.print()},100)}catch{window.open(J,"_blank","noopener,noreferrer")?.focus()}},V.src=J;const G=Number(B?.pages)||s.length;I?.("success",`Druck gestartet (${G} Seite${G>1?"n":""})`)}catch(c){I?.("error",`Drucken fehlgeschlagen: ${c.message||c}`)}finally{he(!1)}},te=()=>{window.location.hash="/protokoll"},W=async()=>{const s=T.current?new FormData(T.current):null,c=structuredClone(w);c.datum=jt(s?.get("datum")||w.datum),c.zeit=Nt(s?.get("zeit")||w.zeit);const y=(s?.get("anvonDir")||w.anvon.richtung||"").toString(),C=(s?.get("anvonName")||w.anvon.name||"").toString();c.anvon={richtung:y,name:C};const B=(s?.get("richtung")||w.uebermittlungsart.richtung||"").toString();c.uebermittlungsart.richtung=B,c.uebermittlungsart.kanalNr=(s?.get("kanalNr")||w.uebermittlungsart.kanalNr||"").toString(),c.information=(s?.get("information")||w.information||"").toString(),c.rueckmeldung1=(s?.get("rueckmeldung1")||w.rueckmeldung1||"").toString(),c.rueckmeldung2=(s?.get("rueckmeldung2")||w.rueckmeldung2||"").toString(),c.ergehtAnText=(s?.get("ergehtAnText")||w.ergehtAnText||"").toString(),c.infoTyp=(s?.get("infoTyp")||w.infoTyp||"Information").toString();const V=s?Array.from(s.getAll("ergehtAn")).map(String):w.ergehtAn;c.ergehtAn=V.length?V:w.ergehtAn,c.massnahmen=c.massnahmen.map((G,ne)=>{const ue=s?s.get(`m_done_${ne}`)!==null:G.done;return{massnahme:(s?.get(`m_massnahme_${ne}`)||G.massnahme||"").toString(),verantwortlich:(s?.get(`m_verantwortlich_${ne}`)||G.verantwortlich||"").toString(),done:!!ue}});const J={...c,uebermittlungsart:{kanalNr:(c.uebermittlungsart.kanalNr||"").trim(),ein:c.uebermittlungsart.richtung==="ein",aus:c.uebermittlungsart.richtung==="aus"},anvon:c.anvon.richtung?`${c.anvon.richtung==="an"?"An":"Von"}: ${c.anvon.name}`.trim():c.anvon.name.trim()};try{const G=We([J.anvon,...JSON.parse(localStorage.getItem(be.anvon)||"[]")]),ne=We([J.uebermittlungsart.kanalNr,...JSON.parse(localStorage.getItem(be.kanal)||"[]")]),ue=[...c.massnahmen.map(ke=>ke.verantwortlich).filter(Boolean),...JSON.parse(localStorage.getItem(be.verantwortlich)||"[]")],Ee=We(ue);localStorage.setItem(be.anvon,JSON.stringify(G)),localStorage.setItem(be.kanal,JSON.stringify(ne)),localStorage.setItem(be.verantwortlich,JSON.stringify(Ee)),$(G),Y(ne),ae(Ee)}catch{}if(h){const G=await fetch(`/api/protocol/${m}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(J)}).then(ne=>ne.json());if(!G?.ok)throw new Error(G?.error||"Speichern fehlgeschlagen");return g(G.nr),M(G.id||P||null),G.nr}else{const G=await fetch("/api/protocol",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(J)}).then(ne=>ne.json());if(!G?.ok)throw new Error(G?.error||"Speichern fehlgeschlagen");return g(G.nr),M(G.id||null),G.nr}},U=async()=>{if(!i){I?.("error","Keine Berechtigung (Meldestelle)");return}if(!f){_(!0);try{await W()&&(window.location.hash="/protokoll")}catch(s){I("error","Fehler beim Speichern: "+s.message,4e3)}finally{_(!1)}}},X=async()=>{if(!i){I?.("error","Keine Berechtigung (Meldestelle)");return}if(!f){_(!0);try{const s=await W();s&&(I("success",`Gespeichert (NR ${s}) â€“ neuer Eintrag`),de(St()),g(null),M(null),setTimeout(()=>v.current?.focus(),0))}catch(s){I("error","Fehler beim Speichern: "+s.message,4e3)}finally{_(!1)}}},ee=s=>{const c=(s.key||"").toLowerCase(),y=s.ctrlKey||s.metaKey;s.repeat||(y&&!s.shiftKey&&c==="s"?(s.preventDefault(),s.stopPropagation(),U()):y&&(s.shiftKey&&c==="s"||c==="enter")&&(s.preventDefault(),s.stopPropagation(),X()))},j=s=>{if(s.preventDefault(),!i){I?.("error","Keine Berechtigung (Meldestelle)");return}U()};if(p)return e.jsx("div",{className:"p-4",children:"Ladeâ€¦"});const D=Ge.every(s=>w.ergehtAn.includes(s)),k=s=>F("ergehtAn",s?[...Ge]:[]);return e.jsxs("div",{className:"mx-auto w-full max-w-[1100px] relative",children:[e.jsx("div",{className:"prot-actionbar sticky top-0 z-30 -mx-2 md:mx-0 px-2 md:px-0",children:e.jsxs("div",{className:"bg-white/95 backdrop-blur border-b rounded-t-xl px-3 py-2 flex items-center justify-between shadow-sm",children:[e.jsx("div",{className:"text-sm font-semibold",children:h?`Protokoll â€“ Bearbeiten (NR ${m??"â€”"})`:"Protokoll â€“ Neuer Eintrag"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:te,className:"px-3 py-1.5 rounded-md border",title:"Maske schlieÃŸen und zur Ãœbersicht wechseln (ESC)",children:"Abbrechen"}),e.jsx("button",{type:"button",onClick:X,disabled:f,className:"px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white disabled:opacity-60",title:"Speichern und neue Maske (Strg+Shift+S oder Strg+Enter)",children:"Speichern/Neu"}),e.jsx("button",{type:"button",onClick:U,disabled:f,className:"px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-60",title:"Speichern und schlieÃŸen (Strg+S)",children:f?"Speichernâ€¦":"Speichern"}),e.jsx("button",{type:"button",onClick:K,disabled:oe,className:"px-3 py-1.5 rounded-md border bg-white hover:bg-gray-50 disabled:opacity-60",title:"Formular drucken â€“ Anzahl gemÃ¤ÃŸ 'ergeht an' + 'Sonstiger EmpfÃ¤nger'",children:oe?"Druckenâ€¦":"Drucken"})]})]})}),z&&e.jsx("div",{className:"fixed right-3 top-3 z-40",children:e.jsx("div",{className:"px-3 py-2 rounded shadow text-white "+(z.type==="success"?"bg-emerald-600":z.type==="error"?"bg-rose-600":"bg-slate-600"),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{children:z.text}),e.jsx("button",{className:"opacity-80 hover:opacity-100",onClick:()=>q(null),title:"Meldung schlieÃŸen",children:"âœ•"})]})})}),e.jsx("style",{children:`
        @media print {
          * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          .prot-actionbar { display: none !important; }
          html, body { margin: 0 !important; }
          @page { size: A4; margin: 12mm; }
        }
      `}),e.jsxs("form",{ref:T,onKeyDown:ee,onSubmit:j,className:"bg-white border-2 rounded-b-xl overflow-hidden shadow",children:[e.jsxs("div",{className:"grid grid-cols-12",children:[e.jsx("div",{className:"col-span-9 p-6 border-b-2",children:e.jsx("div",{className:"text-3xl font-extrabold tracking-wide",children:"MELDUNG/INFORMATION"})}),e.jsxs("div",{className:"col-span-3 border-l-2",children:[e.jsx("div",{className:"p-3 text-xs text-gray-600 border-b-2",children:"PROTOKOLL-NR"}),e.jsx("div",{className:"p-6 text-center text-4xl font-bold",children:m??"â€”"})]}),e.jsx("div",{className:"col-span-12 border-y-2 p-2",children:e.jsxs("div",{className:"grid grid-cols-12 gap-0",children:[e.jsxs("div",{className:"col-span-6 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Datum"}),e.jsx("input",{name:"datum",type:"text",className:"border rounded px-2 h-9 w-full",placeholder:"yyyy-mm-dd",value:w.datum,onChange:s=>F("datum",s.target.value),onBlur:s=>F("datum",jt(s.target.value)),title:"Datum (auch 101025 oder 10.10.2025 mÃ¶glich)"})]}),e.jsxs("div",{className:"col-span-3 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Uhrzeit"}),e.jsx("input",{name:"zeit",type:"text",className:"border rounded px-2 h-9 w-full",placeholder:"hh:mm",value:w.zeit,onChange:s=>F("zeit",s.target.value),onBlur:s=>F("zeit",Nt(s.target.value)),title:"Uhrzeit (915, 09:15 oder 0915 mÃ¶glich)"})]}),e.jsxs("div",{className:"col-span-3 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Typ"}),e.jsxs("div",{className:"grid grid-cols-3 gap-x-6 h-9 items-center",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{ref:v,type:"radio",name:"infoTyp",value:"Information",checked:w.infoTyp==="Information",onChange:()=>F("infoTyp","Information")}),e.jsx("span",{children:"Info"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"infoTyp",value:"Auftrag",checked:w.infoTyp==="Auftrag",onChange:()=>F("infoTyp","Auftrag")}),e.jsx("span",{children:"Auftrag"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"infoTyp",value:"Lagemeldung",checked:w.infoTyp==="Lagemeldung",onChange:()=>F("infoTyp","Lagemeldung")}),e.jsx("span",{children:"Lage"})]})]})]})]})}),e.jsx("div",{className:"col-span-12 border-y-2 p-2",children:e.jsxs("div",{className:"grid grid-cols-12 gap-0 items-end",children:[e.jsxs("div",{className:"col-span-6 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"An/Von"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{ref:R,name:"anvonName",className:"border rounded px-2 h-9 w-full flex-1",placeholder:"Name / Stelle",list:"dl-anvon",value:w.anvon.name,onChange:s=>{let c=s.target.value;const y=c.trim();/^an\s*:/i.test(y)?(F(["anvon","richtung"],"an"),c=y.replace(/^an\s*:/i,"").trim()):/^von\s*:/i.test(y)&&(F(["anvon","richtung"],"von"),c=y.replace(/^von\s*:/i,"").trim()),F(["anvon","name"],c)},title:'Optional mit PrÃ¤fix "an: â€¦" oder "von: â€¦"'}),e.jsxs("div",{className:"flex items-center gap-4 pl-2 min-w-[140px] shrink-0",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"anvonDir",value:"an",checked:w.anvon.richtung==="an",onChange:()=>F(["anvon","richtung"],"an")}),e.jsx("span",{children:"An"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"anvonDir",value:"von",checked:w.anvon.richtung==="von",onChange:()=>F(["anvon","richtung"],"von")}),e.jsx("span",{children:"Von"})]})]})]}),e.jsx("datalist",{id:"dl-anvon",children:H.map(s=>e.jsx("option",{value:s},s))})]}),e.jsxs("div",{className:"col-span-3 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Kanal"}),e.jsx("input",{name:"kanalNr",className:"border rounded px-2 h-9 w-full",list:"dl-kanal",value:w.uebermittlungsart.kanalNr,onChange:s=>F(["uebermittlungsart","kanalNr"],s.target.value),title:"z. B. Funkkanal, Telefonnummer, E-Mail-KÃ¼rzel â€¦"}),e.jsx("datalist",{id:"dl-kanal",children:Z.map(s=>e.jsx("option",{value:s},s))})]}),e.jsxs("div",{className:"col-span-3 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Richtung"}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-6 h-9 items-center",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",title:"Meldung wurde empfangen",children:[e.jsx("input",{type:"radio",name:"richtung",value:"ein",checked:w.uebermittlungsart.richtung==="ein",onChange:()=>F(["uebermittlungsart","richtung"],"ein")}),e.jsx("span",{children:"Eingang"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",title:"Meldung wurde gesendet",children:[e.jsx("input",{type:"radio",name:"richtung",value:"aus",checked:w.uebermittlungsart.richtung==="aus",onChange:()=>F(["uebermittlungsart","richtung"],"aus")}),e.jsx("span",{children:"Ausgang"})]})]})]})]})}),e.jsxs("div",{className:"col-span-12 border-y-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Information/Auftrag"}),e.jsx("textarea",{name:"information",className:"border rounded px-2 py-2 w-full min-h-[160px]",value:w.information,onChange:s=>F("information",s.target.value),title:"Sachverhalt / Meldetext"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"RÃ¼ckmeldung 1"}),e.jsx("input",{name:"rueckmeldung1",className:"border rounded px-2 h-9 w-full",value:w.rueckmeldung1,onChange:s=>F("rueckmeldung1",s.target.value),title:"erste RÃ¼ckmeldung"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"RÃ¼ckmeldung 2"}),e.jsx("input",{name:"rueckmeldung2",className:"border rounded px-2 h-9 w-full",value:w.rueckmeldung2,onChange:s=>F("rueckmeldung2",s.target.value),title:"zweite RÃ¼ckmeldung"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-2",children:"ergeht an:"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 mr-3",title:"Alle EmpfÃ¤nger auswÃ¤hlen / abwÃ¤hlen",children:[e.jsx("input",{type:"checkbox",checked:D,onChange:s=>k(s.target.checked)}),e.jsx("span",{children:"Alle"})]}),Ge.map(s=>e.jsxs("label",{className:"inline-flex items-center gap-2 mr-3",children:[e.jsx("input",{tabIndex:-1,type:"checkbox",name:"ergehtAn",value:s,checked:w.ergehtAn.includes(s),onChange:()=>{const c=new Set(w.ergehtAn);c.has(s)?c.delete(s):c.add(s),F("ergehtAn",[...c])},title:`EmpfÃ¤nger ${s} ${w.ergehtAn.includes(s)?"entfernen":"hinzufÃ¼gen"}`}),e.jsx("span",{children:s})]},s)),e.jsx("span",{className:"ml-2 text-xs text-gray-600",children:"sonstiger EmpfÃ¤nger:"}),e.jsx("input",{name:"ergehtAnText",className:"border rounded px-2 h-9",value:w.ergehtAnText,onChange:s=>F("ergehtAnText",s.target.value),placeholder:"Name/Gruppe"})]})]}),e.jsxs("div",{className:"col-span-12 border-t-2",children:[e.jsxs("div",{className:"grid grid-cols-12 bg-gray-50 border-b-2",children:[e.jsx("div",{className:"col-span-6 p-2 font-semibold border-r",children:"MaÃŸnahme"}),e.jsx("div",{className:"col-span-5 p-2 font-semibold border-r",children:"Verantwortlich"}),e.jsx("div",{className:"col-span-1 p-2 font-semibold text-center",children:"Erledigt"})]}),w.massnahmen.map((s,c)=>e.jsxs("div",{className:"grid grid-cols-12 border-t",children:[e.jsx("div",{className:"col-span-6 p-2 border-r",children:e.jsx("input",{name:`m_massnahme_${c}`,className:"w-full border rounded px-2 h-9",value:s.massnahme,onChange:y=>{const C=[...w.massnahmen];C[c]={...s,massnahme:y.target.value},F("massnahmen",C)},title:`MaÃŸnahme ${c+1}`})}),e.jsx("div",{className:"col-span-5 p-2 border-r",children:e.jsx("input",{name:`m_verantwortlich_${c}`,className:"w-full border rounded px-2 h-9",list:"dl-ver",value:s.verantwortlich,onChange:y=>{const C=[...w.massnahmen];C[c]={...s,verantwortlich:y.target.value},F("massnahmen",C)},title:`Verantwortlich ${c+1}`})}),e.jsx("div",{className:"col-span-1 p-2 flex items-center justify-center",children:e.jsx("input",{tabIndex:-1,type:"checkbox",name:`m_done_${c}`,value:"1",checked:!!s.done,onChange:y=>{const C=[...w.massnahmen];C[c]={...s,done:y.target.checked},F("massnahmen",C)},title:"Erledigt umschalten"})})]},c)),e.jsx("datalist",{id:"dl-ver",children:Q.map(s=>e.jsx("option",{value:s},s))})]})]}),e.jsx("button",{type:"submit",className:"hidden",children:"submit"})]})]})}function Wn({disabled:t=!1}){const[a,i]=r.useState(!1),[l,m]=r.useState(!1),[g,h]=r.useState(""),[p,S]=r.useState({remainingMin:null,idleMinutes:null,lastActivityIso:null,autoStopMin:null}),[f,_]=r.useState({lastLoadedIso:null,file:"list_filtered.json"}),[P,M]=r.useState(!1),[R,v]=r.useState(30),[A,T]=r.useState(null),z=r.useRef(!1),q=async()=>{try{const[N,I,H]=await Promise.all([fetch("/api/ff/status",{credentials:"include",cache:"no-store"}).then($=>$.json()).catch(()=>({running:!1})),fetch("/api/ff/creds",{credentials:"include",cache:"no-store"}).then($=>$.json()).catch(()=>({has:!1})),fetch("/api/import/auto-config",{credentials:"include",cache:"no-store"}).then($=>$.json()).catch(()=>({enabled:!1,intervalSec:30}))]);i(!!N.running),m(!!I.has),M(!!H.enabled),v(Number(H.intervalSec||30)),z.current||(z.current=!0,I.has||h("Keine globalen Fetcher-Zugangsdaten. Bitte als Admin unter /user-admin setzen."))}catch{}};return r.useEffect(()=>{q();const N=setInterval(q,3e3);return()=>clearInterval(N)},[]),r.useEffect(()=>{let N;const I=async()=>{try{const H=await fetch("/api/activity/status",{credentials:"include",cache:"no-store"});if(H.ok){const $=await H.json(),Z=Number($.idleMinutes),Y=Number($.autoStopMin),Q=Math.max(0,Math.ceil(Y-Z));S({remainingMin:Q,idleMinutes:Z,lastActivityIso:$.lastActivityIso,autoStopMin:Y}),i(!!$.fetcher?.running),_({lastLoadedIso:$.import?.lastLoadedIso??null,file:$.import?.file||"list_filtered.json"})}}catch{}};return I(),N=setInterval(I,1e3),()=>clearInterval(N)},[]),r.useEffect(()=>{let N;const I=()=>{if(!P||!f.lastLoadedIso){T(null);return}const $=new Date(f.lastLoadedIso).getTime()+R*1e3,Z=Math.max(0,Math.ceil(($-Date.now())/1e3));T(Z)};return I(),N=setInterval(I,1e3),()=>clearInterval(N)},[P,R,f.lastLoadedIso]),e.jsxs("div",{className:`flex items-center h-9 gap-2 ${t?"opacity-60 pointer-events-none":""}`,style:{alignItems:"center"},children:[e.jsx("span",{className:`sync-chip ${P?"active":""}`,title:P?"Auto-Import Countdown":"Auto-Import ist deaktiviert",style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:"110px",minWidth:"110px",textAlign:"center"},children:P?`âŸ³ in ${A??"â€“"}s`:"â¸ manuell"}),g&&e.jsx("span",{style:{color:"#dc2626",fontSize:12,marginLeft:8},children:g}),a&&p.remainingMin!=null&&p.remainingMin<=15&&e.jsxs("div",{title:`Letzte AktivitÃ¤t: ${p.lastActivityIso?new Date(p.lastActivityIso).toLocaleString():"â€“"} â€¢ Inaktiv: ${p.idleMinutes?.toFixed?.(1)} min â€¢ Limit: ${p.autoStopMin} min`,className:"ml-2 inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border "+(p.remainingMin<=5?"bg-red-50 text-red-700 border-red-300":p.remainingMin<=15?"bg-amber-50 text-amber-700 border-amber-300":"bg-blue-50 text-blue-700 border-blue-300"),children:[e.jsx("span",{className:"mr-2 h-2 w-2 rounded-full bg-current",style:{animation:"pulse 1.5s ease-in-out infinite"}}),e.jsxs("span",{children:["Auto-Import stoppt in ",e.jsxs("b",{children:[p.remainingMin," min"]})]})]}),e.jsx("div",{title:`Quelle: ${f.file}`,className:"ml-2 inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border bg-white text-gray-700",style:{borderColor:"#cbd5e1"},children:e.jsxs("span",{children:["Zuletzt geladen:"," ",e.jsx("b",{children:f.lastLoadedIso?new Date(f.lastLoadedIso).toLocaleTimeString("de-AT",{hour12:!1}):"â€“"})]})})]})}function Jn(){const[t,a]=r.useState(.9);return r.useEffect(()=>{const i=()=>{const l=window.innerWidth,m=window.innerHeight,g=Math.min(Math.max(Math.min(l/1440,m/900),.78),.95);a(Number(g.toFixed(2)))};return i(),window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[]),t}function Zn(){try{const t=new URLSearchParams(window.location.search),a=parseFloat(t.get("font"));if(Number.isFinite(a)&&a>=.5&&a<=5)return a}catch{}try{const t=parseFloat(localStorage.getItem("ff_font_scale")||"");if(Number.isFinite(t)&&t>=.5&&t<=5)return t}catch{}return 1.2}const Pt=t=>new Intl.DateTimeFormat("de-AT",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).format(new Date(t||Date.now())),At=t=>Array.isArray(t?.assignedVehicles)?t.assignedVehicles.length:0,Mt=(t,a)=>(t?.assignedVehicles||[]).reduce((i,l)=>{const m=a.get(l);return i+(typeof m?.mannschaft=="number"?m.mannschaft:0)},0);function qn({c:t,vehiclesById:a,showBottomCounts:i=!0,headerRight:l,kind:m}){const g=m==="erledigt",h=g?Array.isArray(t?.everVehicles)?t.everVehicles.length:0:At(t),p=g?Number.isFinite(t?.everPersonnel)?t.everPersonnel:0:Mt(t,a);return e.jsxs("div",{className:"border rounded-lg p-2 bg-white shadow-sm text-[0.9rem] leading-tight",children:[e.jsxs("div",{className:"flex items-start justify-between text-[0.72rem] text-gray-600 mb-1",children:[e.jsx("span",{children:Pt(t.createdAt)}),e.jsx("span",{className:"font-semibold",children:l})]}),e.jsx("div",{className:"font-semibold",children:t.content}),(t.ort||t.typ||t.alerted)&&e.jsxs("div",{className:"text-[0.75rem] text-gray-600 mt-0.5 space-x-2",children:[t.ort&&e.jsxs("span",{children:["ðŸ“ ",t.ort]}),t.typ&&e.jsxs("span",{children:["ðŸ·ï¸ ",t.typ]}),t.alerted&&e.jsxs("span",{className:"text-gray-500",children:["ðŸ”” ",t.alerted]})]}),i&&e.jsxs("div",{className:"mt-1 text-[0.78rem] text-gray-700 flex items-center gap-2",children:[e.jsxs("span",{children:["ðŸš’ ",h]}),e.jsxs("span",{children:["ðŸ‘¥ ",p]})]})]})}function Je({title:t,cards:a,vehiclesById:i,kind:l,viewportH:m}){const p=Math.max(160,m-56-40),S=Math.max(1,Math.floor(p/96)),f=S*2,_=S+1,P=Math.max(f+2,_+6);let M="grid-cols-1";a.length>=P?M="grid-cols-3":a.length>=_&&(M="grid-cols-2");const R=T=>Pt(T.statusSince),v=r.useMemo(()=>{const T=a.length,z=a.reduce((N,I)=>l==="erledigt"?N+(Array.isArray(I.everVehicles)?I.everVehicles.length:0):N+(Array.isArray(I.assignedVehicles)?I.assignedVehicles.length:0),0),q=a.reduce((N,I)=>{if(l==="erledigt")return N+(Number.isFinite(I?.everPersonnel)?I.everPersonnel:0);const $=(Array.isArray(I.assignedVehicles)?I.assignedVehicles:[]).reduce((Z,Y)=>Z+(i.get(Y)?.mannschaft??0),0);return N+$},0);return{cardCount:T,unitSum:z,personSum:q}},[a,l,i]),A={neu:"bg-red-100","in-bearbeitung":"bg-yellow-100",erledigt:"bg-green-100"}[l]||"bg-gray-100";return e.jsxs("section",{className:`${A} rounded-xl shadow p-3 h-full flex flex-col min-h-0`,children:[e.jsxs("h3",{className:"text-sm font-semibold mb-2",children:[t," â€” â¬› ",v.cardCount," | ðŸš’ ",v.unitSum," | ðŸ‘¥ ",v.personSum]}),e.jsx("div",{className:`grid ${M} gap-2 overflow-auto pr-1 flex-1 min-h-0 place-content-start`,children:a.map(T=>e.jsx(qn,{c:T,vehiclesById:i,headerRight:R(T),showBottomCounts:!0,kind:l},T.id))}),a.length===0&&e.jsx("div",{className:"text-[0.8rem] text-gray-500 italic text-center py-4",children:"â€” keine EintrÃ¤ge â€”"})]})}function Qn(){Jn();const[t,a]=r.useState(Zn());r.useEffect(()=>{const v=document.documentElement.style.fontSize||"",A=Math.max(50,Math.min(500,Math.round(t*100)));return document.documentElement.style.fontSize=A+"%",()=>{document.documentElement.style.fontSize=v}},[t]),r.useEffect(()=>{const v=A=>{if(A.key==="ff_font_scale"){const T=parseFloat(A.newValue||"");Number.isFinite(T)&&T>=.5&&T<=5&&a(T)}};return window.addEventListener("storage",v),()=>window.removeEventListener("storage",v)},[]);const[i,l]=r.useState(null),[m,g]=r.useState([]),[h,p]=r.useState(window.innerHeight);r.useEffect(()=>{let v=!0;const A=async()=>{const[q,N]=await Promise.all([ie(),Ze()]);v&&(l(q),g(N))};A();const T=setInterval(A,7e3),z=()=>p(window.innerHeight);return window.addEventListener("resize",z),()=>{v=!1,clearInterval(T),window.removeEventListener("resize",z)}},[]),r.useEffect(()=>{try{const v=new URLSearchParams(window.location.search);if(v.get("print")==="1"||v.get("pdf")==="1"){const A=setTimeout(()=>{window.print()},600);return()=>clearTimeout(A)}}catch{}},[]),r.useEffect(()=>{const v=()=>{try{window.close()}catch{}};return window.addEventListener("afterprint",v),()=>window.removeEventListener("afterprint",v)},[]);const S=r.useMemo(()=>new Map(m.map(v=>[v.id,v])),[m]),f=r.useMemo(()=>{const v={neu:{items:[]},"in-bearbeitung":{items:[]},erledigt:{items:[]}};return i?.columns?i.columns:v},[i]),_=r.useMemo(()=>{let v=0;for(const A of["neu","in-bearbeitung"])for(const T of f[A].items||[])v+=At(T);return v},[f]),P=r.useMemo(()=>{let v=0;for(const A of["neu","in-bearbeitung"])for(const T of f[A].items||[])v+=Mt(T,S);return v},[f,S]),M=r.useMemo(()=>(f.neu.items.length||0)+(f["in-bearbeitung"].items.length||0),[f]),R=r.useMemo(()=>M+(f.erledigt.items.length||0),[M,f]);return i?e.jsx("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden",children:e.jsxs("div",{className:"h-full w-full flex flex-col gap-2",children:[e.jsxs("header",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:"Einsatzstellen-Ãœbersicht-Feuerwehr"}),e.jsxs("div",{className:"text-base md:text-lg font-bold flex flex-wrap gap-4",children:[e.jsxs("span",{children:["ðŸš’ ",_]}),e.jsxs("span",{children:["ðŸ‘¥ ",P]}),e.jsxs("span",{children:["ðŸŸ¡ Aktiv: ",M]}),e.jsxs("span",{children:["ðŸ“¦ Gesamt: ",R]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2 min-h-0 flex-1",children:[e.jsx(Je,{title:"Neu",cards:f.neu.items,vehiclesById:S,kind:"neu",viewportH:h}),e.jsx(Je,{title:"In Bearbeitung",cards:f["in-bearbeitung"].items,vehiclesById:S,kind:"in-bearbeitung",viewportH:h}),e.jsx(Je,{title:"Erledigt",cards:f.erledigt.items,vehiclesById:S,kind:"erledigt",viewportH:h})]})]})}):e.jsx("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden",children:e.jsx("div",{className:"h-full w-full flex items-center justify-center",children:"Ladeâ€¦"})})}function Yn(){const[t]=r.useState(.9);return t}const Xn=t=>`card:${t}`,ve=!0;async function es(t){if(!t||!window.google?.maps?.Geocoder)return null;const a=new google.maps.Geocoder;return new Promise(i=>{a.geocode({address:t,region:"AT"},(l,m)=>{if(m==="OK"&&l&&l[0]){const g=l[0],h=g.geometry?.location;i({lat:h?.lat?.(),lng:h?.lng?.(),formatted:g.formatted_address||t})}else i(null)})})}function ns(){if(Yn(),typeof window<"u"&&window.location.pathname==="/status")return e.jsx(Qn,{});const t=typeof window<"u"&&window.__USER__||null,[a,i]=r.useState(!1);r.useEffect(()=>{qe().then(()=>i(!0))},[]);const l=a&&Qe("einsatzboard"),m=!l,[g,h]=r.useState(null),[p,S]=r.useState([]),[f,_]=r.useState([]),[P,M]=r.useState(""),[R,v]=r.useState(""),[A,T]=r.useState(""),[z,q]=r.useState(null),[N,I]=r.useState(null),[H,$]=r.useState(""),[Z,Y]=r.useState(!1),[Q,ae]=r.useState(!1),[w,de]=r.useState(!1),[F,oe]=r.useState(30),[he,xe]=r.useState(!1),[b,K]=r.useState(!1),[te,W]=r.useState(!1),[U,X]=r.useState(null),ee=n=>{X(n),W(!0)},[j,D]=r.useState(window.location.hash);r.useEffect(()=>{const n=()=>D(window.location.hash);return window.addEventListener("hashchange",n),()=>window.removeEventListener("hashchange",n)},[]);const k=j.replace(/^#/,""),[s,c]=r.useState(()=>new Set),[y,C]=r.useState(0),B=r.useRef(0),V=r.useRef(new Set),[J,G]=r.useState(0);r.useEffect(()=>{document.title="Einsatzstellen-Ãœbersicht-Feuerwehr",pn()},[]);const{logout:ne}=fn?.()||{},ue=async()=>{try{await ne?.()}finally{window.location.href="/user-login"}};r.useEffect(()=>{if(!l)return;if(!w){G(0);return}const n=setInterval(()=>G(o=>o+1),1e3);return()=>clearInterval(n)},[ve,w]);const Ee=w?Math.max(0,F-J%Math.max(1,F)):0,{query:ke,setQuery:Pe,predictions:Ye,getDetailsByPlaceId:Tt,resetSession:Ae,loading:$t,error:Xe}=Et({country:"at",debounceMs:300,minLength:3}),Me=r.useRef(null);r.useEffect(()=>{document.title="Einsatzstellen-Ãœbersicht-Feuerwehr"},[]),r.useEffect(()=>{(async()=>{const[n,o,d]=await Promise.all([ie(),Ze(),An()]);h(n),S(o),_(Array.isArray(d)?d:[]);try{const u=await $n();de(!!u.enabled),oe(Number(u.intervalSec)||30),Te.current=tt(n)}catch{}G(0)})()},[ve]),r.useEffect(()=>{w&&(async()=>{try{(await fetch("/api/ff/status",{credentials:"include",cache:"no-store"}).then(o=>o.json()).catch(()=>({running:!1}))).running||await fetch("/api/ff/start",{method:"POST",credentials:"include"})}catch{}})()},[ve,w,F]),r.useEffect(()=>{v(ke||"")},[ke]),r.useEffect(()=>{let n;const o=Math.max(5,Math.min(60,w?8:15)),d=async()=>{try{const u=new Set(Te.current),x=await ie();h(x),nt({oldIds:u,newBoard:x,pulseMs:8e3})}catch{}n=setTimeout(d,o*1e3)};return n=setTimeout(d,o*1e3),()=>clearTimeout(n)},[ve,w]),r.useEffect(()=>{const n=o=>{o.altKey&&(o.key==="e"||o.key==="E")&&(o.preventDefault(),K(!0),Ae())};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[ve,Ae]);const ce=g??{columns:{neu:{items:[]},"in-bearbeitung":{items:[]},erledigt:{items:[]}}},Dt=10;function Rt(n){try{const o=n?.columns||{};return[(o.neu?.items||[]).length,(o["in-bearbeitung"]?.items||[]).length,(o.erledigt?.items||[]).length].some(u=>u>=Dt)}catch{return!1}}r.useEffect(()=>{const n=Rt(ce);document.documentElement.classList.toggle("ui-dense",n)},[ce]);const[Oe,et]=r.useState(new Set),Te=r.useRef(new Set);r.useEffect(()=>{if(!Oe.size)return;const n=setTimeout(()=>et(new Set),9e3);return()=>clearTimeout(n)},[Oe]);function tt(n){const o=new Set;if(!n?.columns)return o;for(const d of Object.keys(n.columns))for(const u of n.columns[d].items||[])o.add(String(u.id));return o}function nt({oldIds:n,newBoard:o,pulseMs:d=8e3}){const u=Date.now(),x=tt(o),E=new Set;for(const O of x)n.has(O)||E.add(O);const L=new Set([...E].filter(O=>!V.current.has(String(O))));for(const O of E)V.current.delete(String(O));if(L.size>0&&(et(L),C(u+d),u>=B.current))try{Sn()}catch{}Te.current=x}const[_e,st]=r.useState(!1),Lt=async()=>{if(!_e){st(!0);try{const n=new Set(Te.current),o=await fetch("/api/import/trigger",{method:"POST"});if(!o.ok){const u=await o.text().catch(()=>"");throw new Error(`Import fehlgeschlagen (HTTP ${o.status}) ${u}`)}const d=await ie();h(d),nt({oldIds:n,newBoard:d,pulseMs:8e3}),G(0)}catch(n){alert(n.message||"Import fehlgeschlagen.")}finally{st(!1)}}},[Ot,rt]=r.useState(!1),_t=n=>String(n).replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function zt(n,o){const d=String(o).match(/^(.*?)-(\d+)$/),u=d?d[1]:String(o);let x=d?parseInt(d[2],10):1;for(const E of n){const L=String(E.label||"").match(new RegExp("^"+_t(u)+"-(\\d+)$"));if(!L)continue;const O=parseInt(L[1],10);Number.isFinite(O)&&O>x&&(x=O)}return`${u}-${x+1}`}async function Ft(n,o){if(Ot)return;const d=we.get(n);if(d){rt(!0);try{const u=zt(p,d.label||d.id),x=await fetch("/api/vehicles",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ort:d.ort||"",label:u,mannschaft:0})}),E=await x.json().catch(()=>({}));if(!x.ok||E?.error)throw new Error(E?.error||"Clone fehlgeschlagen");const O=await(await fetch("/api/vehicles")).json();S(O);let re=E?.vehicle?.id;re||(re=O.find(ye=>ye.label===u&&ye.ort===(d.ort||"")&&Number(ye.mannschaft)===0)?.id),o&&re&&await He(o,re),h(await ie())}catch(u){alert(u.message||"Clone fehlgeschlagen")}finally{rt(!1)}}}const we=r.useMemo(()=>new Map(p.map(n=>[n.id,n])),[p]),[at,it]=r.useState(new Map),Vt=r.useMemo(()=>{const n={};for(const[o,d]of we.entries())n[o]=d;return n},[we]),ot=r.useMemo(()=>{const n=new Set,o=ce?.columns||{};for(const d of Object.keys(o))for(const u of o[d].items||[])for(const x of u.assignedVehicles||[])n.add(x);return n},[ce]),je=r.useMemo(()=>p.filter(n=>n&&typeof n.id<"u"&&!ot.has(n.id)),[p,ot]),ge=r.useMemo(()=>{const n={};for(const o of je){const d=o.ort||"Unbekannt";(n[d]??=[]).push(o)}for(const o of Object.keys(n))n[o].sort((d,u)=>(d.label||d.id).localeCompare(u.label||u.id));return Object.entries(n).sort((o,d)=>o[0].localeCompare(d[0]))},[je]);r.useEffect(()=>{if(localStorage.getItem("ff_collapsed_groups")||!ge.length)return;const o=ge.map(([d])=>d);$e(new Set(o)),localStorage.setItem("ff_collapsed_groups",JSON.stringify(o))},[ve,ge]),r.useEffect(()=>{let n=setInterval(async()=>{try{const o=await fetch("/api/activity/status",{cache:"no-store"}).then(d=>d.json());typeof o?.auto?.enabled=="boolean"&&o.auto.enabled!==w&&de(!!o.auto.enabled)}catch{}},3e3);return()=>clearInterval(n)},[ve,w]);function ze(n,o){for(const d of["neu","in-bearbeitung","erledigt"])if((n.columns[d].items||[]).some(u=>u?.id===o))return d;return null}function Bt(n,o){for(const d of["neu","in-bearbeitung","erledigt"]){const u=(n.columns[d].items||[]).find(x=>x?.id===o);if(u)return u}return null}function Fe(n){const o=ce?.columns?.[n]?.items||[];if(n==="erledigt"){const x=o.reduce((L,O)=>L+(O.everVehicles?.length||0),0),E=o.reduce((L,O)=>L+(Number.isFinite(O?.everPersonnel)?O.everPersonnel:0),0);return{cards:o.length,units:x,persons:E}}const d=o.reduce((x,E)=>x+(E.assignedVehicles?.length||0),0),u=o.reduce((x,E)=>Number.isFinite(E?.manualPersonnel)?x+E.manualPersonnel:x+(E.assignedVehicles||[]).reduce((L,O)=>L+(we.get(O)?.mannschaft??0),0),0);return{cards:o.length,units:d,persons:u}}const Kt=Fe("neu"),Ut=Fe("in-bearbeitung"),Ht=Fe("erledigt"),Gt=async()=>{const n=A.replace(/^T\d+\s*,?\s*/i,"").trim(),o=(P||n).trim();if(!o){alert("Bitte Typ oder Titel angeben.");return}const d={id:`tmp-${Math.random().toString(36).slice(2,10)}`,content:o,createdAt:new Date().toISOString(),statusSince:new Date().toISOString(),assignedVehicles:[],everVehicles:[],everPersonnel:0,ort:(R||"").trim(),typ:A.trim()};Y(!0),h(u=>{if(!u)return u;const x=structuredClone(u);return x.columns.neu.items.unshift(d),x});try{let u=null;const x=Me.current;if(x?.geometry?.location?.lat&&x?.geometry?.location?.lng)u={lat:x.geometry.location.lat(),lng:x.geometry.location.lng()};else if(d.ort){const L=await es(d.ort);L&&(u={lat:L.lat,lng:L.lng})}const E=await ut(o,"neu",0,d.ort,d.typ,u??void 0);B.current=Date.now(),E?.card?.id!=null&&V.current.add(String(E.card.id)),h(L=>{if(!L)return L;const O=structuredClone(L),re=O.columns.neu.items,Se=re.findIndex(ye=>ye?.id===d.id);return Se>=0?re[Se]=E.card:re.unshift(E.card),O}),M(""),Pe(""),v(""),T(""),Me.current=null,Ae()}catch{h(u=>{if(!u)return u;const x=structuredClone(u);return x.columns.neu.items=x.columns.neu.items.filter(E=>E?.id!==d.id),x}),alert("Einsatz konnte nicht angelegt werden.")}finally{Y(!1)}},Wt=async n=>{try{const o=await Tt(n.place_id,["formatted_address","geometry","address_components","place_id"]);Me.current=o||null;const d=o?.formatted_address||n.description;Pe(d),v(d)}catch(o){console.error("Place details failed:",o),Me.current=null,Pe(n.description),v(n.description)}finally{Ae()}},Ve=n=>String(n||"").split(/[;,\n]/).map(o=>o.trim()).filter(Boolean),me=n=>String(n||"").normalize?.("NFD").replace?.(new RegExp("\\p{Diacritic}","gu"),"").replace(/^\s*FF\s+/i,"").replace(/[._\-\/]+/g," ").replace(/\s+/g," ").toLowerCase().trim();function Jt(n,o,d,u){const x=Ve(n?.alerted).map(me);if(x.length)for(const E of o){const L=x.some(re=>me(E?.ort)===re),O=x.some(re=>me(E?.label)===re);if(L||O){const re=String(E.id);d.add(re),u.has(re)||u.set(re,null)}}}async function Zt(n,o){if(!(o!=="neu"||!n?.id))try{const d=await Rn(n.id),u=new Set((d?.units||[]).map(se=>String(se.unitId)));if(n?.alerted){const se=Ve(n.alerted).map(me);for(const pe of je){const Ke=se.some(Ue=>me(pe.ort)===me(Ue)),Ce=se.some(Ue=>me(pe.label)===me(Ue));(Ke||Ce)&&u.add(String(pe.id))}}c(u),C(Date.now()+3e3);const x=new Map;for(const se of d?.units||[]){const pe=Number(se?.distanceKm);x.set(String(se.unitId),Number.isFinite(pe)?pe:null)}u.size===0&&n?.alerted&&Jt(n,je,u,x),it(x);const E=new Set((d?.units||[]).filter(se=>!se.assigned).map(se=>String(se.unitId))),L=new Set(je.map(se=>String(se.id))),O=new Set([...E,...[...u].filter(se=>L.has(se))]),re=Ve(n?.alerted).map(me),Se=new Set;if(re.length&&je.length>0)for(const[se,pe]of ge){if(pe.length===0)continue;re.some(Ce=>me(se)===me(Ce))&&Se.add(se)}const ye=[];for(const[se,pe]of ge)(pe.some(Ce=>O.has(String(Ce.id)))||Se.has(se))&&ye.push(se);Yt(ye),clearTimeout(pulseTimerRef.current),pulseTimerRef.current=setTimeout(()=>{c(new Set),C(0),it(new Map)},3200)}catch(d){console.error("fetchNearby failed:",d)}}const[lt,$e]=r.useState(()=>{try{const n=localStorage.getItem("ff_collapsed_groups");return new Set(n?JSON.parse(n):[])}catch{return new Set}}),qt=n=>lt.has(n),Qt=(n,o)=>{$e(d=>{const u=new Set(d);return o?u.add(n):u.delete(n),localStorage.setItem("ff_collapsed_groups",JSON.stringify([...u])),u})},Yt=(n=[])=>{$e(()=>{const o=ge.map(([u])=>u),d=new Set(o);for(const u of n)d.delete(u);return localStorage.setItem("ff_collapsed_groups",JSON.stringify([...d])),d})},Xt=(n=!0)=>{$e(()=>{const o=ge.map(([u])=>u),d=n?new Set(o):new Set;return localStorage.setItem("ff_collapsed_groups",JSON.stringify([...d])),d})},en=()=>{const n=ge.map(([d])=>d),o=n.length>0&&n.every(d=>lt.has(d));Xt(!o)},[De,Be]=r.useState(null),[tn,Ne]=r.useState(null),nn=xn(ct(Cn,{activationConstraint:{distance:4}}),ct(kn,{activationConstraint:{delay:80,tolerance:6}})),sn=n=>{const o=n?.over;if(!o){Ne(null);return}const d=String(o.id||"");if(d.startsWith("col:"))Ne(d.slice(4));else if(d.startsWith("card:")){const u=ze(ce,d.slice(5));Ne(u)}else Ne(null)},rn=async n=>{if(m){Ne(null),Be(null);return}Ne(null);const{active:o,over:d}=n;if(Be(null),!o||!d)return;const u=String(o.id||""),x=String(d.id||"");if(u.startsWith("ass:")&&x.startsWith("card:")){const[,E,L]=u.split(":"),O=x.slice(5);if(E&&L&&O&&E!==O)try{await mt(E,L);try{await pt(L)}catch{}await He(O,L),h(await ie())}catch{alert("Einheit konnte nicht umgehÃ¤ngt werden.")}return}if(u.startsWith("veh:")&&x.startsWith("card:")){try{await He(x.slice(5),u.slice(4)),h(await ie())}catch{alert("Einheit konnte nicht zugewiesen werden.")}return}if(u.startsWith("card:")){const E=u.slice(5),L=ze(ce,E);if(!L)return;if(x.startsWith("col:")){const O=x.slice(4);if(L!==O)try{await Re({cardId:E,from:L,to:O,toIndex:0}),h(await ie())}catch{alert("Statuswechsel konnte nicht gespeichert werden.")}return}if(x.startsWith("card:")){const O=ze(ce,x.slice(5));if(O)try{await Re({cardId:E,from:L,to:O,toIndex:0}),h(await ie())}catch{alert("Statuswechsel konnte nicht gespeichert werden.")}}}},an=async()=>{if(confirm("Board wirklich zurÃ¼cksetzen?")){ae(!0);try{await Tn(),h(await ie())}catch{alert("Reset fehlgeschlagen.")}finally{ae(!1)}}},on=()=>window.open(Dn(),"_blank","noopener,noreferrer"),ln=async()=>{try{const n=await ht({enabled:!w,intervalSec:F});de(!!n.enabled),oe(Number(n.intervalSec)||30),G(0)}catch{alert("Konnte Auto-Import nicht Ã¤ndern.")}},cn=async n=>{const o=Math.max(5,Math.min(3600,Number(n)||30));oe(o);try{await ht({enabled:w,intervalSec:o}),G(0)}catch{}},dn=async({title:n,ort:o,typ:d})=>{const u=await ut(n,"neu",0,o,d);B.current=Date.now(),u?.card?.id!=null&&V.current.add(String(u.card.id)),h(x=>{if(!x)return x;const E=structuredClone(x);return E.columns.neu.items.unshift(u.card),E})},un=n=>{T(n);const o=n.replace(/^T\d+\s*,?\s*/i,"").trim();P.trim()||M(o)};if(k.startsWith("/protokoll/edit/")){const n=k.split("/")[3],o=Number(n);return e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Protokoll â€“ Bearbeiten"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"Zur Ãœbersicht"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(kt,{mode:"edit",editNr:o})})]})}return k.startsWith("/protokoll/neu")?e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Protokoll â€“ Eintrag anlegen"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"Zur Ãœbersicht"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(kt,{mode:"create"})})]}):k.startsWith("/protokoll")?e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Protokoll"}),e.jsx("button",{onClick:()=>{window.location.hash="/"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"â† ZurÃ¼ck"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(Gn,{})})]}):e.jsxs("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden flex flex-col",style:{fontSize:"var(--ui-scale)"},children:[!g&&e.jsx("div",{className:"fixed inset-0 z-10 bg-black/10 backdrop-blur-sm flex items-center justify-center",children:e.jsx("div",{className:"px-4 py-2 rounded-lg bg-white shadow",children:"Ladeâ€¦"})}),e.jsxs("header",{className:"flex flex-wrap items-center justify-between gap-2 mb-2",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:"Einsatzstellen-Ãœbersicht-Feuerwehr"}),e.jsxs("div",{className:"toolbar flex flex-wrap items-center gap-2",children:[e.jsx("button",{onClick:on,className:"px-3 py-1.5 rounded-md bg-purple-600 hover:bg-purple-700 text-white",children:"PDF"}),e.jsx("button",{onClick:ue,className:"px-3 py-1.5 rounded-md border border-gray-300 hover:bg-gray-100",title:t?.displayName?`Logout (${t.displayName})`:"Logout",children:"Logout"}),e.jsx("button",{onClick:()=>window.open("/api/log.csv","_blank"),className:"px-3 py-1.5 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white",title:"log.csv herunterladen",children:"LogÂ (CSV)"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-500 hover:bg-gray-600 text-white",children:"Protokoll"}),e.jsx("button",{onClick:Lt,disabled:m||_e,className:"px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-60",title:"Import sofort ausfÃ¼hren",children:_e?"Importâ€¦":"Import"}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm px-2 py-1 rounded-md bg-white border",children:[e.jsx("input",{type:"checkbox",checked:w,onChange:ln,disabled:m})," Auto-Import"]}),e.jsxs("label",{className:"interval-capsule flex items-center text-sm text-gray-700 bg-gray-50 border border-gray-300 rounded-md overflow-hidden",children:[e.jsx("span",{className:"pl-3 pr-2 select-none",children:"IntervallÂ (s):"}),e.jsx("input",{type:"number",min:"5",max:"3600",value:F,onChange:n=>cn(n.target.value),disabled:m,className:`h-9 w-20 bg-white border-0 rounded-none text-center text-gray-800 
               focus:outline-none focus:ring-0 focus:border-0`})]}),e.jsx(Wn,{autoEnabled:w,remaining:Ee,disabled:m}),e.jsx("button",{onClick:an,disabled:m||Q,className:`px-3 py-1.5 rounded-md text-white ${Q?"bg-gray-400":"bg-gray-700 hover:bg-gray-800"}`,children:Q?"Resetâ€¦":"Reset"})]})]}),e.jsxs("section",{className:"mb-2 grid grid-cols-1 md:grid-cols-7 gap-2",children:[e.jsxs("select",{className:"border rounded px-2 py-1 md:col-span-2",value:A,onChange:n=>un(n.target.value),children:[e.jsx("option",{value:"",children:"â€” Typ auswÃ¤hlen â€”"}),f.map(n=>e.jsx("option",{value:n,children:n},n))]}),e.jsx("input",{className:"border rounded px-2 py-1 md:col-span-2",placeholder:"Titel (wird aus Typ Ã¼bernommen)",value:P,onChange:n=>M(n.target.value)}),e.jsxs("div",{className:"relative md:col-span-2",children:[e.jsx("input",{className:"border rounded px-2 py-1 w-full",placeholder:"Ort (nur Ã–sterreich)",autoComplete:"off",value:ke,onChange:n=>Pe(n.target.value)}),$t&&e.jsx("div",{className:"absolute z-10 mt-1 text-xs text-gray-500 bg-white border rounded px-2 py-1",children:"Sucheâ€¦"}),Xe&&e.jsxs("div",{className:"absolute z-10 mt-1 text-xs text-red-600 bg-white border rounded px-2 py-1",children:["Fehler: ",String(Xe)]}),!!Ye.length&&e.jsx("ul",{className:"absolute z-10 mt-1 w-full max-h-52 overflow-auto bg-white border rounded shadow",children:Ye.map(n=>e.jsx("li",{className:"px-2 py-1 hover:bg-gray-100 cursor-pointer text-sm",onClick:()=>Wt(n),title:n.description,children:n.description},n.place_id))})]}),e.jsx("button",{className:"px-3 py-1 rounded bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60",disabled:m||Z,onClick:Gt,children:Z?"Wird angelegtâ€¦":"Einsatz anlegen"})]}),e.jsxs(bn,{sensors:nn,collisionDetection:n=>n?.active?.data?.current?.type==="vehicle"?yn(n):wn(n),onDragStart:n=>Be({type:n?.active?.data?.current?.type,id:n.active.id,data:n?.active?.data?.current}),onDragOver:sn,onDragEnd:rn,children:[e.jsxs("main",{className:"grid grid-cols-1 md:[grid-template-columns:minmax(180px,220px)_repeat(3,minmax(0,1fr))] gap-2 min-h-0 flex-1 overflow-hidden",children:[e.jsxs("section",{className:"bg-white rounded-xl shadow p-3 h-full flex flex-col min-h-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-semibold",children:e.jsx("button",{type:"button",onClick:en,title:"Alle Gruppen auf/zu klappen",className:"underline decoration-dotted hover:opacity-80 focus:outline-none",children:"Einheiten (frei)"})}),l&&e.jsx("button",{onClick:()=>xe(!0),className:"px-2 py-1 text-sm rounded bg-emerald-600 text-white",children:"+ Einheit"})]}),e.jsxs("div",{className:"overflow-auto pr-1 flex-1 min-h-0 space-y-3",children:[ge.length===0&&e.jsx("div",{className:"text-[0.85rem] text-gray-500 italic",children:"â€” alle Einheiten sind zugewiesen â€”"}),ge.map(([n,o])=>{const d=qt(n);return e.jsxs("div",{className:"border border-blue-400 rounded-md",children:[e.jsxs("button",{type:"button",onClick:()=>Qt(n,!d),className:"w-full flex items-center justify-between px-2 py-2 text-left",title:d?"aufklappen":"zuklappen",children:[e.jsx("span",{className:"text-xs font-semibold text-gray-700",children:n}),e.jsx("span",{className:"group-chip",children:o.length})]}),!d&&e.jsx("div",{className:"px-2 pb-2 grid grid-cols-1 gap-1.5",children:o.map(u=>e.jsx(En,{editable:l,vehicle:u,pillWidthPx:160,near:s.has(String(u.id))&&Date.now()<y,distKm:at.get(String(u.id))},u.id))})]},n)})]})]}),[{id:"neu",title:"Neu",bg:"bg-red-100",totals:Kt},{id:"in-bearbeitung",title:"In Bearbeitung",bg:"bg-yellow-100",totals:Ut},{id:"erledigt",title:"Erledigt",bg:"bg-green-100",totals:Ht}].map(({id:n,title:o,bg:d,totals:u})=>e.jsx("div",{className:tn===n?"drag-over":"",children:e.jsx(Kn,{editable:l,colId:n,bg:d,title:e.jsxs("span",{className:"column-header flex items-center justify-between",children:[e.jsx("span",{className:"font-semibold",children:o}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsxs("span",{className:"kpi-badge","data-variant":"units",children:["ðŸš’ ",u.units]}),e.jsxs("span",{className:"kpi-badge","data-variant":"persons",children:["ðŸ‘¥ ",u.persons]}),e.jsxs("span",{className:"kpi-badge","data-variant":"cards",children:["â¬› ",u.cards]})]})]}),children:e.jsx("ul",{className:"space-y-2 overflow-y-auto overflow-x-hidden pl-1 pr-2 py-2",style:{maxHeight:"calc(100vh - 260px)"},children:e.jsx(vn,{items:(ce.columns[n].items||[]).map(x=>Xn(x.id)),strategy:jn,children:(ce.columns[n].items||[]).map(x=>e.jsx(In,{editable:l,card:x,colId:n,vehiclesById:we,distById:at,pillWidthPx:160,pulse:Oe.has(String(x.id))&&Date.now()<y,onUnassign:async(E,L)=>{await mt(E,L);try{await pt(L)}catch{}h(await ie())},onOpenMap:E=>q({address:x.ort,card:x,board:ce,vehiclesById:Vt}),onAdvance:l?async E=>{n==="neu"?(await Re({cardId:E.id,from:"neu",to:"in-bearbeitung",toIndex:0}),h(await ie())):n==="in-bearbeitung"&&(await Re({cardId:E.id,from:"in-bearbeitung",to:"erledigt",toIndex:0}),h(await ie()))}:void 0,onEditPersonnelStart:l?(E,L)=>{I({cardId:E.id}),$(L)}:void 0,editing:N,editingValue:H,setEditingValue:$,onEditPersonnelSave:l?async E=>{try{await Mn(E.id,H===""?null:Number(H)),h(await ie())}finally{I(null),$("")}}:void 0,onEditPersonnelCancel:l?()=>{I(null),$("")}:void 0,onClone:Ft,onVehiclesIconClick:Zt,nearIds:s,nearUntilMs:y,onShowInfo:ee},x.id))})})})},n))]}),e.jsxs(Nn,{dropAnimation:{duration:180,easing:"ease-out"},children:[De?.type==="vehicle"&&(()=>{const n=we.get(De?.data?.vehicleId);return n?e.jsx("div",{className:"pointer-events-none",children:e.jsxs("div",{style:{width:160},className:"max-w-full select-none border-2 border-red-300 rounded-2xl bg-white px-2 py-1 shadow-lg",children:[e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:n.label||n.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate",children:[n.ort||"â€”"," Â· ðŸ‘¥ ",n.mannschaft??0]})]})}):null})(),De?.type==="card"&&(()=>{const n=String(De?.id||"").replace(/^card:/,""),o=Bt(ce,n);return o?e.jsx("div",{className:"pointer-events-none w-[280px]",children:e.jsxs("div",{className:"rounded-lg bg-white shadow-xl border p-3",children:[e.jsx("div",{className:"font-semibold text-sm mb-1 truncate",children:o.content}),e.jsxs("div",{className:"text-xs text-gray-600",children:[o.assignedVehicles?.length||0," Einheiten â€¢"," ","ðŸ‘¥ ",Number.isFinite(o?.manualPersonnel)?o.manualPersonnel:(o.assignedVehicles||[]).reduce((d,u)=>d+(we.get(u)?.mannschaft??0),0)]})]})}):null})()]})]}),l&&e.jsx("button",{className:"fab",title:"Einsatz anlegen",onClick:()=>K(!0),children:"ï¼‹"}),e.jsx("a",{href:"/Hilfe.pdf",target:"_blank",rel:"noopener noreferrer",className:"fixed bottom-4 right-4 px-4 py-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-lg",children:"Hilfe"}),he&&e.jsx(Fn,{onClose:()=>xe(!1),onCreate:async n=>{const o=await fetch("/api/vehicles",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!o.ok){const d=await o.text().catch(()=>String(o.status));throw new Error(`HTTP ${o.status} ${d}`)}S(await Ze())}}),b&&e.jsx(Bn,{onClose:()=>K(!1),onCreate:dn,types:f}),z&&e.jsx(zn,{context:z,onClose:()=>q(null)}),e.jsx(Un,{open:te,info:U||{},onClose:()=>{W(!1),X(null)}})]})}export{ns as default};
