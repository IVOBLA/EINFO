import{u as Un,j as e,R as Os,r as a,a as Vs,C as Us,s as yn,b as jt,c as Hs,d as Hn,e as Ks,l as wn,f as Gs,g as Ws,h as qs,i as Ce,k as Be,m as Zs,n as vn,o as Sn,p as Gt,q as Js,t as Qs,v as Ys,w as Xs,x as Nn,y as er,z as tr,A as nr,B as sr,D as jn,E as wt,P as Cn,S as kn,F as rr,G as ar,H as ir,I as or,J as lr,K as cr,L as ct,M as An,N as In,O as dr,Q as En,T as Mn,U as Wt,V as ur,W as fr,X as mr,Y as hr,Z as gr,_ as pr,$ as br}from"./index-C-R8BaZ5.js";function Pn({cardId:n,vehicle:o,pillWidthPx:s=160,onUnassign:c,onClone:u,near:p=!1,distKm:f=null,readonly:v=!1}){const N=`ass:${n}:${o.id}`,{attributes:P,listeners:E,setNodeRef:D,transform:C,isDragging:R}=Un({id:N,data:{type:"assigned",vehicleId:o.id,fromCardId:n},disabled:v}),_={width:s,transform:C?`translate3d(${C.x}px, ${C.y}px, 0)`:void 0};return e.jsxs("div",{ref:D,style:_,...P,...E,className:`relative self-start border-2 rounded-2xl bg-white px-2 pr-9 py-1 shadow-sm
                  select-none ${v?"cursor-not-allowed":"cursor-grab active:cursor-grabbing"}
                  ${p?"border-emerald-500 ring-2 ring-emerald-300":"border-red-300"}
                  ${R?"opacity-50":""}`,title:v?"Einheit kann derzeit nicht verschoben werden":"Ziehen: auf andere Karte verschieben Â· Doppelklick: klonen",onDoubleClick:()=>{v||u?.(o.id,n)},"aria-disabled":v,children:[p&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-0.5 rounded-2xl border-2 border-emerald-400/50 animate-ping"}),e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:o.label||o.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate flex justify-between items-center",children:[e.jsxs("span",{children:[o.ort||"â€”"," Â· ðŸ‘¥ ",o.mannschaft??0]}),p&&Number.isFinite(Number(f))&&e.jsxs("span",{className:"absolute top-1 right-8 text-[11px] tabular-nums text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded whitespace-nowrap",children:[Number(f)," Km"]})]}),!v&&e.jsx("button",{type:"button",onMouseDown:S=>S.stopPropagation(),onTouchStart:S=>S.stopPropagation(),onClick:S=>{S.stopPropagation(),c?.(n,o.id)},title:"Einheit entfernen",className:"absolute right-2 top-1/2 -translate-y-1/2 h-6 w-6 rounded-full bg-red-600 text-white shadow flex items-center justify-center","aria-label":"Einheit entfernen",children:e.jsx("svg",{viewBox:"0 0 12 12",width:"12",height:"12","aria-hidden":"true",children:e.jsx("path",{d:"M1 1 L11 11 M11 1 L1 11",stroke:"white",strokeWidth:"2",strokeLinecap:"round"})})})]})}const Tn=n=>{const o=String(n||"");return o?/^B/i.test(o)?`B${o.slice(1)}`:/^[A-Za-z]/.test(o)?`B${o.slice(1)}`:`B${o}`:""},xr=Os.memo(function(o){const{card:s,colId:c,vehiclesById:u,pillWidthPx:p=160,onUnassign:f,onOpenMap:v,onAdvance:N,onEditPersonnelStart:P,editing:E,editingValue:D,setEditingValue:C,onEditPersonnelSave:R,onEditPersonnelCancel:_,onClone:S,onVehiclesIconClick:j,onShowInfo:m,areaOptions:g=[],areaLabelById:$=new Map,areaColorById:T=new Map,onAreaChange:k,onEditCard:G,nearIds:z,nearUntilMs:U,distById:ne,pulse:ie,editable:W=!0}=o,[V,q]=a.useState(!1),[X,de]=a.useState(!1),ce=a.useRef((s.assignedVehicles||[]).length),se=a.useRef(null),A=a.useRef(null),me=Date.now()<(U||0);a.useEffect(()=>{q(!1)},[c]),a.useEffect(()=>()=>{A.current&&(clearTimeout(A.current),A.current=null)},[]);const{attributes:O,listeners:J,setNodeRef:he,transform:re,transition:Ne,isDragging:ge}=Vs({id:`card:${s.id}`,data:{type:"card",cardId:s.id},disabled:!W}),I=a.useMemo(()=>{if(!s)return null;const y=typeof s.areaColor=="string"&&s.areaColor?s.areaColor:null;if(s.isArea)return y;if(!s.areaCardId)return null;if(y)return y;const te=String(s.areaCardId);if(T.has(te))return T.get(te)||null;const Ie=(g||[]).find(pe=>String(pe.id)===te);return Ie?.color?Ie.color:null},[s,T,g]),Z={transform:Us.Transform.toString(re),transition:Ne,opacity:ge?.8:1,borderColor:I||void 0,borderWidth:I?"2px":void 0},ae=c==="erledigt"?s.everVehicles?.length||0:s.assignedVehicles?.length||0,ue=a.useMemo(()=>(s.assignedVehicles||[]).map(y=>u.get(y)).filter(Boolean),[s,u]),we=a.useMemo(()=>c==="erledigt"?Number.isFinite(s?.everPersonnel)?s.everPersonnel:0:Number.isFinite(s?.manualPersonnel)?s.manualPersonnel:ue.reduce((y,te)=>y+(te?.mannschaft??0),0),[c,s,ue]);a.useEffect(()=>{if(c!=="in-bearbeitung"||!me)return;(s.assignedVehicles||[]).some(te=>z?.has(String(te)))&&q(!0)},[c,me,z,s.assignedVehicles]),a.useEffect(()=>{if(c!=="in-bearbeitung")return;const y=(s.assignedVehicles||[]).length,te=ce.current;y>te&&q(!0),ce.current=y},[c,s.assignedVehicles]),a.useEffect(()=>{if(c==="in-bearbeitung"&&V&&se.current)try{se.current.scrollIntoView({behavior:"smooth",block:"nearest"})}catch{}},[c,V]);const be=()=>{c==="neu"?typeof j=="function"&&j(s,c):(c==="in-bearbeitung"||c==="erledigt")&&q(y=>!y)},oe=()=>{W&&typeof P=="function"&&P(s,we)},ve=s?.isEditable!==!1,Q=a.useMemo(()=>s?.humanId?s?.isArea?Tn(s.humanId):String(s.humanId):"",[s?.humanId,s?.isArea]),Y=y=>{if(!y)return"";const te=y.humanId?String(y.humanId):"",Ie=y.isArea?Tn(te):te,pe=y.content?String(y.content):"";return[Ie,pe].filter(Boolean).join(" â€“ ")||Ie||pe||""},le=a.useMemo(()=>{if(s?.isArea)return Y(s);if(!s?.areaCardId)return"";const y=String(s.areaCardId),te=$.get(y);if(te)return te;const Ie=(g||[]).find(pe=>String(pe.id)===y);return Ie?Ie.label:String(s.areaCardId)},[s,$,g]),F=a.useMemo(()=>(g||[]).filter(y=>String(y.id)!==String(s.id)),[g,s.id]),ee=W&&!s.isArea&&typeof k=="function",Se=s.areaCardId?String(s.areaCardId):"",je=y=>{ee&&k(s,y)},Te=X||V,Ee=()=>{A.current&&clearTimeout(A.current),A.current=setTimeout(()=>{de(!0),A.current=null},300)},ke=()=>{A.current&&(clearTimeout(A.current),A.current=null),de(!1)},fe=()=>{A.current&&(clearTimeout(A.current),A.current=null),de(!0)},Le=()=>{A.current&&(clearTimeout(A.current),A.current=null),de(!1)},Re=s.isArea?"bg-slate-100 border-slate-200":"bg-white",Me=s.isArea?"bg-slate-200 hover:bg-slate-300":"bg-white hover:bg-gray-50",Ge=s.isArea?"bg-slate-200 hover:bg-slate-300":"bg-white hover:bg-red-50";return e.jsxs("li",{ref:he,style:Z,tabIndex:0,className:`relative rounded-lg shadow border transition mx-1 focus:outline-none ${Re} ${ie&&c==="neu"?"ring-2 ring-red-400/60":""}`,onMouseEnter:Ee,onMouseLeave:ke,onFocus:fe,onBlur:Le,children:[ie&&c==="neu"&&e.jsxs(e.Fragment,{children:[e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 rounded-lg bg-red-500/10 animate-pulse-inner"}),e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 rounded-lg animate-ping-safe"})]}),e.jsxs("div",{className:`p-3 select-none ${s.isArea?"bg-slate-100 rounded-lg":""}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",...O,...J,children:[e.jsxs("div",{className:"min-w-0",children:[Q&&e.jsxs("div",{className:"text-[11px] font-semibold uppercase tracking-wide text-gray-500",children:["Einsatz: ",Q]}),s.isArea&&e.jsx("div",{className:"text-[11px] font-semibold uppercase tracking-wide text-emerald-600",children:"Abschnitt"}),e.jsx("div",{className:"font-semibold text-sm leading-5 truncate",children:s.content}),!!s.ort&&e.jsx("button",{type:"button",onClick:()=>v?.(s.ort),className:"text-[12px] text-blue-700 hover:underline truncate",title:"Ort in Karte Ã¶ffnen",children:s.ort})]}),e.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[e.jsxs("button",{type:"button",title:c==="neu"?"Nahe Einheiten prÃ¼fen":"Einheiten auf-/zuklappen",className:`px-2 py-1 rounded text-[12px] border flex items-center gap-1 ${Ge}`,onPointerDown:y=>y.stopPropagation(),onClick:y=>{y.stopPropagation(),y.preventDefault(),be()},children:["ðŸš’ ",ae,(c==="in-bearbeitung"||c==="erledigt")&&e.jsx("span",{children:V?"â–¾":"â–¸"})]}),e.jsxs("button",{type:"button",className:`px-2 py-1 rounded text-[12px] border ${Me}`,title:"Personalzahl bearbeiten",onPointerDown:y=>y.stopPropagation(),onClick:y=>{y.stopPropagation(),oe()},children:["ðŸ‘¥ ",we]}),W&&N&&e.jsx("button",{type:"button",onPointerDown:y=>y.stopPropagation(),onClick:y=>{y.stopPropagation(),N(s)},className:`ml-1 px-2 py-1 rounded text-[12px] border ${Me}`,title:"weiter",children:"âž”"})]})]}),e.jsx("div",{className:`mt-0 overflow-hidden transition-all duration-200 ease-in-out ${Te?"max-h-[2000px] opacity-100 pointer-events-auto":"max-h-0 opacity-0 pointer-events-none"}`,children:e.jsxs("div",{className:"pt-2 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-[12px]",children:[e.jsx("span",{className:"text-gray-600 whitespace-nowrap",children:"Abschnitt"}),ee?e.jsxs("select",{className:"border rounded px-2 py-1 text-[12px] min-w-[140px]",value:Se,onChange:y=>je(y.target.value),onPointerDown:y=>y.stopPropagation(),children:[e.jsx("option",{value:"",children:"â€” Abschnitt auswÃ¤hlen â€”"}),F.map(y=>e.jsx("option",{value:y.id,children:y.label},y.id))]}):e.jsx("span",{className:"font-medium text-gray-800",children:le||"â€”"})]}),c==="neu"&&!!ue.length&&e.jsx("div",{className:"flex flex-wrap gap-1.5",children:ue.map(y=>{const te=y?.available!==!1,Ie=y?.groupAvailable!==!1,pe=!W||!te||!Ie;return e.jsx(Pn,{cardId:s.id,vehicle:y,pillWidthPx:p,onUnassign:f,onClone:S,near:!!z&&me&&z.has(String(y.id)),readonly:pe,distKm:ne?.get(String(y.id))??null},`ass-${s.id}-${y.id}`)})}),c==="in-bearbeitung"&&V&&!!ue.length&&e.jsx("div",{ref:se,className:"flex flex-wrap gap-1.5",children:ue.map(y=>{const te=y?.available!==!1,Ie=y?.groupAvailable!==!1,pe=!W||!te||!Ie;return e.jsx(Pn,{cardId:s.id,vehicle:y,pillWidthPx:p,onUnassign:f,onClone:S,near:!!z&&me&&z.has(String(y.id)),readonly:pe,distKm:ne?.get(String(y.id))??null},`ass-${s.id}-${y.id}`)})}),c==="erledigt"&&V&&!!s.everVehicles?.length&&e.jsx("ul",{className:"text-sm text-gray-700 list-disc list-inside space-y-1",children:s.everVehicles.map(y=>{const te=u.get(y),Ie=String(y),pe=s?.everVehicleLabels?.[Ie],We=typeof pe=="string"?pe:pe?.label,Oe=typeof pe=="object"&&pe?pe.ort:null,st=te?.label||We||te?.id||"Unbekannt",qe=te?.ort??Oe??null,It=qe?` (${qe})`:"";return e.jsxs("li",{children:[st,It]},y)})}),W&&E?.cardId===s.id&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",className:"w-20 border rounded px-2 py-1 text-sm",value:D,onChange:y=>C(y.target.value),placeholder:"Personen"}),e.jsx("button",{className:"px-2 py-1 text-sm rounded bg-emerald-600 text-white",onClick:()=>R(s),children:"Speichern"}),e.jsx("button",{className:"px-2 py-1 text-sm rounded bg-gray-200",onClick:_,children:"Abbrechen"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[W&&ve&&typeof G=="function"&&e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Bearbeiten",onPointerDown:y=>y.stopPropagation(),onClick:y=>{y.stopPropagation(),G(s)},children:"âœŽ"}),e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Ort in Karte Ã¶ffnen",onPointerDown:y=>y.stopPropagation(),onClick:y=>{y.stopPropagation(),v?.(s.ort)},children:"Karte"}),e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Einsatz-Info",onPointerDown:y=>y.stopPropagation(),onClick:y=>{y.stopPropagation(),m?.(s)},children:"?"})]})]})})]})]})});function yr({vehicle:n,pillWidthPx:o=160,near:s=!1,distKm:c=null,editable:u=!0}){const p=`veh:${n.id}`,f=n?.available!==!1,v=n?.groupAvailable!==!1,N=u&&f&&v,{attributes:P,listeners:E,setNodeRef:D,transform:C,isDragging:R}=Un({id:p,data:{type:"vehicle",vehicleId:n.id},disabled:!N}),_=!f||!v,S={width:o,transform:C?`translate3d(${C.x}px, ${C.y}px, 0)`:void 0};return _&&!R&&(S.opacity=.6),e.jsxs("div",{ref:D,style:S,...P,...E,className:`relative max-w-full select-none border-2 ${s?"border-emerald-500":"border-red-300"} rounded-2xl bg-white
                 px-2 py-1 shadow-sm
                 ${N?"cursor-grab active:cursor-grabbing":"cursor-not-allowed"}
                 ${R?"opacity-50":""}
                 ${_?"border-gray-200 bg-gray-100":""}`,"aria-disabled":!N,children:[s&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-0.5 rounded-2xl border-2 border-emerald-400/50 animate-ping"}),e.jsx("div",{className:`text-[13px] font-semibold leading-5 truncate ${_?"text-gray-500":""}`,children:n.label||n.id}),e.jsxs("div",{className:`text-[12px] leading-4 truncate flex justify-between items-center ${_?"text-gray-400":"text-gray-600"}`,children:[e.jsxs("span",{children:[n.ort||"â€”"," Â· ðŸ‘¥ ",n.mannschaft??0]}),s&&Number.isFinite(Number(c))&&e.jsxs("span",{className:"absolute top-1 right-1 text-[11px] tabular-nums text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded whitespace-nowrap",children:[Number(c)," Km"]})]})]})}const qt=n=>Array.isArray(n?.assignedVehicles)?n.assignedVehicles:Array.isArray(n?.assigned_vehicle_ids)?n.assigned_vehicle_ids:[];function wr(n,o){const c=(o.lat-n.lat)*Math.PI/180,u=(o.lng-n.lng)*Math.PI/180,p=Math.sin(c/2)**2+Math.cos(n.lat*Math.PI/180)*Math.cos(o.lat*Math.PI/180)*Math.sin(u/2)**2;return 2*6371*Math.asin(Math.sqrt(p))}function Zt(n,o,s){const u=s*Math.PI/180,p=n.lat*Math.PI/180,f=n.lng*Math.PI/180,v=o/6371e3,N=Math.asin(Math.sin(p)*Math.cos(v)+Math.cos(p)*Math.sin(v)*Math.cos(u))*180/Math.PI,P=(f+Math.atan2(Math.sin(u)*Math.sin(v)*Math.cos(p),Math.cos(v)-Math.sin(p)*Math.sin(N*Math.PI/180)))*180/Math.PI;return{lat:N,lng:P}}async function Ln(n){if(!n||!window.google?.maps?.Geocoder)return null;const o=new window.google.maps.Geocoder;return new Promise(s=>{o.geocode({address:n,region:"AT"},(c,u)=>{u==="OK"&&c?.[0]?.geometry?.location?s({lat:c[0].geometry.location.lat(),lng:c[0].geometry.location.lng(),formatted:c[0].formatted_address||n}):s(null)})})}const Ue=n=>String(n||"").trim().toLowerCase();async function $n(){try{const n=await fetch("/api/vehicles",{cache:"no-store",credentials:"include"});if(!n.ok)return[];const o=await n.json();return Array.isArray(o)?o:[]}catch{return[]}}async function Rn(){try{const n=await fetch("/api/board",{cache:"no-store",credentials:"include"});if(!n.ok)return null;const o=await n.json();if(o&&typeof o=="object")return o}catch(n){console.error("Board fetch failed:",n)}return null}function Dn(n,o){const s=new Map;if(Array.isArray(o))for(const c of o)!c||c.id==null||s.set(String(c.id),{...c});if(n&&typeof n=="object")for(const c of Object.values(n)){if(!c||c.id==null)continue;const u=String(c.id),p=s.get(u)||{};s.set(u,{...p,...c})}return[...s.values()]}async function zn(){try{const n=await fetch("/api/gps",{cache:"no-store",credentials:"include"});if(n.ok)return await n.json()}catch(n){console.error("GPS fetch failed:",n)}return[]}function Fn(n){const o=n?.typ||n?.type||"â€”",s=n?.createdAt||n?.timestamp,c=s?new Date(s).toLocaleString("de-AT",{hour12:!1}):"â€”",u=n?.alerted??"â€”",p=n?.description??"â€”",f=n?.additionalAddressInfo||n?.ort||"â€”",v=[];n?.location&&v.push(String(n.location));const N=Number.isFinite(n?.latitude),P=Number.isFinite(n?.longitude);N&&P&&v.push(`(${n.latitude}, ${n.longitude})`);const E=v.length?v.join(" "):"â€”";return`
    <div style="min-width:280px">
      <div style="font-weight:700;margin-bottom:4px">${n?.content||"Einsatz"}</div>
      <div><b>Typ:</b> ${o}</div>
      <div><b>Alarmzeit:</b> ${c}</div>
      <div><b>Alarmiert:</b> ${u}</div>
      <div><b>Beschreibung:</b> ${p}</div>
      <div><b>Adresse:</b> ${f}</div>
      <div><b>Location:</b> ${E}</div>
    </div>
  `}const _e=44,_n="/vehicle-red.gif",vr="/vehicle-gray.png",Sr="/vehicle-drive.gif";function Nr({context:n,address:o,onClose:s}){const c=o||n?.card?.ort||n?.address||"",u=!!window.google?.maps,p=a.useRef(null),f=a.useRef(!1),[v,N]=a.useState(!1),[P,E]=a.useState(""),D=a.useMemo(()=>{const C=n?.card;return C&&Number.isFinite(C?.latitude)&&Number.isFinite(C?.longitude)?{lat:Number(C.latitude),lng:Number(C.longitude)}:null},[n]);if(a.useEffect(()=>{if(!u||!n?.card||!p.current)return;f.current=!1;let C=!1,R,_;const S=new Map;let j=null;const m=n?.card?.id!=null?String(n.card.id):null;let g=n?.board;const $=async(k,G)=>{if(!(!m||f.current)&&!(!Number.isFinite(k?.lat)||!Number.isFinite(k?.lng)))try{const z={latitude:k.lat,longitude:k.lng};G&&!n?.card?.location&&(z.location=G),await jt(m,z),f.current=!0}catch(z){console.error("Geocoding-Persistierung fehlgeschlagen:",z)}};return(async()=>{try{if(N(!0),E(""),!g||typeof g!="object"||!g.columns){const I=await Rn();if(C)return;I&&typeof I=="object"&&(g=I)}let k=D;if(!k){const I=await Ln(n.card.ort);if(C)return;I&&(k={lat:I.lat,lng:I.lng},$(k,I.formatted))}k||(k={lat:46.7227,lng:14.0952},E("Einsatz-Position unbekannt â€“ zeige Karte mit Default-Zentrum.")),R=new window.google.maps.Map(p.current,{center:k,zoom:18,mapTypeId:"roadmap"}),_=new window.google.maps.InfoWindow;const G=(I,Z,ae,ue,{hover:we=!1}={})=>{const be={path:"M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z",fillColor:Z,fillOpacity:1,strokeColor:"#333",strokeWeight:1,scale:1.2},oe=new window.google.maps.Marker({position:I,map:R,title:ae,icon:be});if(ue){const ve=()=>{_.setContent(ue),_.open(R,oe)};we?(oe.addListener("mouseover",ve),oe.addListener("mouseout",()=>_.close())):oe.addListener("click",ve)}return oe};G(k,"#d11a1a",n.card.content||"Einsatz",Fn(n.card),{hover:!0});const z=[],U=new Set,ne=I=>{if(!I||I.id==null)return;const Z=String(I.id);U.has(Z)||(U.add(Z),z.push(I))},W=(g||n?.board)?.columns||{};for(const I of W?.neu?.items||[])ne(I);for(const I of W?.["in-bearbeitung"]?.items||[])ne(I);m&&ne(n?.card);const V=new Map;for(const I of z){const Z=String(I.id);if(Number.isFinite(I.latitude)&&Number.isFinite(I.longitude))V.set(Z,{lat:Number(I.latitude),lng:Number(I.longitude)});else if(I.ort){const ae=await Ln(I.ort);ae&&V.set(Z,{lat:ae.lat,lng:ae.lng})}}m&&k&&V.set(m,k);for(const I of z){const Z=String(I.id);if(m&&Z===m)continue;const ae=V.get(Z);ae&&G(ae,"#1e63d1",I.content||"Einsatz",Fn(I),{hover:!0})}const q=new Map;for(const I of z)for(const Z of qt(I))q.set(String(Z),String(I.id));const X=await zn(),de=new Map(X.filter(I=>Number.isFinite(I?.lat)&&Number.isFinite(I?.lng)&&I?.realname).map(I=>[Ue(I.realname),I])),ce=await $n(),se=new Map(ce.filter(I=>I&&I.source!=="gps"&&Number.isFinite(I.latitude)&&Number.isFinite(I.longitude)).map(I=>[String(I.id),{lat:Number(I.latitude),lng:Number(I.longitude)}])),A=Dn(n.vehiclesById,ce),me=10,O=50,J=new Map,he=window.google?.maps?.marker?.AdvancedMarkerElement,re=typeof he=="function"&&typeof he?.prototype?.addListener=="function"?he:null,Ne=(I,Z,ae)=>{if(!I)return vr;if(!Z||!ae||!V.has(ae))return _n;const ue=V.get(ae);return wr(Z,ue)>.1?Sr:_n},ge=(I,Z,ae,ue,we,be)=>{const oe=Ne(Z,ue,we),ve=!ue;if(re){const Q=document.createElement("img");Q.src=oe,Q.width=_e,Q.height=_e,Q.alt=ae||"",Q.decoding="async";const Y=new re({map:R,position:I,content:Q,title:ae});if(ve){try{Y.draggable=!0}catch{}typeof Y.addListener=="function"&&Y.addListener("dragend",async le=>{const F=le?.latLng||Y.position,ee=typeof F.lat=="function"?F.lat():F.lat,Se=typeof F.lng=="function"?F.lng():F.lng;try{await yn(be,ee,Se,we,"manual")}catch(je){Y.__setPosition(I),console.error("setVehiclePosition failed:",je),alert("Position konnte nicht gespeichert werden.")}})}return Y.__setPosition=le=>{Y.position=le},Y.__setIcon=(le,F,ee)=>{Q.src=Ne(le,F,ee)},Y.__onOver=le=>{Q.addEventListener("mouseover",le),Q.addEventListener("mouseout",()=>_.close())},Y}else{const Q=new window.google.maps.Marker({position:I,map:R,title:ae,draggable:ve,icon:{url:oe,scaledSize:new window.google.maps.Size(_e,_e),anchor:new window.google.maps.Point(_e/2,_e/2)}});return ve&&Q.addListener("dragend",async Y=>{const le=Y?.latLng||Q.getPosition(),F=typeof le.lat=="function"?le.lat():le.lat,ee=typeof le.lng=="function"?le.lng():le.lng;try{await yn(be,F,ee,we,"manual")}catch(Se){Q.__setPosition(I),console.error("setVehiclePosition failed:",Se),alert("Position konnte nicht gespeichert werden.")}}),Q.__setPosition=Y=>Q.setPosition(Y),Q.__setIcon=(Y,le,F)=>Q.setIcon({url:Ne(Y,le,F),scaledSize:new window.google.maps.Size(_e,_e),anchor:new window.google.maps.Point(_e/2,_e/2)}),Q.__onOver=Y=>{Q.addListener("mouseover",Y),Q.addListener("mouseout",()=>_.close())},Q}};for(const I of A){const Z=String(I.id),ae=Ue(`${I?.label||""} ${I?.ort||""}`),ue=Ue(I?.label||""),we=Ue(I?.ort||""),be=de.get(ae)||de.get(ue)||de.get(we),oe=q.get(Z),ve=se.has(Z);if(!oe&&!be&&!ve)continue;let Q=null,Y=null;if(be)Y={lat:Number(be.lat),lng:Number(be.lng)},Q=Y;else if(ve)Q=se.get(Z);else if(oe){const je=V.get(oe)||(m===oe?k:null),Ee=((J.get(oe)||0)+O)%360;J.set(oe,Ee),je&&(Q=Zt(je,me,Ee))}if(!Q)continue;const F=ge(Q,!!oe,I.label||I.id,Y,oe,Z),ee=oe&&z.find(je=>String(je.id)===oe),Se=ee?`<br/><i>zugeordnet: ${ee.content}</i>`:"";F.__onOver(()=>{const je=I?.ort||"";_.setContent(`<div style="min-width:220px"><b>${I.label||I.id}</b>${je?`<br/>${je}`:""}${Se}</div>`);const Te=re?void 0:F;_.open({map:R,anchor:Te,position:Q,shouldFocus:!1})}),S.set(Z,F)}R.setCenter(k),R.setZoom(18),j=setInterval(async()=>{const I=await zn(),Z=await $n();if(!g||typeof g!="object"||!g.columns){const F=await Rn();if(C)return;F&&typeof F=="object"&&(g=F)}const ae=g||n?.board,ue=new Map(Z.filter(F=>F&&F.source!=="gps"&&Number.isFinite(F.latitude)&&Number.isFinite(F.longitude)).map(F=>[String(F.id),{lat:Number(F.latitude),lng:Number(F.longitude)}])),we=new Map(I.filter(F=>Number.isFinite(F?.lat)&&Number.isFinite(F?.lng)&&F?.realname).map(F=>[Ue(F.realname),F])),be=new Map,oe=[...ae?.columns?.neu?.items||[],...ae?.columns?.["in-bearbeitung"]?.items||[]];for(const F of oe){const ee=F?.id!=null?String(F.id):null;if(ee)for(const Se of qt(F))be.set(String(Se),ee)}if(m)for(const F of qt(n.card))be.set(String(F),m);const ve=Dn(n.vehiclesById,Z),Q=new Map;for(const F of ve){const ee=String(F.id),Se=be.get(ee),je=Ue(`${F?.label||""} ${F?.ort||""}`);if(Se&&!we.get(je)&&!ue.has(ee)){const Te=Q.get(Se)||[];Te.push(ee),Q.set(Se,Te)}}for(const[F,ee]of Q.entries())ee.sort();const Y=10,le=50;for(const F of ve){const ee=String(F.id),Se=Ue(`${F?.label||""} ${F?.ort||""}`),je=Ue(F?.label||""),Te=Ue(F?.ort||""),Ee=we.get(Se)||we.get(je)||we.get(Te),ke=be.get(ee);let fe=null;const Le=ue.has(ee),Re=!!ke||!!Ee||!!Le;let Me=S.get(ee);if(!Me&&Re){let y=null;if(Ee)fe={lat:Number(Ee.lat),lng:Number(Ee.lng)},y=fe;else if(Le)y=ue.get(ee);else if(ke){const te=V.get(ke)||(m===ke?k:null);if(te){const We=((Q.get(ke)||[]).indexOf(ee)+1)*le%360;y=Zt(te,Y,We)}}y&&(Me=ge(y,!!ke,F.label||F.id,fe,ke,ee),S.set(ee,Me))}if(!Me)continue;if(Ee)fe={lat:Number(Ee.lat),lng:Number(Ee.lng)},Me.__setPosition(fe);else if(ue.has(ee))Me.__setPosition(ue.get(ee));else if(ke){const y=V.get(ke)||(m===ke?k:null);if(y){const pe=((Q.get(ke)||[]).indexOf(ee)+1)*le%360;Me.__setPosition(Zt(y,Y,pe))}else{const te=S.get(ee);te&&(te.setMap?te.setMap(null):te.map&&(te.map=null),S.delete(ee));continue}}else{const y=S.get(ee);y&&(y.setMap?y.setMap(null):y.map&&(y.map=null),S.delete(ee));continue}const Ge=!!ke;Me.__setIcon(Ge,fe,ke)}},5e3)}catch(k){E(k?.message||"Kartenaufbau fehlgeschlagen.")}finally{N(!1)}})(),()=>{C=!0,j&&clearInterval(j);for(const k of S.values())k?.setMap?k.setMap(null):k&&(k.map=null);S.clear()}},[u,n,D]),!u||!n?.card){const C=`https://www.google.com/maps?q=${encodeURIComponent(c)}&output=embed`;return e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:s,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[70vh] p-2",onClick:R=>R.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-semibold text-sm",children:["Karte: ",c]}),e.jsx("button",{className:"px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm",onClick:s,children:"SchlieÃŸen"})]}),e.jsx("iframe",{title:"maps",className:"w-full h-full rounded-lg border",src:C,loading:"lazy"})]})})}return e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:s,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-5xl h-[75vh] p-2",onClick:C=>C.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-semibold text-sm",children:["Karte: ",n?.card?.content||"Einsatz"," Â· weitere EinsÃ¤tze (Neu & In Bearbeitung)"]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm",onClick:s,children:"SchlieÃŸen"})})]}),e.jsx("div",{ref:p,className:"w-full h-full rounded-lg border"}),v&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"px-3 py-1.5 rounded bg-white shadow text-sm",children:"Ladeâ€¦"})}),!!P&&e.jsx("div",{className:"absolute bottom-3 left-3 px-2 py-1 rounded bg-red-600 text-white text-xs shadow",children:P})]})})}function jr({onClose:n,onCreate:o}){const[s,c]=a.useState(""),[u,p]=a.useState(""),[f,v]=a.useState(0),[N,P]=a.useState(!1),[E,D]=a.useState(""),C=async R=>{if(R.preventDefault(),D(""),!s.trim()||!u.trim()){D("Ort und Name sind erforderlich.");return}try{P(!0),await o({ort:s.trim(),label:u.trim(),mannschaft:Number(f)||0}),n()}catch(_){D(_?.message||"Speichern fehlgeschlagen.")}finally{P(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:e.jsxs("form",{onSubmit:C,className:"bg-white rounded-xl shadow-lg p-4 w-[360px] space-y-3",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Einheit anlegen"}),E&&e.jsx("div",{className:"text-sm text-red-600",children:E}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Ort"}),e.jsx("input",{className:"border rounded px-2 py-1 w-full",value:s,onChange:R=>c(R.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Name"}),e.jsx("input",{className:"border rounded px-2 py-1 w-full",value:u,onChange:R=>p(R.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Mannschaft"}),e.jsx("input",{type:"number",min:"0",className:"border rounded px-2 py-1 w-24",value:f,onChange:R=>v(R.target.value)})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:n,className:"px-3 py-1 rounded border",disabled:N,children:"Abbrechen"}),e.jsx("button",{type:"submit",className:"px-3 py-1 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:N,children:N?"Anlegenâ€¦":"Anlegen"})]})]})})}let vt=null;function Qt(){const n=document.querySelector('meta[name="google-places-key"]');return(window.GMAPS_API_KEY||n?.content||"").trim()||""}async function Kn(n=Qt()){if(window.google?.maps?.places)return!0;if(!n)return!1;if(vt)return await vt,!!window.google?.maps?.places;vt=new Promise((o,s)=>{if(document.getElementById("gmap-places")){const u=()=>{window.google?.maps?.places?o(!0):setTimeout(u,150)};u();return}const c=document.createElement("script");c.id="gmap-places",c.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(n)}&libraries=places&language=de`,c.async=!0,c.defer=!0,c.onload=()=>o(!!window.google?.maps?.places),c.onerror=u=>s(u),document.head.appendChild(c)});try{await vt}catch{}return!!window.google?.maps?.places}function Cr({debounceMs:n=300,country:o="at",minLength:s=3}={}){const[c,u]=a.useState(""),[p,f]=a.useState([]),[v,N]=a.useState(!1),[P,E]=a.useState(!1),[D,C]=a.useState(null),R=a.useRef(null),_=a.useRef(null),S=a.useRef(null),j=a.useRef(null);a.useEffect(()=>{let z=!1;return(async()=>{const U=await Kn(Qt());z||!U||!window.google?.maps?.places||(R.current=new google.maps.places.AutocompleteService,_.current=new google.maps.places.PlacesService(document.createElement("div")),S.current=new google.maps.places.AutocompleteSessionToken,z||E(!0))})(),()=>{z=!0}},[]);const m=a.useCallback(()=>{window.google?.maps?.places&&(S.current=new google.maps.places.AutocompleteSessionToken)},[]),g=a.useRef();a.useEffect(()=>{g.current||(g.current=(z,U)=>{let ne;return(...ie)=>{clearTimeout(ne),ne=setTimeout(()=>z(...ie),U)}})},[]);const $=a.useCallback(async z=>{if(!P||!R.current)return;const U=(z||"").trim();if(!U||U.length<s){f([]);return}N(!0),C(null),R.current.getPlacePredictions({input:U,sessionToken:S.current,componentRestrictions:{country:o},types:["address"]},(ne,ie)=>{if(N(!1),ie!==google.maps.places.PlacesServiceStatus.OK||!ne){f([]),ie&&ie!=="ZERO_RESULTS"&&C(ie);return}f(ne)})},[o,s,P]),T=a.useMemo(()=>g.current?g.current($,n):()=>{},[$,n]);a.useEffect(()=>{T(c)},[c,T]);const k=a.useCallback((z,U=["formatted_address","geometry","address_components"])=>new Promise((ne,ie)=>{if(!P||!_.current){ie(new Error("Google Places nicht bereit"));return}_.current.getDetails({placeId:z,fields:U,sessionToken:S.current},(W,V)=>{if(V!==google.maps.places.PlacesServiceStatus.OK||!W)return ie(new Error(V||"DETAILS_FAILED"));ne(W)})}),[P]),G=a.useCallback(()=>{f([])},[]);return{ready:P,query:c,setQuery:u,predictions:p,loading:v,error:D,resetSession:m,getDetailsByPlaceId:k,clearPredictions:G,inputElRef:j}}function nt(n){return String(n??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}function kr(){const n=document.querySelector('meta[name="google-places-key"]');return(window.GMAPS_API_KEY||n?.content||"").trim()||void 0}function ut(n){if(!n)return null;if(typeof n=="string"){const o=n.trim().match(/^\s*([+-]?\d+(?:\.\d+)?)\s*,\s*([+-]?\d+(?:\.\d+)?)\s*$/);if(!o)return null;const s=Number(o[1]),c=Number(o[2]);return Number.isFinite(s)&&Number.isFinite(c)?{lat:s,lng:c}:null}if(typeof n=="object"&&n){if(typeof n.lat=="function"&&typeof n.lng=="function"){const c=Number(n.lat()),u=Number(n.lng());if(Number.isFinite(c)&&Number.isFinite(u))return{lat:c,lng:u}}if(typeof n.toJSON=="function"){const c=n.toJSON();if(c&&c!==n){const u=ut(c);if(u)return u}}const o=Number(n.lat??n.latitude),s=Number(n.lng??n.longitude);if(Number.isFinite(o)&&Number.isFinite(s))return{lat:o,lng:s}}return null}async function Gn(n){try{const o=String(n||"").trim();if(!o)return null;const s=await fetch(`/api/geocode?q=${encodeURIComponent(o)}`,{credentials:"include",cache:"no-store"});if(!s.ok)return null;const c=await s.json(),u=Number(c?.lat),p=Number(c?.lng);return!Number.isFinite(u)||!Number.isFinite(p)?null:{lat:u,lng:p,formatted:c?.formatted||o}}catch{return null}}function Ar({lat:n,lng:o,address:s,apiKey:c,zoom:u=16,size:p="800x400",scale:f=2}){if(Number.isFinite(n)&&Number.isFinite(o)){if(c){const P="https://maps.googleapis.com/maps/api/staticmap",E=`center=${n},${o}&zoom=${u}&size=${p}&scale=${f}&markers=color:red|label:E|${n},${o}&maptype=roadmap`;return`${P}?${E}&key=${c}`}const N=p.toLowerCase().replace("x","x");return`https://staticmap.openstreetmap.de/staticmap.php?center=${n},${o}&zoom=${u}&size=${N}&markers=${n},${o},red-pushpin`}if(c&&s){const N="https://maps.googleapis.com/maps/api/staticmap",P=encodeURIComponent(s),E=`center=${P}&zoom=${u}&size=${p}&scale=${f}&markers=color:red|label:E|${P}&maptype=roadmap`;return`${N}?${E}&key=${c}`}return""}function Wn({title:n,type:o,location:s,timestamp:c,infoRowsHtml:u,mapSrc:p,staticMapUrl:f,notesSection:v,autoPrint:N}){const P=`
    <script>
      // Markiert, wenn Karte (iFrame ODER Bild) bereit ist â€“ z.B. fÃ¼r automatischen Druck
      (function(){
        window.__incidentMapReady = false;

        function markReady(){
          if (window.__incidentMapReady) return;
          window.__incidentMapReady = true;
          try { document.body.setAttribute('data-map-ready', '1'); } catch(e){}
      if (${N?"true":"false"}) {
            // Nur EINMAL drucken
            if (!window.__alreadyPrinted) {
              window.__alreadyPrinted = true;
             setTimeout(() => { try { window.print(); } catch(e){} }, 100);
            }
          }
        }

        function watchIframeOrImage(){
          const frame = document.querySelector('.map-frame iframe');
          const img = document.querySelector('.map-frame img.map-static');

          // Wenn Bild vorhanden â†’ auf Bild warten (fÃ¼r Print wichtig)
          if (img) {
            if (img.complete) {
              markReady();
            } else {
              img.addEventListener('load', markReady, { once: true });
              img.addEventListener('error', markReady, { once: true });
              setTimeout(markReady, 3000); // Fallback
            }
          }

          // Wenn iFrame vorhanden â†’ auch auf iFrame warten (fÃ¼r Screen)
          if (frame) {
            const safeFinish = () => { markReady(); };
            try {
              frame.addEventListener('load', safeFinish, { once: true });
              frame.addEventListener('error', safeFinish, { once: true });
            } catch { /* ignore */ }

            // Cross-Origin iFrame? Dann lieber Timeout
            setTimeout(safeFinish, 3000);
          }

          // Wenn weder Bild noch iFrame: sofort ready
          if (!img && !frame) markReady();
        }

        if (document.readyState === 'complete') watchIframeOrImage();
        else window.addEventListener('load', watchIframeOrImage, { once: true });
      })();
    <\/script>
  `;return`<!DOCTYPE html>
  <html lang="de">
    <head>
      <meta charSet="utf-8" />
      <title>Einsatzdruck â€“ ${nt(n||o||"Neuer Einsatz")}</title>
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <style>
        * { box-sizing: border-box; font-family: "Inter", "Helvetica Neue", Arial, sans-serif; color:#0f172a; }
        body { margin:0; padding:0; background:#e2e8f0; }
        .sheet { max-width: 190mm; margin: 18px auto; background:#fff; border-radius:16px; padding:22px 26px;
                 box-shadow: 0 12px 32px rgba(15,23,42,0.18); }
        header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; }
        header h1 { margin:0; font-size:20px; }
        header span { font-size:12px; color:#475569; }
        section { margin-top:20px; }
        .info { display:flex; flex-direction:column; gap:10px; }
        .row { display:flex; gap:14px; }
        .label { width:120px; font-weight:600; font-size:13px; text-transform:uppercase; letter-spacing:.04em; color:#475569; }
        .value { flex:1; font-size:14px; line-height:1.4; }
        .map-section h2, .notes h2 { font-size:16px; margin:0 0 10px; }
        .map-frame { width:100%; aspect-ratio: 4 / 3; border-radius:14px; overflow:hidden; border:1px solid #cbd5e1; background:#f8fafc; }
        .map-frame iframe { width:100%; height:100%; border:0; display:block; }
        .map-frame img.map-static { width:100%; height:100%; object-fit:cover; display:none; }
        .notes div { font-size:14px; line-height:1.5; white-space:pre-wrap; }
        footer { margin-top:24px; font-size:11px; color:#64748b; text-align:right; }

        @media print {
          body { background:#fff; }
          .sheet { box-shadow:none; margin:0; max-width:unset; width:100%; border-radius:0; }
          @page { size: A4; margin: 12mm; }
          .map-frame iframe { display:none !important; }
          .map-frame img.map-static { display:block !important; }
        }
      </style>
    </head>
    <body>
      <div class="sheet">
        <header>
          <h1>Einsatzinformation</h1>
          <span>Druck erstellt am ${nt(c||"")}</span>
        </header>

        <section class="info">
          ${u||""}
        </section>

        <section class="map-section">
          <h2>Einsatzkarte</h2>
          <div class="map-frame">
            <iframe src="${p}" title="Einsatzkarte" loading="lazy"></iframe>
            <img class="map-static" alt="Einsatzkarte" src="${f}" referrerpolicy="no-referrer" />
          </div>
        </section>

        ${v||""}

        <footer>Einsatzstellen-Ãœbersicht</footer>
      </div>
      ${P}
    </body>
  </html>`}async function qn({title:n="",type:o="",locationLabel:s="",notes:c="",isArea:u=!1,areaColor:p,areaLabel:f,coordinates:v=null}){const P=new Date().toLocaleString("de-AT",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),E=(n||"").trim(),D=(o||"").trim();let C=(s||"").trim(),R=ut(v);try{if(!R&&C){const T=await Gn(C);T&&(R={lat:T.lat,lng:T.lng},T.formatted&&(C=T.formatted))}}catch{}const _=R?`${R.lat},${R.lng}`:C||E||D||"Ã–sterreich",S=`https://www.google.com/maps?q=${encodeURIComponent(_)}&output=embed&hl=de&z=15`;let j=Ar({lat:R?.lat,lng:R?.lng,address:C||E||D||"Ã–sterreich",apiKey:kr()});j||(j=`https://placehold.co/800x400?text=${encodeURIComponent("Keine Karte verfÃ¼gbar")}`);const m=[["Einsatz",E||D||"â€”"],["Art",D||"â€”"],["Ort",C||"â€”"],...u?[["Bereich",`${nt(f||"Bereich")} ${p?`<span class="color-chip" style="background:${nt(p)}"></span>`:""}`]]:[]].map(([T,k])=>`
      <div class="row">
        <div class="label">${nt(T)}</div>
        <div class="value">${typeof k=="string"?k:k??"â€”"}</div>
      </div>`).join(""),g=c?`<section class="notes"><h2>Hinweise</h2><div>${nt(c)}</div></section>`:"";return{html:Wn({title:E,type:D,location:C,timestamp:P,infoRowsHtml:m,mapSrc:S,staticMapUrl:j,notesSection:g,autoPrint:!1}),title:E,type:D,location:C,timestamp:P,mapSrc:S,staticMapUrl:j,notes:c,isArea:!!u,infoRowsHtml:m,notesSection:g}}async function Zn({title:n="",type:o="",locationLabel:s="",notes:c="",isArea:u=!1,areaColor:p,areaLabel:f,coordinates:v=null,incidentId:N}){const P=await qn({title:n,type:o,locationLabel:s,notes:c,isArea:u,areaColor:p,areaLabel:f,coordinates:v}),{html:E,title:D,type:C,location:R,timestamp:_,mapSrc:S,staticMapUrl:j,infoRowsHtml:m,notesSection:g}=P;try{const $=document.createElement("iframe");$.style.position="fixed",$.style.right="0",$.style.bottom="0",$.style.width="0",$.style.height="0",$.style.border="0",document.body.appendChild($);const T=$.contentDocument||$.contentWindow?.document;if(!T)throw new Error("Kein iFrame-Dokument verfÃ¼gbar.");T.open(),T.write(E),T.close();const k=$.contentWindow;let G=!1;const z=()=>{if(!G){G=!0;try{k.focus()}catch{}try{k.print()}catch{}}},U=()=>{if(!G){try{if(!k||!k.document)return void setTimeout(U,150);if(k.__incidentMapReady===!0||k.document.body&&k.document.body.getAttribute("data-map-ready")==="1")return z()}catch{}setTimeout(U,150)}};try{$.addEventListener("load",()=>setTimeout(U,50),{once:!0})}catch{}setTimeout(U,200);return}catch{const T=window.open("","_blank","noopener,noreferrer,width=980,height=1200"),k=Wn({title:D,type:C,location:R,timestamp:_,infoRowsHtml:m,mapSrc:S,staticMapUrl:j,notesSection:g,autoPrint:!0});try{if(T&&T.document)T.document.open(),T.document.write(k),T.document.close();else{const G=new Blob([k],{type:"text/html"}),z=URL.createObjectURL(G);window.location.href=z}}catch{}}}function Ir({onClose:n,onCreate:o,types:s,areaOptions:c=[]}){const u="#2563eb",[p,f]=a.useState(""),[v,N]=a.useState(""),[P,E]=a.useState(!1),[D,C]=a.useState(!1),[R,_]=a.useState(""),[S,j]=a.useState(u),[m,g]=a.useState(""),[$,T]=a.useState(!1),k=a.useRef(null),{query:G,setQuery:z,predictions:U,getDetailsByPlaceId:ne,resetSession:ie,loading:W,error:V,clearPredictions:q}=Cr({country:"at",debounceMs:300,minLength:3});a.useEffect(()=>{setTimeout(()=>k.current?.focus(),0)},[]),a.useEffect(()=>{const A=(v||"").replace(/^T\d+\s*,?\s*/i,"").trim();!p.trim()&&A&&f(A)},[v]);const X=a.useRef(null);a.useEffect(()=>{D&&(_(""),j(A=>A||u))},[D]);const de=async A=>{A?.preventDefault?.();const me=(v||"").replace(/^T\d+\s*,?\s*/i,"").trim(),O=(p||me).trim();if(O){E(!0);try{let J=null,he=(G||"").trim();const re=X.current;if(re){const ge=ut(re.geometry?.location);ge&&(J=ge);const I=re.formatted_address||re.name||"";I&&(he=I)}if(!J&&he){const ge=await Gn(he);ge&&(J={lat:ge.lat,lng:ge.lng},ge.formatted&&(he=ge.formatted))}const Ne=(m||"").trim();await o({title:O,ort:(G||"").trim(),typ:(v||"").trim(),isArea:D,areaCardId:D?null:R||null,areaColor:D?S:void 0,coordinates:J,location:he,description:Ne}),f(""),z(""),N(""),C(!1),_(""),j(u),g(""),X.current=null,ie(),q(),n?.()}finally{E(!1)}}},ce=async A=>{try{const me=await ne(A.place_id,["formatted_address","geometry","address_components","place_id"]),O=me?.formatted_address||A.description;z(O),X.current=me||null}catch{X.current=null,z(A.description)}finally{ie(),q()}},se=async()=>{if($)return;const A=(v||"").replace(/^T\d+\s*,?\s*/i,"").trim(),me=(p||A).trim(),O=(G||"").trim(),J=(m||"").trim(),he=c.find(re=>String(re.id)===String(R));try{T(!0);let re=O,Ne=null;const ge=X.current;if(ge){const I=ut(ge.geometry?.location);I&&(Ne=I);const Z=ge.formatted_address||ge.name||"";Z&&(re=Z)}await Zn({title:me,type:A,locationLabel:re,notes:J,isArea:D,areaColor:D?S:void 0,areaLabel:!D&&he?he.label:void 0,coordinates:Ne,incidentId:me||A||void 0})}catch(re){const Ne=re?.message||re||"Unbekannter Fehler";alert(`Drucken fehlgeschlagen: ${Ne}`)}finally{T(!1)}};return e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-3",children:e.jsxs("form",{onSubmit:de,className:"bg-white rounded-xl shadow-lg w-[520px] max-w-full p-4 space-y-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Einsatz anlegen"}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs("select",{ref:k,className:"border rounded px-2 py-1",value:v,onChange:A=>N(A.target.value),children:[e.jsx("option",{value:"",children:"â€” Typ auswÃ¤hlen â€”"}),(s||[]).map(A=>e.jsx("option",{value:A,children:A},A))]}),e.jsx("input",{className:"border rounded px-2 py-1",placeholder:"Titel (wird aus Typ Ã¼bernommen)",value:p,onChange:A=>f(A.target.value)}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{className:"border rounded px-2 py-1 w-full",placeholder:"Ort (nur Ã–sterreich)",autoComplete:"off",value:G,onChange:A=>{X.current=null,z(A.target.value)}}),W&&e.jsx("div",{className:"absolute z-10 mt-1 text-xs text-gray-500 bg-white border rounded px-2 py-1",children:"Sucheâ€¦"}),V&&e.jsxs("div",{className:"absolute z-10 mt-1 text-xs text-red-600 bg-white border rounded px-2 py-1",children:["Fehler: ",String(V)]}),!!U.length&&e.jsx("ul",{className:"absolute z-10 mt-1 w-full max-h-52 overflow-auto bg-white border rounded shadow",children:U.map(A=>e.jsx("li",{className:"px-2 py-1 hover:bg-gray-100 cursor-pointer text-sm",onClick:()=>ce(A),title:A.description,children:A.description},A.place_id))})]}),e.jsxs("label",{className:"text-sm font-medium text-gray-700",children:["Notiz",e.jsx("textarea",{className:"mt-1 w-full border rounded px-2 py-1 resize-y min-h-[90px]",value:m,onChange:A=>g(A.target.value),disabled:P})]}),e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:D,onChange:A=>C(A.target.checked),disabled:P}),"Abschnitt"]}),!D&&e.jsxs("select",{className:"border rounded px-2 py-1 text-sm",value:R,onChange:A=>_(A.target.value),disabled:P||c.length===0,children:[e.jsx("option",{value:"",children:"â€” Abschnitt auswÃ¤hlen â€”"}),c.map(A=>e.jsx("option",{value:A.id,children:A.label},A.id))]})]}),D&&e.jsxs("div",{className:"flex items-center justify-between gap-3 text-sm text-gray-700",children:[e.jsx("span",{children:"Abschnittsfarbe"}),e.jsx("input",{type:"color",className:"h-9 w-16 border rounded cursor-pointer",value:S,onChange:A=>j(A.target.value),disabled:P})]}),!D&&c.length===0&&e.jsx("p",{className:"text-xs text-gray-500",children:"Noch keine Abschnitte vorhanden."})]}),e.jsxs("div",{className:"flex items-center justify-between gap-2 pt-1",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Informationen und Karte auf A4 drucken"}),e.jsx("button",{type:"button",onClick:se,className:"px-3 py-1 rounded border bg-white hover:bg-gray-50 text-sm disabled:opacity-60",disabled:P||$,children:$?"Druckenâ€¦":"Drucken"})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:n,className:"px-3 py-1 rounded border",disabled:P,children:"Abbrechen"}),e.jsx("button",{className:"px-3 py-1 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:P,children:P?"Anlegenâ€¦":"Anlegen"})]})]})})}const Er={neu:{colClass:"col-new",titleClass:"col-title-new",icon:"â—"},"in-bearbeitung":{colClass:"col-progress",titleClass:"col-title-progress",icon:"â–¶"},erledigt:{colClass:"col-done",titleClass:"col-title-done",icon:"âœ”"}};function Mr({colId:n,title:o,bg:s,children:c,editable:u=!0}){const p=Er[n]||{},f=a.useRef(null),[v,N]=a.useState(null);if(a.useLayoutEffect(()=>{const D=f.current;if(!D)return;const C=()=>{const R=D.getBoundingClientRect(),_=window.innerHeight||document.documentElement.clientHeight,S=Math.max(240,Math.floor(_-R.top-16));N(S)};return C(),window.addEventListener("resize",C),window.addEventListener("orientationchange",C),()=>{window.removeEventListener("resize",C),window.removeEventListener("orientationchange",C)}},[]),!u)return e.jsxs("section",{ref:f,style:v?{height:v}:void 0,className:["droppable-column","flex flex-col overflow-hidden",p.colClass||s].join(" "),children:[e.jsx("div",{className:"column-header sticky top-0 z-10",children:e.jsx("div",{className:"flex flex-wrap items-center justify-between gap-2",children:e.jsxs("h2",{className:`col-title flex items-center gap-2 ${p.titleClass||""}`,children:[e.jsx("span",{className:"text-base","aria-hidden":!0,children:p.icon||""}),o]})})}),c]});const{setNodeRef:P,isOver:E}=Hs({id:`col:${n}`,data:{type:"column",colId:n}});return e.jsxs("section",{ref:D=>{P(D),f.current=D},style:v?{height:v}:void 0,className:["droppable-column","flex flex-col overflow-hidden",p.colClass||s,E?"ring-2 ring-blue-300":""].join(" "),children:[e.jsx("div",{className:"column-header sticky top-0 z-10",children:e.jsx("div",{className:"flex flex-wrap items-center justify-between gap-2",children:e.jsxs("h2",{className:`col-title flex items-center gap-2 ${p.titleClass||""}`,children:[e.jsx("span",{className:"text-base","aria-hidden":!0,children:p.icon||""}),o]})})}),c]})}const Pr=n=>{if(n==null)return"";const o=String(n).trim();return o?o.normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9_.-]+/g,"-").replace(/-+/g,"-").replace(/^-+/,"").replace(/-+$/,""):""};function Tr(){const[n,o]=a.useState(!1),[s,c]=a.useState(null),u=a.useCallback(async f=>{if(n)return!1;if(!f)return c({type:"error",message:"Kein Einsatz ausgewÃ¤hlt."}),!1;const v=window.prompt("Bitte E-Mail-Adresse fÃ¼r den Versand eingeben:");if(v==null)return!1;const N=v.trim();if(!N)return c({type:"error",message:"Keine E-Mail-Adresse angegeben."}),!1;if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(N))return c({type:"error",message:"E-Mail-Adresse ist ungÃ¼ltig."}),!1;o(!0),c(null);try{const E=f?.content||"",D=f?.typ||f?.type||"",C=f?.additionalAddressInfo||f?.ort||"",R=f?.description||"",_={lat:f?.latitude??f?.lat??null,lng:f?.longitude??f?.lng??null},S=[f?.humanId,f?.content,f?.id].map(W=>W!=null?String(W).trim():"").find(W=>W),j=await qn({title:E,type:D,locationLabel:C,notes:R,coordinates:_,isArea:!!f?.isArea,areaColor:f?.areaColor,areaLabel:f?.areaLabel||f?.areaCardLabel}),m=Pr(S)||"einsatz",g=j.title||j.type||S||m,$=g?`Einsatzkarte ${g}`:"Einsatzkarte",T=[];j.title&&T.push(`Einsatz: ${j.title}`),j.location&&T.push(`Ort: ${j.location}`),T.push(`Gesendet: ${j.timestamp}`);const G=`Im Anhang finden Sie die aktuelle Einsatzkarte.

${T.join(`
`)}`.trim(),U=`<p>Im Anhang finden Sie die aktuelle Einsatzkarte.</p><ul>${[j.title?`<li><strong>Einsatz:</strong> ${j.title}</li>`:"",j.location?`<li><strong>Ort:</strong> ${j.location}</li>`:"",`<li><strong>Gesendet:</strong> ${j.timestamp}</li>`].filter(Boolean).join("")}</ul>`,ne=await fetch(`/api/incidents/${encodeURIComponent(m)}/mail`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({html:j.html,to:N,subject:$,textBody:G,htmlBody:U})}),ie=await ne.json().catch(()=>null);if(!ne.ok||!ie?.ok){const W=ie?.detail||ie?.error||ne.statusText||"Versand fehlgeschlagen.";throw new Error(W)}return c({type:"success",message:"E-Mail wurde versendet."}),!0}catch(E){const D=E?.message||"E-Mail-Versand fehlgeschlagen.";return c({type:"error",message:D}),!1}finally{o(!1)}},[n]),p=a.useCallback(()=>c(null),[]);return{mailBusy:n,mailFeedback:s,sendMail:u,resetMailFeedback:p}}const dt="#2563eb";function Lr(n={}){const o=n?.humanId?String(n.humanId):"",s=n?.content?String(n.content):"";return[o,s].filter(Boolean).join(" â€“ ")||o||s||"Abschnitt"}function St(n={}){return{title:n?.content||"",typ:n?.typ||n?.type||"",ort:n?.additionalAddressInfo||n?.ort||"",description:n?.description||"",isArea:!!n?.isArea,areaCardId:n?.isArea?"":n?.areaCardId||"",areaColor:n?.isArea?n?.areaColor||dt:n?.areaColor||""}}function $r({open:n,onClose:o,info:s={},canEdit:c=!1,onSave:u,areaOptions:p=[],areaLabelById:f=new Map,forceEdit:v=!1,types:N=[]}){if(!n)return null;const P=a.useMemo(()=>s?.isEditable!==!1,[s?.isEditable]),[E,D]=a.useState(!1),[C,R]=a.useState(!1),[_,S]=a.useState(!1),[j,m]=a.useState(()=>St(s)),[g,$]=a.useState(""),{mailBusy:T,mailFeedback:k,sendMail:G,resetMailFeedback:z}=Tr(),U=s?.timestamp,ne=U?new Date(U).toLocaleString("de-AT",{hour12:!1}):"â€”",ie=a.useMemo(()=>{const O=[];return s.location&&O.push(String(s.location)),Number.isFinite(s.latitude)&&Number.isFinite(s.longitude)&&O.push(`(${s.latitude}, ${s.longitude})`),O.length?O.join(" "):void 0},[s]),W=a.useMemo(()=>p.filter(O=>O.id!==s?.id),[p,s?.id]),V=a.useMemo(()=>{if(s?.isArea)return Lr(s);if(!s?.areaCardId)return"â€”";const O=f.get(s.areaCardId);if(O)return O;const J=p.find(he=>he.id===s.areaCardId);return J?J.label:String(s.areaCardId)},[s,f,p]);a.useEffect(()=>{m(St(s)),$(""),R(!1),D(!!(v&&c&&P))},[s,v,c,P,n]),a.useEffect(()=>{z()},[s?.id,n,z]);const q=()=>{C||(D(!1),$(""),o?.())},X=()=>{!c||!P||(m(St(s)),$(""),D(!0))},de=()=>{C||(m(St(s)),$(""),D(!1))},ce=async()=>{if(_)return;const O=s?.content||"",J=s?.typ||s?.type||"",he=s?.location||s?.additionalAddressInfo||s?.ort||"",re=s?.description||"",Ne=ut({lat:s?.latitude??s?.lat,lng:s?.longitude??s?.lng}),ge=!s?.isArea&&V&&V!=="â€”"?V:"",I=[s?.humanId,s?.content,s?.id].map(Z=>Z!=null?String(Z).trim():"").find(Z=>Z);S(!0);try{await Zn({title:O,type:J,locationLabel:he,notes:re,isArea:!!s?.isArea,areaColor:s?.isArea?s?.areaColor||dt:void 0,areaLabel:ge||void 0,coordinates:Ne,incidentId:I})}catch(Z){const ae=Z?.message||Z||"Drucken fehlgeschlagen.";alert(typeof ae=="string"?ae:String(ae))}finally{S(!1)}},se=async O=>{if(O?.preventDefault?.(),!u||!s?.id){D(!1);return}const J=(j.title||"").trim();if(!J){$("Titel darf nicht leer sein.");return}R(!0),$("");try{await u(s.id,{title:J,typ:(j.typ||"").trim(),ort:(j.ort||"").trim(),description:(j.description||"").trim(),isArea:!!j.isArea,areaCardId:j.isArea?null:j.areaCardId||null,areaColor:j.isArea?j.areaColor||dt:void 0}),D(!1)}catch(he){const re=he?.message||"Speichern fehlgeschlagen.";$(re)}finally{R(!1)}},A=({label:O,value:J})=>e.jsxs("div",{className:"flex items-start gap-3 py-1",children:[e.jsx("div",{className:"w-32 shrink-0 text-gray-600",children:O}),e.jsx("div",{className:"flex-1 font-medium break-words",children:J??"â€”"})]}),me=()=>e.jsxs("form",{onSubmit:se,className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-700",children:["Titel",e.jsx("input",{className:"mt-1 w-full border rounded px-2 py-1",value:j.title,onChange:O=>m(J=>({...J,title:O.target.value})),disabled:C})]}),e.jsxs("label",{className:"text-sm font-medium text-gray-700",children:["Typ",e.jsx("input",{className:"mt-1 w-full border rounded px-2 py-1",value:j.typ,onChange:O=>m(J=>({...J,typ:O.target.value})),list:"incident-info-types",disabled:C}),e.jsx("datalist",{id:"incident-info-types",children:(N||[]).map(O=>e.jsx("option",{value:O},O))})]}),e.jsxs("label",{className:"text-sm font-medium text-gray-700",children:["Ort",e.jsx("input",{className:"mt-1 w-full border rounded px-2 py-1",value:j.ort,onChange:O=>m(J=>({...J,ort:O.target.value})),disabled:C})]}),e.jsxs("label",{className:"text-sm font-medium text-gray-700",children:["Alarmzeit",e.jsx("input",{className:"mt-1 w-full border rounded px-2 py-1 bg-gray-100",value:ne,disabled:!0,readOnly:!0})]}),e.jsxs("label",{className:"text-sm font-medium text-gray-700",children:["Notiz",e.jsx("textarea",{className:"mt-1 w-full border rounded px-2 py-1 resize-y min-h-[90px]",value:j.description,onChange:O=>m(J=>({...J,description:O.target.value})),disabled:C})]}),e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:j.isArea,onChange:O=>m(J=>({...J,isArea:O.target.checked,areaCardId:O.target.checked?"":J.areaCardId,areaColor:O.target.checked?J.areaColor||dt:J.areaColor})),disabled:C}),"Abschnitt"]}),!j.isArea&&e.jsxs("select",{className:"border rounded px-2 py-1 text-sm",value:j.areaCardId,onChange:O=>m(J=>({...J,areaCardId:O.target.value})),disabled:C||W.length===0,children:[e.jsx("option",{value:"",children:"â€” Abschnitt auswÃ¤hlen â€”"}),W.map(O=>e.jsx("option",{value:O.id,children:O.label},O.id))]})]}),!j.isArea&&W.length===0&&e.jsx("p",{className:"text-xs text-gray-500",children:"Noch keine Abschnitte vorhanden."}),j.isArea&&e.jsxs("div",{className:"flex items-center justify-between gap-3 text-sm text-gray-700",children:[e.jsx("span",{children:"Farbe"}),e.jsx("input",{type:"color",className:"h-9 w-16 border rounded cursor-pointer",value:j.areaColor||dt,onChange:O=>m(J=>({...J,areaColor:O.target.value})),disabled:C})]})]}),g&&e.jsx("p",{className:"text-sm text-red-600",children:g}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",className:"px-3 py-1.5 rounded border",onClick:de,disabled:C,children:"Abbrechen"}),e.jsx("button",{type:"submit",className:"px-3 py-1.5 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:C,children:C?"Speichernâ€¦":"Speichern"})]})]});return e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:q}),e.jsxs("div",{className:"relative z-[101] w-[min(92vw,640px)] rounded-xl bg-white shadow-xl p-4 md:p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3 gap-2",children:[e.jsx("h2",{className:"text-lg md:text-xl font-bold",children:"Einsatz-Info"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",className:"px-3 py-1.5 rounded border bg-white text-sm hover:bg-gray-50 disabled:opacity-60",onClick:()=>G(s),disabled:T||!s,children:T?"Sendeâ€¦":"Mail senden"}),c&&P&&!E&&e.jsx("button",{type:"button",className:"px-3 py-1.5 rounded border bg-white text-sm hover:bg-gray-50",onClick:X,children:"Bearbeiten"}),e.jsx("button",{type:"button",className:"px-3 py-1.5 rounded border bg-white text-sm hover:bg-gray-50 disabled:opacity-60",onClick:ce,disabled:_,children:_?"Druckenâ€¦":"Drucken"}),e.jsx("button",{className:"h-8 w-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center",onClick:q,"aria-label":"SchlieÃŸen",title:"SchlieÃŸen",children:e.jsx("svg",{viewBox:"0 0 12 12",width:"14",height:"14","aria-hidden":"true",children:e.jsx("path",{d:"M1 1 L11 11 M11 1 L1 11",stroke:"black",strokeWidth:"2",strokeLinecap:"round"})})})]})]}),k&&e.jsx("div",{className:`mb-3 rounded border px-3 py-2 text-sm ${k.type==="error"?"border-red-200 bg-red-50 text-red-700":"border-emerald-200 bg-emerald-50 text-emerald-700"}`,children:k.message}),E?me():e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(A,{label:"Titel",value:s.content}),e.jsx(A,{label:"Typ",value:s.typ||s.type}),e.jsx(A,{label:"Einsatz ID",value:s.humanId}),e.jsx(A,{label:"Alarmzeit",value:ne}),e.jsx(A,{label:"Alarmiert",value:s.alerted}),e.jsx(A,{label:"Notiz",value:s.description}),e.jsx(A,{label:"Adresse",value:s.additionalAddressInfo||s.ort}),e.jsx(A,{label:"Location",value:ie}),e.jsx(A,{label:"Abschnitt",value:s.isArea&&s.areaColor?e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx("span",{className:"h-4 w-4 rounded border",style:{backgroundColor:s.areaColor,borderColor:s.areaColor},"aria-hidden":!0}),V]}):V}),!s.isArea&&s.areaColor&&e.jsx(A,{label:"Farbe",value:e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx("span",{className:"h-4 w-4 rounded border",style:{backgroundColor:s.areaColor,borderColor:s.areaColor},"aria-hidden":!0}),s.areaColor]})})]}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx("button",{className:"px-3 py-1.5 rounded-md bg-emerald-600 text-white hover:bg-emerald-700",onClick:q,children:"OK"})})]})]})]})}const Rr="||",Bn="done:";function Ct(n){if(n==null)return"";try{return String(n).normalize("NFKC").toLowerCase().replace(/\s+/g," ").trim()}catch{return String(n).toLowerCase().replace(/\s+/g," ").trim()}}function Dr(n){if(!n)return"";const o=n.replace(/\s+/g," ").trim();return o.length>200?o.slice(0,200)+"â€¦":o}function zr(n){const o=String(n||"");if(o==="information"||o.startsWith("information."))return"Information";if(o==="rueckmeldung1"||o.startsWith("rueckmeldung1."))return"RÃ¼ckmeldung";if(o==="lagebericht"||o.startsWith("lagebericht."))return"Lagebericht";if(o.startsWith("otherRecipientConfirmation"))return"EmpfÃ¤ngerbestÃ¤tigung";if(o.startsWith("ergehtAn"))return"Verteiler (ergeht an)";if(o.startsWith("uebermittlungsart"))return"Ãœbermittlungsart";if(o==="datum"||o==="zeit")return"Datum/Zeit";if(o==="zu")return"Zu-Nummer";const s=/^massnahmen\.(\d+)(?:\.(.+))?$/.exec(o);if(s){const c=Number(s[1])+1,u=s[2]||"";return u==="text"?`MaÃŸnahme ${c} Text`:u==="done"?`MaÃŸnahme ${c} Status`:`MaÃŸnahme ${c}${u?` (${u})`:""}`}return o||"Feld"}function kt(n){if(n===null||typeof n>"u")return"â€”";if(typeof n=="string"){const o=n.replace(/\s+/g," ").trim();return o?o.length>80?o.slice(0,77)+"â€¦":o:"â€”"}if(typeof n=="number"||typeof n=="boolean")return String(n);if(Array.isArray(n)){const o=n.length;return o===0?"[]":`[${o} EintrÃ¤ge]`}if(typeof n=="object"){if(typeof n.text=="string")return kt(n.text);if(typeof n.name=="string")return kt(n.name);try{const o=JSON.stringify(n);return o.length>80?o.slice(0,77)+"â€¦":o}catch{return"[Objekt]"}}return String(n)}function Fr(n){const o=Array.isArray(n?.history)?n.history:[];if(!o.length)return null;let s=null;for(let f=o.length-1;f>=0;f--){const v=o[f];if(v&&v.action==="update"&&Array.isArray(v.changes)){s=v;break}}if(!s)return null;const c=Array.isArray(s.changes)?s.changes:[];if(!c.length)return null;const u=[];for(const f of c){const v=zr(f.path),N=kt(f.before),P=kt(f.after);N!==P&&u.push(`${v}: ${N} â†’ ${P}`)}if(!u.length)return null;const p=5;if(u.length>p){const f=u.slice(0,p),v=u.length-p;return f.push(`(+${v} weitere Ã„nderungen)`),f.join(`
`)}return u.join(`
`)}function Jn(n){const o=new Set;if(n==null)return o;const s=String(n),c=Ct(s);if(c){o.add(c);const p=c.replace(/\s+/g,"");p&&p!==c&&o.add(p)}const u=s.split(/[/()[\]|]+/);for(const p of u){const f=Ct(p);if(!f)continue;o.add(f);const v=f.replace(/\s+/g,"");v&&v!==f&&o.add(v)}return o}function _r(n){const o=new Set,s=c=>{if(c!=null)for(const u of Jn(c))o.add(u)};return n&&typeof n=="object"&&(s(n.displayName),s(n.username),s(n.name),s(n.userId),n.id!=null&&s(n.id),s(n.role),n.role&&typeof n.role=="object"&&(s(n.role.id),s(n.role.name),s(n.role.label),s(n.role.displayName))),o}function On(n){if(typeof n!="string"||!n)return{raw:n??null,base:n??null,doneSignature:null};const o=n.split(Rr),s=o[0]||n;let c=null;for(let u=1;u<o.length;u+=1){const p=o[u];if(p.startsWith(Bn)){const f=p.slice(Bn.length);if(!f)c="";else try{c=decodeURIComponent(f)}catch{c=f}}}return{raw:n,base:s,doneSignature:c}}function Br(n){return Array.isArray(n)?n.reduce((o,s)=>{if(!s||s.action!=="print")return o;const c=Number(s?.printCount??s?.pages??0);return Number.isFinite(c)&&(o.sum+=Math.max(0,c),o.hasPrintEntries=!0),o},{sum:0,hasPrintEntries:!1}):{sum:0,hasPrintEntries:!1}}function Or(n){const{sum:o,hasPrintEntries:s}=Br(n?.history);if(s)return o;const c=Number(n?.printCount);return Number.isFinite(c)?Math.max(0,c):0}function Vr({searchTerm:n=""}){const[o,s]=a.useState([]),[c,u]=a.useState(!0),{user:p}=Hn()||{},f=a.useMemo(()=>_r(p),[p]),v=a.useMemo(()=>Ks(p),[p]),[N,P]=a.useState({});a.useEffect(()=>{if(!v){P({});return}P(wn(v))},[v]),a.useEffect(()=>{if(!v||typeof window>"u")return()=>{};const S=j=>{j?.key===v&&P(wn(v))};return window.addEventListener("storage",S),()=>{window.removeEventListener("storage",S)}},[v]);const E=a.useCallback((S,j)=>{v&&P(m=>Gs(v,S,j,m))},[v]),D=a.useCallback((S,j)=>{E(S.nr,j),window.location.hash=`/protokoll/edit/${S.nr}`},[E]);a.useEffect(()=>{let S=!1,j=null,m=null,g=!0,$=!1;const T=async()=>{if(S||$)return;$=!0,g&&u(!0),j?.abort();const G=new AbortController;j=G;try{const z=await fetch("/api/protocol",{credentials:"include",signal:G.signal});if(!z.ok)throw new Error(`HTTP ${z.status}`);const U=await z.json();if(S||j!==G)return;const ne=Array.isArray(U?.items)?U.items:[];s(ne)}catch(z){if(S||z?.name==="AbortError")return;g&&s([]),console.warn("[ProtokollOverview] Aktualisierung fehlgeschlagen",z)}finally{!S&&g&&u(!1),g=!1,$=!1}},k=()=>{document.visibilityState==="visible"&&T()};return T(),m=window.setInterval(T,5e3),document.addEventListener("visibilitychange",k),()=>{S=!0,j?.abort(),m&&window.clearInterval(m),document.removeEventListener("visibilitychange",k)}},[]);const C=a.useMemo(()=>Ct(n),[n]),R=C.length>0,_=a.useMemo(()=>{const S=[...o].sort((m,g)=>(Number(g.nr)||0)-(Number(m.nr)||0));if(!R)return S;const j=m=>Ct(m).includes(C);return S.filter(m=>{const g=m?.uebermittlungsart||{},$=[].concat(g.ein?"Eingang":[]).concat(g.aus?"Ausgang":[]),T=[m?.nr,m?.zu,m?.datum,m?.zeit,m?.anvon,m?.information,m?.infoTyp,g.kanal,g.kanalNr,g.art,$.join(" / ")];if(Array.isArray(m?.massnahmen))for(const k of m.massnahmen)T.push(k?.massnahme,k?.verantwortlich);return T.some(k=>j(k))})},[o,R,C]);return e.jsx("div",{className:"p-3 md:p-4 h-full flex flex-col w-full",children:e.jsx("div",{className:"flex-1 min-h-0 overflow-auto border rounded-lg bg-white",children:c?e.jsx("div",{className:"p-4 text-gray-500",children:"Ladeâ€¦"}):e.jsxs("table",{className:"min-w-[1100px] w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0 z-10",children:e.jsxs("tr",{className:"[&>th]:px-2 [&>th]:py-2 [&>th]:text-left [&>th]:font-semibold border-b",children:[e.jsx("th",{className:"text-center whitespace-nowrap w-1",children:"âœ“"}),e.jsx("th",{className:"text-center whitespace-nowrap w-1",children:"NR."}),e.jsx("th",{className:"whitespace-nowrap w-1",children:"Druck"}),e.jsx("th",{className:"whitespace-nowrap w-1",children:"Datum"}),e.jsx("th",{className:"whitespace-nowrap w-1",children:"Zeit"}),e.jsx("th",{className:"whitespace-nowrap w-1",children:"Kanal"}),e.jsx("th",{className:"whitespace-nowrap w-1",children:"Richtung"}),e.jsx("th",{className:"whitespace-nowrap w-1",children:"An/Von"}),e.jsx("th",{children:"Information"}),e.jsx("th",{className:"whitespace-nowrap w-1",children:"Meldungstyp"})]})}),e.jsxs("tbody",{className:"[&>tr>td]:px-2 [&>tr>td]:py-2 [&>tr>td]:align-middle",children:[_.map(S=>{const j=S?.uebermittlungsart||{},m=j.kanal??j.kanalNr??j.art??"",$=[].concat(j.ein?"Eingang":[]).concat(j.aus?"Ausgang":[]).join(" / "),T=Or(S),G=(Array.isArray(S?.massnahmen)?S.massnahmen:[]).filter(fe=>`${fe?.massnahme??""} ${fe?.verantwortlich??""}`.trim().length>0),z=G.some(fe=>!fe?.done),U=S?.otherRecipientConfirmation||{},ne=String(U?.byRole||"").toUpperCase();U?.confirmed;const W=Ws(S)&&!U?.confirmed,V=qs(S),q=V.token,X=String(S?.nr??""),de=X&&N?N[X]:null,ce=!!v,se=ce&&q&&de!==q,A=On(q),me=On(de),O=!!A.doneSignature,J=!!me.doneSignature,he=O&&J&&A.doneSignature===me.doneSignature,re=typeof V.by=="string"?V.by:null;let Ne=!1;if(re&&f.size){const fe=Jn(re);for(const Le of fe)if(f.has(Le)){Ne=!0;break}}const Z=O&&(!ce||!he)||se&&!Ne,ae=re&&re.trim()?re.trim():"Unbekannt",ue=A.doneSignature&&String(A.doneSignature).trim(),be=(ue?(()=>{const fe=ue.split(",").map(Re=>Re.trim()).filter(Boolean);return(fe[fe.length-1]||"").replace(/\s*#\d+\s*$/,"").trim()||null})():null)||ae,oe=Z?Fr(S):null,ve=Z?`Erstellt/geÃ¤ndert durch ${be}`:`GeÃ¤ndert durch ${be}`,Q=oe?`${ve}
${oe}`:ve,Y=!!U?.confirmed,le=[`${T}Ã— gedruckt`];if(z&&le.push("Offene Aufgaben vorhanden"),W&&le.push("BestÃ¤tigung ausstehend"),U?.confirmed){const fe=ne||"BestÃ¤tigt";le.push(`BestÃ¤tigt durch ${fe}`)}const F=le.join(" â€¢ "),ee=z?"border-red-500 text-red-600":"border-emerald-500 text-emerald-600",Se=W?"text-gray-400":z?"text-red-600":"";G.length>0;const je=!z,Ee=!!U?.confirmed&&je,ke=["border-b  cursor-pointer",Z?"bg-yellow-50 hover:bg-yellow-100":"hover:bg-gray-50",W?"text-gray-400 [&>td]:text-gray-400":""].join(" ");return e.jsxs("tr",{className:ke,onClick:()=>D(S,q),title:Q,"aria-label":Q,children:[e.jsx("td",{className:"align-middle text-center",children:Ee?e.jsx("span",{className:"inline-flex items-center justify-center text-emerald-600 text-lg font-semibold",title:"BestÃ¤tigt und alle MaÃŸnahmen erledigt",children:"âœ“"}):null}),e.jsx("td",{className:"align-middle text-center font-semibold whitespace-nowrap",children:(()=>{const fe=S.nr??"â€”",Le=S.zu!==null&&S.zu!==void 0&&String(S.zu).trim()!=="",Re=Le?String(S.zu):"",Me=Le?`${fe}/${Re}`:`${fe}`;return Y?e.jsx("span",{className:`inline-flex items-center justify-center px-3 h-8 rounded-full border-2 text-sm font-semibold ${ee}`,title:F,"aria-label":F,children:Me}):e.jsx("span",{className:`inline-block text-sm font-semibold ${Se}`,title:F,"aria-label":F,children:Me})})()}),e.jsx("td",{className:"font-semibold whitespace-nowrap",children:T}),e.jsx("td",{className:"whitespace-nowrap",children:S.datum}),e.jsx("td",{className:"whitespace-nowrap",children:S.zeit}),e.jsx("td",{className:"whitespace-nowrap",title:m,children:m}),e.jsx("td",{className:"whitespace-nowrap",title:$,children:$}),e.jsx("td",{className:"whitespace-nowrap",children:S.anvon}),e.jsx("td",{className:"whitespace-pre-wrap",children:Dr(S.information)}),e.jsx("td",{className:"whitespace-nowrap",children:S.infoTyp||"â€”"})]},S.nr)}),!_.length&&e.jsx("tr",{children:e.jsx("td",{colSpan:10,className:"p-4 text-gray-500 italic",children:"â€” keine EintrÃ¤ge â€”"})})]})]})})})}const Qn={},Ur=3e3,Hr=1e3;function At(n,o){const s=Number(n);if(Number.isFinite(s)&&s>0){const c=Math.floor(s);return c>0?c:o}return o}const Kr=At(Qn?.VITE_STATUS_POLL_INTERVAL_MS,Ur),Gr=At(Qn?.VITE_ACTIVITY_POLL_INTERVAL_MS,Hr);function Wr({autoEnabled:n,remaining:o,disabled:s=!1,showTimer:c=!0,showLastLoaded:u=!0,onImportInfo:p}){const[f,v]=a.useState(!1),[N,P]=a.useState(!1),[E,D]=a.useState(""),[C,R]=a.useState({remainingMin:null,idleMinutes:null,lastActivityIso:null,autoStopMin:null}),[_,S]=a.useState({lastLoadedIso:null,file:"list_filtered.json"});a.useEffect(()=>{typeof p=="function"&&p(_)},[_,p]);const[j,m]=a.useState(!1),[g,$]=a.useState(30),[T,k]=a.useState(null),[G,z]=a.useState(Kr),[U,ne]=a.useState(Gr),ie=a.useRef(!1),W=async()=>{try{const[X,de,ce]=await Promise.all([fetch("/api/ff/status",{credentials:"include",cache:"no-store"}).then(se=>se.json()).catch(()=>({running:!1})),fetch("/api/ff/creds",{credentials:"include",cache:"no-store"}).then(se=>se.json()).catch(()=>({has:!1})),fetch("/api/import/auto-config",{credentials:"include",cache:"no-store"}).then(se=>se.json()).catch(()=>({enabled:!1,intervalSec:30}))]);v(!!X.running),P(!!de.has),m(!!ce.enabled),$(Number(ce.intervalSec||30)),z(se=>At(ce.statusPollIntervalMs,se)),ne(se=>At(ce.activityPollIntervalMs,se)),ie.current||(ie.current=!0,de.has||D("Keine globalen Fetcher-Zugangsdaten. Bitte als Admin unter /user-admin setzen."))}catch{}};a.useEffect(()=>{W();const X=setInterval(()=>{W()},G);return()=>clearInterval(X)},[G]),a.useEffect(()=>{const X=async()=>{try{const ce=await fetch("/api/activity/status",{credentials:"include",cache:"no-store"});if(ce.ok){const se=await ce.json(),A=Number(se.idleMinutes),me=Number(se.autoStopMin),O=Math.max(0,Math.ceil(me-A));R({remainingMin:O,idleMinutes:A,lastActivityIso:se.lastActivityIso,autoStopMin:me}),v(!!se.fetcher?.running),S({lastLoadedIso:se.import?.lastLoadedIso??null,file:se.import?.file||"list_filtered.json"})}}catch{}};X();const de=setInterval(()=>{X()},U);return()=>clearInterval(de)},[U]),a.useEffect(()=>{let X;const de=()=>{if(!j||!_.lastLoadedIso){k(null);return}const se=new Date(_.lastLoadedIso).getTime()+g*1e3,A=Math.max(0,Math.ceil((se-Date.now())/1e3));k(A)};return de(),X=setInterval(de,1e3),()=>clearInterval(X)},[j,g,_.lastLoadedIso]);const V=typeof n=="boolean"?n:j,q=typeof o=="number"?o:T;return e.jsxs("div",{className:`flex items-center h-9 gap-2 ${s?"opacity-60 pointer-events-none":""}`,style:{alignItems:"center"},children:[c&&e.jsx("span",{className:`sync-chip ${V?"active":""}`,title:V?"Auto-Import Countdown":"Auto-Import ist deaktiviert",style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:"110px",minWidth:"110px",textAlign:"center"},children:V?`âŸ³ in ${q??"â€“"}s`:"â¸ manuell"}),E&&e.jsx("span",{style:{color:"#dc2626",fontSize:12,marginLeft:8},children:E}),f&&C.remainingMin!=null&&C.remainingMin<=15&&e.jsxs("div",{title:`Letzte AktivitÃ¤t: ${C.lastActivityIso?new Date(C.lastActivityIso).toLocaleString():"â€“"} â€¢ Inaktiv: ${C.idleMinutes?.toFixed?.(1)} min â€¢ Limit: ${C.autoStopMin} min`,className:"ml-2 inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border "+(C.remainingMin<=5?"bg-red-50 text-red-700 border-red-300":C.remainingMin<=15?"bg-amber-50 text-amber-700 border-amber-300":"bg-blue-50 text-blue-700 border-blue-300"),children:[e.jsx("span",{className:"mr-2 h-2 w-2 rounded-full bg-current",style:{animation:"pulse 1.5s ease-in-out infinite"}}),e.jsxs("span",{children:["Auto-Import stoppt in ",e.jsxs("b",{children:[C.remainingMin," min"]})]})]}),u&&e.jsx("div",{title:`Quelle: ${_.file}`,className:"ml-2 inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border bg-white text-gray-700",style:{borderColor:"#cbd5e1"},children:e.jsxs("span",{children:["Zuletzt geladen:"," ",e.jsx("b",{children:_.lastLoadedIso?new Date(_.lastLoadedIso).toLocaleTimeString("de-AT",{hour12:!1}):"â€“"})]})})]})}function qr(){const[n,o]=a.useState(.9);return a.useEffect(()=>{const s=()=>{const c=window.innerWidth,u=window.innerHeight,p=Math.min(Math.max(Math.min(c/1440,u/900),.78),.95);o(Number(p.toFixed(2)))};return s(),window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[]),n}function Zr(){try{const n=new URLSearchParams(window.location.search),o=parseFloat(n.get("font"));if(Number.isFinite(o)&&o>=.5&&o<=5)return o}catch{}try{const n=parseFloat(localStorage.getItem("ff_font_scale")||"");if(Number.isFinite(n)&&n>=.5&&n<=5)return n}catch{}return 1.2}const Yn=n=>new Intl.DateTimeFormat("de-AT",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).format(new Date(n||Date.now())),Xn=n=>Array.isArray(n?.assignedVehicles)?n.assignedVehicles.length:0,es=(n,o)=>(n?.assignedVehicles||[]).reduce((s,c)=>{const u=o.get(c);return s+(typeof u?.mannschaft=="number"?u.mannschaft:0)},0),Jr=()=>{if(typeof window>"u")return{id:"",label:""};try{const n=new URLSearchParams(window.location.search),o=n.get("bereichId")||n.get("abschnittId")||n.get("areaId")||"",s=n.get("bereich")||n.get("abschnitt")||n.get("area")||"";return{id:String(o||"").trim(),label:String(s||"").trim()}}catch{return{id:"",label:""}}};function Qr({c:n,vehiclesById:o,showBottomCounts:s=!0,headerRight:c,kind:u}){const p=u==="erledigt",f=p?Array.isArray(n?.everVehicles)?n.everVehicles.length:0:Xn(n),v=p?Number.isFinite(n?.everPersonnel)?n.everPersonnel:0:es(n,o),N=n?.isArea?"bg-slate-100 border-slate-200":"bg-white";return e.jsxs("div",{className:`border rounded-lg p-2 shadow-sm text-[0.9rem] leading-tight ${N}`,children:[e.jsxs("div",{className:"flex items-start justify-between text-[0.72rem] text-gray-600 mb-1",children:[e.jsx("span",{children:Yn(n.createdAt)}),e.jsx("span",{className:"font-semibold",children:c})]}),e.jsx("div",{className:"font-semibold",children:n.content}),(n.humanId||n.typ||n.ort||n.alerted)&&e.jsxs("div",{className:"text-[0.75rem] text-gray-600 mt-0.5 space-y-0.5",children:[(n.humanId||n.typ)&&e.jsxs("div",{className:"flex flex-wrap items-center gap-x-2 gap-y-0.5",children:[n.humanId&&e.jsx("span",{className:"font-semibold text-gray-700",children:n.humanId}),n.typ&&e.jsxs("span",{children:["ðŸ·ï¸ ",n.typ]})]}),(n.ort||n.alerted)&&e.jsxs("div",{className:"flex flex-wrap items-center gap-x-2 gap-y-0.5",children:[n.ort&&e.jsxs("span",{children:["ðŸ“ ",n.ort]}),n.alerted&&e.jsxs("span",{className:"text-gray-500",children:["ðŸ”” ",n.alerted]})]})]}),s&&e.jsxs("div",{className:"mt-1 text-[0.78rem] text-gray-700 flex items-center gap-2",children:[e.jsxs("span",{children:["ðŸš’ ",f]}),e.jsxs("span",{children:["ðŸ‘¥ ",v]})]})]})}function Jt({title:n,cards:o,vehiclesById:s,kind:c,viewportH:u}){const v=Math.max(160,u-56-40),N=Math.max(1,Math.floor(v/96)),P=N*2,E=N+1,D=Math.max(P+2,E+6);let C="grid-cols-1";o.length>=D?C="grid-cols-3":o.length>=E&&(C="grid-cols-2");const R=j=>Yn(j.statusSince),_=a.useMemo(()=>{let j=0,m=0,g=0,$=0,T=0;for(const k of o)if(j+=1,k?.isArea?m+=1:g+=1,c==="erledigt")$+=Array.isArray(k?.everVehicles)?k.everVehicles.length:0,T+=Number.isFinite(k?.everPersonnel)?k.everPersonnel:0;else{$+=Array.isArray(k?.assignedVehicles)?k.assignedVehicles.length:0;const G=Array.isArray(k?.assignedVehicles)?k.assignedVehicles:[];for(const z of G){const U=s.get(z);typeof U?.mannschaft=="number"&&(T+=U.mannschaft)}}return{cardCount:j,areaCount:m,incidentCount:g,unitSum:$,personSum:T}},[o,c,s]),S={neu:"bg-red-100","in-bearbeitung":"bg-yellow-100",erledigt:"bg-green-100"}[c]||"bg-gray-100";return e.jsxs("section",{className:`${S} rounded-xl shadow p-3 h-full flex flex-col min-h-0`,children:[e.jsxs("h3",{className:"text-sm font-semibold mb-2",children:[n," â€” â¬› ",_.incidentCount," | ðŸ—ºï¸ ",_.areaCount," | ðŸš’ ",_.unitSum," | ðŸ‘¥ ",_.personSum]}),e.jsx("div",{className:`grid ${C} gap-2 overflow-auto pr-1 flex-1 min-h-0 place-content-start`,children:o.map(j=>e.jsx(Qr,{c:j,vehiclesById:s,headerRight:R(j),showBottomCounts:!0,kind:c},j.id))}),o.length===0&&e.jsx("div",{className:"text-[0.8rem] text-gray-500 italic text-center py-4",children:"â€” keine EintrÃ¤ge â€”"})]})}function Yr(){qr();const[n,o]=a.useState(Zr());a.useEffect(()=>{const m=document.documentElement.style.fontSize||"",g=Math.max(50,Math.min(500,Math.round(n*100)));return document.documentElement.style.fontSize=g+"%",()=>{document.documentElement.style.fontSize=m}},[n]),a.useEffect(()=>{const m=g=>{if(g.key==="ff_font_scale"){const $=parseFloat(g.newValue||"");Number.isFinite($)&&$>=.5&&$<=5&&o($)}};return window.addEventListener("storage",m),()=>window.removeEventListener("storage",m)},[]);const[s,c]=a.useState(null),[u,p]=a.useState([]),[f,v]=a.useState(window.innerHeight);a.useEffect(()=>{let m=!0;const g=async()=>{const[k,G]=await Promise.all([Ce(),Be()]);m&&(c(k),p(G))};g();const $=setInterval(g,7e3),T=()=>v(window.innerHeight);return window.addEventListener("resize",T),()=>{m=!1,clearInterval($),window.removeEventListener("resize",T)}},[]),a.useEffect(()=>{try{const m=new URLSearchParams(window.location.search);if(m.get("print")==="1"||m.get("pdf")==="1"){const g=setTimeout(()=>{window.print()},600);return()=>clearTimeout(g)}}catch{}},[]),a.useEffect(()=>{const m=()=>{try{window.close()}catch{}};return window.addEventListener("afterprint",m),()=>window.removeEventListener("afterprint",m)},[]);const N=a.useMemo(()=>Jr(),[]),P=a.useMemo(()=>new Map(u.map(m=>[m.id,m])),[u]),{columns:E,areaLabel:D}=a.useMemo(()=>{const m={neu:{name:"Neu",items:[]},"in-bearbeitung":{name:"In Bearbeitung",items:[]},erledigt:{name:"Erledigt",items:[]}},g=s?.columns||m,$=q=>{const X=g[q]||m[q];return{name:X?.name||m[q].name,items:Array.isArray(X?.items)?[...X.items]:[]}},T={neu:$("neu"),"in-bearbeitung":$("in-bearbeitung"),erledigt:$("erledigt")},k=[];for(const q of["neu","in-bearbeitung","erledigt"])for(const X of g[q]?.items||[])X?.isArea&&k.push(X);const G=N.id,z=N.label,U=!!(G||z),ne=String(G||"").toLowerCase(),ie=String(z||"").toLowerCase();let W=null;if(k.length&&U&&(G&&(W=k.find(q=>String(q?.id)===G)||k.find(q=>String(q?.id||"").toLowerCase()===ne)||k.find(q=>String(q?.humanId||"").toLowerCase()===ne)),!W&&z&&(W=k.find(q=>String(q?.content||"").toLowerCase()===ie)),!W&&z&&(W=k.find(q=>String(q?.content||"").toLowerCase().includes(ie)))),W){const q=String(W.id);for(const X of["neu","in-bearbeitung","erledigt"]){const de=T[X]?.items||[];T[X]={...T[X],items:de.filter(ce=>ce?.isArea?String(ce.id)===q:(ce?.areaCardId!=null?String(ce.areaCardId):"")===q)}}}else if(U)for(const q of["neu","in-bearbeitung","erledigt"])T[q]={...T[q],items:[]};const V=(W?.content||"").trim()||(W?.humanId||"").trim()||U&&(N.label||N.id)||"";return{columns:T,areaLabel:V}},[s,N.id,N.label]),C=a.useMemo(()=>{const m="Einsatzstellen-Ãœbersicht-Feuerwehr";return D?`${m} - ${D}`:m},[D]);a.useEffect(()=>{if(typeof document>"u")return;const m=document.title;return document.title=C,()=>{document.title=m}},[C]);const R=a.useMemo(()=>{let m=0;for(const g of["neu","in-bearbeitung"])for(const $ of E[g].items||[])m+=Xn($);return m},[E]),_=a.useMemo(()=>{let m=0;for(const g of["neu","in-bearbeitung"])for(const $ of E[g].items||[])m+=es($,P);return m},[E,P]),S=a.useMemo(()=>{let m=0;for(const g of E.neu.items||[])g?.isArea||(m+=1);for(const g of E["in-bearbeitung"].items||[])g?.isArea||(m+=1);return m},[E]),j=a.useMemo(()=>{let m=S;for(const g of E.erledigt.items||[])g?.isArea||(m+=1);return m},[S,E]);return s?e.jsx("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden",children:e.jsxs("div",{className:"h-full w-full flex flex-col gap-2",children:[e.jsxs("header",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:C}),e.jsxs("div",{className:"text-base md:text-lg font-bold flex flex-wrap gap-4",children:[e.jsxs("span",{children:["ðŸš’ ",R]}),e.jsxs("span",{children:["ðŸ‘¥ ",_]}),e.jsxs("span",{children:["ðŸŸ¡ Aktiv: ",S]}),e.jsxs("span",{children:["ðŸ“¦ Gesamt: ",j]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2 min-h-0 flex-1",children:[e.jsx(Jt,{title:"Neu",cards:E.neu.items,vehiclesById:P,kind:"neu",viewportH:f}),e.jsx(Jt,{title:"In Bearbeitung",cards:E["in-bearbeitung"].items,vehiclesById:P,kind:"in-bearbeitung",viewportH:f}),e.jsx(Jt,{title:"Erledigt",cards:E.erledigt.items,vehiclesById:P,kind:"erledigt",viewportH:f})]})]})}):e.jsx("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden",children:e.jsx("div",{className:"h-full w-full flex items-center justify-center",children:"Ladeâ€¦"})})}const Xr="S2",ea=3e4,ta=" - *** - NEUE LAGEMELDUNG: ",na=" - *** -",Vn="Â ".repeat(30);function sa(){const[n]=a.useState(.9);return n}const ra=n=>`card:${n}`,Ke=!0,aa="#2563eb",ia=2e4,oa={einsatz:{key:"einsatz",label:"E",title:"Zur EinsatzÃ¼bersicht",onClick:()=>{window.location.href="/"}},aufgaben:{key:"aufgaben",label:"A",title:"Zum Aufgaben-Board",onClick:()=>{window.location.href="/aufgaben"}},meldestelle:{key:"meldestelle",label:"M",title:"Zur Meldestelle",onClick:()=>{window.location.href="/#/protokoll"}}};function Nt(n){return Object.values(oa).filter(o=>o.key!==n)}function la(n){if(typeof n!="string")return null;const o=n.trim();if(!o)return null;const s=o.match(/^(\d+):(\d{1,2})$/);if(s){const v=Number(s[1]),N=Number(s[2]);if(Number.isFinite(v)&&Number.isFinite(N))return(v*60+N)*6e4}const u=o.replace(",",".").toLowerCase().match(/^([0-9]+(?:\.[0-9]+)?)([a-zÃ¤Ã¶Ã¼]*)$/);if(!u)return null;const p=Number(u[1]);if(!Number.isFinite(p)||p<=0)return null;const f=u[2];return!f||f==="m"||f==="min"||f==="mins"||f==="minute"||f==="minuten"?p*6e4:f==="h"||f==="st"||f==="std"||f==="stunde"||f==="stunden"?p*36e5:f==="s"||f==="sek"||f==="sekunde"||f==="sekunden"?p*1e3:f==="d"||f==="tag"||f==="tage"||f==="day"||f==="days"?p*864e5:null}function ca({available:n,alerted:o,assigned:s}){return n?s?{container:"border-red-400 bg-white",label:"text-gray-700"}:o?{container:"border-blue-500 bg-blue-50",label:"text-blue-900"}:{container:"border-green-400 bg-white",label:"text-gray-700"}:{container:"border-gray-300 bg-gray-50",label:"text-gray-400"}}function ma(){if(sa(),typeof window<"u"&&window.location.pathname==="/status")return e.jsx(Yr,{});const n=Zs(),o=n.running||n.paused,[s,c]=a.useState(!1);a.useEffect(()=>{vn().then(()=>c(!0))},[]);const u=s&&Sn("einsatzboard"),p=u||s&&Gt("S1"),f=!u,[v,N]=a.useState(null),[P,E]=a.useState([]),[D,C]=a.useState([]),[R,_]=a.useState(new Map),[S,j]=a.useState(new Map),m=a.useRef(new Map),g=a.useRef(new Map),$=a.useRef(new Map),T=a.useRef(new Map),k=a.useCallback(t=>{if(typeof window>"u")return{cancelled:!0};const i=`Bitte Dauer der Nicht-VerfÃ¼gbarkeit fÃ¼r ${t} angeben (z.â€¯B. 30, 2h oder 1:30). Leer lassen fÃ¼r unbegrenzt.`,r=window.prompt(i,"");if(r===null)return{cancelled:!0};const l=r.trim();if(!l)return{cancelled:!1,untilMs:null,untilIso:null};const d=la(l);if(!Number.isFinite(d)||d<=0)return window.alert("UngÃ¼ltige Dauer. Bitte z.â€¯B. 30, 2h oder 1:30 eingeben."),{cancelled:!0};const h=Date.now()+d;return{cancelled:!1,untilMs:h,untilIso:new Date(h).toISOString()}},[]),G=a.useCallback(async()=>{try{const t=await Be();E(t)}catch(t){console.error(t)}},[E]),z=a.useCallback((t,i)=>{if(!t||!i)return;const r=Date.parse(i);if(!Number.isFinite(r))return;const l=m.current,d=l.get(t);if(d&&d.untilIso===i)return;d&&(clearTimeout(d.timeout),l.delete(t));const h=r-Date.now(),x=async()=>{m.current.delete(t),g.current.delete(t);try{await En(t,!0)}catch(L){console.error(L)}await G()};if(h<=0){x();return}const b=setTimeout(x,h);l.set(t,{timeout:b,untilIso:i})},[G]),U=a.useCallback((t,i)=>{if(!t||!i)return;const r=Date.parse(i);if(!Number.isFinite(r))return;const l=$.current,d=l.get(t);if(d&&d.untilIso===i)return;d&&(clearTimeout(d.timeout),l.delete(t));const h=r-Date.now(),x=async()=>{$.current.delete(t),T.current.delete(t);try{await Mn(t,!0)}catch(L){console.error(L)}await G(),_(L=>{const w=new Map(L);return w.set(t,!0),w})};if(h<=0){x();return}const b=setTimeout(x,h);l.set(t,{timeout:b,untilIso:i})},[G,_]);a.useEffect(()=>{const t=m.current,i=new Set;for(const r of P){if(!r)continue;const l=String(r.id??"").trim();if(!l)continue;i.add(l);const d=r.available!==!1&&r.groupAvailable!==!1,h=r.unavailableUntil||g.current.get(l)||null,x=h?Date.parse(h):NaN,b=Number.isFinite(x)?new Date(x).toISOString():null,L=String(r.ort??"").trim();if((R.has(L)?R.get(L):!0)===!1){b?g.current.set(l,b):g.current.delete(l);const M=t.get(l);M&&(clearTimeout(M.timeout),t.delete(l));continue}if(d||!b){const M=t.get(l);M&&(clearTimeout(M.timeout),t.delete(l)),g.current.delete(l);continue}g.current.set(l,b),z(l,b)}for(const[r,l]of Array.from(t.entries()))i.has(r)||(clearTimeout(l.timeout),t.delete(r),g.current.delete(r))},[P,R,z]),a.useEffect(()=>{const t=$.current,i=new Set;for(const[r,l]of R.entries()){const d=String(r||"").trim();if(!d)continue;if(i.add(d),l!==!1){const L=t.get(d);L&&(clearTimeout(L.timeout),t.delete(d)),T.current.delete(d);continue}const h=T.current.get(d)||null,x=h?Date.parse(h):NaN;if(!Number.isFinite(x)){const L=t.get(d);L&&(clearTimeout(L.timeout),t.delete(d)),T.current.delete(d);continue}const b=new Date(x).toISOString();T.current.set(d,b),U(d,b)}for(const[r,l]of Array.from(t.entries()))i.has(r)||(clearTimeout(l.timeout),t.delete(r),T.current.delete(r))},[R,U]),a.useEffect(()=>()=>{for(const{timeout:t}of m.current.values())clearTimeout(t);m.current.clear(),g.current.clear();for(const{timeout:t}of $.current.values())clearTimeout(t);$.current.clear(),T.current.clear()},[]);const ne=a.useCallback(t=>{Array.isArray(t)&&_(i=>{let r=!1;const l=new Map(i);for(const d of t){if(!d||!d.ort)continue;const h=String(d.ort),x=d.groupAvailable!==!1;(!l.has(h)||l.get(h)!==x)&&(l.set(h,x),r=!0)}return r?l:i})},[]);a.useEffect(()=>{ne(P)},[P,ne]);const ie=a.useCallback(t=>{const i=Object.entries(t?.availability||{}),r=[],l=new Map;for(const[d,h]of i){const b=!(h===!1||h&&typeof h=="object"&&h.available===!1);let L=null;if(!b){const w=h&&typeof h=="object"?h.until:null;if(typeof w=="string"&&w.trim()){const M=Date.parse(w);!Number.isNaN(M)&&M>Date.now()&&(L=new Date(M).toISOString())}}r.push([d,b]),!b&&L&&l.set(d,L)}T.current=l,_(new Map(r))},[]),W=a.useCallback(t=>{const i=Object.entries(t?.alerted||{});j(new Map(i.map(([r,l])=>[r,l===!0])))},[]),[V,q]=a.useState(""),[X,de]=a.useState(""),[ce,se]=a.useState(""),{user:A}=Hn()||{},{roles:me}=Js(),O=a.useMemo(()=>me.some(t=>t==="LTSTB"||t==="LTSTBSTV"),[me]),[J,he]=a.useState(!1),[re,Ne]=a.useState(!1),[ge,I]=a.useState(!1),[Z,ae]=a.useState(null),[ue,we]=a.useState(null),[be,oe]=a.useState(""),[ve,Q]=a.useState(!1),[Y,le]=a.useState(!1),[F,ee]=a.useState(30),[Se,je]=a.useState(!1),[Te,Ee]=a.useState({lastLoadedIso:null,file:"list_filtered.json"}),[ke,fe]=a.useState(!1),[Le,Re]=a.useState(!1),[Me,Ge]=a.useState(!1),[y,te]=a.useState(null),[Ie,pe]=a.useState(!1),We=a.useCallback(t=>{te(t),pe(!1),Ge(!0)},[]),Oe=a.useRef(null),[st,qe]=a.useState([]);a.useEffect(()=>{let t=!1;return(async()=>{try{if(await vn(),t)return;const i=Sn("protokoll",A),r=!O&&Gt("S3",A);he(i||r),Ne(Gt("S3",A)&&O)}catch{if(t)return;he(!1),Ne(!1)}})(),()=>{t=!0}},[O,A]);const[It,ts]=a.useState(window.location.hash);a.useEffect(()=>{const t=()=>ts(window.location.hash);return window.addEventListener("hashchange",t),()=>window.removeEventListener("hashchange",t)},[]);const ft=It.replace(/^#/,""),[Yt,Xt]=a.useState(()=>new Set),[Et,Mt]=a.useState(0),rt=a.useRef(null),Fe=a.useRef(null),en=a.useRef(0),tn=a.useRef(new Set),nn=a.useRef(0),sn=a.useRef(0),mt=a.useRef(null),Ze=a.useRef(0),[ns,ht]=a.useState(0);a.useEffect(()=>{document.title="Einsatzstellen-Ãœbersicht-Feuerwehr",Qs()},[]),a.useEffect(()=>()=>{Fe.current&&(clearTimeout(Fe.current),Fe.current=null),rt.current&&(clearTimeout(rt.current),rt.current=null)},[]),a.useEffect(()=>{(async()=>{try{await Kn(Qt())}catch{}})()},[]),a.useEffect(()=>{V||(Fe.current&&(clearTimeout(Fe.current),Fe.current=null),ge&&I(!1))},[V,ge]),a.useEffect(()=>{if(!u)return;if(!Y){ht(0);return}const t=setInterval(()=>ht(i=>i+1),1e3);return()=>clearInterval(t)},[Ke,Y]);const ss=Y?Math.max(0,F-ns%Math.max(1,F)):0;a.useEffect(()=>{document.title="Einsatzstellen-Ãœbersicht-Feuerwehr"},[]),a.useEffect(()=>{(async()=>{const[t,i,r,l,d]=await Promise.all([Ce(),Be(),Ys(),Xs().catch(()=>({availability:{}})),Nn().catch(()=>({alerted:{}}))]);N(t),E(i),C(Array.isArray(r)?r:[]),ie(l),W(d),ye(t),nn.current=Date.now()+ia;try{const h=await er();le(!!h.enabled),ee(Number(h.intervalSec)||30),je(!!h.demoMode)}catch{}ht(0)})()},[Ke]),a.useEffect(()=>{Y&&(async()=>{try{(await fetch("/api/ff/status",{credentials:"include",cache:"no-store"}).then(i=>i.json()).catch(()=>({running:!1}))).running||await fetch("/api/ff/start",{method:"POST",credentials:"include"})}catch{}})()},[Ke,Y,F]),a.useEffect(()=>{let t=!1,i=null,r=0;const l=Math.max(5,Math.min(60,Y?8:15)),d=async()=>{if(Date.now()-Ze.current<5e3){t||(i=setTimeout(d,l*1e3));return}const x=++r;try{const b=new Set($t.current),L=mt.current,w=await Ce();!t&&x===r&&(typeof requestIdleCallback=="function"?requestIdleCallback(()=>{N(w),zt({oldIds:b,oldBoard:L,newBoard:w,pulseMs:8e3})}):(N(w),zt({oldIds:b,oldBoard:L,newBoard:w,pulseMs:8e3})))}catch{}t||(i=setTimeout(d,l*1e3))};return i=setTimeout(d,l*1e3),()=>{t=!0,i&&clearTimeout(i)}},[Ke,Y]),a.useEffect(()=>{let t=!1,i=null,r=0;const l=Math.max(5,Math.min(60,Y?8:15)),d=async()=>{const h=++r;try{const x=await Nn();!t&&h===r&&W(x)}catch{}t||(i=setTimeout(d,l*1e3))};return d(),()=>{t=!0,i&&clearTimeout(i)}},[Ke,Y,W]),a.useEffect(()=>{const t=i=>{i.altKey&&(i.key==="e"||i.key==="E")&&(i.preventDefault(),Re(!0))};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[Ke]);const at=a.useMemo(()=>X.trim().toLowerCase(),[X]),Je=at.length>0,Pe=v??{columns:{neu:{items:[]},"in-bearbeitung":{items:[]},erledigt:{items:[]}}},Pt=a.useMemo(()=>st.length?`${st.map(i=>`${ta}${i}${na}`).join(Vn)}${Vn}`:"",[st]),rn=a.useCallback(async()=>{Oe.current&&Oe.current.abort();const t=new AbortController;Oe.current=t;try{const i=await tr(Xr,{signal:t.signal}),l=(Array.isArray(i?.items)?i.items:[]).filter(d=>String(d?.status??"").trim().toLowerCase()==="neu").filter(d=>String(d?.type??"").trim().toLowerCase()==="lagemeldung").map(d=>typeof d?.desc=="string"?d.desc:"").map(d=>d.replace(/\s+/g," ").trim()).filter(Boolean);t.signal.aborted||qe(l)}catch{t.signal.aborted||qe([])}finally{Oe.current===t&&(Oe.current=null)}},[qe]);a.useEffect(()=>{if(!s)return;const t=()=>{rn().catch(()=>{})};t();const i=setInterval(t,ea);return()=>{clearInterval(i),Oe.current&&Oe.current.abort()}},[rn,s]);const it=a.useMemo(()=>{const t=!!V;if(!t&&!Je)return Pe;const i=String(V),r={};for(const[l,d]of Object.entries(Pe?.columns||{})){let h=d?.items||[];t&&(h=h.filter(x=>dn(x,i))),Je&&(h=h.filter(x=>os(x,at))),r[l]={...d,items:h}}return{...Pe,columns:r}},[Pe,V,Je,at]),rs=(t,i=!1)=>{const r=String(t||"");return!i||!r?r:/^B/i.test(r)?`B${r.slice(1)}`:/^[A-Za-z]/.test(r)?`B${r.slice(1)}`:`B${r}`},an=t=>{if(!t)return"";const i=t.humanId?String(t.humanId):"",r=rs(i,!!t.isArea),l=t.content?String(t.content):"";return[r,l].filter(Boolean).join(" â€“ ")||r||l||""},Qe=a.useMemo(()=>{const t=Pe?.columns||{},i=[];for(const r of Object.keys(t))for(const l of t[r]?.items||[])l?.isArea&&i.push(l);return i},[Pe]),Ye=a.useMemo(()=>{const t=new Map;return Qe.forEach(i=>{if(!i?.id)return;const r=String(i.id);t.set(r,an(i))}),t},[Qe]),Tt=a.useMemo(()=>{const t=new Map;return Qe.forEach(i=>{i?.id&&t.set(String(i.id),i.areaColor||null)}),t},[Qe]),He=a.useMemo(()=>Qe.map(t=>({id:String(t.id),label:Ye.get(String(t.id))||an(t),color:Tt.get(String(t.id))||null})),[Qe,Ye,Tt]);a.useEffect(()=>{if(!V)return;He.some(i=>String(i.id)===V)||q("")},[V,He]);const on=a.useMemo(()=>{if(!V)return"";const t=String(V);return Ye.get(t)||He.find(i=>String(i.id)===t)?.label||""},[V,Ye,He]),Lt=(t,i)=>{if(t?.id&&$e(t.id),i){if(N(i),ye(i),t?.id&&y?.id===t.id){const r=bt(i,t.id);te(r||t)}return}t&&(N(r=>{if(!r)return r;const l=structuredClone(r);for(const d of Object.keys(l.columns||{})){const h=l.columns[d]?.items||[],x=h.findIndex(b=>b?.id===t.id);if(x>=0){h[x]={...h[x],...t};break}}return ye(l),l}),y?.id===t.id&&te(r=>r?{...r,...t}:t))},as=10;function is(t){try{const i=t?.columns||{};return[(i.neu?.items||[]).length,(i["in-bearbeitung"]?.items||[]).length,(i.erledigt?.items||[]).length].some(l=>l>=as)}catch{return!1}}a.useEffect(()=>{const t=is(Pe);document.documentElement.classList.toggle("ui-dense",t)},[Pe]);const[ot,ln]=a.useState(new Set),$t=a.useRef(new Set),ye=t=>{mt.current=t,$t.current=Rt(t)},$e=(...t)=>{t.map(i=>String(i??"").trim()).filter(Boolean).forEach(i=>tn.current.add(i))};a.useEffect(()=>{if(!ot.size)return;const t=setTimeout(()=>ln(new Set),9e3);return()=>clearTimeout(t)},[ot]);function Rt(t){const i=new Set;if(!t?.columns)return i;for(const r of Object.keys(t.columns))for(const l of t.columns[r].items||[])i.add(String(l.id));return i}function Dt(t){return Array.isArray(t)?t.map(Dt):t&&typeof t=="object"?Object.fromEntries(Object.keys(t).sort().map(i=>[i,Dt(t[i])])):t}function gt(t,{ignoreUpdatedAt:i=!1}={}){if(!t||typeof t!="object")return t;const{columnId:r,status:l,updatedAt:d,column:h,...x}=t,b={...x};return!i&&typeof d<"u"&&(b.updatedAt=d),Dt(b)}function cn(t){const i=new Map;if(!t?.columns)return i;for(const[r,l]of Object.entries(t.columns))for(const d of l?.items||[])!d||typeof d.id>"u"||d.id===null||i.set(String(d.id),{card:d,columnId:r});return i}function dn(t,i){return t?i?t.isArea?String(t.id)===i:t.areaCardId?String(t.areaCardId)===i:!1:!0:!1}function os(t,i){if(!i)return!0;if(!t)return!1;try{return JSON.stringify(t).toLowerCase().includes(i)}catch{return!1}}function ls(t,i){if(!i)return!0;if(!t)return!1;try{return JSON.stringify(t).toLowerCase().includes(i)}catch{return!1}}const cs=(t=8e3)=>{I(!0),Fe.current&&clearTimeout(Fe.current),Fe.current=setTimeout(()=>{I(!1),Fe.current=null},t)};function zt({oldIds:t,oldBoard:i,newBoard:r,pulseMs:l=8e3}){const d=Date.now(),h=i??mt.current,x=t??Rt(h),b=Rt(r),L=new Set;for(const H of b)x.has(H)||L.add(H);const w=tn.current,M=new Set([...L].filter(H=>!w.has(String(H)))),B=new Set;if(h&&r){const H=cn(h),xe=cn(r);for(const[Ae,tt]of xe.entries()){if(!H.has(Ae)||w.has(String(Ae)))continue;const Kt=H.get(Ae),zs=gt(Kt.card),Fs=gt(tt.card);if(JSON.stringify(zs)!==JSON.stringify(Fs)){if(Kt.columnId!==tt.columnId){const _s=gt(Kt.card,{ignoreUpdatedAt:!0}),Bs=gt(tt.card,{ignoreUpdatedAt:!0});if(JSON.stringify(_s)===JSON.stringify(Bs))continue}B.add(Ae)}}}const K=new Set([...M,...B]);if(K.size>0){if(d<nn.current){ye(r),w.clear();return}if(ln(K),sn.current=d,Mt(d+l),V){const H=String(V);[...K].some(Ae=>{const tt=bt(r,Ae);return tt?!dn(tt,H):!1})&&cs(l)}}ye(r),w.clear()}a.useEffect(()=>{if(!ot.size||!sn.current||Date.now()<en.current)return;let i=requestAnimationFrame(()=>{try{nr()}catch{}});return()=>cancelAnimationFrame(i)},[ot]);const[Ft,un]=a.useState(!1),ds=async()=>{if(!Ft){un(!0);try{const t=new Set($t.current),i=mt.current,r=await fetch("/api/import/trigger",{method:"POST",credentials:"include"});if(!r.ok){const d=await r.text().catch(()=>"");throw new Error(`Import fehlgeschlagen (HTTP ${r.status}) ${d}`)}const l=await Ce();N(l),zt({oldIds:t,oldBoard:i,newBoard:l,pulseMs:8e3}),ht(0)}catch(t){alert(t.message||"Import fehlgeschlagen.")}finally{un(!1)}}},[us,fn]=a.useState(!1);async function fs(t,i){if(us)return;const r=Ve.get(t);if(!r)return;const l=String(r.id||""),d=new Set(P.filter(h=>String(h?.cloneOf||"").trim()===l).map(h=>String(h?.id)));fn(!0);try{const h=r.label||r.id,x=await fetch("/api/vehicles",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({ort:r.ort||"",label:h,mannschaft:0,cloneOf:r.id})}),b=await x.json().catch(()=>({}));if(!x.ok||b?.error)throw new Error(b?.error||"Clone fehlgeschlagen");const w=await(await fetch("/api/vehicles",{credentials:"include"})).json();E(w);let M=b?.vehicle?.id;M||(M=w.find(H=>{if(!H)return!1;const xe=String(H.id||"");return!xe||d.has(xe)||String(H.ort||"")!==String(r.ort||"")?!1:String(H.cloneOf||"").trim()===l})?.id),i&&M&&(await Wt(i,M),$e(i));const B=await Ce();N(B),ye(B)}catch(h){alert(h.message||"Clone fehlgeschlagen")}finally{fn(!1)}}const Ve=a.useMemo(()=>new Map(P.map(t=>[t.id,t])),[P]);async function ms(t,i){if(!p||!t)return;const r=String(t.id??"").trim();if(!r)return;const l=i===!0,d=t.available!==!1;if(d===l)return;let h=null;if(!l){const L=typeof t.label=="string"&&t.label.trim()?`Einheit ${t.label.trim()}`:"die Einheit",w=k(L);if(w.cancelled)return;h=w.untilIso}const x=g.current.get(r)||null,b=m.current.get(r);b&&(clearTimeout(b.timeout),m.current.delete(r)),l?g.current.delete(r):h?g.current.set(r,h):g.current.delete(r),E(L=>L.map(w=>String(w?.id??"")===r?{...w,available:l,unavailableUntil:h||null}:w));try{const L=await En(r,l,h);if(l){g.current.delete(r),E(B=>B.map(K=>String(K?.id??"")===r?{...K,unavailableUntil:null}:K));return}const w=L&&typeof L.until=="string"?L.until:null,M=w?Date.parse(w):NaN;if(Number.isFinite(M)&&M>Date.now()){const B=new Date(M).toISOString();g.current.set(r,B),E(K=>K.map(H=>String(H?.id??"")===r?{...H,unavailableUntil:B}:H)),z(r,B)}else g.current.delete(r),E(B=>B.map(K=>String(K?.id??"")===r?{...K,unavailableUntil:null}:K))}catch(L){console.error(L),x?(g.current.set(r,x),z(r,x)):g.current.delete(r),E(w=>w.map(M=>String(M?.id??"")===r?{...M,available:d,unavailableUntil:x||null}:M)),alert(L?.message||"VerfÃ¼gbarkeit der Einheit konnte nicht gespeichert werden.")}}async function hs(t,i){if(!p)return;const r=String(t??"").trim();if(!r)return;const l=i===!0,d=R.get(r)??!0,h=new Map;for(const w of P)if(String(w?.ort??"")===r){const M=String(w?.id??"");M&&h.set(M,{available:w?.available!==!1,unavailableUntil:typeof w?.unavailableUntil=="string"&&w.unavailableUntil.trim()?w.unavailableUntil:null})}if(d===l)return;let x=null;if(!l){const w=k(`Gruppe ${r}`);if(w.cancelled)return;x=w.untilIso}const b=T.current.get(r)||null,L=$.current.get(r);if(L&&(clearTimeout(L.timeout),$.current.delete(r)),l){T.current.delete(r);for(const[w,M]of h.entries()){const B=M?.unavailableUntil||null;B?g.current.set(w,B):g.current.delete(w)}}else{x?T.current.set(r,x):T.current.delete(r);for(const w of h.keys())x?g.current.set(w,x):g.current.delete(w)}_(w=>{const M=new Map(w);return M.set(r,l),M}),E(w=>w.map(M=>{if(String(M?.ort??"")!==r)return M;const B=String(M?.id??"");if(!B)return M;if(l){const K=h.get(B),H=K?.available??!0,xe=K?.unavailableUntil||null;return{...M,groupAvailable:!0,available:H,unavailableUntil:xe}}return{...M,groupAvailable:!1,available:!1,unavailableUntil:x||null}}));try{const w=await Mn(r,l,x);if(l){T.current.delete(r);return}const M=w&&typeof w.until=="string"?w.until:null,B=M?Date.parse(M):NaN;if(Number.isFinite(B)&&B>Date.now()){const K=new Date(B).toISOString();T.current.set(r,K);for(const H of h.keys())g.current.set(H,K);E(H=>H.map(xe=>String(xe?.ort??"")===r?{...xe,unavailableUntil:K,groupAvailable:!1,available:!1}:xe)),U(r,K)}else T.current.delete(r),E(K=>K.map(H=>String(H?.ort??"")===r?{...H,unavailableUntil:null,groupAvailable:!1,available:!1}:H))}catch(w){console.error(w),b?(T.current.set(r,b),U(r,b)):T.current.delete(r),_(M=>{const B=new Map(M);return B.set(r,d),B}),E(M=>M.map(B=>{if(String(B?.ort??"")!==r)return B;const K=String(B?.id??"");if(!K)return B;const H=h.get(K),xe=H?.available??!0,Ae=H?.unavailableUntil||null;return Ae?g.current.set(K,Ae):g.current.delete(K),{...B,groupAvailable:d,available:d?xe:!1,unavailableUntil:d?Ae:null}})),alert(w?.message||"VerfÃ¼gbarkeit der Gruppe konnte nicht gespeichert werden.")}}const _t=a.useMemo(()=>{const t=new Set,i=r=>r===!0||typeof r=="string"&&r.trim().toLowerCase()==="clone";for(const r of P){if(!r||typeof r.id>"u")continue;const l=String(r.id);if(!l)continue;if(typeof r.cloneOf=="string"?r.cloneOf.trim():""){t.add(l);continue}(r.isClone===!0||i(r.clone))&&t.add(l)}return t},[P]),mn=t=>_t.has(String(t)),[hn,gn]=a.useState(new Map),gs=a.useMemo(()=>{const t={};for(const[i,r]of Ve.entries())t[i]=r;return t},[Ve]),pt=a.useMemo(()=>{const t=new Set,i=Pe?.columns||{};for(const r of Object.keys(i))for(const l of i[r].items||[])for(const d of l.assignedVehicles||[])t.add(d);return t},[Pe]),ps=a.useMemo(()=>{const t=new Set;for(const i of pt){const r=Ve.get(i),l=typeof r?.ort=="string"?r.ort:"";l&&t.add(l)}return t},[pt,Ve]),Xe=a.useMemo(()=>P.filter(t=>t&&typeof t.id<"u"&&!pt.has(t.id)&&!_t.has(String(t.id))),[P,pt,_t]),De=a.useMemo(()=>{const t={};for(const i of Xe){const r=i.ort||"Unbekannt";(t[r]??=[]).push(i)}for(const i of Object.keys(t))t[i].sort((r,l)=>(r.label||r.id).localeCompare(l.label||l.id));return Object.entries(t).sort((i,r)=>i[0].localeCompare(r[0]))},[Xe]),pn=a.useMemo(()=>{if(!Je)return De;const t=[];for(const[i,r]of De){const l=r.filter(d=>ls(d,at));l.length>0&&t.push([i,l])}return t},[De,Je,at]);a.useEffect(()=>{if(localStorage.getItem("ff_collapsed_groups")||!De.length)return;const i=De.map(([r])=>r);xt(new Set(i)),localStorage.setItem("ff_collapsed_groups",JSON.stringify(i))},[Ke,De]),a.useEffect(()=>{let t=setInterval(async()=>{try{const i=await fetch("/api/activity/status",{cache:"no-store",credentials:"include"}).then(r=>r.json());typeof i?.auto?.enabled=="boolean"&&i.auto.enabled!==Y&&le(!!i.auto.enabled),typeof i?.auto?.demoMode=="boolean"&&i.auto.demoMode!==Se&&je(!!i.auto.demoMode)}catch{}},3e3);return()=>clearInterval(t)},[Ke,Y,Se]);function bn(t,i,r,l){if(!t||!t.columns||r===l)return t;const d=(t.columns[r]?.items||[]).find(h=>h?.id===i);return d?{...t,columns:{...t.columns,[r]:{...t.columns[r],items:t.columns[r].items.filter(h=>h?.id!==i)},[l]:{...t.columns[l],items:[d,...t.columns[l]?.items||[]]}}}:t}function bs(t,i,r,l){if(!t||!t.columns||r===l)return t;const d=t.columns[i]?.items||[];if(r<0||r>=d.length)return t;const h=br(d,r,l);return{...t,columns:{...t.columns,[i]:{...t.columns[i],items:h}}}}function Bt(t,i){for(const r of["neu","in-bearbeitung","erledigt"])if((t.columns[r].items||[]).some(l=>l?.id===i))return r;return null}function bt(t,i){for(const r of["neu","in-bearbeitung","erledigt"]){const l=(t.columns[r].items||[]).find(d=>d?.id===i);if(l)return l}return null}function Ot(t,i){const r=t?.columns?.[i]?.items||[];let l=0,d=0,h=0,x=0;for(const b of r)if(b?.isArea?l+=1:d+=1,i==="erledigt"){const L=Array.isArray(b?.everVehicles)?b.everVehicles:[];h+=L.filter(w=>!mn(w)).length,x+=Number.isFinite(b?.everPersonnel)?b.everPersonnel:0}else{const L=Array.isArray(b?.assignedVehicles)?b.assignedVehicles:[];if(h+=L.filter(w=>!mn(w)).length,Number.isFinite(b?.manualPersonnel))x+=b.manualPersonnel;else for(const w of L){const M=Ve.get(w);typeof M?.mannschaft=="number"&&(x+=M.mannschaft)}}return{cards:r.length,areas:l,incidents:d,units:h,persons:x}}const xs=Ot(it,"neu"),ys=Ot(it,"in-bearbeitung"),ws=Ot(it,"erledigt"),Vt=t=>String(t||"").split(/[;,\n]/).map(i=>i.trim()).filter(Boolean),ze=t=>String(t||"").normalize?.("NFD").replace?.(new RegExp("\\p{Diacritic}","gu"),"").replace(/^\s*FF\s+/i,"").replace(/[._\-\/]+/g," ").replace(/\s+/g," ").toLowerCase().trim();function vs(t,i,r,l){const d=Vt(t?.alerted).map(ze);if(d.length)for(const h of i){const x=d.some(L=>ze(h?.ort)===L),b=d.some(L=>ze(h?.label)===L);if(x||b){const L=String(h.id);r.add(L),l.has(L)||l.set(L,null)}}}async function Ss(t,i){if(!(i!=="neu"||!t?.id))try{const r=await ur(t.id);r?.ok||alert(r?.error||"FÃ¼r diesen Einsatz sind keine Koordinaten hinterlegt.");const l=new Set((r?.units||[]).map(B=>String(B.unitId)));if(t?.alerted){const B=Vt(t.alerted).map(ze);for(const K of Xe){const H=B.some(Ae=>ze(K.ort)===ze(Ae)),xe=B.some(Ae=>ze(K.label)===ze(Ae));(H||xe)&&l.add(String(K.id))}}Xt(l),Mt(Date.now()+3e3);const d=new Map;for(const B of r?.units||[]){const K=Number(B?.distanceKm);d.set(String(B.unitId),Number.isFinite(K)?K:null)}l.size===0&&t?.alerted&&vs(t,Xe,l,d),gn(d);const h=new Set((r?.units||[]).filter(B=>!B.assigned).map(B=>String(B.unitId))),x=new Set(Xe.map(B=>String(B.id))),b=new Set([...h,...[...l].filter(B=>x.has(B))]),L=Vt(t?.alerted).map(ze),w=new Set;if(L.length&&Xe.length>0)for(const[B,K]of De){if(K.length===0)continue;L.some(xe=>ze(B)===ze(xe))&&w.add(B)}const M=[];for(const[B,K]of De)(K.some(xe=>b.has(String(xe.id)))||w.has(B))&&M.push(B);Cs(M),clearTimeout(rt.current),rt.current=setTimeout(()=>{Xt(new Set),Mt(0),gn(new Map)},3200)}catch(r){console.error("fetchNearby failed:",r)}}const[xn,xt]=a.useState(()=>{try{const t=localStorage.getItem("ff_collapsed_groups");return new Set(t?JSON.parse(t):[])}catch{return new Set}}),Ns=t=>xn.has(t),js=(t,i)=>{xt(r=>{const l=new Set(r);return i?l.add(t):l.delete(t),localStorage.setItem("ff_collapsed_groups",JSON.stringify([...l])),l})},Cs=(t=[])=>{xt(()=>{const i=De.map(([l])=>l),r=new Set(i);for(const l of t)r.delete(l);return localStorage.setItem("ff_collapsed_groups",JSON.stringify([...r])),r})},ks=(t=!0)=>{xt(()=>{const i=De.map(([l])=>l),r=t?new Set(i):new Set;return localStorage.setItem("ff_collapsed_groups",JSON.stringify([...r])),r})},As=()=>{const t=De.map(([r])=>r),i=t.length>0&&t.every(r=>xn.has(r));ks(!i)},[yt,Ut]=a.useState(null),[Is,et]=a.useState(null),lt=a.useRef(null),Es=sr(jn(pr,{activationConstraint:{distance:6}}),jn(gr,{activationConstraint:{delay:120,tolerance:6}})),Ms=t=>{const i=t?.over;if(!i){et(null);return}const r=String(i.id||"");if(lt.current=r,r.startsWith("col:"))et(r.slice(4));else if(r.startsWith("card:")){const l=Bt(Pe,r.slice(5));et(l)}else et(null)},Ht=()=>window.confirm("Sind sie sicher?"),Ps=async t=>{if(f){et(null),Ut(null),lt.current=null;return}et(null);const{active:i,over:r}=t;Ut(null);const l=r||(lt.current?{id:lt.current}:null);if(lt.current=null,!i||!l)return;const d=String(i.id||""),h=String(l.id||"");if(d.startsWith("ass:")&&h.startsWith("card:")){const[,x,b]=d.split(":"),L=h.slice(5);if(x&&b&&L&&x!==L){Ze.current=Date.now();try{await An(x,b);try{await In(b)}catch{}await Wt(L,b),$e(x,L);const[w,M]=await Promise.all([Ce(),Be()]);N(w),E(M),ye(w)}catch{alert("Einheit konnte nicht umgehÃ¤ngt werden.")}}return}if(d.startsWith("veh:")&&h.startsWith("card:")){Ze.current=Date.now();try{await Wt(h.slice(5),d.slice(4)),$e(h.slice(5));const[x,b]=await Promise.all([Ce(),Be()]);N(x),E(b),ye(x)}catch{alert("Einheit konnte nicht zugewiesen werden.")}return}if(d.startsWith("card:")){const x=d.slice(5),b=Bt(Pe,x);if(!b)return;if(h.startsWith("col:")){const L=h.slice(4);if(b!==L){if(L==="erledigt"&&b!=="erledigt"&&!Ht())return;N(w=>bn(w,x,b,L)),Ze.current=Date.now();try{if(await ct({cardId:x,from:b,to:L,toIndex:0}),$e(x),L==="erledigt"){const[w,M]=await Promise.all([Ce(),Be()]);N(w),E(M),ye(w)}else{const w=await Ce();N(w),ye(w)}}catch{try{const w=await Ce();N(w),ye(w)}catch{}alert("Statuswechsel konnte nicht gespeichert werden.")}}return}if(h.startsWith("card:")){const L=h.slice(5),w=Bt(Pe,L);if(!w)return;if(b===w){const M=Pe.columns[b]?.items||[],B=M.findIndex(H=>H?.id===x),K=M.findIndex(H=>H?.id===L);if(B<0||K<0||B===K)return;N(H=>bs(H,b,B,K)),Ze.current=Date.now();try{await ct({cardId:x,from:b,to:b,toIndex:K}),$e(x);const H=await Ce();N(H),ye(H)}catch{try{const H=await Ce();N(H),ye(H)}catch{}}}else{if(w==="erledigt"&&b!=="erledigt"&&!Ht())return;N(M=>bn(M,x,b,w)),Ze.current=Date.now();try{if(await ct({cardId:x,from:b,to:w,toIndex:0}),$e(x),w==="erledigt"){const[M,B]=await Promise.all([Ce(),Be()]);N(M),E(B),ye(M)}else{const M=await Ce();N(M),ye(M)}}catch{try{const M=await Ce();N(M),ye(M)}catch{}alert("Statuswechsel konnte nicht gespeichert werden.")}}}}},Ts=async()=>{if(confirm("Board wirklich zurÃ¼cksetzen?")){Q(!0);try{await fr();const t=await Ce();N(t),ye(t)}catch{alert("Reset fehlgeschlagen.")}finally{Q(!1)}}},Ls=()=>window.open(mr(),"_blank","noopener,noreferrer"),$s=async({title:t,ort:i,typ:r,isArea:l=!1,areaCardId:d=null,areaColor:h,coordinates:x=null,location:b="",description:L=""})=>{const w=l?null:d?String(d):null,M={isArea:!!l,areaCardId:w};l&&(M.areaColor=h||aa),x&&Number.isFinite(x?.lat)&&Number.isFinite(x?.lng)&&(M.lat=Number(x.lat),M.lng=Number(x.lng));const B=typeof b=="string"?b.trim():"";B&&(M.location=B);const K=typeof L=="string"?L.trim():"";K&&(M.description=K);const H=await hr(t,"neu",0,i,r,M);en.current=Date.now(),H?.card?.id!=null&&$e(H.card.id),N(xe=>{if(!xe)return xe;const Ae=structuredClone(xe);return Ae.columns.neu.items.unshift(H.card),ye(Ae),Ae})},Rs=a.useCallback(async(t,i)=>{if(!t?.id)return;const r=i?String(i):null;try{const l=await jt(t.id,{areaCardId:r});Lt(l?.card,l?.board)}catch(l){alert(l?.message||"Abschnitt konnte nicht geÃ¤ndert werden.")}},[jt,Lt]),Ds=async(t,i)=>{try{const r=await jt(t,i);return Lt(r?.card,r?.board),r}catch(r){throw r}};if(ft.startsWith("/protokoll/edit/")){const t=ft.split("/")[3],i=Number(t);return e.jsxs("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden flex flex-col min-h-0 floating-actions-safe-area",children:[e.jsx(wt,{helpHref:"/Hilfe_Meldestelle.pdf",helpTitle:"Hilfe â€“ Meldestelle/Protokoll",onAdd:()=>{window.location.hash="/protokoll/neu"},addTitle:"Neuen Eintrag anlegen",navButtons:Nt("meldestelle")}),e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Meldung â€“ Bearbeiten"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"Zur Ãœbersicht"})]}),e.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto p-3",children:e.jsx(Cn,{mode:"edit",editNr:i})})]})}return ft.startsWith("/protokoll/neu")?e.jsxs("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden flex flex-col min-h-0 floating-actions-safe-area",children:[e.jsx(wt,{helpHref:"/Hilfe_Meldestelle.pdf",helpTitle:"Hilfe â€“ Meldestelle/Protokoll",onAdd:()=>{window.location.hash="/protokoll/neu"},addTitle:"Neuen Eintrag anlegen",navButtons:Nt("meldestelle")}),e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Meldung â€“ Eintrag anlegen"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"Zur Ãœbersicht"})]}),e.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto p-3",children:e.jsx(Cn,{mode:"create"})})]}):ft.startsWith("/protokoll")?e.jsxs("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden flex flex-col min-h-0 floating-actions-safe-area",children:[e.jsx(wt,{helpHref:"/Hilfe_Meldestelle.pdf",helpTitle:"Hilfe â€“ Meldestelle/Protokoll",onAdd:()=>{window.location.hash="/protokoll/neu"},addTitle:"Neuen Eintrag anlegen",navButtons:Nt("meldestelle")}),e.jsxs("header",{className:"flex flex-wrap items-center justify-between gap-3 p-3 border-b bg-white shadow",children:[e.jsxs("h1",{className:"text-xl font-bold flex items-center gap-2",children:[o&&e.jsx(kn,{className:"h-5 w-5"}),e.jsx("span",{children:"MeldungsÃ¼bersicht"})]}),e.jsxs("div",{className:"flex flex-1 flex-wrap items-center justify-end gap-2 min-w-0",children:[e.jsx("input",{id:"protocolSearch",type:"search",className:"w-full sm:w-64 md:w-72 lg:w-80 max-w-full px-3 py-2 text-sm rounded-xl border",placeholder:"Sucheâ€¦",value:ce,onChange:t=>se(t.target.value),"aria-label":"Suche Meldungen"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("a",{href:"/api/protocol/csv/file",className:"px-3 py-1.5 rounded-md border bg-white",title:"protocol.csv herunterladen",children:"CSV"}),e.jsx("button",{onClick:()=>{!J||re||(window.location.hash="/protokoll/neu")},disabled:!J||re,className:`px-3 py-1.5 rounded-md text-white ${!J||re?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-emerald-600 hover:bg-emerald-700"}`,title:J?re?"S3 darf nur anlegen, wenn LtStb nicht angemeldet ist":void 0:"Keine Berechtigung (Meldestelle)",children:"+ Eintrag anlegen"})]})]})]}),e.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto p-3 meldung-overview-wrapper",children:e.jsx(Vr,{searchTerm:ce})})]}):e.jsxs("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden flex flex-col min-h-0 floating-actions-safe-area",children:[e.jsx(wt,{helpHref:"/Hilfe.pdf",onAdd:u?()=>Re(!0):void 0,addTitle:"Einsatz anlegen",navButtons:Nt("einsatz")}),!v&&e.jsx("div",{className:"fixed inset-0 z-10 bg-black/10 backdrop-blur-sm flex items-center justify-center",children:e.jsx("div",{className:"px-4 py-2 rounded-lg bg-white shadow",children:"Ladeâ€¦"})}),e.jsxs("header",{className:"einsatz-header",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[e.jsxs("h1",{className:"text-xl font-extrabold tracking-tight text-slate-900 flex items-center gap-2",children:[o&&e.jsx(kn,{className:"h-5 w-5"}),e.jsx("span",{children:"Einsatzstellen-Uebersicht"})]}),e.jsx("div",{title:`Quelle: ${Te.file||"list_filtered.json"}`,className:"sync-chip",children:e.jsxs("span",{children:["Zuletzt geladen: ",e.jsx("b",{children:Te.lastLoadedIso?new Date(Te.lastLoadedIso).toLocaleTimeString("de-AT",{hour12:!1}):"â€“"})]})})]}),Pt&&e.jsx("div",{className:"flex-1 min-w-[200px] max-w-full sm:min-w-[260px] flex items-center self-center",style:{height:"var(--ctl-h)"},children:e.jsx("div",{className:"ticker-container w-full h-full flex items-center","aria-live":"polite",children:e.jsx("marquee",{className:"ticker-content",behavior:"scroll",direction:"left",scrollAmount:6,onMouseEnter:t=>{typeof t.target.stop=="function"&&t.target.stop()},onMouseLeave:t=>{typeof t.target.start=="function"&&t.target.start()},children:e.jsx("span",{children:Pt})},Pt)})}),e.jsxs("div",{className:"toolbar flex flex-wrap items-center gap-2.5 justify-end w-full md:w-auto",children:[e.jsxs("div",{className:`filter-group ${V?"filter-group-active":""}`,children:[e.jsx("span",{className:"filter-group-label",children:"Abschnitt"}),e.jsxs("select",{id:"areaFilter",value:V,onChange:t=>q(t.target.value),children:[e.jsx("option",{value:"",children:"Alle anzeigen"}),He.map(t=>e.jsx("option",{value:String(t.id),children:t.label},t.id))]})]}),e.jsx("input",{id:"boardSearch",type:"search",className:"search-input w-full sm:w-48 md:w-56 lg:w-64 max-w-full",placeholder:"Suche...",value:X,onChange:t=>de(t.target.value),"aria-label":"Suche Einsaetze"}),e.jsx("button",{onClick:Ls,className:"header-btn",children:"PDF"}),e.jsx("button",{onClick:()=>window.open("/api/log.csv","_blank"),className:"header-btn",title:"log.csv herunterladen",children:"Log (CSV)"}),e.jsx("button",{onClick:ds,disabled:f||Ft,className:"header-btn",title:"Import sofort ausfuehren",children:Ft?"Import...":"Import"}),e.jsx(Wr,{autoEnabled:Y,remaining:ss,disabled:f,showTimer:!1,showLastLoaded:!1,onImportInfo:Ee}),Se&&e.jsx("button",{onClick:Ts,disabled:f||ve,className:"header-btn",style:ve?{opacity:.5}:{},children:ve?"Reset...":"Reset"})]})]}),e.jsxs(rr,{sensors:Es,collisionDetection:t=>t?.active?.data?.current?.type==="vehicle"?ar(t):ir(t),onDragStart:t=>Ut({type:t?.active?.data?.current?.type,id:t.active.id,data:t?.active?.data?.current}),onDragOver:Ms,onDragEnd:Ps,children:[e.jsxs("main",{className:"einsatz-main grid grid-cols-1 md:[grid-template-columns:minmax(180px,220px)_repeat(3,minmax(0,1fr))] gap-2 min-h-0 flex-1 overflow-hidden pr-[var(--fab-safe-margin)]",children:[e.jsx("div",{className:"flex flex-col gap-2 h-full min-h-0",children:e.jsxs("section",{className:"bg-white rounded-xl shadow p-3 flex-1 flex flex-col min-h-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-semibold",children:e.jsx("button",{type:"button",onClick:As,title:"Alle Gruppen auf/zu klappen",className:"underline decoration-dotted hover:opacity-80 focus:outline-none",children:"Einheiten (frei)"})}),p&&e.jsx("button",{onClick:()=>fe(!0),className:"px-2 py-1 text-sm rounded bg-emerald-600 text-white",children:"+ Einheit"})]}),e.jsxs("div",{className:"overflow-auto pr-1 flex-1 min-h-0 space-y-3",children:[pn.length===0&&e.jsx("div",{className:"text-[0.85rem] text-gray-500 italic",children:Je?"Keine Einheiten gefunden.":"â€” alle Einheiten sind zugewiesen â€”"}),pn.map(([t,i])=>{const r=Ns(t),l=R.has(t)?R.get(t):!0,d=S.get(t)===!0,h=ps.has(t),x=ca({available:l,alerted:d,assigned:h});return e.jsxs("div",{className:`border rounded-md ${x.container}`,children:[e.jsxs("div",{className:"flex items-center justify-between px-2 py-2 gap-2",children:[e.jsx("button",{type:"button",onClick:()=>js(t,!r),className:"flex-1 flex items-center justify-between gap-2 text-left",title:r?"aufklappen":"zuklappen",children:e.jsx("span",{className:`text-xs font-semibold ${x.label}`,children:t})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("label",{className:"flex items-center gap-1 text-[11px] text-gray-600",title:l?"Gruppe verfÃ¼gbar":"Gruppe deaktiviert",children:[e.jsx("span",{className:"sr-only",children:"Gruppe verfÃ¼gbar"}),e.jsx("input",{type:"checkbox",checked:l,onChange:b=>hs(t,b.target.checked),disabled:!p})]}),e.jsx("span",{className:"group-chip",children:i.length})]})]}),!r&&e.jsx("div",{className:"px-2 pb-2 grid grid-cols-1 gap-1.5",children:i.map(b=>{const L=b?.available!==!1,w=R.has(b?.ort||"")?R.get(b?.ort||""):b?.groupAvailable!==!1,M=L&&w,B=w===(b?.groupAvailable!==!1)&&M===L?b:{...b,available:M,groupAvailable:w};return e.jsxs("div",{className:"flex items-center gap-2 justify-between",children:[e.jsx(yr,{editable:u&&M,vehicle:B,pillWidthPx:160,near:Yt.has(String(b.id))&&Date.now()<Et,distKm:hn.get(String(b.id))}),e.jsxs("label",{className:"flex items-center gap-1 text-[11px] text-gray-600 shrink-0",title:M?"Einheit verfÃ¼gbar":"Einheit deaktiviert",children:[e.jsx("span",{className:"sr-only",children:"Einheit verfÃ¼gbar"}),e.jsx("input",{type:"checkbox",checked:M,onChange:K=>ms(b,K.target.checked),disabled:!p||!w})]})]},b.id)})})]},t)})]})]})}),[{id:"neu",title:"Neu",bg:"bg-red-100",totals:xs},{id:"in-bearbeitung",title:"In Bearbeitung",bg:"bg-yellow-100",totals:ys},{id:"erledigt",title:"Erledigt",bg:"bg-green-100",totals:ws}].map(({id:t,title:i,bg:r,totals:l})=>{const d=on?`${i}: ${on}`:i;return e.jsx("div",{className:Is===t?"drag-over":"",children:e.jsx(Mr,{editable:u,colId:t,bg:r,title:e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"font-semibold break-words min-w-0",children:d}),e.jsxs("span",{className:"flex flex-wrap items-center gap-1.5 justify-end w-full sm:w-auto",children:[e.jsxs("span",{className:"kpi-badge","data-variant":"incidents",children:["â¬› ",l.incidents]}),e.jsxs("span",{className:"kpi-badge","data-variant":"areas",children:["ðŸ—ºï¸ ",l.areas]}),e.jsxs("span",{className:"kpi-badge","data-variant":"units",children:["ðŸš’ ",l.units]}),e.jsxs("span",{className:"kpi-badge","data-variant":"persons",children:["ðŸ‘¥ ",l.persons]})]})]}),children:e.jsx("ul",{className:"flex-1 overflow-y-auto overflow-x-hidden px-2 py-2.5 space-y-2.5",children:e.jsx(or,{items:(it.columns[t].items||[]).map(h=>ra(h.id)),strategy:lr,children:(it.columns[t].items||[]).map(h=>e.jsx(xr,{editable:u,card:h,colId:t,vehiclesById:Ve,areaOptions:He,areaLabelById:Ye,areaColorById:Tt,onAreaChange:u?Rs:void 0,onEditCard:u?x=>{te(x),pe(!0),Ge(!0)}:void 0,distById:hn,pillWidthPx:160,pulse:ot.has(String(h.id))&&Date.now()<Et,onUnassign:async(x,b)=>{await An(x,b);try{await In(b)}catch{}const[L,w]=await Promise.all([Ce(),Be()]);$e(x),N(L),E(w),ye(L)},onOpenMap:x=>ae({address:h.ort,card:h,board:Pe,vehiclesById:gs}),onAdvance:u?async x=>{if(t==="neu"){await ct({cardId:x.id,from:"neu",to:"in-bearbeitung",toIndex:0}),$e(x.id);const b=await Ce();N(b),ye(b)}else if(t==="in-bearbeitung"){if(!Ht())return;await ct({cardId:x.id,from:"in-bearbeitung",to:"erledigt",toIndex:0});const[b,L]=await Promise.all([Ce(),Be()]);$e(x.id),N(b),E(L),ye(b)}}:void 0,onEditPersonnelStart:u?(x,b)=>{we({cardId:x.id}),oe(b)}:void 0,editing:ue,editingValue:be,setEditingValue:oe,onEditPersonnelSave:u?async x=>{try{await cr(x.id,be===""?null:Number(be)),$e(x.id);const b=await Ce();N(b),ye(b)}finally{we(null),oe("")}}:void 0,onEditPersonnelCancel:u?()=>{we(null),oe("")}:void 0,onClone:fs,onVehiclesIconClick:Ss,nearIds:Yt,nearUntilMs:Et,onShowInfo:We},h.id))})})})},t)})]}),e.jsxs(dr,{dropAnimation:{duration:180,easing:"ease-out"},children:[yt?.type==="vehicle"&&(()=>{const t=Ve.get(yt?.data?.vehicleId);return t?e.jsx("div",{className:"pointer-events-none",children:e.jsxs("div",{style:{width:160},className:"max-w-full select-none border-2 border-red-300 rounded-2xl bg-white px-2 py-1 shadow-lg",children:[e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:t.label||t.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate",children:[t.ort||"â€”"," Â· ðŸ‘¥ ",t.mannschaft??0]})]})}):null})(),yt?.type==="card"&&(()=>{const t=String(yt?.id||"").replace(/^card:/,""),i=bt(Pe,t);return i?e.jsx("div",{className:"pointer-events-none w-[280px]",children:e.jsxs("div",{className:"rounded-lg bg-white shadow-xl border p-3",children:[e.jsx("div",{className:"font-semibold text-sm mb-1 truncate",children:i.content}),e.jsxs("div",{className:"text-xs text-gray-600",children:[i.assignedVehicles?.length||0," Einheiten â€¢"," ","ðŸ‘¥ ",Number.isFinite(i?.manualPersonnel)?i.manualPersonnel:(i.assignedVehicles||[]).reduce((r,l)=>r+(Ve.get(l)?.mannschaft??0),0)]})]})}):null})()]})]}),ke&&e.jsx(jr,{onClose:()=>fe(!1),onCreate:async t=>{const i=await fetch("/api/vehicles",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(t)});if(!i.ok){const r=await i.text().catch(()=>String(i.status));throw new Error(`HTTP ${i.status} ${r}`)}E(await Be())}}),Le&&e.jsx(Ir,{onClose:()=>Re(!1),onCreate:$s,types:D,areaOptions:He}),Z&&e.jsx(Nr,{context:Z,onClose:()=>ae(null)}),e.jsx($r,{open:Me,info:y||{},onClose:()=>{Ge(!1),te(null),pe(!1)},canEdit:u,onSave:Ds,areaOptions:He,areaLabelById:Ye,forceEdit:Ie,types:D})]})}export{ma as default};
