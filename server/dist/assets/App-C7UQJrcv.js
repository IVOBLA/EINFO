import{u as kt,j as e,r as s,a as un,C as mn,s as lt,b as hn,i as qe,c as Qe,f as ce,d as Ze,e as gn,g as pn,h as fn,k as xn,l as bn,m as ct,D as yn,n as wn,o as vn,S as jn,v as Nn,p as Sn,t as Le,q as dt,w as ut,x as kn,y as Cn,z as He,A as mt,B as In,E as En,F as An,G as ht,T as Mn,P as Pn}from"./index-CbLU_qi0.js";function gt({cardId:n,vehicle:a,pillWidthPx:o=160,onUnassign:l,onClone:m,near:p=!1,distKm:h=null,readonly:g=!1}){const N=`ass:${n}:${a.id}`,w=g?null:kt({id:N,data:{type:"assigned",vehicleId:a.id,fromCardId:n}}),H=w?.attributes??{},C=w?.listeners??{},P=w?.setNodeRef??(()=>{}),_=w?.transform??null,y=w?.isDragging??!1,$={width:o,transform:_?`translate3d(${_.x}px, ${_.y}px, 0)`:void 0};return e.jsxs("div",{ref:P,style:$,...H,...C,className:`relative self-start border-2 rounded-2xl bg-white px-2 pr-9 py-1 shadow-sm
                  select-none cursor-grab active:cursor-grabbing
                  ${p?"border-emerald-500 ring-2 ring-emerald-300":"border-red-300"}
                  ${y?"opacity-50":""}`,title:"Ziehen: auf andere Karte verschieben Â· Doppelklick: klonen",onDoubleClick:()=>{g||m?.(a.id,n)},children:[p&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-0.5 rounded-2xl border-2 border-emerald-400/50 animate-ping"}),e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:a.label||a.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate flex justify-between items-center",children:[e.jsxs("span",{children:[a.ort||"â€”"," Â· ðŸ‘¥ ",a.mannschaft??0]}),p&&Number.isFinite(Number(h))&&e.jsxs("span",{className:"absolute top-1 right-8 text-[11px] tabular-nums text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded whitespace-nowrap",children:[Number(h)," Km"]})]}),!g&&e.jsx("button",{type:"button",onMouseDown:T=>T.stopPropagation(),onTouchStart:T=>T.stopPropagation(),onClick:T=>{T.stopPropagation(),l?.(n,a.id)},title:"Einheit entfernen",className:"absolute right-2 top-1/2 -translate-y-1/2 h-6 w-6 rounded-full bg-red-600 text-white shadow flex items-center justify-center","aria-label":"Einheit entfernen",children:e.jsx("svg",{viewBox:"0 0 12 12",width:"12",height:"12","aria-hidden":"true",children:e.jsx("path",{d:"M1 1 L11 11 M11 1 L1 11",stroke:"white",strokeWidth:"2",strokeLinecap:"round"})})})]})}function Tn(n){const{card:a,colId:o,vehiclesById:l,pillWidthPx:m=160,onUnassign:p,onOpenMap:h,onAdvance:g,onEditPersonnelStart:N,editing:w,editingValue:H,setEditingValue:C,onEditPersonnelSave:P,onEditPersonnelCancel:_,onClone:y,onVehiclesIconClick:$,onShowInfo:T,nearIds:O,nearUntilMs:Y,distById:v,pulse:A,editable:B=!0}=n,[k,J]=s.useState(o==="in-bearbeitung"),te=s.useRef((a.assignedVehicles||[]).length),X=s.useRef(null),le=Date.now()<(Y||0),se=B?un({id:`card:${a.id}`,data:{type:"card",cardId:a.id}}):{attributes:{},listeners:{},setNodeRef:b=>{},transform:null,transition:null,isDragging:!1},{attributes:ge,listeners:I,setNodeRef:de,transform:K,transition:pe,isDragging:x}=se,U={transform:mn.Transform.toString(K),transition:pe,opacity:x?.8:1},ae=o==="erledigt"?a.everVehicles?.length||0:a.assignedVehicles?.length||0,Z=s.useMemo(()=>(a.assignedVehicles||[]).map(b=>l.get(b)).filter(Boolean),[a,l]),W=s.useMemo(()=>o==="erledigt"?Number.isFinite(a?.everPersonnel)?a.everPersonnel:0:Number.isFinite(a?.manualPersonnel)?a.manualPersonnel:Z.reduce((b,D)=>b+(D?.mannschaft??0),0),[o,a,Z]);s.useEffect(()=>{if(o!=="in-bearbeitung"||!le)return;(a.assignedVehicles||[]).some(D=>O?.has(String(D)))&&J(!0)},[o,le,O,a.assignedVehicles]),s.useEffect(()=>{if(o!=="in-bearbeitung")return;const b=(a.assignedVehicles||[]).length,D=te.current;b>D&&J(!0),te.current=b},[o,a.assignedVehicles]),s.useEffect(()=>{if(o==="in-bearbeitung"&&k&&X.current)try{X.current.scrollIntoView({behavior:"smooth",block:"nearest"})}catch{}},[o,k]);const ne=()=>{o==="neu"?typeof $=="function"&&$(a,o):(o==="in-bearbeitung"||o==="erledigt")&&J(b=>!b)},q=()=>{B&&typeof N=="function"&&N(a,W)};return e.jsxs("li",{ref:de,style:U,className:`relative rounded-lg bg-white shadow border transition mx-1
              ${A&&o==="neu"?"ring-2 ring-red-400/60":""}`,children:[A&&o==="neu"&&e.jsxs(e.Fragment,{children:[e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 rounded-lg bg-red-500/10 animate-pulse-inner"}),e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 rounded-lg animate-ping-safe"})]}),e.jsxs("div",{className:"p-3 select-none",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",...ge,...I,children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-semibold text-sm leading-5 truncate",children:a.content}),!!a.ort&&e.jsx("button",{type:"button",onClick:()=>h?.(a.ort),className:"text-[12px] text-blue-700 hover:underline truncate",title:"Ort in Karte Ã¶ffnen",children:a.ort})]}),e.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[e.jsxs("button",{type:"button",title:o==="neu"?"Nahe Einheiten prÃ¼fen":"Einheiten auf-/zuklappen",className:"px-2 py-1 rounded text-[12px] border hover:bg-red-50 flex items-center gap-1",onPointerDown:b=>b.stopPropagation(),onClick:b=>{b.stopPropagation(),b.preventDefault(),ne()},children:["ðŸš’ ",ae,(o==="in-bearbeitung"||o==="erledigt")&&e.jsx("span",{children:k?"â–¾":"â–¸"})]}),e.jsxs("button",{type:"button",className:"px-2 py-1 rounded text-[12px] border bg-white hover:bg-gray-50",title:"Personalzahl bearbeiten",onPointerDown:b=>b.stopPropagation(),onClick:b=>{b.stopPropagation(),q()},children:["ðŸ‘¥ ",W]}),B&&g&&e.jsx("button",{type:"button",onPointerDown:b=>b.stopPropagation(),onClick:b=>{b.stopPropagation(),g(a)},className:"ml-1 px-2 py-1 rounded text-[12px] border bg-white hover:bg-gray-50",title:"weiter",children:"âž”"})]})]}),o==="neu"&&!!Z.length&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-1.5",children:Z.map(b=>e.jsx(gt,{cardId:a.id,vehicle:b,pillWidthPx:m,onUnassign:p,onClone:y,near:!!O&&le&&O.has(String(b.id)),readonly:!B,distKm:v?.get(String(b.id))??null},`ass-${a.id}-${b.id}`))}),o==="in-bearbeitung"&&k&&!!Z.length&&e.jsx("div",{ref:X,className:"mt-2 flex flex-wrap gap-1.5",children:Z.map(b=>e.jsx(gt,{cardId:a.id,vehicle:b,pillWidthPx:m,onUnassign:p,onClone:y,near:!!O&&le&&O.has(String(b.id)),readonly:!B,distKm:v?.get(String(b.id))??null},`ass-${a.id}-${b.id}`))}),o==="erledigt"&&k&&!!a.everVehicles?.length&&e.jsx("ul",{className:"mt-2 text-sm text-gray-700 list-disc list-inside space-y-1",children:a.everVehicles.map(b=>{const D=l.get(b),S=D?.label||D?.id||"Unbekannt",L=D?.ort?` (${D.ort})`:"";return e.jsxs("li",{children:[S,L]},b)})}),B&&w?.cardId===a.id&&e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("input",{type:"number",className:"w-20 border rounded px-2 py-1 text-sm",value:H,onChange:b=>C(b.target.value),placeholder:"Personen"}),e.jsx("button",{className:"px-2 py-1 text-sm rounded bg-emerald-600 text-white",onClick:()=>P(a),children:"Speichern"}),e.jsx("button",{className:"px-2 py-1 text-sm rounded bg-gray-200",onClick:_,children:"Abbrechen"})]}),e.jsxs("div",{className:"mt-2 flex justify-end gap-2",children:[e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Ort in Karte Ã¶ffnen",onPointerDown:b=>b.stopPropagation(),onClick:b=>{b.stopPropagation(),h?.(a.ort)},children:"Karte"}),e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Einsatz-Info",onPointerDown:b=>b.stopPropagation(),onClick:b=>{b.stopPropagation(),T?.(a)},children:"?"})]})]})]})}function Dn({vehicle:n,pillWidthPx:a=160,near:o=!1,distKm:l=null,editable:m=!0}){const p=`veh:${n.id}`,h=m?kt({id:p,data:{type:"vehicle",vehicleId:n.id}}):null,g=h?.attributes??{},N=h?.listeners??{},w=h?.setNodeRef??(()=>{}),H=h?.transform??null,C=h?.isDragging??!1;return e.jsxs("div",{ref:w,style:{width:a,transform:H?`translate3d(${H.x}px, ${H.y}px, 0)`:void 0},...g,...N,className:`relative max-w-full select-none border-2 ${o?"border-emerald-500":"border-red-300"} rounded-2xl bg-white
                 px-2 py-1 shadow-sm cursor-grab active:cursor-grabbing
                 ${C?"opacity-50":""}`,children:[o&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-0.5 rounded-2xl border-2 border-emerald-400/50 animate-ping"}),e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:n.label||n.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate flex justify-between items-center",children:[e.jsxs("span",{children:[n.ort||"â€”"," Â· ðŸ‘¥ ",n.mannschaft??0]}),o&&Number.isFinite(Number(l))&&e.jsxs("span",{className:"absolute top-1 right-1 text-[11px] tabular-nums text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded whitespace-nowrap",children:[Number(l)," Km"]})]})]})}function $n(n,a){const l=(a.lat-n.lat)*Math.PI/180,m=(a.lng-n.lng)*Math.PI/180,p=Math.sin(l/2)**2+Math.cos(n.lat*Math.PI/180)*Math.cos(a.lat*Math.PI/180)*Math.sin(m/2)**2;return 2*6371*Math.asin(Math.sqrt(p))}function pt(n,a,o){const m=o*Math.PI/180,p=n.lat*Math.PI/180,h=n.lng*Math.PI/180,g=a/6371e3,N=Math.asin(Math.sin(p)*Math.cos(g)+Math.cos(p)*Math.sin(g)*Math.cos(m))*180/Math.PI,w=(h+Math.atan2(Math.sin(m)*Math.sin(g)*Math.cos(p),Math.cos(g)-Math.sin(p)*Math.sin(N*Math.PI/180)))*180/Math.PI;return{lat:N,lng:w}}async function ft(n){if(!n||!window.google?.maps?.Geocoder)return null;const a=new window.google.maps.Geocoder;return new Promise(o=>{a.geocode({address:n,region:"AT"},(l,m)=>{m==="OK"&&l?.[0]?.geometry?.location?o({lat:l[0].geometry.location.lat(),lng:l[0].geometry.location.lng(),formatted:l[0].formatted_address||n}):o(null)})})}const Ee=n=>String(n||"").trim().toLowerCase();async function xt(){try{const n=await fetch("/api/vehicles",{cache:"no-store"});return n.ok?n.json():[]}catch{return[]}}async function bt(){try{const n=await fetch("/api/gps",{cache:"no-store"});if(n.ok)return await n.json()}catch(n){console.error("GPS fetch failed:",n)}return[]}function yt(n){const a=n?.typ||n?.type||"â€”",o=n?.timestamp?new Date(n.timestamp).toLocaleString("de-AT",{hour12:!1}):"â€”",l=n?.alerted??"â€”",m=n?.description??"â€”",p=n?.additionalAddressInfo||n?.ort||"â€”",h=[];n?.location&&h.push(String(n.location));const g=Number.isFinite(n?.latitude),N=Number.isFinite(n?.longitude);g&&N&&h.push(`(${n.latitude}, ${n.longitude})`);const w=h.length?h.join(" "):"â€”";return`
    <div style="min-width:280px">
      <div style="font-weight:700;margin-bottom:4px">${n?.content||"Einsatz"}</div>
      <div><b>Typ:</b> ${a}</div>
      <div><b>Alarmzeit:</b> ${o}</div>
      <div><b>Alarmiert:</b> ${l}</div>
      <div><b>Beschreibung:</b> ${m}</div>
      <div><b>Adresse:</b> ${p}</div>
      <div><b>Location:</b> ${w}</div>
    </div>
  `}const be=44,wt="/vehicle-red.gif",Ln="/vehicle-gray.png",_n="/vehicle-drive.gif";function Rn({context:n,address:a,onClose:o}){const l=a||n?.card?.ort||n?.address||"",m=!!window.google?.maps,p=s.useRef(null),[h,g]=s.useState(!1),[N,w]=s.useState(""),H=s.useMemo(()=>{const C=n?.card;return C&&Number.isFinite(C?.latitude)&&Number.isFinite(C?.longitude)?{lat:Number(C.latitude),lng:Number(C.longitude)}:null},[n]);if(s.useEffect(()=>{if(!m||!n?.card||!p.current)return;let C=!1,P,_;const y=new Map;let $=null;return(async()=>{try{g(!0),w("");let O=H;if(!O){const x=await ft(n.card.ort);if(C)return;x&&(O={lat:x.lat,lng:x.lng})}if(!O){w("Konnte Einsatz-Position nicht bestimmen.");return}P=new window.google.maps.Map(p.current,{center:O,zoom:18,mapTypeId:"roadmap"}),_=new window.google.maps.InfoWindow;const Y=(x,U,ae,Z,{hover:W=!1}={})=>{const ne={path:"M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z",fillColor:U,fillOpacity:1,strokeColor:"#333",strokeWeight:1,scale:1.2},q=new window.google.maps.Marker({position:x,map:P,title:ae,icon:ne});if(Z){const b=()=>{_.setContent(Z),_.open(P,q)};W?(q.addListener("mouseover",b),q.addListener("mouseout",()=>_.close())):q.addListener("click",b)}return q};Y(O,"#d11a1a",n.card.content||"Einsatz",yt(n.card),{hover:!0});const v=[...n?.board?.columns?.neu?.items||[],...n?.board?.columns?.["in-bearbeitung"]?.items||[]],A=new Map;for(const x of v)if(Number.isFinite(x.latitude)&&Number.isFinite(x.longitude))A.set(x.id,{lat:Number(x.latitude),lng:Number(x.longitude)});else if(x.ort){const U=await ft(x.ort);U&&A.set(x.id,{lat:U.lat,lng:U.lng})}for(const x of v){if(x.id===n.card.id)continue;const U=A.get(x.id);U&&Y(U,"#1e63d1",x.content||"Einsatz",yt(x),{hover:!0})}const B=new Map;for(const x of v)for(const U of x.assignedVehicles||[])B.set(String(U),x.id);const k=await bt(),J=new Map(k.filter(x=>Number.isFinite(x?.lat)&&Number.isFinite(x?.lng)&&x?.realname).map(x=>[Ee(x.realname),x])),te=await xt(),X=new Map(te.filter(x=>x&&x.source!=="gps"&&Number.isFinite(x.latitude)&&Number.isFinite(x.longitude)).map(x=>[String(x.id),{lat:Number(x.latitude),lng:Number(x.longitude)}])),le=Object.values(n.vehiclesById||{}),se=10,ge=50,I=new Map,de=window.google?.maps?.marker?.AdvancedMarkerElement,K=(x,U,ae)=>{if(!x)return Ln;if(!U||!ae||!A.has(ae))return wt;const Z=A.get(ae);return $n(U,Z)>.1?_n:wt},pe=(x,U,ae,Z,W,ne)=>{const q=K(U,Z,W),b=!Z;if(de){const D=document.createElement("img");D.src=q,D.width=be,D.height=be,D.alt=ae||"",D.decoding="async";const S=new de({map:P,position:x,content:D,title:ae});if(b){try{S.draggable=!0}catch{}S.addListener("dragend",async L=>{const V=L?.latLng||S.position,r=typeof V.lat=="function"?V.lat():V.lat,u=typeof V.lng=="function"?V.lng():V.lng;try{await lt(ne,r,u,W,"manual")}catch(j){S.__setPosition(x),console.error("setVehiclePosition failed:",j),alert("Position konnte nicht gespeichert werden.")}})}return S.__setPosition=L=>{S.position=L},S.__setIcon=(L,V,r)=>{D.src=K(L,V,r)},S.__onOver=L=>{D.addEventListener("mouseover",L),D.addEventListener("mouseout",()=>_.close())},S}else{const D=new window.google.maps.Marker({position:x,map:P,title:ae,draggable:b,icon:{url:q,scaledSize:new window.google.maps.Size(be,be),anchor:new window.google.maps.Point(be/2,be/2)}});return b&&D.addListener("dragend",async S=>{const L=S?.latLng||D.getPosition(),V=typeof L.lat=="function"?L.lat():L.lat,r=typeof L.lng=="function"?L.lng():L.lng;try{await lt(ne,V,r,W,"manual")}catch(u){D.__setPosition(x),console.error("setVehiclePosition failed:",u),alert("Position konnte nicht gespeichert werden.")}}),D.__setPosition=S=>D.setPosition(S),D.__setIcon=(S,L,V)=>D.setIcon({url:K(S,L,V),scaledSize:new window.google.maps.Size(be,be),anchor:new window.google.maps.Point(be/2,be/2)}),D.__onOver=S=>{D.addListener("mouseover",S),D.addListener("mouseout",()=>_.close())},D}};for(const x of le){const U=String(x.id),ae=Ee(`${x?.label||""} ${x?.ort||""}`),Z=J.get(ae),W=B.get(U);if(!W&&!Z)continue;let ne=null,q=null;if(Z)q={lat:Number(Z.lat),lng:Number(Z.lng)},ne=q;else if(X.has(U))ne=X.get(U);else if(W&&A.has(W)){const V=A.get(W),u=((I.get(W)||0)+ge)%360;I.set(W,u),ne=pt(V,se,u)}if(!ne)continue;const D=pe(ne,!!W,x.label||x.id,q,W,U),S=W&&v.find(V=>V.id===W),L=S?`<br/><i>zugeordnet: ${S.content}</i>`:"";D.__onOver(()=>{const V=x?.ort||"";_.setContent(`<div style="min-width:220px"><b>${x.label||x.id}</b>${V?`<br/>${V}`:""}${L}</div>`);const r=de?void 0:D;_.open({map:P,anchor:r,position:ne,shouldFocus:!1})}),y.set(U,D)}P.setCenter(O),P.setZoom(18),$=setInterval(async()=>{const x=await bt(),U=await xt(),ae=new Map(U.filter(S=>S&&S.source!=="gps"&&Number.isFinite(S.latitude)&&Number.isFinite(S.longitude)).map(S=>[String(S.id),{lat:Number(S.latitude),lng:Number(S.longitude)}])),Z=new Map(x.filter(S=>Number.isFinite(S?.lat)&&Number.isFinite(S?.lng)&&S?.realname).map(S=>[Ee(S.realname),S])),W=new Map;for(const S of[...n?.board?.columns?.neu?.items||[],...n?.board?.columns?.["in-bearbeitung"]?.items||[]])for(const L of S.assignedVehicles||[])W.set(String(L),S.id);const ne=Object.values(n.vehiclesById||{}),q=new Map;for(const S of ne){const L=String(S.id),V=W.get(L),r=Ee(`${S?.label||""} ${S?.ort||""}`);if(V&&!Z.get(r)){const u=q.get(V)||[];u.push(L),q.set(V,u)}}for(const[S,L]of q.entries())L.sort();const b=10,D=50;for(const S of ne){const L=String(S.id),V=y.get(L);if(!V)continue;const r=Ee(`${S?.label||""} ${S?.ort||""}`),u=Z.get(r),j=W.get(L);if(u)gpsPos={lat:Number(u.lat),lng:Number(u.lng)},V.__setPosition(gpsPos);else if(ae.has(L))V.__setPosition(ae.get(L));else if(j&&A.has(j)){const ee=((q.get(j)||[]).indexOf(L)+1)*D%360,Q=A.get(j);V.__setPosition(pt(Q,b,ee))}else{const G=y.get(L);G&&(G.setMap?G.setMap(null):G.map&&(G.map=null),y.delete(L));continue}const M=!!j;V.__setIcon(M,gpsPos,j)}},5e3)}catch(O){w(O?.message||"Kartenaufbau fehlgeschlagen.")}finally{g(!1)}})(),()=>{C=!0,$&&clearInterval($),y.clear()}},[m,n,H]),!m||!n?.card){const C=`https://www.google.com/maps?q=${encodeURIComponent(l)}&output=embed`;return e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:o,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[70vh] p-2",onClick:P=>P.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-semibold text-sm",children:["Karte: ",l]}),e.jsx("button",{className:"px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm",onClick:o,children:"SchlieÃŸen"})]}),e.jsx("iframe",{title:"maps",className:"w-full h-full rounded-lg border",src:C,loading:"lazy"})]})})}return e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:o,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-5xl h-[75vh] p-2",onClick:C=>C.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-semibold text-sm",children:["Karte: ",n?.card?.content||"Einsatz"," Â· weitere EinsÃ¤tze (Neu & In Bearbeitung)"]}),e.jsx("button",{className:"px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm",onClick:o,children:"SchlieÃŸen"})]}),e.jsx("div",{ref:p,className:"w-full h-full rounded-lg border"}),h&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"px-3 py-1.5 rounded bg-white shadow text-sm",children:"Ladeâ€¦"})}),!!N&&e.jsx("div",{className:"absolute bottom-3 left-3 px-2 py-1 rounded bg-red-600 text-white text-xs shadow",children:N})]})})}function On({onClose:n,onCreate:a}){const[o,l]=s.useState(""),[m,p]=s.useState(""),[h,g]=s.useState(0),[N,w]=s.useState(!1),[H,C]=s.useState(""),P=async _=>{if(_.preventDefault(),C(""),!o.trim()||!m.trim()){C("Ort und Name sind erforderlich.");return}try{w(!0),await a({ort:o.trim(),label:m.trim(),mannschaft:Number(h)||0}),n()}catch(y){C(y?.message||"Speichern fehlgeschlagen.")}finally{w(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:e.jsxs("form",{onSubmit:P,className:"bg-white rounded-xl shadow-lg p-4 w-[360px] space-y-3",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Einheit anlegen"}),H&&e.jsx("div",{className:"text-sm text-red-600",children:H}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Ort"}),e.jsx("input",{className:"border rounded px-2 py-1 w-full",value:o,onChange:_=>l(_.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Name"}),e.jsx("input",{className:"border rounded px-2 py-1 w-full",value:m,onChange:_=>p(_.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Mannschaft"}),e.jsx("input",{type:"number",min:"0",className:"border rounded px-2 py-1 w-24",value:h,onChange:_=>g(_.target.value)})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:n,className:"px-3 py-1 rounded border",disabled:N,children:"Abbrechen"}),e.jsx("button",{type:"submit",className:"px-3 py-1 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:N,children:N?"Anlegenâ€¦":"Anlegen"})]})]})})}let _e=null;function Ct(){const n=document.querySelector('meta[name="google-places-key"]');return(window.GMAPS_API_KEY||n?.content||"").trim()||""}async function zn(n=Ct()){if(window.google?.maps?.places)return!0;if(!n)return!1;if(_e)return await _e,!!window.google?.maps?.places;_e=new Promise((a,o)=>{if(document.getElementById("gmap-places")){const m=()=>{window.google?.maps?.places?a(!0):setTimeout(m,150)};m();return}const l=document.createElement("script");l.id="gmap-places",l.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(n)}&libraries=places&language=de`,l.async=!0,l.defer=!0,l.onload=()=>a(!!window.google?.maps?.places),l.onerror=m=>o(m),document.head.appendChild(l)});try{await _e}catch{}return!!window.google?.maps?.places}function It({debounceMs:n=300,country:a="at",minLength:o=3}={}){const[l,m]=s.useState(""),[p,h]=s.useState([]),[g,N]=s.useState(!1),[w,H]=s.useState(!1),[C,P]=s.useState(null),_=s.useRef(null),y=s.useRef(null),$=s.useRef(null),T=s.useRef(null);s.useEffect(()=>{let k=!1;return(async()=>{const J=await zn(Ct());k||!J||!window.google?.maps?.places||(_.current=new google.maps.places.AutocompleteService,y.current=new google.maps.places.PlacesService(document.createElement("div")),$.current=new google.maps.places.AutocompleteSessionToken,k||H(!0))})(),()=>{k=!0}},[]);const O=s.useCallback(()=>{window.google?.maps?.places&&($.current=new google.maps.places.AutocompleteSessionToken)},[]),Y=s.useRef();s.useEffect(()=>{Y.current||(Y.current=(k,J)=>{let te;return(...X)=>{clearTimeout(te),te=setTimeout(()=>k(...X),J)}})},[]);const v=s.useCallback(async k=>{if(!w||!_.current)return;const J=(k||"").trim();if(!J||J.length<o){h([]);return}N(!0),P(null),_.current.getPlacePredictions({input:J,sessionToken:$.current,componentRestrictions:{country:a},types:["address"]},(te,X)=>{if(N(!1),X!==google.maps.places.PlacesServiceStatus.OK||!te){h([]),X&&X!=="ZERO_RESULTS"&&P(X);return}h(te)})},[a,o,w]),A=s.useMemo(()=>Y.current?Y.current(v,n):()=>{},[v,n]);s.useEffect(()=>{A(l)},[l,A]);const B=s.useCallback((k,J=["formatted_address","geometry","address_components"])=>new Promise((te,X)=>{if(!w||!y.current){X(new Error("Google Places nicht bereit"));return}y.current.getDetails({placeId:k,fields:J,sessionToken:$.current},(le,se)=>{if(se!==google.maps.places.PlacesServiceStatus.OK||!le)return X(new Error(se||"DETAILS_FAILED"));te(le)})}),[w]);return{ready:w,query:l,setQuery:m,predictions:p,loading:g,error:C,resetSession:O,getDetailsByPlaceId:B,inputElRef:T}}function Fn({onClose:n,onCreate:a,types:o}){const[l,m]=s.useState(""),[p,h]=s.useState(""),[g,N]=s.useState(!1),w=s.useRef(null),{query:H,setQuery:C,predictions:P,getDetailsByPlaceId:_,resetSession:y,loading:$,error:T}=It({country:"at",debounceMs:300,minLength:3});s.useEffect(()=>{setTimeout(()=>w.current?.focus(),0)},[]),s.useEffect(()=>{const v=(p||"").replace(/^T\d+\s*,?\s*/i,"").trim();!l.trim()&&v&&m(v)},[p]);const O=async v=>{v?.preventDefault?.();const A=(p||"").replace(/^T\d+\s*,?\s*/i,"").trim(),B=(l||A).trim();if(B){N(!0);try{await a({title:B,ort:(H||"").trim(),typ:(p||"").trim()}),m(""),C(""),h(""),y(),n?.()}finally{N(!1)}}},Y=async v=>{try{const B=(await _(v.place_id,["formatted_address","geometry","address_components","place_id"]))?.formatted_address||v.description;C(B)}catch{C(v.description)}finally{y()}};return e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-3",children:e.jsxs("form",{onSubmit:O,className:"bg-white rounded-xl shadow-lg w-[520px] max-w-full p-4 space-y-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Einsatz anlegen"}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs("select",{ref:w,className:"border rounded px-2 py-1",value:p,onChange:v=>h(v.target.value),children:[e.jsx("option",{value:"",children:"â€” Typ auswÃ¤hlen â€”"}),o.map(v=>e.jsx("option",{value:v,children:v},v))]}),e.jsx("input",{className:"border rounded px-2 py-1",placeholder:"Titel (wird aus Typ Ã¼bernommen)",value:l,onChange:v=>m(v.target.value)}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{className:"border rounded px-2 py-1 w-full",placeholder:"Ort (nur Ã–sterreich)",autoComplete:"off",value:H,onChange:v=>C(v.target.value)}),$&&e.jsx("div",{className:"absolute z-10 mt-1 text-xs text-gray-500 bg-white border rounded px-2 py-1",children:"Sucheâ€¦"}),T&&e.jsxs("div",{className:"absolute z-10 mt-1 text-xs text-red-600 bg-white border rounded px-2 py-1",children:["Fehler: ",String(T)]}),!!P.length&&e.jsx("ul",{className:"absolute z-10 mt-1 w-full max-h-52 overflow-auto bg-white border rounded shadow",children:P.map(v=>e.jsx("li",{className:"px-2 py-1 hover:bg-gray-100 cursor-pointer text-sm",onClick:()=>Y(v),title:v.description,children:v.description},v.place_id))})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:n,className:"px-3 py-1 rounded border",disabled:g,children:"Abbrechen"}),e.jsx("button",{className:"px-3 py-1 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:g,children:g?"Anlegenâ€¦":"Anlegen"})]})]})})}function Vn({colId:n,title:a,bg:o,children:l,editable:m=!0}){if(!m)return e.jsxs("section",{className:`${o} rounded-xl shadow p-3 h-full flex flex-col min-h-0`,children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:a}),l]});const{setNodeRef:p,isOver:h}=hn({id:`col:${n}`,data:{type:"column",colId:n}});return e.jsxs("section",{ref:p,className:`${o} rounded-xl shadow p-3 h-full flex flex-col min-h-0 ${h?"outline outline-2 outline-blue-400":""}`,children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:a}),l]})}function Bn({open:n,onClose:a,info:o={}}){if(!n)return null;const l=({label:g,value:N})=>e.jsxs("div",{className:"flex items-start gap-3 py-1",children:[e.jsx("div",{className:"w-32 shrink-0 text-gray-600",children:g}),e.jsx("div",{className:"flex-1 font-medium break-words",children:N??"â€”"})]}),m=o.timestamp?new Date(o.timestamp).toLocaleString("de-AT",{hour12:!1}):"â€”",p=[];o.location&&p.push(String(o.location)),Number.isFinite(o.latitude)&&Number.isFinite(o.longitude)&&p.push(`(${o.latitude}, ${o.longitude})`);const h=p.length?p.join(" "):void 0;return e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:a}),e.jsxs("div",{className:"relative z-[101] w-[min(92vw,640px)] rounded-xl bg-white shadow-xl p-4 md:p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg md:text-xl font-bold",children:"Einsatz-Info"}),e.jsx("button",{className:"h-8 w-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center",onClick:a,"aria-label":"SchlieÃŸen",title:"SchlieÃŸen",children:e.jsx("svg",{viewBox:"0 0 12 12",width:"14",height:"14","aria-hidden":"true",children:e.jsx("path",{d:"M1 1 L11 11 M11 1 L1 11",stroke:"black",strokeWidth:"2",strokeLinecap:"round"})})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(l,{label:"Typ",value:o.type||o.typ}),e.jsx(l,{label:"Alarmzeit",value:m}),e.jsx(l,{label:"Alarmiert",value:o.alerted}),e.jsx(l,{label:"Beschreibung",value:o.description}),e.jsx(l,{label:"Adresse",value:o.additionalAddressInfo||o.ort}),e.jsx(l,{label:"Location",value:h})]}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx("button",{className:"px-3 py-1.5 rounded-md bg-emerald-600 text-white hover:bg-emerald-700",onClick:a,children:"OK"})})]})]})}function Kn(n){const a=(n??"").toString();return a.length>30?a.slice(0,30)+"â€¦":a}function Un(){const[n,a]=s.useState([]),[o,l]=s.useState(!0),[m,p]=s.useState(!1);s.useEffect(()=>{(async()=>{try{await qe(),p(Qe("protokoll"))}catch{p(!1)}})(),(async()=>{try{const g=await fetch("/api/protocol").then(N=>N.json());a(Array.isArray(g?.items)?g.items:[])}catch{a([])}finally{l(!1)}})()},[]);const h=s.useMemo(()=>[...n].sort((g,N)=>(Number(N.nr)||0)-(Number(g.nr)||0)),[n]);return e.jsxs("div",{className:"p-3 md:p-4 max-w-[1400px] mx-auto h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-3",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:"MeldungsÃ¼bersicht"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("a",{href:"/api/protocol/csv/file",className:"px-3 py-1.5 rounded-md border bg-white",title:"protocol.csv herunterladen",children:"CSV"}),e.jsx("button",{onClick:()=>{m&&(window.location.hash="/protokoll/neu")},className:"px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white",title:m?void 0:"Keine Berechtigung (Meldestelle)",children:"+ Eintrag anlegen"})]})]}),e.jsx("div",{className:"flex-1 overflow-auto border rounded-lg bg-white",children:o?e.jsx("div",{className:"p-4 text-gray-500",children:"Ladeâ€¦"}):e.jsxs("table",{className:"min-w-[1100px] w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0 z-10",children:e.jsxs("tr",{className:"[&>th]:px-2 [&>th]:py-2 [&>th]:text-left [&>th]:font-semibold border-b",children:[e.jsx("th",{style:{width:28},title:"Druckstatus"}),e.jsx("th",{style:{width:60},children:"NR"}),e.jsx("th",{style:{width:110},children:"Datum"}),e.jsx("th",{style:{width:80},children:"Zeit"}),e.jsx("th",{style:{width:120},children:"Kanal"}),e.jsx("th",{style:{width:110},children:"Richtung"}),e.jsx("th",{style:{width:160},children:"An/Von"}),e.jsx("th",{children:"Information"}),e.jsx("th",{style:{width:260},children:"Meldungstyp"})]})}),e.jsxs("tbody",{className:"[&>tr>td]:px-2 [&>tr>td]:py-2",children:[h.map(g=>{const N=g?.uebermittlungsart||{},w=N.kanal??N.kanalNr??N.art??"",C=[].concat(N.ein?"Eingang":[]).concat(N.aus?"Ausgang":[]).join(" / "),P=Number(g?.printCount)>0;return e.jsxs("tr",{className:"border-b align-top hover:bg-gray-50 cursor-pointer",onClick:()=>{window.location.hash=`/protokoll/edit/${g.nr}`},title:"Zum Bearbeiten Ã¶ffnen",children:[e.jsx("td",{className:"align-middle",children:P?e.jsx("span",{className:"inline-block w-3 h-3 rounded-full bg-yellow-400",title:`Gedruckt (${g.printCount})`}):null}),e.jsx("td",{className:"font-semibold",children:g.nr}),e.jsx("td",{children:g.datum}),e.jsx("td",{children:g.zeit}),e.jsx("td",{title:w,children:w}),e.jsx("td",{title:C,children:C}),e.jsx("td",{children:g.anvon}),e.jsx("td",{className:"whitespace-pre-wrap",children:Kn(g.information)}),e.jsx("td",{className:"whitespace-pre-wrap",children:g.infoTyp||"â€”"})]},g.nr)}),!h.length&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"p-4 text-gray-500 italic",children:"â€” keine EintrÃ¤ge â€”"})})]})]})}),e.jsx("a",{href:"/Hilfe_Meldestelle.pdf",target:"_blank",rel:"noopener noreferrer",className:"fixed bottom-4 right-4 px-4 py-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-lg",title:"Hilfe â€“ Meldestelle/Protokoll",children:"Hilfe"})]})}const We=["EL","LtStb","S1","S2","S3","S4","S5","S6"],ye={anvon:"prot_sugg_anvon",kanal:"prot_sugg_kanalNr",verantwortlich:"prot_sugg_ver"};function Ge(n,a=12){const o=new Set,l=[];for(const m of n){const p=String(m||"").trim();if(!(!p||o.has(p))&&(o.add(p),l.push(p),l.length>=a))break}return l}function vt(n){let a=String(n||"").trim();if(!a)return a;const o=a.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})$/);if(o){const m=o[1].padStart(2,"0"),p=o[2].padStart(2,"0");return`${o[3].length===2?"20"+o[3]:o[3]}-${p}-${m}`}const l=a.match(/^(\d{1,2})(\d{1,2})(\d{2,4})$/);if(l){const m=l[1].padStart(2,"0"),p=l[2].padStart(2,"0");return`${l[3].length===2?"20"+l[3]:l[3].padStart(4,"20")}-${p}-${m}`}return a}function jt(n){let a=String(n||"").trim();if(!a)return a;const o=a.match(/^(\d{1,2})(\d{2})$/);if(o)return`${o[1].padStart(2,"0")}:${o[2]}`;const l=a.match(/^(\d{1,2})[:.](\d{1,2})$/);return l?`${l[1].padStart(2,"0")}:${l[2].padStart(2,"0")}`:a}const Nt=()=>({datum:new Date().toISOString().slice(0,10),zeit:new Date().toTimeString().slice(0,5),uebermittlungsart:{richtung:"",kanalNr:""},anvon:{richtung:"an",name:""},infoTyp:"Information",information:"",rueckmeldung1:"",rueckmeldung2:"",ergehtAn:[],ergehtAnText:"",lagebericht:"",massnahmen:Array.from({length:5},()=>({massnahme:"",verantwortlich:"",done:!1}))});function St({mode:n="create",editNr:a=null}){const[o,l]=s.useState(!1),[m,p]=s.useState(!1);s.useEffect(()=>{let r=!0;return(async()=>{try{if(await qe(),!r)return;p(Qe("protokoll"))}catch{if(!r)return;p(!1)}})(),()=>{r=!1}},[]);const[h,g]=s.useState(()=>{const r=Number(a);return Number.isFinite(r)&&r>0?r:null}),N=Number.isFinite(Number(h))&&Number(h)>0,[w,H]=s.useState(N),[C,P]=s.useState(!1),[_,y]=s.useState(null),$=s.useRef(null),T=s.useRef(null),O=s.useRef(!1),Y=s.useRef(null),[v,A]=s.useState(null),B=s.useRef(null),k=(r,u,j=2200)=>{A({type:r,text:u}),B.current&&clearTimeout(B.current),B.current=setTimeout(()=>A(null),j)},[J,te]=s.useState([]),[X,le]=s.useState([]),[se,ge]=s.useState([]);s.useEffect(()=>{try{te(JSON.parse(localStorage.getItem(ye.anvon)||"[]")),le(JSON.parse(localStorage.getItem(ye.kanal)||"[]")),ge(JSON.parse(localStorage.getItem(ye.verantwortlich)||"[]"))}catch{}},[]);const[I,de]=s.useState(Nt()),K=(r,u)=>{const j=Array.isArray(r)?r:String(r).split(".");de(M=>{const G=structuredClone(M);let F=G;for(let ee=0;ee<j.length-1;ee++)F=F[j[ee]];return F[j.at(-1)]=u,G})};s.useEffect(()=>{if(!N){H(!1),setTimeout(()=>T.current?.focus(),0);return}const r=Number(h);!Number.isFinite(r)||r<=0||(async()=>{try{const u=await fetch(`/api/protocol/${r}`).then(j=>j.json());if(u?.ok&&u.item){const j=u.item,M=j.uebermittlungsart||{};let G="",F=j.anvon||"";const ee=(j.anvon||"").trim();/^an\s*:/i.test(ee)&&(G="an",F=ee.replace(/^an\s*:/i,"").trim()),/^von\s*:/i.test(ee)&&(G="von",F=ee.replace(/^von\s*:/i,"").trim()),de({datum:j.datum||"",zeit:j.zeit||"",uebermittlungsart:{richtung:M.ein?"ein":M.aus?"aus":"",kanalNr:M.kanalNr||""},anvon:{richtung:G||"an",name:F},infoTyp:j.infoTyp||"Information",information:j.information||"",rueckmeldung1:j.rueckmeldung1||"",rueckmeldung2:j.rueckmeldung2||"",ergehtAn:Array.isArray(j.ergehtAn)?j.ergehtAn:[],ergehtAnText:j.ergehtAnText||"",lagebericht:j.lagebericht||"",massnahmen:Array.from({length:5},(Q,ie)=>{const me=j.massnahmen?.[ie]||{};return{massnahme:me.massnahme||"",verantwortlich:me.verantwortlich||"",done:!!me.done}})}),y(j.id||null),setTimeout(()=>T.current?.focus(),0)}}finally{H(!1)}})()},[N,h]),s.useEffect(()=>{const r=()=>{const M=document.activeElement;M&&typeof M.blur=="function"&&M.blur()},u=M=>setTimeout(M,0),j=M=>{if(M.repeat)return;const G=(M.key||"").toLowerCase(),F=M.ctrlKey||M.metaKey;if(F&&!M.shiftKey&&G==="s"){if(M.preventDefault(),M.stopPropagation(),!m){k?.("error","Keine Berechtigung (Meldestelle)");return}if(O.current)return;O.current=!0,u(async()=>{r(),await new Promise(ee=>setTimeout(ee,0)),q().finally(()=>O.current=!1)});return}if(F&&(M.shiftKey&&G==="s"||G==="enter")){if(M.preventDefault(),M.stopPropagation(),!m){k?.("error","Keine Berechtigung (Meldestelle)");return}if(O.current)return;O.current=!0,u(async()=>{r(),await new Promise(ee=>setTimeout(ee,0)),b().finally(()=>O.current=!1)});return}G==="escape"&&(M.preventDefault(),M.stopPropagation(),u(()=>W()))};return window.addEventListener("keydown",j,!0),document.addEventListener("keydown",j,!0),()=>{window.removeEventListener("keydown",j,!0),document.removeEventListener("keydown",j,!0)}},[]);const[pe,x]=s.useState(!1),U=s.useRef(null);function ae(){const r=Array.isArray(I?.ergehtAn)?[...I.ergehtAn]:[],u=(I?.ergehtAnText||"").trim();return u&&r.push(u),r}const Z=async()=>{if(!m){k?.("error","Keine Berechtigung zum Drucken/Speichern");return}if(pe)return;const r=ae();if(!r.length){k?.("error","Bitte EmpfÃ¤nger wÃ¤hlen oder 'Sonstiger EmpfÃ¤nger' ausfÃ¼llen.");return}x(!0);try{const u=await ne();if(!u)throw new Error("Speichern fehlgeschlagen");g(u);const M=(await fetch(`/api/protocol/${u}`).then(ie=>ie.json()))?.item;if(!M)throw new Error("Datensatz fÃ¼r Druck nicht gefunden");k?.("info","PDF wird serverseitig erzeugt â€¦");const G=await fetch(`/api/protocol/${u}/print`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({recipients:r,data:M})}).then(ie=>ie.json());if(!G?.ok||!G?.fileUrl)throw new Error(G?.error||"PDF-Erzeugung fehlgeschlagen");let F=U.current;F||(F=document.createElement("iframe"),F.style.position="fixed",F.style.width="0",F.style.height="0",F.style.border="0",F.style.visibility="hidden",document.body.appendChild(F),U.current=F);const ee=`${G.fileUrl}#toolbar=0&navpanes=0&scrollbar=0`;F.onload=()=>{try{setTimeout(()=>{F.contentWindow?.focus(),F.contentWindow?.print()},100)}catch{window.open(ee,"_blank","noopener,noreferrer")?.focus()}},F.src=ee;const Q=Number(G?.pages)||r.length;k?.("success",`Druck gestartet (${Q} Seite${Q>1?"n":""})`)}catch(u){k?.("error",`Drucken fehlgeschlagen: ${u.message||u}`)}finally{x(!1)}},W=()=>{window.location.hash="/protokoll"},ne=async()=>{const r=Y.current?new FormData(Y.current):null,u=structuredClone(I);u.datum=vt(r?.get("datum")||I.datum),u.zeit=jt(r?.get("zeit")||I.zeit);const j=(r?.get("anvonDir")||I.anvon.richtung||"").toString(),M=(r?.get("anvonName")||I.anvon.name||"").toString();u.anvon={richtung:j,name:M};const G=(r?.get("richtung")||I.uebermittlungsart.richtung||"").toString();u.uebermittlungsart.richtung=G,u.uebermittlungsart.kanalNr=(r?.get("kanalNr")||I.uebermittlungsart.kanalNr||"").toString(),u.information=(r?.get("information")||I.information||"").toString(),u.rueckmeldung1=(r?.get("rueckmeldung1")||I.rueckmeldung1||"").toString(),u.rueckmeldung2=(r?.get("rueckmeldung2")||I.rueckmeldung2||"").toString(),u.ergehtAnText=(r?.get("ergehtAnText")||I.ergehtAnText||"").toString(),u.infoTyp=(r?.get("infoTyp")||I.infoTyp||"Information").toString();const F=r?Array.from(r.getAll("ergehtAn")).map(String):I.ergehtAn;u.ergehtAn=F.length?F:I.ergehtAn,u.massnahmen=u.massnahmen.map((Q,ie)=>{const me=r?r.get(`m_done_${ie}`)!==null:Q.done;return{massnahme:(r?.get(`m_massnahme_${ie}`)||Q.massnahme||"").toString(),verantwortlich:(r?.get(`m_verantwortlich_${ie}`)||Q.verantwortlich||"").toString(),done:!!me}});const ee={...u,uebermittlungsart:{kanalNr:(u.uebermittlungsart.kanalNr||"").trim(),ein:u.uebermittlungsart.richtung==="ein",aus:u.uebermittlungsart.richtung==="aus"},anvon:u.anvon.richtung?`${u.anvon.richtung==="an"?"An":"Von"}: ${u.anvon.name}`.trim():u.anvon.name.trim()};try{const Q=Ge([ee.anvon,...JSON.parse(localStorage.getItem(ye.anvon)||"[]")]),ie=Ge([ee.uebermittlungsart.kanalNr,...JSON.parse(localStorage.getItem(ye.kanal)||"[]")]),me=[...u.massnahmen.map(Ae=>Ae.verantwortlich).filter(Boolean),...JSON.parse(localStorage.getItem(ye.verantwortlich)||"[]")],ve=Ge(me);localStorage.setItem(ye.anvon,JSON.stringify(Q)),localStorage.setItem(ye.kanal,JSON.stringify(ie)),localStorage.setItem(ye.verantwortlich,JSON.stringify(ve)),te(Q),le(ie),ge(ve)}catch{}if(N){const Q=await fetch(`/api/protocol/${h}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(ee)}).then(ie=>ie.json());if(!Q?.ok)throw new Error(Q?.error||"Speichern fehlgeschlagen");return g(Q.nr),y(Q.id||_||null),Q.nr}else{const Q=await fetch("/api/protocol",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ee)}).then(ie=>ie.json());if(!Q?.ok)throw new Error(Q?.error||"Speichern fehlgeschlagen");return g(Q.nr),y(Q.id||null),Q.nr}},q=async()=>{if(!m){k?.("error","Keine Berechtigung (Meldestelle)");return}if(!C){P(!0);try{await ne()&&(window.location.hash="/protokoll")}catch(r){k("error","Fehler beim Speichern: "+r.message,4e3)}finally{P(!1)}}},b=async()=>{if(!m){k?.("error","Keine Berechtigung (Meldestelle)");return}if(!C){P(!0);try{const r=await ne();r&&(k("success",`Gespeichert (NR ${r}) â€“ neuer Eintrag`),de(Nt()),g(null),y(null),setTimeout(()=>T.current?.focus(),0))}catch(r){k("error","Fehler beim Speichern: "+r.message,4e3)}finally{P(!1)}}},D=r=>{const u=(r.key||"").toLowerCase(),j=r.ctrlKey||r.metaKey;r.repeat||(j&&!r.shiftKey&&u==="s"?(r.preventDefault(),r.stopPropagation(),q()):j&&(r.shiftKey&&u==="s"||u==="enter")&&(r.preventDefault(),r.stopPropagation(),b()))},S=r=>{if(r.preventDefault(),!m){k?.("error","Keine Berechtigung (Meldestelle)");return}q()};if(w)return e.jsx("div",{className:"p-4",children:"Ladeâ€¦"});const L=We.every(r=>I.ergehtAn.includes(r)),V=r=>K("ergehtAn",r?[...We]:[]);return e.jsxs("div",{className:"mx-auto w-full max-w-[1100px] relative",children:[e.jsx("div",{className:"prot-actionbar sticky top-0 z-30 -mx-2 md:mx-0 px-2 md:px-0",children:e.jsxs("div",{className:"bg-white/95 backdrop-blur border-b rounded-t-xl px-3 py-2 flex items-center justify-between shadow-sm",children:[e.jsx("div",{className:"text-sm font-semibold",children:N?`Protokoll â€“ Bearbeiten (NR ${h??"â€”"})`:"Protokoll â€“ Neuer Eintrag"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:W,className:"px-3 py-1.5 rounded-md border",title:"Maske schlieÃŸen und zur Ãœbersicht wechseln (ESC)",children:"Abbrechen"}),e.jsx("button",{type:"button",onClick:b,disabled:C,className:"px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white disabled:opacity-60",title:"Speichern und neue Maske (Strg+Shift+S oder Strg+Enter)",children:"Speichern/Neu"}),e.jsx("button",{type:"button",onClick:q,disabled:C,className:"px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-60",title:"Speichern und schlieÃŸen (Strg+S)",children:C?"Speichernâ€¦":"Speichern"}),e.jsx("button",{type:"button",onClick:Z,disabled:pe,className:"px-3 py-1.5 rounded-md border bg-white hover:bg-gray-50 disabled:opacity-60",title:"Formular drucken â€“ Anzahl gemÃ¤ÃŸ 'ergeht an' + 'Sonstiger EmpfÃ¤nger'",children:pe?"Druckenâ€¦":"Drucken"})]})]})}),v&&e.jsx("div",{className:"fixed right-3 top-3 z-40",children:e.jsx("div",{className:"px-3 py-2 rounded shadow text-white "+(v.type==="success"?"bg-emerald-600":v.type==="error"?"bg-rose-600":"bg-slate-600"),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{children:v.text}),e.jsx("button",{className:"opacity-80 hover:opacity-100",onClick:()=>A(null),title:"Meldung schlieÃŸen",children:"âœ•"})]})})}),e.jsx("style",{children:`
        @media print {
          * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          .prot-actionbar { display: none !important; }
          html, body { margin: 0 !important; }
          @page { size: A4; margin: 12mm; }
        }
      `}),e.jsxs("form",{ref:Y,onKeyDown:D,onSubmit:S,className:"bg-white border-2 rounded-b-xl overflow-hidden shadow",children:[e.jsxs("div",{className:"grid grid-cols-12",children:[e.jsx("div",{className:"col-span-9 p-6 border-b-2",children:e.jsx("div",{className:"text-3xl font-extrabold tracking-wide",children:"MELDUNG/INFORMATION"})}),e.jsxs("div",{className:"col-span-3 border-l-2",children:[e.jsx("div",{className:"p-3 text-xs text-gray-600 border-b-2",children:"PROTOKOLL-NR"}),e.jsx("div",{className:"p-6 text-center text-4xl font-bold",children:h??"â€”"})]}),e.jsx("div",{className:"col-span-12 border-y-2 p-2",children:e.jsxs("div",{className:"grid grid-cols-12 gap-0",children:[e.jsxs("div",{className:"col-span-6 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Datum"}),e.jsx("input",{name:"datum",type:"text",className:"border rounded px-2 h-9 w-full",placeholder:"yyyy-mm-dd",value:I.datum,onChange:r=>K("datum",r.target.value),onBlur:r=>K("datum",vt(r.target.value)),title:"Datum (auch 101025 oder 10.10.2025 mÃ¶glich)"})]}),e.jsxs("div",{className:"col-span-3 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Uhrzeit"}),e.jsx("input",{name:"zeit",type:"text",className:"border rounded px-2 h-9 w-full",placeholder:"hh:mm",value:I.zeit,onChange:r=>K("zeit",r.target.value),onBlur:r=>K("zeit",jt(r.target.value)),title:"Uhrzeit (915, 09:15 oder 0915 mÃ¶glich)"})]}),e.jsxs("div",{className:"col-span-3 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Typ"}),e.jsxs("div",{className:"grid grid-cols-3 gap-x-6 h-9 items-center",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{ref:T,type:"radio",name:"infoTyp",value:"Information",checked:I.infoTyp==="Information",onChange:()=>K("infoTyp","Information")}),e.jsx("span",{children:"Info"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"infoTyp",value:"Auftrag",checked:I.infoTyp==="Auftrag",onChange:()=>K("infoTyp","Auftrag")}),e.jsx("span",{children:"Auftrag"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"infoTyp",value:"Lagemeldung",checked:I.infoTyp==="Lagemeldung",onChange:()=>K("infoTyp","Lagemeldung")}),e.jsx("span",{children:"Lage"})]})]})]})]})}),e.jsx("div",{className:"col-span-12 border-y-2 p-2",children:e.jsxs("div",{className:"grid grid-cols-12 gap-0 items-end",children:[e.jsxs("div",{className:"col-span-6 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"An/Von"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{ref:$,name:"anvonName",className:"border rounded px-2 h-9 w-full flex-1",placeholder:"Name / Stelle",list:"dl-anvon",value:I.anvon.name,onChange:r=>{let u=r.target.value;const j=u.trim();/^an\s*:/i.test(j)?(K(["anvon","richtung"],"an"),u=j.replace(/^an\s*:/i,"").trim()):/^von\s*:/i.test(j)&&(K(["anvon","richtung"],"von"),u=j.replace(/^von\s*:/i,"").trim()),K(["anvon","name"],u)},title:'Optional mit PrÃ¤fix "an: â€¦" oder "von: â€¦"'}),e.jsxs("div",{className:"flex items-center gap-4 pl-2 min-w-[140px] shrink-0",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"anvonDir",value:"an",checked:I.anvon.richtung==="an",onChange:()=>K(["anvon","richtung"],"an")}),e.jsx("span",{children:"An"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"anvonDir",value:"von",checked:I.anvon.richtung==="von",onChange:()=>K(["anvon","richtung"],"von")}),e.jsx("span",{children:"Von"})]})]})]}),e.jsx("datalist",{id:"dl-anvon",children:J.map(r=>e.jsx("option",{value:r},r))})]}),e.jsxs("div",{className:"col-span-3 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Kanal"}),e.jsx("input",{name:"kanalNr",className:"border rounded px-2 h-9 w-full",list:"dl-kanal",value:I.uebermittlungsart.kanalNr,onChange:r=>K(["uebermittlungsart","kanalNr"],r.target.value),title:"z. B. Funkkanal, Telefonnummer, E-Mail-KÃ¼rzel â€¦"}),e.jsx("datalist",{id:"dl-kanal",children:X.map(r=>e.jsx("option",{value:r},r))})]}),e.jsxs("div",{className:"col-span-3 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Richtung"}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-6 h-9 items-center",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",title:"Meldung wurde empfangen",children:[e.jsx("input",{type:"radio",name:"richtung",value:"ein",checked:I.uebermittlungsart.richtung==="ein",onChange:()=>K(["uebermittlungsart","richtung"],"ein")}),e.jsx("span",{children:"Eingang"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",title:"Meldung wurde gesendet",children:[e.jsx("input",{type:"radio",name:"richtung",value:"aus",checked:I.uebermittlungsart.richtung==="aus",onChange:()=>K(["uebermittlungsart","richtung"],"aus")}),e.jsx("span",{children:"Ausgang"})]})]})]})]})}),e.jsxs("div",{className:"col-span-12 border-y-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Information/Auftrag"}),e.jsx("textarea",{name:"information",className:"border rounded px-2 py-2 w-full min-h-[160px]",value:I.information,onChange:r=>K("information",r.target.value),title:"Sachverhalt / Meldetext"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"RÃ¼ckmeldung 1"}),e.jsx("input",{name:"rueckmeldung1",className:"border rounded px-2 h-9 w-full",value:I.rueckmeldung1,onChange:r=>K("rueckmeldung1",r.target.value),title:"erste RÃ¼ckmeldung"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"RÃ¼ckmeldung 2"}),e.jsx("input",{name:"rueckmeldung2",className:"border rounded px-2 h-9 w-full",value:I.rueckmeldung2,onChange:r=>K("rueckmeldung2",r.target.value),title:"zweite RÃ¼ckmeldung"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-2",children:"ergeht an:"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 mr-3",title:"Alle EmpfÃ¤nger auswÃ¤hlen / abwÃ¤hlen",children:[e.jsx("input",{type:"checkbox",checked:L,onChange:r=>V(r.target.checked)}),e.jsx("span",{children:"Alle"})]}),We.map(r=>e.jsxs("label",{className:"inline-flex items-center gap-2 mr-3",children:[e.jsx("input",{tabIndex:-1,type:"checkbox",name:"ergehtAn",value:r,checked:I.ergehtAn.includes(r),onChange:()=>{const u=new Set(I.ergehtAn);u.has(r)?u.delete(r):u.add(r),K("ergehtAn",[...u])},title:`EmpfÃ¤nger ${r} ${I.ergehtAn.includes(r)?"entfernen":"hinzufÃ¼gen"}`}),e.jsx("span",{children:r})]},r)),e.jsx("span",{className:"ml-2 text-xs text-gray-600",children:"sonstiger EmpfÃ¤nger:"}),e.jsx("input",{name:"ergehtAnText",className:"border rounded px-2 h-9",value:I.ergehtAnText,onChange:r=>K("ergehtAnText",r.target.value),placeholder:"Name/Gruppe"})]})]}),e.jsxs("div",{className:"col-span-12 border-t-2",children:[e.jsxs("div",{className:"grid grid-cols-12 bg-gray-50 border-b-2",children:[e.jsx("div",{className:"col-span-6 p-2 font-semibold border-r",children:"MaÃŸnahme"}),e.jsx("div",{className:"col-span-5 p-2 font-semibold border-r",children:"Verantwortlich"}),e.jsx("div",{className:"col-span-1 p-2 font-semibold text-center",children:"Erledigt"})]}),I.massnahmen.map((r,u)=>e.jsxs("div",{className:"grid grid-cols-12 border-t",children:[e.jsx("div",{className:"col-span-6 p-2 border-r",children:e.jsx("input",{name:`m_massnahme_${u}`,className:"w-full border rounded px-2 h-9",value:r.massnahme,onChange:j=>{const M=[...I.massnahmen];M[u]={...r,massnahme:j.target.value},K("massnahmen",M)},title:`MaÃŸnahme ${u+1}`})}),e.jsx("div",{className:"col-span-5 p-2 border-r",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{name:`m_verantwortlich_${u}`,className:"w-full border rounded px-2 h-9",list:"dl-ver",value:r.verantwortlich,onChange:j=>{const M=[...I.massnahmen];M[u]={...r,verantwortlich:j.target.value},K("massnahmen",M)},title:`Verantwortlich ${u+1}`}),e.jsx("button",{type:"button",className:"px-2 h-9 text-xs rounded border bg-white hover:bg-gray-50",title:"Als Aufgabe anlegen (mit Protokoll-Bezug)",onClick:()=>createTaskFromMeasure(u),disabled:o,children:"â†’"})]})}),e.jsx("div",{className:"col-span-1 p-2 flex items-center justify-center",children:e.jsx("input",{tabIndex:-1,type:"checkbox",name:`m_done_${u}`,value:"1",checked:!!r.done,onChange:j=>{const M=[...I.massnahmen];M[u]={...r,done:j.target.checked},K("massnahmen",M)},title:"Erledigt umschalten"})})]},u)),e.jsx("datalist",{id:"dl-ver",children:se.map(r=>e.jsx("option",{value:r},r))})]})]}),e.jsx("button",{type:"submit",className:"hidden",children:"submit"})]})]})}function Hn({disabled:n=!1}){const[a,o]=s.useState(!1),[l,m]=s.useState(!1),[p,h]=s.useState(""),[g,N]=s.useState({remainingMin:null,idleMinutes:null,lastActivityIso:null,autoStopMin:null}),[w,H]=s.useState({lastLoadedIso:null,file:"list_filtered.json"}),[C,P]=s.useState(!1),[_,y]=s.useState(30),[$,T]=s.useState(null),O=s.useRef(!1),Y=async()=>{try{const[v,A,B]=await Promise.all([fetch("/api/ff/status",{credentials:"include",cache:"no-store"}).then(k=>k.json()).catch(()=>({running:!1})),fetch("/api/ff/creds",{credentials:"include",cache:"no-store"}).then(k=>k.json()).catch(()=>({has:!1})),fetch("/api/import/auto-config",{credentials:"include",cache:"no-store"}).then(k=>k.json()).catch(()=>({enabled:!1,intervalSec:30}))]);o(!!v.running),m(!!A.has),P(!!B.enabled),y(Number(B.intervalSec||30)),O.current||(O.current=!0,A.has||h("Keine globalen Fetcher-Zugangsdaten. Bitte als Admin unter /user-admin setzen."))}catch{}};return s.useEffect(()=>{Y();const v=setInterval(Y,3e3);return()=>clearInterval(v)},[]),s.useEffect(()=>{let v;const A=async()=>{try{const B=await fetch("/api/activity/status",{credentials:"include",cache:"no-store"});if(B.ok){const k=await B.json(),J=Number(k.idleMinutes),te=Number(k.autoStopMin),X=Math.max(0,Math.ceil(te-J));N({remainingMin:X,idleMinutes:J,lastActivityIso:k.lastActivityIso,autoStopMin:te}),o(!!k.fetcher?.running),H({lastLoadedIso:k.import?.lastLoadedIso??null,file:k.import?.file||"list_filtered.json"})}}catch{}};return A(),v=setInterval(A,1e3),()=>clearInterval(v)},[]),s.useEffect(()=>{let v;const A=()=>{if(!C||!w.lastLoadedIso){T(null);return}const k=new Date(w.lastLoadedIso).getTime()+_*1e3,J=Math.max(0,Math.ceil((k-Date.now())/1e3));T(J)};return A(),v=setInterval(A,1e3),()=>clearInterval(v)},[C,_,w.lastLoadedIso]),e.jsxs("div",{className:`flex items-center h-9 gap-2 ${n?"opacity-60 pointer-events-none":""}`,style:{alignItems:"center"},children:[e.jsx("span",{className:`sync-chip ${C?"active":""}`,title:C?"Auto-Import Countdown":"Auto-Import ist deaktiviert",style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:"110px",minWidth:"110px",textAlign:"center"},children:C?`âŸ³ in ${$??"â€“"}s`:"â¸ manuell"}),p&&e.jsx("span",{style:{color:"#dc2626",fontSize:12,marginLeft:8},children:p}),a&&g.remainingMin!=null&&g.remainingMin<=15&&e.jsxs("div",{title:`Letzte AktivitÃ¤t: ${g.lastActivityIso?new Date(g.lastActivityIso).toLocaleString():"â€“"} â€¢ Inaktiv: ${g.idleMinutes?.toFixed?.(1)} min â€¢ Limit: ${g.autoStopMin} min`,className:"ml-2 inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border "+(g.remainingMin<=5?"bg-red-50 text-red-700 border-red-300":g.remainingMin<=15?"bg-amber-50 text-amber-700 border-amber-300":"bg-blue-50 text-blue-700 border-blue-300"),children:[e.jsx("span",{className:"mr-2 h-2 w-2 rounded-full bg-current",style:{animation:"pulse 1.5s ease-in-out infinite"}}),e.jsxs("span",{children:["Auto-Import stoppt in ",e.jsxs("b",{children:[g.remainingMin," min"]})]})]}),e.jsx("div",{title:`Quelle: ${w.file}`,className:"ml-2 inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border bg-white text-gray-700",style:{borderColor:"#cbd5e1"},children:e.jsxs("span",{children:["Zuletzt geladen:"," ",e.jsx("b",{children:w.lastLoadedIso?new Date(w.lastLoadedIso).toLocaleTimeString("de-AT",{hour12:!1}):"â€“"})]})})]})}function Wn(){const[n,a]=s.useState(.9);return s.useEffect(()=>{const o=()=>{const l=window.innerWidth,m=window.innerHeight,p=Math.min(Math.max(Math.min(l/1440,m/900),.78),.95);a(Number(p.toFixed(2)))};return o(),window.addEventListener("resize",o),()=>window.removeEventListener("resize",o)},[]),n}function Gn(){try{const n=new URLSearchParams(window.location.search),a=parseFloat(n.get("font"));if(Number.isFinite(a)&&a>=.5&&a<=5)return a}catch{}try{const n=parseFloat(localStorage.getItem("ff_font_scale")||"");if(Number.isFinite(n)&&n>=.5&&n<=5)return n}catch{}return 1.2}const Et=n=>new Intl.DateTimeFormat("de-AT",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).format(new Date(n||Date.now())),At=n=>Array.isArray(n?.assignedVehicles)?n.assignedVehicles.length:0,Mt=(n,a)=>(n?.assignedVehicles||[]).reduce((o,l)=>{const m=a.get(l);return o+(typeof m?.mannschaft=="number"?m.mannschaft:0)},0);function Jn({c:n,vehiclesById:a,showBottomCounts:o=!0,headerRight:l,kind:m}){const p=m==="erledigt",h=p?Array.isArray(n?.everVehicles)?n.everVehicles.length:0:At(n),g=p?Number.isFinite(n?.everPersonnel)?n.everPersonnel:0:Mt(n,a);return e.jsxs("div",{className:"border rounded-lg p-2 bg-white shadow-sm text-[0.9rem] leading-tight",children:[e.jsxs("div",{className:"flex items-start justify-between text-[0.72rem] text-gray-600 mb-1",children:[e.jsx("span",{children:Et(n.createdAt)}),e.jsx("span",{className:"font-semibold",children:l})]}),e.jsx("div",{className:"font-semibold",children:n.content}),(n.ort||n.typ||n.alerted)&&e.jsxs("div",{className:"text-[0.75rem] text-gray-600 mt-0.5 space-x-2",children:[n.ort&&e.jsxs("span",{children:["ðŸ“ ",n.ort]}),n.typ&&e.jsxs("span",{children:["ðŸ·ï¸ ",n.typ]}),n.alerted&&e.jsxs("span",{className:"text-gray-500",children:["ðŸ”” ",n.alerted]})]}),o&&e.jsxs("div",{className:"mt-1 text-[0.78rem] text-gray-700 flex items-center gap-2",children:[e.jsxs("span",{children:["ðŸš’ ",h]}),e.jsxs("span",{children:["ðŸ‘¥ ",g]})]})]})}function Je({title:n,cards:a,vehiclesById:o,kind:l,viewportH:m}){const g=Math.max(160,m-56-40),N=Math.max(1,Math.floor(g/96)),w=N*2,H=N+1,C=Math.max(w+2,H+6);let P="grid-cols-1";a.length>=C?P="grid-cols-3":a.length>=H&&(P="grid-cols-2");const _=T=>Et(T.statusSince),y=s.useMemo(()=>{const T=a.length,O=a.reduce((v,A)=>l==="erledigt"?v+(Array.isArray(A.everVehicles)?A.everVehicles.length:0):v+(Array.isArray(A.assignedVehicles)?A.assignedVehicles.length:0),0),Y=a.reduce((v,A)=>{if(l==="erledigt")return v+(Number.isFinite(A?.everPersonnel)?A.everPersonnel:0);const k=(Array.isArray(A.assignedVehicles)?A.assignedVehicles:[]).reduce((J,te)=>J+(o.get(te)?.mannschaft??0),0);return v+k},0);return{cardCount:T,unitSum:O,personSum:Y}},[a,l,o]),$={neu:"bg-red-100","in-bearbeitung":"bg-yellow-100",erledigt:"bg-green-100"}[l]||"bg-gray-100";return e.jsxs("section",{className:`${$} rounded-xl shadow p-3 h-full flex flex-col min-h-0`,children:[e.jsxs("h3",{className:"text-sm font-semibold mb-2",children:[n," â€” â¬› ",y.cardCount," | ðŸš’ ",y.unitSum," | ðŸ‘¥ ",y.personSum]}),e.jsx("div",{className:`grid ${P} gap-2 overflow-auto pr-1 flex-1 min-h-0 place-content-start`,children:a.map(T=>e.jsx(Jn,{c:T,vehiclesById:o,headerRight:_(T),showBottomCounts:!0,kind:l},T.id))}),a.length===0&&e.jsx("div",{className:"text-[0.8rem] text-gray-500 italic text-center py-4",children:"â€” keine EintrÃ¤ge â€”"})]})}function Zn(){Wn();const[n,a]=s.useState(Gn());s.useEffect(()=>{const y=document.documentElement.style.fontSize||"",$=Math.max(50,Math.min(500,Math.round(n*100)));return document.documentElement.style.fontSize=$+"%",()=>{document.documentElement.style.fontSize=y}},[n]),s.useEffect(()=>{const y=$=>{if($.key==="ff_font_scale"){const T=parseFloat($.newValue||"");Number.isFinite(T)&&T>=.5&&T<=5&&a(T)}};return window.addEventListener("storage",y),()=>window.removeEventListener("storage",y)},[]);const[o,l]=s.useState(null),[m,p]=s.useState([]),[h,g]=s.useState(window.innerHeight);s.useEffect(()=>{let y=!0;const $=async()=>{const[Y,v]=await Promise.all([ce(),Ze()]);y&&(l(Y),p(v))};$();const T=setInterval($,7e3),O=()=>g(window.innerHeight);return window.addEventListener("resize",O),()=>{y=!1,clearInterval(T),window.removeEventListener("resize",O)}},[]),s.useEffect(()=>{try{const y=new URLSearchParams(window.location.search);if(y.get("print")==="1"||y.get("pdf")==="1"){const $=setTimeout(()=>{window.print()},600);return()=>clearTimeout($)}}catch{}},[]),s.useEffect(()=>{const y=()=>{try{window.close()}catch{}};return window.addEventListener("afterprint",y),()=>window.removeEventListener("afterprint",y)},[]);const N=s.useMemo(()=>new Map(m.map(y=>[y.id,y])),[m]),w=s.useMemo(()=>{const y={neu:{items:[]},"in-bearbeitung":{items:[]},erledigt:{items:[]}};return o?.columns?o.columns:y},[o]),H=s.useMemo(()=>{let y=0;for(const $ of["neu","in-bearbeitung"])for(const T of w[$].items||[])y+=At(T);return y},[w]),C=s.useMemo(()=>{let y=0;for(const $ of["neu","in-bearbeitung"])for(const T of w[$].items||[])y+=Mt(T,N);return y},[w,N]),P=s.useMemo(()=>(w.neu.items.length||0)+(w["in-bearbeitung"].items.length||0),[w]),_=s.useMemo(()=>P+(w.erledigt.items.length||0),[P,w]);return o?e.jsx("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden",children:e.jsxs("div",{className:"h-full w-full flex flex-col gap-2",children:[e.jsxs("header",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:"Einsatzstellen-Ãœbersicht-Feuerwehr"}),e.jsxs("div",{className:"text-base md:text-lg font-bold flex flex-wrap gap-4",children:[e.jsxs("span",{children:["ðŸš’ ",H]}),e.jsxs("span",{children:["ðŸ‘¥ ",C]}),e.jsxs("span",{children:["ðŸŸ¡ Aktiv: ",P]}),e.jsxs("span",{children:["ðŸ“¦ Gesamt: ",_]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2 min-h-0 flex-1",children:[e.jsx(Je,{title:"Neu",cards:w.neu.items,vehiclesById:N,kind:"neu",viewportH:h}),e.jsx(Je,{title:"In Bearbeitung",cards:w["in-bearbeitung"].items,vehiclesById:N,kind:"in-bearbeitung",viewportH:h}),e.jsx(Je,{title:"Erledigt",cards:w.erledigt.items,vehiclesById:N,kind:"erledigt",viewportH:h})]})]})}):e.jsx("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden",children:e.jsx("div",{className:"h-full w-full flex items-center justify-center",children:"Ladeâ€¦"})})}function qn(){const[n]=s.useState(.9);return n}const Qn=n=>`card:${n}`,Ne=!0;async function Yn(n){if(!n||!window.google?.maps?.Geocoder)return null;const a=new google.maps.Geocoder;return new Promise(o=>{a.geocode({address:n,region:"AT"},(l,m)=>{if(m==="OK"&&l&&l[0]){const p=l[0],h=p.geometry?.location;o({lat:h?.lat?.(),lng:h?.lng?.(),formatted:p.formatted_address||n})}else o(null)})})}function es(){if(qn(),typeof window<"u"&&window.location.pathname==="/status")return e.jsx(Zn,{});const n=typeof window<"u"&&window.__USER__||null,[a,o]=s.useState(!1);s.useEffect(()=>{qe().then(()=>o(!0))},[]);const l=a&&Qe("einsatzboard"),m=!l,[p,h]=s.useState(null),[g,N]=s.useState([]),[w,H]=s.useState([]),[C,P]=s.useState(""),[_,y]=s.useState(""),[$,T]=s.useState(""),[O,Y]=s.useState(null),[v,A]=s.useState(null),[B,k]=s.useState(""),[J,te]=s.useState(!1),[X,le]=s.useState(!1),[se,ge]=s.useState(!1),[I,de]=s.useState(30),[K,pe]=s.useState(!1),[x,U]=s.useState(!1),[ae,Z]=s.useState(!1),[W,ne]=s.useState(null),q=t=>{ne(t),Z(!0)},[b,D]=s.useState(window.location.hash);s.useEffect(()=>{const t=()=>D(window.location.hash);return window.addEventListener("hashchange",t),()=>window.removeEventListener("hashchange",t)},[]);const S=b.replace(/^#/,""),[L,V]=s.useState(()=>new Set),[r,u]=s.useState(0),j=s.useRef(0),M=s.useRef(new Set),[G,F]=s.useState(0);s.useEffect(()=>{document.title="Einsatzstellen-Ãœbersicht-Feuerwehr",gn()},[]);const{logout:ee}=pn?.()||{},Q=async()=>{try{await ee?.()}finally{window.location.href="/user-login"}};s.useEffect(()=>{if(!l)return;if(!se){F(0);return}const t=setInterval(()=>F(i=>i+1),1e3);return()=>clearInterval(t)},[Ne,se]);const ie=se?Math.max(0,I-G%Math.max(1,I)):0,{query:me,setQuery:ve,predictions:Ae,getDetailsByPlaceId:Pt,resetSession:Me,loading:Tt,error:Ye}=It({country:"at",debounceMs:300,minLength:3}),Pe=s.useRef(null);s.useEffect(()=>{document.title="Einsatzstellen-Ãœbersicht-Feuerwehr"},[]),s.useEffect(()=>{(async()=>{const[t,i,c]=await Promise.all([ce(),Ze(),fn()]);h(t),N(i),H(Array.isArray(c)?c:[]);try{const d=await xn();ge(!!d.enabled),de(Number(d.intervalSec)||30),Te.current=et(t)}catch{}F(0)})()},[Ne]),s.useEffect(()=>{se&&(async()=>{try{(await fetch("/api/ff/status",{credentials:"include",cache:"no-store"}).then(i=>i.json()).catch(()=>({running:!1}))).running||await fetch("/api/ff/start",{method:"POST",credentials:"include"})}catch{}})()},[Ne,se,I]),s.useEffect(()=>{y(me||"")},[me]),s.useEffect(()=>{let t;const i=Math.max(5,Math.min(60,se?8:15)),c=async()=>{try{const d=new Set(Te.current),f=await ce();h(f),tt({oldIds:d,newBoard:f,pulseMs:8e3})}catch{}t=setTimeout(c,i*1e3)};return t=setTimeout(c,i*1e3),()=>clearTimeout(t)},[Ne,se]),s.useEffect(()=>{const t=i=>{i.altKey&&(i.key==="e"||i.key==="E")&&(i.preventDefault(),U(!0),Me())};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[Ne,Me]);const ue=p??{columns:{neu:{items:[]},"in-bearbeitung":{items:[]},erledigt:{items:[]}}},Dt=10;function $t(t){try{const i=t?.columns||{};return[(i.neu?.items||[]).length,(i["in-bearbeitung"]?.items||[]).length,(i.erledigt?.items||[]).length].some(d=>d>=Dt)}catch{return!1}}s.useEffect(()=>{const t=$t(ue);document.documentElement.classList.toggle("ui-dense",t)},[ue]);const[Re,Xe]=s.useState(new Set),Te=s.useRef(new Set);s.useEffect(()=>{if(!Re.size)return;const t=setTimeout(()=>Xe(new Set),9e3);return()=>clearTimeout(t)},[Re]);function et(t){const i=new Set;if(!t?.columns)return i;for(const c of Object.keys(t.columns))for(const d of t.columns[c].items||[])i.add(String(d.id));return i}function tt({oldIds:t,newBoard:i,pulseMs:c=8e3}){const d=Date.now(),f=et(i),E=new Set;for(const z of f)t.has(z)||E.add(z);const R=new Set([...E].filter(z=>!M.current.has(String(z))));for(const z of E)M.current.delete(String(z));if(R.size>0&&(Xe(R),u(d+c),d>=j.current))try{Cn()}catch{}Te.current=f}const[Oe,nt]=s.useState(!1),Lt=async()=>{if(!Oe){nt(!0);try{const t=new Set(Te.current),i=await fetch("/api/import/trigger",{method:"POST"});if(!i.ok){const d=await i.text().catch(()=>"");throw new Error(`Import fehlgeschlagen (HTTP ${i.status}) ${d}`)}const c=await ce();h(c),tt({oldIds:t,newBoard:c,pulseMs:8e3}),F(0)}catch(t){alert(t.message||"Import fehlgeschlagen.")}finally{nt(!1)}}},[_t,st]=s.useState(!1),Rt=t=>String(t).replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function Ot(t,i){const c=String(i).match(/^(.*?)-(\d+)$/),d=c?c[1]:String(i);let f=c?parseInt(c[2],10):1;for(const E of t){const R=String(E.label||"").match(new RegExp("^"+Rt(d)+"-(\\d+)$"));if(!R)continue;const z=parseInt(R[1],10);Number.isFinite(z)&&z>f&&(f=z)}return`${d}-${f+1}`}async function zt(t,i){if(_t)return;const c=je.get(t);if(c){st(!0);try{const d=Ot(g,c.label||c.id),f=await fetch("/api/vehicles",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ort:c.ort||"",label:d,mannschaft:0})}),E=await f.json().catch(()=>({}));if(!f.ok||E?.error)throw new Error(E?.error||"Clone fehlgeschlagen");const z=await(await fetch("/api/vehicles")).json();N(z);let oe=E?.vehicle?.id;oe||(oe=z.find(we=>we.label===d&&we.ort===(c.ort||"")&&Number(we.mannschaft)===0)?.id),i&&oe&&await He(i,oe),h(await ce())}catch(d){alert(d.message||"Clone fehlgeschlagen")}finally{st(!1)}}}const je=s.useMemo(()=>new Map(g.map(t=>[t.id,t])),[g]),[rt,at]=s.useState(new Map),Ft=s.useMemo(()=>{const t={};for(const[i,c]of je.entries())t[i]=c;return t},[je]),it=s.useMemo(()=>{const t=new Set,i=ue?.columns||{};for(const c of Object.keys(i))for(const d of i[c].items||[])for(const f of d.assignedVehicles||[])t.add(f);return t},[ue]),Se=s.useMemo(()=>g.filter(t=>t&&typeof t.id<"u"&&!it.has(t.id)),[g,it]),fe=s.useMemo(()=>{const t={};for(const i of Se){const c=i.ort||"Unbekannt";(t[c]??=[]).push(i)}for(const i of Object.keys(t))t[i].sort((c,d)=>(c.label||c.id).localeCompare(d.label||d.id));return Object.entries(t).sort((i,c)=>i[0].localeCompare(c[0]))},[Se]);s.useEffect(()=>{if(localStorage.getItem("ff_collapsed_groups")||!fe.length)return;const i=fe.map(([c])=>c);De(new Set(i)),localStorage.setItem("ff_collapsed_groups",JSON.stringify(i))},[Ne,fe]),s.useEffect(()=>{let t=setInterval(async()=>{try{const i=await fetch("/api/activity/status",{cache:"no-store"}).then(c=>c.json());typeof i?.auto?.enabled=="boolean"&&i.auto.enabled!==se&&ge(!!i.auto.enabled)}catch{}},3e3);return()=>clearInterval(t)},[Ne,se]);function ze(t,i){for(const c of["neu","in-bearbeitung","erledigt"])if((t.columns[c].items||[]).some(d=>d?.id===i))return c;return null}function Vt(t,i){for(const c of["neu","in-bearbeitung","erledigt"]){const d=(t.columns[c].items||[]).find(f=>f?.id===i);if(d)return d}return null}function Fe(t){const i=ue?.columns?.[t]?.items||[];if(t==="erledigt"){const f=i.reduce((R,z)=>R+(z.everVehicles?.length||0),0),E=i.reduce((R,z)=>R+(Number.isFinite(z?.everPersonnel)?z.everPersonnel:0),0);return{cards:i.length,units:f,persons:E}}const c=i.reduce((f,E)=>f+(E.assignedVehicles?.length||0),0),d=i.reduce((f,E)=>Number.isFinite(E?.manualPersonnel)?f+E.manualPersonnel:f+(E.assignedVehicles||[]).reduce((R,z)=>R+(je.get(z)?.mannschaft??0),0),0);return{cards:i.length,units:c,persons:d}}const Bt=Fe("neu"),Kt=Fe("in-bearbeitung"),Ut=Fe("erledigt"),Ht=async()=>{const t=$.replace(/^T\d+\s*,?\s*/i,"").trim(),i=(C||t).trim();if(!i){alert("Bitte Typ oder Titel angeben.");return}const c={id:`tmp-${Math.random().toString(36).slice(2,10)}`,content:i,createdAt:new Date().toISOString(),statusSince:new Date().toISOString(),assignedVehicles:[],everVehicles:[],everPersonnel:0,ort:(_||"").trim(),typ:$.trim()};te(!0),h(d=>{if(!d)return d;const f=structuredClone(d);return f.columns.neu.items.unshift(c),f});try{let d=null;const f=Pe.current;if(f?.geometry?.location?.lat&&f?.geometry?.location?.lng)d={lat:f.geometry.location.lat(),lng:f.geometry.location.lng()};else if(c.ort){const R=await Yn(c.ort);R&&(d={lat:R.lat,lng:R.lng})}const E=await mt(i,"neu",0,c.ort,c.typ,d??void 0);j.current=Date.now(),E?.card?.id!=null&&M.current.add(String(E.card.id)),h(R=>{if(!R)return R;const z=structuredClone(R),oe=z.columns.neu.items,Ce=oe.findIndex(we=>we?.id===c.id);return Ce>=0?oe[Ce]=E.card:oe.unshift(E.card),z}),P(""),ve(""),y(""),T(""),Pe.current=null,Me()}catch{h(d=>{if(!d)return d;const f=structuredClone(d);return f.columns.neu.items=f.columns.neu.items.filter(E=>E?.id!==c.id),f}),alert("Einsatz konnte nicht angelegt werden.")}finally{te(!1)}},Wt=async t=>{try{const i=await Pt(t.place_id,["formatted_address","geometry","address_components","place_id"]);Pe.current=i||null;const c=i?.formatted_address||t.description;ve(c),y(c)}catch(i){console.error("Place details failed:",i),Pe.current=null,ve(t.description),y(t.description)}finally{Me()}},Ve=t=>String(t||"").split(/[;,\n]/).map(i=>i.trim()).filter(Boolean),he=t=>String(t||"").normalize?.("NFD").replace?.(new RegExp("\\p{Diacritic}","gu"),"").replace(/^\s*FF\s+/i,"").replace(/[._\-\/]+/g," ").replace(/\s+/g," ").toLowerCase().trim();function Gt(t,i,c,d){const f=Ve(t?.alerted).map(he);if(f.length)for(const E of i){const R=f.some(oe=>he(E?.ort)===oe),z=f.some(oe=>he(E?.label)===oe);if(R||z){const oe=String(E.id);c.add(oe),d.has(oe)||d.set(oe,null)}}}async function Jt(t,i){if(!(i!=="neu"||!t?.id))try{const c=await In(t.id),d=new Set((c?.units||[]).map(re=>String(re.unitId)));if(t?.alerted){const re=Ve(t.alerted).map(he);for(const xe of Se){const Ke=re.some(Ue=>he(xe.ort)===he(Ue)),Ie=re.some(Ue=>he(xe.label)===he(Ue));(Ke||Ie)&&d.add(String(xe.id))}}V(d),u(Date.now()+3e3);const f=new Map;for(const re of c?.units||[]){const xe=Number(re?.distanceKm);f.set(String(re.unitId),Number.isFinite(xe)?xe:null)}d.size===0&&t?.alerted&&Gt(t,Se,d,f),at(f);const E=new Set((c?.units||[]).filter(re=>!re.assigned).map(re=>String(re.unitId))),R=new Set(Se.map(re=>String(re.id))),z=new Set([...E,...[...d].filter(re=>R.has(re))]),oe=Ve(t?.alerted).map(he),Ce=new Set;if(oe.length&&Se.length>0)for(const[re,xe]of fe){if(xe.length===0)continue;oe.some(Ie=>he(re)===he(Ie))&&Ce.add(re)}const we=[];for(const[re,xe]of fe)(xe.some(Ie=>z.has(String(Ie.id)))||Ce.has(re))&&we.push(re);Qt(we),clearTimeout(pulseTimerRef.current),pulseTimerRef.current=setTimeout(()=>{V(new Set),u(0),at(new Map)},3200)}catch(c){console.error("fetchNearby failed:",c)}}const[ot,De]=s.useState(()=>{try{const t=localStorage.getItem("ff_collapsed_groups");return new Set(t?JSON.parse(t):[])}catch{return new Set}}),Zt=t=>ot.has(t),qt=(t,i)=>{De(c=>{const d=new Set(c);return i?d.add(t):d.delete(t),localStorage.setItem("ff_collapsed_groups",JSON.stringify([...d])),d})},Qt=(t=[])=>{De(()=>{const i=fe.map(([d])=>d),c=new Set(i);for(const d of t)c.delete(d);return localStorage.setItem("ff_collapsed_groups",JSON.stringify([...c])),c})},Yt=(t=!0)=>{De(()=>{const i=fe.map(([d])=>d),c=t?new Set(i):new Set;return localStorage.setItem("ff_collapsed_groups",JSON.stringify([...c])),c})},Xt=()=>{const t=fe.map(([c])=>c),i=t.length>0&&t.every(c=>ot.has(c));Yt(!i)},[$e,Be]=s.useState(null),[en,ke]=s.useState(null),tn=bn(ct(Pn,{activationConstraint:{distance:4}}),ct(Mn,{activationConstraint:{delay:80,tolerance:6}})),nn=t=>{const i=t?.over;if(!i){ke(null);return}const c=String(i.id||"");if(c.startsWith("col:"))ke(c.slice(4));else if(c.startsWith("card:")){const d=ze(ue,c.slice(5));ke(d)}else ke(null)},sn=async t=>{if(m){ke(null),Be(null);return}ke(null);const{active:i,over:c}=t;if(Be(null),!i||!c)return;const d=String(i.id||""),f=String(c.id||"");if(d.startsWith("ass:")&&f.startsWith("card:")){const[,E,R]=d.split(":"),z=f.slice(5);if(E&&R&&z&&E!==z)try{await dt(E,R);try{await ut(R)}catch{}await He(z,R),h(await ce())}catch{alert("Einheit konnte nicht umgehÃ¤ngt werden.")}return}if(d.startsWith("veh:")&&f.startsWith("card:")){try{await He(f.slice(5),d.slice(4)),h(await ce())}catch{alert("Einheit konnte nicht zugewiesen werden.")}return}if(d.startsWith("card:")){const E=d.slice(5),R=ze(ue,E);if(!R)return;if(f.startsWith("col:")){const z=f.slice(4);if(R!==z)try{await Le({cardId:E,from:R,to:z,toIndex:0}),h(await ce())}catch{alert("Statuswechsel konnte nicht gespeichert werden.")}return}if(f.startsWith("card:")){const z=ze(ue,f.slice(5));if(z)try{await Le({cardId:E,from:R,to:z,toIndex:0}),h(await ce())}catch{alert("Statuswechsel konnte nicht gespeichert werden.")}}}},rn=async()=>{if(confirm("Board wirklich zurÃ¼cksetzen?")){le(!0);try{await En(),h(await ce())}catch{alert("Reset fehlgeschlagen.")}finally{le(!1)}}},an=()=>window.open(An(),"_blank","noopener,noreferrer"),on=async()=>{try{const t=await ht({enabled:!se,intervalSec:I});ge(!!t.enabled),de(Number(t.intervalSec)||30),F(0)}catch{alert("Konnte Auto-Import nicht Ã¤ndern.")}},ln=async t=>{const i=Math.max(5,Math.min(3600,Number(t)||30));de(i);try{await ht({enabled:se,intervalSec:i}),F(0)}catch{}},cn=async({title:t,ort:i,typ:c})=>{const d=await mt(t,"neu",0,i,c);j.current=Date.now(),d?.card?.id!=null&&M.current.add(String(d.card.id)),h(f=>{if(!f)return f;const E=structuredClone(f);return E.columns.neu.items.unshift(d.card),E})},dn=t=>{T(t);const i=t.replace(/^T\d+\s*,?\s*/i,"").trim();C.trim()||P(i)};if(S.startsWith("/protokoll/edit/")){const t=S.split("/")[3],i=Number(t);return e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Meldung â€“ Bearbeiten"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"Zur Ãœbersicht"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(St,{mode:"edit",editNr:i})})]})}return S.startsWith("/protokoll/neu")?e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Meldung â€“ Eintrag anlegen"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"Zur Ãœbersicht"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(St,{mode:"create"})})]}):S.startsWith("/protokoll")?e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Meldestelle"}),e.jsx("button",{onClick:()=>{window.location.hash="/"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"â† ZurÃ¼ck"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(Un,{})})]}):e.jsxs("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden flex flex-col",style:{fontSize:"var(--ui-scale)"},children:[!p&&e.jsx("div",{className:"fixed inset-0 z-10 bg-black/10 backdrop-blur-sm flex items-center justify-center",children:e.jsx("div",{className:"px-4 py-2 rounded-lg bg-white shadow",children:"Ladeâ€¦"})}),e.jsxs("header",{className:"flex flex-wrap items-center justify-between gap-2 mb-2",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:"Einsatzstellen-Ãœbersicht-Feuerwehr"}),e.jsxs("div",{className:"toolbar flex flex-wrap items-center gap-2",children:[e.jsx("button",{onClick:an,className:"px-3 py-1.5 rounded-md bg-purple-600 hover:bg-purple-700 text-white",children:"PDF"}),e.jsx("button",{onClick:Q,className:"px-3 py-1.5 rounded-md border border-gray-300 hover:bg-gray-100",title:n?.displayName?`Logout (${n.displayName})`:"Logout",children:"Logout"}),e.jsx("button",{onClick:()=>window.open("/api/log.csv","_blank"),className:"px-3 py-1.5 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white",title:"log.csv herunterladen",children:"LogÂ (CSV)"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-500 hover:bg-gray-600 text-white",children:"Meldestelle"}),e.jsx("button",{type:"button",onClick:()=>{window.location.href="/aufgaben"},className:"px-3 py-1.5 rounded-md bg-teal-600 hover:bg-teal-700 text-white",title:"Zum Aufgaben-Board",children:"Aufgaben"}),e.jsx("button",{onClick:Lt,disabled:m||Oe,className:"px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-60",title:"Import sofort ausfÃ¼hren",children:Oe?"Importâ€¦":"Import"}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm px-2 py-1 rounded-md bg-white border",children:[e.jsx("input",{type:"checkbox",checked:se,onChange:on,disabled:m})," Auto-Import"]}),e.jsxs("label",{className:"interval-capsule flex items-center text-sm text-gray-700 bg-gray-50 border border-gray-300 rounded-md overflow-hidden",children:[e.jsx("span",{className:"pl-3 pr-2 select-none",children:"IntervallÂ (s):"}),e.jsx("input",{type:"number",min:"5",max:"3600",value:I,onChange:t=>ln(t.target.value),disabled:m,className:`h-9 w-20 bg-white border-0 rounded-none text-center text-gray-800 
               focus:outline-none focus:ring-0 focus:border-0`})]}),e.jsx(Hn,{autoEnabled:se,remaining:ie,disabled:m}),e.jsx("button",{onClick:rn,disabled:m||X,className:`px-3 py-1.5 rounded-md text-white ${X?"bg-gray-400":"bg-gray-700 hover:bg-gray-800"}`,children:X?"Resetâ€¦":"Reset"})]})]}),e.jsxs("section",{className:"mb-2 grid grid-cols-1 md:grid-cols-7 gap-2",children:[e.jsxs("select",{className:"border rounded px-2 py-1 md:col-span-2",value:$,onChange:t=>dn(t.target.value),children:[e.jsx("option",{value:"",children:"â€” Typ auswÃ¤hlen â€”"}),w.map(t=>e.jsx("option",{value:t,children:t},t))]}),e.jsx("input",{className:"border rounded px-2 py-1 md:col-span-2",placeholder:"Titel (wird aus Typ Ã¼bernommen)",value:C,onChange:t=>P(t.target.value)}),e.jsxs("div",{className:"relative md:col-span-2",children:[e.jsx("input",{className:"border rounded px-2 py-1 w-full",placeholder:"Ort (nur Ã–sterreich)",autoComplete:"off",value:me,onChange:t=>ve(t.target.value)}),Tt&&e.jsx("div",{className:"absolute z-10 mt-1 text-xs text-gray-500 bg-white border rounded px-2 py-1",children:"Sucheâ€¦"}),Ye&&e.jsxs("div",{className:"absolute z-10 mt-1 text-xs text-red-600 bg-white border rounded px-2 py-1",children:["Fehler: ",String(Ye)]}),!!Ae.length&&e.jsx("ul",{className:"absolute z-10 mt-1 w-full max-h-52 overflow-auto bg-white border rounded shadow",children:Ae.map(t=>e.jsx("li",{className:"px-2 py-1 hover:bg-gray-100 cursor-pointer text-sm",onClick:()=>Wt(t),title:t.description,children:t.description},t.place_id))})]}),e.jsx("button",{className:"px-3 py-1 rounded bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60",disabled:m||J,onClick:Ht,children:J?"Wird angelegtâ€¦":"Einsatz anlegen"})]}),e.jsxs(yn,{sensors:tn,collisionDetection:t=>t?.active?.data?.current?.type==="vehicle"?wn(t):vn(t),onDragStart:t=>Be({type:t?.active?.data?.current?.type,id:t.active.id,data:t?.active?.data?.current}),onDragOver:nn,onDragEnd:sn,children:[e.jsxs("main",{className:"grid grid-cols-1 md:[grid-template-columns:minmax(180px,220px)_repeat(3,minmax(0,1fr))] gap-2 min-h-0 flex-1 overflow-hidden",children:[e.jsxs("section",{className:"bg-white rounded-xl shadow p-3 h-full flex flex-col min-h-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-semibold",children:e.jsx("button",{type:"button",onClick:Xt,title:"Alle Gruppen auf/zu klappen",className:"underline decoration-dotted hover:opacity-80 focus:outline-none",children:"Einheiten (frei)"})}),l&&e.jsx("button",{onClick:()=>pe(!0),className:"px-2 py-1 text-sm rounded bg-emerald-600 text-white",children:"+ Einheit"})]}),e.jsxs("div",{className:"overflow-auto pr-1 flex-1 min-h-0 space-y-3",children:[fe.length===0&&e.jsx("div",{className:"text-[0.85rem] text-gray-500 italic",children:"â€” alle Einheiten sind zugewiesen â€”"}),fe.map(([t,i])=>{const c=Zt(t);return e.jsxs("div",{className:"border border-blue-400 rounded-md",children:[e.jsxs("button",{type:"button",onClick:()=>qt(t,!c),className:"w-full flex items-center justify-between px-2 py-2 text-left",title:c?"aufklappen":"zuklappen",children:[e.jsx("span",{className:"text-xs font-semibold text-gray-700",children:t}),e.jsx("span",{className:"group-chip",children:i.length})]}),!c&&e.jsx("div",{className:"px-2 pb-2 grid grid-cols-1 gap-1.5",children:i.map(d=>e.jsx(Dn,{editable:l,vehicle:d,pillWidthPx:160,near:L.has(String(d.id))&&Date.now()<r,distKm:rt.get(String(d.id))},d.id))})]},t)})]})]}),[{id:"neu",title:"Neu",bg:"bg-red-100",totals:Bt},{id:"in-bearbeitung",title:"In Bearbeitung",bg:"bg-yellow-100",totals:Kt},{id:"erledigt",title:"Erledigt",bg:"bg-green-100",totals:Ut}].map(({id:t,title:i,bg:c,totals:d})=>e.jsx("div",{className:en===t?"drag-over":"",children:e.jsx(Vn,{editable:l,colId:t,bg:c,title:e.jsxs("span",{className:"column-header flex items-center justify-between",children:[e.jsx("span",{className:"font-semibold",children:i}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsxs("span",{className:"kpi-badge","data-variant":"units",children:["ðŸš’ ",d.units]}),e.jsxs("span",{className:"kpi-badge","data-variant":"persons",children:["ðŸ‘¥ ",d.persons]}),e.jsxs("span",{className:"kpi-badge","data-variant":"cards",children:["â¬› ",d.cards]})]})]}),children:e.jsx("ul",{className:"space-y-2 overflow-y-auto overflow-x-hidden pl-1 pr-2 py-2",style:{maxHeight:"calc(100vh - 260px)"},children:e.jsx(jn,{items:(ue.columns[t].items||[]).map(f=>Qn(f.id)),strategy:Nn,children:(ue.columns[t].items||[]).map(f=>e.jsx(Tn,{editable:l,card:f,colId:t,vehiclesById:je,distById:rt,pillWidthPx:160,pulse:Re.has(String(f.id))&&Date.now()<r,onUnassign:async(E,R)=>{await dt(E,R);try{await ut(R)}catch{}h(await ce())},onOpenMap:E=>Y({address:f.ort,card:f,board:ue,vehiclesById:Ft}),onAdvance:l?async E=>{t==="neu"?(await Le({cardId:E.id,from:"neu",to:"in-bearbeitung",toIndex:0}),h(await ce())):t==="in-bearbeitung"&&(await Le({cardId:E.id,from:"in-bearbeitung",to:"erledigt",toIndex:0}),h(await ce()))}:void 0,onEditPersonnelStart:l?(E,R)=>{A({cardId:E.id}),k(R)}:void 0,editing:v,editingValue:B,setEditingValue:k,onEditPersonnelSave:l?async E=>{try{await Sn(E.id,B===""?null:Number(B)),h(await ce())}finally{A(null),k("")}}:void 0,onEditPersonnelCancel:l?()=>{A(null),k("")}:void 0,onClone:zt,onVehiclesIconClick:Jt,nearIds:L,nearUntilMs:r,onShowInfo:q},f.id))})})})},t))]}),e.jsxs(kn,{dropAnimation:{duration:180,easing:"ease-out"},children:[$e?.type==="vehicle"&&(()=>{const t=je.get($e?.data?.vehicleId);return t?e.jsx("div",{className:"pointer-events-none",children:e.jsxs("div",{style:{width:160},className:"max-w-full select-none border-2 border-red-300 rounded-2xl bg-white px-2 py-1 shadow-lg",children:[e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:t.label||t.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate",children:[t.ort||"â€”"," Â· ðŸ‘¥ ",t.mannschaft??0]})]})}):null})(),$e?.type==="card"&&(()=>{const t=String($e?.id||"").replace(/^card:/,""),i=Vt(ue,t);return i?e.jsx("div",{className:"pointer-events-none w-[280px]",children:e.jsxs("div",{className:"rounded-lg bg-white shadow-xl border p-3",children:[e.jsx("div",{className:"font-semibold text-sm mb-1 truncate",children:i.content}),e.jsxs("div",{className:"text-xs text-gray-600",children:[i.assignedVehicles?.length||0," Einheiten â€¢"," ","ðŸ‘¥ ",Number.isFinite(i?.manualPersonnel)?i.manualPersonnel:(i.assignedVehicles||[]).reduce((c,d)=>c+(je.get(d)?.mannschaft??0),0)]})]})}):null})()]})]}),l&&e.jsx("button",{className:"fab",title:"Einsatz anlegen",onClick:()=>U(!0),children:"ï¼‹"}),e.jsx("a",{href:"/Hilfe.pdf",target:"_blank",rel:"noopener noreferrer",className:"fixed bottom-4 right-4 px-4 py-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-lg",children:"Hilfe"}),K&&e.jsx(On,{onClose:()=>pe(!1),onCreate:async t=>{const i=await fetch("/api/vehicles",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!i.ok){const c=await i.text().catch(()=>String(i.status));throw new Error(`HTTP ${i.status} ${c}`)}N(await Ze())}}),x&&e.jsx(Fn,{onClose:()=>U(!1),onCreate:cn,types:w}),O&&e.jsx(Rn,{context:O,onClose:()=>Y(null)}),e.jsx(Bn,{open:ae,info:W||{},onClose:()=>{Z(!1),ne(null)}})]})}export{es as default};
