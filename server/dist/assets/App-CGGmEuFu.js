import{u as jt,j as e,r,a as on,C as ln,b as cn,c as St,i as dn,d as un,e as mn,f as at,D as hn,g as gn,h as pn,S as fn,v as xn,k as bn,T as yn,P as wn}from"./index-CHXXJq5m.js";function rt({cardId:s,vehicle:a,pillWidthPx:l=160,onUnassign:c,onClone:p,near:h=!1,distKm:f=null,readonly:v=!1}){const C=`ass:${s}:${a.id}`,S=v?null:jt({id:C,data:{type:"assigned",vehicleId:a.id,fromCardId:s}}),L=S?.attributes??{},k=S?.listeners??{},D=S?.setNodeRef??(()=>{}),E=S?.transform??null,B=S?.isDragging??!1,W={width:l,transform:E?`translate3d(${E.x}px, ${E.y}px, 0)`:void 0};return e.jsxs("div",{ref:D,style:W,...L,...k,className:`relative self-start border-2 rounded-2xl bg-white px-2 pr-9 py-1 shadow-sm
                  select-none cursor-grab active:cursor-grabbing
                  ${h?"border-emerald-500 ring-2 ring-emerald-300":"border-red-300"}
                  ${B?"opacity-50":""}`,title:"Ziehen: auf andere Karte verschieben · Doppelklick: klonen",onDoubleClick:()=>{v||p?.(a.id,s)},children:[h&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-0.5 rounded-2xl border-2 border-emerald-400/50 animate-ping"}),e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:a.label||a.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate flex justify-between items-center",children:[e.jsxs("span",{children:[a.ort||"—"," · 👥 ",a.mannschaft??0]}),h&&Number.isFinite(Number(f))&&e.jsxs("span",{className:"absolute top-1 right-8 text-[11px] tabular-nums text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded whitespace-nowrap",children:[Number(f)," Km"]})]}),!v&&e.jsx("button",{type:"button",onMouseDown:Y=>Y.stopPropagation(),onTouchStart:Y=>Y.stopPropagation(),onClick:Y=>{Y.stopPropagation(),c?.(s,a.id)},title:"Einheit entfernen",className:"absolute right-2 top-1/2 -translate-y-1/2 h-6 w-6 rounded-full bg-red-600 text-white shadow flex items-center justify-center","aria-label":"Einheit entfernen",children:e.jsx("svg",{viewBox:"0 0 12 12",width:"12",height:"12","aria-hidden":"true",children:e.jsx("path",{d:"M1 1 L11 11 M11 1 L1 11",stroke:"white",strokeWidth:"2",strokeLinecap:"round"})})})]})}function vn(s){const{card:a,colId:l,vehiclesById:c,pillWidthPx:p=160,onUnassign:h,onOpenMap:f,onAdvance:v,onEditPersonnelStart:C,editing:S,editingValue:L,setEditingValue:k,onEditPersonnelSave:D,onEditPersonnelCancel:E,onClone:B,onVehiclesIconClick:W,onShowInfo:Y,nearIds:F,nearUntilMs:J,distById:N,pulse:R,editable:V=!0}=s,[P,q]=r.useState(l==="in-bearbeitung"),_=r.useRef((a.assignedVehicles||[]).length),y=r.useRef(null),te=Date.now()<(J||0),O=V?on({id:`card:${a.id}`,data:{type:"card",cardId:a.id}}):{attributes:{},listeners:{},setNodeRef:w=>{},transform:null,transition:null,isDragging:!1},{attributes:pe,listeners:de,setNodeRef:ue,transform:le,transition:be,isDragging:x}=O,z={transform:ln.Transform.toString(le),transition:be,opacity:x?.8:1},Q=l==="erledigt"?a.everVehicles?.length||0:a.assignedVehicles?.length||0,K=r.useMemo(()=>(a.assignedVehicles||[]).map(w=>c.get(w)).filter(Boolean),[a,c]),U=r.useMemo(()=>l==="erledigt"?Number.isFinite(a?.everPersonnel)?a.everPersonnel:0:Number.isFinite(a?.manualPersonnel)?a.manualPersonnel:K.reduce((w,n)=>w+(n?.mannschaft??0),0),[l,a,K]);r.useEffect(()=>{if(l!=="in-bearbeitung"||!te)return;(a.assignedVehicles||[]).some(n=>F?.has(String(n)))&&q(!0)},[l,te,F,a.assignedVehicles]),r.useEffect(()=>{if(l!=="in-bearbeitung")return;const w=(a.assignedVehicles||[]).length,n=_.current;w>n&&q(!0),_.current=w},[l,a.assignedVehicles]),r.useEffect(()=>{if(l==="in-bearbeitung"&&P&&y.current)try{y.current.scrollIntoView({behavior:"smooth",block:"nearest"})}catch{}},[l,P]);const ee=()=>{l==="neu"?typeof W=="function"&&W(a,l):(l==="in-bearbeitung"||l==="erledigt")&&q(w=>!w)},H=()=>{V&&typeof C=="function"&&C(a,U)};return e.jsxs("li",{ref:ue,style:z,className:`relative rounded-lg bg-white shadow border transition mx-1
              ${R&&l==="neu"?"ring-2 ring-red-400/60":""}`,children:[R&&l==="neu"&&e.jsxs(e.Fragment,{children:[e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 rounded-lg bg-red-500/10 animate-pulse-inner"}),e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 rounded-lg animate-ping-safe"})]}),e.jsxs("div",{className:"p-3 select-none",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",...pe,...de,children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-semibold text-sm leading-5 truncate",children:a.content}),!!a.ort&&e.jsx("button",{type:"button",onClick:()=>f?.(a.ort),className:"text-[12px] text-blue-700 hover:underline truncate",title:"Ort in Karte öffnen",children:a.ort})]}),e.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[e.jsxs("button",{type:"button",title:l==="neu"?"Nahe Einheiten prüfen":"Einheiten auf-/zuklappen",className:"px-2 py-1 rounded text-[12px] border hover:bg-red-50 flex items-center gap-1",onPointerDown:w=>w.stopPropagation(),onClick:w=>{w.stopPropagation(),w.preventDefault(),ee()},children:["🚒 ",Q,(l==="in-bearbeitung"||l==="erledigt")&&e.jsx("span",{children:P?"▾":"▸"})]}),e.jsxs("button",{type:"button",className:"px-2 py-1 rounded text-[12px] border bg-white hover:bg-gray-50",title:"Personalzahl bearbeiten",onPointerDown:w=>w.stopPropagation(),onClick:w=>{w.stopPropagation(),H()},children:["👥 ",U]}),V&&v&&e.jsx("button",{type:"button",onPointerDown:w=>w.stopPropagation(),onClick:w=>{w.stopPropagation(),v(a)},className:"ml-1 px-2 py-1 rounded text-[12px] border bg-white hover:bg-gray-50",title:"weiter",children:"➔"})]})]}),l==="neu"&&!!K.length&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-1.5",children:K.map(w=>e.jsx(rt,{cardId:a.id,vehicle:w,pillWidthPx:p,onUnassign:h,onClone:B,near:!!F&&te&&F.has(String(w.id)),readonly:!V,distKm:N?.get(String(w.id))??null},`ass-${a.id}-${w.id}`))}),l==="in-bearbeitung"&&P&&!!K.length&&e.jsx("div",{ref:y,className:"mt-2 flex flex-wrap gap-1.5",children:K.map(w=>e.jsx(rt,{cardId:a.id,vehicle:w,pillWidthPx:p,onUnassign:h,onClone:B,near:!!F&&te&&F.has(String(w.id)),readonly:!V,distKm:N?.get(String(w.id))??null},`ass-${a.id}-${w.id}`))}),l==="erledigt"&&P&&!!a.everVehicles?.length&&e.jsx("ul",{className:"mt-2 text-sm text-gray-700 list-disc list-inside space-y-1",children:a.everVehicles.map(w=>{const n=c.get(w),i=n?.label||n?.id||"Unbekannt",m=n?.ort?` (${n.ort})`:"";return e.jsxs("li",{children:[i,m]},w)})}),V&&S?.cardId===a.id&&e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("input",{type:"number",className:"w-20 border rounded px-2 py-1 text-sm",value:L,onChange:w=>k(w.target.value),placeholder:"Personen"}),e.jsx("button",{className:"px-2 py-1 text-sm rounded bg-emerald-600 text-white",onClick:()=>D(a),children:"Speichern"}),e.jsx("button",{className:"px-2 py-1 text-sm rounded bg-gray-200",onClick:E,children:"Abbrechen"})]}),e.jsxs("div",{className:"mt-2 flex justify-end gap-2",children:[e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Ort in Karte öffnen",onPointerDown:w=>w.stopPropagation(),onClick:w=>{w.stopPropagation(),f?.(a.ort)},children:"Karte"}),e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Einsatz-Info",onPointerDown:w=>w.stopPropagation(),onClick:w=>{w.stopPropagation(),Y?.(a)},children:"?"})]})]})]})}function Nn({vehicle:s,pillWidthPx:a=160,near:l=!1,distKm:c=null,editable:p=!0}){const h=`veh:${s.id}`,f=p?jt({id:h,data:{type:"vehicle",vehicleId:s.id}}):null,v=f?.attributes??{},C=f?.listeners??{},S=f?.setNodeRef??(()=>{}),L=f?.transform??null,k=f?.isDragging??!1;return e.jsxs("div",{ref:S,style:{width:a,transform:L?`translate3d(${L.x}px, ${L.y}px, 0)`:void 0},...v,...C,className:`relative max-w-full select-none border-2 ${l?"border-emerald-500":"border-red-300"} rounded-2xl bg-white
                 px-2 py-1 shadow-sm cursor-grab active:cursor-grabbing
                 ${k?"opacity-50":""}`,children:[l&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-0.5 rounded-2xl border-2 border-emerald-400/50 animate-ping"}),e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:s.label||s.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate flex justify-between items-center",children:[e.jsxs("span",{children:[s.ort||"—"," · 👥 ",s.mannschaft??0]}),l&&Number.isFinite(Number(c))&&e.jsxs("span",{className:"absolute top-1 right-1 text-[11px] tabular-nums text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded whitespace-nowrap",children:[Number(c)," Km"]})]})]})}const jn="";async function re(s,a,l){const c=await fetch(jn+a,{method:s,headers:{"Content-Type":"application/json"},body:l===void 0?void 0:JSON.stringify(l),cache:"no-store",credentials:"include"});if(!c.ok)throw new Error(`HTTP ${c.status} ${await c.text().catch(()=>c.statusText)}`);return(c.headers.get("content-type")||"").includes("application/json")?c.json():c.text()}async function ae(){return re("GET","/api/board")}async function it(){return re("GET","/api/vehicles")}async function Sn(){try{return await re("GET","/api/types")}catch{return[]}}async function ot(s,a="neu",l=0,c="",p="",h={}){const f={title:s,columnId:a,toIndex:l,ort:c,typ:p};if(h&&typeof h=="object"){const{lat:v,lng:C,latitude:S,longitude:L,...k}=h;Number.isFinite(S)&&(f.latitude=Number(S)),Number.isFinite(L)&&(f.longitude=Number(L)),Number.isFinite(v)&&(f.latitude=Number(v)),Number.isFinite(C)&&(f.longitude=Number(C)),Object.assign(f,k)}return re("POST","/api/cards",f)}async function $e({cardId:s,from:a,to:l,toIndex:c=0}){return re("POST",`/api/cards/${encodeURIComponent(s)}/move`,{from:a,to:l,toIndex:c})}async function Ke(s,a){return re("POST",`/api/cards/${encodeURIComponent(s)}/assign`,{vehicleId:a})}async function lt(s,a){return re("POST",`/api/cards/${encodeURIComponent(s)}/unassign`,{vehicleId:a})}async function kn(s,a){return re("PATCH",`/api/cards/${encodeURIComponent(s)}/personnel`,{manualPersonnel:a})}async function In(){return re("POST","/api/reset",{})}async function Cn(){return re("GET","/api/import/auto-config")}async function ct({enabled:s,intervalSec:a}){return re("POST","/api/import/auto-config",{enabled:s,intervalSec:a})}function En(){return"/api/export/pdf"}async function Pn(s,a){const l=`cardId=${encodeURIComponent(s)}`,p=Number.isFinite(Number(a))&&Number(a)>0?`${l}&radiusKm=${encodeURIComponent(a)}`:l,h=await fetch(`/api/nearby?${p}`,{credentials:"same-origin",cache:"no-store"});if(!h.ok)throw new Error("fetchNearby failed");return h.json()}async function dt(s,a,l,c=null,p="manual"){return re("PATCH",`/api/vehicles/${encodeURIComponent(s)}/position`,{lat:Number(a),lng:Number(l),incidentId:c,source:p})}async function ut(s){return re("DELETE",`/api/vehicles/${encodeURIComponent(s)}/position`)}function An(s,a){const c=(a.lat-s.lat)*Math.PI/180,p=(a.lng-s.lng)*Math.PI/180,h=Math.sin(c/2)**2+Math.cos(s.lat*Math.PI/180)*Math.cos(a.lat*Math.PI/180)*Math.sin(p/2)**2;return 2*6371*Math.asin(Math.sqrt(h))}function mt(s,a,l){const p=l*Math.PI/180,h=s.lat*Math.PI/180,f=s.lng*Math.PI/180,v=a/6371e3,C=Math.asin(Math.sin(h)*Math.cos(v)+Math.cos(h)*Math.sin(v)*Math.cos(p))*180/Math.PI,S=(f+Math.atan2(Math.sin(p)*Math.sin(v)*Math.cos(h),Math.cos(v)-Math.sin(h)*Math.sin(C*Math.PI/180)))*180/Math.PI;return{lat:C,lng:S}}async function ht(s){if(!s||!window.google?.maps?.Geocoder)return null;const a=new window.google.maps.Geocoder;return new Promise(l=>{a.geocode({address:s,region:"AT"},(c,p)=>{p==="OK"&&c?.[0]?.geometry?.location?l({lat:c[0].geometry.location.lat(),lng:c[0].geometry.location.lng(),formatted:c[0].formatted_address||s}):l(null)})})}const Ce=s=>String(s||"").trim().toLowerCase();async function gt(){try{const s=await fetch("/api/vehicles",{cache:"no-store"});return s.ok?s.json():[]}catch{return[]}}async function pt(){try{const s=await fetch("/api/gps",{cache:"no-store"});if(s.ok)return await s.json()}catch(s){console.error("GPS fetch failed:",s)}return[]}function ft(s){const a=s?.typ||s?.type||"—",l=s?.timestamp?new Date(s.timestamp).toLocaleString("de-AT",{hour12:!1}):"—",c=s?.alerted??"—",p=s?.description??"—",h=s?.additionalAddressInfo||s?.ort||"—",f=[];s?.location&&f.push(String(s.location));const v=Number.isFinite(s?.latitude),C=Number.isFinite(s?.longitude);v&&C&&f.push(`(${s.latitude}, ${s.longitude})`);const S=f.length?f.join(" "):"—";return`
    <div style="min-width:280px">
      <div style="font-weight:700;margin-bottom:4px">${s?.content||"Einsatz"}</div>
      <div><b>Typ:</b> ${a}</div>
      <div><b>Alarmzeit:</b> ${l}</div>
      <div><b>Alarmiert:</b> ${c}</div>
      <div><b>Beschreibung:</b> ${p}</div>
      <div><b>Adresse:</b> ${h}</div>
      <div><b>Location:</b> ${S}</div>
    </div>
  `}const ge=44,xt="/vehicle-red.gif",Tn="/vehicle-gray.png",Mn="/vehicle-drive.gif";function $n({context:s,address:a,onClose:l}){const c=a||s?.card?.ort||s?.address||"",p=!!window.google?.maps,h=r.useRef(null),[f,v]=r.useState(!1),[C,S]=r.useState(""),L=r.useMemo(()=>{const k=s?.card;return k&&Number.isFinite(k?.latitude)&&Number.isFinite(k?.longitude)?{lat:Number(k.latitude),lng:Number(k.longitude)}:null},[s]);if(r.useEffect(()=>{if(!p||!s?.card||!h.current)return;let k=!1,D,E;const B=new Map;let W=null;return(async()=>{try{v(!0),S("");let F=L;if(!F){const x=await ht(s.card.ort);if(k)return;x&&(F={lat:x.lat,lng:x.lng})}if(!F){S("Konnte Einsatz-Position nicht bestimmen.");return}D=new window.google.maps.Map(h.current,{center:F,zoom:18,mapTypeId:"roadmap"}),E=new window.google.maps.InfoWindow;const J=(x,z,Q,K,{hover:U=!1}={})=>{const ee={path:"M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z",fillColor:z,fillOpacity:1,strokeColor:"#333",strokeWeight:1,scale:1.2},H=new window.google.maps.Marker({position:x,map:D,title:Q,icon:ee});if(K){const w=()=>{E.setContent(K),E.open(D,H)};U?(H.addListener("mouseover",w),H.addListener("mouseout",()=>E.close())):H.addListener("click",w)}return H};J(F,"#d11a1a",s.card.content||"Einsatz",ft(s.card),{hover:!0});const N=[...s?.board?.columns?.neu?.items||[],...s?.board?.columns?.["in-bearbeitung"]?.items||[]],R=new Map;for(const x of N)if(Number.isFinite(x.latitude)&&Number.isFinite(x.longitude))R.set(x.id,{lat:Number(x.latitude),lng:Number(x.longitude)});else if(x.ort){const z=await ht(x.ort);z&&R.set(x.id,{lat:z.lat,lng:z.lng})}for(const x of N){if(x.id===s.card.id)continue;const z=R.get(x.id);z&&J(z,"#1e63d1",x.content||"Einsatz",ft(x),{hover:!0})}const V=new Map;for(const x of N)for(const z of x.assignedVehicles||[])V.set(String(z),x.id);const P=await pt(),q=new Map(P.filter(x=>Number.isFinite(x?.lat)&&Number.isFinite(x?.lng)&&x?.realname).map(x=>[Ce(x.realname),x])),_=await gt(),y=new Map(_.filter(x=>x&&x.source!=="gps"&&Number.isFinite(x.latitude)&&Number.isFinite(x.longitude)).map(x=>[String(x.id),{lat:Number(x.latitude),lng:Number(x.longitude)}])),te=Object.values(s.vehiclesById||{}),O=10,pe=50,de=new Map,ue=window.google?.maps?.marker?.AdvancedMarkerElement,le=(x,z,Q)=>{if(!x)return Tn;if(!z||!Q||!R.has(Q))return xt;const K=R.get(Q);return An(z,K)>.1?Mn:xt},be=(x,z,Q,K,U,ee)=>{const H=le(z,K,U),w=!K;if(ue){const n=document.createElement("img");n.src=H,n.width=ge,n.height=ge,n.alt=Q||"",n.decoding="async";const i=new ue({map:D,position:x,content:n,title:Q});if(w){try{i.draggable=!0}catch{}i.addListener("dragend",async m=>{const g=m?.latLng||i.position,T=typeof g.lat=="function"?g.lat():g.lat,I=typeof g.lng=="function"?g.lng():g.lng;try{await dt(ee,T,I,U,"manual")}catch($){i.__setPosition(x),console.error("setVehiclePosition failed:",$),alert("Position konnte nicht gespeichert werden.")}})}return i.__setPosition=m=>{i.position=m},i.__setIcon=(m,g,T)=>{n.src=le(m,g,T)},i.__onOver=m=>{n.addEventListener("mouseover",m),n.addEventListener("mouseout",()=>E.close())},i}else{const n=new window.google.maps.Marker({position:x,map:D,title:Q,draggable:w,icon:{url:H,scaledSize:new window.google.maps.Size(ge,ge),anchor:new window.google.maps.Point(ge/2,ge/2)}});return w&&n.addListener("dragend",async i=>{const m=i?.latLng||n.getPosition(),g=typeof m.lat=="function"?m.lat():m.lat,T=typeof m.lng=="function"?m.lng():m.lng;try{await dt(ee,g,T,U,"manual")}catch(I){n.__setPosition(x),console.error("setVehiclePosition failed:",I),alert("Position konnte nicht gespeichert werden.")}}),n.__setPosition=i=>n.setPosition(i),n.__setIcon=(i,m,g)=>n.setIcon({url:le(i,m,g),scaledSize:new window.google.maps.Size(ge,ge),anchor:new window.google.maps.Point(ge/2,ge/2)}),n.__onOver=i=>{n.addListener("mouseover",i),n.addListener("mouseout",()=>E.close())},n}};for(const x of te){const z=String(x.id),Q=Ce(`${x?.label||""} ${x?.ort||""}`),K=q.get(Q),U=V.get(z);if(!U&&!K)continue;let ee=null,H=null;if(K)H={lat:Number(K.lat),lng:Number(K.lng)},ee=H;else if(y.has(z))ee=y.get(z);else if(U&&R.has(U)){const g=R.get(U),I=((de.get(U)||0)+pe)%360;de.set(U,I),ee=mt(g,O,I)}if(!ee)continue;const n=be(ee,!!U,x.label||x.id,H,U,z),i=U&&N.find(g=>g.id===U),m=i?`<br/><i>zugeordnet: ${i.content}</i>`:"";n.__onOver(()=>{const g=x?.ort||"";E.setContent(`<div style="min-width:220px"><b>${x.label||x.id}</b>${g?`<br/>${g}`:""}${m}</div>`);const T=ue?void 0:n;E.open({map:D,anchor:T,position:ee,shouldFocus:!1})}),B.set(z,n)}D.setCenter(F),D.setZoom(18),W=setInterval(async()=>{const x=await pt(),z=await gt(),Q=new Map(z.filter(i=>i&&i.source!=="gps"&&Number.isFinite(i.latitude)&&Number.isFinite(i.longitude)).map(i=>[String(i.id),{lat:Number(i.latitude),lng:Number(i.longitude)}])),K=new Map(x.filter(i=>Number.isFinite(i?.lat)&&Number.isFinite(i?.lng)&&i?.realname).map(i=>[Ce(i.realname),i])),U=new Map;for(const i of[...s?.board?.columns?.neu?.items||[],...s?.board?.columns?.["in-bearbeitung"]?.items||[]])for(const m of i.assignedVehicles||[])U.set(String(m),i.id);const ee=Object.values(s.vehiclesById||{}),H=new Map;for(const i of ee){const m=String(i.id),g=U.get(m),T=Ce(`${i?.label||""} ${i?.ort||""}`);if(g&&!K.get(T)){const I=H.get(g)||[];I.push(m),H.set(g,I)}}for(const[i,m]of H.entries())m.sort();const w=10,n=50;for(const i of ee){const m=String(i.id),g=B.get(m);if(!g)continue;const T=Ce(`${i?.label||""} ${i?.ort||""}`),I=K.get(T),$=U.get(m);if(I)gpsPos={lat:Number(I.lat),lng:Number(I.lng)},g.__setPosition(gpsPos);else if(Q.has(m))g.__setPosition(Q.get(m));else if($&&R.has($)){const ye=((H.get($)||[]).indexOf(m)+1)*n%360,ke=R.get($);g.__setPosition(mt(ke,w,ye))}else{const G=B.get(m);G&&(G.setMap?G.setMap(null):G.map&&(G.map=null),B.delete(m));continue}const Z=!!$;g.__setIcon(Z,gpsPos,$)}},5e3)}catch(F){S(F?.message||"Kartenaufbau fehlgeschlagen.")}finally{v(!1)}})(),()=>{k=!0,W&&clearInterval(W),B.clear()}},[p,s,L]),!p||!s?.card){const k=`https://www.google.com/maps?q=${encodeURIComponent(c)}&output=embed`;return e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:l,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[70vh] p-2",onClick:D=>D.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-semibold text-sm",children:["Karte: ",c]}),e.jsx("button",{className:"px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm",onClick:l,children:"Schließen"})]}),e.jsx("iframe",{title:"maps",className:"w-full h-full rounded-lg border",src:k,loading:"lazy"})]})})}return e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:l,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-5xl h-[75vh] p-2",onClick:k=>k.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-semibold text-sm",children:["Karte: ",s?.card?.content||"Einsatz"," · weitere Einsätze (Neu & In Bearbeitung)"]}),e.jsx("button",{className:"px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm",onClick:l,children:"Schließen"})]}),e.jsx("div",{ref:h,className:"w-full h-full rounded-lg border"}),f&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"px-3 py-1.5 rounded bg-white shadow text-sm",children:"Lade…"})}),!!C&&e.jsx("div",{className:"absolute bottom-3 left-3 px-2 py-1 rounded bg-red-600 text-white text-xs shadow",children:C})]})})}function On({onClose:s,onCreate:a}){const[l,c]=r.useState(""),[p,h]=r.useState(""),[f,v]=r.useState(0),[C,S]=r.useState(!1),[L,k]=r.useState(""),D=async E=>{if(E.preventDefault(),k(""),!l.trim()||!p.trim()){k("Ort und Name sind erforderlich.");return}try{S(!0),await a({ort:l.trim(),label:p.trim(),mannschaft:Number(f)||0}),s()}catch(B){k(B?.message||"Speichern fehlgeschlagen.")}finally{S(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:e.jsxs("form",{onSubmit:D,className:"bg-white rounded-xl shadow-lg p-4 w-[360px] space-y-3",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Einheit anlegen"}),L&&e.jsx("div",{className:"text-sm text-red-600",children:L}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Ort"}),e.jsx("input",{className:"border rounded px-2 py-1 w-full",value:l,onChange:E=>c(E.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Name"}),e.jsx("input",{className:"border rounded px-2 py-1 w-full",value:p,onChange:E=>h(E.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Mannschaft"}),e.jsx("input",{type:"number",min:"0",className:"border rounded px-2 py-1 w-24",value:f,onChange:E=>v(E.target.value)})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:s,className:"px-3 py-1 rounded border",disabled:C,children:"Abbrechen"}),e.jsx("button",{type:"submit",className:"px-3 py-1 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:C,children:C?"Anlegen…":"Anlegen"})]})]})})}let Oe=null;function kt(){const s=document.querySelector('meta[name="google-places-key"]');return(window.GMAPS_API_KEY||s?.content||"").trim()||""}async function Dn(s=kt()){if(window.google?.maps?.places)return!0;if(!s)return!1;if(Oe)return await Oe,!!window.google?.maps?.places;Oe=new Promise((a,l)=>{if(document.getElementById("gmap-places")){const p=()=>{window.google?.maps?.places?a(!0):setTimeout(p,150)};p();return}const c=document.createElement("script");c.id="gmap-places",c.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(s)}&libraries=places&language=de`,c.async=!0,c.defer=!0,c.onload=()=>a(!!window.google?.maps?.places),c.onerror=p=>l(p),document.head.appendChild(c)});try{await Oe}catch{}return!!window.google?.maps?.places}function It({debounceMs:s=300,country:a="at",minLength:l=3}={}){const[c,p]=r.useState(""),[h,f]=r.useState([]),[v,C]=r.useState(!1),[S,L]=r.useState(!1),[k,D]=r.useState(null),E=r.useRef(null),B=r.useRef(null),W=r.useRef(null),Y=r.useRef(null);r.useEffect(()=>{let P=!1;return(async()=>{const q=await Dn(kt());P||!q||!window.google?.maps?.places||(E.current=new google.maps.places.AutocompleteService,B.current=new google.maps.places.PlacesService(document.createElement("div")),W.current=new google.maps.places.AutocompleteSessionToken,P||L(!0))})(),()=>{P=!0}},[]);const F=r.useCallback(()=>{window.google?.maps?.places&&(W.current=new google.maps.places.AutocompleteSessionToken)},[]),J=r.useRef();r.useEffect(()=>{J.current||(J.current=(P,q)=>{let _;return(...y)=>{clearTimeout(_),_=setTimeout(()=>P(...y),q)}})},[]);const N=r.useCallback(async P=>{if(!S||!E.current)return;const q=(P||"").trim();if(!q||q.length<l){f([]);return}C(!0),D(null),E.current.getPlacePredictions({input:q,sessionToken:W.current,componentRestrictions:{country:a},types:["address"]},(_,y)=>{if(C(!1),y!==google.maps.places.PlacesServiceStatus.OK||!_){f([]),y&&y!=="ZERO_RESULTS"&&D(y);return}f(_)})},[a,l,S]),R=r.useMemo(()=>J.current?J.current(N,s):()=>{},[N,s]);r.useEffect(()=>{R(c)},[c,R]);const V=r.useCallback((P,q=["formatted_address","geometry","address_components"])=>new Promise((_,y)=>{if(!S||!B.current){y(new Error("Google Places nicht bereit"));return}B.current.getDetails({placeId:P,fields:q,sessionToken:W.current},(te,O)=>{if(O!==google.maps.places.PlacesServiceStatus.OK||!te)return y(new Error(O||"DETAILS_FAILED"));_(te)})}),[S]);return{ready:S,query:c,setQuery:p,predictions:h,loading:v,error:k,resetSession:F,getDetailsByPlaceId:V,inputElRef:Y}}function Rn({onClose:s,onCreate:a,types:l}){const[c,p]=r.useState(""),[h,f]=r.useState(""),[v,C]=r.useState(!1),S=r.useRef(null),{query:L,setQuery:k,predictions:D,getDetailsByPlaceId:E,resetSession:B,loading:W,error:Y}=It({country:"at",debounceMs:300,minLength:3});r.useEffect(()=>{setTimeout(()=>S.current?.focus(),0)},[]),r.useEffect(()=>{const N=(h||"").replace(/^T\d+\s*,?\s*/i,"").trim();!c.trim()&&N&&p(N)},[h]);const F=async N=>{N?.preventDefault?.();const R=(h||"").replace(/^T\d+\s*,?\s*/i,"").trim(),V=(c||R).trim();if(V){C(!0);try{await a({title:V,ort:(L||"").trim(),typ:(h||"").trim()}),p(""),k(""),f(""),B(),s?.()}finally{C(!1)}}},J=async N=>{try{const V=(await E(N.place_id,["formatted_address","geometry","address_components","place_id"]))?.formatted_address||N.description;k(V)}catch{k(N.description)}finally{B()}};return e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-3",children:e.jsxs("form",{onSubmit:F,className:"bg-white rounded-xl shadow-lg w-[520px] max-w-full p-4 space-y-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Einsatz anlegen"}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs("select",{ref:S,className:"border rounded px-2 py-1",value:h,onChange:N=>f(N.target.value),children:[e.jsx("option",{value:"",children:"— Typ auswählen —"}),l.map(N=>e.jsx("option",{value:N,children:N},N))]}),e.jsx("input",{className:"border rounded px-2 py-1",placeholder:"Titel (wird aus Typ übernommen)",value:c,onChange:N=>p(N.target.value)}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{className:"border rounded px-2 py-1 w-full",placeholder:"Ort (nur Österreich)",autoComplete:"off",value:L,onChange:N=>k(N.target.value)}),W&&e.jsx("div",{className:"absolute z-10 mt-1 text-xs text-gray-500 bg-white border rounded px-2 py-1",children:"Suche…"}),Y&&e.jsxs("div",{className:"absolute z-10 mt-1 text-xs text-red-600 bg-white border rounded px-2 py-1",children:["Fehler: ",String(Y)]}),!!D.length&&e.jsx("ul",{className:"absolute z-10 mt-1 w-full max-h-52 overflow-auto bg-white border rounded shadow",children:D.map(N=>e.jsx("li",{className:"px-2 py-1 hover:bg-gray-100 cursor-pointer text-sm",onClick:()=>J(N),title:N.description,children:N.description},N.place_id))})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:s,className:"px-3 py-1 rounded border",disabled:v,children:"Abbrechen"}),e.jsx("button",{className:"px-3 py-1 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:v,children:v?"Anlegen…":"Anlegen"})]})]})})}function Ln({colId:s,title:a,bg:l,children:c,editable:p=!0}){if(!p)return e.jsxs("section",{className:`${l} rounded-xl shadow p-3 h-full flex flex-col min-h-0`,children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:a}),c]});const{setNodeRef:h,isOver:f}=cn({id:`col:${s}`,data:{type:"column",colId:s}});return e.jsxs("section",{ref:h,className:`${l} rounded-xl shadow p-3 h-full flex flex-col min-h-0 ${f?"outline outline-2 outline-blue-400":""}`,children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:a}),c]})}function _n({open:s,onClose:a,info:l={}}){if(!s)return null;const c=({label:v,value:C})=>e.jsxs("div",{className:"flex items-start gap-3 py-1",children:[e.jsx("div",{className:"w-32 shrink-0 text-gray-600",children:v}),e.jsx("div",{className:"flex-1 font-medium break-words",children:C??"—"})]}),p=l.timestamp?new Date(l.timestamp).toLocaleString("de-AT",{hour12:!1}):"—",h=[];l.location&&h.push(String(l.location)),Number.isFinite(l.latitude)&&Number.isFinite(l.longitude)&&h.push(`(${l.latitude}, ${l.longitude})`);const f=h.length?h.join(" "):void 0;return e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:a}),e.jsxs("div",{className:"relative z-[101] w-[min(92vw,640px)] rounded-xl bg-white shadow-xl p-4 md:p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg md:text-xl font-bold",children:"Einsatz-Info"}),e.jsx("button",{className:"h-8 w-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center",onClick:a,"aria-label":"Schließen",title:"Schließen",children:e.jsx("svg",{viewBox:"0 0 12 12",width:"14",height:"14","aria-hidden":"true",children:e.jsx("path",{d:"M1 1 L11 11 M11 1 L1 11",stroke:"black",strokeWidth:"2",strokeLinecap:"round"})})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(c,{label:"Typ",value:l.type||l.typ}),e.jsx(c,{label:"Alarmzeit",value:p}),e.jsx(c,{label:"Alarmiert",value:l.alerted}),e.jsx(c,{label:"Beschreibung",value:l.description}),e.jsx(c,{label:"Adresse",value:l.additionalAddressInfo||l.ort}),e.jsx(c,{label:"Location",value:f})]}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx("button",{className:"px-3 py-1.5 rounded-md bg-emerald-600 text-white hover:bg-emerald-700",onClick:a,children:"OK"})})]})]})}let Je=localStorage.getItem("soundEnabled")==="1",oe=null;const bt=window.AudioContext||window.webkitAudioContext,Ue=bt?new bt:null;function Ct(){oe||(oe=new Audio("/sounds/bahnhof.mp3"),oe.preload="auto");const s=async()=>{try{Ue&&Ue.state!=="running"&&await Ue.resume(),oe&&(oe.muted=!0,await oe.play(),oe.pause(),oe.currentTime=0,oe.muted=!1),Je=!0,localStorage.setItem("soundEnabled","1"),window.removeEventListener("pointerdown",s),window.removeEventListener("keydown",s),window.dispatchEvent(new CustomEvent("sound:unlocked"))}catch{}};Je||(window.addEventListener("pointerdown",s,{once:!0}),window.addEventListener("keydown",s,{once:!0}))}async function zn(){if(oe||Ct(),!Je){window.dispatchEvent(new CustomEvent("sound:needsUnlock"));return}try{oe.currentTime=0,await oe.play()}catch{}}function Fn(s){const a=(s??"").toString();return a.length>30?a.slice(0,30)+"…":a}function Bn(){const[s,a]=r.useState([]),[l,c]=r.useState(!0);r.useEffect(()=>{(async()=>{try{const h=await fetch("/api/protocol").then(f=>f.json());a(Array.isArray(h?.items)?h.items:[])}catch{a([])}finally{c(!1)}})()},[]);const p=r.useMemo(()=>[...s].sort((h,f)=>(Number(f.nr)||0)-(Number(h.nr)||0)),[s]);return e.jsxs("div",{className:"p-3 md:p-4 max-w-[1400px] mx-auto h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-3",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:"Protokoll-Übersicht"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("a",{href:"/api/protocol/csv/file",className:"px-3 py-1.5 rounded-md border bg-white",title:"protocol.csv herunterladen",children:"CSV"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll/neu"},className:"px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white",children:"+ Eintrag anlegen"})]})]}),e.jsx("div",{className:"flex-1 overflow-auto border rounded-lg bg-white",children:l?e.jsx("div",{className:"p-4 text-gray-500",children:"Lade…"}):e.jsxs("table",{className:"min-w-[1100px] w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0 z-10",children:e.jsxs("tr",{className:"[&>th]:px-2 [&>th]:py-2 [&>th]:text-left [&>th]:font-semibold border-b",children:[e.jsx("th",{style:{width:28},title:"Druckstatus"}),e.jsx("th",{style:{width:60},children:"NR"}),e.jsx("th",{style:{width:110},children:"Datum"}),e.jsx("th",{style:{width:80},children:"Zeit"}),e.jsx("th",{style:{width:120},children:"Kanal"}),e.jsx("th",{style:{width:110},children:"Richtung"}),e.jsx("th",{style:{width:160},children:"An/Von"}),e.jsx("th",{children:"Information"}),e.jsx("th",{style:{width:260},children:"Meldungstyp"})]})}),e.jsxs("tbody",{className:"[&>tr>td]:px-2 [&>tr>td]:py-2",children:[p.map(h=>{const f=h?.uebermittlungsart||{},v=f.kanal??f.kanalNr??f.art??"",S=[].concat(f.ein?"Eingang":[]).concat(f.aus?"Ausgang":[]).join(" / "),L=Number(h?.printCount)>0;return e.jsxs("tr",{className:"border-b align-top hover:bg-gray-50 cursor-pointer",onClick:()=>{window.location.hash=`/protokoll/edit/${h.nr}`},title:"Zum Bearbeiten öffnen",children:[e.jsx("td",{className:"align-middle",children:L?e.jsx("span",{className:"inline-block w-3 h-3 rounded-full bg-yellow-400",title:`Gedruckt (${h.printCount})`}):null}),e.jsx("td",{className:"font-semibold",children:h.nr}),e.jsx("td",{children:h.datum}),e.jsx("td",{children:h.zeit}),e.jsx("td",{title:v,children:v}),e.jsx("td",{title:S,children:S}),e.jsx("td",{children:h.anvon}),e.jsx("td",{className:"whitespace-pre-wrap",children:Fn(h.information)}),e.jsx("td",{className:"whitespace-pre-wrap",children:h.infoTyp||"—"})]},h.nr)}),!p.length&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"p-4 text-gray-500 italic",children:"— keine Einträge —"})})]})]})})]})}const Ge=["EL","LtStb","S1","S2","S3","S4","S5","S6"];St("protokoll");const fe={anvon:"prot_sugg_anvon",kanal:"prot_sugg_kanalNr",verantwortlich:"prot_sugg_ver"};function We(s,a=12){const l=new Set,c=[];for(const p of s){const h=String(p||"").trim();if(!(!h||l.has(h))&&(l.add(h),c.push(h),c.length>=a))break}return c}function yt(s){let a=String(s||"").trim();if(!a)return a;const l=a.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})$/);if(l){const p=l[1].padStart(2,"0"),h=l[2].padStart(2,"0");return`${l[3].length===2?"20"+l[3]:l[3]}-${h}-${p}`}const c=a.match(/^(\d{1,2})(\d{1,2})(\d{2,4})$/);if(c){const p=c[1].padStart(2,"0"),h=c[2].padStart(2,"0");return`${c[3].length===2?"20"+c[3]:c[3].padStart(4,"20")}-${h}-${p}`}return a}function wt(s){let a=String(s||"").trim();if(!a)return a;const l=a.match(/^(\d{1,2})(\d{2})$/);if(l)return`${l[1].padStart(2,"0")}:${l[2]}`;const c=a.match(/^(\d{1,2})[:.](\d{1,2})$/);return c?`${c[1].padStart(2,"0")}:${c[2].padStart(2,"0")}`:a}const vt=()=>({datum:new Date().toISOString().slice(0,10),zeit:new Date().toTimeString().slice(0,5),uebermittlungsart:{richtung:"",kanalNr:""},anvon:{richtung:"an",name:""},infoTyp:"Information",information:"",rueckmeldung1:"",rueckmeldung2:"",ergehtAn:[],ergehtAnText:"",lagebericht:"",massnahmen:Array.from({length:5},()=>({massnahme:"",verantwortlich:"",done:!1}))});function Nt({mode:s="create",editNr:a=null}){const[l,c]=r.useState(()=>{const n=Number(a);return Number.isFinite(n)&&n>0?n:null}),p=Number.isFinite(Number(l))&&Number(l)>0,[h,f]=r.useState(p),[v,C]=r.useState(!1),[S,L]=r.useState(null),k=r.useRef(null),D=r.useRef(null),E=r.useRef(!1),B=r.useRef(null),[W,Y]=r.useState(null),F=r.useRef(null),J=(n,i,m=2200)=>{Y({type:n,text:i}),F.current&&clearTimeout(F.current),F.current=setTimeout(()=>Y(null),m)},[N,R]=r.useState([]),[V,P]=r.useState([]),[q,_]=r.useState([]);r.useEffect(()=>{try{R(JSON.parse(localStorage.getItem(fe.anvon)||"[]")),P(JSON.parse(localStorage.getItem(fe.kanal)||"[]")),_(JSON.parse(localStorage.getItem(fe.verantwortlich)||"[]"))}catch{}},[]);const[y,te]=r.useState(vt()),O=(n,i)=>{const m=Array.isArray(n)?n:String(n).split(".");te(g=>{const T=structuredClone(g);let I=T;for(let $=0;$<m.length-1;$++)I=I[m[$]];return I[m.at(-1)]=i,T})};r.useEffect(()=>{if(!p){f(!1),setTimeout(()=>D.current?.focus(),0);return}const n=Number(l);!Number.isFinite(n)||n<=0||(async()=>{try{const i=await fetch(`/api/protocol/${n}`).then(m=>m.json());if(i?.ok&&i.item){const m=i.item,g=m.uebermittlungsart||{};let T="",I=m.anvon||"";const $=(m.anvon||"").trim();/^an\s*:/i.test($)&&(T="an",I=$.replace(/^an\s*:/i,"").trim()),/^von\s*:/i.test($)&&(T="von",I=$.replace(/^von\s*:/i,"").trim()),te({datum:m.datum||"",zeit:m.zeit||"",uebermittlungsart:{richtung:g.ein?"ein":g.aus?"aus":"",kanalNr:g.kanalNr||""},anvon:{richtung:T||"an",name:I},infoTyp:m.infoTyp||"Information",information:m.information||"",rueckmeldung1:m.rueckmeldung1||"",rueckmeldung2:m.rueckmeldung2||"",ergehtAn:Array.isArray(m.ergehtAn)?m.ergehtAn:[],ergehtAnText:m.ergehtAnText||"",lagebericht:m.lagebericht||"",massnahmen:Array.from({length:5},(Z,G)=>{const se=m.massnahmen?.[G]||{};return{massnahme:se.massnahme||"",verantwortlich:se.verantwortlich||"",done:!!se.done}})}),L(m.id||null),setTimeout(()=>D.current?.focus(),0)}}finally{f(!1)}})()},[p,l]),r.useEffect(()=>{const n=()=>{const g=document.activeElement;g&&typeof g.blur=="function"&&g.blur()},i=g=>setTimeout(g,0),m=g=>{if(g.repeat)return;const T=(g.key||"").toLowerCase(),I=g.ctrlKey||g.metaKey;if(I&&!g.shiftKey&&T==="s"){if(g.preventDefault(),g.stopPropagation(),E.current)return;E.current=!0,i(async()=>{n(),await new Promise($=>setTimeout($,0)),Q().finally(()=>E.current=!1)});return}if(I&&(g.shiftKey&&T==="s"||T==="enter")){if(g.preventDefault(),g.stopPropagation(),E.current)return;E.current=!0,i(async()=>{n(),await new Promise($=>setTimeout($,0)),K().finally(()=>E.current=!1)});return}T==="escape"&&(g.preventDefault(),g.stopPropagation(),i(()=>x()))};return window.addEventListener("keydown",m,!0),document.addEventListener("keydown",m,!0),()=>{window.removeEventListener("keydown",m,!0),document.removeEventListener("keydown",m,!0)}},[]);const[pe,de]=r.useState(!1),ue=r.useRef(null);function le(){const n=Array.isArray(y?.ergehtAn)?[...y.ergehtAn]:[],i=(y?.ergehtAnText||"").trim();return i&&n.push(i),n}const be=async()=>{if(pe)return;const n=le();if(!n.length){J?.("error","Bitte Empfänger wählen oder 'Sonstiger Empfänger' ausfüllen.");return}de(!0);try{const i=await z();if(!i)throw new Error("Speichern fehlgeschlagen");c(i);const g=(await fetch(`/api/protocol/${i}`).then(G=>G.json()))?.item;if(!g)throw new Error("Datensatz für Druck nicht gefunden");J?.("info","PDF wird serverseitig erzeugt …");const T=await fetch(`/api/protocol/${i}/print`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({recipients:n,data:g})}).then(G=>G.json());if(!T?.ok||!T?.fileUrl)throw new Error(T?.error||"PDF-Erzeugung fehlgeschlagen");let I=ue.current;I||(I=document.createElement("iframe"),I.style.position="fixed",I.style.width="0",I.style.height="0",I.style.border="0",I.style.visibility="hidden",document.body.appendChild(I),ue.current=I);const $=`${T.fileUrl}#toolbar=0&navpanes=0&scrollbar=0`;I.onload=()=>{try{setTimeout(()=>{I.contentWindow?.focus(),I.contentWindow?.print()},100)}catch{window.open($,"_blank","noopener,noreferrer")?.focus()}},I.src=$;const Z=Number(T?.pages)||n.length;J?.("success",`Druck gestartet (${Z} Seite${Z>1?"n":""})`)}catch(i){J?.("error",`Drucken fehlgeschlagen: ${i.message||i}`)}finally{de(!1)}},x=()=>{window.location.hash="/protokoll"},z=async()=>{const n=B.current?new FormData(B.current):null,i=structuredClone(y);i.datum=yt(n?.get("datum")||y.datum),i.zeit=wt(n?.get("zeit")||y.zeit);const m=(n?.get("anvonDir")||y.anvon.richtung||"").toString(),g=(n?.get("anvonName")||y.anvon.name||"").toString();i.anvon={richtung:m,name:g};const T=(n?.get("richtung")||y.uebermittlungsart.richtung||"").toString();i.uebermittlungsart.richtung=T,i.uebermittlungsart.kanalNr=(n?.get("kanalNr")||y.uebermittlungsart.kanalNr||"").toString(),i.information=(n?.get("information")||y.information||"").toString(),i.rueckmeldung1=(n?.get("rueckmeldung1")||y.rueckmeldung1||"").toString(),i.rueckmeldung2=(n?.get("rueckmeldung2")||y.rueckmeldung2||"").toString(),i.ergehtAnText=(n?.get("ergehtAnText")||y.ergehtAnText||"").toString(),i.infoTyp=(n?.get("infoTyp")||y.infoTyp||"Information").toString();const I=n?Array.from(n.getAll("ergehtAn")).map(String):y.ergehtAn;i.ergehtAn=I.length?I:y.ergehtAn,i.massnahmen=i.massnahmen.map((Z,G)=>{const se=n?n.get(`m_done_${G}`)!==null:Z.done;return{massnahme:(n?.get(`m_massnahme_${G}`)||Z.massnahme||"").toString(),verantwortlich:(n?.get(`m_verantwortlich_${G}`)||Z.verantwortlich||"").toString(),done:!!se}});const $={...i,uebermittlungsart:{kanalNr:(i.uebermittlungsart.kanalNr||"").trim(),ein:i.uebermittlungsart.richtung==="ein",aus:i.uebermittlungsart.richtung==="aus"},anvon:i.anvon.richtung?`${i.anvon.richtung==="an"?"An":"Von"}: ${i.anvon.name}`.trim():i.anvon.name.trim()};try{const Z=We([$.anvon,...JSON.parse(localStorage.getItem(fe.anvon)||"[]")]),G=We([$.uebermittlungsart.kanalNr,...JSON.parse(localStorage.getItem(fe.kanal)||"[]")]),se=[...i.massnahmen.map(ke=>ke.verantwortlich).filter(Boolean),...JSON.parse(localStorage.getItem(fe.verantwortlich)||"[]")],ye=We(se);localStorage.setItem(fe.anvon,JSON.stringify(Z)),localStorage.setItem(fe.kanal,JSON.stringify(G)),localStorage.setItem(fe.verantwortlich,JSON.stringify(ye)),R(Z),P(G),_(ye)}catch{}if(p){const Z=await fetch(`/api/protocol/${l}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify($)}).then(G=>G.json());if(!Z?.ok)throw new Error(Z?.error||"Speichern fehlgeschlagen");return c(Z.nr),L(Z.id||S||null),Z.nr}else{const Z=await fetch("/api/protocol",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify($)}).then(G=>G.json());if(!Z?.ok)throw new Error(Z?.error||"Speichern fehlgeschlagen");return c(Z.nr),L(Z.id||null),Z.nr}},Q=async()=>{if(!v){C(!0);try{await z()&&(window.location.hash="/protokoll")}catch(n){J("error","Fehler beim Speichern: "+n.message,4e3)}finally{C(!1)}}},K=async()=>{if(!v){C(!0);try{const n=await z();n&&(J("success",`Gespeichert (NR ${n}) – neuer Eintrag`),te(vt()),c(null),L(null),setTimeout(()=>D.current?.focus(),0))}catch(n){J("error","Fehler beim Speichern: "+n.message,4e3)}finally{C(!1)}}},U=n=>{const i=(n.key||"").toLowerCase(),m=n.ctrlKey||n.metaKey;n.repeat||(m&&!n.shiftKey&&i==="s"?(n.preventDefault(),n.stopPropagation(),Q()):m&&(n.shiftKey&&i==="s"||i==="enter")&&(n.preventDefault(),n.stopPropagation(),K()))},ee=n=>{n.preventDefault(),Q()};if(h)return e.jsx("div",{className:"p-4",children:"Lade…"});const H=Ge.every(n=>y.ergehtAn.includes(n)),w=n=>O("ergehtAn",n?[...Ge]:[]);return e.jsxs("div",{className:"mx-auto w-full max-w-[1100px] relative",children:[e.jsx("div",{className:"prot-actionbar sticky top-0 z-30 -mx-2 md:mx-0 px-2 md:px-0",children:e.jsxs("div",{className:"bg-white/95 backdrop-blur border-b rounded-t-xl px-3 py-2 flex items-center justify-between shadow-sm",children:[e.jsx("div",{className:"text-sm font-semibold",children:p?`Protokoll – Bearbeiten (NR ${l??"—"})`:"Protokoll – Neuer Eintrag"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:x,className:"px-3 py-1.5 rounded-md border",title:"Maske schließen und zur Übersicht wechseln (ESC)",children:"Abbrechen"}),e.jsx("button",{type:"button",onClick:K,disabled:v,className:"px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white disabled:opacity-60",title:"Speichern und neue Maske (Strg+Shift+S oder Strg+Enter)",children:"Speichern/Neu"}),e.jsx("button",{type:"button",onClick:Q,disabled:v,className:"px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-60",title:"Speichern und schließen (Strg+S)",children:v?"Speichern…":"Speichern"}),e.jsx("button",{type:"button",onClick:be,disabled:pe,className:"px-3 py-1.5 rounded-md border bg-white hover:bg-gray-50 disabled:opacity-60",title:"Formular drucken – Anzahl gemäß 'ergeht an' + 'Sonstiger Empfänger'",children:pe?"Drucken…":"Drucken"})]})]})}),W&&e.jsx("div",{className:"fixed right-3 top-3 z-40",children:e.jsx("div",{className:"px-3 py-2 rounded shadow text-white "+(W.type==="success"?"bg-emerald-600":W.type==="error"?"bg-rose-600":"bg-slate-600"),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{children:W.text}),e.jsx("button",{className:"opacity-80 hover:opacity-100",onClick:()=>Y(null),title:"Meldung schließen",children:"✕"})]})})}),e.jsx("style",{children:`
        @media print {
          * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          .prot-actionbar { display: none !important; }
          html, body { margin: 0 !important; }
          @page { size: A4; margin: 12mm; }
        }
      `}),e.jsxs("form",{ref:B,onKeyDown:U,onSubmit:ee,className:"bg-white border-2 rounded-b-xl overflow-hidden shadow",children:[e.jsxs("div",{className:"grid grid-cols-12",children:[e.jsx("div",{className:"col-span-9 p-6 border-b-2",children:e.jsx("div",{className:"text-3xl font-extrabold tracking-wide",children:"MELDUNG/INFORMATION"})}),e.jsxs("div",{className:"col-span-3 border-l-2",children:[e.jsx("div",{className:"p-3 text-xs text-gray-600 border-b-2",children:"PROTOKOLL-NR"}),e.jsx("div",{className:"p-6 text-center text-4xl font-bold",children:l??"—"})]}),e.jsx("div",{className:"col-span-12 border-y-2 p-2",children:e.jsxs("div",{className:"grid grid-cols-12 gap-0",children:[e.jsxs("div",{className:"col-span-6 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Datum"}),e.jsx("input",{name:"datum",type:"text",className:"border rounded px-2 h-9 w-full",placeholder:"yyyy-mm-dd",value:y.datum,onChange:n=>O("datum",n.target.value),onBlur:n=>O("datum",yt(n.target.value)),title:"Datum (auch 101025 oder 10.10.2025 möglich)"})]}),e.jsxs("div",{className:"col-span-3 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Uhrzeit"}),e.jsx("input",{name:"zeit",type:"text",className:"border rounded px-2 h-9 w-full",placeholder:"hh:mm",value:y.zeit,onChange:n=>O("zeit",n.target.value),onBlur:n=>O("zeit",wt(n.target.value)),title:"Uhrzeit (915, 09:15 oder 0915 möglich)"})]}),e.jsxs("div",{className:"col-span-3 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Typ"}),e.jsxs("div",{className:"grid grid-cols-3 gap-x-6 h-9 items-center",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{ref:D,type:"radio",name:"infoTyp",value:"Information",checked:y.infoTyp==="Information",onChange:()=>O("infoTyp","Information")}),e.jsx("span",{children:"Info"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"infoTyp",value:"Auftrag",checked:y.infoTyp==="Auftrag",onChange:()=>O("infoTyp","Auftrag")}),e.jsx("span",{children:"Auftrag"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"infoTyp",value:"Lagemeldung",checked:y.infoTyp==="Lagemeldung",onChange:()=>O("infoTyp","Lagemeldung")}),e.jsx("span",{children:"Lage"})]})]})]})]})}),e.jsx("div",{className:"col-span-12 border-y-2 p-2",children:e.jsxs("div",{className:"grid grid-cols-12 gap-0 items-end",children:[e.jsxs("div",{className:"col-span-6 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"An/Von"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{ref:k,name:"anvonName",className:"border rounded px-2 h-9 w-full flex-1",placeholder:"Name / Stelle",list:"dl-anvon",value:y.anvon.name,onChange:n=>{let i=n.target.value;const m=i.trim();/^an\s*:/i.test(m)?(O(["anvon","richtung"],"an"),i=m.replace(/^an\s*:/i,"").trim()):/^von\s*:/i.test(m)&&(O(["anvon","richtung"],"von"),i=m.replace(/^von\s*:/i,"").trim()),O(["anvon","name"],i)},title:'Optional mit Präfix "an: …" oder "von: …"'}),e.jsxs("div",{className:"flex items-center gap-4 pl-2 min-w-[140px] shrink-0",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"anvonDir",value:"an",checked:y.anvon.richtung==="an",onChange:()=>O(["anvon","richtung"],"an")}),e.jsx("span",{children:"An"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"anvonDir",value:"von",checked:y.anvon.richtung==="von",onChange:()=>O(["anvon","richtung"],"von")}),e.jsx("span",{children:"Von"})]})]})]}),e.jsx("datalist",{id:"dl-anvon",children:N.map(n=>e.jsx("option",{value:n},n))})]}),e.jsxs("div",{className:"col-span-3 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Kanal"}),e.jsx("input",{name:"kanalNr",className:"border rounded px-2 h-9 w-full",list:"dl-kanal",value:y.uebermittlungsart.kanalNr,onChange:n=>O(["uebermittlungsart","kanalNr"],n.target.value),title:"z. B. Funkkanal, Telefonnummer, E-Mail-Kürzel …"}),e.jsx("datalist",{id:"dl-kanal",children:V.map(n=>e.jsx("option",{value:n},n))})]}),e.jsxs("div",{className:"col-span-3 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Richtung"}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-6 h-9 items-center",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",title:"Meldung wurde empfangen",children:[e.jsx("input",{type:"radio",name:"richtung",value:"ein",checked:y.uebermittlungsart.richtung==="ein",onChange:()=>O(["uebermittlungsart","richtung"],"ein")}),e.jsx("span",{children:"Eingang"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",title:"Meldung wurde gesendet",children:[e.jsx("input",{type:"radio",name:"richtung",value:"aus",checked:y.uebermittlungsart.richtung==="aus",onChange:()=>O(["uebermittlungsart","richtung"],"aus")}),e.jsx("span",{children:"Ausgang"})]})]})]})]})}),e.jsxs("div",{className:"col-span-12 border-y-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Information/Auftrag"}),e.jsx("textarea",{name:"information",className:"border rounded px-2 py-2 w-full min-h-[160px]",value:y.information,onChange:n=>O("information",n.target.value),title:"Sachverhalt / Meldetext"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Rückmeldung 1"}),e.jsx("input",{name:"rueckmeldung1",className:"border rounded px-2 h-9 w-full",value:y.rueckmeldung1,onChange:n=>O("rueckmeldung1",n.target.value),title:"erste Rückmeldung"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Rückmeldung 2"}),e.jsx("input",{name:"rueckmeldung2",className:"border rounded px-2 h-9 w-full",value:y.rueckmeldung2,onChange:n=>O("rueckmeldung2",n.target.value),title:"zweite Rückmeldung"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-2",children:"ergeht an:"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 mr-3",title:"Alle Empfänger auswählen / abwählen",children:[e.jsx("input",{type:"checkbox",checked:H,onChange:n=>w(n.target.checked)}),e.jsx("span",{children:"Alle"})]}),Ge.map(n=>e.jsxs("label",{className:"inline-flex items-center gap-2 mr-3",children:[e.jsx("input",{tabIndex:-1,type:"checkbox",name:"ergehtAn",value:n,checked:y.ergehtAn.includes(n),onChange:()=>{const i=new Set(y.ergehtAn);i.has(n)?i.delete(n):i.add(n),O("ergehtAn",[...i])},title:`Empfänger ${n} ${y.ergehtAn.includes(n)?"entfernen":"hinzufügen"}`}),e.jsx("span",{children:n})]},n)),e.jsx("span",{className:"ml-2 text-xs text-gray-600",children:"sonstiger Empfänger:"}),e.jsx("input",{name:"ergehtAnText",className:"border rounded px-2 h-9",value:y.ergehtAnText,onChange:n=>O("ergehtAnText",n.target.value),placeholder:"Name/Gruppe"})]})]}),e.jsxs("div",{className:"col-span-12 border-t-2",children:[e.jsxs("div",{className:"grid grid-cols-12 bg-gray-50 border-b-2",children:[e.jsx("div",{className:"col-span-6 p-2 font-semibold border-r",children:"Maßnahme"}),e.jsx("div",{className:"col-span-5 p-2 font-semibold border-r",children:"Verantwortlich"}),e.jsx("div",{className:"col-span-1 p-2 font-semibold text-center",children:"Erledigt"})]}),y.massnahmen.map((n,i)=>e.jsxs("div",{className:"grid grid-cols-12 border-t",children:[e.jsx("div",{className:"col-span-6 p-2 border-r",children:e.jsx("input",{name:`m_massnahme_${i}`,className:"w-full border rounded px-2 h-9",value:n.massnahme,onChange:m=>{const g=[...y.massnahmen];g[i]={...n,massnahme:m.target.value},O("massnahmen",g)},title:`Maßnahme ${i+1}`})}),e.jsx("div",{className:"col-span-5 p-2 border-r",children:e.jsx("input",{name:`m_verantwortlich_${i}`,className:"w-full border rounded px-2 h-9",list:"dl-ver",value:n.verantwortlich,onChange:m=>{const g=[...y.massnahmen];g[i]={...n,verantwortlich:m.target.value},O("massnahmen",g)},title:`Verantwortlich ${i+1}`})}),e.jsx("div",{className:"col-span-1 p-2 flex items-center justify-center",children:e.jsx("input",{tabIndex:-1,type:"checkbox",name:`m_done_${i}`,value:"1",checked:!!n.done,onChange:m=>{const g=[...y.massnahmen];g[i]={...n,done:m.target.checked},O("massnahmen",g)},title:"Erledigt umschalten"})})]},i)),e.jsx("datalist",{id:"dl-ver",children:q.map(n=>e.jsx("option",{value:n},n))})]})]}),e.jsx("button",{type:"submit",className:"hidden",children:"submit"})]})]})}function Vn({disabled:s=!1}){const[a,l]=r.useState(!1),[c,p]=r.useState(!1),[h,f]=r.useState(""),[v,C]=r.useState({remainingMin:null,idleMinutes:null,lastActivityIso:null,autoStopMin:null}),[S,L]=r.useState({lastLoadedIso:null,file:"list_filtered.json"}),[k,D]=r.useState(!1),[E,B]=r.useState(30),[W,Y]=r.useState(null),F=r.useRef(!1),J=async()=>{try{const[N,R,V]=await Promise.all([fetch("/api/ff/status",{credentials:"include",cache:"no-store"}).then(P=>P.json()).catch(()=>({running:!1})),fetch("/api/ff/creds",{credentials:"include",cache:"no-store"}).then(P=>P.json()).catch(()=>({has:!1})),fetch("/api/import/auto-config",{credentials:"include",cache:"no-store"}).then(P=>P.json()).catch(()=>({enabled:!1,intervalSec:30}))]);l(!!N.running),p(!!R.has),D(!!V.enabled),B(Number(V.intervalSec||30)),F.current||(F.current=!0,R.has||f("Keine globalen Fetcher-Zugangsdaten. Bitte als Admin unter /user-admin setzen."))}catch{}};return r.useEffect(()=>{J();const N=setInterval(J,3e3);return()=>clearInterval(N)},[]),r.useEffect(()=>{let N;const R=async()=>{try{const V=await fetch("/api/activity/status",{credentials:"include",cache:"no-store"});if(V.ok){const P=await V.json(),q=Number(P.idleMinutes),_=Number(P.autoStopMin),y=Math.max(0,Math.ceil(_-q));C({remainingMin:y,idleMinutes:q,lastActivityIso:P.lastActivityIso,autoStopMin:_}),l(!!P.fetcher?.running),L({lastLoadedIso:P.import?.lastLoadedIso??null,file:P.import?.file||"list_filtered.json"})}}catch{}};return R(),N=setInterval(R,1e3),()=>clearInterval(N)},[]),r.useEffect(()=>{let N;const R=()=>{if(!k||!S.lastLoadedIso){Y(null);return}const P=new Date(S.lastLoadedIso).getTime()+E*1e3,q=Math.max(0,Math.ceil((P-Date.now())/1e3));Y(q)};return R(),N=setInterval(R,1e3),()=>clearInterval(N)},[k,E,S.lastLoadedIso]),e.jsxs("div",{className:`flex items-center h-9 gap-2 ${s?"opacity-60 pointer-events-none":""}`,style:{alignItems:"center"},children:[e.jsx("span",{className:`sync-chip ${k?"active":""}`,title:k?"Auto-Import Countdown":"Auto-Import ist deaktiviert",style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:"110px",minWidth:"110px",textAlign:"center"},children:k?`⟳ in ${W??"–"}s`:"⏸ manuell"}),h&&e.jsx("span",{style:{color:"#dc2626",fontSize:12,marginLeft:8},children:h}),a&&v.remainingMin!=null&&v.remainingMin<=15&&e.jsxs("div",{title:`Letzte Aktivität: ${v.lastActivityIso?new Date(v.lastActivityIso).toLocaleString():"–"} • Inaktiv: ${v.idleMinutes?.toFixed?.(1)} min • Limit: ${v.autoStopMin} min`,className:"ml-2 inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border "+(v.remainingMin<=5?"bg-red-50 text-red-700 border-red-300":v.remainingMin<=15?"bg-amber-50 text-amber-700 border-amber-300":"bg-blue-50 text-blue-700 border-blue-300"),children:[e.jsx("span",{className:"mr-2 h-2 w-2 rounded-full bg-current",style:{animation:"pulse 1.5s ease-in-out infinite"}}),e.jsxs("span",{children:["Auto-Import stoppt in ",e.jsxs("b",{children:[v.remainingMin," min"]})]})]}),e.jsx("div",{title:`Quelle: ${S.file}`,className:"ml-2 inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border bg-white text-gray-700",style:{borderColor:"#cbd5e1"},children:e.jsxs("span",{children:["Zuletzt geladen:"," ",e.jsx("b",{children:S.lastLoadedIso?new Date(S.lastLoadedIso).toLocaleTimeString("de-AT",{hour12:!1}):"–"})]})})]})}function Kn(){const[s]=r.useState(.9);return s}const Un=s=>`card:${s}`,ve=!0;async function Gn(s){if(!s||!window.google?.maps?.Geocoder)return null;const a=new google.maps.Geocoder;return new Promise(l=>{a.geocode({address:s,region:"AT"},(c,p)=>{if(p==="OK"&&c&&c[0]){const h=c[0],f=h.geometry?.location;l({lat:f?.lat?.(),lng:f?.lng?.(),formatted:h.formatted_address||s})}else l(null)})})}function Jn(){Kn(),r.useEffect(()=>{dn()},[]);const s=St("einsatzboard"),a=un("einsatzboard"),[l,c]=r.useState(null),[p,h]=r.useState([]),[f,v]=r.useState([]),[C,S]=r.useState(""),[L,k]=r.useState(""),[D,E]=r.useState(""),[B,W]=r.useState(null),[Y,F]=r.useState(null),[J,N]=r.useState(""),[R,V]=r.useState(!1),[P,q]=r.useState(!1),[_,y]=r.useState(!1),[te,O]=r.useState(30),[pe,de]=r.useState(!1),[ue,le]=r.useState(!1),[be,x]=r.useState(!1),[z,Q]=r.useState(null),K=t=>{Q(t),x(!0)},[U,ee]=r.useState(window.location.hash);r.useEffect(()=>{const t=()=>ee(window.location.hash);return window.addEventListener("hashchange",t),()=>window.removeEventListener("hashchange",t)},[]);const H=U.replace(/^#/,""),[w,n]=r.useState(()=>new Set),[i,m]=r.useState(0),g=r.useRef(0),T=r.useRef(new Set),[I,$]=r.useState(0);r.useEffect(()=>{document.title="Einsatzstellen-Übersicht-Feuerwehr",Ct()},[]),r.useEffect(()=>{if(!s)return;if(!_){$(0);return}const t=setInterval(()=>$(o=>o+1),1e3);return()=>clearInterval(t)},[ve,_]);const Z=_?Math.max(0,te-I%Math.max(1,te)):0,{query:G,setQuery:se,predictions:ye,getDetailsByPlaceId:ke,resetSession:Ee,loading:Et,error:He}=It({country:"at",debounceMs:300,minLength:3}),Pe=r.useRef(null);r.useEffect(()=>{document.title="Einsatzstellen-Übersicht-Feuerwehr"},[]),r.useEffect(()=>{(async()=>{const[t,o,d]=await Promise.all([ae(),it(),Sn()]);c(t),h(o),v(Array.isArray(d)?d:[]);try{const u=await Cn();y(!!u.enabled),O(Number(u.intervalSec)||30),Ae.current=qe(t)}catch{}$(0)})()},[ve]),r.useEffect(()=>{_&&(async()=>{try{(await fetch("/api/ff/status",{credentials:"include",cache:"no-store"}).then(o=>o.json()).catch(()=>({running:!1}))).running||await fetch("/api/ff/start",{method:"POST",credentials:"include"})}catch{}})()},[ve,_,te]),r.useEffect(()=>{k(G||"")},[G]),r.useEffect(()=>{let t;const o=Math.max(5,Math.min(60,_?8:15)),d=async()=>{try{const u=new Set(Ae.current),b=await ae();c(b),Qe({oldIds:u,newBoard:b,pulseMs:8e3})}catch{}t=setTimeout(d,o*1e3)};return t=setTimeout(d,o*1e3),()=>clearTimeout(t)},[ve,_]),r.useEffect(()=>{const t=o=>{o.altKey&&(o.key==="e"||o.key==="E")&&(o.preventDefault(),le(!0),Ee())};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[ve,Ee]);const ie=l??{columns:{neu:{items:[]},"in-bearbeitung":{items:[]},erledigt:{items:[]}}},Pt=10;function At(t){try{const o=t?.columns||{};return[(o.neu?.items||[]).length,(o["in-bearbeitung"]?.items||[]).length,(o.erledigt?.items||[]).length].some(u=>u>=Pt)}catch{return!1}}r.useEffect(()=>{const t=At(ie);document.documentElement.classList.toggle("ui-dense",t)},[ie]);const[De,Ze]=r.useState(new Set),Ae=r.useRef(new Set);r.useEffect(()=>{if(!De.size)return;const t=setTimeout(()=>Ze(new Set),9e3);return()=>clearTimeout(t)},[De]);function qe(t){const o=new Set;if(!t?.columns)return o;for(const d of Object.keys(t.columns))for(const u of t.columns[d].items||[])o.add(String(u.id));return o}function Qe({oldIds:t,newBoard:o,pulseMs:d=8e3}){const u=Date.now(),b=qe(o),j=new Set;for(const M of b)t.has(M)||j.add(M);const A=new Set([...j].filter(M=>!T.current.has(String(M))));for(const M of j)T.current.delete(String(M));if(A.size>0&&(Ze(A),m(u+d),u>=g.current))try{zn()}catch{}Ae.current=b}const[Re,Ye]=r.useState(!1),Tt=async()=>{if(!Re){Ye(!0);try{const t=new Set(Ae.current),o=await fetch("/api/import/trigger",{method:"POST"});if(!o.ok){const u=await o.text().catch(()=>"");throw new Error(`Import fehlgeschlagen (HTTP ${o.status}) ${u}`)}const d=await ae();c(d),Qe({oldIds:t,newBoard:d,pulseMs:8e3}),$(0)}catch(t){alert(t.message||"Import fehlgeschlagen.")}finally{Ye(!1)}}},[Mt,Xe]=r.useState(!1),$t=t=>String(t).replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function Ot(t,o){const d=String(o).match(/^(.*?)-(\d+)$/),u=d?d[1]:String(o);let b=d?parseInt(d[2],10):1;for(const j of t){const A=String(j.label||"").match(new RegExp("^"+$t(u)+"-(\\d+)$"));if(!A)continue;const M=parseInt(A[1],10);Number.isFinite(M)&&M>b&&(b=M)}return`${u}-${b+1}`}async function Dt(t,o){if(Mt)return;const d=we.get(t);if(d){Xe(!0);try{const u=Ot(p,d.label||d.id),b=await fetch("/api/vehicles",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ort:d.ort||"",label:u,mannschaft:0})}),j=await b.json().catch(()=>({}));if(!b.ok||j?.error)throw new Error(j?.error||"Clone fehlgeschlagen");const M=await(await fetch("/api/vehicles")).json();h(M);let ne=j?.vehicle?.id;ne||(ne=M.find(xe=>xe.label===u&&xe.ort===(d.ort||"")&&Number(xe.mannschaft)===0)?.id),o&&ne&&await Ke(o,ne),c(await ae())}catch(u){alert(u.message||"Clone fehlgeschlagen")}finally{Xe(!1)}}}const we=r.useMemo(()=>new Map(p.map(t=>[t.id,t])),[p]),[et,tt]=r.useState(new Map),Rt=r.useMemo(()=>{const t={};for(const[o,d]of we.entries())t[o]=d;return t},[we]),nt=r.useMemo(()=>{const t=new Set,o=ie?.columns||{};for(const d of Object.keys(o))for(const u of o[d].items||[])for(const b of u.assignedVehicles||[])t.add(b);return t},[ie]),Ne=r.useMemo(()=>p.filter(t=>t&&typeof t.id<"u"&&!nt.has(t.id)),[p,nt]),me=r.useMemo(()=>{const t={};for(const o of Ne){const d=o.ort||"Unbekannt";(t[d]??=[]).push(o)}for(const o of Object.keys(t))t[o].sort((d,u)=>(d.label||d.id).localeCompare(u.label||u.id));return Object.entries(t).sort((o,d)=>o[0].localeCompare(d[0]))},[Ne]);r.useEffect(()=>{if(localStorage.getItem("ff_collapsed_groups")||!me.length)return;const o=me.map(([d])=>d);Te(new Set(o)),localStorage.setItem("ff_collapsed_groups",JSON.stringify(o))},[ve,me]),r.useEffect(()=>{let t=setInterval(async()=>{try{const o=await fetch("/api/activity/status",{cache:"no-store"}).then(d=>d.json());typeof o?.auto?.enabled=="boolean"&&o.auto.enabled!==_&&y(!!o.auto.enabled)}catch{}},3e3);return()=>clearInterval(t)},[ve,_]);function Le(t,o){for(const d of["neu","in-bearbeitung","erledigt"])if((t.columns[d].items||[]).some(u=>u?.id===o))return d;return null}function Lt(t,o){for(const d of["neu","in-bearbeitung","erledigt"]){const u=(t.columns[d].items||[]).find(b=>b?.id===o);if(u)return u}return null}function _e(t){const o=ie?.columns?.[t]?.items||[];if(t==="erledigt"){const b=o.reduce((A,M)=>A+(M.everVehicles?.length||0),0),j=o.reduce((A,M)=>A+(Number.isFinite(M?.everPersonnel)?M.everPersonnel:0),0);return{cards:o.length,units:b,persons:j}}const d=o.reduce((b,j)=>b+(j.assignedVehicles?.length||0),0),u=o.reduce((b,j)=>Number.isFinite(j?.manualPersonnel)?b+j.manualPersonnel:b+(j.assignedVehicles||[]).reduce((A,M)=>A+(we.get(M)?.mannschaft??0),0),0);return{cards:o.length,units:d,persons:u}}const _t=_e("neu"),zt=_e("in-bearbeitung"),Ft=_e("erledigt"),Bt=async()=>{const t=D.replace(/^T\d+\s*,?\s*/i,"").trim(),o=(C||t).trim();if(!o){alert("Bitte Typ oder Titel angeben.");return}const d={id:`tmp-${Math.random().toString(36).slice(2,10)}`,content:o,createdAt:new Date().toISOString(),statusSince:new Date().toISOString(),assignedVehicles:[],everVehicles:[],everPersonnel:0,ort:(L||"").trim(),typ:D.trim()};V(!0),c(u=>{if(!u)return u;const b=structuredClone(u);return b.columns.neu.items.unshift(d),b});try{let u=null;const b=Pe.current;if(b?.geometry?.location?.lat&&b?.geometry?.location?.lng)u={lat:b.geometry.location.lat(),lng:b.geometry.location.lng()};else if(d.ort){const A=await Gn(d.ort);A&&(u={lat:A.lat,lng:A.lng})}const j=await ot(o,"neu",0,d.ort,d.typ,u??void 0);g.current=Date.now(),j?.card?.id!=null&&T.current.add(String(j.card.id)),c(A=>{if(!A)return A;const M=structuredClone(A),ne=M.columns.neu.items,Se=ne.findIndex(xe=>xe?.id===d.id);return Se>=0?ne[Se]=j.card:ne.unshift(j.card),M}),S(""),se(""),k(""),E(""),Pe.current=null,Ee()}catch{c(u=>{if(!u)return u;const b=structuredClone(u);return b.columns.neu.items=b.columns.neu.items.filter(j=>j?.id!==d.id),b}),alert("Einsatz konnte nicht angelegt werden.")}finally{V(!1)}},Vt=async t=>{try{const o=await ke(t.place_id,["formatted_address","geometry","address_components","place_id"]);Pe.current=o||null;const d=o?.formatted_address||t.description;se(d),k(d)}catch(o){console.error("Place details failed:",o),Pe.current=null,se(t.description),k(t.description)}finally{Ee()}},ze=t=>String(t||"").split(/[;,\n]/).map(o=>o.trim()).filter(Boolean),ce=t=>String(t||"").normalize?.("NFD").replace?.(new RegExp("\\p{Diacritic}","gu"),"").replace(/^\s*FF\s+/i,"").replace(/[._\-\/]+/g," ").replace(/\s+/g," ").toLowerCase().trim();function Kt(t,o,d,u){const b=ze(t?.alerted).map(ce);if(b.length)for(const j of o){const A=b.some(ne=>ce(j?.ort)===ne),M=b.some(ne=>ce(j?.label)===ne);if(A||M){const ne=String(j.id);d.add(ne),u.has(ne)||u.set(ne,null)}}}async function Ut(t,o){if(!(o!=="neu"||!t?.id))try{const d=await Pn(t.id),u=new Set((d?.units||[]).map(X=>String(X.unitId)));if(t?.alerted){const X=ze(t.alerted).map(ce);for(const he of Ne){const Be=X.some(Ve=>ce(he.ort)===ce(Ve)),Ie=X.some(Ve=>ce(he.label)===ce(Ve));(Be||Ie)&&u.add(String(he.id))}}n(u),m(Date.now()+3e3);const b=new Map;for(const X of d?.units||[]){const he=Number(X?.distanceKm);b.set(String(X.unitId),Number.isFinite(he)?he:null)}u.size===0&&t?.alerted&&Kt(t,Ne,u,b),tt(b);const j=new Set((d?.units||[]).filter(X=>!X.assigned).map(X=>String(X.unitId))),A=new Set(Ne.map(X=>String(X.id))),M=new Set([...j,...[...u].filter(X=>A.has(X))]),ne=ze(t?.alerted).map(ce),Se=new Set;if(ne.length&&Ne.length>0)for(const[X,he]of me){if(he.length===0)continue;ne.some(Ie=>ce(X)===ce(Ie))&&Se.add(X)}const xe=[];for(const[X,he]of me)(he.some(Ie=>M.has(String(Ie.id)))||Se.has(X))&&xe.push(X);Jt(xe),clearTimeout(pulseTimerRef.current),pulseTimerRef.current=setTimeout(()=>{n(new Set),m(0),tt(new Map)},3200)}catch(d){console.error("fetchNearby failed:",d)}}const[st,Te]=r.useState(()=>{try{const t=localStorage.getItem("ff_collapsed_groups");return new Set(t?JSON.parse(t):[])}catch{return new Set}}),Gt=t=>st.has(t),Wt=(t,o)=>{Te(d=>{const u=new Set(d);return o?u.add(t):u.delete(t),localStorage.setItem("ff_collapsed_groups",JSON.stringify([...u])),u})},Jt=(t=[])=>{Te(()=>{const o=me.map(([u])=>u),d=new Set(o);for(const u of t)d.delete(u);return localStorage.setItem("ff_collapsed_groups",JSON.stringify([...d])),d})},Ht=(t=!0)=>{Te(()=>{const o=me.map(([u])=>u),d=t?new Set(o):new Set;return localStorage.setItem("ff_collapsed_groups",JSON.stringify([...d])),d})},Zt=()=>{const t=me.map(([d])=>d),o=t.length>0&&t.every(d=>st.has(d));Ht(!o)},[Me,Fe]=r.useState(null),[qt,je]=r.useState(null),Qt=mn(at(wn,{activationConstraint:{distance:4}}),at(yn,{activationConstraint:{delay:80,tolerance:6}})),Yt=t=>{const o=t?.over;if(!o){je(null);return}const d=String(o.id||"");if(d.startsWith("col:"))je(d.slice(4));else if(d.startsWith("card:")){const u=Le(ie,d.slice(5));je(u)}else je(null)},Xt=async t=>{if(a){je(null),Fe(null);return}je(null);const{active:o,over:d}=t;if(Fe(null),!o||!d)return;const u=String(o.id||""),b=String(d.id||"");if(u.startsWith("ass:")&&b.startsWith("card:")){const[,j,A]=u.split(":"),M=b.slice(5);if(j&&A&&M&&j!==M)try{await lt(j,A);try{await ut(A)}catch{}await Ke(M,A),c(await ae())}catch{alert("Einheit konnte nicht umgehängt werden.")}return}if(u.startsWith("veh:")&&b.startsWith("card:")){try{await Ke(b.slice(5),u.slice(4)),c(await ae())}catch{alert("Einheit konnte nicht zugewiesen werden.")}return}if(u.startsWith("card:")){const j=u.slice(5),A=Le(ie,j);if(!A)return;if(b.startsWith("col:")){const M=b.slice(4);if(A!==M)try{await $e({cardId:j,from:A,to:M,toIndex:0}),c(await ae())}catch{alert("Statuswechsel konnte nicht gespeichert werden.")}return}if(b.startsWith("card:")){const M=Le(ie,b.slice(5));if(M)try{await $e({cardId:j,from:A,to:M,toIndex:0}),c(await ae())}catch{alert("Statuswechsel konnte nicht gespeichert werden.")}}}},en=async()=>{if(confirm("Board wirklich zurücksetzen?")){q(!0);try{await In(),c(await ae())}catch{alert("Reset fehlgeschlagen.")}finally{q(!1)}}},tn=()=>window.open(En(),"_blank","noopener,noreferrer"),nn=async()=>{try{const t=await ct({enabled:!_,intervalSec:te});y(!!t.enabled),O(Number(t.intervalSec)||30),$(0)}catch{alert("Konnte Auto-Import nicht ändern.")}},sn=async t=>{const o=Math.max(5,Math.min(3600,Number(t)||30));O(o);try{await ct({enabled:_,intervalSec:o}),$(0)}catch{}},an=async({title:t,ort:o,typ:d})=>{const u=await ot(t,"neu",0,o,d);g.current=Date.now(),u?.card?.id!=null&&T.current.add(String(u.card.id)),c(b=>{if(!b)return b;const j=structuredClone(b);return j.columns.neu.items.unshift(u.card),j})},rn=t=>{E(t);const o=t.replace(/^T\d+\s*,?\s*/i,"").trim();C.trim()||S(o)};if(H.startsWith("/protokoll/edit/")){const t=H.split("/")[3],o=Number(t);return e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Protokoll – Bearbeiten"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"Zur Übersicht"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(Nt,{mode:"edit",editNr:o})})]})}return H.startsWith("/protokoll/neu")?e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Protokoll – Eintrag anlegen"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"Zur Übersicht"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(Nt,{mode:"create"})})]}):H.startsWith("/protokoll")?e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Protokoll"}),e.jsx("button",{onClick:()=>{window.location.hash="/"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"← Zurück"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(Bn,{})})]}):e.jsxs("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden flex flex-col",style:{fontSize:"var(--ui-scale)"},children:[!l&&e.jsx("div",{className:"fixed inset-0 z-10 bg-black/10 backdrop-blur-sm flex items-center justify-center",children:e.jsx("div",{className:"px-4 py-2 rounded-lg bg-white shadow",children:"Lade…"})}),e.jsxs("header",{className:"flex flex-wrap items-center justify-between gap-2 mb-2",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:"Einsatzstellen-Übersicht-Feuerwehr"}),e.jsxs("div",{className:"toolbar flex flex-wrap items-center gap-2",children:[e.jsx("button",{onClick:tn,className:"px-3 py-1.5 rounded-md bg-purple-600 hover:bg-purple-700 text-white",children:"PDF"}),e.jsx("button",{onClick:()=>window.open("/api/log.csv","_blank"),className:"px-3 py-1.5 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white",title:"log.csv herunterladen",children:"Log (CSV)"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-500 hover:bg-gray-600 text-white",children:"Protokoll"}),e.jsx("button",{onClick:Tt,disabled:a||Re,className:"px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-60",title:"Import sofort ausführen",children:Re?"Import…":"Import"}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm px-2 py-1 rounded-md bg-white border",children:[e.jsx("input",{type:"checkbox",checked:_,onChange:nn,disabled:a})," Auto-Import"]}),e.jsxs("label",{className:"interval-capsule flex items-center text-sm text-gray-700 bg-gray-50 border border-gray-300 rounded-md overflow-hidden",children:[e.jsx("span",{className:"pl-3 pr-2 select-none",children:"Intervall (s):"}),e.jsx("input",{type:"number",min:"5",max:"3600",value:te,onChange:t=>sn(t.target.value),disabled:a,className:`h-9 w-20 bg-white border-0 rounded-none text-center text-gray-800 
               focus:outline-none focus:ring-0 focus:border-0`})]}),e.jsx(Vn,{autoEnabled:_,remaining:Z,disabled:a}),e.jsx("button",{onClick:en,disabled:a||P,className:`px-3 py-1.5 rounded-md text-white ${P?"bg-gray-400":"bg-gray-700 hover:bg-gray-800"}`,children:P?"Reset…":"Reset"})]})]}),e.jsxs("section",{className:"mb-2 grid grid-cols-1 md:grid-cols-7 gap-2",children:[e.jsxs("select",{className:"border rounded px-2 py-1 md:col-span-2",value:D,onChange:t=>rn(t.target.value),children:[e.jsx("option",{value:"",children:"— Typ auswählen —"}),f.map(t=>e.jsx("option",{value:t,children:t},t))]}),e.jsx("input",{className:"border rounded px-2 py-1 md:col-span-2",placeholder:"Titel (wird aus Typ übernommen)",value:C,onChange:t=>S(t.target.value)}),e.jsxs("div",{className:"relative md:col-span-2",children:[e.jsx("input",{className:"border rounded px-2 py-1 w-full",placeholder:"Ort (nur Österreich)",autoComplete:"off",value:G,onChange:t=>se(t.target.value)}),Et&&e.jsx("div",{className:"absolute z-10 mt-1 text-xs text-gray-500 bg-white border rounded px-2 py-1",children:"Suche…"}),He&&e.jsxs("div",{className:"absolute z-10 mt-1 text-xs text-red-600 bg-white border rounded px-2 py-1",children:["Fehler: ",String(He)]}),!!ye.length&&e.jsx("ul",{className:"absolute z-10 mt-1 w-full max-h-52 overflow-auto bg-white border rounded shadow",children:ye.map(t=>e.jsx("li",{className:"px-2 py-1 hover:bg-gray-100 cursor-pointer text-sm",onClick:()=>Vt(t),title:t.description,children:t.description},t.place_id))})]}),e.jsx("button",{className:"px-3 py-1 rounded bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60",disabled:a||R,onClick:Bt,children:R?"Wird angelegt…":"Einsatz anlegen"})]}),e.jsxs(hn,{sensors:Qt,collisionDetection:t=>t?.active?.data?.current?.type==="vehicle"?gn(t):pn(t),onDragStart:t=>Fe({type:t?.active?.data?.current?.type,id:t.active.id,data:t?.active?.data?.current}),onDragOver:Yt,onDragEnd:Xt,children:[e.jsxs("main",{className:"grid grid-cols-1 md:[grid-template-columns:minmax(180px,220px)_repeat(3,minmax(0,1fr))] gap-2 min-h-0 flex-1 overflow-hidden",children:[e.jsxs("section",{className:"bg-white rounded-xl shadow p-3 h-full flex flex-col min-h-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-semibold",children:e.jsx("button",{type:"button",onClick:Zt,title:"Alle Gruppen auf/zu klappen",className:"underline decoration-dotted hover:opacity-80 focus:outline-none",children:"Einheiten (frei)"})}),s&&e.jsx("button",{onClick:()=>de(!0),className:"px-2 py-1 text-sm rounded bg-emerald-600 text-white",children:"+ Einheit"})]}),e.jsxs("div",{className:"overflow-auto pr-1 flex-1 min-h-0 space-y-3",children:[me.length===0&&e.jsx("div",{className:"text-[0.85rem] text-gray-500 italic",children:"— alle Einheiten sind zugewiesen —"}),me.map(([t,o])=>{const d=Gt(t);return e.jsxs("div",{className:"border border-blue-400 rounded-md",children:[e.jsxs("button",{type:"button",onClick:()=>Wt(t,!d),className:"w-full flex items-center justify-between px-2 py-2 text-left",title:d?"aufklappen":"zuklappen",children:[e.jsx("span",{className:"text-xs font-semibold text-gray-700",children:t}),e.jsx("span",{className:"group-chip",children:o.length})]}),!d&&e.jsx("div",{className:"px-2 pb-2 grid grid-cols-1 gap-1.5",children:o.map(u=>e.jsx(Nn,{editable:s,vehicle:u,pillWidthPx:160,near:w.has(String(u.id))&&Date.now()<i,distKm:et.get(String(u.id))},u.id))})]},t)})]})]}),[{id:"neu",title:"Neu",bg:"bg-red-100",totals:_t},{id:"in-bearbeitung",title:"In Bearbeitung",bg:"bg-yellow-100",totals:zt},{id:"erledigt",title:"Erledigt",bg:"bg-green-100",totals:Ft}].map(({id:t,title:o,bg:d,totals:u})=>e.jsx("div",{className:qt===t?"drag-over":"",children:e.jsx(Ln,{editable:s,colId:t,bg:d,title:e.jsxs("span",{className:"column-header flex items-center justify-between",children:[e.jsx("span",{className:"font-semibold",children:o}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsxs("span",{className:"kpi-badge","data-variant":"units",children:["🚒 ",u.units]}),e.jsxs("span",{className:"kpi-badge","data-variant":"persons",children:["👥 ",u.persons]}),e.jsxs("span",{className:"kpi-badge","data-variant":"cards",children:["⬛ ",u.cards]})]})]}),children:e.jsx("ul",{className:"space-y-2 overflow-y-auto overflow-x-hidden pl-1 pr-2 py-2",style:{maxHeight:"calc(100vh - 260px)"},children:e.jsx(fn,{items:(ie.columns[t].items||[]).map(b=>Un(b.id)),strategy:xn,children:(ie.columns[t].items||[]).map(b=>e.jsx(vn,{editable:s,card:b,colId:t,vehiclesById:we,distById:et,pillWidthPx:160,pulse:De.has(String(b.id))&&Date.now()<i,onUnassign:async(j,A)=>{await lt(j,A);try{await ut(A)}catch{}c(await ae())},onOpenMap:j=>W({address:b.ort,card:b,board:ie,vehiclesById:Rt}),onAdvance:s?async j=>{t==="neu"?(await $e({cardId:j.id,from:"neu",to:"in-bearbeitung",toIndex:0}),c(await ae())):t==="in-bearbeitung"&&(await $e({cardId:j.id,from:"in-bearbeitung",to:"erledigt",toIndex:0}),c(await ae()))}:void 0,onEditPersonnelStart:s?(j,A)=>{F({cardId:j.id}),N(A)}:void 0,editing:Y,editingValue:J,setEditingValue:N,onEditPersonnelSave:s?async j=>{try{await kn(j.id,J===""?null:Number(J)),c(await ae())}finally{F(null),N("")}}:void 0,onEditPersonnelCancel:s?()=>{F(null),N("")}:void 0,onClone:Dt,onVehiclesIconClick:Ut,nearIds:w,nearUntilMs:i,onShowInfo:K},b.id))})})})},t))]}),e.jsxs(bn,{dropAnimation:{duration:180,easing:"ease-out"},children:[Me?.type==="vehicle"&&(()=>{const t=we.get(Me?.data?.vehicleId);return t?e.jsx("div",{className:"pointer-events-none",children:e.jsxs("div",{style:{width:160},className:"max-w-full select-none border-2 border-red-300 rounded-2xl bg-white px-2 py-1 shadow-lg",children:[e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:t.label||t.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate",children:[t.ort||"—"," · 👥 ",t.mannschaft??0]})]})}):null})(),Me?.type==="card"&&(()=>{const t=String(Me?.id||"").replace(/^card:/,""),o=Lt(ie,t);return o?e.jsx("div",{className:"pointer-events-none w-[280px]",children:e.jsxs("div",{className:"rounded-lg bg-white shadow-xl border p-3",children:[e.jsx("div",{className:"font-semibold text-sm mb-1 truncate",children:o.content}),e.jsxs("div",{className:"text-xs text-gray-600",children:[o.assignedVehicles?.length||0," Einheiten •"," ","👥 ",Number.isFinite(o?.manualPersonnel)?o.manualPersonnel:(o.assignedVehicles||[]).reduce((d,u)=>d+(we.get(u)?.mannschaft??0),0)]})]})}):null})()]})]}),s&&e.jsx("button",{className:"fab",title:"Einsatz anlegen",onClick:()=>le(!0),children:"＋"}),e.jsx("a",{href:"/Hilfe.pdf",target:"_blank",rel:"noopener noreferrer",className:"fixed bottom-4 right-4 px-4 py-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-lg",children:"Hilfe"}),pe&&e.jsx(On,{onClose:()=>de(!1),onCreate:async t=>{const o=await fetch("/api/vehicles",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!o.ok){const d=await o.text().catch(()=>String(o.status));throw new Error(`HTTP ${o.status} ${d}`)}h(await it())}}),ue&&e.jsx(Rn,{onClose:()=>le(!1),onCreate:an,types:f}),B&&e.jsx($n,{context:B,onClose:()=>W(null)}),e.jsx(_n,{open:be,info:z||{},onClose:()=>{x(!1),Q(null)}})]})}export{Jn as default};
