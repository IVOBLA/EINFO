import{u as St,j as e,r as a,a as cn,C as dn,b as un,c as kt,i as mn,d as hn,e as rt,D as gn,f as pn,g as fn,S as xn,v as bn,h as yn,T as wn,P as vn}from"./index-RzLcsrvd.js";function it({cardId:s,vehicle:i,pillWidthPx:r=160,onUnassign:c,onClone:p,near:u=!1,distKm:f=null,readonly:v=!1}){const E=`ass:${s}:${i.id}`,S=v?null:St({id:E,data:{type:"assigned",vehicleId:i.id,fromCardId:s}}),O=S?.attributes??{},I=S?.listeners??{},L=S?.setNodeRef??(()=>{}),C=S?.transform??null,B=S?.isDragging??!1,W={width:r,transform:C?`translate3d(${C.x}px, ${C.y}px, 0)`:void 0};return e.jsxs("div",{ref:L,style:W,...O,...I,className:`relative self-start border-2 rounded-2xl bg-white px-2 pr-9 py-1 shadow-sm
                  select-none cursor-grab active:cursor-grabbing
                  ${u?"border-emerald-500 ring-2 ring-emerald-300":"border-red-300"}
                  ${B?"opacity-50":""}`,title:"Ziehen: auf andere Karte verschieben · Doppelklick: klonen",onDoubleClick:()=>{v||p?.(i.id,s)},children:[u&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-0.5 rounded-2xl border-2 border-emerald-400/50 animate-ping"}),e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:i.label||i.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate flex justify-between items-center",children:[e.jsxs("span",{children:[i.ort||"—"," · 👥 ",i.mannschaft??0]}),u&&Number.isFinite(Number(f))&&e.jsxs("span",{className:"absolute top-1 right-8 text-[11px] tabular-nums text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded whitespace-nowrap",children:[Number(f)," Km"]})]}),!v&&e.jsx("button",{type:"button",onMouseDown:Q=>Q.stopPropagation(),onTouchStart:Q=>Q.stopPropagation(),onClick:Q=>{Q.stopPropagation(),c?.(s,i.id)},title:"Einheit entfernen",className:"absolute right-2 top-1/2 -translate-y-1/2 h-6 w-6 rounded-full bg-red-600 text-white shadow flex items-center justify-center","aria-label":"Einheit entfernen",children:e.jsx("svg",{viewBox:"0 0 12 12",width:"12",height:"12","aria-hidden":"true",children:e.jsx("path",{d:"M1 1 L11 11 M11 1 L1 11",stroke:"white",strokeWidth:"2",strokeLinecap:"round"})})})]})}function Nn(s){const{card:i,colId:r,vehiclesById:c,pillWidthPx:p=160,onUnassign:u,onOpenMap:f,onAdvance:v,onEditPersonnelStart:E,editing:S,editingValue:O,setEditingValue:I,onEditPersonnelSave:L,onEditPersonnelCancel:C,onClone:B,onVehiclesIconClick:W,onShowInfo:Q,nearIds:V,nearUntilMs:Z,distById:j,pulse:D,editable:F=!0}=s,[A,H]=a.useState(r==="in-bearbeitung"),X=a.useRef((i.assignedVehicles||[]).length),y=a.useRef(null),G=Date.now()<(Z||0),$=F?cn({id:`card:${i.id}`,data:{type:"card",cardId:i.id}}):{attributes:{},listeners:{},setNodeRef:w=>{},transform:null,transition:null,isDragging:!1},{attributes:se,listeners:le,setNodeRef:de,transform:ue,transition:we,isDragging:x}=$,_={transform:dn.Transform.toString(ue),transition:we,opacity:x?.8:1},q=r==="erledigt"?i.everVehicles?.length||0:i.assignedVehicles?.length||0,U=a.useMemo(()=>(i.assignedVehicles||[]).map(w=>c.get(w)).filter(Boolean),[i,c]),K=a.useMemo(()=>r==="erledigt"?Number.isFinite(i?.everPersonnel)?i.everPersonnel:0:Number.isFinite(i?.manualPersonnel)?i.manualPersonnel:U.reduce((w,n)=>w+(n?.mannschaft??0),0),[r,i,U]);a.useEffect(()=>{if(r!=="in-bearbeitung"||!G)return;(i.assignedVehicles||[]).some(n=>V?.has(String(n)))&&H(!0)},[r,G,V,i.assignedVehicles]),a.useEffect(()=>{if(r!=="in-bearbeitung")return;const w=(i.assignedVehicles||[]).length,n=X.current;w>n&&H(!0),X.current=w},[r,i.assignedVehicles]),a.useEffect(()=>{if(r==="in-bearbeitung"&&A&&y.current)try{y.current.scrollIntoView({behavior:"smooth",block:"nearest"})}catch{}},[r,A]);const te=()=>{r==="neu"?typeof W=="function"&&W(i,r):(r==="in-bearbeitung"||r==="erledigt")&&H(w=>!w)},Y=()=>{F&&typeof E=="function"&&E(i,K)};return e.jsxs("li",{ref:de,style:_,className:`relative rounded-lg bg-white shadow border transition mx-1
              ${D&&r==="neu"?"ring-2 ring-red-400/60":""}`,children:[D&&r==="neu"&&e.jsxs(e.Fragment,{children:[e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 rounded-lg bg-red-500/10 animate-pulse-inner"}),e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 rounded-lg animate-ping-safe"})]}),e.jsxs("div",{className:"p-3 select-none",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",...se,...le,children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-semibold text-sm leading-5 truncate",children:i.content}),!!i.ort&&e.jsx("button",{type:"button",onClick:()=>f?.(i.ort),className:"text-[12px] text-blue-700 hover:underline truncate",title:"Ort in Karte öffnen",children:i.ort})]}),e.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[e.jsxs("button",{type:"button",title:r==="neu"?"Nahe Einheiten prüfen":"Einheiten auf-/zuklappen",className:"px-2 py-1 rounded text-[12px] border hover:bg-red-50 flex items-center gap-1",onPointerDown:w=>w.stopPropagation(),onClick:w=>{w.stopPropagation(),w.preventDefault(),te()},children:["🚒 ",q,(r==="in-bearbeitung"||r==="erledigt")&&e.jsx("span",{children:A?"▾":"▸"})]}),e.jsxs("button",{type:"button",className:"px-2 py-1 rounded text-[12px] border bg-white hover:bg-gray-50",title:"Personalzahl bearbeiten",onPointerDown:w=>w.stopPropagation(),onClick:w=>{w.stopPropagation(),Y()},children:["👥 ",K]}),F&&v&&e.jsx("button",{type:"button",onPointerDown:w=>w.stopPropagation(),onClick:w=>{w.stopPropagation(),v(i)},className:"ml-1 px-2 py-1 rounded text-[12px] border bg-white hover:bg-gray-50",title:"weiter",children:"➔"})]})]}),r==="neu"&&!!U.length&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-1.5",children:U.map(w=>e.jsx(it,{cardId:i.id,vehicle:w,pillWidthPx:p,onUnassign:u,onClone:B,near:!!V&&G&&V.has(String(w.id)),readonly:!F,distKm:j?.get(String(w.id))??null},`ass-${i.id}-${w.id}`))}),r==="in-bearbeitung"&&A&&!!U.length&&e.jsx("div",{ref:y,className:"mt-2 flex flex-wrap gap-1.5",children:U.map(w=>e.jsx(it,{cardId:i.id,vehicle:w,pillWidthPx:p,onUnassign:u,onClone:B,near:!!V&&G&&V.has(String(w.id)),readonly:!F,distKm:j?.get(String(w.id))??null},`ass-${i.id}-${w.id}`))}),r==="erledigt"&&A&&!!i.everVehicles?.length&&e.jsx("ul",{className:"mt-2 text-sm text-gray-700 list-disc list-inside space-y-1",children:i.everVehicles.map(w=>{const n=c.get(w),o=n?.label||n?.id||"Unbekannt",h=n?.ort?` (${n.ort})`:"";return e.jsxs("li",{children:[o,h]},w)})}),F&&S?.cardId===i.id&&e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("input",{type:"number",className:"w-20 border rounded px-2 py-1 text-sm",value:O,onChange:w=>I(w.target.value),placeholder:"Personen"}),e.jsx("button",{className:"px-2 py-1 text-sm rounded bg-emerald-600 text-white",onClick:()=>L(i),children:"Speichern"}),e.jsx("button",{className:"px-2 py-1 text-sm rounded bg-gray-200",onClick:C,children:"Abbrechen"})]}),e.jsxs("div",{className:"mt-2 flex justify-end gap-2",children:[e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Ort in Karte öffnen",onPointerDown:w=>w.stopPropagation(),onClick:w=>{w.stopPropagation(),f?.(i.ort)},children:"Karte"}),e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Einsatz-Info",onPointerDown:w=>w.stopPropagation(),onClick:w=>{w.stopPropagation(),Q?.(i)},children:"?"})]})]})]})}function jn({vehicle:s,pillWidthPx:i=160,near:r=!1,distKm:c=null,editable:p=!0}){const u=`veh:${s.id}`,f=p?St({id:u,data:{type:"vehicle",vehicleId:s.id}}):null,v=f?.attributes??{},E=f?.listeners??{},S=f?.setNodeRef??(()=>{}),O=f?.transform??null,I=f?.isDragging??!1;return e.jsxs("div",{ref:S,style:{width:i,transform:O?`translate3d(${O.x}px, ${O.y}px, 0)`:void 0},...v,...E,className:`relative max-w-full select-none border-2 ${r?"border-emerald-500":"border-red-300"} rounded-2xl bg-white
                 px-2 py-1 shadow-sm cursor-grab active:cursor-grabbing
                 ${I?"opacity-50":""}`,children:[r&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-0.5 rounded-2xl border-2 border-emerald-400/50 animate-ping"}),e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:s.label||s.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate flex justify-between items-center",children:[e.jsxs("span",{children:[s.ort||"—"," · 👥 ",s.mannschaft??0]}),r&&Number.isFinite(Number(c))&&e.jsxs("span",{className:"absolute top-1 right-1 text-[11px] tabular-nums text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded whitespace-nowrap",children:[Number(c)," Km"]})]})]})}const Sn="";async function re(s,i,r){const c=await fetch(Sn+i,{method:s,headers:{"Content-Type":"application/json"},body:r===void 0?void 0:JSON.stringify(r),cache:"no-store",credentials:"include"});if(!c.ok)throw new Error(`HTTP ${c.status} ${await c.text().catch(()=>c.statusText)}`);return(c.headers.get("content-type")||"").includes("application/json")?c.json():c.text()}async function ae(){return re("GET","/api/board")}async function ot(){return re("GET","/api/vehicles")}async function kn(){try{return await re("GET","/api/types")}catch{return[]}}async function lt(s,i="neu",r=0,c="",p="",u={}){const f={title:s,columnId:i,toIndex:r,ort:c,typ:p};if(u&&typeof u=="object"){const{lat:v,lng:E,latitude:S,longitude:O,...I}=u;Number.isFinite(S)&&(f.latitude=Number(S)),Number.isFinite(O)&&(f.longitude=Number(O)),Number.isFinite(v)&&(f.latitude=Number(v)),Number.isFinite(E)&&(f.longitude=Number(E)),Object.assign(f,I)}return re("POST","/api/cards",f)}async function $e({cardId:s,from:i,to:r,toIndex:c=0}){return re("POST",`/api/cards/${encodeURIComponent(s)}/move`,{from:i,to:r,toIndex:c})}async function Ke(s,i){return re("POST",`/api/cards/${encodeURIComponent(s)}/assign`,{vehicleId:i})}async function ct(s,i){return re("POST",`/api/cards/${encodeURIComponent(s)}/unassign`,{vehicleId:i})}async function In(s,i){return re("PATCH",`/api/cards/${encodeURIComponent(s)}/personnel`,{manualPersonnel:i})}async function Cn(){return re("POST","/api/reset",{})}async function En(){return re("GET","/api/import/auto-config")}async function dt({enabled:s,intervalSec:i}){return re("POST","/api/import/auto-config",{enabled:s,intervalSec:i})}function Pn(){return"/api/export/pdf"}async function An(s,i){const r=`cardId=${encodeURIComponent(s)}`,p=Number.isFinite(Number(i))&&Number(i)>0?`${r}&radiusKm=${encodeURIComponent(i)}`:r,u=await fetch(`/api/nearby?${p}`,{credentials:"same-origin",cache:"no-store"});if(!u.ok)throw new Error("fetchNearby failed");return u.json()}async function ut(s,i,r,c=null,p="manual"){return re("PATCH",`/api/vehicles/${encodeURIComponent(s)}/position`,{lat:Number(i),lng:Number(r),incidentId:c,source:p})}async function mt(s){return re("DELETE",`/api/vehicles/${encodeURIComponent(s)}/position`)}function Tn(s,i){const c=(i.lat-s.lat)*Math.PI/180,p=(i.lng-s.lng)*Math.PI/180,u=Math.sin(c/2)**2+Math.cos(s.lat*Math.PI/180)*Math.cos(i.lat*Math.PI/180)*Math.sin(p/2)**2;return 2*6371*Math.asin(Math.sqrt(u))}function ht(s,i,r){const p=r*Math.PI/180,u=s.lat*Math.PI/180,f=s.lng*Math.PI/180,v=i/6371e3,E=Math.asin(Math.sin(u)*Math.cos(v)+Math.cos(u)*Math.sin(v)*Math.cos(p))*180/Math.PI,S=(f+Math.atan2(Math.sin(p)*Math.sin(v)*Math.cos(u),Math.cos(v)-Math.sin(u)*Math.sin(E*Math.PI/180)))*180/Math.PI;return{lat:E,lng:S}}async function gt(s){if(!s||!window.google?.maps?.Geocoder)return null;const i=new window.google.maps.Geocoder;return new Promise(r=>{i.geocode({address:s,region:"AT"},(c,p)=>{p==="OK"&&c?.[0]?.geometry?.location?r({lat:c[0].geometry.location.lat(),lng:c[0].geometry.location.lng(),formatted:c[0].formatted_address||s}):r(null)})})}const Ce=s=>String(s||"").trim().toLowerCase();async function pt(){try{const s=await fetch("/api/vehicles",{cache:"no-store"});return s.ok?s.json():[]}catch{return[]}}async function ft(){try{const s=await fetch("/api/gps",{cache:"no-store"});if(s.ok)return await s.json()}catch(s){console.error("GPS fetch failed:",s)}return[]}function xt(s){const i=s?.typ||s?.type||"—",r=s?.timestamp?new Date(s.timestamp).toLocaleString("de-AT",{hour12:!1}):"—",c=s?.alerted??"—",p=s?.description??"—",u=s?.additionalAddressInfo||s?.ort||"—",f=[];s?.location&&f.push(String(s.location));const v=Number.isFinite(s?.latitude),E=Number.isFinite(s?.longitude);v&&E&&f.push(`(${s.latitude}, ${s.longitude})`);const S=f.length?f.join(" "):"—";return`
    <div style="min-width:280px">
      <div style="font-weight:700;margin-bottom:4px">${s?.content||"Einsatz"}</div>
      <div><b>Typ:</b> ${i}</div>
      <div><b>Alarmzeit:</b> ${r}</div>
      <div><b>Alarmiert:</b> ${c}</div>
      <div><b>Beschreibung:</b> ${p}</div>
      <div><b>Adresse:</b> ${u}</div>
      <div><b>Location:</b> ${S}</div>
    </div>
  `}const pe=44,bt="/vehicle-red.gif",Mn="/vehicle-gray.png",$n="/vehicle-drive.gif";function On({context:s,address:i,onClose:r}){const c=i||s?.card?.ort||s?.address||"",p=!!window.google?.maps,u=a.useRef(null),[f,v]=a.useState(!1),[E,S]=a.useState(""),O=a.useMemo(()=>{const I=s?.card;return I&&Number.isFinite(I?.latitude)&&Number.isFinite(I?.longitude)?{lat:Number(I.latitude),lng:Number(I.longitude)}:null},[s]);if(a.useEffect(()=>{if(!p||!s?.card||!u.current)return;let I=!1,L,C;const B=new Map;let W=null;return(async()=>{try{v(!0),S("");let V=O;if(!V){const x=await gt(s.card.ort);if(I)return;x&&(V={lat:x.lat,lng:x.lng})}if(!V){S("Konnte Einsatz-Position nicht bestimmen.");return}L=new window.google.maps.Map(u.current,{center:V,zoom:18,mapTypeId:"roadmap"}),C=new window.google.maps.InfoWindow;const Z=(x,_,q,U,{hover:K=!1}={})=>{const te={path:"M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z",fillColor:_,fillOpacity:1,strokeColor:"#333",strokeWeight:1,scale:1.2},Y=new window.google.maps.Marker({position:x,map:L,title:q,icon:te});if(U){const w=()=>{C.setContent(U),C.open(L,Y)};K?(Y.addListener("mouseover",w),Y.addListener("mouseout",()=>C.close())):Y.addListener("click",w)}return Y};Z(V,"#d11a1a",s.card.content||"Einsatz",xt(s.card),{hover:!0});const j=[...s?.board?.columns?.neu?.items||[],...s?.board?.columns?.["in-bearbeitung"]?.items||[]],D=new Map;for(const x of j)if(Number.isFinite(x.latitude)&&Number.isFinite(x.longitude))D.set(x.id,{lat:Number(x.latitude),lng:Number(x.longitude)});else if(x.ort){const _=await gt(x.ort);_&&D.set(x.id,{lat:_.lat,lng:_.lng})}for(const x of j){if(x.id===s.card.id)continue;const _=D.get(x.id);_&&Z(_,"#1e63d1",x.content||"Einsatz",xt(x),{hover:!0})}const F=new Map;for(const x of j)for(const _ of x.assignedVehicles||[])F.set(String(_),x.id);const A=await ft(),H=new Map(A.filter(x=>Number.isFinite(x?.lat)&&Number.isFinite(x?.lng)&&x?.realname).map(x=>[Ce(x.realname),x])),X=await pt(),y=new Map(X.filter(x=>x&&x.source!=="gps"&&Number.isFinite(x.latitude)&&Number.isFinite(x.longitude)).map(x=>[String(x.id),{lat:Number(x.latitude),lng:Number(x.longitude)}])),G=Object.values(s.vehiclesById||{}),$=10,se=50,le=new Map,de=window.google?.maps?.marker?.AdvancedMarkerElement,ue=(x,_,q)=>{if(!x)return Mn;if(!_||!q||!D.has(q))return bt;const U=D.get(q);return Tn(_,U)>.1?$n:bt},we=(x,_,q,U,K,te)=>{const Y=ue(_,U,K),w=!U;if(de){const n=document.createElement("img");n.src=Y,n.width=pe,n.height=pe,n.alt=q||"",n.decoding="async";const o=new de({map:L,position:x,content:n,title:q});if(w){try{o.draggable=!0}catch{}o.addListener("dragend",async h=>{const g=h?.latLng||o.position,M=typeof g.lat=="function"?g.lat():g.lat,k=typeof g.lng=="function"?g.lng():g.lng;try{await ut(te,M,k,K,"manual")}catch(R){o.__setPosition(x),console.error("setVehiclePosition failed:",R),alert("Position konnte nicht gespeichert werden.")}})}return o.__setPosition=h=>{o.position=h},o.__setIcon=(h,g,M)=>{n.src=ue(h,g,M)},o.__onOver=h=>{n.addEventListener("mouseover",h),n.addEventListener("mouseout",()=>C.close())},o}else{const n=new window.google.maps.Marker({position:x,map:L,title:q,draggable:w,icon:{url:Y,scaledSize:new window.google.maps.Size(pe,pe),anchor:new window.google.maps.Point(pe/2,pe/2)}});return w&&n.addListener("dragend",async o=>{const h=o?.latLng||n.getPosition(),g=typeof h.lat=="function"?h.lat():h.lat,M=typeof h.lng=="function"?h.lng():h.lng;try{await ut(te,g,M,K,"manual")}catch(k){n.__setPosition(x),console.error("setVehiclePosition failed:",k),alert("Position konnte nicht gespeichert werden.")}}),n.__setPosition=o=>n.setPosition(o),n.__setIcon=(o,h,g)=>n.setIcon({url:ue(o,h,g),scaledSize:new window.google.maps.Size(pe,pe),anchor:new window.google.maps.Point(pe/2,pe/2)}),n.__onOver=o=>{n.addListener("mouseover",o),n.addListener("mouseout",()=>C.close())},n}};for(const x of G){const _=String(x.id),q=Ce(`${x?.label||""} ${x?.ort||""}`),U=H.get(q),K=F.get(_);if(!K&&!U)continue;let te=null,Y=null;if(U)Y={lat:Number(U.lat),lng:Number(U.lng)},te=Y;else if(y.has(_))te=y.get(_);else if(K&&D.has(K)){const g=D.get(K),k=((le.get(K)||0)+se)%360;le.set(K,k),te=ht(g,$,k)}if(!te)continue;const n=we(te,!!K,x.label||x.id,Y,K,_),o=K&&j.find(g=>g.id===K),h=o?`<br/><i>zugeordnet: ${o.content}</i>`:"";n.__onOver(()=>{const g=x?.ort||"";C.setContent(`<div style="min-width:220px"><b>${x.label||x.id}</b>${g?`<br/>${g}`:""}${h}</div>`);const M=de?void 0:n;C.open({map:L,anchor:M,position:te,shouldFocus:!1})}),B.set(_,n)}L.setCenter(V),L.setZoom(18),W=setInterval(async()=>{const x=await ft(),_=await pt(),q=new Map(_.filter(o=>o&&o.source!=="gps"&&Number.isFinite(o.latitude)&&Number.isFinite(o.longitude)).map(o=>[String(o.id),{lat:Number(o.latitude),lng:Number(o.longitude)}])),U=new Map(x.filter(o=>Number.isFinite(o?.lat)&&Number.isFinite(o?.lng)&&o?.realname).map(o=>[Ce(o.realname),o])),K=new Map;for(const o of[...s?.board?.columns?.neu?.items||[],...s?.board?.columns?.["in-bearbeitung"]?.items||[]])for(const h of o.assignedVehicles||[])K.set(String(h),o.id);const te=Object.values(s.vehiclesById||{}),Y=new Map;for(const o of te){const h=String(o.id),g=K.get(h),M=Ce(`${o?.label||""} ${o?.ort||""}`);if(g&&!U.get(M)){const k=Y.get(g)||[];k.push(h),Y.set(g,k)}}for(const[o,h]of Y.entries())h.sort();const w=10,n=50;for(const o of te){const h=String(o.id),g=B.get(h);if(!g)continue;const M=Ce(`${o?.label||""} ${o?.ort||""}`),k=U.get(M),R=K.get(h);if(k)gpsPos={lat:Number(k.lat),lng:Number(k.lng)},g.__setPosition(gpsPos);else if(q.has(h))g.__setPosition(q.get(h));else if(R&&D.has(R)){const xe=((Y.get(R)||[]).indexOf(h)+1)*n%360,be=D.get(R);g.__setPosition(ht(be,w,xe))}else{const z=B.get(h);z&&(z.setMap?z.setMap(null):z.map&&(z.map=null),B.delete(h));continue}const J=!!R;g.__setIcon(J,gpsPos,R)}},5e3)}catch(V){S(V?.message||"Kartenaufbau fehlgeschlagen.")}finally{v(!1)}})(),()=>{I=!0,W&&clearInterval(W),B.clear()}},[p,s,O]),!p||!s?.card){const I=`https://www.google.com/maps?q=${encodeURIComponent(c)}&output=embed`;return e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:r,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[70vh] p-2",onClick:L=>L.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-semibold text-sm",children:["Karte: ",c]}),e.jsx("button",{className:"px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm",onClick:r,children:"Schließen"})]}),e.jsx("iframe",{title:"maps",className:"w-full h-full rounded-lg border",src:I,loading:"lazy"})]})})}return e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:r,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-5xl h-[75vh] p-2",onClick:I=>I.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-semibold text-sm",children:["Karte: ",s?.card?.content||"Einsatz"," · weitere Einsätze (Neu & In Bearbeitung)"]}),e.jsx("button",{className:"px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm",onClick:r,children:"Schließen"})]}),e.jsx("div",{ref:u,className:"w-full h-full rounded-lg border"}),f&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"px-3 py-1.5 rounded bg-white shadow text-sm",children:"Lade…"})}),!!E&&e.jsx("div",{className:"absolute bottom-3 left-3 px-2 py-1 rounded bg-red-600 text-white text-xs shadow",children:E})]})})}function Dn({onClose:s,onCreate:i}){const[r,c]=a.useState(""),[p,u]=a.useState(""),[f,v]=a.useState(0),[E,S]=a.useState(!1),[O,I]=a.useState(""),L=async C=>{if(C.preventDefault(),I(""),!r.trim()||!p.trim()){I("Ort und Name sind erforderlich.");return}try{S(!0),await i({ort:r.trim(),label:p.trim(),mannschaft:Number(f)||0}),s()}catch(B){I(B?.message||"Speichern fehlgeschlagen.")}finally{S(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:e.jsxs("form",{onSubmit:L,className:"bg-white rounded-xl shadow-lg p-4 w-[360px] space-y-3",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Einheit anlegen"}),O&&e.jsx("div",{className:"text-sm text-red-600",children:O}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Ort"}),e.jsx("input",{className:"border rounded px-2 py-1 w-full",value:r,onChange:C=>c(C.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Name"}),e.jsx("input",{className:"border rounded px-2 py-1 w-full",value:p,onChange:C=>u(C.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Mannschaft"}),e.jsx("input",{type:"number",min:"0",className:"border rounded px-2 py-1 w-24",value:f,onChange:C=>v(C.target.value)})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:s,className:"px-3 py-1 rounded border",disabled:E,children:"Abbrechen"}),e.jsx("button",{type:"submit",className:"px-3 py-1 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:E,children:E?"Anlegen…":"Anlegen"})]})]})})}let Oe=null;function It(){const s=document.querySelector('meta[name="google-places-key"]');return(window.GMAPS_API_KEY||s?.content||"").trim()||""}async function Rn(s=It()){if(window.google?.maps?.places)return!0;if(!s)return!1;if(Oe)return await Oe,!!window.google?.maps?.places;Oe=new Promise((i,r)=>{if(document.getElementById("gmap-places")){const p=()=>{window.google?.maps?.places?i(!0):setTimeout(p,150)};p();return}const c=document.createElement("script");c.id="gmap-places",c.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(s)}&libraries=places&language=de`,c.async=!0,c.defer=!0,c.onload=()=>i(!!window.google?.maps?.places),c.onerror=p=>r(p),document.head.appendChild(c)});try{await Oe}catch{}return!!window.google?.maps?.places}function Ct({debounceMs:s=300,country:i="at",minLength:r=3}={}){const[c,p]=a.useState(""),[u,f]=a.useState([]),[v,E]=a.useState(!1),[S,O]=a.useState(!1),[I,L]=a.useState(null),C=a.useRef(null),B=a.useRef(null),W=a.useRef(null),Q=a.useRef(null);a.useEffect(()=>{let A=!1;return(async()=>{const H=await Rn(It());A||!H||!window.google?.maps?.places||(C.current=new google.maps.places.AutocompleteService,B.current=new google.maps.places.PlacesService(document.createElement("div")),W.current=new google.maps.places.AutocompleteSessionToken,A||O(!0))})(),()=>{A=!0}},[]);const V=a.useCallback(()=>{window.google?.maps?.places&&(W.current=new google.maps.places.AutocompleteSessionToken)},[]),Z=a.useRef();a.useEffect(()=>{Z.current||(Z.current=(A,H)=>{let X;return(...y)=>{clearTimeout(X),X=setTimeout(()=>A(...y),H)}})},[]);const j=a.useCallback(async A=>{if(!S||!C.current)return;const H=(A||"").trim();if(!H||H.length<r){f([]);return}E(!0),L(null),C.current.getPlacePredictions({input:H,sessionToken:W.current,componentRestrictions:{country:i},types:["address"]},(X,y)=>{if(E(!1),y!==google.maps.places.PlacesServiceStatus.OK||!X){f([]),y&&y!=="ZERO_RESULTS"&&L(y);return}f(X)})},[i,r,S]),D=a.useMemo(()=>Z.current?Z.current(j,s):()=>{},[j,s]);a.useEffect(()=>{D(c)},[c,D]);const F=a.useCallback((A,H=["formatted_address","geometry","address_components"])=>new Promise((X,y)=>{if(!S||!B.current){y(new Error("Google Places nicht bereit"));return}B.current.getDetails({placeId:A,fields:H,sessionToken:W.current},(G,$)=>{if($!==google.maps.places.PlacesServiceStatus.OK||!G)return y(new Error($||"DETAILS_FAILED"));X(G)})}),[S]);return{ready:S,query:c,setQuery:p,predictions:u,loading:v,error:I,resetSession:V,getDetailsByPlaceId:F,inputElRef:Q}}function Ln({onClose:s,onCreate:i,types:r}){const[c,p]=a.useState(""),[u,f]=a.useState(""),[v,E]=a.useState(!1),S=a.useRef(null),{query:O,setQuery:I,predictions:L,getDetailsByPlaceId:C,resetSession:B,loading:W,error:Q}=Ct({country:"at",debounceMs:300,minLength:3});a.useEffect(()=>{setTimeout(()=>S.current?.focus(),0)},[]),a.useEffect(()=>{const j=(u||"").replace(/^T\d+\s*,?\s*/i,"").trim();!c.trim()&&j&&p(j)},[u]);const V=async j=>{j?.preventDefault?.();const D=(u||"").replace(/^T\d+\s*,?\s*/i,"").trim(),F=(c||D).trim();if(F){E(!0);try{await i({title:F,ort:(O||"").trim(),typ:(u||"").trim()}),p(""),I(""),f(""),B(),s?.()}finally{E(!1)}}},Z=async j=>{try{const F=(await C(j.place_id,["formatted_address","geometry","address_components","place_id"]))?.formatted_address||j.description;I(F)}catch{I(j.description)}finally{B()}};return e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-3",children:e.jsxs("form",{onSubmit:V,className:"bg-white rounded-xl shadow-lg w-[520px] max-w-full p-4 space-y-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Einsatz anlegen"}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs("select",{ref:S,className:"border rounded px-2 py-1",value:u,onChange:j=>f(j.target.value),children:[e.jsx("option",{value:"",children:"— Typ auswählen —"}),r.map(j=>e.jsx("option",{value:j,children:j},j))]}),e.jsx("input",{className:"border rounded px-2 py-1",placeholder:"Titel (wird aus Typ übernommen)",value:c,onChange:j=>p(j.target.value)}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{className:"border rounded px-2 py-1 w-full",placeholder:"Ort (nur Österreich)",autoComplete:"off",value:O,onChange:j=>I(j.target.value)}),W&&e.jsx("div",{className:"absolute z-10 mt-1 text-xs text-gray-500 bg-white border rounded px-2 py-1",children:"Suche…"}),Q&&e.jsxs("div",{className:"absolute z-10 mt-1 text-xs text-red-600 bg-white border rounded px-2 py-1",children:["Fehler: ",String(Q)]}),!!L.length&&e.jsx("ul",{className:"absolute z-10 mt-1 w-full max-h-52 overflow-auto bg-white border rounded shadow",children:L.map(j=>e.jsx("li",{className:"px-2 py-1 hover:bg-gray-100 cursor-pointer text-sm",onClick:()=>Z(j),title:j.description,children:j.description},j.place_id))})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:s,className:"px-3 py-1 rounded border",disabled:v,children:"Abbrechen"}),e.jsx("button",{className:"px-3 py-1 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:v,children:v?"Anlegen…":"Anlegen"})]})]})})}function _n({colId:s,title:i,bg:r,children:c,editable:p=!0}){if(!p)return e.jsxs("section",{className:`${r} rounded-xl shadow p-3 h-full flex flex-col min-h-0`,children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:i}),c]});const{setNodeRef:u,isOver:f}=un({id:`col:${s}`,data:{type:"column",colId:s}});return e.jsxs("section",{ref:u,className:`${r} rounded-xl shadow p-3 h-full flex flex-col min-h-0 ${f?"outline outline-2 outline-blue-400":""}`,children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:i}),c]})}function zn({open:s,onClose:i,info:r={}}){if(!s)return null;const c=({label:v,value:E})=>e.jsxs("div",{className:"flex items-start gap-3 py-1",children:[e.jsx("div",{className:"w-32 shrink-0 text-gray-600",children:v}),e.jsx("div",{className:"flex-1 font-medium break-words",children:E??"—"})]}),p=r.timestamp?new Date(r.timestamp).toLocaleString("de-AT",{hour12:!1}):"—",u=[];r.location&&u.push(String(r.location)),Number.isFinite(r.latitude)&&Number.isFinite(r.longitude)&&u.push(`(${r.latitude}, ${r.longitude})`);const f=u.length?u.join(" "):void 0;return e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:i}),e.jsxs("div",{className:"relative z-[101] w-[min(92vw,640px)] rounded-xl bg-white shadow-xl p-4 md:p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg md:text-xl font-bold",children:"Einsatz-Info"}),e.jsx("button",{className:"h-8 w-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center",onClick:i,"aria-label":"Schließen",title:"Schließen",children:e.jsx("svg",{viewBox:"0 0 12 12",width:"14",height:"14","aria-hidden":"true",children:e.jsx("path",{d:"M1 1 L11 11 M11 1 L1 11",stroke:"black",strokeWidth:"2",strokeLinecap:"round"})})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(c,{label:"Typ",value:r.type||r.typ}),e.jsx(c,{label:"Alarmzeit",value:p}),e.jsx(c,{label:"Alarmiert",value:r.alerted}),e.jsx(c,{label:"Beschreibung",value:r.description}),e.jsx(c,{label:"Adresse",value:r.additionalAddressInfo||r.ort}),e.jsx(c,{label:"Location",value:f})]}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx("button",{className:"px-3 py-1.5 rounded-md bg-emerald-600 text-white hover:bg-emerald-700",onClick:i,children:"OK"})})]})]})}let Je=localStorage.getItem("soundEnabled")==="1",oe=null;const yt=window.AudioContext||window.webkitAudioContext,Ue=yt?new yt:null;function Et(){oe||(oe=new Audio("/sounds/bahnhof.mp3"),oe.preload="auto");const s=async()=>{try{Ue&&Ue.state!=="running"&&await Ue.resume(),oe&&(oe.muted=!0,await oe.play(),oe.pause(),oe.currentTime=0,oe.muted=!1),Je=!0,localStorage.setItem("soundEnabled","1"),window.removeEventListener("pointerdown",s),window.removeEventListener("keydown",s),window.dispatchEvent(new CustomEvent("sound:unlocked"))}catch{}};Je||(window.addEventListener("pointerdown",s,{once:!0}),window.addEventListener("keydown",s,{once:!0}))}async function Fn(){if(oe||Et(),!Je){window.dispatchEvent(new CustomEvent("sound:needsUnlock"));return}try{oe.currentTime=0,await oe.play()}catch{}}function Bn(s){const i=(s??"").toString();return i.length>30?i.slice(0,30)+"…":i}function Vn(){const[s,i]=a.useState([]),[r,c]=a.useState(!0);a.useEffect(()=>{(async()=>{try{const u=await fetch("/api/protocol").then(f=>f.json());i(Array.isArray(u?.items)?u.items:[])}catch{i([])}finally{c(!1)}})()},[]);const p=a.useMemo(()=>[...s].sort((u,f)=>(Number(f.nr)||0)-(Number(u.nr)||0)),[s]);return e.jsxs("div",{className:"p-3 md:p-4 max-w-[1400px] mx-auto h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-3",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:"Protokoll-Übersicht"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("a",{href:"/api/protocol/csv/file",className:"px-3 py-1.5 rounded-md border bg-white",title:"protocol.csv herunterladen",children:"CSV"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll/neu"},className:"px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white",children:"+ Eintrag anlegen"})]})]}),e.jsx("div",{className:"flex-1 overflow-auto border rounded-lg bg-white",children:r?e.jsx("div",{className:"p-4 text-gray-500",children:"Lade…"}):e.jsxs("table",{className:"min-w-[1100px] w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0 z-10",children:e.jsxs("tr",{className:"[&>th]:px-2 [&>th]:py-2 [&>th]:text-left [&>th]:font-semibold border-b",children:[e.jsx("th",{style:{width:28},title:"Druckstatus"}),e.jsx("th",{style:{width:60},children:"NR"}),e.jsx("th",{style:{width:110},children:"Datum"}),e.jsx("th",{style:{width:80},children:"Zeit"}),e.jsx("th",{style:{width:120},children:"Kanal"}),e.jsx("th",{style:{width:110},children:"Richtung"}),e.jsx("th",{style:{width:160},children:"An/Von"}),e.jsx("th",{children:"Information"}),e.jsx("th",{style:{width:260},children:"Meldungstyp"})]})}),e.jsxs("tbody",{className:"[&>tr>td]:px-2 [&>tr>td]:py-2",children:[p.map(u=>{const f=u?.uebermittlungsart||{},v=f.kanal??f.kanalNr??f.art??"",S=[].concat(f.ein?"Eingang":[]).concat(f.aus?"Ausgang":[]).join(" / "),O=Number(u?.printCount)>0;return e.jsxs("tr",{className:"border-b align-top hover:bg-gray-50 cursor-pointer",onClick:()=>{window.location.hash=`/protokoll/edit/${u.nr}`},title:"Zum Bearbeiten öffnen",children:[e.jsx("td",{className:"align-middle",children:O?e.jsx("span",{className:"inline-block w-3 h-3 rounded-full bg-yellow-400",title:`Gedruckt (${u.printCount})`}):null}),e.jsx("td",{className:"font-semibold",children:u.nr}),e.jsx("td",{children:u.datum}),e.jsx("td",{children:u.zeit}),e.jsx("td",{title:v,children:v}),e.jsx("td",{title:S,children:S}),e.jsx("td",{children:u.anvon}),e.jsx("td",{className:"whitespace-pre-wrap",children:Bn(u.information)}),e.jsx("td",{className:"whitespace-pre-wrap",children:u.infoTyp||"—"})]},u.nr)}),!p.length&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"p-4 text-gray-500 italic",children:"— keine Einträge —"})})]})]})})]})}const Ge=["EL","LtStb","S1","S2","S3","S4","S5","S6"];kt("protokoll");const fe={anvon:"prot_sugg_anvon",kanal:"prot_sugg_kanalNr",verantwortlich:"prot_sugg_ver"};function We(s,i=12){const r=new Set,c=[];for(const p of s){const u=String(p||"").trim();if(!(!u||r.has(u))&&(r.add(u),c.push(u),c.length>=i))break}return c}function wt(s){let i=String(s||"").trim();if(!i)return i;const r=i.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})$/);if(r){const p=r[1].padStart(2,"0"),u=r[2].padStart(2,"0");return`${r[3].length===2?"20"+r[3]:r[3]}-${u}-${p}`}const c=i.match(/^(\d{1,2})(\d{1,2})(\d{2,4})$/);if(c){const p=c[1].padStart(2,"0"),u=c[2].padStart(2,"0");return`${c[3].length===2?"20"+c[3]:c[3].padStart(4,"20")}-${u}-${p}`}return i}function vt(s){let i=String(s||"").trim();if(!i)return i;const r=i.match(/^(\d{1,2})(\d{2})$/);if(r)return`${r[1].padStart(2,"0")}:${r[2]}`;const c=i.match(/^(\d{1,2})[:.](\d{1,2})$/);return c?`${c[1].padStart(2,"0")}:${c[2].padStart(2,"0")}`:i}const Nt=()=>({datum:new Date().toISOString().slice(0,10),zeit:new Date().toTimeString().slice(0,5),uebermittlungsart:{richtung:"",kanalNr:""},anvon:{richtung:"an",name:""},infoTyp:"Information",information:"",rueckmeldung1:"",rueckmeldung2:"",ergehtAn:[],ergehtAnText:"",lagebericht:"",massnahmen:Array.from({length:5},()=>({massnahme:"",verantwortlich:"",done:!1}))});function jt({mode:s="create",editNr:i=null}){const[r,c]=a.useState(()=>{const n=Number(i);return Number.isFinite(n)&&n>0?n:null}),p=Number.isFinite(Number(r))&&Number(r)>0,[u,f]=a.useState(p),[v,E]=a.useState(!1),[S,O]=a.useState(null),I=a.useRef(null),L=a.useRef(null),C=a.useRef(!1),B=a.useRef(null),[W,Q]=a.useState(null),V=a.useRef(null),Z=(n,o,h=2200)=>{Q({type:n,text:o}),V.current&&clearTimeout(V.current),V.current=setTimeout(()=>Q(null),h)},[j,D]=a.useState([]),[F,A]=a.useState([]),[H,X]=a.useState([]);a.useEffect(()=>{try{D(JSON.parse(localStorage.getItem(fe.anvon)||"[]")),A(JSON.parse(localStorage.getItem(fe.kanal)||"[]")),X(JSON.parse(localStorage.getItem(fe.verantwortlich)||"[]"))}catch{}},[]);const[y,G]=a.useState(Nt()),$=(n,o)=>{const h=Array.isArray(n)?n:String(n).split(".");G(g=>{const M=structuredClone(g);let k=M;for(let R=0;R<h.length-1;R++)k=k[h[R]];return k[h.at(-1)]=o,M})};a.useEffect(()=>{if(!p){f(!1),setTimeout(()=>L.current?.focus(),0);return}const n=Number(r);!Number.isFinite(n)||n<=0||(async()=>{try{const o=await fetch(`/api/protocol/${n}`).then(h=>h.json());if(o?.ok&&o.item){const h=o.item,g=h.uebermittlungsart||{};let M="",k=h.anvon||"";const R=(h.anvon||"").trim();/^an\s*:/i.test(R)&&(M="an",k=R.replace(/^an\s*:/i,"").trim()),/^von\s*:/i.test(R)&&(M="von",k=R.replace(/^von\s*:/i,"").trim()),G({datum:h.datum||"",zeit:h.zeit||"",uebermittlungsart:{richtung:g.ein?"ein":g.aus?"aus":"",kanalNr:g.kanalNr||""},anvon:{richtung:M||"an",name:k},infoTyp:h.infoTyp||"Information",information:h.information||"",rueckmeldung1:h.rueckmeldung1||"",rueckmeldung2:h.rueckmeldung2||"",ergehtAn:Array.isArray(h.ergehtAn)?h.ergehtAn:[],ergehtAnText:h.ergehtAnText||"",lagebericht:h.lagebericht||"",massnahmen:Array.from({length:5},(J,z)=>{const me=h.massnahmen?.[z]||{};return{massnahme:me.massnahme||"",verantwortlich:me.verantwortlich||"",done:!!me.done}})}),O(h.id||null),setTimeout(()=>L.current?.focus(),0)}}finally{f(!1)}})()},[p,r]),a.useEffect(()=>{const n=()=>{const g=document.activeElement;g&&typeof g.blur=="function"&&g.blur()},o=g=>setTimeout(g,0),h=g=>{if(g.repeat)return;const M=(g.key||"").toLowerCase(),k=g.ctrlKey||g.metaKey;if(k&&!g.shiftKey&&M==="s"){if(g.preventDefault(),g.stopPropagation(),C.current)return;C.current=!0,o(async()=>{n(),await new Promise(R=>setTimeout(R,0)),q().finally(()=>C.current=!1)});return}if(k&&(g.shiftKey&&M==="s"||M==="enter")){if(g.preventDefault(),g.stopPropagation(),C.current)return;C.current=!0,o(async()=>{n(),await new Promise(R=>setTimeout(R,0)),U().finally(()=>C.current=!1)});return}M==="escape"&&(g.preventDefault(),g.stopPropagation(),o(()=>x()))};return window.addEventListener("keydown",h,!0),document.addEventListener("keydown",h,!0),()=>{window.removeEventListener("keydown",h,!0),document.removeEventListener("keydown",h,!0)}},[]);const[se,le]=a.useState(!1),de=a.useRef(null);function ue(){const n=Array.isArray(y?.ergehtAn)?[...y.ergehtAn]:[],o=(y?.ergehtAnText||"").trim();return o&&n.push(o),n}const we=async()=>{if(se)return;const n=ue();if(!n.length){Z?.("error","Bitte Empfänger wählen oder 'Sonstiger Empfänger' ausfüllen.");return}le(!0);try{const o=await _();if(!o)throw new Error("Speichern fehlgeschlagen");c(o);const g=(await fetch(`/api/protocol/${o}`).then(z=>z.json()))?.item;if(!g)throw new Error("Datensatz für Druck nicht gefunden");Z?.("info","PDF wird serverseitig erzeugt …");const M=await fetch(`/api/protocol/${o}/print`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({recipients:n,data:g})}).then(z=>z.json());if(!M?.ok||!M?.fileUrl)throw new Error(M?.error||"PDF-Erzeugung fehlgeschlagen");let k=de.current;k||(k=document.createElement("iframe"),k.style.position="fixed",k.style.width="0",k.style.height="0",k.style.border="0",k.style.visibility="hidden",document.body.appendChild(k),de.current=k);const R=`${M.fileUrl}#toolbar=0&navpanes=0&scrollbar=0`;k.onload=()=>{try{setTimeout(()=>{k.contentWindow?.focus(),k.contentWindow?.print()},100)}catch{window.open(R,"_blank","noopener,noreferrer")?.focus()}},k.src=R;const J=Number(M?.pages)||n.length;Z?.("success",`Druck gestartet (${J} Seite${J>1?"n":""})`)}catch(o){Z?.("error",`Drucken fehlgeschlagen: ${o.message||o}`)}finally{le(!1)}},x=()=>{window.location.hash="/protokoll"},_=async()=>{const n=B.current?new FormData(B.current):null,o=structuredClone(y);o.datum=wt(n?.get("datum")||y.datum),o.zeit=vt(n?.get("zeit")||y.zeit);const h=(n?.get("anvonDir")||y.anvon.richtung||"").toString(),g=(n?.get("anvonName")||y.anvon.name||"").toString();o.anvon={richtung:h,name:g};const M=(n?.get("richtung")||y.uebermittlungsart.richtung||"").toString();o.uebermittlungsart.richtung=M,o.uebermittlungsart.kanalNr=(n?.get("kanalNr")||y.uebermittlungsart.kanalNr||"").toString(),o.information=(n?.get("information")||y.information||"").toString(),o.rueckmeldung1=(n?.get("rueckmeldung1")||y.rueckmeldung1||"").toString(),o.rueckmeldung2=(n?.get("rueckmeldung2")||y.rueckmeldung2||"").toString(),o.ergehtAnText=(n?.get("ergehtAnText")||y.ergehtAnText||"").toString(),o.infoTyp=(n?.get("infoTyp")||y.infoTyp||"Information").toString();const k=n?Array.from(n.getAll("ergehtAn")).map(String):y.ergehtAn;o.ergehtAn=k.length?k:y.ergehtAn,o.massnahmen=o.massnahmen.map((J,z)=>{const me=n?n.get(`m_done_${z}`)!==null:J.done;return{massnahme:(n?.get(`m_massnahme_${z}`)||J.massnahme||"").toString(),verantwortlich:(n?.get(`m_verantwortlich_${z}`)||J.verantwortlich||"").toString(),done:!!me}});const R={...o,uebermittlungsart:{kanalNr:(o.uebermittlungsart.kanalNr||"").trim(),ein:o.uebermittlungsart.richtung==="ein",aus:o.uebermittlungsart.richtung==="aus"},anvon:o.anvon.richtung?`${o.anvon.richtung==="an"?"An":"Von"}: ${o.anvon.name}`.trim():o.anvon.name.trim()};try{const J=We([R.anvon,...JSON.parse(localStorage.getItem(fe.anvon)||"[]")]),z=We([R.uebermittlungsart.kanalNr,...JSON.parse(localStorage.getItem(fe.kanal)||"[]")]),me=[...o.massnahmen.map(be=>be.verantwortlich).filter(Boolean),...JSON.parse(localStorage.getItem(fe.verantwortlich)||"[]")],xe=We(me);localStorage.setItem(fe.anvon,JSON.stringify(J)),localStorage.setItem(fe.kanal,JSON.stringify(z)),localStorage.setItem(fe.verantwortlich,JSON.stringify(xe)),D(J),A(z),X(xe)}catch{}if(p){const J=await fetch(`/api/protocol/${r}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(R)}).then(z=>z.json());if(!J?.ok)throw new Error(J?.error||"Speichern fehlgeschlagen");return c(J.nr),O(J.id||S||null),J.nr}else{const J=await fetch("/api/protocol",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(R)}).then(z=>z.json());if(!J?.ok)throw new Error(J?.error||"Speichern fehlgeschlagen");return c(J.nr),O(J.id||null),J.nr}},q=async()=>{if(!v){E(!0);try{await _()&&(window.location.hash="/protokoll")}catch(n){Z("error","Fehler beim Speichern: "+n.message,4e3)}finally{E(!1)}}},U=async()=>{if(!v){E(!0);try{const n=await _();n&&(Z("success",`Gespeichert (NR ${n}) – neuer Eintrag`),G(Nt()),c(null),O(null),setTimeout(()=>L.current?.focus(),0))}catch(n){Z("error","Fehler beim Speichern: "+n.message,4e3)}finally{E(!1)}}},K=n=>{const o=(n.key||"").toLowerCase(),h=n.ctrlKey||n.metaKey;n.repeat||(h&&!n.shiftKey&&o==="s"?(n.preventDefault(),n.stopPropagation(),q()):h&&(n.shiftKey&&o==="s"||o==="enter")&&(n.preventDefault(),n.stopPropagation(),U()))},te=n=>{n.preventDefault(),q()};if(u)return e.jsx("div",{className:"p-4",children:"Lade…"});const Y=Ge.every(n=>y.ergehtAn.includes(n)),w=n=>$("ergehtAn",n?[...Ge]:[]);return e.jsxs("div",{className:"mx-auto w-full max-w-[1100px] relative",children:[e.jsx("div",{className:"prot-actionbar sticky top-0 z-30 -mx-2 md:mx-0 px-2 md:px-0",children:e.jsxs("div",{className:"bg-white/95 backdrop-blur border-b rounded-t-xl px-3 py-2 flex items-center justify-between shadow-sm",children:[e.jsx("div",{className:"text-sm font-semibold",children:p?`Protokoll – Bearbeiten (NR ${r??"—"})`:"Protokoll – Neuer Eintrag"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:x,className:"px-3 py-1.5 rounded-md border",title:"Maske schließen und zur Übersicht wechseln (ESC)",children:"Abbrechen"}),e.jsx("button",{type:"button",onClick:U,disabled:v,className:"px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white disabled:opacity-60",title:"Speichern und neue Maske (Strg+Shift+S oder Strg+Enter)",children:"Speichern/Neu"}),e.jsx("button",{type:"button",onClick:q,disabled:v,className:"px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-60",title:"Speichern und schließen (Strg+S)",children:v?"Speichern…":"Speichern"}),e.jsx("button",{type:"button",onClick:we,disabled:se,className:"px-3 py-1.5 rounded-md border bg-white hover:bg-gray-50 disabled:opacity-60",title:"Formular drucken – Anzahl gemäß 'ergeht an' + 'Sonstiger Empfänger'",children:se?"Drucken…":"Drucken"})]})]})}),W&&e.jsx("div",{className:"fixed right-3 top-3 z-40",children:e.jsx("div",{className:"px-3 py-2 rounded shadow text-white "+(W.type==="success"?"bg-emerald-600":W.type==="error"?"bg-rose-600":"bg-slate-600"),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{children:W.text}),e.jsx("button",{className:"opacity-80 hover:opacity-100",onClick:()=>Q(null),title:"Meldung schließen",children:"✕"})]})})}),e.jsx("style",{children:`
        @media print {
          * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          .prot-actionbar { display: none !important; }
          html, body { margin: 0 !important; }
          @page { size: A4; margin: 12mm; }
        }
      `}),e.jsxs("form",{ref:B,onKeyDown:K,onSubmit:te,className:"bg-white border-2 rounded-b-xl overflow-hidden shadow",children:[e.jsxs("div",{className:"grid grid-cols-12",children:[e.jsx("div",{className:"col-span-9 p-6 border-b-2",children:e.jsx("div",{className:"text-3xl font-extrabold tracking-wide",children:"MELDUNG/INFORMATION"})}),e.jsxs("div",{className:"col-span-3 border-l-2",children:[e.jsx("div",{className:"p-3 text-xs text-gray-600 border-b-2",children:"PROTOKOLL-NR"}),e.jsx("div",{className:"p-6 text-center text-4xl font-bold",children:r??"—"})]}),e.jsx("div",{className:"col-span-12 border-y-2 p-2",children:e.jsxs("div",{className:"grid grid-cols-12 gap-0",children:[e.jsxs("div",{className:"col-span-6 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Datum"}),e.jsx("input",{name:"datum",type:"text",className:"border rounded px-2 h-9 w-full",placeholder:"yyyy-mm-dd",value:y.datum,onChange:n=>$("datum",n.target.value),onBlur:n=>$("datum",wt(n.target.value)),title:"Datum (auch 101025 oder 10.10.2025 möglich)"})]}),e.jsxs("div",{className:"col-span-3 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Uhrzeit"}),e.jsx("input",{name:"zeit",type:"text",className:"border rounded px-2 h-9 w-full",placeholder:"hh:mm",value:y.zeit,onChange:n=>$("zeit",n.target.value),onBlur:n=>$("zeit",vt(n.target.value)),title:"Uhrzeit (915, 09:15 oder 0915 möglich)"})]}),e.jsxs("div",{className:"col-span-3 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Typ"}),e.jsxs("div",{className:"grid grid-cols-3 gap-x-6 h-9 items-center",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{ref:L,type:"radio",name:"infoTyp",value:"Information",checked:y.infoTyp==="Information",onChange:()=>$("infoTyp","Information")}),e.jsx("span",{children:"Info"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"infoTyp",value:"Auftrag",checked:y.infoTyp==="Auftrag",onChange:()=>$("infoTyp","Auftrag")}),e.jsx("span",{children:"Auftrag"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"infoTyp",value:"Lagemeldung",checked:y.infoTyp==="Lagemeldung",onChange:()=>$("infoTyp","Lagemeldung")}),e.jsx("span",{children:"Lage"})]})]})]})]})}),e.jsx("div",{className:"col-span-12 border-y-2 p-2",children:e.jsxs("div",{className:"grid grid-cols-12 gap-0 items-end",children:[e.jsxs("div",{className:"col-span-6 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"An/Von"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{ref:I,name:"anvonName",className:"border rounded px-2 h-9 w-full flex-1",placeholder:"Name / Stelle",list:"dl-anvon",value:y.anvon.name,onChange:n=>{let o=n.target.value;const h=o.trim();/^an\s*:/i.test(h)?($(["anvon","richtung"],"an"),o=h.replace(/^an\s*:/i,"").trim()):/^von\s*:/i.test(h)&&($(["anvon","richtung"],"von"),o=h.replace(/^von\s*:/i,"").trim()),$(["anvon","name"],o)},title:'Optional mit Präfix "an: …" oder "von: …"'}),e.jsxs("div",{className:"flex items-center gap-4 pl-2 min-w-[140px] shrink-0",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"anvonDir",value:"an",checked:y.anvon.richtung==="an",onChange:()=>$(["anvon","richtung"],"an")}),e.jsx("span",{children:"An"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"anvonDir",value:"von",checked:y.anvon.richtung==="von",onChange:()=>$(["anvon","richtung"],"von")}),e.jsx("span",{children:"Von"})]})]})]}),e.jsx("datalist",{id:"dl-anvon",children:j.map(n=>e.jsx("option",{value:n},n))})]}),e.jsxs("div",{className:"col-span-3 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Kanal"}),e.jsx("input",{name:"kanalNr",className:"border rounded px-2 h-9 w-full",list:"dl-kanal",value:y.uebermittlungsart.kanalNr,onChange:n=>$(["uebermittlungsart","kanalNr"],n.target.value),title:"z. B. Funkkanal, Telefonnummer, E-Mail-Kürzel …"}),e.jsx("datalist",{id:"dl-kanal",children:F.map(n=>e.jsx("option",{value:n},n))})]}),e.jsxs("div",{className:"col-span-3 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Richtung"}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-6 h-9 items-center",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",title:"Meldung wurde empfangen",children:[e.jsx("input",{type:"radio",name:"richtung",value:"ein",checked:y.uebermittlungsart.richtung==="ein",onChange:()=>$(["uebermittlungsart","richtung"],"ein")}),e.jsx("span",{children:"Eingang"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",title:"Meldung wurde gesendet",children:[e.jsx("input",{type:"radio",name:"richtung",value:"aus",checked:y.uebermittlungsart.richtung==="aus",onChange:()=>$(["uebermittlungsart","richtung"],"aus")}),e.jsx("span",{children:"Ausgang"})]})]})]})]})}),e.jsxs("div",{className:"col-span-12 border-y-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Information/Auftrag"}),e.jsx("textarea",{name:"information",className:"border rounded px-2 py-2 w-full min-h-[160px]",value:y.information,onChange:n=>$("information",n.target.value),title:"Sachverhalt / Meldetext"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Rückmeldung 1"}),e.jsx("input",{name:"rueckmeldung1",className:"border rounded px-2 h-9 w-full",value:y.rueckmeldung1,onChange:n=>$("rueckmeldung1",n.target.value),title:"erste Rückmeldung"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Rückmeldung 2"}),e.jsx("input",{name:"rueckmeldung2",className:"border rounded px-2 h-9 w-full",value:y.rueckmeldung2,onChange:n=>$("rueckmeldung2",n.target.value),title:"zweite Rückmeldung"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-2",children:"ergeht an:"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 mr-3",title:"Alle Empfänger auswählen / abwählen",children:[e.jsx("input",{type:"checkbox",checked:Y,onChange:n=>w(n.target.checked)}),e.jsx("span",{children:"Alle"})]}),Ge.map(n=>e.jsxs("label",{className:"inline-flex items-center gap-2 mr-3",children:[e.jsx("input",{tabIndex:-1,type:"checkbox",name:"ergehtAn",value:n,checked:y.ergehtAn.includes(n),onChange:()=>{const o=new Set(y.ergehtAn);o.has(n)?o.delete(n):o.add(n),$("ergehtAn",[...o])},title:`Empfänger ${n} ${y.ergehtAn.includes(n)?"entfernen":"hinzufügen"}`}),e.jsx("span",{children:n})]},n)),e.jsx("span",{className:"ml-2 text-xs text-gray-600",children:"sonstiger Empfänger:"}),e.jsx("input",{name:"ergehtAnText",className:"border rounded px-2 h-9",value:y.ergehtAnText,onChange:n=>$("ergehtAnText",n.target.value),placeholder:"Name/Gruppe"})]})]}),e.jsxs("div",{className:"col-span-12 border-t-2",children:[e.jsxs("div",{className:"grid grid-cols-12 bg-gray-50 border-b-2",children:[e.jsx("div",{className:"col-span-6 p-2 font-semibold border-r",children:"Maßnahme"}),e.jsx("div",{className:"col-span-5 p-2 font-semibold border-r",children:"Verantwortlich"}),e.jsx("div",{className:"col-span-1 p-2 font-semibold text-center",children:"Erledigt"})]}),y.massnahmen.map((n,o)=>e.jsxs("div",{className:"grid grid-cols-12 border-t",children:[e.jsx("div",{className:"col-span-6 p-2 border-r",children:e.jsx("input",{name:`m_massnahme_${o}`,className:"w-full border rounded px-2 h-9",value:n.massnahme,onChange:h=>{const g=[...y.massnahmen];g[o]={...n,massnahme:h.target.value},$("massnahmen",g)},title:`Maßnahme ${o+1}`})}),e.jsx("div",{className:"col-span-5 p-2 border-r",children:e.jsx("input",{name:`m_verantwortlich_${o}`,className:"w-full border rounded px-2 h-9",list:"dl-ver",value:n.verantwortlich,onChange:h=>{const g=[...y.massnahmen];g[o]={...n,verantwortlich:h.target.value},$("massnahmen",g)},title:`Verantwortlich ${o+1}`})}),e.jsx("div",{className:"col-span-1 p-2 flex items-center justify-center",children:e.jsx("input",{tabIndex:-1,type:"checkbox",name:`m_done_${o}`,value:"1",checked:!!n.done,onChange:h=>{const g=[...y.massnahmen];g[o]={...n,done:h.target.checked},$("massnahmen",g)},title:"Erledigt umschalten"})})]},o)),e.jsx("datalist",{id:"dl-ver",children:H.map(n=>e.jsx("option",{value:n},n))})]})]}),e.jsx("button",{type:"submit",className:"hidden",children:"submit"})]})]})}function Kn({disabled:s=!1}){const[i,r]=a.useState(!1),[c,p]=a.useState(!1),[u,f]=a.useState(""),[v,E]=a.useState({remainingMin:null,idleMinutes:null,lastActivityIso:null,autoStopMin:null}),[S,O]=a.useState({lastLoadedIso:null,file:"list_filtered.json"}),[I,L]=a.useState(!1),[C,B]=a.useState(30),[W,Q]=a.useState(null),V=a.useRef(!1),Z=async()=>{try{const[j,D,F]=await Promise.all([fetch("/api/ff/status",{credentials:"include",cache:"no-store"}).then(A=>A.json()).catch(()=>({running:!1})),fetch("/api/ff/creds",{credentials:"include",cache:"no-store"}).then(A=>A.json()).catch(()=>({has:!1})),fetch("/api/import/auto-config",{credentials:"include",cache:"no-store"}).then(A=>A.json()).catch(()=>({enabled:!1,intervalSec:30}))]);r(!!j.running),p(!!D.has),L(!!F.enabled),B(Number(F.intervalSec||30)),V.current||(V.current=!0,D.has||f("Keine globalen Fetcher-Zugangsdaten. Bitte als Admin unter /user-admin setzen."))}catch{}};return a.useEffect(()=>{Z();const j=setInterval(Z,3e3);return()=>clearInterval(j)},[]),a.useEffect(()=>{let j;const D=async()=>{try{const F=await fetch("/api/activity/status",{credentials:"include",cache:"no-store"});if(F.ok){const A=await F.json(),H=Number(A.idleMinutes),X=Number(A.autoStopMin),y=Math.max(0,Math.ceil(X-H));E({remainingMin:y,idleMinutes:H,lastActivityIso:A.lastActivityIso,autoStopMin:X}),r(!!A.fetcher?.running),O({lastLoadedIso:A.import?.lastLoadedIso??null,file:A.import?.file||"list_filtered.json"})}}catch{}};return D(),j=setInterval(D,1e3),()=>clearInterval(j)},[]),a.useEffect(()=>{let j;const D=()=>{if(!I||!S.lastLoadedIso){Q(null);return}const A=new Date(S.lastLoadedIso).getTime()+C*1e3,H=Math.max(0,Math.ceil((A-Date.now())/1e3));Q(H)};return D(),j=setInterval(D,1e3),()=>clearInterval(j)},[I,C,S.lastLoadedIso]),e.jsxs("div",{className:`flex items-center h-9 gap-2 ${s?"opacity-60 pointer-events-none":""}`,style:{alignItems:"center"},children:[e.jsx("span",{className:`sync-chip ${I?"active":""}`,title:I?"Auto-Import Countdown":"Auto-Import ist deaktiviert",style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:"110px",minWidth:"110px",textAlign:"center"},children:I?`⟳ in ${W??"–"}s`:"⏸ manuell"}),u&&e.jsx("span",{style:{color:"#dc2626",fontSize:12,marginLeft:8},children:u}),i&&v.remainingMin!=null&&v.remainingMin<=15&&e.jsxs("div",{title:`Letzte Aktivität: ${v.lastActivityIso?new Date(v.lastActivityIso).toLocaleString():"–"} • Inaktiv: ${v.idleMinutes?.toFixed?.(1)} min • Limit: ${v.autoStopMin} min`,className:"ml-2 inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border "+(v.remainingMin<=5?"bg-red-50 text-red-700 border-red-300":v.remainingMin<=15?"bg-amber-50 text-amber-700 border-amber-300":"bg-blue-50 text-blue-700 border-blue-300"),children:[e.jsx("span",{className:"mr-2 h-2 w-2 rounded-full bg-current",style:{animation:"pulse 1.5s ease-in-out infinite"}}),e.jsxs("span",{children:["Auto-Import stoppt in ",e.jsxs("b",{children:[v.remainingMin," min"]})]})]}),e.jsx("div",{title:`Quelle: ${S.file}`,className:"ml-2 inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border bg-white text-gray-700",style:{borderColor:"#cbd5e1"},children:e.jsxs("span",{children:["Zuletzt geladen:"," ",e.jsx("b",{children:S.lastLoadedIso?new Date(S.lastLoadedIso).toLocaleTimeString("de-AT",{hour12:!1}):"–"})]})})]})}function Un(){const[s]=a.useState(.9);return s}const Gn=s=>`card:${s}`,Ne=!0;async function Wn(s){if(!s||!window.google?.maps?.Geocoder)return null;const i=new google.maps.Geocoder;return new Promise(r=>{i.geocode({address:s,region:"AT"},(c,p)=>{if(p==="OK"&&c&&c[0]){const u=c[0],f=u.geometry?.location;r({lat:f?.lat?.(),lng:f?.lng?.(),formatted:u.formatted_address||s})}else r(null)})})}function Hn(){Un();const[s,i]=a.useState(!1);a.useEffect(()=>{mn().then(()=>i(!0))},[]);const r=s&&kt("einsatzboard"),c=!r,[p,u]=a.useState(null),[f,v]=a.useState([]),[E,S]=a.useState([]),[O,I]=a.useState(""),[L,C]=a.useState(""),[B,W]=a.useState(""),[Q,V]=a.useState(null),[Z,j]=a.useState(null),[D,F]=a.useState(""),[A,H]=a.useState(!1),[X,y]=a.useState(!1),[G,$]=a.useState(!1),[se,le]=a.useState(30),[de,ue]=a.useState(!1),[we,x]=a.useState(!1),[_,q]=a.useState(!1),[U,K]=a.useState(null),te=t=>{K(t),q(!0)},[Y,w]=a.useState(window.location.hash);a.useEffect(()=>{const t=()=>w(window.location.hash);return window.addEventListener("hashchange",t),()=>window.removeEventListener("hashchange",t)},[]);const n=Y.replace(/^#/,""),[o,h]=a.useState(()=>new Set),[g,M]=a.useState(0),k=a.useRef(0),R=a.useRef(new Set),[J,z]=a.useState(0);a.useEffect(()=>{document.title="Einsatzstellen-Übersicht-Feuerwehr",Et()},[]),a.useEffect(()=>{if(!r)return;if(!G){z(0);return}const t=setInterval(()=>z(l=>l+1),1e3);return()=>clearInterval(t)},[Ne,G]);const me=G?Math.max(0,se-J%Math.max(1,se)):0,{query:xe,setQuery:be,predictions:He,getDetailsByPlaceId:Pt,resetSession:Ee,loading:At,error:Ze}=Ct({country:"at",debounceMs:300,minLength:3}),Pe=a.useRef(null);a.useEffect(()=>{document.title="Einsatzstellen-Übersicht-Feuerwehr"},[]),a.useEffect(()=>{(async()=>{const[t,l,d]=await Promise.all([ae(),ot(),kn()]);u(t),v(l),S(Array.isArray(d)?d:[]);try{const m=await En();$(!!m.enabled),le(Number(m.intervalSec)||30),Ae.current=Qe(t)}catch{}z(0)})()},[Ne]),a.useEffect(()=>{G&&(async()=>{try{(await fetch("/api/ff/status",{credentials:"include",cache:"no-store"}).then(l=>l.json()).catch(()=>({running:!1}))).running||await fetch("/api/ff/start",{method:"POST",credentials:"include"})}catch{}})()},[Ne,G,se]),a.useEffect(()=>{C(xe||"")},[xe]),a.useEffect(()=>{let t;const l=Math.max(5,Math.min(60,G?8:15)),d=async()=>{try{const m=new Set(Ae.current),b=await ae();u(b),Ye({oldIds:m,newBoard:b,pulseMs:8e3})}catch{}t=setTimeout(d,l*1e3)};return t=setTimeout(d,l*1e3),()=>clearTimeout(t)},[Ne,G]),a.useEffect(()=>{const t=l=>{l.altKey&&(l.key==="e"||l.key==="E")&&(l.preventDefault(),x(!0),Ee())};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[Ne,Ee]);const ie=p??{columns:{neu:{items:[]},"in-bearbeitung":{items:[]},erledigt:{items:[]}}},Tt=10;function Mt(t){try{const l=t?.columns||{};return[(l.neu?.items||[]).length,(l["in-bearbeitung"]?.items||[]).length,(l.erledigt?.items||[]).length].some(m=>m>=Tt)}catch{return!1}}a.useEffect(()=>{const t=Mt(ie);document.documentElement.classList.toggle("ui-dense",t)},[ie]);const[De,qe]=a.useState(new Set),Ae=a.useRef(new Set);a.useEffect(()=>{if(!De.size)return;const t=setTimeout(()=>qe(new Set),9e3);return()=>clearTimeout(t)},[De]);function Qe(t){const l=new Set;if(!t?.columns)return l;for(const d of Object.keys(t.columns))for(const m of t.columns[d].items||[])l.add(String(m.id));return l}function Ye({oldIds:t,newBoard:l,pulseMs:d=8e3}){const m=Date.now(),b=Qe(l),N=new Set;for(const T of b)t.has(T)||N.add(T);const P=new Set([...N].filter(T=>!R.current.has(String(T))));for(const T of N)R.current.delete(String(T));if(P.size>0&&(qe(P),M(m+d),m>=k.current))try{Fn()}catch{}Ae.current=b}const[Re,Xe]=a.useState(!1),$t=async()=>{if(!Re){Xe(!0);try{const t=new Set(Ae.current),l=await fetch("/api/import/trigger",{method:"POST"});if(!l.ok){const m=await l.text().catch(()=>"");throw new Error(`Import fehlgeschlagen (HTTP ${l.status}) ${m}`)}const d=await ae();u(d),Ye({oldIds:t,newBoard:d,pulseMs:8e3}),z(0)}catch(t){alert(t.message||"Import fehlgeschlagen.")}finally{Xe(!1)}}},[Ot,et]=a.useState(!1),Dt=t=>String(t).replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function Rt(t,l){const d=String(l).match(/^(.*?)-(\d+)$/),m=d?d[1]:String(l);let b=d?parseInt(d[2],10):1;for(const N of t){const P=String(N.label||"").match(new RegExp("^"+Dt(m)+"-(\\d+)$"));if(!P)continue;const T=parseInt(P[1],10);Number.isFinite(T)&&T>b&&(b=T)}return`${m}-${b+1}`}async function Lt(t,l){if(Ot)return;const d=ve.get(t);if(d){et(!0);try{const m=Rt(f,d.label||d.id),b=await fetch("/api/vehicles",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ort:d.ort||"",label:m,mannschaft:0})}),N=await b.json().catch(()=>({}));if(!b.ok||N?.error)throw new Error(N?.error||"Clone fehlgeschlagen");const T=await(await fetch("/api/vehicles")).json();v(T);let ne=N?.vehicle?.id;ne||(ne=T.find(ye=>ye.label===m&&ye.ort===(d.ort||"")&&Number(ye.mannschaft)===0)?.id),l&&ne&&await Ke(l,ne),u(await ae())}catch(m){alert(m.message||"Clone fehlgeschlagen")}finally{et(!1)}}}const ve=a.useMemo(()=>new Map(f.map(t=>[t.id,t])),[f]),[tt,nt]=a.useState(new Map),_t=a.useMemo(()=>{const t={};for(const[l,d]of ve.entries())t[l]=d;return t},[ve]),st=a.useMemo(()=>{const t=new Set,l=ie?.columns||{};for(const d of Object.keys(l))for(const m of l[d].items||[])for(const b of m.assignedVehicles||[])t.add(b);return t},[ie]),je=a.useMemo(()=>f.filter(t=>t&&typeof t.id<"u"&&!st.has(t.id)),[f,st]),he=a.useMemo(()=>{const t={};for(const l of je){const d=l.ort||"Unbekannt";(t[d]??=[]).push(l)}for(const l of Object.keys(t))t[l].sort((d,m)=>(d.label||d.id).localeCompare(m.label||m.id));return Object.entries(t).sort((l,d)=>l[0].localeCompare(d[0]))},[je]);a.useEffect(()=>{if(localStorage.getItem("ff_collapsed_groups")||!he.length)return;const l=he.map(([d])=>d);Te(new Set(l)),localStorage.setItem("ff_collapsed_groups",JSON.stringify(l))},[Ne,he]),a.useEffect(()=>{let t=setInterval(async()=>{try{const l=await fetch("/api/activity/status",{cache:"no-store"}).then(d=>d.json());typeof l?.auto?.enabled=="boolean"&&l.auto.enabled!==G&&$(!!l.auto.enabled)}catch{}},3e3);return()=>clearInterval(t)},[Ne,G]);function Le(t,l){for(const d of["neu","in-bearbeitung","erledigt"])if((t.columns[d].items||[]).some(m=>m?.id===l))return d;return null}function zt(t,l){for(const d of["neu","in-bearbeitung","erledigt"]){const m=(t.columns[d].items||[]).find(b=>b?.id===l);if(m)return m}return null}function _e(t){const l=ie?.columns?.[t]?.items||[];if(t==="erledigt"){const b=l.reduce((P,T)=>P+(T.everVehicles?.length||0),0),N=l.reduce((P,T)=>P+(Number.isFinite(T?.everPersonnel)?T.everPersonnel:0),0);return{cards:l.length,units:b,persons:N}}const d=l.reduce((b,N)=>b+(N.assignedVehicles?.length||0),0),m=l.reduce((b,N)=>Number.isFinite(N?.manualPersonnel)?b+N.manualPersonnel:b+(N.assignedVehicles||[]).reduce((P,T)=>P+(ve.get(T)?.mannschaft??0),0),0);return{cards:l.length,units:d,persons:m}}const Ft=_e("neu"),Bt=_e("in-bearbeitung"),Vt=_e("erledigt"),Kt=async()=>{const t=B.replace(/^T\d+\s*,?\s*/i,"").trim(),l=(O||t).trim();if(!l){alert("Bitte Typ oder Titel angeben.");return}const d={id:`tmp-${Math.random().toString(36).slice(2,10)}`,content:l,createdAt:new Date().toISOString(),statusSince:new Date().toISOString(),assignedVehicles:[],everVehicles:[],everPersonnel:0,ort:(L||"").trim(),typ:B.trim()};H(!0),u(m=>{if(!m)return m;const b=structuredClone(m);return b.columns.neu.items.unshift(d),b});try{let m=null;const b=Pe.current;if(b?.geometry?.location?.lat&&b?.geometry?.location?.lng)m={lat:b.geometry.location.lat(),lng:b.geometry.location.lng()};else if(d.ort){const P=await Wn(d.ort);P&&(m={lat:P.lat,lng:P.lng})}const N=await lt(l,"neu",0,d.ort,d.typ,m??void 0);k.current=Date.now(),N?.card?.id!=null&&R.current.add(String(N.card.id)),u(P=>{if(!P)return P;const T=structuredClone(P),ne=T.columns.neu.items,ke=ne.findIndex(ye=>ye?.id===d.id);return ke>=0?ne[ke]=N.card:ne.unshift(N.card),T}),I(""),be(""),C(""),W(""),Pe.current=null,Ee()}catch{u(m=>{if(!m)return m;const b=structuredClone(m);return b.columns.neu.items=b.columns.neu.items.filter(N=>N?.id!==d.id),b}),alert("Einsatz konnte nicht angelegt werden.")}finally{H(!1)}},Ut=async t=>{try{const l=await Pt(t.place_id,["formatted_address","geometry","address_components","place_id"]);Pe.current=l||null;const d=l?.formatted_address||t.description;be(d),C(d)}catch(l){console.error("Place details failed:",l),Pe.current=null,be(t.description),C(t.description)}finally{Ee()}},ze=t=>String(t||"").split(/[;,\n]/).map(l=>l.trim()).filter(Boolean),ce=t=>String(t||"").normalize?.("NFD").replace?.(new RegExp("\\p{Diacritic}","gu"),"").replace(/^\s*FF\s+/i,"").replace(/[._\-\/]+/g," ").replace(/\s+/g," ").toLowerCase().trim();function Gt(t,l,d,m){const b=ze(t?.alerted).map(ce);if(b.length)for(const N of l){const P=b.some(ne=>ce(N?.ort)===ne),T=b.some(ne=>ce(N?.label)===ne);if(P||T){const ne=String(N.id);d.add(ne),m.has(ne)||m.set(ne,null)}}}async function Wt(t,l){if(!(l!=="neu"||!t?.id))try{const d=await An(t.id),m=new Set((d?.units||[]).map(ee=>String(ee.unitId)));if(t?.alerted){const ee=ze(t.alerted).map(ce);for(const ge of je){const Be=ee.some(Ve=>ce(ge.ort)===ce(Ve)),Ie=ee.some(Ve=>ce(ge.label)===ce(Ve));(Be||Ie)&&m.add(String(ge.id))}}h(m),M(Date.now()+3e3);const b=new Map;for(const ee of d?.units||[]){const ge=Number(ee?.distanceKm);b.set(String(ee.unitId),Number.isFinite(ge)?ge:null)}m.size===0&&t?.alerted&&Gt(t,je,m,b),nt(b);const N=new Set((d?.units||[]).filter(ee=>!ee.assigned).map(ee=>String(ee.unitId))),P=new Set(je.map(ee=>String(ee.id))),T=new Set([...N,...[...m].filter(ee=>P.has(ee))]),ne=ze(t?.alerted).map(ce),ke=new Set;if(ne.length&&je.length>0)for(const[ee,ge]of he){if(ge.length===0)continue;ne.some(Ie=>ce(ee)===ce(Ie))&&ke.add(ee)}const ye=[];for(const[ee,ge]of he)(ge.some(Ie=>T.has(String(Ie.id)))||ke.has(ee))&&ye.push(ee);Zt(ye),clearTimeout(pulseTimerRef.current),pulseTimerRef.current=setTimeout(()=>{h(new Set),M(0),nt(new Map)},3200)}catch(d){console.error("fetchNearby failed:",d)}}const[at,Te]=a.useState(()=>{try{const t=localStorage.getItem("ff_collapsed_groups");return new Set(t?JSON.parse(t):[])}catch{return new Set}}),Jt=t=>at.has(t),Ht=(t,l)=>{Te(d=>{const m=new Set(d);return l?m.add(t):m.delete(t),localStorage.setItem("ff_collapsed_groups",JSON.stringify([...m])),m})},Zt=(t=[])=>{Te(()=>{const l=he.map(([m])=>m),d=new Set(l);for(const m of t)d.delete(m);return localStorage.setItem("ff_collapsed_groups",JSON.stringify([...d])),d})},qt=(t=!0)=>{Te(()=>{const l=he.map(([m])=>m),d=t?new Set(l):new Set;return localStorage.setItem("ff_collapsed_groups",JSON.stringify([...d])),d})},Qt=()=>{const t=he.map(([d])=>d),l=t.length>0&&t.every(d=>at.has(d));qt(!l)},[Me,Fe]=a.useState(null),[Yt,Se]=a.useState(null),Xt=hn(rt(vn,{activationConstraint:{distance:4}}),rt(wn,{activationConstraint:{delay:80,tolerance:6}})),en=t=>{const l=t?.over;if(!l){Se(null);return}const d=String(l.id||"");if(d.startsWith("col:"))Se(d.slice(4));else if(d.startsWith("card:")){const m=Le(ie,d.slice(5));Se(m)}else Se(null)},tn=async t=>{if(c){Se(null),Fe(null);return}Se(null);const{active:l,over:d}=t;if(Fe(null),!l||!d)return;const m=String(l.id||""),b=String(d.id||"");if(m.startsWith("ass:")&&b.startsWith("card:")){const[,N,P]=m.split(":"),T=b.slice(5);if(N&&P&&T&&N!==T)try{await ct(N,P);try{await mt(P)}catch{}await Ke(T,P),u(await ae())}catch{alert("Einheit konnte nicht umgehängt werden.")}return}if(m.startsWith("veh:")&&b.startsWith("card:")){try{await Ke(b.slice(5),m.slice(4)),u(await ae())}catch{alert("Einheit konnte nicht zugewiesen werden.")}return}if(m.startsWith("card:")){const N=m.slice(5),P=Le(ie,N);if(!P)return;if(b.startsWith("col:")){const T=b.slice(4);if(P!==T)try{await $e({cardId:N,from:P,to:T,toIndex:0}),u(await ae())}catch{alert("Statuswechsel konnte nicht gespeichert werden.")}return}if(b.startsWith("card:")){const T=Le(ie,b.slice(5));if(T)try{await $e({cardId:N,from:P,to:T,toIndex:0}),u(await ae())}catch{alert("Statuswechsel konnte nicht gespeichert werden.")}}}},nn=async()=>{if(confirm("Board wirklich zurücksetzen?")){y(!0);try{await Cn(),u(await ae())}catch{alert("Reset fehlgeschlagen.")}finally{y(!1)}}},sn=()=>window.open(Pn(),"_blank","noopener,noreferrer"),an=async()=>{try{const t=await dt({enabled:!G,intervalSec:se});$(!!t.enabled),le(Number(t.intervalSec)||30),z(0)}catch{alert("Konnte Auto-Import nicht ändern.")}},rn=async t=>{const l=Math.max(5,Math.min(3600,Number(t)||30));le(l);try{await dt({enabled:G,intervalSec:l}),z(0)}catch{}},on=async({title:t,ort:l,typ:d})=>{const m=await lt(t,"neu",0,l,d);k.current=Date.now(),m?.card?.id!=null&&R.current.add(String(m.card.id)),u(b=>{if(!b)return b;const N=structuredClone(b);return N.columns.neu.items.unshift(m.card),N})},ln=t=>{W(t);const l=t.replace(/^T\d+\s*,?\s*/i,"").trim();O.trim()||I(l)};if(n.startsWith("/protokoll/edit/")){const t=n.split("/")[3],l=Number(t);return e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Protokoll – Bearbeiten"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"Zur Übersicht"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(jt,{mode:"edit",editNr:l})})]})}return n.startsWith("/protokoll/neu")?e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Protokoll – Eintrag anlegen"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"Zur Übersicht"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(jt,{mode:"create"})})]}):n.startsWith("/protokoll")?e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Protokoll"}),e.jsx("button",{onClick:()=>{window.location.hash="/"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"← Zurück"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(Vn,{})})]}):e.jsxs("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden flex flex-col",style:{fontSize:"var(--ui-scale)"},children:[!p&&e.jsx("div",{className:"fixed inset-0 z-10 bg-black/10 backdrop-blur-sm flex items-center justify-center",children:e.jsx("div",{className:"px-4 py-2 rounded-lg bg-white shadow",children:"Lade…"})}),e.jsxs("header",{className:"flex flex-wrap items-center justify-between gap-2 mb-2",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:"Einsatzstellen-Übersicht-Feuerwehr"}),e.jsxs("div",{className:"toolbar flex flex-wrap items-center gap-2",children:[e.jsx("button",{onClick:sn,className:"px-3 py-1.5 rounded-md bg-purple-600 hover:bg-purple-700 text-white",children:"PDF"}),e.jsx("button",{onClick:()=>window.open("/api/log.csv","_blank"),className:"px-3 py-1.5 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white",title:"log.csv herunterladen",children:"Log (CSV)"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-500 hover:bg-gray-600 text-white",children:"Protokoll"}),e.jsx("button",{onClick:$t,disabled:c||Re,className:"px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-60",title:"Import sofort ausführen",children:Re?"Import…":"Import"}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm px-2 py-1 rounded-md bg-white border",children:[e.jsx("input",{type:"checkbox",checked:G,onChange:an,disabled:c})," Auto-Import"]}),e.jsxs("label",{className:"interval-capsule flex items-center text-sm text-gray-700 bg-gray-50 border border-gray-300 rounded-md overflow-hidden",children:[e.jsx("span",{className:"pl-3 pr-2 select-none",children:"Intervall (s):"}),e.jsx("input",{type:"number",min:"5",max:"3600",value:se,onChange:t=>rn(t.target.value),disabled:c,className:`h-9 w-20 bg-white border-0 rounded-none text-center text-gray-800 
               focus:outline-none focus:ring-0 focus:border-0`})]}),e.jsx(Kn,{autoEnabled:G,remaining:me,disabled:c}),e.jsx("button",{onClick:nn,disabled:c||X,className:`px-3 py-1.5 rounded-md text-white ${X?"bg-gray-400":"bg-gray-700 hover:bg-gray-800"}`,children:X?"Reset…":"Reset"})]})]}),e.jsxs("section",{className:"mb-2 grid grid-cols-1 md:grid-cols-7 gap-2",children:[e.jsxs("select",{className:"border rounded px-2 py-1 md:col-span-2",value:B,onChange:t=>ln(t.target.value),children:[e.jsx("option",{value:"",children:"— Typ auswählen —"}),E.map(t=>e.jsx("option",{value:t,children:t},t))]}),e.jsx("input",{className:"border rounded px-2 py-1 md:col-span-2",placeholder:"Titel (wird aus Typ übernommen)",value:O,onChange:t=>I(t.target.value)}),e.jsxs("div",{className:"relative md:col-span-2",children:[e.jsx("input",{className:"border rounded px-2 py-1 w-full",placeholder:"Ort (nur Österreich)",autoComplete:"off",value:xe,onChange:t=>be(t.target.value)}),At&&e.jsx("div",{className:"absolute z-10 mt-1 text-xs text-gray-500 bg-white border rounded px-2 py-1",children:"Suche…"}),Ze&&e.jsxs("div",{className:"absolute z-10 mt-1 text-xs text-red-600 bg-white border rounded px-2 py-1",children:["Fehler: ",String(Ze)]}),!!He.length&&e.jsx("ul",{className:"absolute z-10 mt-1 w-full max-h-52 overflow-auto bg-white border rounded shadow",children:He.map(t=>e.jsx("li",{className:"px-2 py-1 hover:bg-gray-100 cursor-pointer text-sm",onClick:()=>Ut(t),title:t.description,children:t.description},t.place_id))})]}),e.jsx("button",{className:"px-3 py-1 rounded bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60",disabled:c||A,onClick:Kt,children:A?"Wird angelegt…":"Einsatz anlegen"})]}),e.jsxs(gn,{sensors:Xt,collisionDetection:t=>t?.active?.data?.current?.type==="vehicle"?pn(t):fn(t),onDragStart:t=>Fe({type:t?.active?.data?.current?.type,id:t.active.id,data:t?.active?.data?.current}),onDragOver:en,onDragEnd:tn,children:[e.jsxs("main",{className:"grid grid-cols-1 md:[grid-template-columns:minmax(180px,220px)_repeat(3,minmax(0,1fr))] gap-2 min-h-0 flex-1 overflow-hidden",children:[e.jsxs("section",{className:"bg-white rounded-xl shadow p-3 h-full flex flex-col min-h-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-semibold",children:e.jsx("button",{type:"button",onClick:Qt,title:"Alle Gruppen auf/zu klappen",className:"underline decoration-dotted hover:opacity-80 focus:outline-none",children:"Einheiten (frei)"})}),r&&e.jsx("button",{onClick:()=>ue(!0),className:"px-2 py-1 text-sm rounded bg-emerald-600 text-white",children:"+ Einheit"})]}),e.jsxs("div",{className:"overflow-auto pr-1 flex-1 min-h-0 space-y-3",children:[he.length===0&&e.jsx("div",{className:"text-[0.85rem] text-gray-500 italic",children:"— alle Einheiten sind zugewiesen —"}),he.map(([t,l])=>{const d=Jt(t);return e.jsxs("div",{className:"border border-blue-400 rounded-md",children:[e.jsxs("button",{type:"button",onClick:()=>Ht(t,!d),className:"w-full flex items-center justify-between px-2 py-2 text-left",title:d?"aufklappen":"zuklappen",children:[e.jsx("span",{className:"text-xs font-semibold text-gray-700",children:t}),e.jsx("span",{className:"group-chip",children:l.length})]}),!d&&e.jsx("div",{className:"px-2 pb-2 grid grid-cols-1 gap-1.5",children:l.map(m=>e.jsx(jn,{editable:r,vehicle:m,pillWidthPx:160,near:o.has(String(m.id))&&Date.now()<g,distKm:tt.get(String(m.id))},m.id))})]},t)})]})]}),[{id:"neu",title:"Neu",bg:"bg-red-100",totals:Ft},{id:"in-bearbeitung",title:"In Bearbeitung",bg:"bg-yellow-100",totals:Bt},{id:"erledigt",title:"Erledigt",bg:"bg-green-100",totals:Vt}].map(({id:t,title:l,bg:d,totals:m})=>e.jsx("div",{className:Yt===t?"drag-over":"",children:e.jsx(_n,{editable:r,colId:t,bg:d,title:e.jsxs("span",{className:"column-header flex items-center justify-between",children:[e.jsx("span",{className:"font-semibold",children:l}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsxs("span",{className:"kpi-badge","data-variant":"units",children:["🚒 ",m.units]}),e.jsxs("span",{className:"kpi-badge","data-variant":"persons",children:["👥 ",m.persons]}),e.jsxs("span",{className:"kpi-badge","data-variant":"cards",children:["⬛ ",m.cards]})]})]}),children:e.jsx("ul",{className:"space-y-2 overflow-y-auto overflow-x-hidden pl-1 pr-2 py-2",style:{maxHeight:"calc(100vh - 260px)"},children:e.jsx(xn,{items:(ie.columns[t].items||[]).map(b=>Gn(b.id)),strategy:bn,children:(ie.columns[t].items||[]).map(b=>e.jsx(Nn,{editable:r,card:b,colId:t,vehiclesById:ve,distById:tt,pillWidthPx:160,pulse:De.has(String(b.id))&&Date.now()<g,onUnassign:async(N,P)=>{await ct(N,P);try{await mt(P)}catch{}u(await ae())},onOpenMap:N=>V({address:b.ort,card:b,board:ie,vehiclesById:_t}),onAdvance:r?async N=>{t==="neu"?(await $e({cardId:N.id,from:"neu",to:"in-bearbeitung",toIndex:0}),u(await ae())):t==="in-bearbeitung"&&(await $e({cardId:N.id,from:"in-bearbeitung",to:"erledigt",toIndex:0}),u(await ae()))}:void 0,onEditPersonnelStart:r?(N,P)=>{j({cardId:N.id}),F(P)}:void 0,editing:Z,editingValue:D,setEditingValue:F,onEditPersonnelSave:r?async N=>{try{await In(N.id,D===""?null:Number(D)),u(await ae())}finally{j(null),F("")}}:void 0,onEditPersonnelCancel:r?()=>{j(null),F("")}:void 0,onClone:Lt,onVehiclesIconClick:Wt,nearIds:o,nearUntilMs:g,onShowInfo:te},b.id))})})})},t))]}),e.jsxs(yn,{dropAnimation:{duration:180,easing:"ease-out"},children:[Me?.type==="vehicle"&&(()=>{const t=ve.get(Me?.data?.vehicleId);return t?e.jsx("div",{className:"pointer-events-none",children:e.jsxs("div",{style:{width:160},className:"max-w-full select-none border-2 border-red-300 rounded-2xl bg-white px-2 py-1 shadow-lg",children:[e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:t.label||t.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate",children:[t.ort||"—"," · 👥 ",t.mannschaft??0]})]})}):null})(),Me?.type==="card"&&(()=>{const t=String(Me?.id||"").replace(/^card:/,""),l=zt(ie,t);return l?e.jsx("div",{className:"pointer-events-none w-[280px]",children:e.jsxs("div",{className:"rounded-lg bg-white shadow-xl border p-3",children:[e.jsx("div",{className:"font-semibold text-sm mb-1 truncate",children:l.content}),e.jsxs("div",{className:"text-xs text-gray-600",children:[l.assignedVehicles?.length||0," Einheiten •"," ","👥 ",Number.isFinite(l?.manualPersonnel)?l.manualPersonnel:(l.assignedVehicles||[]).reduce((d,m)=>d+(ve.get(m)?.mannschaft??0),0)]})]})}):null})()]})]}),r&&e.jsx("button",{className:"fab",title:"Einsatz anlegen",onClick:()=>x(!0),children:"＋"}),e.jsx("a",{href:"/Hilfe.pdf",target:"_blank",rel:"noopener noreferrer",className:"fixed bottom-4 right-4 px-4 py-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-lg",children:"Hilfe"}),de&&e.jsx(Dn,{onClose:()=>ue(!1),onCreate:async t=>{const l=await fetch("/api/vehicles",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!l.ok){const d=await l.text().catch(()=>String(l.status));throw new Error(`HTTP ${l.status} ${d}`)}v(await ot())}}),we&&e.jsx(Ln,{onClose:()=>x(!1),onCreate:on,types:E}),Q&&e.jsx(On,{context:Q,onClose:()=>V(null)}),e.jsx(zn,{open:_,info:U||{},onClose:()=>{q(!1),K(null)}})]})}export{Hn as default};
