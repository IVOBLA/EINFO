import{u as Ct,j as e,r as s,a as mn,C as hn,b as gn,i as Qe,c as Ye,d as pn,e as fn,f as xn,g as ct,D as bn,h as yn,k as wn,S as vn,v as jn,l as Nn,p as Sn,T as kn,P as Cn}from"./index-B7RT0hgL.js";function dt({cardId:t,vehicle:r,pillWidthPx:i=160,onUnassign:l,onClone:m,near:g=!1,distKm:h=null,readonly:p=!1}){const w=`ass:${t}:${r.id}`,b=p?null:Ct({id:w,data:{type:"assigned",vehicleId:r.id,fromCardId:t}}),V=b?.attributes??{},k=b?.listeners??{},M=b?.setNodeRef??(()=>{}),L=b?.transform??null,v=b?.isDragging??!1,D={width:i,transform:L?`translate3d(${L.x}px, ${L.y}px, 0)`:void 0};return e.jsxs("div",{ref:M,style:D,...V,...k,className:`relative self-start border-2 rounded-2xl bg-white px-2 pr-9 py-1 shadow-sm
                  select-none cursor-grab active:cursor-grabbing
                  ${g?"border-emerald-500 ring-2 ring-emerald-300":"border-red-300"}
                  ${v?"opacity-50":""}`,title:"Ziehen: auf andere Karte verschieben Â· Doppelklick: klonen",onDoubleClick:()=>{p||m?.(r.id,t)},children:[g&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-0.5 rounded-2xl border-2 border-emerald-400/50 animate-ping"}),e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:r.label||r.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate flex justify-between items-center",children:[e.jsxs("span",{children:[r.ort||"â€”"," Â· ðŸ‘¥ ",r.mannschaft??0]}),g&&Number.isFinite(Number(h))&&e.jsxs("span",{className:"absolute top-1 right-8 text-[11px] tabular-nums text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded whitespace-nowrap",children:[Number(h)," Km"]})]}),!p&&e.jsx("button",{type:"button",onMouseDown:T=>T.stopPropagation(),onTouchStart:T=>T.stopPropagation(),onClick:T=>{T.stopPropagation(),l?.(t,r.id)},title:"Einheit entfernen",className:"absolute right-2 top-1/2 -translate-y-1/2 h-6 w-6 rounded-full bg-red-600 text-white shadow flex items-center justify-center","aria-label":"Einheit entfernen",children:e.jsx("svg",{viewBox:"0 0 12 12",width:"12",height:"12","aria-hidden":"true",children:e.jsx("path",{d:"M1 1 L11 11 M11 1 L1 11",stroke:"white",strokeWidth:"2",strokeLinecap:"round"})})})]})}function In(t){const{card:r,colId:i,vehiclesById:l,pillWidthPx:m=160,onUnassign:g,onOpenMap:h,onAdvance:p,onEditPersonnelStart:w,editing:b,editingValue:V,setEditingValue:k,onEditPersonnelSave:M,onEditPersonnelCancel:L,onClone:v,onVehiclesIconClick:D,onShowInfo:T,nearIds:_,nearUntilMs:Y,distById:j,pulse:A,editable:K=!0}=t,[C,J]=s.useState(i==="in-bearbeitung"),te=s.useRef((r.assignedVehicles||[]).length),X=s.useRef(null),le=Date.now()<(Y||0),se=K?mn({id:`card:${r.id}`,data:{type:"card",cardId:r.id}}):{attributes:{},listeners:{},setNodeRef:y=>{},transform:null,transition:null,isDragging:!1},{attributes:pe,listeners:I,setNodeRef:de,transform:U,transition:fe,isDragging:x}=se,H={transform:hn.Transform.toString(U),transition:fe,opacity:x?.8:1},ae=i==="erledigt"?r.everVehicles?.length||0:r.assignedVehicles?.length||0,Z=s.useMemo(()=>(r.assignedVehicles||[]).map(y=>l.get(y)).filter(Boolean),[r,l]),G=s.useMemo(()=>i==="erledigt"?Number.isFinite(r?.everPersonnel)?r.everPersonnel:0:Number.isFinite(r?.manualPersonnel)?r.manualPersonnel:Z.reduce((y,$)=>y+($?.mannschaft??0),0),[i,r,Z]);s.useEffect(()=>{if(i!=="in-bearbeitung"||!le)return;(r.assignedVehicles||[]).some($=>_?.has(String($)))&&J(!0)},[i,le,_,r.assignedVehicles]),s.useEffect(()=>{if(i!=="in-bearbeitung")return;const y=(r.assignedVehicles||[]).length,$=te.current;y>$&&J(!0),te.current=y},[i,r.assignedVehicles]),s.useEffect(()=>{if(i==="in-bearbeitung"&&C&&X.current)try{X.current.scrollIntoView({behavior:"smooth",block:"nearest"})}catch{}},[i,C]);const ne=()=>{i==="neu"?typeof D=="function"&&D(r,i):(i==="in-bearbeitung"||i==="erledigt")&&J(y=>!y)},q=()=>{K&&typeof w=="function"&&w(r,G)};return e.jsxs("li",{ref:de,style:H,className:`relative rounded-lg bg-white shadow border transition mx-1
              ${A&&i==="neu"?"ring-2 ring-red-400/60":""}`,children:[A&&i==="neu"&&e.jsxs(e.Fragment,{children:[e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 rounded-lg bg-red-500/10 animate-pulse-inner"}),e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 rounded-lg animate-ping-safe"})]}),e.jsxs("div",{className:"p-3 select-none",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",...pe,...I,children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-semibold text-sm leading-5 truncate",children:r.content}),!!r.ort&&e.jsx("button",{type:"button",onClick:()=>h?.(r.ort),className:"text-[12px] text-blue-700 hover:underline truncate",title:"Ort in Karte Ã¶ffnen",children:r.ort})]}),e.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[e.jsxs("button",{type:"button",title:i==="neu"?"Nahe Einheiten prÃ¼fen":"Einheiten auf-/zuklappen",className:"px-2 py-1 rounded text-[12px] border hover:bg-red-50 flex items-center gap-1",onPointerDown:y=>y.stopPropagation(),onClick:y=>{y.stopPropagation(),y.preventDefault(),ne()},children:["ðŸš’ ",ae,(i==="in-bearbeitung"||i==="erledigt")&&e.jsx("span",{children:C?"â–¾":"â–¸"})]}),e.jsxs("button",{type:"button",className:"px-2 py-1 rounded text-[12px] border bg-white hover:bg-gray-50",title:"Personalzahl bearbeiten",onPointerDown:y=>y.stopPropagation(),onClick:y=>{y.stopPropagation(),q()},children:["ðŸ‘¥ ",G]}),K&&p&&e.jsx("button",{type:"button",onPointerDown:y=>y.stopPropagation(),onClick:y=>{y.stopPropagation(),p(r)},className:"ml-1 px-2 py-1 rounded text-[12px] border bg-white hover:bg-gray-50",title:"weiter",children:"âž”"})]})]}),i==="neu"&&!!Z.length&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-1.5",children:Z.map(y=>e.jsx(dt,{cardId:r.id,vehicle:y,pillWidthPx:m,onUnassign:g,onClone:v,near:!!_&&le&&_.has(String(y.id)),readonly:!K,distKm:j?.get(String(y.id))??null},`ass-${r.id}-${y.id}`))}),i==="in-bearbeitung"&&C&&!!Z.length&&e.jsx("div",{ref:X,className:"mt-2 flex flex-wrap gap-1.5",children:Z.map(y=>e.jsx(dt,{cardId:r.id,vehicle:y,pillWidthPx:m,onUnassign:g,onClone:v,near:!!_&&le&&_.has(String(y.id)),readonly:!K,distKm:j?.get(String(y.id))??null},`ass-${r.id}-${y.id}`))}),i==="erledigt"&&C&&!!r.everVehicles?.length&&e.jsx("ul",{className:"mt-2 text-sm text-gray-700 list-disc list-inside space-y-1",children:r.everVehicles.map(y=>{const $=l.get(y),S=$?.label||$?.id||"Unbekannt",R=$?.ort?` (${$.ort})`:"";return e.jsxs("li",{children:[S,R]},y)})}),K&&b?.cardId===r.id&&e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("input",{type:"number",className:"w-20 border rounded px-2 py-1 text-sm",value:V,onChange:y=>k(y.target.value),placeholder:"Personen"}),e.jsx("button",{className:"px-2 py-1 text-sm rounded bg-emerald-600 text-white",onClick:()=>M(r),children:"Speichern"}),e.jsx("button",{className:"px-2 py-1 text-sm rounded bg-gray-200",onClick:L,children:"Abbrechen"})]}),e.jsxs("div",{className:"mt-2 flex justify-end gap-2",children:[e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Ort in Karte Ã¶ffnen",onPointerDown:y=>y.stopPropagation(),onClick:y=>{y.stopPropagation(),h?.(r.ort)},children:"Karte"}),e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Einsatz-Info",onPointerDown:y=>y.stopPropagation(),onClick:y=>{y.stopPropagation(),T?.(r)},children:"?"})]})]})]})}function En({vehicle:t,pillWidthPx:r=160,near:i=!1,distKm:l=null,editable:m=!0}){const g=`veh:${t.id}`,h=m?Ct({id:g,data:{type:"vehicle",vehicleId:t.id}}):null,p=h?.attributes??{},w=h?.listeners??{},b=h?.setNodeRef??(()=>{}),V=h?.transform??null,k=h?.isDragging??!1;return e.jsxs("div",{ref:b,style:{width:r,transform:V?`translate3d(${V.x}px, ${V.y}px, 0)`:void 0},...p,...w,className:`relative max-w-full select-none border-2 ${i?"border-emerald-500":"border-red-300"} rounded-2xl bg-white
                 px-2 py-1 shadow-sm cursor-grab active:cursor-grabbing
                 ${k?"opacity-50":""}`,children:[i&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-0.5 rounded-2xl border-2 border-emerald-400/50 animate-ping"}),e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:t.label||t.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate flex justify-between items-center",children:[e.jsxs("span",{children:[t.ort||"â€”"," Â· ðŸ‘¥ ",t.mannschaft??0]}),i&&Number.isFinite(Number(l))&&e.jsxs("span",{className:"absolute top-1 right-1 text-[11px] tabular-nums text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded whitespace-nowrap",children:[Number(l)," Km"]})]})]})}const An="";async function ue(t,r,i){const l=await fetch(An+r,{method:t,headers:{"Content-Type":"application/json"},body:i===void 0?void 0:JSON.stringify(i),cache:"no-store",credentials:"include"});if(!l.ok)throw new Error(`HTTP ${l.status} ${await l.text().catch(()=>l.statusText)}`);return(l.headers.get("content-type")||"").includes("application/json")?l.json():l.text()}async function ce(){return ue("GET","/api/board")}async function qe(){return ue("GET","/api/vehicles")}async function Pn(){try{return await ue("GET","/api/types")}catch{return[]}}async function ut(t,r="neu",i=0,l="",m="",g={}){const h={title:t,columnId:r,toIndex:i,ort:l,typ:m};if(g&&typeof g=="object"){const{lat:p,lng:w,latitude:b,longitude:V,...k}=g;Number.isFinite(b)&&(h.latitude=Number(b)),Number.isFinite(V)&&(h.longitude=Number(V)),Number.isFinite(p)&&(h.latitude=Number(p)),Number.isFinite(w)&&(h.longitude=Number(w)),Object.assign(h,k)}return ue("POST","/api/cards",h)}async function Le({cardId:t,from:r,to:i,toIndex:l=0}){return ue("POST",`/api/cards/${encodeURIComponent(t)}/move`,{from:r,to:i,toIndex:l})}async function Ge(t,r){return ue("POST",`/api/cards/${encodeURIComponent(t)}/assign`,{vehicleId:r})}async function mt(t,r){return ue("POST",`/api/cards/${encodeURIComponent(t)}/unassign`,{vehicleId:r})}async function Mn(t,r){return ue("PATCH",`/api/cards/${encodeURIComponent(t)}/personnel`,{manualPersonnel:r})}async function Tn(){return ue("POST","/api/reset",{})}async function $n(){return ue("GET","/api/import/auto-config")}async function ht({enabled:t,intervalSec:r}){return ue("POST","/api/import/auto-config",{enabled:t,intervalSec:r})}function Dn(){return"/api/export/pdf"}async function Rn(t,r){const i=`cardId=${encodeURIComponent(t)}`,m=Number.isFinite(Number(r))&&Number(r)>0?`${i}&radiusKm=${encodeURIComponent(r)}`:i,g=await fetch(`/api/nearby?${m}`,{credentials:"same-origin",cache:"no-store"});if(!g.ok)throw new Error("fetchNearby failed");return g.json()}async function gt(t,r,i,l=null,m="manual"){return ue("PATCH",`/api/vehicles/${encodeURIComponent(t)}/position`,{lat:Number(r),lng:Number(i),incidentId:l,source:m})}async function pt(t){return ue("DELETE",`/api/vehicles/${encodeURIComponent(t)}/position`)}function Ln(t,r){const l=(r.lat-t.lat)*Math.PI/180,m=(r.lng-t.lng)*Math.PI/180,g=Math.sin(l/2)**2+Math.cos(t.lat*Math.PI/180)*Math.cos(r.lat*Math.PI/180)*Math.sin(m/2)**2;return 2*6371*Math.asin(Math.sqrt(g))}function ft(t,r,i){const m=i*Math.PI/180,g=t.lat*Math.PI/180,h=t.lng*Math.PI/180,p=r/6371e3,w=Math.asin(Math.sin(g)*Math.cos(p)+Math.cos(g)*Math.sin(p)*Math.cos(m))*180/Math.PI,b=(h+Math.atan2(Math.sin(m)*Math.sin(p)*Math.cos(g),Math.cos(p)-Math.sin(g)*Math.sin(w*Math.PI/180)))*180/Math.PI;return{lat:w,lng:b}}async function xt(t){if(!t||!window.google?.maps?.Geocoder)return null;const r=new window.google.maps.Geocoder;return new Promise(i=>{r.geocode({address:t,region:"AT"},(l,m)=>{m==="OK"&&l?.[0]?.geometry?.location?i({lat:l[0].geometry.location.lat(),lng:l[0].geometry.location.lng(),formatted:l[0].formatted_address||t}):i(null)})})}const Ae=t=>String(t||"").trim().toLowerCase();async function bt(){try{const t=await fetch("/api/vehicles",{cache:"no-store"});return t.ok?t.json():[]}catch{return[]}}async function yt(){try{const t=await fetch("/api/gps",{cache:"no-store"});if(t.ok)return await t.json()}catch(t){console.error("GPS fetch failed:",t)}return[]}function wt(t){const r=t?.typ||t?.type||"â€”",i=t?.timestamp?new Date(t.timestamp).toLocaleString("de-AT",{hour12:!1}):"â€”",l=t?.alerted??"â€”",m=t?.description??"â€”",g=t?.additionalAddressInfo||t?.ort||"â€”",h=[];t?.location&&h.push(String(t.location));const p=Number.isFinite(t?.latitude),w=Number.isFinite(t?.longitude);p&&w&&h.push(`(${t.latitude}, ${t.longitude})`);const b=h.length?h.join(" "):"â€”";return`
    <div style="min-width:280px">
      <div style="font-weight:700;margin-bottom:4px">${t?.content||"Einsatz"}</div>
      <div><b>Typ:</b> ${r}</div>
      <div><b>Alarmzeit:</b> ${i}</div>
      <div><b>Alarmiert:</b> ${l}</div>
      <div><b>Beschreibung:</b> ${m}</div>
      <div><b>Adresse:</b> ${g}</div>
      <div><b>Location:</b> ${b}</div>
    </div>
  `}const ye=44,vt="/vehicle-red.gif",On="/vehicle-gray.png",_n="/vehicle-drive.gif";function zn({context:t,address:r,onClose:i}){const l=r||t?.card?.ort||t?.address||"",m=!!window.google?.maps,g=s.useRef(null),[h,p]=s.useState(!1),[w,b]=s.useState(""),V=s.useMemo(()=>{const k=t?.card;return k&&Number.isFinite(k?.latitude)&&Number.isFinite(k?.longitude)?{lat:Number(k.latitude),lng:Number(k.longitude)}:null},[t]);if(s.useEffect(()=>{if(!m||!t?.card||!g.current)return;let k=!1,M,L;const v=new Map;let D=null;return(async()=>{try{p(!0),b("");let _=V;if(!_){const x=await xt(t.card.ort);if(k)return;x&&(_={lat:x.lat,lng:x.lng})}if(!_){b("Konnte Einsatz-Position nicht bestimmen.");return}M=new window.google.maps.Map(g.current,{center:_,zoom:18,mapTypeId:"roadmap"}),L=new window.google.maps.InfoWindow;const Y=(x,H,ae,Z,{hover:G=!1}={})=>{const ne={path:"M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z",fillColor:H,fillOpacity:1,strokeColor:"#333",strokeWeight:1,scale:1.2},q=new window.google.maps.Marker({position:x,map:M,title:ae,icon:ne});if(Z){const y=()=>{L.setContent(Z),L.open(M,q)};G?(q.addListener("mouseover",y),q.addListener("mouseout",()=>L.close())):q.addListener("click",y)}return q};Y(_,"#d11a1a",t.card.content||"Einsatz",wt(t.card),{hover:!0});const j=[...t?.board?.columns?.neu?.items||[],...t?.board?.columns?.["in-bearbeitung"]?.items||[]],A=new Map;for(const x of j)if(Number.isFinite(x.latitude)&&Number.isFinite(x.longitude))A.set(x.id,{lat:Number(x.latitude),lng:Number(x.longitude)});else if(x.ort){const H=await xt(x.ort);H&&A.set(x.id,{lat:H.lat,lng:H.lng})}for(const x of j){if(x.id===t.card.id)continue;const H=A.get(x.id);H&&Y(H,"#1e63d1",x.content||"Einsatz",wt(x),{hover:!0})}const K=new Map;for(const x of j)for(const H of x.assignedVehicles||[])K.set(String(H),x.id);const C=await yt(),J=new Map(C.filter(x=>Number.isFinite(x?.lat)&&Number.isFinite(x?.lng)&&x?.realname).map(x=>[Ae(x.realname),x])),te=await bt(),X=new Map(te.filter(x=>x&&x.source!=="gps"&&Number.isFinite(x.latitude)&&Number.isFinite(x.longitude)).map(x=>[String(x.id),{lat:Number(x.latitude),lng:Number(x.longitude)}])),le=Object.values(t.vehiclesById||{}),se=10,pe=50,I=new Map,de=window.google?.maps?.marker?.AdvancedMarkerElement,U=(x,H,ae)=>{if(!x)return On;if(!H||!ae||!A.has(ae))return vt;const Z=A.get(ae);return Ln(H,Z)>.1?_n:vt},fe=(x,H,ae,Z,G,ne)=>{const q=U(H,Z,G),y=!Z;if(de){const $=document.createElement("img");$.src=q,$.width=ye,$.height=ye,$.alt=ae||"",$.decoding="async";const S=new de({map:M,position:x,content:$,title:ae});if(y){try{S.draggable=!0}catch{}S.addListener("dragend",async R=>{const B=R?.latLng||S.position,a=typeof B.lat=="function"?B.lat():B.lat,u=typeof B.lng=="function"?B.lng():B.lng;try{await gt(ne,a,u,G,"manual")}catch(N){S.__setPosition(x),console.error("setVehiclePosition failed:",N),alert("Position konnte nicht gespeichert werden.")}})}return S.__setPosition=R=>{S.position=R},S.__setIcon=(R,B,a)=>{$.src=U(R,B,a)},S.__onOver=R=>{$.addEventListener("mouseover",R),$.addEventListener("mouseout",()=>L.close())},S}else{const $=new window.google.maps.Marker({position:x,map:M,title:ae,draggable:y,icon:{url:q,scaledSize:new window.google.maps.Size(ye,ye),anchor:new window.google.maps.Point(ye/2,ye/2)}});return y&&$.addListener("dragend",async S=>{const R=S?.latLng||$.getPosition(),B=typeof R.lat=="function"?R.lat():R.lat,a=typeof R.lng=="function"?R.lng():R.lng;try{await gt(ne,B,a,G,"manual")}catch(u){$.__setPosition(x),console.error("setVehiclePosition failed:",u),alert("Position konnte nicht gespeichert werden.")}}),$.__setPosition=S=>$.setPosition(S),$.__setIcon=(S,R,B)=>$.setIcon({url:U(S,R,B),scaledSize:new window.google.maps.Size(ye,ye),anchor:new window.google.maps.Point(ye/2,ye/2)}),$.__onOver=S=>{$.addListener("mouseover",S),$.addListener("mouseout",()=>L.close())},$}};for(const x of le){const H=String(x.id),ae=Ae(`${x?.label||""} ${x?.ort||""}`),Z=J.get(ae),G=K.get(H);if(!G&&!Z)continue;let ne=null,q=null;if(Z)q={lat:Number(Z.lat),lng:Number(Z.lng)},ne=q;else if(X.has(H))ne=X.get(H);else if(G&&A.has(G)){const B=A.get(G),u=((I.get(G)||0)+pe)%360;I.set(G,u),ne=ft(B,se,u)}if(!ne)continue;const $=fe(ne,!!G,x.label||x.id,q,G,H),S=G&&j.find(B=>B.id===G),R=S?`<br/><i>zugeordnet: ${S.content}</i>`:"";$.__onOver(()=>{const B=x?.ort||"";L.setContent(`<div style="min-width:220px"><b>${x.label||x.id}</b>${B?`<br/>${B}`:""}${R}</div>`);const a=de?void 0:$;L.open({map:M,anchor:a,position:ne,shouldFocus:!1})}),v.set(H,$)}M.setCenter(_),M.setZoom(18),D=setInterval(async()=>{const x=await yt(),H=await bt(),ae=new Map(H.filter(S=>S&&S.source!=="gps"&&Number.isFinite(S.latitude)&&Number.isFinite(S.longitude)).map(S=>[String(S.id),{lat:Number(S.latitude),lng:Number(S.longitude)}])),Z=new Map(x.filter(S=>Number.isFinite(S?.lat)&&Number.isFinite(S?.lng)&&S?.realname).map(S=>[Ae(S.realname),S])),G=new Map;for(const S of[...t?.board?.columns?.neu?.items||[],...t?.board?.columns?.["in-bearbeitung"]?.items||[]])for(const R of S.assignedVehicles||[])G.set(String(R),S.id);const ne=Object.values(t.vehiclesById||{}),q=new Map;for(const S of ne){const R=String(S.id),B=G.get(R),a=Ae(`${S?.label||""} ${S?.ort||""}`);if(B&&!Z.get(a)){const u=q.get(B)||[];u.push(R),q.set(B,u)}}for(const[S,R]of q.entries())R.sort();const y=10,$=50;for(const S of ne){const R=String(S.id),B=v.get(R);if(!B)continue;const a=Ae(`${S?.label||""} ${S?.ort||""}`),u=Z.get(a),N=G.get(R);if(u)gpsPos={lat:Number(u.lat),lng:Number(u.lng)},B.__setPosition(gpsPos);else if(ae.has(R))B.__setPosition(ae.get(R));else if(N&&A.has(N)){const ee=((q.get(N)||[]).indexOf(R)+1)*$%360,Q=A.get(N);B.__setPosition(ft(Q,y,ee))}else{const W=v.get(R);W&&(W.setMap?W.setMap(null):W.map&&(W.map=null),v.delete(R));continue}const P=!!N;B.__setIcon(P,gpsPos,N)}},5e3)}catch(_){b(_?.message||"Kartenaufbau fehlgeschlagen.")}finally{p(!1)}})(),()=>{k=!0,D&&clearInterval(D),v.clear()}},[m,t,V]),!m||!t?.card){const k=`https://www.google.com/maps?q=${encodeURIComponent(l)}&output=embed`;return e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:i,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[70vh] p-2",onClick:M=>M.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-semibold text-sm",children:["Karte: ",l]}),e.jsx("button",{className:"px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm",onClick:i,children:"SchlieÃŸen"})]}),e.jsx("iframe",{title:"maps",className:"w-full h-full rounded-lg border",src:k,loading:"lazy"})]})})}return e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:i,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-5xl h-[75vh] p-2",onClick:k=>k.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-semibold text-sm",children:["Karte: ",t?.card?.content||"Einsatz"," Â· weitere EinsÃ¤tze (Neu & In Bearbeitung)"]}),e.jsx("button",{className:"px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm",onClick:i,children:"SchlieÃŸen"})]}),e.jsx("div",{ref:g,className:"w-full h-full rounded-lg border"}),h&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"px-3 py-1.5 rounded bg-white shadow text-sm",children:"Ladeâ€¦"})}),!!w&&e.jsx("div",{className:"absolute bottom-3 left-3 px-2 py-1 rounded bg-red-600 text-white text-xs shadow",children:w})]})})}function Fn({onClose:t,onCreate:r}){const[i,l]=s.useState(""),[m,g]=s.useState(""),[h,p]=s.useState(0),[w,b]=s.useState(!1),[V,k]=s.useState(""),M=async L=>{if(L.preventDefault(),k(""),!i.trim()||!m.trim()){k("Ort und Name sind erforderlich.");return}try{b(!0),await r({ort:i.trim(),label:m.trim(),mannschaft:Number(h)||0}),t()}catch(v){k(v?.message||"Speichern fehlgeschlagen.")}finally{b(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:e.jsxs("form",{onSubmit:M,className:"bg-white rounded-xl shadow-lg p-4 w-[360px] space-y-3",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Einheit anlegen"}),V&&e.jsx("div",{className:"text-sm text-red-600",children:V}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Ort"}),e.jsx("input",{className:"border rounded px-2 py-1 w-full",value:i,onChange:L=>l(L.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Name"}),e.jsx("input",{className:"border rounded px-2 py-1 w-full",value:m,onChange:L=>g(L.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Mannschaft"}),e.jsx("input",{type:"number",min:"0",className:"border rounded px-2 py-1 w-24",value:h,onChange:L=>p(L.target.value)})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:t,className:"px-3 py-1 rounded border",disabled:w,children:"Abbrechen"}),e.jsx("button",{type:"submit",className:"px-3 py-1 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:w,children:w?"Anlegenâ€¦":"Anlegen"})]})]})})}let Oe=null;function It(){const t=document.querySelector('meta[name="google-places-key"]');return(window.GMAPS_API_KEY||t?.content||"").trim()||""}async function Vn(t=It()){if(window.google?.maps?.places)return!0;if(!t)return!1;if(Oe)return await Oe,!!window.google?.maps?.places;Oe=new Promise((r,i)=>{if(document.getElementById("gmap-places")){const m=()=>{window.google?.maps?.places?r(!0):setTimeout(m,150)};m();return}const l=document.createElement("script");l.id="gmap-places",l.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(t)}&libraries=places&language=de`,l.async=!0,l.defer=!0,l.onload=()=>r(!!window.google?.maps?.places),l.onerror=m=>i(m),document.head.appendChild(l)});try{await Oe}catch{}return!!window.google?.maps?.places}function Et({debounceMs:t=300,country:r="at",minLength:i=3}={}){const[l,m]=s.useState(""),[g,h]=s.useState([]),[p,w]=s.useState(!1),[b,V]=s.useState(!1),[k,M]=s.useState(null),L=s.useRef(null),v=s.useRef(null),D=s.useRef(null),T=s.useRef(null);s.useEffect(()=>{let C=!1;return(async()=>{const J=await Vn(It());C||!J||!window.google?.maps?.places||(L.current=new google.maps.places.AutocompleteService,v.current=new google.maps.places.PlacesService(document.createElement("div")),D.current=new google.maps.places.AutocompleteSessionToken,C||V(!0))})(),()=>{C=!0}},[]);const _=s.useCallback(()=>{window.google?.maps?.places&&(D.current=new google.maps.places.AutocompleteSessionToken)},[]),Y=s.useRef();s.useEffect(()=>{Y.current||(Y.current=(C,J)=>{let te;return(...X)=>{clearTimeout(te),te=setTimeout(()=>C(...X),J)}})},[]);const j=s.useCallback(async C=>{if(!b||!L.current)return;const J=(C||"").trim();if(!J||J.length<i){h([]);return}w(!0),M(null),L.current.getPlacePredictions({input:J,sessionToken:D.current,componentRestrictions:{country:r},types:["address"]},(te,X)=>{if(w(!1),X!==google.maps.places.PlacesServiceStatus.OK||!te){h([]),X&&X!=="ZERO_RESULTS"&&M(X);return}h(te)})},[r,i,b]),A=s.useMemo(()=>Y.current?Y.current(j,t):()=>{},[j,t]);s.useEffect(()=>{A(l)},[l,A]);const K=s.useCallback((C,J=["formatted_address","geometry","address_components"])=>new Promise((te,X)=>{if(!b||!v.current){X(new Error("Google Places nicht bereit"));return}v.current.getDetails({placeId:C,fields:J,sessionToken:D.current},(le,se)=>{if(se!==google.maps.places.PlacesServiceStatus.OK||!le)return X(new Error(se||"DETAILS_FAILED"));te(le)})}),[b]);return{ready:b,query:l,setQuery:m,predictions:g,loading:p,error:k,resetSession:_,getDetailsByPlaceId:K,inputElRef:T}}function Bn({onClose:t,onCreate:r,types:i}){const[l,m]=s.useState(""),[g,h]=s.useState(""),[p,w]=s.useState(!1),b=s.useRef(null),{query:V,setQuery:k,predictions:M,getDetailsByPlaceId:L,resetSession:v,loading:D,error:T}=Et({country:"at",debounceMs:300,minLength:3});s.useEffect(()=>{setTimeout(()=>b.current?.focus(),0)},[]),s.useEffect(()=>{const j=(g||"").replace(/^T\d+\s*,?\s*/i,"").trim();!l.trim()&&j&&m(j)},[g]);const _=async j=>{j?.preventDefault?.();const A=(g||"").replace(/^T\d+\s*,?\s*/i,"").trim(),K=(l||A).trim();if(K){w(!0);try{await r({title:K,ort:(V||"").trim(),typ:(g||"").trim()}),m(""),k(""),h(""),v(),t?.()}finally{w(!1)}}},Y=async j=>{try{const K=(await L(j.place_id,["formatted_address","geometry","address_components","place_id"]))?.formatted_address||j.description;k(K)}catch{k(j.description)}finally{v()}};return e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-3",children:e.jsxs("form",{onSubmit:_,className:"bg-white rounded-xl shadow-lg w-[520px] max-w-full p-4 space-y-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Einsatz anlegen"}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs("select",{ref:b,className:"border rounded px-2 py-1",value:g,onChange:j=>h(j.target.value),children:[e.jsx("option",{value:"",children:"â€” Typ auswÃ¤hlen â€”"}),i.map(j=>e.jsx("option",{value:j,children:j},j))]}),e.jsx("input",{className:"border rounded px-2 py-1",placeholder:"Titel (wird aus Typ Ã¼bernommen)",value:l,onChange:j=>m(j.target.value)}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{className:"border rounded px-2 py-1 w-full",placeholder:"Ort (nur Ã–sterreich)",autoComplete:"off",value:V,onChange:j=>k(j.target.value)}),D&&e.jsx("div",{className:"absolute z-10 mt-1 text-xs text-gray-500 bg-white border rounded px-2 py-1",children:"Sucheâ€¦"}),T&&e.jsxs("div",{className:"absolute z-10 mt-1 text-xs text-red-600 bg-white border rounded px-2 py-1",children:["Fehler: ",String(T)]}),!!M.length&&e.jsx("ul",{className:"absolute z-10 mt-1 w-full max-h-52 overflow-auto bg-white border rounded shadow",children:M.map(j=>e.jsx("li",{className:"px-2 py-1 hover:bg-gray-100 cursor-pointer text-sm",onClick:()=>Y(j),title:j.description,children:j.description},j.place_id))})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:t,className:"px-3 py-1 rounded border",disabled:p,children:"Abbrechen"}),e.jsx("button",{className:"px-3 py-1 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:p,children:p?"Anlegenâ€¦":"Anlegen"})]})]})})}function Kn({colId:t,title:r,bg:i,children:l,editable:m=!0}){if(!m)return e.jsxs("section",{className:`${i} rounded-xl shadow p-3 h-full flex flex-col min-h-0`,children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:r}),l]});const{setNodeRef:g,isOver:h}=gn({id:`col:${t}`,data:{type:"column",colId:t}});return e.jsxs("section",{ref:g,className:`${i} rounded-xl shadow p-3 h-full flex flex-col min-h-0 ${h?"outline outline-2 outline-blue-400":""}`,children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:r}),l]})}function Un({open:t,onClose:r,info:i={}}){if(!t)return null;const l=({label:p,value:w})=>e.jsxs("div",{className:"flex items-start gap-3 py-1",children:[e.jsx("div",{className:"w-32 shrink-0 text-gray-600",children:p}),e.jsx("div",{className:"flex-1 font-medium break-words",children:w??"â€”"})]}),m=i.timestamp?new Date(i.timestamp).toLocaleString("de-AT",{hour12:!1}):"â€”",g=[];i.location&&g.push(String(i.location)),Number.isFinite(i.latitude)&&Number.isFinite(i.longitude)&&g.push(`(${i.latitude}, ${i.longitude})`);const h=g.length?g.join(" "):void 0;return e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:r}),e.jsxs("div",{className:"relative z-[101] w-[min(92vw,640px)] rounded-xl bg-white shadow-xl p-4 md:p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg md:text-xl font-bold",children:"Einsatz-Info"}),e.jsx("button",{className:"h-8 w-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center",onClick:r,"aria-label":"SchlieÃŸen",title:"SchlieÃŸen",children:e.jsx("svg",{viewBox:"0 0 12 12",width:"14",height:"14","aria-hidden":"true",children:e.jsx("path",{d:"M1 1 L11 11 M11 1 L1 11",stroke:"black",strokeWidth:"2",strokeLinecap:"round"})})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(l,{label:"Typ",value:i.type||i.typ}),e.jsx(l,{label:"Alarmzeit",value:m}),e.jsx(l,{label:"Alarmiert",value:i.alerted}),e.jsx(l,{label:"Beschreibung",value:i.description}),e.jsx(l,{label:"Adresse",value:i.additionalAddressInfo||i.ort}),e.jsx(l,{label:"Location",value:h})]}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx("button",{className:"px-3 py-1.5 rounded-md bg-emerald-600 text-white hover:bg-emerald-700",onClick:r,children:"OK"})})]})]})}function Hn(t){const r=(t??"").toString();return r.length>30?r.slice(0,30)+"â€¦":r}function Gn(){const[t,r]=s.useState([]),[i,l]=s.useState(!0),[m,g]=s.useState(!1);s.useEffect(()=>{(async()=>{try{await Qe(),g(Ye("protokoll"))}catch{g(!1)}})(),(async()=>{try{const p=await fetch("/api/protocol").then(w=>w.json());r(Array.isArray(p?.items)?p.items:[])}catch{r([])}finally{l(!1)}})()},[]);const h=s.useMemo(()=>[...t].sort((p,w)=>(Number(w.nr)||0)-(Number(p.nr)||0)),[t]);return e.jsxs("div",{className:"p-3 md:p-4 max-w-[1400px] mx-auto h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-3",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:"MeldungsÃ¼bersicht"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("a",{href:"/api/protocol/csv/file",className:"px-3 py-1.5 rounded-md border bg-white",title:"protocol.csv herunterladen",children:"CSV"}),e.jsx("button",{onClick:()=>{m&&(window.location.hash="/protokoll/neu")},className:"px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white",title:m?void 0:"Keine Berechtigung (Meldestelle)",children:"+ Eintrag anlegen"})]})]}),e.jsx("div",{className:"flex-1 overflow-auto border rounded-lg bg-white",children:i?e.jsx("div",{className:"p-4 text-gray-500",children:"Ladeâ€¦"}):e.jsxs("table",{className:"min-w-[1100px] w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0 z-10",children:e.jsxs("tr",{className:"[&>th]:px-2 [&>th]:py-2 [&>th]:text-left [&>th]:font-semibold border-b",children:[e.jsx("th",{style:{width:28},title:"Druckstatus"}),e.jsx("th",{style:{width:60},children:"NR"}),e.jsx("th",{style:{width:110},children:"Datum"}),e.jsx("th",{style:{width:80},children:"Zeit"}),e.jsx("th",{style:{width:120},children:"Kanal"}),e.jsx("th",{style:{width:110},children:"Richtung"}),e.jsx("th",{style:{width:160},children:"An/Von"}),e.jsx("th",{children:"Information"}),e.jsx("th",{style:{width:260},children:"Meldungstyp"})]})}),e.jsxs("tbody",{className:"[&>tr>td]:px-2 [&>tr>td]:py-2",children:[h.map(p=>{const w=p?.uebermittlungsart||{},b=w.kanal??w.kanalNr??w.art??"",k=[].concat(w.ein?"Eingang":[]).concat(w.aus?"Ausgang":[]).join(" / "),M=Number(p?.printCount)>0;return e.jsxs("tr",{className:"border-b align-top hover:bg-gray-50 cursor-pointer",onClick:()=>{window.location.hash=`/protokoll/edit/${p.nr}`},title:"Zum Bearbeiten Ã¶ffnen",children:[e.jsx("td",{className:"align-middle",children:M?e.jsx("span",{className:"inline-block w-3 h-3 rounded-full bg-yellow-400",title:`Gedruckt (${p.printCount})`}):null}),e.jsx("td",{className:"font-semibold",children:p.nr}),e.jsx("td",{children:p.datum}),e.jsx("td",{children:p.zeit}),e.jsx("td",{title:b,children:b}),e.jsx("td",{title:k,children:k}),e.jsx("td",{children:p.anvon}),e.jsx("td",{className:"whitespace-pre-wrap",children:Hn(p.information)}),e.jsx("td",{className:"whitespace-pre-wrap",children:p.infoTyp||"â€”"})]},p.nr)}),!h.length&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"p-4 text-gray-500 italic",children:"â€” keine EintrÃ¤ge â€”"})})]})]})}),e.jsx("a",{href:"/Hilfe_Meldestelle.pdf",target:"_blank",rel:"noopener noreferrer",className:"fixed bottom-4 right-4 px-4 py-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-lg",title:"Hilfe â€“ Meldestelle/Protokoll",children:"Hilfe"})]})}const We=["EL","LtStb","S1","S2","S3","S4","S5","S6"],we={anvon:"prot_sugg_anvon",kanal:"prot_sugg_kanalNr",verantwortlich:"prot_sugg_ver"};function Je(t,r=12){const i=new Set,l=[];for(const m of t){const g=String(m||"").trim();if(!(!g||i.has(g))&&(i.add(g),l.push(g),l.length>=r))break}return l}function jt(t){let r=String(t||"").trim();if(!r)return r;const i=r.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})$/);if(i){const m=i[1].padStart(2,"0"),g=i[2].padStart(2,"0");return`${i[3].length===2?"20"+i[3]:i[3]}-${g}-${m}`}const l=r.match(/^(\d{1,2})(\d{1,2})(\d{2,4})$/);if(l){const m=l[1].padStart(2,"0"),g=l[2].padStart(2,"0");return`${l[3].length===2?"20"+l[3]:l[3].padStart(4,"20")}-${g}-${m}`}return r}function Nt(t){let r=String(t||"").trim();if(!r)return r;const i=r.match(/^(\d{1,2})(\d{2})$/);if(i)return`${i[1].padStart(2,"0")}:${i[2]}`;const l=r.match(/^(\d{1,2})[:.](\d{1,2})$/);return l?`${l[1].padStart(2,"0")}:${l[2].padStart(2,"0")}`:r}const St=()=>({datum:new Date().toISOString().slice(0,10),zeit:new Date().toTimeString().slice(0,5),uebermittlungsart:{richtung:"",kanalNr:""},anvon:{richtung:"an",name:""},infoTyp:"Information",information:"",rueckmeldung1:"",rueckmeldung2:"",ergehtAn:[],ergehtAnText:"",lagebericht:"",massnahmen:Array.from({length:5},()=>({massnahme:"",verantwortlich:"",done:!1}))});function kt({mode:t="create",editNr:r=null}){const[i,l]=s.useState(!1),[m,g]=s.useState(!1);s.useEffect(()=>{let a=!0;return(async()=>{try{if(await Qe(),!a)return;g(Ye("protokoll"))}catch{if(!a)return;g(!1)}})(),()=>{a=!1}},[]);const[h,p]=s.useState(()=>{const a=Number(r);return Number.isFinite(a)&&a>0?a:null}),w=Number.isFinite(Number(h))&&Number(h)>0,[b,V]=s.useState(w),[k,M]=s.useState(!1),[L,v]=s.useState(null),D=s.useRef(null),T=s.useRef(null),_=s.useRef(!1),Y=s.useRef(null),[j,A]=s.useState(null),K=s.useRef(null),C=(a,u,N=2200)=>{A({type:a,text:u}),K.current&&clearTimeout(K.current),K.current=setTimeout(()=>A(null),N)},[J,te]=s.useState([]),[X,le]=s.useState([]),[se,pe]=s.useState([]);s.useEffect(()=>{try{te(JSON.parse(localStorage.getItem(we.anvon)||"[]")),le(JSON.parse(localStorage.getItem(we.kanal)||"[]")),pe(JSON.parse(localStorage.getItem(we.verantwortlich)||"[]"))}catch{}},[]);const[I,de]=s.useState(St()),U=(a,u)=>{const N=Array.isArray(a)?a:String(a).split(".");de(P=>{const W=structuredClone(P);let F=W;for(let ee=0;ee<N.length-1;ee++)F=F[N[ee]];return F[N.at(-1)]=u,W})};s.useEffect(()=>{if(!w){V(!1),setTimeout(()=>T.current?.focus(),0);return}const a=Number(h);!Number.isFinite(a)||a<=0||(async()=>{try{const u=await fetch(`/api/protocol/${a}`).then(N=>N.json());if(u?.ok&&u.item){const N=u.item,P=N.uebermittlungsart||{};let W="",F=N.anvon||"";const ee=(N.anvon||"").trim();/^an\s*:/i.test(ee)&&(W="an",F=ee.replace(/^an\s*:/i,"").trim()),/^von\s*:/i.test(ee)&&(W="von",F=ee.replace(/^von\s*:/i,"").trim()),de({datum:N.datum||"",zeit:N.zeit||"",uebermittlungsart:{richtung:P.ein?"ein":P.aus?"aus":"",kanalNr:P.kanalNr||""},anvon:{richtung:W||"an",name:F},infoTyp:N.infoTyp||"Information",information:N.information||"",rueckmeldung1:N.rueckmeldung1||"",rueckmeldung2:N.rueckmeldung2||"",ergehtAn:Array.isArray(N.ergehtAn)?N.ergehtAn:[],ergehtAnText:N.ergehtAnText||"",lagebericht:N.lagebericht||"",massnahmen:Array.from({length:5},(Q,ie)=>{const he=N.massnahmen?.[ie]||{};return{massnahme:he.massnahme||"",verantwortlich:he.verantwortlich||"",done:!!he.done}})}),v(N.id||null),setTimeout(()=>T.current?.focus(),0)}}finally{V(!1)}})()},[w,h]),s.useEffect(()=>{const a=()=>{const P=document.activeElement;P&&typeof P.blur=="function"&&P.blur()},u=P=>setTimeout(P,0),N=P=>{if(P.repeat)return;const W=(P.key||"").toLowerCase(),F=P.ctrlKey||P.metaKey;if(F&&!P.shiftKey&&W==="s"){if(P.preventDefault(),P.stopPropagation(),!m){C?.("error","Keine Berechtigung (Meldestelle)");return}if(_.current)return;_.current=!0,u(async()=>{a(),await new Promise(ee=>setTimeout(ee,0)),q().finally(()=>_.current=!1)});return}if(F&&(P.shiftKey&&W==="s"||W==="enter")){if(P.preventDefault(),P.stopPropagation(),!m){C?.("error","Keine Berechtigung (Meldestelle)");return}if(_.current)return;_.current=!0,u(async()=>{a(),await new Promise(ee=>setTimeout(ee,0)),y().finally(()=>_.current=!1)});return}W==="escape"&&(P.preventDefault(),P.stopPropagation(),u(()=>G()))};return window.addEventListener("keydown",N,!0),document.addEventListener("keydown",N,!0),()=>{window.removeEventListener("keydown",N,!0),document.removeEventListener("keydown",N,!0)}},[]);const[fe,x]=s.useState(!1),H=s.useRef(null);function ae(){const a=Array.isArray(I?.ergehtAn)?[...I.ergehtAn]:[],u=(I?.ergehtAnText||"").trim();return u&&a.push(u),a}const Z=async()=>{if(!m){C?.("error","Keine Berechtigung zum Drucken/Speichern");return}if(fe)return;const a=ae();if(!a.length){C?.("error","Bitte EmpfÃ¤nger wÃ¤hlen oder 'Sonstiger EmpfÃ¤nger' ausfÃ¼llen.");return}x(!0);try{const u=await ne();if(!u)throw new Error("Speichern fehlgeschlagen");p(u);const P=(await fetch(`/api/protocol/${u}`).then(ie=>ie.json()))?.item;if(!P)throw new Error("Datensatz fÃ¼r Druck nicht gefunden");C?.("info","PDF wird serverseitig erzeugt â€¦");const W=await fetch(`/api/protocol/${u}/print`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({recipients:a,data:P})}).then(ie=>ie.json());if(!W?.ok||!W?.fileUrl)throw new Error(W?.error||"PDF-Erzeugung fehlgeschlagen");let F=H.current;F||(F=document.createElement("iframe"),F.style.position="fixed",F.style.width="0",F.style.height="0",F.style.border="0",F.style.visibility="hidden",document.body.appendChild(F),H.current=F);const ee=`${W.fileUrl}#toolbar=0&navpanes=0&scrollbar=0`;F.onload=()=>{try{setTimeout(()=>{F.contentWindow?.focus(),F.contentWindow?.print()},100)}catch{window.open(ee,"_blank","noopener,noreferrer")?.focus()}},F.src=ee;const Q=Number(W?.pages)||a.length;C?.("success",`Druck gestartet (${Q} Seite${Q>1?"n":""})`)}catch(u){C?.("error",`Drucken fehlgeschlagen: ${u.message||u}`)}finally{x(!1)}},G=()=>{window.location.hash="/protokoll"},ne=async()=>{const a=Y.current?new FormData(Y.current):null,u=structuredClone(I);u.datum=jt(a?.get("datum")||I.datum),u.zeit=Nt(a?.get("zeit")||I.zeit);const N=(a?.get("anvonDir")||I.anvon.richtung||"").toString(),P=(a?.get("anvonName")||I.anvon.name||"").toString();u.anvon={richtung:N,name:P};const W=(a?.get("richtung")||I.uebermittlungsart.richtung||"").toString();u.uebermittlungsart.richtung=W,u.uebermittlungsart.kanalNr=(a?.get("kanalNr")||I.uebermittlungsart.kanalNr||"").toString(),u.information=(a?.get("information")||I.information||"").toString(),u.rueckmeldung1=(a?.get("rueckmeldung1")||I.rueckmeldung1||"").toString(),u.rueckmeldung2=(a?.get("rueckmeldung2")||I.rueckmeldung2||"").toString(),u.ergehtAnText=(a?.get("ergehtAnText")||I.ergehtAnText||"").toString(),u.infoTyp=(a?.get("infoTyp")||I.infoTyp||"Information").toString();const F=a?Array.from(a.getAll("ergehtAn")).map(String):I.ergehtAn;u.ergehtAn=F.length?F:I.ergehtAn,u.massnahmen=u.massnahmen.map((Q,ie)=>{const he=a?a.get(`m_done_${ie}`)!==null:Q.done;return{massnahme:(a?.get(`m_massnahme_${ie}`)||Q.massnahme||"").toString(),verantwortlich:(a?.get(`m_verantwortlich_${ie}`)||Q.verantwortlich||"").toString(),done:!!he}});const ee={...u,uebermittlungsart:{kanalNr:(u.uebermittlungsart.kanalNr||"").trim(),ein:u.uebermittlungsart.richtung==="ein",aus:u.uebermittlungsart.richtung==="aus"},anvon:u.anvon.richtung?`${u.anvon.richtung==="an"?"An":"Von"}: ${u.anvon.name}`.trim():u.anvon.name.trim()};try{const Q=Je([ee.anvon,...JSON.parse(localStorage.getItem(we.anvon)||"[]")]),ie=Je([ee.uebermittlungsart.kanalNr,...JSON.parse(localStorage.getItem(we.kanal)||"[]")]),he=[...u.massnahmen.map(Pe=>Pe.verantwortlich).filter(Boolean),...JSON.parse(localStorage.getItem(we.verantwortlich)||"[]")],je=Je(he);localStorage.setItem(we.anvon,JSON.stringify(Q)),localStorage.setItem(we.kanal,JSON.stringify(ie)),localStorage.setItem(we.verantwortlich,JSON.stringify(je)),te(Q),le(ie),pe(je)}catch{}if(w){const Q=await fetch(`/api/protocol/${h}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(ee)}).then(ie=>ie.json());if(!Q?.ok)throw new Error(Q?.error||"Speichern fehlgeschlagen");return p(Q.nr),v(Q.id||L||null),Q.nr}else{const Q=await fetch("/api/protocol",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ee)}).then(ie=>ie.json());if(!Q?.ok)throw new Error(Q?.error||"Speichern fehlgeschlagen");return p(Q.nr),v(Q.id||null),Q.nr}},q=async()=>{if(!m){C?.("error","Keine Berechtigung (Meldestelle)");return}if(!k){M(!0);try{await ne()&&(window.location.hash="/protokoll")}catch(a){C("error","Fehler beim Speichern: "+a.message,4e3)}finally{M(!1)}}},y=async()=>{if(!m){C?.("error","Keine Berechtigung (Meldestelle)");return}if(!k){M(!0);try{const a=await ne();a&&(C("success",`Gespeichert (NR ${a}) â€“ neuer Eintrag`),de(St()),p(null),v(null),setTimeout(()=>T.current?.focus(),0))}catch(a){C("error","Fehler beim Speichern: "+a.message,4e3)}finally{M(!1)}}},$=a=>{const u=(a.key||"").toLowerCase(),N=a.ctrlKey||a.metaKey;a.repeat||(N&&!a.shiftKey&&u==="s"?(a.preventDefault(),a.stopPropagation(),q()):N&&(a.shiftKey&&u==="s"||u==="enter")&&(a.preventDefault(),a.stopPropagation(),y()))},S=a=>{if(a.preventDefault(),!m){C?.("error","Keine Berechtigung (Meldestelle)");return}q()};if(b)return e.jsx("div",{className:"p-4",children:"Ladeâ€¦"});const R=We.every(a=>I.ergehtAn.includes(a)),B=a=>U("ergehtAn",a?[...We]:[]);return e.jsxs("div",{className:"mx-auto w-full max-w-[1100px] relative",children:[e.jsx("div",{className:"prot-actionbar sticky top-0 z-30 -mx-2 md:mx-0 px-2 md:px-0",children:e.jsxs("div",{className:"bg-white/95 backdrop-blur border-b rounded-t-xl px-3 py-2 flex items-center justify-between shadow-sm",children:[e.jsx("div",{className:"text-sm font-semibold",children:w?`Protokoll â€“ Bearbeiten (NR ${h??"â€”"})`:"Protokoll â€“ Neuer Eintrag"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:G,className:"px-3 py-1.5 rounded-md border",title:"Maske schlieÃŸen und zur Ãœbersicht wechseln (ESC)",children:"Abbrechen"}),e.jsx("button",{type:"button",onClick:y,disabled:k,className:"px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white disabled:opacity-60",title:"Speichern und neue Maske (Strg+Shift+S oder Strg+Enter)",children:"Speichern/Neu"}),e.jsx("button",{type:"button",onClick:q,disabled:k,className:"px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-60",title:"Speichern und schlieÃŸen (Strg+S)",children:k?"Speichernâ€¦":"Speichern"}),e.jsx("button",{type:"button",onClick:Z,disabled:fe,className:"px-3 py-1.5 rounded-md border bg-white hover:bg-gray-50 disabled:opacity-60",title:"Formular drucken â€“ Anzahl gemÃ¤ÃŸ 'ergeht an' + 'Sonstiger EmpfÃ¤nger'",children:fe?"Druckenâ€¦":"Drucken"})]})]})}),j&&e.jsx("div",{className:"fixed right-3 top-3 z-40",children:e.jsx("div",{className:"px-3 py-2 rounded shadow text-white "+(j.type==="success"?"bg-emerald-600":j.type==="error"?"bg-rose-600":"bg-slate-600"),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{children:j.text}),e.jsx("button",{className:"opacity-80 hover:opacity-100",onClick:()=>A(null),title:"Meldung schlieÃŸen",children:"âœ•"})]})})}),e.jsx("style",{children:`
        @media print {
          * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          .prot-actionbar { display: none !important; }
          html, body { margin: 0 !important; }
          @page { size: A4; margin: 12mm; }
        }
      `}),e.jsxs("form",{ref:Y,onKeyDown:$,onSubmit:S,className:"bg-white border-2 rounded-b-xl overflow-hidden shadow",children:[e.jsxs("div",{className:"grid grid-cols-12",children:[e.jsx("div",{className:"col-span-9 p-6 border-b-2",children:e.jsx("div",{className:"text-3xl font-extrabold tracking-wide",children:"MELDUNG/INFORMATION"})}),e.jsxs("div",{className:"col-span-3 border-l-2",children:[e.jsx("div",{className:"p-3 text-xs text-gray-600 border-b-2",children:"PROTOKOLL-NR"}),e.jsx("div",{className:"p-6 text-center text-4xl font-bold",children:h??"â€”"})]}),e.jsx("div",{className:"col-span-12 border-y-2 p-2",children:e.jsxs("div",{className:"grid grid-cols-12 gap-0",children:[e.jsxs("div",{className:"col-span-6 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Datum"}),e.jsx("input",{name:"datum",type:"text",className:"border rounded px-2 h-9 w-full",placeholder:"yyyy-mm-dd",value:I.datum,onChange:a=>U("datum",a.target.value),onBlur:a=>U("datum",jt(a.target.value)),title:"Datum (auch 101025 oder 10.10.2025 mÃ¶glich)"})]}),e.jsxs("div",{className:"col-span-3 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Uhrzeit"}),e.jsx("input",{name:"zeit",type:"text",className:"border rounded px-2 h-9 w-full",placeholder:"hh:mm",value:I.zeit,onChange:a=>U("zeit",a.target.value),onBlur:a=>U("zeit",Nt(a.target.value)),title:"Uhrzeit (915, 09:15 oder 0915 mÃ¶glich)"})]}),e.jsxs("div",{className:"col-span-3 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Typ"}),e.jsxs("div",{className:"grid grid-cols-3 gap-x-6 h-9 items-center",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{ref:T,type:"radio",name:"infoTyp",value:"Information",checked:I.infoTyp==="Information",onChange:()=>U("infoTyp","Information")}),e.jsx("span",{children:"Info"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"infoTyp",value:"Auftrag",checked:I.infoTyp==="Auftrag",onChange:()=>U("infoTyp","Auftrag")}),e.jsx("span",{children:"Auftrag"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"infoTyp",value:"Lagemeldung",checked:I.infoTyp==="Lagemeldung",onChange:()=>U("infoTyp","Lagemeldung")}),e.jsx("span",{children:"Lage"})]})]})]})]})}),e.jsx("div",{className:"col-span-12 border-y-2 p-2",children:e.jsxs("div",{className:"grid grid-cols-12 gap-0 items-end",children:[e.jsxs("div",{className:"col-span-6 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"An/Von"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{ref:D,name:"anvonName",className:"border rounded px-2 h-9 w-full flex-1",placeholder:"Name / Stelle",list:"dl-anvon",value:I.anvon.name,onChange:a=>{let u=a.target.value;const N=u.trim();/^an\s*:/i.test(N)?(U(["anvon","richtung"],"an"),u=N.replace(/^an\s*:/i,"").trim()):/^von\s*:/i.test(N)&&(U(["anvon","richtung"],"von"),u=N.replace(/^von\s*:/i,"").trim()),U(["anvon","name"],u)},title:'Optional mit PrÃ¤fix "an: â€¦" oder "von: â€¦"'}),e.jsxs("div",{className:"flex items-center gap-4 pl-2 min-w-[140px] shrink-0",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"anvonDir",value:"an",checked:I.anvon.richtung==="an",onChange:()=>U(["anvon","richtung"],"an")}),e.jsx("span",{children:"An"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"anvonDir",value:"von",checked:I.anvon.richtung==="von",onChange:()=>U(["anvon","richtung"],"von")}),e.jsx("span",{children:"Von"})]})]})]}),e.jsx("datalist",{id:"dl-anvon",children:J.map(a=>e.jsx("option",{value:a},a))})]}),e.jsxs("div",{className:"col-span-3 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Kanal"}),e.jsx("input",{name:"kanalNr",className:"border rounded px-2 h-9 w-full",list:"dl-kanal",value:I.uebermittlungsart.kanalNr,onChange:a=>U(["uebermittlungsart","kanalNr"],a.target.value),title:"z. B. Funkkanal, Telefonnummer, E-Mail-KÃ¼rzel â€¦"}),e.jsx("datalist",{id:"dl-kanal",children:X.map(a=>e.jsx("option",{value:a},a))})]}),e.jsxs("div",{className:"col-span-3 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Richtung"}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-6 h-9 items-center",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",title:"Meldung wurde empfangen",children:[e.jsx("input",{type:"radio",name:"richtung",value:"ein",checked:I.uebermittlungsart.richtung==="ein",onChange:()=>U(["uebermittlungsart","richtung"],"ein")}),e.jsx("span",{children:"Eingang"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",title:"Meldung wurde gesendet",children:[e.jsx("input",{type:"radio",name:"richtung",value:"aus",checked:I.uebermittlungsart.richtung==="aus",onChange:()=>U(["uebermittlungsart","richtung"],"aus")}),e.jsx("span",{children:"Ausgang"})]})]})]})]})}),e.jsxs("div",{className:"col-span-12 border-y-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Information/Auftrag"}),e.jsx("textarea",{name:"information",className:"border rounded px-2 py-2 w-full min-h-[160px]",value:I.information,onChange:a=>U("information",a.target.value),title:"Sachverhalt / Meldetext"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"RÃ¼ckmeldung 1"}),e.jsx("input",{name:"rueckmeldung1",className:"border rounded px-2 h-9 w-full",value:I.rueckmeldung1,onChange:a=>U("rueckmeldung1",a.target.value),title:"erste RÃ¼ckmeldung"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"RÃ¼ckmeldung 2"}),e.jsx("input",{name:"rueckmeldung2",className:"border rounded px-2 h-9 w-full",value:I.rueckmeldung2,onChange:a=>U("rueckmeldung2",a.target.value),title:"zweite RÃ¼ckmeldung"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-2",children:"ergeht an:"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 mr-3",title:"Alle EmpfÃ¤nger auswÃ¤hlen / abwÃ¤hlen",children:[e.jsx("input",{type:"checkbox",checked:R,onChange:a=>B(a.target.checked)}),e.jsx("span",{children:"Alle"})]}),We.map(a=>e.jsxs("label",{className:"inline-flex items-center gap-2 mr-3",children:[e.jsx("input",{tabIndex:-1,type:"checkbox",name:"ergehtAn",value:a,checked:I.ergehtAn.includes(a),onChange:()=>{const u=new Set(I.ergehtAn);u.has(a)?u.delete(a):u.add(a),U("ergehtAn",[...u])},title:`EmpfÃ¤nger ${a} ${I.ergehtAn.includes(a)?"entfernen":"hinzufÃ¼gen"}`}),e.jsx("span",{children:a})]},a)),e.jsx("span",{className:"ml-2 text-xs text-gray-600",children:"sonstiger EmpfÃ¤nger:"}),e.jsx("input",{name:"ergehtAnText",className:"border rounded px-2 h-9",value:I.ergehtAnText,onChange:a=>U("ergehtAnText",a.target.value),placeholder:"Name/Gruppe"})]})]}),e.jsxs("div",{className:"col-span-12 border-t-2",children:[e.jsxs("div",{className:"grid grid-cols-12 bg-gray-50 border-b-2",children:[e.jsx("div",{className:"col-span-6 p-2 font-semibold border-r",children:"MaÃŸnahme"}),e.jsx("div",{className:"col-span-5 p-2 font-semibold border-r",children:"Verantwortlich"}),e.jsx("div",{className:"col-span-1 p-2 font-semibold text-center",children:"Erledigt"})]}),I.massnahmen.map((a,u)=>e.jsxs("div",{className:"grid grid-cols-12 border-t",children:[e.jsx("div",{className:"col-span-6 p-2 border-r",children:e.jsx("input",{name:`m_massnahme_${u}`,className:"w-full border rounded px-2 h-9",value:a.massnahme,onChange:N=>{const P=[...I.massnahmen];P[u]={...a,massnahme:N.target.value},U("massnahmen",P)},title:`MaÃŸnahme ${u+1}`})}),e.jsx("div",{className:"col-span-5 p-2 border-r",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{name:`m_verantwortlich_${u}`,className:"w-full border rounded px-2 h-9",list:"dl-ver",value:a.verantwortlich,onChange:N=>{const P=[...I.massnahmen];P[u]={...a,verantwortlich:N.target.value},U("massnahmen",P)},title:`Verantwortlich ${u+1}`}),e.jsx("button",{type:"button",className:"px-2 h-9 text-xs rounded border bg-white hover:bg-gray-50",title:"Als Aufgabe anlegen (mit Protokoll-Bezug)",onClick:()=>createTaskFromMeasure(u),disabled:i,children:"â†’"})]})}),e.jsx("div",{className:"col-span-1 p-2 flex items-center justify-center",children:e.jsx("input",{tabIndex:-1,type:"checkbox",name:`m_done_${u}`,value:"1",checked:!!a.done,onChange:N=>{const P=[...I.massnahmen];P[u]={...a,done:N.target.checked},U("massnahmen",P)},title:"Erledigt umschalten"})})]},u)),e.jsx("datalist",{id:"dl-ver",children:se.map(a=>e.jsx("option",{value:a},a))})]})]}),e.jsx("button",{type:"submit",className:"hidden",children:"submit"})]})]})}function Wn({disabled:t=!1}){const[r,i]=s.useState(!1),[l,m]=s.useState(!1),[g,h]=s.useState(""),[p,w]=s.useState({remainingMin:null,idleMinutes:null,lastActivityIso:null,autoStopMin:null}),[b,V]=s.useState({lastLoadedIso:null,file:"list_filtered.json"}),[k,M]=s.useState(!1),[L,v]=s.useState(30),[D,T]=s.useState(null),_=s.useRef(!1),Y=async()=>{try{const[j,A,K]=await Promise.all([fetch("/api/ff/status",{credentials:"include",cache:"no-store"}).then(C=>C.json()).catch(()=>({running:!1})),fetch("/api/ff/creds",{credentials:"include",cache:"no-store"}).then(C=>C.json()).catch(()=>({has:!1})),fetch("/api/import/auto-config",{credentials:"include",cache:"no-store"}).then(C=>C.json()).catch(()=>({enabled:!1,intervalSec:30}))]);i(!!j.running),m(!!A.has),M(!!K.enabled),v(Number(K.intervalSec||30)),_.current||(_.current=!0,A.has||h("Keine globalen Fetcher-Zugangsdaten. Bitte als Admin unter /user-admin setzen."))}catch{}};return s.useEffect(()=>{Y();const j=setInterval(Y,3e3);return()=>clearInterval(j)},[]),s.useEffect(()=>{let j;const A=async()=>{try{const K=await fetch("/api/activity/status",{credentials:"include",cache:"no-store"});if(K.ok){const C=await K.json(),J=Number(C.idleMinutes),te=Number(C.autoStopMin),X=Math.max(0,Math.ceil(te-J));w({remainingMin:X,idleMinutes:J,lastActivityIso:C.lastActivityIso,autoStopMin:te}),i(!!C.fetcher?.running),V({lastLoadedIso:C.import?.lastLoadedIso??null,file:C.import?.file||"list_filtered.json"})}}catch{}};return A(),j=setInterval(A,1e3),()=>clearInterval(j)},[]),s.useEffect(()=>{let j;const A=()=>{if(!k||!b.lastLoadedIso){T(null);return}const C=new Date(b.lastLoadedIso).getTime()+L*1e3,J=Math.max(0,Math.ceil((C-Date.now())/1e3));T(J)};return A(),j=setInterval(A,1e3),()=>clearInterval(j)},[k,L,b.lastLoadedIso]),e.jsxs("div",{className:`flex items-center h-9 gap-2 ${t?"opacity-60 pointer-events-none":""}`,style:{alignItems:"center"},children:[e.jsx("span",{className:`sync-chip ${k?"active":""}`,title:k?"Auto-Import Countdown":"Auto-Import ist deaktiviert",style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:"110px",minWidth:"110px",textAlign:"center"},children:k?`âŸ³ in ${D??"â€“"}s`:"â¸ manuell"}),g&&e.jsx("span",{style:{color:"#dc2626",fontSize:12,marginLeft:8},children:g}),r&&p.remainingMin!=null&&p.remainingMin<=15&&e.jsxs("div",{title:`Letzte AktivitÃ¤t: ${p.lastActivityIso?new Date(p.lastActivityIso).toLocaleString():"â€“"} â€¢ Inaktiv: ${p.idleMinutes?.toFixed?.(1)} min â€¢ Limit: ${p.autoStopMin} min`,className:"ml-2 inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border "+(p.remainingMin<=5?"bg-red-50 text-red-700 border-red-300":p.remainingMin<=15?"bg-amber-50 text-amber-700 border-amber-300":"bg-blue-50 text-blue-700 border-blue-300"),children:[e.jsx("span",{className:"mr-2 h-2 w-2 rounded-full bg-current",style:{animation:"pulse 1.5s ease-in-out infinite"}}),e.jsxs("span",{children:["Auto-Import stoppt in ",e.jsxs("b",{children:[p.remainingMin," min"]})]})]}),e.jsx("div",{title:`Quelle: ${b.file}`,className:"ml-2 inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border bg-white text-gray-700",style:{borderColor:"#cbd5e1"},children:e.jsxs("span",{children:["Zuletzt geladen:"," ",e.jsx("b",{children:b.lastLoadedIso?new Date(b.lastLoadedIso).toLocaleTimeString("de-AT",{hour12:!1}):"â€“"})]})})]})}function Jn(){const[t,r]=s.useState(.9);return s.useEffect(()=>{const i=()=>{const l=window.innerWidth,m=window.innerHeight,g=Math.min(Math.max(Math.min(l/1440,m/900),.78),.95);r(Number(g.toFixed(2)))};return i(),window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[]),t}function Zn(){try{const t=new URLSearchParams(window.location.search),r=parseFloat(t.get("font"));if(Number.isFinite(r)&&r>=.5&&r<=5)return r}catch{}try{const t=parseFloat(localStorage.getItem("ff_font_scale")||"");if(Number.isFinite(t)&&t>=.5&&t<=5)return t}catch{}return 1.2}const At=t=>new Intl.DateTimeFormat("de-AT",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).format(new Date(t||Date.now())),Pt=t=>Array.isArray(t?.assignedVehicles)?t.assignedVehicles.length:0,Mt=(t,r)=>(t?.assignedVehicles||[]).reduce((i,l)=>{const m=r.get(l);return i+(typeof m?.mannschaft=="number"?m.mannschaft:0)},0);function qn({c:t,vehiclesById:r,showBottomCounts:i=!0,headerRight:l,kind:m}){const g=m==="erledigt",h=g?Array.isArray(t?.everVehicles)?t.everVehicles.length:0:Pt(t),p=g?Number.isFinite(t?.everPersonnel)?t.everPersonnel:0:Mt(t,r);return e.jsxs("div",{className:"border rounded-lg p-2 bg-white shadow-sm text-[0.9rem] leading-tight",children:[e.jsxs("div",{className:"flex items-start justify-between text-[0.72rem] text-gray-600 mb-1",children:[e.jsx("span",{children:At(t.createdAt)}),e.jsx("span",{className:"font-semibold",children:l})]}),e.jsx("div",{className:"font-semibold",children:t.content}),(t.ort||t.typ||t.alerted)&&e.jsxs("div",{className:"text-[0.75rem] text-gray-600 mt-0.5 space-x-2",children:[t.ort&&e.jsxs("span",{children:["ðŸ“ ",t.ort]}),t.typ&&e.jsxs("span",{children:["ðŸ·ï¸ ",t.typ]}),t.alerted&&e.jsxs("span",{className:"text-gray-500",children:["ðŸ”” ",t.alerted]})]}),i&&e.jsxs("div",{className:"mt-1 text-[0.78rem] text-gray-700 flex items-center gap-2",children:[e.jsxs("span",{children:["ðŸš’ ",h]}),e.jsxs("span",{children:["ðŸ‘¥ ",p]})]})]})}function Ze({title:t,cards:r,vehiclesById:i,kind:l,viewportH:m}){const p=Math.max(160,m-56-40),w=Math.max(1,Math.floor(p/96)),b=w*2,V=w+1,k=Math.max(b+2,V+6);let M="grid-cols-1";r.length>=k?M="grid-cols-3":r.length>=V&&(M="grid-cols-2");const L=T=>At(T.statusSince),v=s.useMemo(()=>{const T=r.length,_=r.reduce((j,A)=>l==="erledigt"?j+(Array.isArray(A.everVehicles)?A.everVehicles.length:0):j+(Array.isArray(A.assignedVehicles)?A.assignedVehicles.length:0),0),Y=r.reduce((j,A)=>{if(l==="erledigt")return j+(Number.isFinite(A?.everPersonnel)?A.everPersonnel:0);const C=(Array.isArray(A.assignedVehicles)?A.assignedVehicles:[]).reduce((J,te)=>J+(i.get(te)?.mannschaft??0),0);return j+C},0);return{cardCount:T,unitSum:_,personSum:Y}},[r,l,i]),D={neu:"bg-red-100","in-bearbeitung":"bg-yellow-100",erledigt:"bg-green-100"}[l]||"bg-gray-100";return e.jsxs("section",{className:`${D} rounded-xl shadow p-3 h-full flex flex-col min-h-0`,children:[e.jsxs("h3",{className:"text-sm font-semibold mb-2",children:[t," â€” â¬› ",v.cardCount," | ðŸš’ ",v.unitSum," | ðŸ‘¥ ",v.personSum]}),e.jsx("div",{className:`grid ${M} gap-2 overflow-auto pr-1 flex-1 min-h-0 place-content-start`,children:r.map(T=>e.jsx(qn,{c:T,vehiclesById:i,headerRight:L(T),showBottomCounts:!0,kind:l},T.id))}),r.length===0&&e.jsx("div",{className:"text-[0.8rem] text-gray-500 italic text-center py-4",children:"â€” keine EintrÃ¤ge â€”"})]})}function Qn(){Jn();const[t,r]=s.useState(Zn());s.useEffect(()=>{const v=document.documentElement.style.fontSize||"",D=Math.max(50,Math.min(500,Math.round(t*100)));return document.documentElement.style.fontSize=D+"%",()=>{document.documentElement.style.fontSize=v}},[t]),s.useEffect(()=>{const v=D=>{if(D.key==="ff_font_scale"){const T=parseFloat(D.newValue||"");Number.isFinite(T)&&T>=.5&&T<=5&&r(T)}};return window.addEventListener("storage",v),()=>window.removeEventListener("storage",v)},[]);const[i,l]=s.useState(null),[m,g]=s.useState([]),[h,p]=s.useState(window.innerHeight);s.useEffect(()=>{let v=!0;const D=async()=>{const[Y,j]=await Promise.all([ce(),qe()]);v&&(l(Y),g(j))};D();const T=setInterval(D,7e3),_=()=>p(window.innerHeight);return window.addEventListener("resize",_),()=>{v=!1,clearInterval(T),window.removeEventListener("resize",_)}},[]),s.useEffect(()=>{try{const v=new URLSearchParams(window.location.search);if(v.get("print")==="1"||v.get("pdf")==="1"){const D=setTimeout(()=>{window.print()},600);return()=>clearTimeout(D)}}catch{}},[]),s.useEffect(()=>{const v=()=>{try{window.close()}catch{}};return window.addEventListener("afterprint",v),()=>window.removeEventListener("afterprint",v)},[]);const w=s.useMemo(()=>new Map(m.map(v=>[v.id,v])),[m]),b=s.useMemo(()=>{const v={neu:{items:[]},"in-bearbeitung":{items:[]},erledigt:{items:[]}};return i?.columns?i.columns:v},[i]),V=s.useMemo(()=>{let v=0;for(const D of["neu","in-bearbeitung"])for(const T of b[D].items||[])v+=Pt(T);return v},[b]),k=s.useMemo(()=>{let v=0;for(const D of["neu","in-bearbeitung"])for(const T of b[D].items||[])v+=Mt(T,w);return v},[b,w]),M=s.useMemo(()=>(b.neu.items.length||0)+(b["in-bearbeitung"].items.length||0),[b]),L=s.useMemo(()=>M+(b.erledigt.items.length||0),[M,b]);return i?e.jsx("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden",children:e.jsxs("div",{className:"h-full w-full flex flex-col gap-2",children:[e.jsxs("header",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:"Einsatzstellen-Ãœbersicht-Feuerwehr"}),e.jsxs("div",{className:"text-base md:text-lg font-bold flex flex-wrap gap-4",children:[e.jsxs("span",{children:["ðŸš’ ",V]}),e.jsxs("span",{children:["ðŸ‘¥ ",k]}),e.jsxs("span",{children:["ðŸŸ¡ Aktiv: ",M]}),e.jsxs("span",{children:["ðŸ“¦ Gesamt: ",L]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2 min-h-0 flex-1",children:[e.jsx(Ze,{title:"Neu",cards:b.neu.items,vehiclesById:w,kind:"neu",viewportH:h}),e.jsx(Ze,{title:"In Bearbeitung",cards:b["in-bearbeitung"].items,vehiclesById:w,kind:"in-bearbeitung",viewportH:h}),e.jsx(Ze,{title:"Erledigt",cards:b.erledigt.items,vehiclesById:w,kind:"erledigt",viewportH:h})]})]})}):e.jsx("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden",children:e.jsx("div",{className:"h-full w-full flex items-center justify-center",children:"Ladeâ€¦"})})}function Yn(){const[t]=s.useState(.9);return t}const Xn=t=>`card:${t}`,Se=!0;async function es(t){if(!t||!window.google?.maps?.Geocoder)return null;const r=new google.maps.Geocoder;return new Promise(i=>{r.geocode({address:t,region:"AT"},(l,m)=>{if(m==="OK"&&l&&l[0]){const g=l[0],h=g.geometry?.location;i({lat:h?.lat?.(),lng:h?.lng?.(),formatted:g.formatted_address||t})}else i(null)})})}function ns(){if(Yn(),typeof window<"u"&&window.location.pathname==="/status")return e.jsx(Qn,{});const t=typeof window<"u"&&window.__USER__||null,[r,i]=s.useState(!1);s.useEffect(()=>{Qe().then(()=>i(!0))},[]);const l=r&&Ye("einsatzboard"),m=!l,[g,h]=s.useState(null),[p,w]=s.useState([]),[b,V]=s.useState([]),[k,M]=s.useState(""),[L,v]=s.useState(""),[D,T]=s.useState(""),[_,Y]=s.useState(null),[j,A]=s.useState(null),[K,C]=s.useState(""),[J,te]=s.useState(!1),[X,le]=s.useState(!1),[se,pe]=s.useState(!1),[I,de]=s.useState(30),[U,fe]=s.useState(!1),[x,H]=s.useState(!1),[ae,Z]=s.useState(!1),[G,ne]=s.useState(null),q=n=>{ne(n),Z(!0)},[y,$]=s.useState(window.location.hash);s.useEffect(()=>{const n=()=>$(window.location.hash);return window.addEventListener("hashchange",n),()=>window.removeEventListener("hashchange",n)},[]);const S=y.replace(/^#/,""),[R,B]=s.useState(()=>new Set),[a,u]=s.useState(0),N=s.useRef(0),P=s.useRef(new Set),[W,F]=s.useState(0);s.useEffect(()=>{document.title="Einsatzstellen-Ãœbersicht-Feuerwehr",pn()},[]);const{logout:ee}=fn?.()||{},Q=async()=>{try{await ee?.()}finally{window.location.href="/user-login"}};s.useEffect(()=>{if(!l)return;if(!se){F(0);return}const n=setInterval(()=>F(o=>o+1),1e3);return()=>clearInterval(n)},[Se,se]);const ie=se?Math.max(0,I-W%Math.max(1,I)):0,{query:he,setQuery:je,predictions:Pe,getDetailsByPlaceId:Tt,resetSession:Me,loading:$t,error:Xe}=Et({country:"at",debounceMs:300,minLength:3}),Te=s.useRef(null);s.useEffect(()=>{document.title="Einsatzstellen-Ãœbersicht-Feuerwehr"},[]),s.useEffect(()=>{(async()=>{const[n,o,c]=await Promise.all([ce(),qe(),Pn()]);h(n),w(o),V(Array.isArray(c)?c:[]);try{const d=await $n();pe(!!d.enabled),de(Number(d.intervalSec)||30),$e.current=tt(n)}catch{}F(0)})()},[Se]),s.useEffect(()=>{se&&(async()=>{try{(await fetch("/api/ff/status",{credentials:"include",cache:"no-store"}).then(o=>o.json()).catch(()=>({running:!1}))).running||await fetch("/api/ff/start",{method:"POST",credentials:"include"})}catch{}})()},[Se,se,I]),s.useEffect(()=>{v(he||"")},[he]),s.useEffect(()=>{let n;const o=Math.max(5,Math.min(60,se?8:15)),c=async()=>{try{const d=new Set($e.current),f=await ce();h(f),nt({oldIds:d,newBoard:f,pulseMs:8e3})}catch{}n=setTimeout(c,o*1e3)};return n=setTimeout(c,o*1e3),()=>clearTimeout(n)},[Se,se]),s.useEffect(()=>{const n=o=>{o.altKey&&(o.key==="e"||o.key==="E")&&(o.preventDefault(),H(!0),Me())};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[Se,Me]);const me=g??{columns:{neu:{items:[]},"in-bearbeitung":{items:[]},erledigt:{items:[]}}},Dt=10;function Rt(n){try{const o=n?.columns||{};return[(o.neu?.items||[]).length,(o["in-bearbeitung"]?.items||[]).length,(o.erledigt?.items||[]).length].some(d=>d>=Dt)}catch{return!1}}s.useEffect(()=>{const n=Rt(me);document.documentElement.classList.toggle("ui-dense",n)},[me]);const[_e,et]=s.useState(new Set),$e=s.useRef(new Set);s.useEffect(()=>{if(!_e.size)return;const n=setTimeout(()=>et(new Set),9e3);return()=>clearTimeout(n)},[_e]);function tt(n){const o=new Set;if(!n?.columns)return o;for(const c of Object.keys(n.columns))for(const d of n.columns[c].items||[])o.add(String(d.id));return o}function nt({oldIds:n,newBoard:o,pulseMs:c=8e3}){const d=Date.now(),f=tt(o),E=new Set;for(const z of f)n.has(z)||E.add(z);const O=new Set([...E].filter(z=>!P.current.has(String(z))));for(const z of E)P.current.delete(String(z));if(O.size>0&&(et(O),u(d+c),d>=N.current))try{Sn()}catch{}$e.current=f}const[ze,st]=s.useState(!1),Lt=async()=>{if(!ze){st(!0);try{const n=new Set($e.current),o=await fetch("/api/import/trigger",{method:"POST"});if(!o.ok){const d=await o.text().catch(()=>"");throw new Error(`Import fehlgeschlagen (HTTP ${o.status}) ${d}`)}const c=await ce();h(c),nt({oldIds:n,newBoard:c,pulseMs:8e3}),F(0)}catch(n){alert(n.message||"Import fehlgeschlagen.")}finally{st(!1)}}},[Ot,rt]=s.useState(!1),_t=n=>String(n).replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function zt(n,o){const c=String(o).match(/^(.*?)-(\d+)$/),d=c?c[1]:String(o);let f=c?parseInt(c[2],10):1;for(const E of n){const O=String(E.label||"").match(new RegExp("^"+_t(d)+"-(\\d+)$"));if(!O)continue;const z=parseInt(O[1],10);Number.isFinite(z)&&z>f&&(f=z)}return`${d}-${f+1}`}async function Ft(n,o){if(Ot)return;const c=Ne.get(n);if(c){rt(!0);try{const d=zt(p,c.label||c.id),f=await fetch("/api/vehicles",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ort:c.ort||"",label:d,mannschaft:0})}),E=await f.json().catch(()=>({}));if(!f.ok||E?.error)throw new Error(E?.error||"Clone fehlgeschlagen");const z=await(await fetch("/api/vehicles")).json();w(z);let oe=E?.vehicle?.id;oe||(oe=z.find(ve=>ve.label===d&&ve.ort===(c.ort||"")&&Number(ve.mannschaft)===0)?.id),o&&oe&&await Ge(o,oe),h(await ce())}catch(d){alert(d.message||"Clone fehlgeschlagen")}finally{rt(!1)}}}const Ne=s.useMemo(()=>new Map(p.map(n=>[n.id,n])),[p]),[at,it]=s.useState(new Map),Vt=s.useMemo(()=>{const n={};for(const[o,c]of Ne.entries())n[o]=c;return n},[Ne]),ot=s.useMemo(()=>{const n=new Set,o=me?.columns||{};for(const c of Object.keys(o))for(const d of o[c].items||[])for(const f of d.assignedVehicles||[])n.add(f);return n},[me]),ke=s.useMemo(()=>p.filter(n=>n&&typeof n.id<"u"&&!ot.has(n.id)),[p,ot]),xe=s.useMemo(()=>{const n={};for(const o of ke){const c=o.ort||"Unbekannt";(n[c]??=[]).push(o)}for(const o of Object.keys(n))n[o].sort((c,d)=>(c.label||c.id).localeCompare(d.label||d.id));return Object.entries(n).sort((o,c)=>o[0].localeCompare(c[0]))},[ke]);s.useEffect(()=>{if(localStorage.getItem("ff_collapsed_groups")||!xe.length)return;const o=xe.map(([c])=>c);De(new Set(o)),localStorage.setItem("ff_collapsed_groups",JSON.stringify(o))},[Se,xe]),s.useEffect(()=>{let n=setInterval(async()=>{try{const o=await fetch("/api/activity/status",{cache:"no-store"}).then(c=>c.json());typeof o?.auto?.enabled=="boolean"&&o.auto.enabled!==se&&pe(!!o.auto.enabled)}catch{}},3e3);return()=>clearInterval(n)},[Se,se]);function Fe(n,o){for(const c of["neu","in-bearbeitung","erledigt"])if((n.columns[c].items||[]).some(d=>d?.id===o))return c;return null}function Bt(n,o){for(const c of["neu","in-bearbeitung","erledigt"]){const d=(n.columns[c].items||[]).find(f=>f?.id===o);if(d)return d}return null}function Ve(n){const o=me?.columns?.[n]?.items||[];if(n==="erledigt"){const f=o.reduce((O,z)=>O+(z.everVehicles?.length||0),0),E=o.reduce((O,z)=>O+(Number.isFinite(z?.everPersonnel)?z.everPersonnel:0),0);return{cards:o.length,units:f,persons:E}}const c=o.reduce((f,E)=>f+(E.assignedVehicles?.length||0),0),d=o.reduce((f,E)=>Number.isFinite(E?.manualPersonnel)?f+E.manualPersonnel:f+(E.assignedVehicles||[]).reduce((O,z)=>O+(Ne.get(z)?.mannschaft??0),0),0);return{cards:o.length,units:c,persons:d}}const Kt=Ve("neu"),Ut=Ve("in-bearbeitung"),Ht=Ve("erledigt"),Gt=async()=>{const n=D.replace(/^T\d+\s*,?\s*/i,"").trim(),o=(k||n).trim();if(!o){alert("Bitte Typ oder Titel angeben.");return}const c={id:`tmp-${Math.random().toString(36).slice(2,10)}`,content:o,createdAt:new Date().toISOString(),statusSince:new Date().toISOString(),assignedVehicles:[],everVehicles:[],everPersonnel:0,ort:(L||"").trim(),typ:D.trim()};te(!0),h(d=>{if(!d)return d;const f=structuredClone(d);return f.columns.neu.items.unshift(c),f});try{let d=null;const f=Te.current;if(f?.geometry?.location?.lat&&f?.geometry?.location?.lng)d={lat:f.geometry.location.lat(),lng:f.geometry.location.lng()};else if(c.ort){const O=await es(c.ort);O&&(d={lat:O.lat,lng:O.lng})}const E=await ut(o,"neu",0,c.ort,c.typ,d??void 0);N.current=Date.now(),E?.card?.id!=null&&P.current.add(String(E.card.id)),h(O=>{if(!O)return O;const z=structuredClone(O),oe=z.columns.neu.items,Ie=oe.findIndex(ve=>ve?.id===c.id);return Ie>=0?oe[Ie]=E.card:oe.unshift(E.card),z}),M(""),je(""),v(""),T(""),Te.current=null,Me()}catch{h(d=>{if(!d)return d;const f=structuredClone(d);return f.columns.neu.items=f.columns.neu.items.filter(E=>E?.id!==c.id),f}),alert("Einsatz konnte nicht angelegt werden.")}finally{te(!1)}},Wt=async n=>{try{const o=await Tt(n.place_id,["formatted_address","geometry","address_components","place_id"]);Te.current=o||null;const c=o?.formatted_address||n.description;je(c),v(c)}catch(o){console.error("Place details failed:",o),Te.current=null,je(n.description),v(n.description)}finally{Me()}},Be=n=>String(n||"").split(/[;,\n]/).map(o=>o.trim()).filter(Boolean),ge=n=>String(n||"").normalize?.("NFD").replace?.(new RegExp("\\p{Diacritic}","gu"),"").replace(/^\s*FF\s+/i,"").replace(/[._\-\/]+/g," ").replace(/\s+/g," ").toLowerCase().trim();function Jt(n,o,c,d){const f=Be(n?.alerted).map(ge);if(f.length)for(const E of o){const O=f.some(oe=>ge(E?.ort)===oe),z=f.some(oe=>ge(E?.label)===oe);if(O||z){const oe=String(E.id);c.add(oe),d.has(oe)||d.set(oe,null)}}}async function Zt(n,o){if(!(o!=="neu"||!n?.id))try{const c=await Rn(n.id),d=new Set((c?.units||[]).map(re=>String(re.unitId)));if(n?.alerted){const re=Be(n.alerted).map(ge);for(const be of ke){const Ue=re.some(He=>ge(be.ort)===ge(He)),Ee=re.some(He=>ge(be.label)===ge(He));(Ue||Ee)&&d.add(String(be.id))}}B(d),u(Date.now()+3e3);const f=new Map;for(const re of c?.units||[]){const be=Number(re?.distanceKm);f.set(String(re.unitId),Number.isFinite(be)?be:null)}d.size===0&&n?.alerted&&Jt(n,ke,d,f),it(f);const E=new Set((c?.units||[]).filter(re=>!re.assigned).map(re=>String(re.unitId))),O=new Set(ke.map(re=>String(re.id))),z=new Set([...E,...[...d].filter(re=>O.has(re))]),oe=Be(n?.alerted).map(ge),Ie=new Set;if(oe.length&&ke.length>0)for(const[re,be]of xe){if(be.length===0)continue;oe.some(Ee=>ge(re)===ge(Ee))&&Ie.add(re)}const ve=[];for(const[re,be]of xe)(be.some(Ee=>z.has(String(Ee.id)))||Ie.has(re))&&ve.push(re);Yt(ve),clearTimeout(pulseTimerRef.current),pulseTimerRef.current=setTimeout(()=>{B(new Set),u(0),it(new Map)},3200)}catch(c){console.error("fetchNearby failed:",c)}}const[lt,De]=s.useState(()=>{try{const n=localStorage.getItem("ff_collapsed_groups");return new Set(n?JSON.parse(n):[])}catch{return new Set}}),qt=n=>lt.has(n),Qt=(n,o)=>{De(c=>{const d=new Set(c);return o?d.add(n):d.delete(n),localStorage.setItem("ff_collapsed_groups",JSON.stringify([...d])),d})},Yt=(n=[])=>{De(()=>{const o=xe.map(([d])=>d),c=new Set(o);for(const d of n)c.delete(d);return localStorage.setItem("ff_collapsed_groups",JSON.stringify([...c])),c})},Xt=(n=!0)=>{De(()=>{const o=xe.map(([d])=>d),c=n?new Set(o):new Set;return localStorage.setItem("ff_collapsed_groups",JSON.stringify([...c])),c})},en=()=>{const n=xe.map(([c])=>c),o=n.length>0&&n.every(c=>lt.has(c));Xt(!o)},[Re,Ke]=s.useState(null),[tn,Ce]=s.useState(null),nn=xn(ct(Cn,{activationConstraint:{distance:4}}),ct(kn,{activationConstraint:{delay:80,tolerance:6}})),sn=n=>{const o=n?.over;if(!o){Ce(null);return}const c=String(o.id||"");if(c.startsWith("col:"))Ce(c.slice(4));else if(c.startsWith("card:")){const d=Fe(me,c.slice(5));Ce(d)}else Ce(null)},rn=async n=>{if(m){Ce(null),Ke(null);return}Ce(null);const{active:o,over:c}=n;if(Ke(null),!o||!c)return;const d=String(o.id||""),f=String(c.id||"");if(d.startsWith("ass:")&&f.startsWith("card:")){const[,E,O]=d.split(":"),z=f.slice(5);if(E&&O&&z&&E!==z)try{await mt(E,O);try{await pt(O)}catch{}await Ge(z,O),h(await ce())}catch{alert("Einheit konnte nicht umgehÃ¤ngt werden.")}return}if(d.startsWith("veh:")&&f.startsWith("card:")){try{await Ge(f.slice(5),d.slice(4)),h(await ce())}catch{alert("Einheit konnte nicht zugewiesen werden.")}return}if(d.startsWith("card:")){const E=d.slice(5),O=Fe(me,E);if(!O)return;if(f.startsWith("col:")){const z=f.slice(4);if(O!==z)try{await Le({cardId:E,from:O,to:z,toIndex:0}),h(await ce())}catch{alert("Statuswechsel konnte nicht gespeichert werden.")}return}if(f.startsWith("card:")){const z=Fe(me,f.slice(5));if(z)try{await Le({cardId:E,from:O,to:z,toIndex:0}),h(await ce())}catch{alert("Statuswechsel konnte nicht gespeichert werden.")}}}},an=async()=>{if(confirm("Board wirklich zurÃ¼cksetzen?")){le(!0);try{await Tn(),h(await ce())}catch{alert("Reset fehlgeschlagen.")}finally{le(!1)}}},on=()=>window.open(Dn(),"_blank","noopener,noreferrer"),ln=async()=>{try{const n=await ht({enabled:!se,intervalSec:I});pe(!!n.enabled),de(Number(n.intervalSec)||30),F(0)}catch{alert("Konnte Auto-Import nicht Ã¤ndern.")}},cn=async n=>{const o=Math.max(5,Math.min(3600,Number(n)||30));de(o);try{await ht({enabled:se,intervalSec:o}),F(0)}catch{}},dn=async({title:n,ort:o,typ:c})=>{const d=await ut(n,"neu",0,o,c);N.current=Date.now(),d?.card?.id!=null&&P.current.add(String(d.card.id)),h(f=>{if(!f)return f;const E=structuredClone(f);return E.columns.neu.items.unshift(d.card),E})},un=n=>{T(n);const o=n.replace(/^T\d+\s*,?\s*/i,"").trim();k.trim()||M(o)};if(S.startsWith("/protokoll/edit/")){const n=S.split("/")[3],o=Number(n);return e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Meldung â€“ Bearbeiten"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"Zur Ãœbersicht"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(kt,{mode:"edit",editNr:o})})]})}return S.startsWith("/protokoll/neu")?e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Meldung â€“ Eintrag anlegen"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"Zur Ãœbersicht"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(kt,{mode:"create"})})]}):S.startsWith("/protokoll")?e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Meldestelle"}),e.jsx("button",{onClick:()=>{window.location.hash="/"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"â† ZurÃ¼ck"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(Gn,{})})]}):e.jsxs("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden flex flex-col",style:{fontSize:"var(--ui-scale)"},children:[!g&&e.jsx("div",{className:"fixed inset-0 z-10 bg-black/10 backdrop-blur-sm flex items-center justify-center",children:e.jsx("div",{className:"px-4 py-2 rounded-lg bg-white shadow",children:"Ladeâ€¦"})}),e.jsxs("header",{className:"flex flex-wrap items-center justify-between gap-2 mb-2",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:"Einsatzstellen-Ãœbersicht-Feuerwehr"}),e.jsxs("div",{className:"toolbar flex flex-wrap items-center gap-2",children:[e.jsx("button",{onClick:on,className:"px-3 py-1.5 rounded-md bg-purple-600 hover:bg-purple-700 text-white",children:"PDF"}),e.jsx("button",{onClick:Q,className:"px-3 py-1.5 rounded-md border border-gray-300 hover:bg-gray-100",title:t?.displayName?`Logout (${t.displayName})`:"Logout",children:"Logout"}),e.jsx("button",{onClick:()=>window.open("/api/log.csv","_blank"),className:"px-3 py-1.5 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white",title:"log.csv herunterladen",children:"LogÂ (CSV)"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-500 hover:bg-gray-600 text-white",children:"Meldestelle"}),e.jsx("button",{type:"button",onClick:()=>{window.location.href="/aufgaben"},className:"px-3 py-1.5 rounded-md bg-teal-600 hover:bg-teal-700 text-white",title:"Zum Aufgaben-Board",children:"Aufgaben"}),e.jsx("button",{onClick:Lt,disabled:m||ze,className:"px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-60",title:"Import sofort ausfÃ¼hren",children:ze?"Importâ€¦":"Import"}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm px-2 py-1 rounded-md bg-white border",children:[e.jsx("input",{type:"checkbox",checked:se,onChange:ln,disabled:m})," Auto-Import"]}),e.jsxs("label",{className:"interval-capsule flex items-center text-sm text-gray-700 bg-gray-50 border border-gray-300 rounded-md overflow-hidden",children:[e.jsx("span",{className:"pl-3 pr-2 select-none",children:"IntervallÂ (s):"}),e.jsx("input",{type:"number",min:"5",max:"3600",value:I,onChange:n=>cn(n.target.value),disabled:m,className:`h-9 w-20 bg-white border-0 rounded-none text-center text-gray-800 
               focus:outline-none focus:ring-0 focus:border-0`})]}),e.jsx(Wn,{autoEnabled:se,remaining:ie,disabled:m}),e.jsx("button",{onClick:an,disabled:m||X,className:`px-3 py-1.5 rounded-md text-white ${X?"bg-gray-400":"bg-gray-700 hover:bg-gray-800"}`,children:X?"Resetâ€¦":"Reset"})]})]}),e.jsxs("section",{className:"mb-2 grid grid-cols-1 md:grid-cols-7 gap-2",children:[e.jsxs("select",{className:"border rounded px-2 py-1 md:col-span-2",value:D,onChange:n=>un(n.target.value),children:[e.jsx("option",{value:"",children:"â€” Typ auswÃ¤hlen â€”"}),b.map(n=>e.jsx("option",{value:n,children:n},n))]}),e.jsx("input",{className:"border rounded px-2 py-1 md:col-span-2",placeholder:"Titel (wird aus Typ Ã¼bernommen)",value:k,onChange:n=>M(n.target.value)}),e.jsxs("div",{className:"relative md:col-span-2",children:[e.jsx("input",{className:"border rounded px-2 py-1 w-full",placeholder:"Ort (nur Ã–sterreich)",autoComplete:"off",value:he,onChange:n=>je(n.target.value)}),$t&&e.jsx("div",{className:"absolute z-10 mt-1 text-xs text-gray-500 bg-white border rounded px-2 py-1",children:"Sucheâ€¦"}),Xe&&e.jsxs("div",{className:"absolute z-10 mt-1 text-xs text-red-600 bg-white border rounded px-2 py-1",children:["Fehler: ",String(Xe)]}),!!Pe.length&&e.jsx("ul",{className:"absolute z-10 mt-1 w-full max-h-52 overflow-auto bg-white border rounded shadow",children:Pe.map(n=>e.jsx("li",{className:"px-2 py-1 hover:bg-gray-100 cursor-pointer text-sm",onClick:()=>Wt(n),title:n.description,children:n.description},n.place_id))})]}),e.jsx("button",{className:"px-3 py-1 rounded bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60",disabled:m||J,onClick:Gt,children:J?"Wird angelegtâ€¦":"Einsatz anlegen"})]}),e.jsxs(bn,{sensors:nn,collisionDetection:n=>n?.active?.data?.current?.type==="vehicle"?yn(n):wn(n),onDragStart:n=>Ke({type:n?.active?.data?.current?.type,id:n.active.id,data:n?.active?.data?.current}),onDragOver:sn,onDragEnd:rn,children:[e.jsxs("main",{className:"grid grid-cols-1 md:[grid-template-columns:minmax(180px,220px)_repeat(3,minmax(0,1fr))] gap-2 min-h-0 flex-1 overflow-hidden",children:[e.jsxs("section",{className:"bg-white rounded-xl shadow p-3 h-full flex flex-col min-h-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-semibold",children:e.jsx("button",{type:"button",onClick:en,title:"Alle Gruppen auf/zu klappen",className:"underline decoration-dotted hover:opacity-80 focus:outline-none",children:"Einheiten (frei)"})}),l&&e.jsx("button",{onClick:()=>fe(!0),className:"px-2 py-1 text-sm rounded bg-emerald-600 text-white",children:"+ Einheit"})]}),e.jsxs("div",{className:"overflow-auto pr-1 flex-1 min-h-0 space-y-3",children:[xe.length===0&&e.jsx("div",{className:"text-[0.85rem] text-gray-500 italic",children:"â€” alle Einheiten sind zugewiesen â€”"}),xe.map(([n,o])=>{const c=qt(n);return e.jsxs("div",{className:"border border-blue-400 rounded-md",children:[e.jsxs("button",{type:"button",onClick:()=>Qt(n,!c),className:"w-full flex items-center justify-between px-2 py-2 text-left",title:c?"aufklappen":"zuklappen",children:[e.jsx("span",{className:"text-xs font-semibold text-gray-700",children:n}),e.jsx("span",{className:"group-chip",children:o.length})]}),!c&&e.jsx("div",{className:"px-2 pb-2 grid grid-cols-1 gap-1.5",children:o.map(d=>e.jsx(En,{editable:l,vehicle:d,pillWidthPx:160,near:R.has(String(d.id))&&Date.now()<a,distKm:at.get(String(d.id))},d.id))})]},n)})]})]}),[{id:"neu",title:"Neu",bg:"bg-red-100",totals:Kt},{id:"in-bearbeitung",title:"In Bearbeitung",bg:"bg-yellow-100",totals:Ut},{id:"erledigt",title:"Erledigt",bg:"bg-green-100",totals:Ht}].map(({id:n,title:o,bg:c,totals:d})=>e.jsx("div",{className:tn===n?"drag-over":"",children:e.jsx(Kn,{editable:l,colId:n,bg:c,title:e.jsxs("span",{className:"column-header flex items-center justify-between",children:[e.jsx("span",{className:"font-semibold",children:o}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsxs("span",{className:"kpi-badge","data-variant":"units",children:["ðŸš’ ",d.units]}),e.jsxs("span",{className:"kpi-badge","data-variant":"persons",children:["ðŸ‘¥ ",d.persons]}),e.jsxs("span",{className:"kpi-badge","data-variant":"cards",children:["â¬› ",d.cards]})]})]}),children:e.jsx("ul",{className:"space-y-2 overflow-y-auto overflow-x-hidden pl-1 pr-2 py-2",style:{maxHeight:"calc(100vh - 260px)"},children:e.jsx(vn,{items:(me.columns[n].items||[]).map(f=>Xn(f.id)),strategy:jn,children:(me.columns[n].items||[]).map(f=>e.jsx(In,{editable:l,card:f,colId:n,vehiclesById:Ne,distById:at,pillWidthPx:160,pulse:_e.has(String(f.id))&&Date.now()<a,onUnassign:async(E,O)=>{await mt(E,O);try{await pt(O)}catch{}h(await ce())},onOpenMap:E=>Y({address:f.ort,card:f,board:me,vehiclesById:Vt}),onAdvance:l?async E=>{n==="neu"?(await Le({cardId:E.id,from:"neu",to:"in-bearbeitung",toIndex:0}),h(await ce())):n==="in-bearbeitung"&&(await Le({cardId:E.id,from:"in-bearbeitung",to:"erledigt",toIndex:0}),h(await ce()))}:void 0,onEditPersonnelStart:l?(E,O)=>{A({cardId:E.id}),C(O)}:void 0,editing:j,editingValue:K,setEditingValue:C,onEditPersonnelSave:l?async E=>{try{await Mn(E.id,K===""?null:Number(K)),h(await ce())}finally{A(null),C("")}}:void 0,onEditPersonnelCancel:l?()=>{A(null),C("")}:void 0,onClone:Ft,onVehiclesIconClick:Zt,nearIds:R,nearUntilMs:a,onShowInfo:q},f.id))})})})},n))]}),e.jsxs(Nn,{dropAnimation:{duration:180,easing:"ease-out"},children:[Re?.type==="vehicle"&&(()=>{const n=Ne.get(Re?.data?.vehicleId);return n?e.jsx("div",{className:"pointer-events-none",children:e.jsxs("div",{style:{width:160},className:"max-w-full select-none border-2 border-red-300 rounded-2xl bg-white px-2 py-1 shadow-lg",children:[e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:n.label||n.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate",children:[n.ort||"â€”"," Â· ðŸ‘¥ ",n.mannschaft??0]})]})}):null})(),Re?.type==="card"&&(()=>{const n=String(Re?.id||"").replace(/^card:/,""),o=Bt(me,n);return o?e.jsx("div",{className:"pointer-events-none w-[280px]",children:e.jsxs("div",{className:"rounded-lg bg-white shadow-xl border p-3",children:[e.jsx("div",{className:"font-semibold text-sm mb-1 truncate",children:o.content}),e.jsxs("div",{className:"text-xs text-gray-600",children:[o.assignedVehicles?.length||0," Einheiten â€¢"," ","ðŸ‘¥ ",Number.isFinite(o?.manualPersonnel)?o.manualPersonnel:(o.assignedVehicles||[]).reduce((c,d)=>c+(Ne.get(d)?.mannschaft??0),0)]})]})}):null})()]})]}),l&&e.jsx("button",{className:"fab",title:"Einsatz anlegen",onClick:()=>H(!0),children:"ï¼‹"}),e.jsx("a",{href:"/Hilfe.pdf",target:"_blank",rel:"noopener noreferrer",className:"fixed bottom-4 right-4 px-4 py-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-lg",children:"Hilfe"}),U&&e.jsx(Fn,{onClose:()=>fe(!1),onCreate:async n=>{const o=await fetch("/api/vehicles",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!o.ok){const c=await o.text().catch(()=>String(o.status));throw new Error(`HTTP ${o.status} ${c}`)}w(await qe())}}),x&&e.jsx(Bn,{onClose:()=>H(!1),onCreate:dn,types:b}),_&&e.jsx(zn,{context:_,onClose:()=>Y(null)}),e.jsx(Un,{open:ae,info:G||{},onClose:()=>{Z(!1),ne(null)}})]})}export{ns as default};
