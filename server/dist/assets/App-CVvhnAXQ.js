import{u as On,j as e,r as a,a as Ds,C as _s,s as bn,b as Wt,c as Bs,d as Vn,e as Os,l as xn,f as Vs,g as Us,h as Hs,i as Me,k as Ke,m as Ks,n as yn,o as wn,p as Vt,q as Gs,t as Ws,v as qs,w as Zs,x as vn,y as Js,z as Qs,A as Ys,B as Xs,D as Sn,E as xt,P as Nn,S as jn,F as er,G as tr,H as nr,I as sr,J as rr,K as ar,L as yt,M as An,N as kn,O as ir,Q as Cn,R as In,T as Ut,U as or,V as lr,W as cr,X as dr,Y as ur,Z as fr}from"./index-D863VuTX.js";function En({cardId:n,vehicle:s,pillWidthPx:i=160,onUnassign:c,onClone:d,near:b=!1,distKm:f=null,readonly:v=!1}){const I=`ass:${n}:${s.id}`,j=v?null:On({id:I,data:{type:"assigned",vehicleId:s.id,fromCardId:n}}),M=j?.attributes??{},D=j?.listeners??{},P=j?.setNodeRef??(()=>{}),$=j?.transform??null,z=j?.isDragging??!1,S={width:i,transform:$?`translate3d(${$.x}px, ${$.y}px, 0)`:void 0};return e.jsxs("div",{ref:P,style:S,...M,...D,className:`relative self-start border-2 rounded-2xl bg-white px-2 pr-9 py-1 shadow-sm
                  select-none ${v?"cursor-not-allowed":"cursor-grab active:cursor-grabbing"}
                  ${b?"border-emerald-500 ring-2 ring-emerald-300":"border-red-300"}
                  ${z?"opacity-50":""}`,title:v?"Einheit kann derzeit nicht verschoben werden":"Ziehen: auf andere Karte verschieben Â· Doppelklick: klonen",onDoubleClick:()=>{v||d?.(s.id,n)},"aria-disabled":v,children:[b&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-0.5 rounded-2xl border-2 border-emerald-400/50 animate-ping"}),e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:s.label||s.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate flex justify-between items-center",children:[e.jsxs("span",{children:[s.ort||"â€”"," Â· ðŸ‘¥ ",s.mannschaft??0]}),b&&Number.isFinite(Number(f))&&e.jsxs("span",{className:"absolute top-1 right-8 text-[11px] tabular-nums text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded whitespace-nowrap",children:[Number(f)," Km"]})]}),!v&&e.jsx("button",{type:"button",onMouseDown:x=>x.stopPropagation(),onTouchStart:x=>x.stopPropagation(),onClick:x=>{x.stopPropagation(),c?.(n,s.id)},title:"Einheit entfernen",className:"absolute right-2 top-1/2 -translate-y-1/2 h-6 w-6 rounded-full bg-red-600 text-white shadow flex items-center justify-center","aria-label":"Einheit entfernen",children:e.jsx("svg",{viewBox:"0 0 12 12",width:"12",height:"12","aria-hidden":"true",children:e.jsx("path",{d:"M1 1 L11 11 M11 1 L1 11",stroke:"white",strokeWidth:"2",strokeLinecap:"round"})})})]})}const Mn=n=>{const s=String(n||"");return s?/^B/i.test(s)?`B${s.slice(1)}`:/^[A-Za-z]/.test(s)?`B${s.slice(1)}`:`B${s}`:""};function mr(n){const{card:s,colId:i,vehiclesById:c,pillWidthPx:d=160,onUnassign:b,onOpenMap:f,onAdvance:v,onEditPersonnelStart:I,editing:j,editingValue:M,setEditingValue:D,onEditPersonnelSave:P,onEditPersonnelCancel:$,onClone:z,onVehiclesIconClick:S,onShowInfo:x,areaOptions:u=[],areaLabelById:g=new Map,areaColorById:T=new Map,onAreaChange:E,onEditCard:N,nearIds:V,nearUntilMs:_,distById:U,pulse:se,editable:re=!0}=n,[G,H]=a.useState(!1),[J,Q]=a.useState(!1),fe=a.useRef((s.assignedVehicles||[]).length),le=a.useRef(null),K=a.useRef(null),L=Date.now()<(_||0);a.useEffect(()=>{H(!1)},[i]),a.useEffect(()=>()=>{K.current&&(clearTimeout(K.current),K.current=null)},[]);const xe=re?Ds({id:`card:${s.id}`,data:{type:"card",cardId:s.id}}):{attributes:{},listeners:{},setNodeRef:()=>{},transform:null,transition:null,isDragging:!1},{attributes:O,listeners:q,setNodeRef:me,transform:ae,transition:Se,isDragging:he}=xe,k=a.useMemo(()=>{if(!s)return null;const p=typeof s.areaColor=="string"&&s.areaColor?s.areaColor:null;if(s.isArea)return p;if(!s.areaCardId)return null;if(p)return p;const te=String(s.areaCardId);if(T.has(te))return T.get(te)||null;const ke=(u||[]).find(ge=>String(ge.id)===te);return ke?.color?ke.color:null},[s,T,u]),W={transform:_s.Transform.toString(ae),transition:Se,opacity:he?.8:1,borderColor:k||void 0,borderWidth:k?"2px":void 0},ie=i==="erledigt"?s.everVehicles?.length||0:s.assignedVehicles?.length||0,de=a.useMemo(()=>(s.assignedVehicles||[]).map(p=>c.get(p)).filter(Boolean),[s,c]),ye=a.useMemo(()=>i==="erledigt"?Number.isFinite(s?.everPersonnel)?s.everPersonnel:0:Number.isFinite(s?.manualPersonnel)?s.manualPersonnel:de.reduce((p,te)=>p+(te?.mannschaft??0),0),[i,s,de]);a.useEffect(()=>{if(i!=="in-bearbeitung"||!L)return;(s.assignedVehicles||[]).some(te=>V?.has(String(te)))&&H(!0)},[i,L,V,s.assignedVehicles]),a.useEffect(()=>{if(i!=="in-bearbeitung")return;const p=(s.assignedVehicles||[]).length,te=fe.current;p>te&&H(!0),fe.current=p},[i,s.assignedVehicles]),a.useEffect(()=>{if(i==="in-bearbeitung"&&G&&le.current)try{le.current.scrollIntoView({behavior:"smooth",block:"nearest"})}catch{}},[i,G]);const pe=()=>{i==="neu"?typeof S=="function"&&S(s,i):(i==="in-bearbeitung"||i==="erledigt")&&H(p=>!p)},oe=()=>{re&&typeof I=="function"&&I(s,ye)},we=s?.isEditable!==!1,Y=a.useMemo(()=>s?.humanId?s?.isArea?Mn(s.humanId):String(s.humanId):"",[s?.humanId,s?.isArea]),X=p=>{if(!p)return"";const te=p.humanId?String(p.humanId):"",ke=p.isArea?Mn(te):te,ge=p.content?String(p.content):"";return[ke,ge].filter(Boolean).join(" â€“ ")||ke||ge||""},ce=a.useMemo(()=>{if(s?.isArea)return X(s);if(!s?.areaCardId)return"";const p=String(s.areaCardId),te=g.get(p);if(te)return te;const ke=(u||[]).find(ge=>String(ge.id)===p);return ke?ke.label:String(s.areaCardId)},[s,g,u]),F=a.useMemo(()=>(u||[]).filter(p=>String(p.id)!==String(s.id)),[u,s.id]),ee=re&&!s.isArea&&typeof E=="function",ve=s.areaCardId?String(s.areaCardId):"",Ne=p=>{ee&&E(s,p)},Te=J||G,Ie=()=>{K.current&&clearTimeout(K.current),K.current=setTimeout(()=>{Q(!0),K.current=null},300)},je=()=>{K.current&&(clearTimeout(K.current),K.current=null),Q(!1)},ue=()=>{K.current&&(clearTimeout(K.current),K.current=null),Q(!0)},Le=()=>{K.current&&(clearTimeout(K.current),K.current=null),Q(!1)},$e=s.isArea?"bg-slate-100 border-slate-200":"bg-white",Ee=s.isArea?"bg-slate-200 hover:bg-slate-300":"bg-white hover:bg-gray-50",Ge=s.isArea?"bg-slate-200 hover:bg-slate-300":"bg-white hover:bg-red-50";return e.jsxs("li",{ref:me,style:W,tabIndex:0,className:`relative rounded-lg shadow border transition mx-1 focus:outline-none ${$e} ${se&&i==="neu"?"ring-2 ring-red-400/60":""}`,onMouseEnter:Ie,onMouseLeave:je,onFocus:ue,onBlur:Le,children:[se&&i==="neu"&&e.jsxs(e.Fragment,{children:[e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 rounded-lg bg-red-500/10 animate-pulse-inner"}),e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 rounded-lg animate-ping-safe"})]}),e.jsxs("div",{className:`p-3 select-none ${s.isArea?"bg-slate-100 rounded-lg":""}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",...O,...q,children:[e.jsxs("div",{className:"min-w-0",children:[Y&&e.jsxs("div",{className:"text-[11px] font-semibold uppercase tracking-wide text-gray-500",children:["Einsatz: ",Y]}),s.isArea&&e.jsx("div",{className:"text-[11px] font-semibold uppercase tracking-wide text-emerald-600",children:"Abschnitt"}),e.jsx("div",{className:"font-semibold text-sm leading-5 truncate",children:s.content}),!!s.ort&&e.jsx("button",{type:"button",onClick:()=>f?.(s.ort),className:"text-[12px] text-blue-700 hover:underline truncate",title:"Ort in Karte Ã¶ffnen",children:s.ort})]}),e.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[e.jsxs("button",{type:"button",title:i==="neu"?"Nahe Einheiten prÃ¼fen":"Einheiten auf-/zuklappen",className:`px-2 py-1 rounded text-[12px] border flex items-center gap-1 ${Ge}`,onPointerDown:p=>p.stopPropagation(),onClick:p=>{p.stopPropagation(),p.preventDefault(),pe()},children:["ðŸš’ ",ie,(i==="in-bearbeitung"||i==="erledigt")&&e.jsx("span",{children:G?"â–¾":"â–¸"})]}),e.jsxs("button",{type:"button",className:`px-2 py-1 rounded text-[12px] border ${Ee}`,title:"Personalzahl bearbeiten",onPointerDown:p=>p.stopPropagation(),onClick:p=>{p.stopPropagation(),oe()},children:["ðŸ‘¥ ",ye]}),re&&v&&e.jsx("button",{type:"button",onPointerDown:p=>p.stopPropagation(),onClick:p=>{p.stopPropagation(),v(s)},className:`ml-1 px-2 py-1 rounded text-[12px] border ${Ee}`,title:"weiter",children:"âž”"})]})]}),e.jsx("div",{className:`mt-0 overflow-hidden transition-all duration-200 ease-in-out ${Te?"max-h-[2000px] opacity-100 pointer-events-auto":"max-h-0 opacity-0 pointer-events-none"}`,children:e.jsxs("div",{className:"pt-2 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-[12px]",children:[e.jsx("span",{className:"text-gray-600 whitespace-nowrap",children:"Abschnitt"}),ee?e.jsxs("select",{className:"border rounded px-2 py-1 text-[12px] min-w-[140px]",value:ve,onChange:p=>Ne(p.target.value),onPointerDown:p=>p.stopPropagation(),children:[e.jsx("option",{value:"",children:"â€” Abschnitt auswÃ¤hlen â€”"}),F.map(p=>e.jsx("option",{value:p.id,children:p.label},p.id))]}):e.jsx("span",{className:"font-medium text-gray-800",children:ce||"â€”"})]}),i==="neu"&&!!de.length&&e.jsx("div",{className:"flex flex-wrap gap-1.5",children:de.map(p=>{const te=p?.available!==!1,ke=p?.groupAvailable!==!1,ge=!re||!te||!ke;return e.jsx(En,{cardId:s.id,vehicle:p,pillWidthPx:d,onUnassign:b,onClone:z,near:!!V&&L&&V.has(String(p.id)),readonly:ge,distKm:U?.get(String(p.id))??null},`ass-${s.id}-${p.id}`)})}),i==="in-bearbeitung"&&G&&!!de.length&&e.jsx("div",{ref:le,className:"flex flex-wrap gap-1.5",children:de.map(p=>{const te=p?.available!==!1,ke=p?.groupAvailable!==!1,ge=!re||!te||!ke;return e.jsx(En,{cardId:s.id,vehicle:p,pillWidthPx:d,onUnassign:b,onClone:z,near:!!V&&L&&V.has(String(p.id)),readonly:ge,distKm:U?.get(String(p.id))??null},`ass-${s.id}-${p.id}`)})}),i==="erledigt"&&G&&!!s.everVehicles?.length&&e.jsx("ul",{className:"text-sm text-gray-700 list-disc list-inside space-y-1",children:s.everVehicles.map(p=>{const te=c.get(p),ke=String(p),ge=s?.everVehicleLabels?.[ke],We=typeof ge=="string"?ge:ge?.label,Be=typeof ge=="object"&&ge?ge.ort:null,nt=te?.label||We||te?.id||"Unbekannt",qe=te?.ort??Be??null,kt=qe?` (${qe})`:"";return e.jsxs("li",{children:[nt,kt]},p)})}),re&&j?.cardId===s.id&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",className:"w-20 border rounded px-2 py-1 text-sm",value:M,onChange:p=>D(p.target.value),placeholder:"Personen"}),e.jsx("button",{className:"px-2 py-1 text-sm rounded bg-emerald-600 text-white",onClick:()=>P(s),children:"Speichern"}),e.jsx("button",{className:"px-2 py-1 text-sm rounded bg-gray-200",onClick:$,children:"Abbrechen"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[re&&we&&typeof N=="function"&&e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Bearbeiten",onPointerDown:p=>p.stopPropagation(),onClick:p=>{p.stopPropagation(),N(s)},children:"âœŽ"}),e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Ort in Karte Ã¶ffnen",onPointerDown:p=>p.stopPropagation(),onClick:p=>{p.stopPropagation(),f?.(s.ort)},children:"Karte"}),e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Einsatz-Info",onPointerDown:p=>p.stopPropagation(),onClick:p=>{p.stopPropagation(),x?.(s)},children:"?"})]})]})})]})]})}function hr({vehicle:n,pillWidthPx:s=160,near:i=!1,distKm:c=null,editable:d=!0}){const b=`veh:${n.id}`,f=n?.available!==!1,v=n?.groupAvailable!==!1,I=d&&f&&v,j=I?On({id:b,data:{type:"vehicle",vehicleId:n.id}}):null,M=j?.attributes??{},D=j?.listeners??{},P=j?.setNodeRef??(()=>{}),$=j?.transform??null,z=j?.isDragging??!1,S=!f||!v,x={width:s,transform:$?`translate3d(${$.x}px, ${$.y}px, 0)`:void 0};return S&&!z&&(x.opacity=.6),e.jsxs("div",{ref:P,style:x,...M,...D,className:`relative max-w-full select-none border-2 ${i?"border-emerald-500":"border-red-300"} rounded-2xl bg-white
                 px-2 py-1 shadow-sm
                 ${I?"cursor-grab active:cursor-grabbing":"cursor-not-allowed"}
                 ${z?"opacity-50":""}
                 ${S?"border-gray-200 bg-gray-100":""}`,"aria-disabled":!I,children:[i&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-0.5 rounded-2xl border-2 border-emerald-400/50 animate-ping"}),e.jsx("div",{className:`text-[13px] font-semibold leading-5 truncate ${S?"text-gray-500":""}`,children:n.label||n.id}),e.jsxs("div",{className:`text-[12px] leading-4 truncate flex justify-between items-center ${S?"text-gray-400":"text-gray-600"}`,children:[e.jsxs("span",{children:[n.ort||"â€”"," Â· ðŸ‘¥ ",n.mannschaft??0]}),i&&Number.isFinite(Number(c))&&e.jsxs("span",{className:"absolute top-1 right-1 text-[11px] tabular-nums text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded whitespace-nowrap",children:[Number(c)," Km"]})]})]})}const Ht=n=>Array.isArray(n?.assignedVehicles)?n.assignedVehicles:Array.isArray(n?.assigned_vehicle_ids)?n.assigned_vehicle_ids:[];function gr(n,s){const c=(s.lat-n.lat)*Math.PI/180,d=(s.lng-n.lng)*Math.PI/180,b=Math.sin(c/2)**2+Math.cos(n.lat*Math.PI/180)*Math.cos(s.lat*Math.PI/180)*Math.sin(d/2)**2;return 2*6371*Math.asin(Math.sqrt(b))}function Kt(n,s,i){const d=i*Math.PI/180,b=n.lat*Math.PI/180,f=n.lng*Math.PI/180,v=s/6371e3,I=Math.asin(Math.sin(b)*Math.cos(v)+Math.cos(b)*Math.sin(v)*Math.cos(d))*180/Math.PI,j=(f+Math.atan2(Math.sin(d)*Math.sin(v)*Math.cos(b),Math.cos(v)-Math.sin(b)*Math.sin(I*Math.PI/180)))*180/Math.PI;return{lat:I,lng:j}}async function Pn(n){if(!n||!window.google?.maps?.Geocoder)return null;const s=new window.google.maps.Geocoder;return new Promise(i=>{s.geocode({address:n,region:"AT"},(c,d)=>{d==="OK"&&c?.[0]?.geometry?.location?i({lat:c[0].geometry.location.lat(),lng:c[0].geometry.location.lng(),formatted:c[0].formatted_address||n}):i(null)})})}const Ve=n=>String(n||"").trim().toLowerCase();async function Tn(){try{const n=await fetch("/api/vehicles",{cache:"no-store",credentials:"include"});if(!n.ok)return[];const s=await n.json();return Array.isArray(s)?s:[]}catch{return[]}}async function Ln(){try{const n=await fetch("/api/board",{cache:"no-store",credentials:"include"});if(!n.ok)return null;const s=await n.json();if(s&&typeof s=="object")return s}catch(n){console.error("Board fetch failed:",n)}return null}function $n(n,s){const i=new Map;if(Array.isArray(s))for(const c of s)!c||c.id==null||i.set(String(c.id),{...c});if(n&&typeof n=="object")for(const c of Object.values(n)){if(!c||c.id==null)continue;const d=String(c.id),b=i.get(d)||{};i.set(d,{...b,...c})}return[...i.values()]}async function Rn(){try{const n=await fetch("/api/gps",{cache:"no-store",credentials:"include"});if(n.ok)return await n.json()}catch(n){console.error("GPS fetch failed:",n)}return[]}function Fn(n){const s=n?.typ||n?.type||"â€”",i=n?.createdAt||n?.timestamp,c=i?new Date(i).toLocaleString("de-AT",{hour12:!1}):"â€”",d=n?.alerted??"â€”",b=n?.description??"â€”",f=n?.additionalAddressInfo||n?.ort||"â€”",v=[];n?.location&&v.push(String(n.location));const I=Number.isFinite(n?.latitude),j=Number.isFinite(n?.longitude);I&&j&&v.push(`(${n.latitude}, ${n.longitude})`);const M=v.length?v.join(" "):"â€”";return`
    <div style="min-width:280px">
      <div style="font-weight:700;margin-bottom:4px">${n?.content||"Einsatz"}</div>
      <div><b>Typ:</b> ${s}</div>
      <div><b>Alarmzeit:</b> ${c}</div>
      <div><b>Alarmiert:</b> ${d}</div>
      <div><b>Beschreibung:</b> ${b}</div>
      <div><b>Adresse:</b> ${f}</div>
      <div><b>Location:</b> ${M}</div>
    </div>
  `}const _e=44,zn="/vehicle-red.gif",pr="/vehicle-gray.png",br="/vehicle-drive.gif";function xr({context:n,address:s,onClose:i}){const c=s||n?.card?.ort||n?.address||"",d=!!window.google?.maps,b=a.useRef(null),f=a.useRef(!1),[v,I]=a.useState(!1),[j,M]=a.useState(""),D=a.useMemo(()=>{const P=n?.card;return P&&Number.isFinite(P?.latitude)&&Number.isFinite(P?.longitude)?{lat:Number(P.latitude),lng:Number(P.longitude)}:null},[n]);if(a.useEffect(()=>{if(!d||!n?.card||!b.current)return;f.current=!1;let P=!1,$,z;const S=new Map;let x=null;const u=n?.card?.id!=null?String(n.card.id):null;let g=n?.board;const T=async(N,V)=>{if(!(!u||f.current)&&!(!Number.isFinite(N?.lat)||!Number.isFinite(N?.lng)))try{const _={latitude:N.lat,longitude:N.lng};V&&!n?.card?.location&&(_.location=V),await Wt(u,_),f.current=!0}catch(_){console.error("Geocoding-Persistierung fehlgeschlagen:",_)}};return(async()=>{try{if(I(!0),M(""),!g||typeof g!="object"||!g.columns){const k=await Ln();if(P)return;k&&typeof k=="object"&&(g=k)}let N=D;if(!N){const k=await Pn(n.card.ort);if(P)return;k&&(N={lat:k.lat,lng:k.lng},T(N,k.formatted))}N||(N={lat:46.7227,lng:14.0952},M("Einsatz-Position unbekannt â€“ zeige Karte mit Default-Zentrum.")),$=new window.google.maps.Map(b.current,{center:N,zoom:18,mapTypeId:"roadmap"}),z=new window.google.maps.InfoWindow;const V=(k,W,ie,de,{hover:ye=!1}={})=>{const pe={path:"M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z",fillColor:W,fillOpacity:1,strokeColor:"#333",strokeWeight:1,scale:1.2},oe=new window.google.maps.Marker({position:k,map:$,title:ie,icon:pe});if(de){const we=()=>{z.setContent(de),z.open($,oe)};ye?(oe.addListener("mouseover",we),oe.addListener("mouseout",()=>z.close())):oe.addListener("click",we)}return oe};V(N,"#d11a1a",n.card.content||"Einsatz",Fn(n.card),{hover:!0});const _=[],U=new Set,se=k=>{if(!k||k.id==null)return;const W=String(k.id);U.has(W)||(U.add(W),_.push(k))},G=(g||n?.board)?.columns||{};for(const k of G?.neu?.items||[])se(k);for(const k of G?.["in-bearbeitung"]?.items||[])se(k);u&&se(n?.card);const H=new Map;for(const k of _){const W=String(k.id);if(Number.isFinite(k.latitude)&&Number.isFinite(k.longitude))H.set(W,{lat:Number(k.latitude),lng:Number(k.longitude)});else if(k.ort){const ie=await Pn(k.ort);ie&&H.set(W,{lat:ie.lat,lng:ie.lng})}}u&&N&&H.set(u,N);for(const k of _){const W=String(k.id);if(u&&W===u)continue;const ie=H.get(W);ie&&V(ie,"#1e63d1",k.content||"Einsatz",Fn(k),{hover:!0})}const J=new Map;for(const k of _)for(const W of Ht(k))J.set(String(W),String(k.id));const Q=await Rn(),fe=new Map(Q.filter(k=>Number.isFinite(k?.lat)&&Number.isFinite(k?.lng)&&k?.realname).map(k=>[Ve(k.realname),k])),le=await Tn(),K=new Map(le.filter(k=>k&&k.source!=="gps"&&Number.isFinite(k.latitude)&&Number.isFinite(k.longitude)).map(k=>[String(k.id),{lat:Number(k.latitude),lng:Number(k.longitude)}])),L=$n(n.vehiclesById,le),xe=10,O=50,q=new Map,me=window.google?.maps?.marker?.AdvancedMarkerElement,ae=typeof me=="function"&&typeof me?.prototype?.addListener=="function"?me:null,Se=(k,W,ie)=>{if(!k)return pr;if(!W||!ie||!H.has(ie))return zn;const de=H.get(ie);return gr(W,de)>.1?br:zn},he=(k,W,ie,de,ye,pe)=>{const oe=Se(W,de,ye),we=!de;if(ae){const Y=document.createElement("img");Y.src=oe,Y.width=_e,Y.height=_e,Y.alt=ie||"",Y.decoding="async";const X=new ae({map:$,position:k,content:Y,title:ie});if(we){try{X.draggable=!0}catch{}typeof X.addListener=="function"&&X.addListener("dragend",async ce=>{const F=ce?.latLng||X.position,ee=typeof F.lat=="function"?F.lat():F.lat,ve=typeof F.lng=="function"?F.lng():F.lng;try{await bn(pe,ee,ve,ye,"manual")}catch(Ne){X.__setPosition(k),console.error("setVehiclePosition failed:",Ne),alert("Position konnte nicht gespeichert werden.")}})}return X.__setPosition=ce=>{X.position=ce},X.__setIcon=(ce,F,ee)=>{Y.src=Se(ce,F,ee)},X.__onOver=ce=>{Y.addEventListener("mouseover",ce),Y.addEventListener("mouseout",()=>z.close())},X}else{const Y=new window.google.maps.Marker({position:k,map:$,title:ie,draggable:we,icon:{url:oe,scaledSize:new window.google.maps.Size(_e,_e),anchor:new window.google.maps.Point(_e/2,_e/2)}});return we&&Y.addListener("dragend",async X=>{const ce=X?.latLng||Y.getPosition(),F=typeof ce.lat=="function"?ce.lat():ce.lat,ee=typeof ce.lng=="function"?ce.lng():ce.lng;try{await bn(pe,F,ee,ye,"manual")}catch(ve){Y.__setPosition(k),console.error("setVehiclePosition failed:",ve),alert("Position konnte nicht gespeichert werden.")}}),Y.__setPosition=X=>Y.setPosition(X),Y.__setIcon=(X,ce,F)=>Y.setIcon({url:Se(X,ce,F),scaledSize:new window.google.maps.Size(_e,_e),anchor:new window.google.maps.Point(_e/2,_e/2)}),Y.__onOver=X=>{Y.addListener("mouseover",X),Y.addListener("mouseout",()=>z.close())},Y}};for(const k of L){const W=String(k.id),ie=Ve(`${k?.label||""} ${k?.ort||""}`),de=Ve(k?.label||""),ye=Ve(k?.ort||""),pe=fe.get(ie)||fe.get(de)||fe.get(ye),oe=J.get(W),we=K.has(W);if(!oe&&!pe&&!we)continue;let Y=null,X=null;if(pe)X={lat:Number(pe.lat),lng:Number(pe.lng)},Y=X;else if(we)Y=K.get(W);else if(oe){const Ne=H.get(oe)||(u===oe?N:null),Ie=((q.get(oe)||0)+O)%360;q.set(oe,Ie),Ne&&(Y=Kt(Ne,xe,Ie))}if(!Y)continue;const F=he(Y,!!oe,k.label||k.id,X,oe,W),ee=oe&&_.find(Ne=>String(Ne.id)===oe),ve=ee?`<br/><i>zugeordnet: ${ee.content}</i>`:"";F.__onOver(()=>{const Ne=k?.ort||"";z.setContent(`<div style="min-width:220px"><b>${k.label||k.id}</b>${Ne?`<br/>${Ne}`:""}${ve}</div>`);const Te=ae?void 0:F;z.open({map:$,anchor:Te,position:Y,shouldFocus:!1})}),S.set(W,F)}$.setCenter(N),$.setZoom(18),x=setInterval(async()=>{const k=await Rn(),W=await Tn();if(!g||typeof g!="object"||!g.columns){const F=await Ln();if(P)return;F&&typeof F=="object"&&(g=F)}const ie=g||n?.board,de=new Map(W.filter(F=>F&&F.source!=="gps"&&Number.isFinite(F.latitude)&&Number.isFinite(F.longitude)).map(F=>[String(F.id),{lat:Number(F.latitude),lng:Number(F.longitude)}])),ye=new Map(k.filter(F=>Number.isFinite(F?.lat)&&Number.isFinite(F?.lng)&&F?.realname).map(F=>[Ve(F.realname),F])),pe=new Map,oe=[...ie?.columns?.neu?.items||[],...ie?.columns?.["in-bearbeitung"]?.items||[]];for(const F of oe){const ee=F?.id!=null?String(F.id):null;if(ee)for(const ve of Ht(F))pe.set(String(ve),ee)}if(u)for(const F of Ht(n.card))pe.set(String(F),u);const we=$n(n.vehiclesById,W),Y=new Map;for(const F of we){const ee=String(F.id),ve=pe.get(ee),Ne=Ve(`${F?.label||""} ${F?.ort||""}`);if(ve&&!ye.get(Ne)&&!de.has(ee)){const Te=Y.get(ve)||[];Te.push(ee),Y.set(ve,Te)}}for(const[F,ee]of Y.entries())ee.sort();const X=10,ce=50;for(const F of we){const ee=String(F.id),ve=Ve(`${F?.label||""} ${F?.ort||""}`),Ne=Ve(F?.label||""),Te=Ve(F?.ort||""),Ie=ye.get(ve)||ye.get(Ne)||ye.get(Te),je=pe.get(ee);let ue=null;const Le=de.has(ee),$e=!!je||!!Ie||!!Le;let Ee=S.get(ee);if(!Ee&&$e){let p=null;if(Ie)ue={lat:Number(Ie.lat),lng:Number(Ie.lng)},p=ue;else if(Le)p=de.get(ee);else if(je){const te=H.get(je)||(u===je?N:null);if(te){const We=((Y.get(je)||[]).indexOf(ee)+1)*ce%360;p=Kt(te,X,We)}}p&&(Ee=he(p,!!je,F.label||F.id,ue,je,ee),S.set(ee,Ee))}if(!Ee)continue;if(Ie)ue={lat:Number(Ie.lat),lng:Number(Ie.lng)},Ee.__setPosition(ue);else if(de.has(ee))Ee.__setPosition(de.get(ee));else if(je){const p=H.get(je)||(u===je?N:null);if(p){const ge=((Y.get(je)||[]).indexOf(ee)+1)*ce%360;Ee.__setPosition(Kt(p,X,ge))}else{const te=S.get(ee);te&&(te.setMap?te.setMap(null):te.map&&(te.map=null),S.delete(ee));continue}}else{const p=S.get(ee);p&&(p.setMap?p.setMap(null):p.map&&(p.map=null),S.delete(ee));continue}const Ge=!!je;Ee.__setIcon(Ge,ue,je)}},5e3)}catch(N){M(N?.message||"Kartenaufbau fehlgeschlagen.")}finally{I(!1)}})(),()=>{P=!0,x&&clearInterval(x);for(const N of S.values())N?.setMap?N.setMap(null):N&&(N.map=null);S.clear()}},[d,n,D]),!d||!n?.card){const P=`https://www.google.com/maps?q=${encodeURIComponent(c)}&output=embed`;return e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:i,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[70vh] p-2",onClick:$=>$.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-semibold text-sm",children:["Karte: ",c]}),e.jsx("button",{className:"px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm",onClick:i,children:"SchlieÃŸen"})]}),e.jsx("iframe",{title:"maps",className:"w-full h-full rounded-lg border",src:P,loading:"lazy"})]})})}return e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:i,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-5xl h-[75vh] p-2",onClick:P=>P.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-semibold text-sm",children:["Karte: ",n?.card?.content||"Einsatz"," Â· weitere EinsÃ¤tze (Neu & In Bearbeitung)"]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm",onClick:i,children:"SchlieÃŸen"})})]}),e.jsx("div",{ref:b,className:"w-full h-full rounded-lg border"}),v&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"px-3 py-1.5 rounded bg-white shadow text-sm",children:"Ladeâ€¦"})}),!!j&&e.jsx("div",{className:"absolute bottom-3 left-3 px-2 py-1 rounded bg-red-600 text-white text-xs shadow",children:j})]})})}function yr({onClose:n,onCreate:s}){const[i,c]=a.useState(""),[d,b]=a.useState(""),[f,v]=a.useState(0),[I,j]=a.useState(!1),[M,D]=a.useState(""),P=async $=>{if($.preventDefault(),D(""),!i.trim()||!d.trim()){D("Ort und Name sind erforderlich.");return}try{j(!0),await s({ort:i.trim(),label:d.trim(),mannschaft:Number(f)||0}),n()}catch(z){D(z?.message||"Speichern fehlgeschlagen.")}finally{j(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:e.jsxs("form",{onSubmit:P,className:"bg-white rounded-xl shadow-lg p-4 w-[360px] space-y-3",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Einheit anlegen"}),M&&e.jsx("div",{className:"text-sm text-red-600",children:M}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Ort"}),e.jsx("input",{className:"border rounded px-2 py-1 w-full",value:i,onChange:$=>c($.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Name"}),e.jsx("input",{className:"border rounded px-2 py-1 w-full",value:d,onChange:$=>b($.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Mannschaft"}),e.jsx("input",{type:"number",min:"0",className:"border rounded px-2 py-1 w-24",value:f,onChange:$=>v($.target.value)})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:n,className:"px-3 py-1 rounded border",disabled:I,children:"Abbrechen"}),e.jsx("button",{type:"submit",className:"px-3 py-1 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:I,children:I?"Anlegenâ€¦":"Anlegen"})]})]})})}let wt=null;function qt(){const n=document.querySelector('meta[name="google-places-key"]');return(window.GMAPS_API_KEY||n?.content||"").trim()||""}async function Un(n=qt()){if(window.google?.maps?.places)return!0;if(!n)return!1;if(wt)return await wt,!!window.google?.maps?.places;wt=new Promise((s,i)=>{if(document.getElementById("gmap-places")){const d=()=>{window.google?.maps?.places?s(!0):setTimeout(d,150)};d();return}const c=document.createElement("script");c.id="gmap-places",c.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(n)}&libraries=places&language=de`,c.async=!0,c.defer=!0,c.onload=()=>s(!!window.google?.maps?.places),c.onerror=d=>i(d),document.head.appendChild(c)});try{await wt}catch{}return!!window.google?.maps?.places}function wr({debounceMs:n=300,country:s="at",minLength:i=3}={}){const[c,d]=a.useState(""),[b,f]=a.useState([]),[v,I]=a.useState(!1),[j,M]=a.useState(!1),[D,P]=a.useState(null),$=a.useRef(null),z=a.useRef(null),S=a.useRef(null),x=a.useRef(null);a.useEffect(()=>{let _=!1;return(async()=>{const U=await Un(qt());_||!U||!window.google?.maps?.places||($.current=new google.maps.places.AutocompleteService,z.current=new google.maps.places.PlacesService(document.createElement("div")),S.current=new google.maps.places.AutocompleteSessionToken,_||M(!0))})(),()=>{_=!0}},[]);const u=a.useCallback(()=>{window.google?.maps?.places&&(S.current=new google.maps.places.AutocompleteSessionToken)},[]),g=a.useRef();a.useEffect(()=>{g.current||(g.current=(_,U)=>{let se;return(...re)=>{clearTimeout(se),se=setTimeout(()=>_(...re),U)}})},[]);const T=a.useCallback(async _=>{if(!j||!$.current)return;const U=(_||"").trim();if(!U||U.length<i){f([]);return}I(!0),P(null),$.current.getPlacePredictions({input:U,sessionToken:S.current,componentRestrictions:{country:s},types:["address"]},(se,re)=>{if(I(!1),re!==google.maps.places.PlacesServiceStatus.OK||!se){f([]),re&&re!=="ZERO_RESULTS"&&P(re);return}f(se)})},[s,i,j]),E=a.useMemo(()=>g.current?g.current(T,n):()=>{},[T,n]);a.useEffect(()=>{E(c)},[c,E]);const N=a.useCallback((_,U=["formatted_address","geometry","address_components"])=>new Promise((se,re)=>{if(!j||!z.current){re(new Error("Google Places nicht bereit"));return}z.current.getDetails({placeId:_,fields:U,sessionToken:S.current},(G,H)=>{if(H!==google.maps.places.PlacesServiceStatus.OK||!G)return re(new Error(H||"DETAILS_FAILED"));se(G)})}),[j]),V=a.useCallback(()=>{f([])},[]);return{ready:j,query:c,setQuery:d,predictions:b,loading:v,error:D,resetSession:u,getDetailsByPlaceId:N,clearPredictions:V,inputElRef:x}}function tt(n){return String(n??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}function vr(){const n=document.querySelector('meta[name="google-places-key"]');return(window.GMAPS_API_KEY||n?.content||"").trim()||void 0}function ct(n){if(!n)return null;if(typeof n=="string"){const s=n.trim().match(/^\s*([+-]?\d+(?:\.\d+)?)\s*,\s*([+-]?\d+(?:\.\d+)?)\s*$/);if(!s)return null;const i=Number(s[1]),c=Number(s[2]);return Number.isFinite(i)&&Number.isFinite(c)?{lat:i,lng:c}:null}if(typeof n=="object"&&n){if(typeof n.lat=="function"&&typeof n.lng=="function"){const c=Number(n.lat()),d=Number(n.lng());if(Number.isFinite(c)&&Number.isFinite(d))return{lat:c,lng:d}}if(typeof n.toJSON=="function"){const c=n.toJSON();if(c&&c!==n){const d=ct(c);if(d)return d}}const s=Number(n.lat??n.latitude),i=Number(n.lng??n.longitude);if(Number.isFinite(s)&&Number.isFinite(i))return{lat:s,lng:i}}return null}async function Hn(n){try{const s=String(n||"").trim();if(!s)return null;const i=await fetch(`/api/geocode?q=${encodeURIComponent(s)}`,{credentials:"include",cache:"no-store"});if(!i.ok)return null;const c=await i.json(),d=Number(c?.lat),b=Number(c?.lng);return!Number.isFinite(d)||!Number.isFinite(b)?null:{lat:d,lng:b,formatted:c?.formatted||s}}catch{return null}}function Sr({lat:n,lng:s,address:i,apiKey:c,zoom:d=16,size:b="800x400",scale:f=2}){if(Number.isFinite(n)&&Number.isFinite(s)){if(c){const j="https://maps.googleapis.com/maps/api/staticmap",M=`center=${n},${s}&zoom=${d}&size=${b}&scale=${f}&markers=color:red|label:E|${n},${s}&maptype=roadmap`;return`${j}?${M}&key=${c}`}const I=b.toLowerCase().replace("x","x");return`https://staticmap.openstreetmap.de/staticmap.php?center=${n},${s}&zoom=${d}&size=${I}&markers=${n},${s},red-pushpin`}if(c&&i){const I="https://maps.googleapis.com/maps/api/staticmap",j=encodeURIComponent(i),M=`center=${j}&zoom=${d}&size=${b}&scale=${f}&markers=color:red|label:E|${j}&maptype=roadmap`;return`${I}?${M}&key=${c}`}return""}function Kn({title:n,type:s,location:i,timestamp:c,infoRowsHtml:d,mapSrc:b,staticMapUrl:f,notesSection:v,autoPrint:I}){const j=`
    <script>
      // Markiert, wenn Karte (iFrame ODER Bild) bereit ist â€“ z.B. fÃ¼r automatischen Druck
      (function(){
        window.__incidentMapReady = false;

        function markReady(){
          if (window.__incidentMapReady) return;
          window.__incidentMapReady = true;
          try { document.body.setAttribute('data-map-ready', '1'); } catch(e){}
      if (${I?"true":"false"}) {
            // Nur EINMAL drucken
            if (!window.__alreadyPrinted) {
              window.__alreadyPrinted = true;
             setTimeout(() => { try { window.print(); } catch(e){} }, 100);
            }
          }
        }

        function watchIframeOrImage(){
          const frame = document.querySelector('.map-frame iframe');
          const img = document.querySelector('.map-frame img.map-static');

          // Wenn Bild vorhanden â†’ auf Bild warten (fÃ¼r Print wichtig)
          if (img) {
            if (img.complete) {
              markReady();
            } else {
              img.addEventListener('load', markReady, { once: true });
              img.addEventListener('error', markReady, { once: true });
              setTimeout(markReady, 3000); // Fallback
            }
          }

          // Wenn iFrame vorhanden â†’ auch auf iFrame warten (fÃ¼r Screen)
          if (frame) {
            const safeFinish = () => { markReady(); };
            try {
              frame.addEventListener('load', safeFinish, { once: true });
              frame.addEventListener('error', safeFinish, { once: true });
            } catch { /* ignore */ }

            // Cross-Origin iFrame? Dann lieber Timeout
            setTimeout(safeFinish, 3000);
          }

          // Wenn weder Bild noch iFrame: sofort ready
          if (!img && !frame) markReady();
        }

        if (document.readyState === 'complete') watchIframeOrImage();
        else window.addEventListener('load', watchIframeOrImage, { once: true });
      })();
    <\/script>
  `;return`<!DOCTYPE html>
  <html lang="de">
    <head>
      <meta charSet="utf-8" />
      <title>Einsatzdruck â€“ ${tt(n||s||"Neuer Einsatz")}</title>
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <style>
        * { box-sizing: border-box; font-family: "Inter", "Helvetica Neue", Arial, sans-serif; color:#0f172a; }
        body { margin:0; padding:0; background:#e2e8f0; }
        .sheet { max-width: 190mm; margin: 18px auto; background:#fff; border-radius:16px; padding:22px 26px;
                 box-shadow: 0 12px 32px rgba(15,23,42,0.18); }
        header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; }
        header h1 { margin:0; font-size:20px; }
        header span { font-size:12px; color:#475569; }
        section { margin-top:20px; }
        .info { display:flex; flex-direction:column; gap:10px; }
        .row { display:flex; gap:14px; }
        .label { width:120px; font-weight:600; font-size:13px; text-transform:uppercase; letter-spacing:.04em; color:#475569; }
        .value { flex:1; font-size:14px; line-height:1.4; }
        .map-section h2, .notes h2 { font-size:16px; margin:0 0 10px; }
        .map-frame { width:100%; aspect-ratio: 4 / 3; border-radius:14px; overflow:hidden; border:1px solid #cbd5e1; background:#f8fafc; }
        .map-frame iframe { width:100%; height:100%; border:0; display:block; }
        .map-frame img.map-static { width:100%; height:100%; object-fit:cover; display:none; }
        .notes div { font-size:14px; line-height:1.5; white-space:pre-wrap; }
        footer { margin-top:24px; font-size:11px; color:#64748b; text-align:right; }

        @media print {
          body { background:#fff; }
          .sheet { box-shadow:none; margin:0; max-width:unset; width:100%; border-radius:0; }
          @page { size: A4; margin: 12mm; }
          .map-frame iframe { display:none !important; }
          .map-frame img.map-static { display:block !important; }
        }
      </style>
    </head>
    <body>
      <div class="sheet">
        <header>
          <h1>Einsatzinformation</h1>
          <span>Druck erstellt am ${tt(c||"")}</span>
        </header>

        <section class="info">
          ${d||""}
        </section>

        <section class="map-section">
          <h2>Einsatzkarte</h2>
          <div class="map-frame">
            <iframe src="${b}" title="Einsatzkarte" loading="lazy"></iframe>
            <img class="map-static" alt="Einsatzkarte" src="${f}" referrerpolicy="no-referrer" />
          </div>
        </section>

        ${v||""}

        <footer>Einsatzstellen-Ãœbersicht</footer>
      </div>
      ${j}
    </body>
  </html>`}async function Gn({title:n="",type:s="",locationLabel:i="",notes:c="",isArea:d=!1,areaColor:b,areaLabel:f,coordinates:v=null}){const j=new Date().toLocaleString("de-AT",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),M=(n||"").trim(),D=(s||"").trim();let P=(i||"").trim(),$=ct(v);try{if(!$&&P){const E=await Hn(P);E&&($={lat:E.lat,lng:E.lng},E.formatted&&(P=E.formatted))}}catch{}const z=$?`${$.lat},${$.lng}`:P||M||D||"Ã–sterreich",S=`https://www.google.com/maps?q=${encodeURIComponent(z)}&output=embed&hl=de&z=15`;let x=Sr({lat:$?.lat,lng:$?.lng,address:P||M||D||"Ã–sterreich",apiKey:vr()});x||(x=`https://placehold.co/800x400?text=${encodeURIComponent("Keine Karte verfÃ¼gbar")}`);const u=[["Einsatz",M||D||"â€”"],["Art",D||"â€”"],["Ort",P||"â€”"],...d?[["Bereich",`${tt(f||"Bereich")} ${b?`<span class="color-chip" style="background:${tt(b)}"></span>`:""}`]]:[]].map(([E,N])=>`
      <div class="row">
        <div class="label">${tt(E)}</div>
        <div class="value">${typeof N=="string"?N:N??"â€”"}</div>
      </div>`).join(""),g=c?`<section class="notes"><h2>Hinweise</h2><div>${tt(c)}</div></section>`:"";return{html:Kn({title:M,type:D,location:P,timestamp:j,infoRowsHtml:u,mapSrc:S,staticMapUrl:x,notesSection:g,autoPrint:!1}),title:M,type:D,location:P,timestamp:j,mapSrc:S,staticMapUrl:x,notes:c,isArea:!!d,infoRowsHtml:u,notesSection:g}}async function Wn({title:n="",type:s="",locationLabel:i="",notes:c="",isArea:d=!1,areaColor:b,areaLabel:f,coordinates:v=null,incidentId:I}){const j=await Gn({title:n,type:s,locationLabel:i,notes:c,isArea:d,areaColor:b,areaLabel:f,coordinates:v}),{html:M,title:D,type:P,location:$,timestamp:z,mapSrc:S,staticMapUrl:x,infoRowsHtml:u,notesSection:g}=j;try{const T=document.createElement("iframe");T.style.position="fixed",T.style.right="0",T.style.bottom="0",T.style.width="0",T.style.height="0",T.style.border="0",document.body.appendChild(T);const E=T.contentDocument||T.contentWindow?.document;if(!E)throw new Error("Kein iFrame-Dokument verfÃ¼gbar.");E.open(),E.write(M),E.close();const N=T.contentWindow;let V=!1;const _=()=>{if(!V){V=!0;try{N.focus()}catch{}try{N.print()}catch{}}},U=()=>{if(!V){try{if(!N||!N.document)return void setTimeout(U,150);if(N.__incidentMapReady===!0||N.document.body&&N.document.body.getAttribute("data-map-ready")==="1")return _()}catch{}setTimeout(U,150)}};try{T.addEventListener("load",()=>setTimeout(U,50),{once:!0})}catch{}setTimeout(U,200);return}catch{const E=window.open("","_blank","noopener,noreferrer,width=980,height=1200"),N=Kn({title:D,type:P,location:$,timestamp:z,infoRowsHtml:u,mapSrc:S,staticMapUrl:x,notesSection:g,autoPrint:!0});try{if(E&&E.document)E.document.open(),E.document.write(N),E.document.close();else{const V=new Blob([N],{type:"text/html"}),_=URL.createObjectURL(V);window.location.href=_}}catch{}}}function Nr({onClose:n,onCreate:s,types:i,areaOptions:c=[]}){const d="#2563eb",[b,f]=a.useState(""),[v,I]=a.useState(""),[j,M]=a.useState(!1),[D,P]=a.useState(!1),[$,z]=a.useState(""),[S,x]=a.useState(d),[u,g]=a.useState(""),[T,E]=a.useState(!1),N=a.useRef(null),{query:V,setQuery:_,predictions:U,getDetailsByPlaceId:se,resetSession:re,loading:G,error:H,clearPredictions:J}=wr({country:"at",debounceMs:300,minLength:3});a.useEffect(()=>{setTimeout(()=>N.current?.focus(),0)},[]),a.useEffect(()=>{const L=(v||"").replace(/^T\d+\s*,?\s*/i,"").trim();!b.trim()&&L&&f(L)},[v]);const Q=a.useRef(null);a.useEffect(()=>{D&&(z(""),x(L=>L||d))},[D]);const fe=async L=>{L?.preventDefault?.();const xe=(v||"").replace(/^T\d+\s*,?\s*/i,"").trim(),O=(b||xe).trim();if(O){M(!0);try{let q=null,me=(V||"").trim();const ae=Q.current;if(ae){const he=ct(ae.geometry?.location);he&&(q=he);const k=ae.formatted_address||ae.name||"";k&&(me=k)}if(!q&&me){const he=await Hn(me);he&&(q={lat:he.lat,lng:he.lng},he.formatted&&(me=he.formatted))}const Se=(u||"").trim();await s({title:O,ort:(V||"").trim(),typ:(v||"").trim(),isArea:D,areaCardId:D?null:$||null,areaColor:D?S:void 0,coordinates:q,location:me,description:Se}),f(""),_(""),I(""),P(!1),z(""),x(d),g(""),Q.current=null,re(),J(),n?.()}finally{M(!1)}}},le=async L=>{try{const xe=await se(L.place_id,["formatted_address","geometry","address_components","place_id"]),O=xe?.formatted_address||L.description;_(O),Q.current=xe||null}catch{Q.current=null,_(L.description)}finally{re(),J()}},K=async()=>{if(T)return;const L=(v||"").replace(/^T\d+\s*,?\s*/i,"").trim(),xe=(b||L).trim(),O=(V||"").trim(),q=(u||"").trim(),me=c.find(ae=>String(ae.id)===String($));try{E(!0);let ae=O,Se=null;const he=Q.current;if(he){const k=ct(he.geometry?.location);k&&(Se=k);const W=he.formatted_address||he.name||"";W&&(ae=W)}await Wn({title:xe,type:L,locationLabel:ae,notes:q,isArea:D,areaColor:D?S:void 0,areaLabel:!D&&me?me.label:void 0,coordinates:Se,incidentId:xe||L||void 0})}catch(ae){const Se=ae?.message||ae||"Unbekannter Fehler";alert(`Drucken fehlgeschlagen: ${Se}`)}finally{E(!1)}};return e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-3",children:e.jsxs("form",{onSubmit:fe,className:"bg-white rounded-xl shadow-lg w-[520px] max-w-full p-4 space-y-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Einsatz anlegen"}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs("select",{ref:N,className:"border rounded px-2 py-1",value:v,onChange:L=>I(L.target.value),children:[e.jsx("option",{value:"",children:"â€” Typ auswÃ¤hlen â€”"}),(i||[]).map(L=>e.jsx("option",{value:L,children:L},L))]}),e.jsx("input",{className:"border rounded px-2 py-1",placeholder:"Titel (wird aus Typ Ã¼bernommen)",value:b,onChange:L=>f(L.target.value)}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{className:"border rounded px-2 py-1 w-full",placeholder:"Ort (nur Ã–sterreich)",autoComplete:"off",value:V,onChange:L=>{Q.current=null,_(L.target.value)}}),G&&e.jsx("div",{className:"absolute z-10 mt-1 text-xs text-gray-500 bg-white border rounded px-2 py-1",children:"Sucheâ€¦"}),H&&e.jsxs("div",{className:"absolute z-10 mt-1 text-xs text-red-600 bg-white border rounded px-2 py-1",children:["Fehler: ",String(H)]}),!!U.length&&e.jsx("ul",{className:"absolute z-10 mt-1 w-full max-h-52 overflow-auto bg-white border rounded shadow",children:U.map(L=>e.jsx("li",{className:"px-2 py-1 hover:bg-gray-100 cursor-pointer text-sm",onClick:()=>le(L),title:L.description,children:L.description},L.place_id))})]}),e.jsxs("label",{className:"text-sm font-medium text-gray-700",children:["Notiz",e.jsx("textarea",{className:"mt-1 w-full border rounded px-2 py-1 resize-y min-h-[90px]",value:u,onChange:L=>g(L.target.value),disabled:j})]}),e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:D,onChange:L=>P(L.target.checked),disabled:j}),"Abschnitt"]}),!D&&e.jsxs("select",{className:"border rounded px-2 py-1 text-sm",value:$,onChange:L=>z(L.target.value),disabled:j||c.length===0,children:[e.jsx("option",{value:"",children:"â€” Abschnitt auswÃ¤hlen â€”"}),c.map(L=>e.jsx("option",{value:L.id,children:L.label},L.id))]})]}),D&&e.jsxs("div",{className:"flex items-center justify-between gap-3 text-sm text-gray-700",children:[e.jsx("span",{children:"Abschnittsfarbe"}),e.jsx("input",{type:"color",className:"h-9 w-16 border rounded cursor-pointer",value:S,onChange:L=>x(L.target.value),disabled:j})]}),!D&&c.length===0&&e.jsx("p",{className:"text-xs text-gray-500",children:"Noch keine Abschnitte vorhanden."})]}),e.jsxs("div",{className:"flex items-center justify-between gap-2 pt-1",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Informationen und Karte auf A4 drucken"}),e.jsx("button",{type:"button",onClick:K,className:"px-3 py-1 rounded border bg-white hover:bg-gray-50 text-sm disabled:opacity-60",disabled:j||T,children:T?"Druckenâ€¦":"Drucken"})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:n,className:"px-3 py-1 rounded border",disabled:j,children:"Abbrechen"}),e.jsx("button",{className:"px-3 py-1 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:j,children:j?"Anlegenâ€¦":"Anlegen"})]})]})})}function jr({colId:n,title:s,bg:i,children:c,editable:d=!0}){if(!d)return e.jsxs("section",{className:`${i} rounded-xl shadow p-3 h-full flex flex-col min-h-0`,children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:s}),c]});const{setNodeRef:b,isOver:f}=Bs({id:`col:${n}`,data:{type:"column",colId:n}});return e.jsxs("section",{ref:b,className:`${i} rounded-xl shadow p-3 h-full flex flex-col min-h-0 ${f?"outline outline-2 outline-blue-400":""}`,children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:s}),c]})}const Ar=n=>{if(n==null)return"";const s=String(n).trim();return s?s.normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9_.-]+/g,"-").replace(/-+/g,"-").replace(/^-+/,"").replace(/-+$/,""):""};function kr(){const[n,s]=a.useState(!1),[i,c]=a.useState(null),d=a.useCallback(async f=>{if(n)return!1;if(!f)return c({type:"error",message:"Kein Einsatz ausgewÃ¤hlt."}),!1;const v=window.prompt("Bitte E-Mail-Adresse fÃ¼r den Versand eingeben:");if(v==null)return!1;const I=v.trim();if(!I)return c({type:"error",message:"Keine E-Mail-Adresse angegeben."}),!1;if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(I))return c({type:"error",message:"E-Mail-Adresse ist ungÃ¼ltig."}),!1;s(!0),c(null);try{const M=f?.content||"",D=f?.typ||f?.type||"",P=f?.additionalAddressInfo||f?.ort||"",$=f?.description||"",z={lat:f?.latitude??f?.lat??null,lng:f?.longitude??f?.lng??null},S=[f?.humanId,f?.content,f?.id].map(G=>G!=null?String(G).trim():"").find(G=>G),x=await Gn({title:M,type:D,locationLabel:P,notes:$,coordinates:z,isArea:!!f?.isArea,areaColor:f?.areaColor,areaLabel:f?.areaLabel||f?.areaCardLabel}),u=Ar(S)||"einsatz",g=x.title||x.type||S||u,T=g?`Einsatzkarte ${g}`:"Einsatzkarte",E=[];x.title&&E.push(`Einsatz: ${x.title}`),x.location&&E.push(`Ort: ${x.location}`),E.push(`Gesendet: ${x.timestamp}`);const V=`Im Anhang finden Sie die aktuelle Einsatzkarte.

${E.join(`
`)}`.trim(),U=`<p>Im Anhang finden Sie die aktuelle Einsatzkarte.</p><ul>${[x.title?`<li><strong>Einsatz:</strong> ${x.title}</li>`:"",x.location?`<li><strong>Ort:</strong> ${x.location}</li>`:"",`<li><strong>Gesendet:</strong> ${x.timestamp}</li>`].filter(Boolean).join("")}</ul>`,se=await fetch(`/api/incidents/${encodeURIComponent(u)}/mail`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({html:x.html,to:I,subject:T,textBody:V,htmlBody:U})}),re=await se.json().catch(()=>null);if(!se.ok||!re?.ok){const G=re?.detail||re?.error||se.statusText||"Versand fehlgeschlagen.";throw new Error(G)}return c({type:"success",message:"E-Mail wurde versendet."}),!0}catch(M){const D=M?.message||"E-Mail-Versand fehlgeschlagen.";return c({type:"error",message:D}),!1}finally{s(!1)}},[n]),b=a.useCallback(()=>c(null),[]);return{mailBusy:n,mailFeedback:i,sendMail:d,resetMailFeedback:b}}const lt="#2563eb";function Cr(n={}){const s=n?.humanId?String(n.humanId):"",i=n?.content?String(n.content):"";return[s,i].filter(Boolean).join(" â€“ ")||s||i||"Abschnitt"}function vt(n={}){return{title:n?.content||"",typ:n?.typ||n?.type||"",ort:n?.additionalAddressInfo||n?.ort||"",description:n?.description||"",isArea:!!n?.isArea,areaCardId:n?.isArea?"":n?.areaCardId||"",areaColor:n?.isArea?n?.areaColor||lt:n?.areaColor||""}}function Ir({open:n,onClose:s,info:i={},canEdit:c=!1,onSave:d,areaOptions:b=[],areaLabelById:f=new Map,forceEdit:v=!1,types:I=[]}){if(!n)return null;const j=a.useMemo(()=>i?.isEditable!==!1,[i?.isEditable]),[M,D]=a.useState(!1),[P,$]=a.useState(!1),[z,S]=a.useState(!1),[x,u]=a.useState(()=>vt(i)),[g,T]=a.useState(""),{mailBusy:E,mailFeedback:N,sendMail:V,resetMailFeedback:_}=kr(),U=i?.timestamp,se=U?new Date(U).toLocaleString("de-AT",{hour12:!1}):"â€”",re=a.useMemo(()=>{const O=[];return i.location&&O.push(String(i.location)),Number.isFinite(i.latitude)&&Number.isFinite(i.longitude)&&O.push(`(${i.latitude}, ${i.longitude})`),O.length?O.join(" "):void 0},[i]),G=a.useMemo(()=>b.filter(O=>O.id!==i?.id),[b,i?.id]),H=a.useMemo(()=>{if(i?.isArea)return Cr(i);if(!i?.areaCardId)return"â€”";const O=f.get(i.areaCardId);if(O)return O;const q=b.find(me=>me.id===i.areaCardId);return q?q.label:String(i.areaCardId)},[i,f,b]);a.useEffect(()=>{u(vt(i)),T(""),$(!1),D(!!(v&&c&&j))},[i,v,c,j,n]),a.useEffect(()=>{_()},[i?.id,n,_]);const J=()=>{P||(D(!1),T(""),s?.())},Q=()=>{!c||!j||(u(vt(i)),T(""),D(!0))},fe=()=>{P||(u(vt(i)),T(""),D(!1))},le=async()=>{if(z)return;const O=i?.content||"",q=i?.typ||i?.type||"",me=i?.location||i?.additionalAddressInfo||i?.ort||"",ae=i?.description||"",Se=ct({lat:i?.latitude??i?.lat,lng:i?.longitude??i?.lng}),he=!i?.isArea&&H&&H!=="â€”"?H:"",k=[i?.humanId,i?.content,i?.id].map(W=>W!=null?String(W).trim():"").find(W=>W);S(!0);try{await Wn({title:O,type:q,locationLabel:me,notes:ae,isArea:!!i?.isArea,areaColor:i?.isArea?i?.areaColor||lt:void 0,areaLabel:he||void 0,coordinates:Se,incidentId:k})}catch(W){const ie=W?.message||W||"Drucken fehlgeschlagen.";alert(typeof ie=="string"?ie:String(ie))}finally{S(!1)}},K=async O=>{if(O?.preventDefault?.(),!d||!i?.id){D(!1);return}const q=(x.title||"").trim();if(!q){T("Titel darf nicht leer sein.");return}$(!0),T("");try{await d(i.id,{title:q,typ:(x.typ||"").trim(),ort:(x.ort||"").trim(),description:(x.description||"").trim(),isArea:!!x.isArea,areaCardId:x.isArea?null:x.areaCardId||null,areaColor:x.isArea?x.areaColor||lt:void 0}),D(!1)}catch(me){const ae=me?.message||"Speichern fehlgeschlagen.";T(ae)}finally{$(!1)}},L=({label:O,value:q})=>e.jsxs("div",{className:"flex items-start gap-3 py-1",children:[e.jsx("div",{className:"w-32 shrink-0 text-gray-600",children:O}),e.jsx("div",{className:"flex-1 font-medium break-words",children:q??"â€”"})]}),xe=()=>e.jsxs("form",{onSubmit:K,className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-700",children:["Titel",e.jsx("input",{className:"mt-1 w-full border rounded px-2 py-1",value:x.title,onChange:O=>u(q=>({...q,title:O.target.value})),disabled:P})]}),e.jsxs("label",{className:"text-sm font-medium text-gray-700",children:["Typ",e.jsx("input",{className:"mt-1 w-full border rounded px-2 py-1",value:x.typ,onChange:O=>u(q=>({...q,typ:O.target.value})),list:"incident-info-types",disabled:P}),e.jsx("datalist",{id:"incident-info-types",children:(I||[]).map(O=>e.jsx("option",{value:O},O))})]}),e.jsxs("label",{className:"text-sm font-medium text-gray-700",children:["Ort",e.jsx("input",{className:"mt-1 w-full border rounded px-2 py-1",value:x.ort,onChange:O=>u(q=>({...q,ort:O.target.value})),disabled:P})]}),e.jsxs("label",{className:"text-sm font-medium text-gray-700",children:["Alarmzeit",e.jsx("input",{className:"mt-1 w-full border rounded px-2 py-1 bg-gray-100",value:se,disabled:!0,readOnly:!0})]}),e.jsxs("label",{className:"text-sm font-medium text-gray-700",children:["Notiz",e.jsx("textarea",{className:"mt-1 w-full border rounded px-2 py-1 resize-y min-h-[90px]",value:x.description,onChange:O=>u(q=>({...q,description:O.target.value})),disabled:P})]}),e.jsxs("div",{className:"flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:x.isArea,onChange:O=>u(q=>({...q,isArea:O.target.checked,areaCardId:O.target.checked?"":q.areaCardId,areaColor:O.target.checked?q.areaColor||lt:q.areaColor})),disabled:P}),"Abschnitt"]}),!x.isArea&&e.jsxs("select",{className:"border rounded px-2 py-1 text-sm",value:x.areaCardId,onChange:O=>u(q=>({...q,areaCardId:O.target.value})),disabled:P||G.length===0,children:[e.jsx("option",{value:"",children:"â€” Abschnitt auswÃ¤hlen â€”"}),G.map(O=>e.jsx("option",{value:O.id,children:O.label},O.id))]})]}),!x.isArea&&G.length===0&&e.jsx("p",{className:"text-xs text-gray-500",children:"Noch keine Abschnitte vorhanden."}),x.isArea&&e.jsxs("div",{className:"flex items-center justify-between gap-3 text-sm text-gray-700",children:[e.jsx("span",{children:"Farbe"}),e.jsx("input",{type:"color",className:"h-9 w-16 border rounded cursor-pointer",value:x.areaColor||lt,onChange:O=>u(q=>({...q,areaColor:O.target.value})),disabled:P})]})]}),g&&e.jsx("p",{className:"text-sm text-red-600",children:g}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",className:"px-3 py-1.5 rounded border",onClick:fe,disabled:P,children:"Abbrechen"}),e.jsx("button",{type:"submit",className:"px-3 py-1.5 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:P,children:P?"Speichernâ€¦":"Speichern"})]})]});return e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:J}),e.jsxs("div",{className:"relative z-[101] w-[min(92vw,640px)] rounded-xl bg-white shadow-xl p-4 md:p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3 gap-2",children:[e.jsx("h2",{className:"text-lg md:text-xl font-bold",children:"Einsatz-Info"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",className:"px-3 py-1.5 rounded border bg-white text-sm hover:bg-gray-50 disabled:opacity-60",onClick:()=>V(i),disabled:E||!i,children:E?"Sendeâ€¦":"Mail senden"}),c&&j&&!M&&e.jsx("button",{type:"button",className:"px-3 py-1.5 rounded border bg-white text-sm hover:bg-gray-50",onClick:Q,children:"Bearbeiten"}),e.jsx("button",{type:"button",className:"px-3 py-1.5 rounded border bg-white text-sm hover:bg-gray-50 disabled:opacity-60",onClick:le,disabled:z,children:z?"Druckenâ€¦":"Drucken"}),e.jsx("button",{className:"h-8 w-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center",onClick:J,"aria-label":"SchlieÃŸen",title:"SchlieÃŸen",children:e.jsx("svg",{viewBox:"0 0 12 12",width:"14",height:"14","aria-hidden":"true",children:e.jsx("path",{d:"M1 1 L11 11 M11 1 L1 11",stroke:"black",strokeWidth:"2",strokeLinecap:"round"})})})]})]}),N&&e.jsx("div",{className:`mb-3 rounded border px-3 py-2 text-sm ${N.type==="error"?"border-red-200 bg-red-50 text-red-700":"border-emerald-200 bg-emerald-50 text-emerald-700"}`,children:N.message}),M?xe():e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(L,{label:"Titel",value:i.content}),e.jsx(L,{label:"Typ",value:i.typ||i.type}),e.jsx(L,{label:"Einsatz ID",value:i.humanId}),e.jsx(L,{label:"Alarmzeit",value:se}),e.jsx(L,{label:"Alarmiert",value:i.alerted}),e.jsx(L,{label:"Notiz",value:i.description}),e.jsx(L,{label:"Adresse",value:i.additionalAddressInfo||i.ort}),e.jsx(L,{label:"Location",value:re}),e.jsx(L,{label:"Abschnitt",value:i.isArea&&i.areaColor?e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx("span",{className:"h-4 w-4 rounded border",style:{backgroundColor:i.areaColor,borderColor:i.areaColor},"aria-hidden":!0}),H]}):H}),!i.isArea&&i.areaColor&&e.jsx(L,{label:"Farbe",value:e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx("span",{className:"h-4 w-4 rounded border",style:{backgroundColor:i.areaColor,borderColor:i.areaColor},"aria-hidden":!0}),i.areaColor]})})]}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx("button",{className:"px-3 py-1.5 rounded-md bg-emerald-600 text-white hover:bg-emerald-700",onClick:J,children:"OK"})})]})]})]})}const Er="||",Dn="done:";function Nt(n){if(n==null)return"";try{return String(n).normalize("NFKC").toLowerCase().replace(/\s+/g," ").trim()}catch{return String(n).toLowerCase().replace(/\s+/g," ").trim()}}function Mr(n){if(!n)return"";const s=n.replace(/\s+/g," ").trim();return s.length>200?s.slice(0,200)+"â€¦":s}function Pr(n){const s=String(n||"");if(s==="information"||s.startsWith("information."))return"Information";if(s==="rueckmeldung1"||s.startsWith("rueckmeldung1."))return"RÃ¼ckmeldung";if(s==="lagebericht"||s.startsWith("lagebericht."))return"Lagebericht";if(s.startsWith("otherRecipientConfirmation"))return"EmpfÃ¤ngerbestÃ¤tigung";if(s.startsWith("ergehtAn"))return"Verteiler (ergeht an)";if(s.startsWith("uebermittlungsart"))return"Ãœbermittlungsart";if(s==="datum"||s==="zeit")return"Datum/Zeit";if(s==="zu")return"Zu-Nummer";const i=/^massnahmen\.(\d+)(?:\.(.+))?$/.exec(s);if(i){const c=Number(i[1])+1,d=i[2]||"";return d==="text"?`MaÃŸnahme ${c} Text`:d==="done"?`MaÃŸnahme ${c} Status`:`MaÃŸnahme ${c}${d?` (${d})`:""}`}return s||"Feld"}function jt(n){if(n===null||typeof n>"u")return"â€”";if(typeof n=="string"){const s=n.replace(/\s+/g," ").trim();return s?s.length>80?s.slice(0,77)+"â€¦":s:"â€”"}if(typeof n=="number"||typeof n=="boolean")return String(n);if(Array.isArray(n)){const s=n.length;return s===0?"[]":`[${s} EintrÃ¤ge]`}if(typeof n=="object"){if(typeof n.text=="string")return jt(n.text);if(typeof n.name=="string")return jt(n.name);try{const s=JSON.stringify(n);return s.length>80?s.slice(0,77)+"â€¦":s}catch{return"[Objekt]"}}return String(n)}function Tr(n){const s=Array.isArray(n?.history)?n.history:[];if(!s.length)return null;let i=null;for(let f=s.length-1;f>=0;f--){const v=s[f];if(v&&v.action==="update"&&Array.isArray(v.changes)){i=v;break}}if(!i)return null;const c=Array.isArray(i.changes)?i.changes:[];if(!c.length)return null;const d=[];for(const f of c){const v=Pr(f.path),I=jt(f.before),j=jt(f.after);I!==j&&d.push(`${v}: ${I} â†’ ${j}`)}if(!d.length)return null;const b=5;if(d.length>b){const f=d.slice(0,b),v=d.length-b;return f.push(`(+${v} weitere Ã„nderungen)`),f.join(`
`)}return d.join(`
`)}function qn(n){const s=new Set;if(n==null)return s;const i=String(n),c=Nt(i);if(c){s.add(c);const b=c.replace(/\s+/g,"");b&&b!==c&&s.add(b)}const d=i.split(/[/()[\]|]+/);for(const b of d){const f=Nt(b);if(!f)continue;s.add(f);const v=f.replace(/\s+/g,"");v&&v!==f&&s.add(v)}return s}function Lr(n){const s=new Set,i=c=>{if(c!=null)for(const d of qn(c))s.add(d)};return n&&typeof n=="object"&&(i(n.displayName),i(n.username),i(n.name),i(n.userId),n.id!=null&&i(n.id),i(n.role),n.role&&typeof n.role=="object"&&(i(n.role.id),i(n.role.name),i(n.role.label),i(n.role.displayName))),s}function _n(n){if(typeof n!="string"||!n)return{raw:n??null,base:n??null,doneSignature:null};const s=n.split(Er),i=s[0]||n;let c=null;for(let d=1;d<s.length;d+=1){const b=s[d];if(b.startsWith(Dn)){const f=b.slice(Dn.length);if(!f)c="";else try{c=decodeURIComponent(f)}catch{c=f}}}return{raw:n,base:i,doneSignature:c}}function $r(n){return Array.isArray(n)?n.reduce((s,i)=>{if(!i||i.action!=="print")return s;const c=Number(i?.printCount??i?.pages??0);return Number.isFinite(c)&&(s.sum+=Math.max(0,c),s.hasPrintEntries=!0),s},{sum:0,hasPrintEntries:!1}):{sum:0,hasPrintEntries:!1}}function Rr(n){const{sum:s,hasPrintEntries:i}=$r(n?.history);if(i)return s;const c=Number(n?.printCount);return Number.isFinite(c)?Math.max(0,c):0}function Fr({searchTerm:n=""}){const[s,i]=a.useState([]),[c,d]=a.useState(!0),{user:b}=Vn()||{},f=a.useMemo(()=>Lr(b),[b]),v=a.useMemo(()=>Os(b),[b]),[I,j]=a.useState({});a.useEffect(()=>{if(!v){j({});return}j(xn(v))},[v]),a.useEffect(()=>{if(!v||typeof window>"u")return()=>{};const S=x=>{x?.key===v&&j(xn(v))};return window.addEventListener("storage",S),()=>{window.removeEventListener("storage",S)}},[v]);const M=a.useCallback((S,x)=>{v&&j(u=>Vs(v,S,x,u))},[v]),D=a.useCallback((S,x)=>{M(S.nr,x),window.location.hash=`/protokoll/edit/${S.nr}`},[M]);a.useEffect(()=>{let S=!1,x=null,u=null,g=!0,T=!1;const E=async()=>{if(S||T)return;T=!0,g&&d(!0),x?.abort();const V=new AbortController;x=V;try{const _=await fetch("/api/protocol",{credentials:"include",signal:V.signal});if(!_.ok)throw new Error(`HTTP ${_.status}`);const U=await _.json();if(S||x!==V)return;const se=Array.isArray(U?.items)?U.items:[];i(se)}catch(_){if(S||_?.name==="AbortError")return;g&&i([]),console.warn("[ProtokollOverview] Aktualisierung fehlgeschlagen",_)}finally{!S&&g&&d(!1),g=!1,T=!1}},N=()=>{document.visibilityState==="visible"&&E()};return E(),u=window.setInterval(E,5e3),document.addEventListener("visibilitychange",N),()=>{S=!0,x?.abort(),u&&window.clearInterval(u),document.removeEventListener("visibilitychange",N)}},[]);const P=a.useMemo(()=>Nt(n),[n]),$=P.length>0,z=a.useMemo(()=>{const S=[...s].sort((u,g)=>(Number(g.nr)||0)-(Number(u.nr)||0));if(!$)return S;const x=u=>Nt(u).includes(P);return S.filter(u=>{const g=u?.uebermittlungsart||{},T=[].concat(g.ein?"Eingang":[]).concat(g.aus?"Ausgang":[]),E=[u?.nr,u?.zu,u?.datum,u?.zeit,u?.anvon,u?.information,u?.infoTyp,g.kanal,g.kanalNr,g.art,T.join(" / ")];if(Array.isArray(u?.massnahmen))for(const N of u.massnahmen)E.push(N?.massnahme,N?.verantwortlich);return E.some(N=>x(N))})},[s,$,P]);return e.jsx("div",{className:"p-3 md:p-4 h-full flex flex-col w-full",children:e.jsx("div",{className:"flex-1 min-h-0 overflow-auto border rounded-lg bg-white",children:c?e.jsx("div",{className:"p-4 text-gray-500",children:"Ladeâ€¦"}):e.jsxs("table",{className:"min-w-[1100px] w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0 z-10",children:e.jsxs("tr",{className:"[&>th]:px-2 [&>th]:py-2 [&>th]:text-left [&>th]:font-semibold border-b",children:[e.jsx("th",{className:"text-center whitespace-nowrap w-1",children:"âœ“"}),e.jsx("th",{className:"text-center whitespace-nowrap w-1",children:"NR."}),e.jsx("th",{className:"whitespace-nowrap w-1",children:"Druck"}),e.jsx("th",{className:"whitespace-nowrap w-1",children:"Datum"}),e.jsx("th",{className:"whitespace-nowrap w-1",children:"Zeit"}),e.jsx("th",{className:"whitespace-nowrap w-1",children:"Kanal"}),e.jsx("th",{className:"whitespace-nowrap w-1",children:"Richtung"}),e.jsx("th",{className:"whitespace-nowrap w-1",children:"An/Von"}),e.jsx("th",{children:"Information"}),e.jsx("th",{className:"whitespace-nowrap w-1",children:"Meldungstyp"})]})}),e.jsxs("tbody",{className:"[&>tr>td]:px-2 [&>tr>td]:py-2 [&>tr>td]:align-middle",children:[z.map(S=>{const x=S?.uebermittlungsart||{},u=x.kanal??x.kanalNr??x.art??"",T=[].concat(x.ein?"Eingang":[]).concat(x.aus?"Ausgang":[]).join(" / "),E=Rr(S),V=(Array.isArray(S?.massnahmen)?S.massnahmen:[]).filter(ue=>`${ue?.massnahme??""} ${ue?.verantwortlich??""}`.trim().length>0),_=V.some(ue=>!ue?.done),U=S?.otherRecipientConfirmation||{},se=String(U?.byRole||"").toUpperCase();U?.confirmed;const G=Us(S)&&!U?.confirmed,H=Hs(S),J=H.token,Q=String(S?.nr??""),fe=Q&&I?I[Q]:null,le=!!v,K=le&&J&&fe!==J,L=_n(J),xe=_n(fe),O=!!L.doneSignature,q=!!xe.doneSignature,me=O&&q&&L.doneSignature===xe.doneSignature,ae=typeof H.by=="string"?H.by:null;let Se=!1;if(ae&&f.size){const ue=qn(ae);for(const Le of ue)if(f.has(Le)){Se=!0;break}}const W=O&&(!le||!me)||K&&!Se,ie=ae&&ae.trim()?ae.trim():"Unbekannt",de=L.doneSignature&&String(L.doneSignature).trim(),pe=(de?(()=>{const ue=de.split(",").map($e=>$e.trim()).filter(Boolean);return(ue[ue.length-1]||"").replace(/\s*#\d+\s*$/,"").trim()||null})():null)||ie,oe=W?Tr(S):null,we=W?`Erstellt/geÃ¤ndert durch ${pe}`:`GeÃ¤ndert durch ${pe}`,Y=oe?`${we}
${oe}`:we,X=!!U?.confirmed,ce=[`${E}Ã— gedruckt`];if(_&&ce.push("Offene Aufgaben vorhanden"),G&&ce.push("BestÃ¤tigung ausstehend"),U?.confirmed){const ue=se||"BestÃ¤tigt";ce.push(`BestÃ¤tigt durch ${ue}`)}const F=ce.join(" â€¢ "),ee=_?"border-red-500 text-red-600":"border-emerald-500 text-emerald-600",ve=G?"text-gray-400":_?"text-red-600":"";V.length>0;const Ne=!_,Ie=!!U?.confirmed&&Ne,je=["border-b  cursor-pointer",W?"bg-yellow-50 hover:bg-yellow-100":"hover:bg-gray-50",G?"text-gray-400 [&>td]:text-gray-400":""].join(" ");return e.jsxs("tr",{className:je,onClick:()=>D(S,J),title:Y,"aria-label":Y,children:[e.jsx("td",{className:"align-middle text-center",children:Ie?e.jsx("span",{className:"inline-flex items-center justify-center text-emerald-600 text-lg font-semibold",title:"BestÃ¤tigt und alle MaÃŸnahmen erledigt",children:"âœ“"}):null}),e.jsx("td",{className:"align-middle text-center font-semibold whitespace-nowrap",children:(()=>{const ue=S.nr??"â€”",Le=S.zu!==null&&S.zu!==void 0&&String(S.zu).trim()!=="",$e=Le?String(S.zu):"",Ee=Le?`${ue}/${$e}`:`${ue}`;return X?e.jsx("span",{className:`inline-flex items-center justify-center px-3 h-8 rounded-full border-2 text-sm font-semibold ${ee}`,title:F,"aria-label":F,children:Ee}):e.jsx("span",{className:`inline-block text-sm font-semibold ${ve}`,title:F,"aria-label":F,children:Ee})})()}),e.jsx("td",{className:"font-semibold whitespace-nowrap",children:E}),e.jsx("td",{className:"whitespace-nowrap",children:S.datum}),e.jsx("td",{className:"whitespace-nowrap",children:S.zeit}),e.jsx("td",{className:"whitespace-nowrap",title:u,children:u}),e.jsx("td",{className:"whitespace-nowrap",title:T,children:T}),e.jsx("td",{className:"whitespace-nowrap",children:S.anvon}),e.jsx("td",{className:"whitespace-pre-wrap",children:Mr(S.information)}),e.jsx("td",{className:"whitespace-nowrap",children:S.infoTyp||"â€”"})]},S.nr)}),!z.length&&e.jsx("tr",{children:e.jsx("td",{colSpan:10,className:"p-4 text-gray-500 italic",children:"â€” keine EintrÃ¤ge â€”"})})]})]})})})}const Zn={},zr=3e3,Dr=1e3;function At(n,s){const i=Number(n);if(Number.isFinite(i)&&i>0){const c=Math.floor(i);return c>0?c:s}return s}const _r=At(Zn?.VITE_STATUS_POLL_INTERVAL_MS,zr),Br=At(Zn?.VITE_ACTIVITY_POLL_INTERVAL_MS,Dr);function Or({autoEnabled:n,remaining:s,disabled:i=!1,showTimer:c=!0,showLastLoaded:d=!0,onImportInfo:b}){const[f,v]=a.useState(!1),[I,j]=a.useState(!1),[M,D]=a.useState(""),[P,$]=a.useState({remainingMin:null,idleMinutes:null,lastActivityIso:null,autoStopMin:null}),[z,S]=a.useState({lastLoadedIso:null,file:"list_filtered.json"});a.useEffect(()=>{typeof b=="function"&&b(z)},[z,b]);const[x,u]=a.useState(!1),[g,T]=a.useState(30),[E,N]=a.useState(null),[V,_]=a.useState(_r),[U,se]=a.useState(Br),re=a.useRef(!1),G=async()=>{try{const[Q,fe,le]=await Promise.all([fetch("/api/ff/status",{credentials:"include",cache:"no-store"}).then(K=>K.json()).catch(()=>({running:!1})),fetch("/api/ff/creds",{credentials:"include",cache:"no-store"}).then(K=>K.json()).catch(()=>({has:!1})),fetch("/api/import/auto-config",{credentials:"include",cache:"no-store"}).then(K=>K.json()).catch(()=>({enabled:!1,intervalSec:30}))]);v(!!Q.running),j(!!fe.has),u(!!le.enabled),T(Number(le.intervalSec||30)),_(K=>At(le.statusPollIntervalMs,K)),se(K=>At(le.activityPollIntervalMs,K)),re.current||(re.current=!0,fe.has||D("Keine globalen Fetcher-Zugangsdaten. Bitte als Admin unter /user-admin setzen."))}catch{}};a.useEffect(()=>{G();const Q=setInterval(()=>{G()},V);return()=>clearInterval(Q)},[V]),a.useEffect(()=>{const Q=async()=>{try{const le=await fetch("/api/activity/status",{credentials:"include",cache:"no-store"});if(le.ok){const K=await le.json(),L=Number(K.idleMinutes),xe=Number(K.autoStopMin),O=Math.max(0,Math.ceil(xe-L));$({remainingMin:O,idleMinutes:L,lastActivityIso:K.lastActivityIso,autoStopMin:xe}),v(!!K.fetcher?.running),S({lastLoadedIso:K.import?.lastLoadedIso??null,file:K.import?.file||"list_filtered.json"})}}catch{}};Q();const fe=setInterval(()=>{Q()},U);return()=>clearInterval(fe)},[U]),a.useEffect(()=>{let Q;const fe=()=>{if(!x||!z.lastLoadedIso){N(null);return}const K=new Date(z.lastLoadedIso).getTime()+g*1e3,L=Math.max(0,Math.ceil((K-Date.now())/1e3));N(L)};return fe(),Q=setInterval(fe,1e3),()=>clearInterval(Q)},[x,g,z.lastLoadedIso]);const H=typeof n=="boolean"?n:x,J=typeof s=="number"?s:E;return e.jsxs("div",{className:`flex items-center h-9 gap-2 ${i?"opacity-60 pointer-events-none":""}`,style:{alignItems:"center"},children:[c&&e.jsx("span",{className:`sync-chip ${H?"active":""}`,title:H?"Auto-Import Countdown":"Auto-Import ist deaktiviert",style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:"110px",minWidth:"110px",textAlign:"center"},children:H?`âŸ³ in ${J??"â€“"}s`:"â¸ manuell"}),M&&e.jsx("span",{style:{color:"#dc2626",fontSize:12,marginLeft:8},children:M}),f&&P.remainingMin!=null&&P.remainingMin<=15&&e.jsxs("div",{title:`Letzte AktivitÃ¤t: ${P.lastActivityIso?new Date(P.lastActivityIso).toLocaleString():"â€“"} â€¢ Inaktiv: ${P.idleMinutes?.toFixed?.(1)} min â€¢ Limit: ${P.autoStopMin} min`,className:"ml-2 inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border "+(P.remainingMin<=5?"bg-red-50 text-red-700 border-red-300":P.remainingMin<=15?"bg-amber-50 text-amber-700 border-amber-300":"bg-blue-50 text-blue-700 border-blue-300"),children:[e.jsx("span",{className:"mr-2 h-2 w-2 rounded-full bg-current",style:{animation:"pulse 1.5s ease-in-out infinite"}}),e.jsxs("span",{children:["Auto-Import stoppt in ",e.jsxs("b",{children:[P.remainingMin," min"]})]})]}),d&&e.jsx("div",{title:`Quelle: ${z.file}`,className:"ml-2 inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border bg-white text-gray-700",style:{borderColor:"#cbd5e1"},children:e.jsxs("span",{children:["Zuletzt geladen:"," ",e.jsx("b",{children:z.lastLoadedIso?new Date(z.lastLoadedIso).toLocaleTimeString("de-AT",{hour12:!1}):"â€“"})]})})]})}function Vr(){const[n,s]=a.useState(.9);return a.useEffect(()=>{const i=()=>{const c=window.innerWidth,d=window.innerHeight,b=Math.min(Math.max(Math.min(c/1440,d/900),.78),.95);s(Number(b.toFixed(2)))};return i(),window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[]),n}function Ur(){try{const n=new URLSearchParams(window.location.search),s=parseFloat(n.get("font"));if(Number.isFinite(s)&&s>=.5&&s<=5)return s}catch{}try{const n=parseFloat(localStorage.getItem("ff_font_scale")||"");if(Number.isFinite(n)&&n>=.5&&n<=5)return n}catch{}return 1.2}const Jn=n=>new Intl.DateTimeFormat("de-AT",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).format(new Date(n||Date.now())),Qn=n=>Array.isArray(n?.assignedVehicles)?n.assignedVehicles.length:0,Yn=(n,s)=>(n?.assignedVehicles||[]).reduce((i,c)=>{const d=s.get(c);return i+(typeof d?.mannschaft=="number"?d.mannschaft:0)},0),Hr=()=>{if(typeof window>"u")return{id:"",label:""};try{const n=new URLSearchParams(window.location.search),s=n.get("bereichId")||n.get("abschnittId")||n.get("areaId")||"",i=n.get("bereich")||n.get("abschnitt")||n.get("area")||"";return{id:String(s||"").trim(),label:String(i||"").trim()}}catch{return{id:"",label:""}}};function Kr({c:n,vehiclesById:s,showBottomCounts:i=!0,headerRight:c,kind:d}){const b=d==="erledigt",f=b?Array.isArray(n?.everVehicles)?n.everVehicles.length:0:Qn(n),v=b?Number.isFinite(n?.everPersonnel)?n.everPersonnel:0:Yn(n,s),I=n?.isArea?"bg-slate-100 border-slate-200":"bg-white";return e.jsxs("div",{className:`border rounded-lg p-2 shadow-sm text-[0.9rem] leading-tight ${I}`,children:[e.jsxs("div",{className:"flex items-start justify-between text-[0.72rem] text-gray-600 mb-1",children:[e.jsx("span",{children:Jn(n.createdAt)}),e.jsx("span",{className:"font-semibold",children:c})]}),e.jsx("div",{className:"font-semibold",children:n.content}),(n.humanId||n.typ||n.ort||n.alerted)&&e.jsxs("div",{className:"text-[0.75rem] text-gray-600 mt-0.5 space-y-0.5",children:[(n.humanId||n.typ)&&e.jsxs("div",{className:"flex flex-wrap items-center gap-x-2 gap-y-0.5",children:[n.humanId&&e.jsx("span",{className:"font-semibold text-gray-700",children:n.humanId}),n.typ&&e.jsxs("span",{children:["ðŸ·ï¸ ",n.typ]})]}),(n.ort||n.alerted)&&e.jsxs("div",{className:"flex flex-wrap items-center gap-x-2 gap-y-0.5",children:[n.ort&&e.jsxs("span",{children:["ðŸ“ ",n.ort]}),n.alerted&&e.jsxs("span",{className:"text-gray-500",children:["ðŸ”” ",n.alerted]})]})]}),i&&e.jsxs("div",{className:"mt-1 text-[0.78rem] text-gray-700 flex items-center gap-2",children:[e.jsxs("span",{children:["ðŸš’ ",f]}),e.jsxs("span",{children:["ðŸ‘¥ ",v]})]})]})}function Gt({title:n,cards:s,vehiclesById:i,kind:c,viewportH:d}){const v=Math.max(160,d-56-40),I=Math.max(1,Math.floor(v/96)),j=I*2,M=I+1,D=Math.max(j+2,M+6);let P="grid-cols-1";s.length>=D?P="grid-cols-3":s.length>=M&&(P="grid-cols-2");const $=x=>Jn(x.statusSince),z=a.useMemo(()=>{let x=0,u=0,g=0,T=0,E=0;for(const N of s)if(x+=1,N?.isArea?u+=1:g+=1,c==="erledigt")T+=Array.isArray(N?.everVehicles)?N.everVehicles.length:0,E+=Number.isFinite(N?.everPersonnel)?N.everPersonnel:0;else{T+=Array.isArray(N?.assignedVehicles)?N.assignedVehicles.length:0;const V=Array.isArray(N?.assignedVehicles)?N.assignedVehicles:[];for(const _ of V){const U=i.get(_);typeof U?.mannschaft=="number"&&(E+=U.mannschaft)}}return{cardCount:x,areaCount:u,incidentCount:g,unitSum:T,personSum:E}},[s,c,i]),S={neu:"bg-red-100","in-bearbeitung":"bg-yellow-100",erledigt:"bg-green-100"}[c]||"bg-gray-100";return e.jsxs("section",{className:`${S} rounded-xl shadow p-3 h-full flex flex-col min-h-0`,children:[e.jsxs("h3",{className:"text-sm font-semibold mb-2",children:[n," â€” â¬› ",z.incidentCount," | ðŸ—ºï¸ ",z.areaCount," | ðŸš’ ",z.unitSum," | ðŸ‘¥ ",z.personSum]}),e.jsx("div",{className:`grid ${P} gap-2 overflow-auto pr-1 flex-1 min-h-0 place-content-start`,children:s.map(x=>e.jsx(Kr,{c:x,vehiclesById:i,headerRight:$(x),showBottomCounts:!0,kind:c},x.id))}),s.length===0&&e.jsx("div",{className:"text-[0.8rem] text-gray-500 italic text-center py-4",children:"â€” keine EintrÃ¤ge â€”"})]})}function Gr(){Vr();const[n,s]=a.useState(Ur());a.useEffect(()=>{const u=document.documentElement.style.fontSize||"",g=Math.max(50,Math.min(500,Math.round(n*100)));return document.documentElement.style.fontSize=g+"%",()=>{document.documentElement.style.fontSize=u}},[n]),a.useEffect(()=>{const u=g=>{if(g.key==="ff_font_scale"){const T=parseFloat(g.newValue||"");Number.isFinite(T)&&T>=.5&&T<=5&&s(T)}};return window.addEventListener("storage",u),()=>window.removeEventListener("storage",u)},[]);const[i,c]=a.useState(null),[d,b]=a.useState([]),[f,v]=a.useState(window.innerHeight);a.useEffect(()=>{let u=!0;const g=async()=>{const[N,V]=await Promise.all([Me(),Ke()]);u&&(c(N),b(V))};g();const T=setInterval(g,7e3),E=()=>v(window.innerHeight);return window.addEventListener("resize",E),()=>{u=!1,clearInterval(T),window.removeEventListener("resize",E)}},[]),a.useEffect(()=>{try{const u=new URLSearchParams(window.location.search);if(u.get("print")==="1"||u.get("pdf")==="1"){const g=setTimeout(()=>{window.print()},600);return()=>clearTimeout(g)}}catch{}},[]),a.useEffect(()=>{const u=()=>{try{window.close()}catch{}};return window.addEventListener("afterprint",u),()=>window.removeEventListener("afterprint",u)},[]);const I=a.useMemo(()=>Hr(),[]),j=a.useMemo(()=>new Map(d.map(u=>[u.id,u])),[d]),{columns:M,areaLabel:D}=a.useMemo(()=>{const u={neu:{name:"Neu",items:[]},"in-bearbeitung":{name:"In Bearbeitung",items:[]},erledigt:{name:"Erledigt",items:[]}},g=i?.columns||u,T=J=>{const Q=g[J]||u[J];return{name:Q?.name||u[J].name,items:Array.isArray(Q?.items)?[...Q.items]:[]}},E={neu:T("neu"),"in-bearbeitung":T("in-bearbeitung"),erledigt:T("erledigt")},N=[];for(const J of["neu","in-bearbeitung","erledigt"])for(const Q of g[J]?.items||[])Q?.isArea&&N.push(Q);const V=I.id,_=I.label,U=!!(V||_),se=String(V||"").toLowerCase(),re=String(_||"").toLowerCase();let G=null;if(N.length&&U&&(V&&(G=N.find(J=>String(J?.id)===V)||N.find(J=>String(J?.id||"").toLowerCase()===se)||N.find(J=>String(J?.humanId||"").toLowerCase()===se)),!G&&_&&(G=N.find(J=>String(J?.content||"").toLowerCase()===re)),!G&&_&&(G=N.find(J=>String(J?.content||"").toLowerCase().includes(re)))),G){const J=String(G.id);for(const Q of["neu","in-bearbeitung","erledigt"]){const fe=E[Q]?.items||[];E[Q]={...E[Q],items:fe.filter(le=>le?.isArea?String(le.id)===J:(le?.areaCardId!=null?String(le.areaCardId):"")===J)}}}else if(U)for(const J of["neu","in-bearbeitung","erledigt"])E[J]={...E[J],items:[]};const H=(G?.content||"").trim()||(G?.humanId||"").trim()||U&&(I.label||I.id)||"";return{columns:E,areaLabel:H}},[i,I.id,I.label]),P=a.useMemo(()=>{const u="Einsatzstellen-Ãœbersicht-Feuerwehr";return D?`${u} - ${D}`:u},[D]);a.useEffect(()=>{if(typeof document>"u")return;const u=document.title;return document.title=P,()=>{document.title=u}},[P]);const $=a.useMemo(()=>{let u=0;for(const g of["neu","in-bearbeitung"])for(const T of M[g].items||[])u+=Qn(T);return u},[M]),z=a.useMemo(()=>{let u=0;for(const g of["neu","in-bearbeitung"])for(const T of M[g].items||[])u+=Yn(T,j);return u},[M,j]),S=a.useMemo(()=>{let u=0;for(const g of M.neu.items||[])g?.isArea||(u+=1);for(const g of M["in-bearbeitung"].items||[])g?.isArea||(u+=1);return u},[M]),x=a.useMemo(()=>{let u=S;for(const g of M.erledigt.items||[])g?.isArea||(u+=1);return u},[S,M]);return i?e.jsx("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden",children:e.jsxs("div",{className:"h-full w-full flex flex-col gap-2",children:[e.jsxs("header",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:P}),e.jsxs("div",{className:"text-base md:text-lg font-bold flex flex-wrap gap-4",children:[e.jsxs("span",{children:["ðŸš’ ",$]}),e.jsxs("span",{children:["ðŸ‘¥ ",z]}),e.jsxs("span",{children:["ðŸŸ¡ Aktiv: ",S]}),e.jsxs("span",{children:["ðŸ“¦ Gesamt: ",x]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2 min-h-0 flex-1",children:[e.jsx(Gt,{title:"Neu",cards:M.neu.items,vehiclesById:j,kind:"neu",viewportH:f}),e.jsx(Gt,{title:"In Bearbeitung",cards:M["in-bearbeitung"].items,vehiclesById:j,kind:"in-bearbeitung",viewportH:f}),e.jsx(Gt,{title:"Erledigt",cards:M.erledigt.items,vehiclesById:j,kind:"erledigt",viewportH:f})]})]})}):e.jsx("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden",children:e.jsx("div",{className:"h-full w-full flex items-center justify-center",children:"Ladeâ€¦"})})}const Wr="S2",qr=3e4,Zr=" - *** - NEUE LAGEMELDUNG: ",Jr=" - *** -",Bn="Â ".repeat(30);function Qr(){const[n]=a.useState(.9);return n}const Yr=n=>`card:${n}`,He=!0,Xr="#2563eb",ea=2e4,ta={einsatz:{key:"einsatz",label:"E",title:"Zur EinsatzÃ¼bersicht",onClick:()=>{window.location.href="/"}},aufgaben:{key:"aufgaben",label:"A",title:"Zum Aufgaben-Board",onClick:()=>{window.location.href="/aufgaben"}},meldestelle:{key:"meldestelle",label:"M",title:"Zur Meldestelle",onClick:()=>{window.location.href="/#/protokoll"}}};function St(n){return Object.values(ta).filter(s=>s.key!==n)}function na(n){if(typeof n!="string")return null;const s=n.trim();if(!s)return null;const i=s.match(/^(\d+):(\d{1,2})$/);if(i){const v=Number(i[1]),I=Number(i[2]);if(Number.isFinite(v)&&Number.isFinite(I))return(v*60+I)*6e4}const d=s.replace(",",".").toLowerCase().match(/^([0-9]+(?:\.[0-9]+)?)([a-zÃ¤Ã¶Ã¼]*)$/);if(!d)return null;const b=Number(d[1]);if(!Number.isFinite(b)||b<=0)return null;const f=d[2];return!f||f==="m"||f==="min"||f==="mins"||f==="minute"||f==="minuten"?b*6e4:f==="h"||f==="st"||f==="std"||f==="stunde"||f==="stunden"?b*36e5:f==="s"||f==="sek"||f==="sekunde"||f==="sekunden"?b*1e3:f==="d"||f==="tag"||f==="tage"||f==="day"||f==="days"?b*864e5:null}function sa({available:n,alerted:s,assigned:i}){return n?i?{container:"border-red-400 bg-white",label:"text-gray-700"}:s?{container:"border-blue-500 bg-blue-50",label:"text-blue-900"}:{container:"border-green-400 bg-white",label:"text-gray-700"}:{container:"border-gray-300 bg-gray-50",label:"text-gray-400"}}function oa(){if(Qr(),typeof window<"u"&&window.location.pathname==="/status")return e.jsx(Gr,{});const n=Ks(),s=n.running||n.paused,[i,c]=a.useState(!1);a.useEffect(()=>{yn().then(()=>c(!0))},[]);const d=i&&wn("einsatzboard"),b=d||i&&Vt("S1"),f=!d,[v,I]=a.useState(null),[j,M]=a.useState([]),[D,P]=a.useState([]),[$,z]=a.useState(new Map),[S,x]=a.useState(new Map),u=a.useRef(new Map),g=a.useRef(new Map),T=a.useRef(new Map),E=a.useRef(new Map),N=a.useCallback(t=>{if(typeof window>"u")return{cancelled:!0};const o=`Bitte Dauer der Nicht-VerfÃ¼gbarkeit fÃ¼r ${t} angeben (z.â€¯B. 30, 2h oder 1:30). Leer lassen fÃ¼r unbegrenzt.`,r=window.prompt(o,"");if(r===null)return{cancelled:!0};const l=r.trim();if(!l)return{cancelled:!1,untilMs:null,untilIso:null};const m=na(l);if(!Number.isFinite(m)||m<=0)return window.alert("UngÃ¼ltige Dauer. Bitte z.â€¯B. 30, 2h oder 1:30 eingeben."),{cancelled:!0};const h=Date.now()+m;return{cancelled:!1,untilMs:h,untilIso:new Date(h).toISOString()}},[]),V=a.useCallback(async()=>{try{const t=await Ke();M(t)}catch(t){console.error(t)}},[M]),_=a.useCallback((t,o)=>{if(!t||!o)return;const r=Date.parse(o);if(!Number.isFinite(r))return;const l=u.current,m=l.get(t);if(m&&m.untilIso===o)return;m&&(clearTimeout(m.timeout),l.delete(t));const h=r-Date.now(),y=async()=>{u.current.delete(t),g.current.delete(t);try{await Cn(t,!0)}catch(C){console.error(C)}await V()};if(h<=0){y();return}const w=setTimeout(y,h);l.set(t,{timeout:w,untilIso:o})},[V]),U=a.useCallback((t,o)=>{if(!t||!o)return;const r=Date.parse(o);if(!Number.isFinite(r))return;const l=T.current,m=l.get(t);if(m&&m.untilIso===o)return;m&&(clearTimeout(m.timeout),l.delete(t));const h=r-Date.now(),y=async()=>{T.current.delete(t),E.current.delete(t);try{await In(t,!0)}catch(C){console.error(C)}await V(),z(C=>{const A=new Map(C);return A.set(t,!0),A})};if(h<=0){y();return}const w=setTimeout(y,h);l.set(t,{timeout:w,untilIso:o})},[V,z]);a.useEffect(()=>{const t=u.current,o=new Set;for(const r of j){if(!r)continue;const l=String(r.id??"").trim();if(!l)continue;o.add(l);const m=r.available!==!1&&r.groupAvailable!==!1,h=r.unavailableUntil||g.current.get(l)||null,y=h?Date.parse(h):NaN,w=Number.isFinite(y)?new Date(y).toISOString():null,C=String(r.ort??"").trim();if(($.has(C)?$.get(C):!0)===!1){w?g.current.set(l,w):g.current.delete(l);const R=t.get(l);R&&(clearTimeout(R.timeout),t.delete(l));continue}if(m||!w){const R=t.get(l);R&&(clearTimeout(R.timeout),t.delete(l)),g.current.delete(l);continue}g.current.set(l,w),_(l,w)}for(const[r,l]of Array.from(t.entries()))o.has(r)||(clearTimeout(l.timeout),t.delete(r),g.current.delete(r))},[j,$,_]),a.useEffect(()=>{const t=T.current,o=new Set;for(const[r,l]of $.entries()){const m=String(r||"").trim();if(!m)continue;if(o.add(m),l!==!1){const C=t.get(m);C&&(clearTimeout(C.timeout),t.delete(m)),E.current.delete(m);continue}const h=E.current.get(m)||null,y=h?Date.parse(h):NaN;if(!Number.isFinite(y)){const C=t.get(m);C&&(clearTimeout(C.timeout),t.delete(m)),E.current.delete(m);continue}const w=new Date(y).toISOString();E.current.set(m,w),U(m,w)}for(const[r,l]of Array.from(t.entries()))o.has(r)||(clearTimeout(l.timeout),t.delete(r),E.current.delete(r))},[$,U]),a.useEffect(()=>()=>{for(const{timeout:t}of u.current.values())clearTimeout(t);u.current.clear(),g.current.clear();for(const{timeout:t}of T.current.values())clearTimeout(t);T.current.clear(),E.current.clear()},[]);const se=a.useCallback(t=>{Array.isArray(t)&&z(o=>{let r=!1;const l=new Map(o);for(const m of t){if(!m||!m.ort)continue;const h=String(m.ort),y=m.groupAvailable!==!1;(!l.has(h)||l.get(h)!==y)&&(l.set(h,y),r=!0)}return r?l:o})},[]);a.useEffect(()=>{se(j)},[j,se]);const re=a.useCallback(t=>{const o=Object.entries(t?.availability||{}),r=[],l=new Map;for(const[m,h]of o){const w=!(h===!1||h&&typeof h=="object"&&h.available===!1);let C=null;if(!w){const A=h&&typeof h=="object"?h.until:null;if(typeof A=="string"&&A.trim()){const R=Date.parse(A);!Number.isNaN(R)&&R>Date.now()&&(C=new Date(R).toISOString())}}r.push([m,w]),!w&&C&&l.set(m,C)}E.current=l,z(new Map(r))},[]),G=a.useCallback(t=>{const o=Object.entries(t?.alerted||{});x(new Map(o.map(([r,l])=>[r,l===!0])))},[]),[H,J]=a.useState(""),[Q,fe]=a.useState(""),[le,K]=a.useState(""),{user:L}=Vn()||{},{roles:xe}=Gs(),O=a.useMemo(()=>xe.some(t=>t==="LTSTB"||t==="LTSTBSTV"),[xe]),[q,me]=a.useState(!1),[ae,Se]=a.useState(!1),[he,k]=a.useState(!1),[W,ie]=a.useState(null),[de,ye]=a.useState(null),[pe,oe]=a.useState(""),[we,Y]=a.useState(!1),[X,ce]=a.useState(!1),[F,ee]=a.useState(30),[ve,Ne]=a.useState(!1),[Te,Ie]=a.useState({lastLoadedIso:null,file:"list_filtered.json"}),[je,ue]=a.useState(!1),[Le,$e]=a.useState(!1),[Ee,Ge]=a.useState(!1),[p,te]=a.useState(null),[ke,ge]=a.useState(!1),We=t=>{te(t),ge(!1),Ge(!0)},Be=a.useRef(null),[nt,qe]=a.useState([]);a.useEffect(()=>{let t=!1;return(async()=>{try{if(await yn(),t)return;const o=wn("protokoll",L),r=!O&&Vt("S3",L);me(o||r),Se(Vt("S3",L)&&O)}catch{if(t)return;me(!1),Se(!1)}})(),()=>{t=!0}},[O,L]);const[kt,Xn]=a.useState(window.location.hash);a.useEffect(()=>{const t=()=>Xn(window.location.hash);return window.addEventListener("hashchange",t),()=>window.removeEventListener("hashchange",t)},[]);const dt=kt.replace(/^#/,""),[Zt,Jt]=a.useState(()=>new Set),[Ct,It]=a.useState(0),st=a.useRef(null),De=a.useRef(null),Qt=a.useRef(0),Yt=a.useRef(new Set),Xt=a.useRef(0),en=a.useRef(0),ut=a.useRef(null),[es,ft]=a.useState(0);a.useEffect(()=>{document.title="Einsatzstellen-Ãœbersicht-Feuerwehr",Ws()},[]),a.useEffect(()=>()=>{De.current&&(clearTimeout(De.current),De.current=null),st.current&&(clearTimeout(st.current),st.current=null)},[]),a.useEffect(()=>{(async()=>{try{await Un(qt())}catch{}})()},[]),a.useEffect(()=>{H||(De.current&&(clearTimeout(De.current),De.current=null),he&&k(!1))},[H,he]),a.useEffect(()=>{if(!d)return;if(!X){ft(0);return}const t=setInterval(()=>ft(o=>o+1),1e3);return()=>clearInterval(t)},[He,X]);const ts=X?Math.max(0,F-es%Math.max(1,F)):0;a.useEffect(()=>{document.title="Einsatzstellen-Ãœbersicht-Feuerwehr"},[]),a.useEffect(()=>{(async()=>{const[t,o,r,l,m]=await Promise.all([Me(),Ke(),qs(),Zs().catch(()=>({availability:{}})),vn().catch(()=>({alerted:{}}))]);I(t),M(o),P(Array.isArray(r)?r:[]),re(l),G(m),Ce(t),Xt.current=Date.now()+ea;try{const h=await Js();ce(!!h.enabled),ee(Number(h.intervalSec)||30),Ne(!!h.demoMode)}catch{}ft(0)})()},[He]),a.useEffect(()=>{X&&(async()=>{try{(await fetch("/api/ff/status",{credentials:"include",cache:"no-store"}).then(o=>o.json()).catch(()=>({running:!1}))).running||await fetch("/api/ff/start",{method:"POST",credentials:"include"})}catch{}})()},[He,X,F]),a.useEffect(()=>{let t=!1,o=null,r=0;const l=Math.max(5,Math.min(60,X?8:15)),m=async()=>{const h=++r;try{const y=new Set(Pt.current),w=ut.current,C=await Me();!t&&h===r&&(I(C),cn({oldIds:y,oldBoard:w,newBoard:C,pulseMs:8e3}))}catch{}t||(o=setTimeout(m,l*1e3))};return o=setTimeout(m,l*1e3),()=>{t=!0,o&&clearTimeout(o)}},[He,X]),a.useEffect(()=>{let t=!1,o=null,r=0;const l=Math.max(5,Math.min(60,X?8:15)),m=async()=>{const h=++r;try{const y=await vn();!t&&h===r&&G(y)}catch{}t||(o=setTimeout(m,l*1e3))};return m(),()=>{t=!0,o&&clearTimeout(o)}},[He,X,G]),a.useEffect(()=>{const t=o=>{o.altKey&&(o.key==="e"||o.key==="E")&&(o.preventDefault(),$e(!0))};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[He]);const rt=a.useMemo(()=>Q.trim().toLowerCase(),[Q]),Ze=rt.length>0,Pe=v??{columns:{neu:{items:[]},"in-bearbeitung":{items:[]},erledigt:{items:[]}}},Et=a.useMemo(()=>nt.length?`${nt.map(o=>`${Zr}${o}${Jr}`).join(Bn)}${Bn}`:"",[nt]),tn=a.useCallback(async()=>{Be.current&&Be.current.abort();const t=new AbortController;Be.current=t;try{const o=await Qs(Wr,{signal:t.signal}),l=(Array.isArray(o?.items)?o.items:[]).filter(m=>String(m?.status??"").trim().toLowerCase()==="neu").filter(m=>String(m?.type??"").trim().toLowerCase()==="lagemeldung").map(m=>typeof m?.desc=="string"?m.desc:"").map(m=>m.replace(/\s+/g," ").trim()).filter(Boolean);t.signal.aborted||qe(l)}catch{t.signal.aborted||qe([])}finally{Be.current===t&&(Be.current=null)}},[qe]);a.useEffect(()=>{if(!i)return;const t=()=>{tn().catch(()=>{})};t();const o=setInterval(t,qr);return()=>{clearInterval(o),Be.current&&Be.current.abort()}},[tn,i]);const at=a.useMemo(()=>{const t=!!H;if(!t&&!Ze)return Pe;const o=String(H),r={};for(const[l,m]of Object.entries(Pe?.columns||{})){let h=m?.items||[];t&&(h=h.filter(y=>ln(y,o))),Ze&&(h=h.filter(y=>as(y,rt))),r[l]={...m,items:h}}return{...Pe,columns:r}},[Pe,H,Ze,rt]),ns=(t,o=!1)=>{const r=String(t||"");return!o||!r?r:/^B/i.test(r)?`B${r.slice(1)}`:/^[A-Za-z]/.test(r)?`B${r.slice(1)}`:`B${r}`},nn=t=>{if(!t)return"";const o=t.humanId?String(t.humanId):"",r=ns(o,!!t.isArea),l=t.content?String(t.content):"";return[r,l].filter(Boolean).join(" â€“ ")||r||l||""},Je=a.useMemo(()=>{const t=Pe?.columns||{},o=[];for(const r of Object.keys(t))for(const l of t[r]?.items||[])l?.isArea&&o.push(l);return o},[Pe]),Qe=a.useMemo(()=>{const t=new Map;return Je.forEach(o=>{if(!o?.id)return;const r=String(o.id);t.set(r,nn(o))}),t},[Je]),Mt=a.useMemo(()=>{const t=new Map;return Je.forEach(o=>{o?.id&&t.set(String(o.id),o.areaColor||null)}),t},[Je]),Ue=a.useMemo(()=>Je.map(t=>({id:String(t.id),label:Qe.get(String(t.id))||nn(t),color:Mt.get(String(t.id))||null})),[Je,Qe,Mt]);a.useEffect(()=>{if(!H)return;Ue.some(o=>String(o.id)===H)||J("")},[H,Ue]);const sn=a.useMemo(()=>{if(!H)return"";const t=String(H);return Qe.get(t)||Ue.find(o=>String(o.id)===t)?.label||""},[H,Qe,Ue]),rn=(t,o)=>{if(t?.id&&Re(t.id),o){if(I(o),Ce(o),t?.id&&p?.id===t.id){const r=gt(o,t.id);te(r||t)}return}t&&(I(r=>{if(!r)return r;const l=structuredClone(r);for(const m of Object.keys(l.columns||{})){const h=l.columns[m]?.items||[],y=h.findIndex(w=>w?.id===t.id);if(y>=0){h[y]={...h[y],...t};break}}return Ce(l),l}),p?.id===t.id&&te(r=>r?{...r,...t}:t))},ss=10;function rs(t){try{const o=t?.columns||{};return[(o.neu?.items||[]).length,(o["in-bearbeitung"]?.items||[]).length,(o.erledigt?.items||[]).length].some(l=>l>=ss)}catch{return!1}}a.useEffect(()=>{const t=rs(Pe);document.documentElement.classList.toggle("ui-dense",t)},[Pe]);const[it,an]=a.useState(new Set),Pt=a.useRef(new Set),Ce=t=>{ut.current=t,Pt.current=Tt(t)},Re=(...t)=>{t.map(o=>String(o??"").trim()).filter(Boolean).forEach(o=>Yt.current.add(o))};a.useEffect(()=>{if(!it.size)return;const t=setTimeout(()=>an(new Set),9e3);return()=>clearTimeout(t)},[it]);function Tt(t){const o=new Set;if(!t?.columns)return o;for(const r of Object.keys(t.columns))for(const l of t.columns[r].items||[])o.add(String(l.id));return o}function Lt(t){return Array.isArray(t)?t.map(Lt):t&&typeof t=="object"?Object.fromEntries(Object.keys(t).sort().map(o=>[o,Lt(t[o])])):t}function mt(t,{ignoreUpdatedAt:o=!1}={}){if(!t||typeof t!="object")return t;const{columnId:r,status:l,updatedAt:m,column:h,...y}=t,w={...y};return!o&&typeof m<"u"&&(w.updatedAt=m),Lt(w)}function on(t){const o=new Map;if(!t?.columns)return o;for(const[r,l]of Object.entries(t.columns))for(const m of l?.items||[])!m||typeof m.id>"u"||m.id===null||o.set(String(m.id),{card:m,columnId:r});return o}function ln(t,o){return t?o?t.isArea?String(t.id)===o:t.areaCardId?String(t.areaCardId)===o:!1:!0:!1}function as(t,o){if(!o)return!0;if(!t)return!1;try{return JSON.stringify(t).toLowerCase().includes(o)}catch{return!1}}function is(t,o){if(!o)return!0;if(!t)return!1;try{return JSON.stringify(t).toLowerCase().includes(o)}catch{return!1}}const os=(t=8e3)=>{k(!0),De.current&&clearTimeout(De.current),De.current=setTimeout(()=>{k(!1),De.current=null},t)};function cn({oldIds:t,oldBoard:o,newBoard:r,pulseMs:l=8e3}){const m=Date.now(),h=o??ut.current,y=t??Tt(h),w=Tt(r),C=new Set;for(const ne of w)y.has(ne)||C.add(ne);const A=Yt.current,R=new Set([...C].filter(ne=>!A.has(String(ne)))),B=new Set;if(h&&r){const ne=on(h),be=on(r);for(const[Ae,et]of be.entries()){if(!ne.has(Ae)||A.has(String(Ae)))continue;const Ot=ne.get(Ae),$s=mt(Ot.card),Rs=mt(et.card);if(JSON.stringify($s)!==JSON.stringify(Rs)){if(Ot.columnId!==et.columnId){const Fs=mt(Ot.card,{ignoreUpdatedAt:!0}),zs=mt(et.card,{ignoreUpdatedAt:!0});if(JSON.stringify(Fs)===JSON.stringify(zs))continue}B.add(Ae)}}}const Z=new Set([...R,...B]);if(Z.size>0){if(m<Xt.current){Ce(r),A.clear();return}if(an(Z),en.current=m,It(m+l),H){const ne=String(H);[...Z].some(Ae=>{const et=gt(r,Ae);return et?!ln(et,ne):!1})&&os(l)}}Ce(r),A.clear()}a.useEffect(()=>{if(!it.size||!en.current||Date.now()<Qt.current)return;let o=requestAnimationFrame(()=>{try{Ys()}catch{}});return()=>cancelAnimationFrame(o)},[it]);const[$t,dn]=a.useState(!1),ls=async()=>{if(!$t){dn(!0);try{const t=new Set(Pt.current),o=ut.current,r=await fetch("/api/import/trigger",{method:"POST",credentials:"include"});if(!r.ok){const m=await r.text().catch(()=>"");throw new Error(`Import fehlgeschlagen (HTTP ${r.status}) ${m}`)}const l=await Me();I(l),cn({oldIds:t,oldBoard:o,newBoard:l,pulseMs:8e3}),ft(0)}catch(t){alert(t.message||"Import fehlgeschlagen.")}finally{dn(!1)}}},[cs,un]=a.useState(!1);async function ds(t,o){if(cs)return;const r=Oe.get(t);if(!r)return;const l=String(r.id||""),m=new Set(j.filter(h=>String(h?.cloneOf||"").trim()===l).map(h=>String(h?.id)));un(!0);try{const h=r.label||r.id,y=await fetch("/api/vehicles",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({ort:r.ort||"",label:h,mannschaft:0,cloneOf:r.id})}),w=await y.json().catch(()=>({}));if(!y.ok||w?.error)throw new Error(w?.error||"Clone fehlgeschlagen");const A=await(await fetch("/api/vehicles",{credentials:"include"})).json();M(A);let R=w?.vehicle?.id;R||(R=A.find(ne=>{if(!ne)return!1;const be=String(ne.id||"");return!be||m.has(be)||String(ne.ort||"")!==String(r.ort||"")?!1:String(ne.cloneOf||"").trim()===l})?.id),o&&R&&(await Ut(o,R),Re(o));const B=await Me();I(B),Ce(B)}catch(h){alert(h.message||"Clone fehlgeschlagen")}finally{un(!1)}}const Oe=a.useMemo(()=>new Map(j.map(t=>[t.id,t])),[j]);async function us(t,o){if(!b||!t)return;const r=String(t.id??"").trim();if(!r)return;const l=o===!0,m=t.available!==!1;if(m===l)return;let h=null;if(!l){const C=typeof t.label=="string"&&t.label.trim()?`Einheit ${t.label.trim()}`:"die Einheit",A=N(C);if(A.cancelled)return;h=A.untilIso}const y=g.current.get(r)||null,w=u.current.get(r);w&&(clearTimeout(w.timeout),u.current.delete(r)),l?g.current.delete(r):h?g.current.set(r,h):g.current.delete(r),M(C=>C.map(A=>String(A?.id??"")===r?{...A,available:l,unavailableUntil:h||null}:A));try{const C=await Cn(r,l,h);if(l){g.current.delete(r),M(B=>B.map(Z=>String(Z?.id??"")===r?{...Z,unavailableUntil:null}:Z));return}const A=C&&typeof C.until=="string"?C.until:null,R=A?Date.parse(A):NaN;if(Number.isFinite(R)&&R>Date.now()){const B=new Date(R).toISOString();g.current.set(r,B),M(Z=>Z.map(ne=>String(ne?.id??"")===r?{...ne,unavailableUntil:B}:ne)),_(r,B)}else g.current.delete(r),M(B=>B.map(Z=>String(Z?.id??"")===r?{...Z,unavailableUntil:null}:Z))}catch(C){console.error(C),y?(g.current.set(r,y),_(r,y)):g.current.delete(r),M(A=>A.map(R=>String(R?.id??"")===r?{...R,available:m,unavailableUntil:y||null}:R)),alert(C?.message||"VerfÃ¼gbarkeit der Einheit konnte nicht gespeichert werden.")}}async function fs(t,o){if(!b)return;const r=String(t??"").trim();if(!r)return;const l=o===!0,m=$.get(r)??!0,h=new Map;for(const A of j)if(String(A?.ort??"")===r){const R=String(A?.id??"");R&&h.set(R,{available:A?.available!==!1,unavailableUntil:typeof A?.unavailableUntil=="string"&&A.unavailableUntil.trim()?A.unavailableUntil:null})}if(m===l)return;let y=null;if(!l){const A=N(`Gruppe ${r}`);if(A.cancelled)return;y=A.untilIso}const w=E.current.get(r)||null,C=T.current.get(r);if(C&&(clearTimeout(C.timeout),T.current.delete(r)),l){E.current.delete(r);for(const[A,R]of h.entries()){const B=R?.unavailableUntil||null;B?g.current.set(A,B):g.current.delete(A)}}else{y?E.current.set(r,y):E.current.delete(r);for(const A of h.keys())y?g.current.set(A,y):g.current.delete(A)}z(A=>{const R=new Map(A);return R.set(r,l),R}),M(A=>A.map(R=>{if(String(R?.ort??"")!==r)return R;const B=String(R?.id??"");if(!B)return R;if(l){const Z=h.get(B),ne=Z?.available??!0,be=Z?.unavailableUntil||null;return{...R,groupAvailable:!0,available:ne,unavailableUntil:be}}return{...R,groupAvailable:!1,available:!1,unavailableUntil:y||null}}));try{const A=await In(r,l,y);if(l){E.current.delete(r);return}const R=A&&typeof A.until=="string"?A.until:null,B=R?Date.parse(R):NaN;if(Number.isFinite(B)&&B>Date.now()){const Z=new Date(B).toISOString();E.current.set(r,Z);for(const ne of h.keys())g.current.set(ne,Z);M(ne=>ne.map(be=>String(be?.ort??"")===r?{...be,unavailableUntil:Z,groupAvailable:!1,available:!1}:be)),U(r,Z)}else E.current.delete(r),M(Z=>Z.map(ne=>String(ne?.ort??"")===r?{...ne,unavailableUntil:null,groupAvailable:!1,available:!1}:ne))}catch(A){console.error(A),w?(E.current.set(r,w),U(r,w)):E.current.delete(r),z(R=>{const B=new Map(R);return B.set(r,m),B}),M(R=>R.map(B=>{if(String(B?.ort??"")!==r)return B;const Z=String(B?.id??"");if(!Z)return B;const ne=h.get(Z),be=ne?.available??!0,Ae=ne?.unavailableUntil||null;return Ae?g.current.set(Z,Ae):g.current.delete(Z),{...B,groupAvailable:m,available:m?be:!1,unavailableUntil:m?Ae:null}})),alert(A?.message||"VerfÃ¼gbarkeit der Gruppe konnte nicht gespeichert werden.")}}const Rt=a.useMemo(()=>{const t=new Set,o=r=>r===!0||typeof r=="string"&&r.trim().toLowerCase()==="clone";for(const r of j){if(!r||typeof r.id>"u")continue;const l=String(r.id);if(!l)continue;if(typeof r.cloneOf=="string"?r.cloneOf.trim():""){t.add(l);continue}(r.isClone===!0||o(r.clone))&&t.add(l)}return t},[j]),fn=t=>Rt.has(String(t)),[mn,hn]=a.useState(new Map),ms=a.useMemo(()=>{const t={};for(const[o,r]of Oe.entries())t[o]=r;return t},[Oe]),ht=a.useMemo(()=>{const t=new Set,o=Pe?.columns||{};for(const r of Object.keys(o))for(const l of o[r].items||[])for(const m of l.assignedVehicles||[])t.add(m);return t},[Pe]),hs=a.useMemo(()=>{const t=new Set;for(const o of ht){const r=Oe.get(o),l=typeof r?.ort=="string"?r.ort:"";l&&t.add(l)}return t},[ht,Oe]),Ye=a.useMemo(()=>j.filter(t=>t&&typeof t.id<"u"&&!ht.has(t.id)&&!Rt.has(String(t.id))),[j,ht,Rt]),Fe=a.useMemo(()=>{const t={};for(const o of Ye){const r=o.ort||"Unbekannt";(t[r]??=[]).push(o)}for(const o of Object.keys(t))t[o].sort((r,l)=>(r.label||r.id).localeCompare(l.label||l.id));return Object.entries(t).sort((o,r)=>o[0].localeCompare(r[0]))},[Ye]),gn=a.useMemo(()=>{if(!Ze)return Fe;const t=[];for(const[o,r]of Fe){const l=r.filter(m=>is(m,rt));l.length>0&&t.push([o,l])}return t},[Fe,Ze,rt]);a.useEffect(()=>{if(localStorage.getItem("ff_collapsed_groups")||!Fe.length)return;const o=Fe.map(([r])=>r);pt(new Set(o)),localStorage.setItem("ff_collapsed_groups",JSON.stringify(o))},[He,Fe]),a.useEffect(()=>{let t=setInterval(async()=>{try{const o=await fetch("/api/activity/status",{cache:"no-store",credentials:"include"}).then(r=>r.json());typeof o?.auto?.enabled=="boolean"&&o.auto.enabled!==X&&ce(!!o.auto.enabled),typeof o?.auto?.demoMode=="boolean"&&o.auto.demoMode!==ve&&Ne(!!o.auto.demoMode)}catch{}},3e3);return()=>clearInterval(t)},[He,X,ve]);function Ft(t,o){for(const r of["neu","in-bearbeitung","erledigt"])if((t.columns[r].items||[]).some(l=>l?.id===o))return r;return null}function gt(t,o){for(const r of["neu","in-bearbeitung","erledigt"]){const l=(t.columns[r].items||[]).find(m=>m?.id===o);if(l)return l}return null}function zt(t,o){const r=t?.columns?.[o]?.items||[];let l=0,m=0,h=0,y=0;for(const w of r)if(w?.isArea?l+=1:m+=1,o==="erledigt"){const C=Array.isArray(w?.everVehicles)?w.everVehicles:[];h+=C.filter(A=>!fn(A)).length,y+=Number.isFinite(w?.everPersonnel)?w.everPersonnel:0}else{const C=Array.isArray(w?.assignedVehicles)?w.assignedVehicles:[];if(h+=C.filter(A=>!fn(A)).length,Number.isFinite(w?.manualPersonnel))y+=w.manualPersonnel;else for(const A of C){const R=Oe.get(A);typeof R?.mannschaft=="number"&&(y+=R.mannschaft)}}return{cards:r.length,areas:l,incidents:m,units:h,persons:y}}const gs=zt(at,"neu"),ps=zt(at,"in-bearbeitung"),bs=zt(at,"erledigt"),Dt=t=>String(t||"").split(/[;,\n]/).map(o=>o.trim()).filter(Boolean),ze=t=>String(t||"").normalize?.("NFD").replace?.(new RegExp("\\p{Diacritic}","gu"),"").replace(/^\s*FF\s+/i,"").replace(/[._\-\/]+/g," ").replace(/\s+/g," ").toLowerCase().trim();function xs(t,o,r,l){const m=Dt(t?.alerted).map(ze);if(m.length)for(const h of o){const y=m.some(C=>ze(h?.ort)===C),w=m.some(C=>ze(h?.label)===C);if(y||w){const C=String(h.id);r.add(C),l.has(C)||l.set(C,null)}}}async function ys(t,o){if(!(o!=="neu"||!t?.id))try{const r=await or(t.id);r?.ok||alert(r?.error||"FÃ¼r diesen Einsatz sind keine Koordinaten hinterlegt.");const l=new Set((r?.units||[]).map(B=>String(B.unitId)));if(t?.alerted){const B=Dt(t.alerted).map(ze);for(const Z of Ye){const ne=B.some(Ae=>ze(Z.ort)===ze(Ae)),be=B.some(Ae=>ze(Z.label)===ze(Ae));(ne||be)&&l.add(String(Z.id))}}Jt(l),It(Date.now()+3e3);const m=new Map;for(const B of r?.units||[]){const Z=Number(B?.distanceKm);m.set(String(B.unitId),Number.isFinite(Z)?Z:null)}l.size===0&&t?.alerted&&xs(t,Ye,l,m),hn(m);const h=new Set((r?.units||[]).filter(B=>!B.assigned).map(B=>String(B.unitId))),y=new Set(Ye.map(B=>String(B.id))),w=new Set([...h,...[...l].filter(B=>y.has(B))]),C=Dt(t?.alerted).map(ze),A=new Set;if(C.length&&Ye.length>0)for(const[B,Z]of Fe){if(Z.length===0)continue;C.some(be=>ze(B)===ze(be))&&A.add(B)}const R=[];for(const[B,Z]of Fe)(Z.some(be=>w.has(String(be.id)))||A.has(B))&&R.push(B);Ss(R),clearTimeout(st.current),st.current=setTimeout(()=>{Jt(new Set),It(0),hn(new Map)},3200)}catch(r){console.error("fetchNearby failed:",r)}}const[pn,pt]=a.useState(()=>{try{const t=localStorage.getItem("ff_collapsed_groups");return new Set(t?JSON.parse(t):[])}catch{return new Set}}),ws=t=>pn.has(t),vs=(t,o)=>{pt(r=>{const l=new Set(r);return o?l.add(t):l.delete(t),localStorage.setItem("ff_collapsed_groups",JSON.stringify([...l])),l})},Ss=(t=[])=>{pt(()=>{const o=Fe.map(([l])=>l),r=new Set(o);for(const l of t)r.delete(l);return localStorage.setItem("ff_collapsed_groups",JSON.stringify([...r])),r})},Ns=(t=!0)=>{pt(()=>{const o=Fe.map(([l])=>l),r=t?new Set(o):new Set;return localStorage.setItem("ff_collapsed_groups",JSON.stringify([...r])),r})},js=()=>{const t=Fe.map(([r])=>r),o=t.length>0&&t.every(r=>pn.has(r));Ns(!o)},[bt,_t]=a.useState(null),[As,Xe]=a.useState(null),ot=a.useRef(null),ks=Xs(Sn(fr,{activationConstraint:{distance:6}}),Sn(ur,{activationConstraint:{delay:120,tolerance:6}})),Cs=t=>{const o=t?.over;if(!o){Xe(null);return}const r=String(o.id||"");if(ot.current=r,r.startsWith("col:"))Xe(r.slice(4));else if(r.startsWith("card:")){const l=Ft(Pe,r.slice(5));Xe(l)}else Xe(null)},Bt=()=>window.confirm("Sind sie sicher?"),Is=async t=>{if(f){Xe(null),_t(null),ot.current=null;return}Xe(null);const{active:o,over:r}=t;_t(null);const l=r||(ot.current?{id:ot.current}:null);if(ot.current=null,!o||!l)return;const m=String(o.id||""),h=String(l.id||"");if(m.startsWith("ass:")&&h.startsWith("card:")){const[,y,w]=m.split(":"),C=h.slice(5);if(y&&w&&C&&y!==C)try{await An(y,w);try{await kn(w)}catch{}await Ut(C,w),Re(y,C);const A=await Me();I(A),Ce(A)}catch{alert("Einheit konnte nicht umgehÃ¤ngt werden.")}return}if(m.startsWith("veh:")&&h.startsWith("card:")){try{await Ut(h.slice(5),m.slice(4)),Re(h.slice(5));const y=await Me();I(y),Ce(y)}catch{alert("Einheit konnte nicht zugewiesen werden.")}return}if(m.startsWith("card:")){const y=m.slice(5),w=Ft(Pe,y);if(!w)return;if(h.startsWith("col:")){const C=h.slice(4);if(w!==C){if(C==="erledigt"&&w!=="erledigt"&&!Bt())return;try{if(await yt({cardId:y,from:w,to:C,toIndex:0}),Re(y),C==="erledigt"){const[A,R]=await Promise.all([Me(),Ke()]);I(A),M(R),Ce(A)}else{const A=await Me();I(A),Ce(A)}}catch{alert("Statuswechsel konnte nicht gespeichert werden.")}}return}if(h.startsWith("card:")){const C=Ft(Pe,h.slice(5));if(C&&w!==C){if(C==="erledigt"&&w!=="erledigt"&&!Bt())return;try{if(await yt({cardId:y,from:w,to:C,toIndex:0}),Re(y),C==="erledigt"){const[A,R]=await Promise.all([Me(),Ke()]);I(A),M(R),Ce(A)}else{const A=await Me();I(A),Ce(A)}}catch{alert("Statuswechsel konnte nicht gespeichert werden.")}}}}},Es=async()=>{if(confirm("Board wirklich zurÃ¼cksetzen?")){Y(!0);try{await lr();const t=await Me();I(t),Ce(t)}catch{alert("Reset fehlgeschlagen.")}finally{Y(!1)}}},Ms=()=>window.open(cr(),"_blank","noopener,noreferrer"),Ps=async({title:t,ort:o,typ:r,isArea:l=!1,areaCardId:m=null,areaColor:h,coordinates:y=null,location:w="",description:C=""})=>{const A=l?null:m?String(m):null,R={isArea:!!l,areaCardId:A};l&&(R.areaColor=h||Xr),y&&Number.isFinite(y?.lat)&&Number.isFinite(y?.lng)&&(R.lat=Number(y.lat),R.lng=Number(y.lng));const B=typeof w=="string"?w.trim():"";B&&(R.location=B);const Z=typeof C=="string"?C.trim():"";Z&&(R.description=Z);const ne=await dr(t,"neu",0,o,r,R);Qt.current=Date.now(),ne?.card?.id!=null&&Re(ne.card.id),I(be=>{if(!be)return be;const Ae=structuredClone(be);return Ae.columns.neu.items.unshift(ne.card),Ce(Ae),Ae})},Ts=async(t,o)=>{if(!t?.id)return;const r=o?String(o):null;try{const l=await Wt(t.id,{areaCardId:r});rn(l?.card,l?.board)}catch(l){alert(l?.message||"Abschnitt konnte nicht geÃ¤ndert werden.")}},Ls=async(t,o)=>{try{const r=await Wt(t,o);return rn(r?.card,r?.board),r}catch(r){throw r}};if(dt.startsWith("/protokoll/edit/")){const t=dt.split("/")[3],o=Number(t);return e.jsxs("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden flex flex-col min-h-0 floating-actions-safe-area",children:[e.jsx(xt,{helpHref:"/Hilfe_Meldestelle.pdf",helpTitle:"Hilfe â€“ Meldestelle/Protokoll",onAdd:()=>{window.location.hash="/protokoll/neu"},addTitle:"Neuen Eintrag anlegen",navButtons:St("meldestelle")}),e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Meldung â€“ Bearbeiten"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"Zur Ãœbersicht"})]}),e.jsx("div",{className:"flex-1 min-h-0 overflow-hidden p-3",children:e.jsx(Nn,{mode:"edit",editNr:o})})]})}return dt.startsWith("/protokoll/neu")?e.jsxs("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden flex flex-col min-h-0 floating-actions-safe-area",children:[e.jsx(xt,{helpHref:"/Hilfe_Meldestelle.pdf",helpTitle:"Hilfe â€“ Meldestelle/Protokoll",onAdd:()=>{window.location.hash="/protokoll/neu"},addTitle:"Neuen Eintrag anlegen",navButtons:St("meldestelle")}),e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Meldung â€“ Eintrag anlegen"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"Zur Ãœbersicht"})]}),e.jsx("div",{className:"flex-1 min-h-0 overflow-hidden p-3",children:e.jsx(Nn,{mode:"create"})})]}):dt.startsWith("/protokoll")?e.jsxs("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden flex flex-col min-h-0 floating-actions-safe-area",children:[e.jsx(xt,{helpHref:"/Hilfe_Meldestelle.pdf",helpTitle:"Hilfe â€“ Meldestelle/Protokoll",onAdd:()=>{window.location.hash="/protokoll/neu"},addTitle:"Neuen Eintrag anlegen",navButtons:St("meldestelle")}),e.jsxs("header",{className:"flex flex-wrap items-center justify-between gap-3 p-3 border-b bg-white shadow",children:[e.jsxs("h1",{className:"text-xl font-bold flex items-center gap-2",children:[s&&e.jsx(jn,{className:"h-5 w-5"}),e.jsx("span",{children:"MeldungsÃ¼bersicht"})]}),e.jsxs("div",{className:"flex flex-1 flex-wrap items-center justify-end gap-2 min-w-0",children:[e.jsx("input",{id:"protocolSearch",type:"search",className:"w-full sm:w-64 md:w-72 lg:w-80 max-w-full px-3 py-2 text-sm rounded-xl border",placeholder:"Sucheâ€¦",value:le,onChange:t=>K(t.target.value),"aria-label":"Suche Meldungen"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("a",{href:"/api/protocol/csv/file",className:"px-3 py-1.5 rounded-md border bg-white",title:"protocol.csv herunterladen",children:"CSV"}),e.jsx("button",{onClick:()=>{!q||ae||(window.location.hash="/protokoll/neu")},disabled:!q||ae,className:`px-3 py-1.5 rounded-md text-white ${!q||ae?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-emerald-600 hover:bg-emerald-700"}`,title:q?ae?"S3 darf nur anlegen, wenn LtStb nicht angemeldet ist":void 0:"Keine Berechtigung (Meldestelle)",children:"+ Eintrag anlegen"})]})]})]}),e.jsx("div",{className:"flex-1 min-h-0 overflow-hidden p-3",children:e.jsx(Fr,{searchTerm:le})})]}):e.jsxs("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden flex flex-col min-h-0 floating-actions-safe-area",style:{fontSize:"var(--ui-scale)"},children:[e.jsx(xt,{helpHref:"/Hilfe.pdf",onAdd:d?()=>$e(!0):void 0,addTitle:"Einsatz anlegen",navButtons:St("einsatz")}),!v&&e.jsx("div",{className:"fixed inset-0 z-10 bg-black/10 backdrop-blur-sm flex items-center justify-center",children:e.jsx("div",{className:"px-4 py-2 rounded-lg bg-white shadow",children:"Ladeâ€¦"})}),e.jsxs("header",{className:"einsatz-header",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[e.jsxs("h1",{className:"text-xl font-extrabold tracking-tight text-slate-900 flex items-center gap-2",children:[s&&e.jsx(jn,{className:"h-5 w-5"}),e.jsx("span",{children:"Einsatzstellen-Uebersicht"})]}),e.jsx("div",{title:`Quelle: ${Te.file||"list_filtered.json"}`,className:"sync-chip",children:e.jsxs("span",{children:["Zuletzt geladen: ",e.jsx("b",{children:Te.lastLoadedIso?new Date(Te.lastLoadedIso).toLocaleTimeString("de-AT",{hour12:!1}):"â€“"})]})})]}),Et&&e.jsx("div",{className:"flex-1 min-w-[200px] min-h-[2.5rem] max-w-full sm:min-w-[260px]",children:e.jsx("div",{className:"ticker-container w-full h-full flex items-center","aria-live":"polite",children:e.jsx("marquee",{className:"ticker-content",behavior:"scroll",direction:"left",scrollAmount:6,onMouseEnter:t=>{typeof t.target.stop=="function"&&t.target.stop()},onMouseLeave:t=>{typeof t.target.start=="function"&&t.target.start()},children:e.jsx("span",{children:Et})},Et)})}),e.jsxs("div",{className:"toolbar flex flex-wrap items-center gap-2.5 justify-end w-full md:w-auto",children:[e.jsxs("div",{className:`filter-group ${H?"filter-group-active":""}`,children:[e.jsx("span",{className:"filter-group-label",children:"Abschnitt"}),e.jsxs("select",{id:"areaFilter",value:H,onChange:t=>J(t.target.value),children:[e.jsx("option",{value:"",children:"Alle anzeigen"}),Ue.map(t=>e.jsx("option",{value:String(t.id),children:t.label},t.id))]})]}),e.jsx("input",{id:"boardSearch",type:"search",className:"search-input w-full sm:w-48 md:w-56 lg:w-64 max-w-full",placeholder:"Suche...",value:Q,onChange:t=>fe(t.target.value),"aria-label":"Suche Einsaetze"}),e.jsx("button",{onClick:Ms,className:"header-btn",children:"PDF"}),e.jsx("button",{onClick:()=>window.open("/api/log.csv","_blank"),className:"header-btn",title:"log.csv herunterladen",children:"Log (CSV)"}),e.jsx("button",{onClick:ls,disabled:f||$t,className:"header-btn",title:"Import sofort ausfuehren",children:$t?"Import...":"Import"}),e.jsx(Or,{autoEnabled:X,remaining:ts,disabled:f,showTimer:!1,showLastLoaded:!1,onImportInfo:Ie}),ve&&e.jsx("button",{onClick:Es,disabled:f||we,className:"header-btn",style:we?{opacity:.5}:{},children:we?"Reset...":"Reset"})]})]}),e.jsxs(er,{sensors:ks,collisionDetection:t=>t?.active?.data?.current?.type==="vehicle"?tr(t):nr(t),onDragStart:t=>_t({type:t?.active?.data?.current?.type,id:t.active.id,data:t?.active?.data?.current}),onDragOver:Cs,onDragEnd:Is,children:[e.jsxs("main",{className:"einsatz-main grid grid-cols-1 md:[grid-template-columns:minmax(180px,220px)_repeat(3,minmax(0,1fr))] gap-2 min-h-0 flex-1 overflow-hidden pr-[var(--fab-safe-margin)]",children:[e.jsx("div",{className:"flex flex-col gap-2 h-full min-h-0",children:e.jsxs("section",{className:"bg-white rounded-xl shadow p-3 flex-1 flex flex-col min-h-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-semibold",children:e.jsx("button",{type:"button",onClick:js,title:"Alle Gruppen auf/zu klappen",className:"underline decoration-dotted hover:opacity-80 focus:outline-none",children:"Einheiten (frei)"})}),b&&e.jsx("button",{onClick:()=>ue(!0),className:"px-2 py-1 text-sm rounded bg-emerald-600 text-white",children:"+ Einheit"})]}),e.jsxs("div",{className:"overflow-auto pr-1 flex-1 min-h-0 space-y-3",children:[gn.length===0&&e.jsx("div",{className:"text-[0.85rem] text-gray-500 italic",children:Ze?"Keine Einheiten gefunden.":"â€” alle Einheiten sind zugewiesen â€”"}),gn.map(([t,o])=>{const r=ws(t),l=$.has(t)?$.get(t):!0,m=S.get(t)===!0,h=hs.has(t),y=sa({available:l,alerted:m,assigned:h});return e.jsxs("div",{className:`border rounded-md ${y.container}`,children:[e.jsxs("div",{className:"flex items-center justify-between px-2 py-2 gap-2",children:[e.jsx("button",{type:"button",onClick:()=>vs(t,!r),className:"flex-1 flex items-center justify-between gap-2 text-left",title:r?"aufklappen":"zuklappen",children:e.jsx("span",{className:`text-xs font-semibold ${y.label}`,children:t})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("label",{className:"flex items-center gap-1 text-[11px] text-gray-600",title:l?"Gruppe verfÃ¼gbar":"Gruppe deaktiviert",children:[e.jsx("span",{className:"sr-only",children:"Gruppe verfÃ¼gbar"}),e.jsx("input",{type:"checkbox",checked:l,onChange:w=>fs(t,w.target.checked),disabled:!b})]}),e.jsx("span",{className:"group-chip",children:o.length})]})]}),!r&&e.jsx("div",{className:"px-2 pb-2 grid grid-cols-1 gap-1.5",children:o.map(w=>{const C=w?.available!==!1,A=$.has(w?.ort||"")?$.get(w?.ort||""):w?.groupAvailable!==!1,R=C&&A,B=A===(w?.groupAvailable!==!1)&&R===C?w:{...w,available:R,groupAvailable:A};return e.jsxs("div",{className:"flex items-center gap-2 justify-between",children:[e.jsx(hr,{editable:d&&R,vehicle:B,pillWidthPx:160,near:Zt.has(String(w.id))&&Date.now()<Ct,distKm:mn.get(String(w.id))}),e.jsxs("label",{className:"flex items-center gap-1 text-[11px] text-gray-600 shrink-0",title:R?"Einheit verfÃ¼gbar":"Einheit deaktiviert",children:[e.jsx("span",{className:"sr-only",children:"Einheit verfÃ¼gbar"}),e.jsx("input",{type:"checkbox",checked:R,onChange:Z=>us(w,Z.target.checked),disabled:!b||!A})]})]},w.id)})})]},t)})]})]})}),[{id:"neu",title:"Neu",bg:"bg-red-100",totals:gs},{id:"in-bearbeitung",title:"In Bearbeitung",bg:"bg-yellow-100",totals:ps},{id:"erledigt",title:"Erledigt",bg:"bg-green-100",totals:bs}].map(({id:t,title:o,bg:r,totals:l})=>{const m=sn?`${o}: ${sn}`:o;return e.jsx("div",{className:As===t?"drag-over":"",children:e.jsx(jr,{editable:d,colId:t,bg:r,title:e.jsxs("span",{className:"column-header flex flex-wrap items-center justify-between gap-2",children:[e.jsx("span",{className:"font-semibold break-words min-w-0",children:m}),e.jsxs("span",{className:"flex flex-wrap items-center gap-1.5 justify-end w-full sm:w-auto",children:[e.jsxs("span",{className:"kpi-badge","data-variant":"incidents",children:["â¬› ",l.incidents]}),e.jsxs("span",{className:"kpi-badge","data-variant":"areas",children:["ðŸ—ºï¸ ",l.areas]}),e.jsxs("span",{className:"kpi-badge","data-variant":"units",children:["ðŸš’ ",l.units]}),e.jsxs("span",{className:"kpi-badge","data-variant":"persons",children:["ðŸ‘¥ ",l.persons]})]})]}),children:e.jsx("ul",{className:"space-y-2 overflow-y-auto overflow-x-hidden pl-1 pr-2 py-2",style:{maxHeight:"calc(100vh - 260px)"},children:e.jsx(sr,{items:(at.columns[t].items||[]).map(h=>Yr(h.id)),strategy:rr,children:(at.columns[t].items||[]).map(h=>e.jsx(mr,{editable:d,card:h,colId:t,vehiclesById:Oe,areaOptions:Ue,areaLabelById:Qe,areaColorById:Mt,onAreaChange:d?Ts:void 0,onEditCard:d?y=>{te(y),ge(!0),Ge(!0)}:void 0,distById:mn,pillWidthPx:160,pulse:it.has(String(h.id))&&Date.now()<Ct,onUnassign:async(y,w)=>{await An(y,w);try{await kn(w)}catch{}const[C,A]=await Promise.all([Me(),Ke()]);Re(y),I(C),M(A),Ce(C)},onOpenMap:y=>ie({address:h.ort,card:h,board:Pe,vehiclesById:ms}),onAdvance:d?async y=>{if(t==="neu"){await yt({cardId:y.id,from:"neu",to:"in-bearbeitung",toIndex:0}),Re(y.id);const w=await Me();I(w),Ce(w)}else if(t==="in-bearbeitung"){if(!Bt())return;await yt({cardId:y.id,from:"in-bearbeitung",to:"erledigt",toIndex:0});const[w,C]=await Promise.all([Me(),Ke()]);Re(y.id),I(w),M(C),Ce(w)}}:void 0,onEditPersonnelStart:d?(y,w)=>{ye({cardId:y.id}),oe(w)}:void 0,editing:de,editingValue:pe,setEditingValue:oe,onEditPersonnelSave:d?async y=>{try{await ar(y.id,pe===""?null:Number(pe)),Re(y.id);const w=await Me();I(w),Ce(w)}finally{ye(null),oe("")}}:void 0,onEditPersonnelCancel:d?()=>{ye(null),oe("")}:void 0,onClone:ds,onVehiclesIconClick:ys,nearIds:Zt,nearUntilMs:Ct,onShowInfo:We},h.id))})})})},t)})]}),e.jsxs(ir,{dropAnimation:{duration:180,easing:"ease-out"},children:[bt?.type==="vehicle"&&(()=>{const t=Oe.get(bt?.data?.vehicleId);return t?e.jsx("div",{className:"pointer-events-none",children:e.jsxs("div",{style:{width:160},className:"max-w-full select-none border-2 border-red-300 rounded-2xl bg-white px-2 py-1 shadow-lg",children:[e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:t.label||t.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate",children:[t.ort||"â€”"," Â· ðŸ‘¥ ",t.mannschaft??0]})]})}):null})(),bt?.type==="card"&&(()=>{const t=String(bt?.id||"").replace(/^card:/,""),o=gt(Pe,t);return o?e.jsx("div",{className:"pointer-events-none w-[280px]",children:e.jsxs("div",{className:"rounded-lg bg-white shadow-xl border p-3",children:[e.jsx("div",{className:"font-semibold text-sm mb-1 truncate",children:o.content}),e.jsxs("div",{className:"text-xs text-gray-600",children:[o.assignedVehicles?.length||0," Einheiten â€¢"," ","ðŸ‘¥ ",Number.isFinite(o?.manualPersonnel)?o.manualPersonnel:(o.assignedVehicles||[]).reduce((r,l)=>r+(Oe.get(l)?.mannschaft??0),0)]})]})}):null})()]})]}),je&&e.jsx(yr,{onClose:()=>ue(!1),onCreate:async t=>{const o=await fetch("/api/vehicles",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(t)});if(!o.ok){const r=await o.text().catch(()=>String(o.status));throw new Error(`HTTP ${o.status} ${r}`)}M(await Ke())}}),Le&&e.jsx(Nr,{onClose:()=>$e(!1),onCreate:Ps,types:D,areaOptions:Ue}),W&&e.jsx(xr,{context:W,onClose:()=>ie(null)}),e.jsx(Ir,{open:Ee,info:p||{},onClose:()=>{Ge(!1),te(null),ge(!1)},canEdit:d,onSave:Ls,areaOptions:Ue,areaLabelById:Qe,forceEdit:ke,types:D})]})}export{oa as default};
