import{u as Pt,j as e,r,a as hn,C as gn,b as pn,i as Qe,c as Ye,d as fn,e as xn,f as dt,D as bn,g as yn,h as wn,S as vn,v as Nn,k as jn,T as Sn,P as kn}from"./index-DPBwQrNE.js";function ut({cardId:s,vehicle:a,pillWidthPx:o=160,onUnassign:c,onClone:h,near:g=!1,distKm:m=null,readonly:p=!1}){const I=`ass:${s}:${a.id}`,j=p?null:Pt({id:I,data:{type:"assigned",vehicleId:a.id,fromCardId:s}}),_=j?.attributes??{},C=j?.listeners??{},$=j?.setNodeRef??(()=>{}),D=j?.transform??null,z=j?.isDragging??!1,U={width:o,transform:D?`translate3d(${D.x}px, ${D.y}px, 0)`:void 0};return e.jsxs("div",{ref:$,style:U,..._,...C,className:`relative self-start border-2 rounded-2xl bg-white px-2 pr-9 py-1 shadow-sm
                  select-none cursor-grab active:cursor-grabbing
                  ${g?"border-emerald-500 ring-2 ring-emerald-300":"border-red-300"}
                  ${z?"opacity-50":""}`,title:"Ziehen: auf andere Karte verschieben · Doppelklick: klonen",onDoubleClick:()=>{p||h?.(a.id,s)},children:[g&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-0.5 rounded-2xl border-2 border-emerald-400/50 animate-ping"}),e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:a.label||a.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate flex justify-between items-center",children:[e.jsxs("span",{children:[a.ort||"—"," · 👥 ",a.mannschaft??0]}),g&&Number.isFinite(Number(m))&&e.jsxs("span",{className:"absolute top-1 right-8 text-[11px] tabular-nums text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded whitespace-nowrap",children:[Number(m)," Km"]})]}),!p&&e.jsx("button",{type:"button",onMouseDown:q=>q.stopPropagation(),onTouchStart:q=>q.stopPropagation(),onClick:q=>{q.stopPropagation(),c?.(s,a.id)},title:"Einheit entfernen",className:"absolute right-2 top-1/2 -translate-y-1/2 h-6 w-6 rounded-full bg-red-600 text-white shadow flex items-center justify-center","aria-label":"Einheit entfernen",children:e.jsx("svg",{viewBox:"0 0 12 12",width:"12",height:"12","aria-hidden":"true",children:e.jsx("path",{d:"M1 1 L11 11 M11 1 L1 11",stroke:"white",strokeWidth:"2",strokeLinecap:"round"})})})]})}function In(s){const{card:a,colId:o,vehiclesById:c,pillWidthPx:h=160,onUnassign:g,onOpenMap:m,onAdvance:p,onEditPersonnelStart:I,editing:j,editingValue:_,setEditingValue:C,onEditPersonnelSave:$,onEditPersonnelCancel:D,onClone:z,onVehiclesIconClick:U,onShowInfo:q,nearIds:V,nearUntilMs:X,distById:k,pulse:E,editable:G=!0}=s,[A,H]=r.useState(o==="in-bearbeitung"),ee=r.useRef((a.assignedVehicles||[]).length),Z=r.useRef(null),ae=Date.now()<(X||0),y=G?hn({id:`card:${a.id}`,data:{type:"card",cardId:a.id}}):{attributes:{},listeners:{},setNodeRef:w=>{},transform:null,transition:null,isDragging:!1},{attributes:ue,listeners:O,setNodeRef:ie,transform:ge,transition:be,isDragging:x}=y,F={transform:gn.Transform.toString(ge),transition:be,opacity:x?.8:1},te=o==="erledigt"?a.everVehicles?.length||0:a.assignedVehicles?.length||0,W=r.useMemo(()=>(a.assignedVehicles||[]).map(w=>c.get(w)).filter(Boolean),[a,c]),B=r.useMemo(()=>o==="erledigt"?Number.isFinite(a?.everPersonnel)?a.everPersonnel:0:Number.isFinite(a?.manualPersonnel)?a.manualPersonnel:W.reduce((w,P)=>w+(P?.mannschaft??0),0),[o,a,W]);r.useEffect(()=>{if(o!=="in-bearbeitung"||!ae)return;(a.assignedVehicles||[]).some(P=>V?.has(String(P)))&&H(!0)},[o,ae,V,a.assignedVehicles]),r.useEffect(()=>{if(o!=="in-bearbeitung")return;const w=(a.assignedVehicles||[]).length,P=ee.current;w>P&&H(!0),ee.current=w},[o,a.assignedVehicles]),r.useEffect(()=>{if(o==="in-bearbeitung"&&A&&Z.current)try{Z.current.scrollIntoView({behavior:"smooth",block:"nearest"})}catch{}},[o,A]);const Q=()=>{o==="neu"?typeof U=="function"&&U(a,o):(o==="in-bearbeitung"||o==="erledigt")&&H(w=>!w)},Y=()=>{G&&typeof I=="function"&&I(a,B)};return e.jsxs("li",{ref:ie,style:F,className:`relative rounded-lg bg-white shadow border transition mx-1
              ${E&&o==="neu"?"ring-2 ring-red-400/60":""}`,children:[E&&o==="neu"&&e.jsxs(e.Fragment,{children:[e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 rounded-lg bg-red-500/10 animate-pulse-inner"}),e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 rounded-lg animate-ping-safe"})]}),e.jsxs("div",{className:"p-3 select-none",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",...ue,...O,children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-semibold text-sm leading-5 truncate",children:a.content}),!!a.ort&&e.jsx("button",{type:"button",onClick:()=>m?.(a.ort),className:"text-[12px] text-blue-700 hover:underline truncate",title:"Ort in Karte öffnen",children:a.ort})]}),e.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[e.jsxs("button",{type:"button",title:o==="neu"?"Nahe Einheiten prüfen":"Einheiten auf-/zuklappen",className:"px-2 py-1 rounded text-[12px] border hover:bg-red-50 flex items-center gap-1",onPointerDown:w=>w.stopPropagation(),onClick:w=>{w.stopPropagation(),w.preventDefault(),Q()},children:["🚒 ",te,(o==="in-bearbeitung"||o==="erledigt")&&e.jsx("span",{children:A?"▾":"▸"})]}),e.jsxs("button",{type:"button",className:"px-2 py-1 rounded text-[12px] border bg-white hover:bg-gray-50",title:"Personalzahl bearbeiten",onPointerDown:w=>w.stopPropagation(),onClick:w=>{w.stopPropagation(),Y()},children:["👥 ",B]}),G&&p&&e.jsx("button",{type:"button",onPointerDown:w=>w.stopPropagation(),onClick:w=>{w.stopPropagation(),p(a)},className:"ml-1 px-2 py-1 rounded text-[12px] border bg-white hover:bg-gray-50",title:"weiter",children:"➔"})]})]}),o==="neu"&&!!W.length&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-1.5",children:W.map(w=>e.jsx(ut,{cardId:a.id,vehicle:w,pillWidthPx:h,onUnassign:g,onClone:z,near:!!V&&ae&&V.has(String(w.id)),readonly:!G,distKm:k?.get(String(w.id))??null},`ass-${a.id}-${w.id}`))}),o==="in-bearbeitung"&&A&&!!W.length&&e.jsx("div",{ref:Z,className:"mt-2 flex flex-wrap gap-1.5",children:W.map(w=>e.jsx(ut,{cardId:a.id,vehicle:w,pillWidthPx:h,onUnassign:g,onClone:z,near:!!V&&ae&&V.has(String(w.id)),readonly:!G,distKm:k?.get(String(w.id))??null},`ass-${a.id}-${w.id}`))}),o==="erledigt"&&A&&!!a.everVehicles?.length&&e.jsx("ul",{className:"mt-2 text-sm text-gray-700 list-disc list-inside space-y-1",children:a.everVehicles.map(w=>{const P=c.get(w),v=P?.label||P?.id||"Unbekannt",n=P?.ort?` (${P.ort})`:"";return e.jsxs("li",{children:[v,n]},w)})}),G&&j?.cardId===a.id&&e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("input",{type:"number",className:"w-20 border rounded px-2 py-1 text-sm",value:_,onChange:w=>C(w.target.value),placeholder:"Personen"}),e.jsx("button",{className:"px-2 py-1 text-sm rounded bg-emerald-600 text-white",onClick:()=>$(a),children:"Speichern"}),e.jsx("button",{className:"px-2 py-1 text-sm rounded bg-gray-200",onClick:D,children:"Abbrechen"})]}),e.jsxs("div",{className:"mt-2 flex justify-end gap-2",children:[e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Ort in Karte öffnen",onPointerDown:w=>w.stopPropagation(),onClick:w=>{w.stopPropagation(),m?.(a.ort)},children:"Karte"}),e.jsx("button",{type:"button",className:"text-[12px] text-blue-700 hover:underline",title:"Einsatz-Info",onPointerDown:w=>w.stopPropagation(),onClick:w=>{w.stopPropagation(),q?.(a)},children:"?"})]})]})]})}function Cn({vehicle:s,pillWidthPx:a=160,near:o=!1,distKm:c=null,editable:h=!0}){const g=`veh:${s.id}`,m=h?Pt({id:g,data:{type:"vehicle",vehicleId:s.id}}):null,p=m?.attributes??{},I=m?.listeners??{},j=m?.setNodeRef??(()=>{}),_=m?.transform??null,C=m?.isDragging??!1;return e.jsxs("div",{ref:j,style:{width:a,transform:_?`translate3d(${_.x}px, ${_.y}px, 0)`:void 0},...p,...I,className:`relative max-w-full select-none border-2 ${o?"border-emerald-500":"border-red-300"} rounded-2xl bg-white
                 px-2 py-1 shadow-sm cursor-grab active:cursor-grabbing
                 ${C?"opacity-50":""}`,children:[o&&e.jsx("span",{"aria-hidden":!0,className:"pointer-events-none absolute -inset-0.5 rounded-2xl border-2 border-emerald-400/50 animate-ping"}),e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:s.label||s.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate flex justify-between items-center",children:[e.jsxs("span",{children:[s.ort||"—"," · 👥 ",s.mannschaft??0]}),o&&Number.isFinite(Number(c))&&e.jsxs("span",{className:"absolute top-1 right-1 text-[11px] tabular-nums text-gray-800 bg-gray-100 px-1.5 py-0.5 rounded whitespace-nowrap",children:[Number(c)," Km"]})]})]})}const En="";async function le(s,a,o){const c=await fetch(En+a,{method:s,headers:{"Content-Type":"application/json"},body:o===void 0?void 0:JSON.stringify(o),cache:"no-store",credentials:"include"});if(!c.ok)throw new Error(`HTTP ${c.status} ${await c.text().catch(()=>c.statusText)}`);return(c.headers.get("content-type")||"").includes("application/json")?c.json():c.text()}async function oe(){return le("GET","/api/board")}async function mt(){return le("GET","/api/vehicles")}async function Pn(){try{return await le("GET","/api/types")}catch{return[]}}async function ht(s,a="neu",o=0,c="",h="",g={}){const m={title:s,columnId:a,toIndex:o,ort:c,typ:h};if(g&&typeof g=="object"){const{lat:p,lng:I,latitude:j,longitude:_,...C}=g;Number.isFinite(j)&&(m.latitude=Number(j)),Number.isFinite(_)&&(m.longitude=Number(_)),Number.isFinite(p)&&(m.latitude=Number(p)),Number.isFinite(I)&&(m.longitude=Number(I)),Object.assign(m,C)}return le("POST","/api/cards",m)}async function Re({cardId:s,from:a,to:o,toIndex:c=0}){return le("POST",`/api/cards/${encodeURIComponent(s)}/move`,{from:a,to:o,toIndex:c})}async function We(s,a){return le("POST",`/api/cards/${encodeURIComponent(s)}/assign`,{vehicleId:a})}async function gt(s,a){return le("POST",`/api/cards/${encodeURIComponent(s)}/unassign`,{vehicleId:a})}async function An(s,a){return le("PATCH",`/api/cards/${encodeURIComponent(s)}/personnel`,{manualPersonnel:a})}async function Tn(){return le("POST","/api/reset",{})}async function Mn(){return le("GET","/api/import/auto-config")}async function pt({enabled:s,intervalSec:a}){return le("POST","/api/import/auto-config",{enabled:s,intervalSec:a})}function $n(){return"/api/export/pdf"}async function Dn(s,a){const o=`cardId=${encodeURIComponent(s)}`,h=Number.isFinite(Number(a))&&Number(a)>0?`${o}&radiusKm=${encodeURIComponent(a)}`:o,g=await fetch(`/api/nearby?${h}`,{credentials:"same-origin",cache:"no-store"});if(!g.ok)throw new Error("fetchNearby failed");return g.json()}async function ft(s,a,o,c=null,h="manual"){return le("PATCH",`/api/vehicles/${encodeURIComponent(s)}/position`,{lat:Number(a),lng:Number(o),incidentId:c,source:h})}async function xt(s){return le("DELETE",`/api/vehicles/${encodeURIComponent(s)}/position`)}function On(s,a){const c=(a.lat-s.lat)*Math.PI/180,h=(a.lng-s.lng)*Math.PI/180,g=Math.sin(c/2)**2+Math.cos(s.lat*Math.PI/180)*Math.cos(a.lat*Math.PI/180)*Math.sin(h/2)**2;return 2*6371*Math.asin(Math.sqrt(g))}function bt(s,a,o){const h=o*Math.PI/180,g=s.lat*Math.PI/180,m=s.lng*Math.PI/180,p=a/6371e3,I=Math.asin(Math.sin(g)*Math.cos(p)+Math.cos(g)*Math.sin(p)*Math.cos(h))*180/Math.PI,j=(m+Math.atan2(Math.sin(h)*Math.sin(p)*Math.cos(g),Math.cos(p)-Math.sin(g)*Math.sin(I*Math.PI/180)))*180/Math.PI;return{lat:I,lng:j}}async function yt(s){if(!s||!window.google?.maps?.Geocoder)return null;const a=new window.google.maps.Geocoder;return new Promise(o=>{a.geocode({address:s,region:"AT"},(c,h)=>{h==="OK"&&c?.[0]?.geometry?.location?o({lat:c[0].geometry.location.lat(),lng:c[0].geometry.location.lng(),formatted:c[0].formatted_address||s}):o(null)})})}const Ee=s=>String(s||"").trim().toLowerCase();async function wt(){try{const s=await fetch("/api/vehicles",{cache:"no-store"});return s.ok?s.json():[]}catch{return[]}}async function vt(){try{const s=await fetch("/api/gps",{cache:"no-store"});if(s.ok)return await s.json()}catch(s){console.error("GPS fetch failed:",s)}return[]}function Nt(s){const a=s?.typ||s?.type||"—",o=s?.timestamp?new Date(s.timestamp).toLocaleString("de-AT",{hour12:!1}):"—",c=s?.alerted??"—",h=s?.description??"—",g=s?.additionalAddressInfo||s?.ort||"—",m=[];s?.location&&m.push(String(s.location));const p=Number.isFinite(s?.latitude),I=Number.isFinite(s?.longitude);p&&I&&m.push(`(${s.latitude}, ${s.longitude})`);const j=m.length?m.join(" "):"—";return`
    <div style="min-width:280px">
      <div style="font-weight:700;margin-bottom:4px">${s?.content||"Einsatz"}</div>
      <div><b>Typ:</b> ${a}</div>
      <div><b>Alarmzeit:</b> ${o}</div>
      <div><b>Alarmiert:</b> ${c}</div>
      <div><b>Beschreibung:</b> ${h}</div>
      <div><b>Adresse:</b> ${g}</div>
      <div><b>Location:</b> ${j}</div>
    </div>
  `}const xe=44,jt="/vehicle-red.gif",Rn="/vehicle-gray.png",Ln="/vehicle-drive.gif";function _n({context:s,address:a,onClose:o}){const c=a||s?.card?.ort||s?.address||"",h=!!window.google?.maps,g=r.useRef(null),[m,p]=r.useState(!1),[I,j]=r.useState(""),_=r.useMemo(()=>{const C=s?.card;return C&&Number.isFinite(C?.latitude)&&Number.isFinite(C?.longitude)?{lat:Number(C.latitude),lng:Number(C.longitude)}:null},[s]);if(r.useEffect(()=>{if(!h||!s?.card||!g.current)return;let C=!1,$,D;const z=new Map;let U=null;return(async()=>{try{p(!0),j("");let V=_;if(!V){const x=await yt(s.card.ort);if(C)return;x&&(V={lat:x.lat,lng:x.lng})}if(!V){j("Konnte Einsatz-Position nicht bestimmen.");return}$=new window.google.maps.Map(g.current,{center:V,zoom:18,mapTypeId:"roadmap"}),D=new window.google.maps.InfoWindow;const X=(x,F,te,W,{hover:B=!1}={})=>{const Q={path:"M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z",fillColor:F,fillOpacity:1,strokeColor:"#333",strokeWeight:1,scale:1.2},Y=new window.google.maps.Marker({position:x,map:$,title:te,icon:Q});if(W){const w=()=>{D.setContent(W),D.open($,Y)};B?(Y.addListener("mouseover",w),Y.addListener("mouseout",()=>D.close())):Y.addListener("click",w)}return Y};X(V,"#d11a1a",s.card.content||"Einsatz",Nt(s.card),{hover:!0});const k=[...s?.board?.columns?.neu?.items||[],...s?.board?.columns?.["in-bearbeitung"]?.items||[]],E=new Map;for(const x of k)if(Number.isFinite(x.latitude)&&Number.isFinite(x.longitude))E.set(x.id,{lat:Number(x.latitude),lng:Number(x.longitude)});else if(x.ort){const F=await yt(x.ort);F&&E.set(x.id,{lat:F.lat,lng:F.lng})}for(const x of k){if(x.id===s.card.id)continue;const F=E.get(x.id);F&&X(F,"#1e63d1",x.content||"Einsatz",Nt(x),{hover:!0})}const G=new Map;for(const x of k)for(const F of x.assignedVehicles||[])G.set(String(F),x.id);const A=await vt(),H=new Map(A.filter(x=>Number.isFinite(x?.lat)&&Number.isFinite(x?.lng)&&x?.realname).map(x=>[Ee(x.realname),x])),ee=await wt(),Z=new Map(ee.filter(x=>x&&x.source!=="gps"&&Number.isFinite(x.latitude)&&Number.isFinite(x.longitude)).map(x=>[String(x.id),{lat:Number(x.latitude),lng:Number(x.longitude)}])),ae=Object.values(s.vehiclesById||{}),y=10,ue=50,O=new Map,ie=window.google?.maps?.marker?.AdvancedMarkerElement,ge=(x,F,te)=>{if(!x)return Rn;if(!F||!te||!E.has(te))return jt;const W=E.get(te);return On(F,W)>.1?Ln:jt},be=(x,F,te,W,B,Q)=>{const Y=ge(F,W,B),w=!W;if(ie){const P=document.createElement("img");P.src=Y,P.width=xe,P.height=xe,P.alt=te||"",P.decoding="async";const v=new ie({map:$,position:x,content:P,title:te});if(w){try{v.draggable=!0}catch{}v.addListener("dragend",async n=>{const l=n?.latLng||v.position,b=typeof l.lat=="function"?l.lat():l.lat,N=typeof l.lng=="function"?l.lng():l.lng;try{await ft(Q,b,N,B,"manual")}catch(L){v.__setPosition(x),console.error("setVehiclePosition failed:",L),alert("Position konnte nicht gespeichert werden.")}})}return v.__setPosition=n=>{v.position=n},v.__setIcon=(n,l,b)=>{P.src=ge(n,l,b)},v.__onOver=n=>{P.addEventListener("mouseover",n),P.addEventListener("mouseout",()=>D.close())},v}else{const P=new window.google.maps.Marker({position:x,map:$,title:te,draggable:w,icon:{url:Y,scaledSize:new window.google.maps.Size(xe,xe),anchor:new window.google.maps.Point(xe/2,xe/2)}});return w&&P.addListener("dragend",async v=>{const n=v?.latLng||P.getPosition(),l=typeof n.lat=="function"?n.lat():n.lat,b=typeof n.lng=="function"?n.lng():n.lng;try{await ft(Q,l,b,B,"manual")}catch(N){P.__setPosition(x),console.error("setVehiclePosition failed:",N),alert("Position konnte nicht gespeichert werden.")}}),P.__setPosition=v=>P.setPosition(v),P.__setIcon=(v,n,l)=>P.setIcon({url:ge(v,n,l),scaledSize:new window.google.maps.Size(xe,xe),anchor:new window.google.maps.Point(xe/2,xe/2)}),P.__onOver=v=>{P.addListener("mouseover",v),P.addListener("mouseout",()=>D.close())},P}};for(const x of ae){const F=String(x.id),te=Ee(`${x?.label||""} ${x?.ort||""}`),W=H.get(te),B=G.get(F);if(!B&&!W)continue;let Q=null,Y=null;if(W)Y={lat:Number(W.lat),lng:Number(W.lng)},Q=Y;else if(Z.has(F))Q=Z.get(F);else if(B&&E.has(B)){const l=E.get(B),N=((O.get(B)||0)+ue)%360;O.set(B,N),Q=bt(l,y,N)}if(!Q)continue;const P=be(Q,!!B,x.label||x.id,Y,B,F),v=B&&k.find(l=>l.id===B),n=v?`<br/><i>zugeordnet: ${v.content}</i>`:"";P.__onOver(()=>{const l=x?.ort||"";D.setContent(`<div style="min-width:220px"><b>${x.label||x.id}</b>${l?`<br/>${l}`:""}${n}</div>`);const b=ie?void 0:P;D.open({map:$,anchor:b,position:Q,shouldFocus:!1})}),z.set(F,P)}$.setCenter(V),$.setZoom(18),U=setInterval(async()=>{const x=await vt(),F=await wt(),te=new Map(F.filter(v=>v&&v.source!=="gps"&&Number.isFinite(v.latitude)&&Number.isFinite(v.longitude)).map(v=>[String(v.id),{lat:Number(v.latitude),lng:Number(v.longitude)}])),W=new Map(x.filter(v=>Number.isFinite(v?.lat)&&Number.isFinite(v?.lng)&&v?.realname).map(v=>[Ee(v.realname),v])),B=new Map;for(const v of[...s?.board?.columns?.neu?.items||[],...s?.board?.columns?.["in-bearbeitung"]?.items||[]])for(const n of v.assignedVehicles||[])B.set(String(n),v.id);const Q=Object.values(s.vehiclesById||{}),Y=new Map;for(const v of Q){const n=String(v.id),l=B.get(n),b=Ee(`${v?.label||""} ${v?.ort||""}`);if(l&&!W.get(b)){const N=Y.get(l)||[];N.push(n),Y.set(l,N)}}for(const[v,n]of Y.entries())n.sort();const w=10,P=50;for(const v of Q){const n=String(v.id),l=z.get(n);if(!l)continue;const b=Ee(`${v?.label||""} ${v?.ort||""}`),N=W.get(b),L=B.get(n);if(N)gpsPos={lat:Number(N.lat),lng:Number(N.lng)},l.__setPosition(gpsPos);else if(te.has(n))l.__setPosition(te.get(n));else if(L&&E.has(L)){const ne=((Y.get(L)||[]).indexOf(n)+1)*P%360,me=E.get(L);l.__setPosition(bt(me,w,ne))}else{const J=z.get(n);J&&(J.setMap?J.setMap(null):J.map&&(J.map=null),z.delete(n));continue}const R=!!L;l.__setIcon(R,gpsPos,L)}},5e3)}catch(V){j(V?.message||"Kartenaufbau fehlgeschlagen.")}finally{p(!1)}})(),()=>{C=!0,U&&clearInterval(U),z.clear()}},[h,s,_]),!h||!s?.card){const C=`https://www.google.com/maps?q=${encodeURIComponent(c)}&output=embed`;return e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:o,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[70vh] p-2",onClick:$=>$.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-semibold text-sm",children:["Karte: ",c]}),e.jsx("button",{className:"px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm",onClick:o,children:"Schließen"})]}),e.jsx("iframe",{title:"maps",className:"w-full h-full rounded-lg border",src:C,loading:"lazy"})]})})}return e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:o,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-5xl h-[75vh] p-2",onClick:C=>C.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("h4",{className:"font-semibold text-sm",children:["Karte: ",s?.card?.content||"Einsatz"," · weitere Einsätze (Neu & In Bearbeitung)"]}),e.jsx("button",{className:"px-2 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm",onClick:o,children:"Schließen"})]}),e.jsx("div",{ref:g,className:"w-full h-full rounded-lg border"}),m&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"px-3 py-1.5 rounded bg-white shadow text-sm",children:"Lade…"})}),!!I&&e.jsx("div",{className:"absolute bottom-3 left-3 px-2 py-1 rounded bg-red-600 text-white text-xs shadow",children:I})]})})}function zn({onClose:s,onCreate:a}){const[o,c]=r.useState(""),[h,g]=r.useState(""),[m,p]=r.useState(0),[I,j]=r.useState(!1),[_,C]=r.useState(""),$=async D=>{if(D.preventDefault(),C(""),!o.trim()||!h.trim()){C("Ort und Name sind erforderlich.");return}try{j(!0),await a({ort:o.trim(),label:h.trim(),mannschaft:Number(m)||0}),s()}catch(z){C(z?.message||"Speichern fehlgeschlagen.")}finally{j(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:e.jsxs("form",{onSubmit:$,className:"bg-white rounded-xl shadow-lg p-4 w-[360px] space-y-3",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Einheit anlegen"}),_&&e.jsx("div",{className:"text-sm text-red-600",children:_}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Ort"}),e.jsx("input",{className:"border rounded px-2 py-1 w-full",value:o,onChange:D=>c(D.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Name"}),e.jsx("input",{className:"border rounded px-2 py-1 w-full",value:h,onChange:D=>g(D.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-sm",children:"Mannschaft"}),e.jsx("input",{type:"number",min:"0",className:"border rounded px-2 py-1 w-24",value:m,onChange:D=>p(D.target.value)})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:s,className:"px-3 py-1 rounded border",disabled:I,children:"Abbrechen"}),e.jsx("button",{type:"submit",className:"px-3 py-1 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:I,children:I?"Anlegen…":"Anlegen"})]})]})})}let Le=null;function At(){const s=document.querySelector('meta[name="google-places-key"]');return(window.GMAPS_API_KEY||s?.content||"").trim()||""}async function Fn(s=At()){if(window.google?.maps?.places)return!0;if(!s)return!1;if(Le)return await Le,!!window.google?.maps?.places;Le=new Promise((a,o)=>{if(document.getElementById("gmap-places")){const h=()=>{window.google?.maps?.places?a(!0):setTimeout(h,150)};h();return}const c=document.createElement("script");c.id="gmap-places",c.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(s)}&libraries=places&language=de`,c.async=!0,c.defer=!0,c.onload=()=>a(!!window.google?.maps?.places),c.onerror=h=>o(h),document.head.appendChild(c)});try{await Le}catch{}return!!window.google?.maps?.places}function Tt({debounceMs:s=300,country:a="at",minLength:o=3}={}){const[c,h]=r.useState(""),[g,m]=r.useState([]),[p,I]=r.useState(!1),[j,_]=r.useState(!1),[C,$]=r.useState(null),D=r.useRef(null),z=r.useRef(null),U=r.useRef(null),q=r.useRef(null);r.useEffect(()=>{let A=!1;return(async()=>{const H=await Fn(At());A||!H||!window.google?.maps?.places||(D.current=new google.maps.places.AutocompleteService,z.current=new google.maps.places.PlacesService(document.createElement("div")),U.current=new google.maps.places.AutocompleteSessionToken,A||_(!0))})(),()=>{A=!0}},[]);const V=r.useCallback(()=>{window.google?.maps?.places&&(U.current=new google.maps.places.AutocompleteSessionToken)},[]),X=r.useRef();r.useEffect(()=>{X.current||(X.current=(A,H)=>{let ee;return(...Z)=>{clearTimeout(ee),ee=setTimeout(()=>A(...Z),H)}})},[]);const k=r.useCallback(async A=>{if(!j||!D.current)return;const H=(A||"").trim();if(!H||H.length<o){m([]);return}I(!0),$(null),D.current.getPlacePredictions({input:H,sessionToken:U.current,componentRestrictions:{country:a},types:["address"]},(ee,Z)=>{if(I(!1),Z!==google.maps.places.PlacesServiceStatus.OK||!ee){m([]),Z&&Z!=="ZERO_RESULTS"&&$(Z);return}m(ee)})},[a,o,j]),E=r.useMemo(()=>X.current?X.current(k,s):()=>{},[k,s]);r.useEffect(()=>{E(c)},[c,E]);const G=r.useCallback((A,H=["formatted_address","geometry","address_components"])=>new Promise((ee,Z)=>{if(!j||!z.current){Z(new Error("Google Places nicht bereit"));return}z.current.getDetails({placeId:A,fields:H,sessionToken:U.current},(ae,y)=>{if(y!==google.maps.places.PlacesServiceStatus.OK||!ae)return Z(new Error(y||"DETAILS_FAILED"));ee(ae)})}),[j]);return{ready:j,query:c,setQuery:h,predictions:g,loading:p,error:C,resetSession:V,getDetailsByPlaceId:G,inputElRef:q}}function Bn({onClose:s,onCreate:a,types:o}){const[c,h]=r.useState(""),[g,m]=r.useState(""),[p,I]=r.useState(!1),j=r.useRef(null),{query:_,setQuery:C,predictions:$,getDetailsByPlaceId:D,resetSession:z,loading:U,error:q}=Tt({country:"at",debounceMs:300,minLength:3});r.useEffect(()=>{setTimeout(()=>j.current?.focus(),0)},[]),r.useEffect(()=>{const k=(g||"").replace(/^T\d+\s*,?\s*/i,"").trim();!c.trim()&&k&&h(k)},[g]);const V=async k=>{k?.preventDefault?.();const E=(g||"").replace(/^T\d+\s*,?\s*/i,"").trim(),G=(c||E).trim();if(G){I(!0);try{await a({title:G,ort:(_||"").trim(),typ:(g||"").trim()}),h(""),C(""),m(""),z(),s?.()}finally{I(!1)}}},X=async k=>{try{const G=(await D(k.place_id,["formatted_address","geometry","address_components","place_id"]))?.formatted_address||k.description;C(G)}catch{C(k.description)}finally{z()}};return e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-3",children:e.jsxs("form",{onSubmit:V,className:"bg-white rounded-xl shadow-lg w-[520px] max-w-full p-4 space-y-3",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Einsatz anlegen"}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs("select",{ref:j,className:"border rounded px-2 py-1",value:g,onChange:k=>m(k.target.value),children:[e.jsx("option",{value:"",children:"— Typ auswählen —"}),o.map(k=>e.jsx("option",{value:k,children:k},k))]}),e.jsx("input",{className:"border rounded px-2 py-1",placeholder:"Titel (wird aus Typ übernommen)",value:c,onChange:k=>h(k.target.value)}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{className:"border rounded px-2 py-1 w-full",placeholder:"Ort (nur Österreich)",autoComplete:"off",value:_,onChange:k=>C(k.target.value)}),U&&e.jsx("div",{className:"absolute z-10 mt-1 text-xs text-gray-500 bg-white border rounded px-2 py-1",children:"Suche…"}),q&&e.jsxs("div",{className:"absolute z-10 mt-1 text-xs text-red-600 bg-white border rounded px-2 py-1",children:["Fehler: ",String(q)]}),!!$.length&&e.jsx("ul",{className:"absolute z-10 mt-1 w-full max-h-52 overflow-auto bg-white border rounded shadow",children:$.map(k=>e.jsx("li",{className:"px-2 py-1 hover:bg-gray-100 cursor-pointer text-sm",onClick:()=>X(k),title:k.description,children:k.description},k.place_id))})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx("button",{type:"button",onClick:s,className:"px-3 py-1 rounded border",disabled:p,children:"Abbrechen"}),e.jsx("button",{className:"px-3 py-1 rounded bg-emerald-600 text-white disabled:opacity-60",disabled:p,children:p?"Anlegen…":"Anlegen"})]})]})})}function Vn({colId:s,title:a,bg:o,children:c,editable:h=!0}){if(!h)return e.jsxs("section",{className:`${o} rounded-xl shadow p-3 h-full flex flex-col min-h-0`,children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:a}),c]});const{setNodeRef:g,isOver:m}=pn({id:`col:${s}`,data:{type:"column",colId:s}});return e.jsxs("section",{ref:g,className:`${o} rounded-xl shadow p-3 h-full flex flex-col min-h-0 ${m?"outline outline-2 outline-blue-400":""}`,children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:a}),c]})}function Kn({open:s,onClose:a,info:o={}}){if(!s)return null;const c=({label:p,value:I})=>e.jsxs("div",{className:"flex items-start gap-3 py-1",children:[e.jsx("div",{className:"w-32 shrink-0 text-gray-600",children:p}),e.jsx("div",{className:"flex-1 font-medium break-words",children:I??"—"})]}),h=o.timestamp?new Date(o.timestamp).toLocaleString("de-AT",{hour12:!1}):"—",g=[];o.location&&g.push(String(o.location)),Number.isFinite(o.latitude)&&Number.isFinite(o.longitude)&&g.push(`(${o.latitude}, ${o.longitude})`);const m=g.length?g.join(" "):void 0;return e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:a}),e.jsxs("div",{className:"relative z-[101] w-[min(92vw,640px)] rounded-xl bg-white shadow-xl p-4 md:p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg md:text-xl font-bold",children:"Einsatz-Info"}),e.jsx("button",{className:"h-8 w-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center",onClick:a,"aria-label":"Schließen",title:"Schließen",children:e.jsx("svg",{viewBox:"0 0 12 12",width:"14",height:"14","aria-hidden":"true",children:e.jsx("path",{d:"M1 1 L11 11 M11 1 L1 11",stroke:"black",strokeWidth:"2",strokeLinecap:"round"})})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(c,{label:"Typ",value:o.type||o.typ}),e.jsx(c,{label:"Alarmzeit",value:h}),e.jsx(c,{label:"Alarmiert",value:o.alerted}),e.jsx(c,{label:"Beschreibung",value:o.description}),e.jsx(c,{label:"Adresse",value:o.additionalAddressInfo||o.ort}),e.jsx(c,{label:"Location",value:m})]}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx("button",{className:"px-3 py-1.5 rounded-md bg-emerald-600 text-white hover:bg-emerald-700",onClick:a,children:"OK"})})]})]})}let qe=localStorage.getItem("soundEnabled")==="1",de=null;const St=window.AudioContext||window.webkitAudioContext,Je=St?new St:null;function Mt(){de||(de=new Audio("/sounds/bahnhof.mp3"),de.preload="auto");const s=async()=>{try{Je&&Je.state!=="running"&&await Je.resume(),de&&(de.muted=!0,await de.play(),de.pause(),de.currentTime=0,de.muted=!1),qe=!0,localStorage.setItem("soundEnabled","1"),window.removeEventListener("pointerdown",s),window.removeEventListener("keydown",s),window.dispatchEvent(new CustomEvent("sound:unlocked"))}catch{}};qe||(window.addEventListener("pointerdown",s,{once:!0}),window.addEventListener("keydown",s,{once:!0}))}async function Un(){if(de||Mt(),!qe){window.dispatchEvent(new CustomEvent("sound:needsUnlock"));return}try{de.currentTime=0,await de.play()}catch{}}function Gn(s){const a=(s??"").toString();return a.length>30?a.slice(0,30)+"…":a}function Wn(){const[s,a]=r.useState([]),[o,c]=r.useState(!0),[h,g]=r.useState(!1);r.useEffect(()=>{(async()=>{try{await Qe(),g(Ye("protokoll"))}catch{g(!1)}})(),(async()=>{try{const p=await fetch("/api/protocol").then(I=>I.json());a(Array.isArray(p?.items)?p.items:[])}catch{a([])}finally{c(!1)}})()},[]);const m=r.useMemo(()=>[...s].sort((p,I)=>(Number(I.nr)||0)-(Number(p.nr)||0)),[s]);return e.jsxs("div",{className:"p-3 md:p-4 max-w-[1400px] mx-auto h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-3",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:"Protokoll-Übersicht"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("a",{href:"/api/protocol/csv/file",className:"px-3 py-1.5 rounded-md border bg-white",title:"protocol.csv herunterladen",children:"CSV"}),e.jsx("button",{onClick:()=>{h&&(window.location.hash="/protokoll/neu")},className:"px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white",title:h?void 0:"Keine Berechtigung (Meldestelle)",children:"+ Eintrag anlegen"})]})]}),e.jsx("div",{className:"flex-1 overflow-auto border rounded-lg bg-white",children:o?e.jsx("div",{className:"p-4 text-gray-500",children:"Lade…"}):e.jsxs("table",{className:"min-w-[1100px] w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0 z-10",children:e.jsxs("tr",{className:"[&>th]:px-2 [&>th]:py-2 [&>th]:text-left [&>th]:font-semibold border-b",children:[e.jsx("th",{style:{width:28},title:"Druckstatus"}),e.jsx("th",{style:{width:60},children:"NR"}),e.jsx("th",{style:{width:110},children:"Datum"}),e.jsx("th",{style:{width:80},children:"Zeit"}),e.jsx("th",{style:{width:120},children:"Kanal"}),e.jsx("th",{style:{width:110},children:"Richtung"}),e.jsx("th",{style:{width:160},children:"An/Von"}),e.jsx("th",{children:"Information"}),e.jsx("th",{style:{width:260},children:"Meldungstyp"})]})}),e.jsxs("tbody",{className:"[&>tr>td]:px-2 [&>tr>td]:py-2",children:[m.map(p=>{const I=p?.uebermittlungsart||{},j=I.kanal??I.kanalNr??I.art??"",C=[].concat(I.ein?"Eingang":[]).concat(I.aus?"Ausgang":[]).join(" / "),$=Number(p?.printCount)>0;return e.jsxs("tr",{className:"border-b align-top hover:bg-gray-50 cursor-pointer",onClick:()=>{window.location.hash=`/protokoll/edit/${p.nr}`},title:"Zum Bearbeiten öffnen",children:[e.jsx("td",{className:"align-middle",children:$?e.jsx("span",{className:"inline-block w-3 h-3 rounded-full bg-yellow-400",title:`Gedruckt (${p.printCount})`}):null}),e.jsx("td",{className:"font-semibold",children:p.nr}),e.jsx("td",{children:p.datum}),e.jsx("td",{children:p.zeit}),e.jsx("td",{title:j,children:j}),e.jsx("td",{title:C,children:C}),e.jsx("td",{children:p.anvon}),e.jsx("td",{className:"whitespace-pre-wrap",children:Gn(p.information)}),e.jsx("td",{className:"whitespace-pre-wrap",children:p.infoTyp||"—"})]},p.nr)}),!m.length&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"p-4 text-gray-500 italic",children:"— keine Einträge —"})})]})]})})]})}const He=["EL","LtStb","S1","S2","S3","S4","S5","S6"],ye={anvon:"prot_sugg_anvon",kanal:"prot_sugg_kanalNr",verantwortlich:"prot_sugg_ver"};function Ze(s,a=12){const o=new Set,c=[];for(const h of s){const g=String(h||"").trim();if(!(!g||o.has(g))&&(o.add(g),c.push(g),c.length>=a))break}return c}function kt(s){let a=String(s||"").trim();if(!a)return a;const o=a.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})$/);if(o){const h=o[1].padStart(2,"0"),g=o[2].padStart(2,"0");return`${o[3].length===2?"20"+o[3]:o[3]}-${g}-${h}`}const c=a.match(/^(\d{1,2})(\d{1,2})(\d{2,4})$/);if(c){const h=c[1].padStart(2,"0"),g=c[2].padStart(2,"0");return`${c[3].length===2?"20"+c[3]:c[3].padStart(4,"20")}-${g}-${h}`}return a}function It(s){let a=String(s||"").trim();if(!a)return a;const o=a.match(/^(\d{1,2})(\d{2})$/);if(o)return`${o[1].padStart(2,"0")}:${o[2]}`;const c=a.match(/^(\d{1,2})[:.](\d{1,2})$/);return c?`${c[1].padStart(2,"0")}:${c[2].padStart(2,"0")}`:a}const Ct=()=>({datum:new Date().toISOString().slice(0,10),zeit:new Date().toTimeString().slice(0,5),uebermittlungsart:{richtung:"",kanalNr:""},anvon:{richtung:"an",name:""},infoTyp:"Information",information:"",rueckmeldung1:"",rueckmeldung2:"",ergehtAn:[],ergehtAnText:"",lagebericht:"",massnahmen:Array.from({length:5},()=>({massnahme:"",verantwortlich:"",done:!1}))});function Et({mode:s="create",editNr:a=null}){const[o,c]=r.useState(!1);r.useEffect(()=>{let n=!0;return(async()=>{try{if(await Qe(),!n)return;c(Ye("protokoll"))}catch{if(!n)return;c(!1)}})(),()=>{n=!1}},[]);const[h,g]=r.useState(()=>{const n=Number(a);return Number.isFinite(n)&&n>0?n:null}),m=Number.isFinite(Number(h))&&Number(h)>0,[p,I]=r.useState(m),[j,_]=r.useState(!1),[C,$]=r.useState(null),D=r.useRef(null),z=r.useRef(null),U=r.useRef(!1),q=r.useRef(null),[V,X]=r.useState(null),k=r.useRef(null),E=(n,l,b=2200)=>{X({type:n,text:l}),k.current&&clearTimeout(k.current),k.current=setTimeout(()=>X(null),b)},[G,A]=r.useState([]),[H,ee]=r.useState([]),[Z,ae]=r.useState([]);r.useEffect(()=>{try{A(JSON.parse(localStorage.getItem(ye.anvon)||"[]")),ee(JSON.parse(localStorage.getItem(ye.kanal)||"[]")),ae(JSON.parse(localStorage.getItem(ye.verantwortlich)||"[]"))}catch{}},[]);const[y,ue]=r.useState(Ct()),O=(n,l)=>{const b=Array.isArray(n)?n:String(n).split(".");ue(N=>{const L=structuredClone(N);let R=L;for(let J=0;J<b.length-1;J++)R=R[b[J]];return R[b.at(-1)]=l,L})};r.useEffect(()=>{if(!m){I(!1),setTimeout(()=>z.current?.focus(),0);return}const n=Number(h);!Number.isFinite(n)||n<=0||(async()=>{try{const l=await fetch(`/api/protocol/${n}`).then(b=>b.json());if(l?.ok&&l.item){const b=l.item,N=b.uebermittlungsart||{};let L="",R=b.anvon||"";const J=(b.anvon||"").trim();/^an\s*:/i.test(J)&&(L="an",R=J.replace(/^an\s*:/i,"").trim()),/^von\s*:/i.test(J)&&(L="von",R=J.replace(/^von\s*:/i,"").trim()),ue({datum:b.datum||"",zeit:b.zeit||"",uebermittlungsart:{richtung:N.ein?"ein":N.aus?"aus":"",kanalNr:N.kanalNr||""},anvon:{richtung:L||"an",name:R},infoTyp:b.infoTyp||"Information",information:b.information||"",rueckmeldung1:b.rueckmeldung1||"",rueckmeldung2:b.rueckmeldung2||"",ergehtAn:Array.isArray(b.ergehtAn)?b.ergehtAn:[],ergehtAnText:b.ergehtAnText||"",lagebericht:b.lagebericht||"",massnahmen:Array.from({length:5},(K,ne)=>{const me=b.massnahmen?.[ne]||{};return{massnahme:me.massnahme||"",verantwortlich:me.verantwortlich||"",done:!!me.done}})}),$(b.id||null),setTimeout(()=>z.current?.focus(),0)}}finally{I(!1)}})()},[m,h]),r.useEffect(()=>{const n=()=>{const N=document.activeElement;N&&typeof N.blur=="function"&&N.blur()},l=N=>setTimeout(N,0),b=N=>{if(N.repeat)return;const L=(N.key||"").toLowerCase(),R=N.ctrlKey||N.metaKey;if(R&&!N.shiftKey&&L==="s"){if(N.preventDefault(),N.stopPropagation(),!o){E?.("error","Keine Berechtigung (Meldestelle)");return}if(U.current)return;U.current=!0,l(async()=>{n(),await new Promise(J=>setTimeout(J,0)),B().finally(()=>U.current=!1)});return}if(R&&(N.shiftKey&&L==="s"||L==="enter")){if(N.preventDefault(),N.stopPropagation(),!o){E?.("error","Keine Berechtigung (Meldestelle)");return}if(U.current)return;U.current=!0,l(async()=>{n(),await new Promise(J=>setTimeout(J,0)),Q().finally(()=>U.current=!1)});return}L==="escape"&&(N.preventDefault(),N.stopPropagation(),l(()=>te()))};return window.addEventListener("keydown",b,!0),document.addEventListener("keydown",b,!0),()=>{window.removeEventListener("keydown",b,!0),document.removeEventListener("keydown",b,!0)}},[]);const[ie,ge]=r.useState(!1),be=r.useRef(null);function x(){const n=Array.isArray(y?.ergehtAn)?[...y.ergehtAn]:[],l=(y?.ergehtAnText||"").trim();return l&&n.push(l),n}const F=async()=>{if(!o){E?.("error","Keine Berechtigung zum Drucken/Speichern");return}if(ie)return;const n=x();if(!n.length){E?.("error","Bitte Empfänger wählen oder 'Sonstiger Empfänger' ausfüllen.");return}ge(!0);try{const l=await W();if(!l)throw new Error("Speichern fehlgeschlagen");g(l);const N=(await fetch(`/api/protocol/${l}`).then(ne=>ne.json()))?.item;if(!N)throw new Error("Datensatz für Druck nicht gefunden");E?.("info","PDF wird serverseitig erzeugt …");const L=await fetch(`/api/protocol/${l}/print`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({recipients:n,data:N})}).then(ne=>ne.json());if(!L?.ok||!L?.fileUrl)throw new Error(L?.error||"PDF-Erzeugung fehlgeschlagen");let R=be.current;R||(R=document.createElement("iframe"),R.style.position="fixed",R.style.width="0",R.style.height="0",R.style.border="0",R.style.visibility="hidden",document.body.appendChild(R),be.current=R);const J=`${L.fileUrl}#toolbar=0&navpanes=0&scrollbar=0`;R.onload=()=>{try{setTimeout(()=>{R.contentWindow?.focus(),R.contentWindow?.print()},100)}catch{window.open(J,"_blank","noopener,noreferrer")?.focus()}},R.src=J;const K=Number(L?.pages)||n.length;E?.("success",`Druck gestartet (${K} Seite${K>1?"n":""})`)}catch(l){E?.("error",`Drucken fehlgeschlagen: ${l.message||l}`)}finally{ge(!1)}},te=()=>{window.location.hash="/protokoll"},W=async()=>{const n=q.current?new FormData(q.current):null,l=structuredClone(y);l.datum=kt(n?.get("datum")||y.datum),l.zeit=It(n?.get("zeit")||y.zeit);const b=(n?.get("anvonDir")||y.anvon.richtung||"").toString(),N=(n?.get("anvonName")||y.anvon.name||"").toString();l.anvon={richtung:b,name:N};const L=(n?.get("richtung")||y.uebermittlungsart.richtung||"").toString();l.uebermittlungsart.richtung=L,l.uebermittlungsart.kanalNr=(n?.get("kanalNr")||y.uebermittlungsart.kanalNr||"").toString(),l.information=(n?.get("information")||y.information||"").toString(),l.rueckmeldung1=(n?.get("rueckmeldung1")||y.rueckmeldung1||"").toString(),l.rueckmeldung2=(n?.get("rueckmeldung2")||y.rueckmeldung2||"").toString(),l.ergehtAnText=(n?.get("ergehtAnText")||y.ergehtAnText||"").toString(),l.infoTyp=(n?.get("infoTyp")||y.infoTyp||"Information").toString();const R=n?Array.from(n.getAll("ergehtAn")).map(String):y.ergehtAn;l.ergehtAn=R.length?R:y.ergehtAn,l.massnahmen=l.massnahmen.map((K,ne)=>{const me=n?n.get(`m_done_${ne}`)!==null:K.done;return{massnahme:(n?.get(`m_massnahme_${ne}`)||K.massnahme||"").toString(),verantwortlich:(n?.get(`m_verantwortlich_${ne}`)||K.verantwortlich||"").toString(),done:!!me}});const J={...l,uebermittlungsart:{kanalNr:(l.uebermittlungsart.kanalNr||"").trim(),ein:l.uebermittlungsart.richtung==="ein",aus:l.uebermittlungsart.richtung==="aus"},anvon:l.anvon.richtung?`${l.anvon.richtung==="an"?"An":"Von"}: ${l.anvon.name}`.trim():l.anvon.name.trim()};try{const K=Ze([J.anvon,...JSON.parse(localStorage.getItem(ye.anvon)||"[]")]),ne=Ze([J.uebermittlungsart.kanalNr,...JSON.parse(localStorage.getItem(ye.kanal)||"[]")]),me=[...l.massnahmen.map(Ie=>Ie.verantwortlich).filter(Boolean),...JSON.parse(localStorage.getItem(ye.verantwortlich)||"[]")],Pe=Ze(me);localStorage.setItem(ye.anvon,JSON.stringify(K)),localStorage.setItem(ye.kanal,JSON.stringify(ne)),localStorage.setItem(ye.verantwortlich,JSON.stringify(Pe)),A(K),ee(ne),ae(Pe)}catch{}if(m){const K=await fetch(`/api/protocol/${h}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(J)}).then(ne=>ne.json());if(!K?.ok)throw new Error(K?.error||"Speichern fehlgeschlagen");return g(K.nr),$(K.id||C||null),K.nr}else{const K=await fetch("/api/protocol",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(J)}).then(ne=>ne.json());if(!K?.ok)throw new Error(K?.error||"Speichern fehlgeschlagen");return g(K.nr),$(K.id||null),K.nr}},B=async()=>{if(!o){E?.("error","Keine Berechtigung (Meldestelle)");return}if(!j){_(!0);try{await W()&&(window.location.hash="/protokoll")}catch(n){E("error","Fehler beim Speichern: "+n.message,4e3)}finally{_(!1)}}},Q=async()=>{if(!o){E?.("error","Keine Berechtigung (Meldestelle)");return}if(!j){_(!0);try{const n=await W();n&&(E("success",`Gespeichert (NR ${n}) – neuer Eintrag`),ue(Ct()),g(null),$(null),setTimeout(()=>z.current?.focus(),0))}catch(n){E("error","Fehler beim Speichern: "+n.message,4e3)}finally{_(!1)}}},Y=n=>{const l=(n.key||"").toLowerCase(),b=n.ctrlKey||n.metaKey;n.repeat||(b&&!n.shiftKey&&l==="s"?(n.preventDefault(),n.stopPropagation(),B()):b&&(n.shiftKey&&l==="s"||l==="enter")&&(n.preventDefault(),n.stopPropagation(),Q()))},w=n=>{if(n.preventDefault(),!o){E?.("error","Keine Berechtigung (Meldestelle)");return}B()};if(p)return e.jsx("div",{className:"p-4",children:"Lade…"});const P=He.every(n=>y.ergehtAn.includes(n)),v=n=>O("ergehtAn",n?[...He]:[]);return e.jsxs("div",{className:"mx-auto w-full max-w-[1100px] relative",children:[e.jsx("div",{className:"prot-actionbar sticky top-0 z-30 -mx-2 md:mx-0 px-2 md:px-0",children:e.jsxs("div",{className:"bg-white/95 backdrop-blur border-b rounded-t-xl px-3 py-2 flex items-center justify-between shadow-sm",children:[e.jsx("div",{className:"text-sm font-semibold",children:m?`Protokoll – Bearbeiten (NR ${h??"—"})`:"Protokoll – Neuer Eintrag"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:te,className:"px-3 py-1.5 rounded-md border",title:"Maske schließen und zur Übersicht wechseln (ESC)",children:"Abbrechen"}),e.jsx("button",{type:"button",onClick:Q,disabled:j,className:"px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white disabled:opacity-60",title:"Speichern und neue Maske (Strg+Shift+S oder Strg+Enter)",children:"Speichern/Neu"}),e.jsx("button",{type:"button",onClick:B,disabled:j,className:"px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-60",title:"Speichern und schließen (Strg+S)",children:j?"Speichern…":"Speichern"}),e.jsx("button",{type:"button",onClick:F,disabled:ie,className:"px-3 py-1.5 rounded-md border bg-white hover:bg-gray-50 disabled:opacity-60",title:"Formular drucken – Anzahl gemäß 'ergeht an' + 'Sonstiger Empfänger'",children:ie?"Drucken…":"Drucken"})]})]})}),V&&e.jsx("div",{className:"fixed right-3 top-3 z-40",children:e.jsx("div",{className:"px-3 py-2 rounded shadow text-white "+(V.type==="success"?"bg-emerald-600":V.type==="error"?"bg-rose-600":"bg-slate-600"),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{children:V.text}),e.jsx("button",{className:"opacity-80 hover:opacity-100",onClick:()=>X(null),title:"Meldung schließen",children:"✕"})]})})}),e.jsx("style",{children:`
        @media print {
          * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          .prot-actionbar { display: none !important; }
          html, body { margin: 0 !important; }
          @page { size: A4; margin: 12mm; }
        }
      `}),e.jsxs("form",{ref:q,onKeyDown:Y,onSubmit:w,className:"bg-white border-2 rounded-b-xl overflow-hidden shadow",children:[e.jsxs("div",{className:"grid grid-cols-12",children:[e.jsx("div",{className:"col-span-9 p-6 border-b-2",children:e.jsx("div",{className:"text-3xl font-extrabold tracking-wide",children:"MELDUNG/INFORMATION"})}),e.jsxs("div",{className:"col-span-3 border-l-2",children:[e.jsx("div",{className:"p-3 text-xs text-gray-600 border-b-2",children:"PROTOKOLL-NR"}),e.jsx("div",{className:"p-6 text-center text-4xl font-bold",children:h??"—"})]}),e.jsx("div",{className:"col-span-12 border-y-2 p-2",children:e.jsxs("div",{className:"grid grid-cols-12 gap-0",children:[e.jsxs("div",{className:"col-span-6 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Datum"}),e.jsx("input",{name:"datum",type:"text",className:"border rounded px-2 h-9 w-full",placeholder:"yyyy-mm-dd",value:y.datum,onChange:n=>O("datum",n.target.value),onBlur:n=>O("datum",kt(n.target.value)),title:"Datum (auch 101025 oder 10.10.2025 möglich)"})]}),e.jsxs("div",{className:"col-span-3 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Uhrzeit"}),e.jsx("input",{name:"zeit",type:"text",className:"border rounded px-2 h-9 w-full",placeholder:"hh:mm",value:y.zeit,onChange:n=>O("zeit",n.target.value),onBlur:n=>O("zeit",It(n.target.value)),title:"Uhrzeit (915, 09:15 oder 0915 möglich)"})]}),e.jsxs("div",{className:"col-span-3 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Typ"}),e.jsxs("div",{className:"grid grid-cols-3 gap-x-6 h-9 items-center",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{ref:z,type:"radio",name:"infoTyp",value:"Information",checked:y.infoTyp==="Information",onChange:()=>O("infoTyp","Information")}),e.jsx("span",{children:"Info"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"infoTyp",value:"Auftrag",checked:y.infoTyp==="Auftrag",onChange:()=>O("infoTyp","Auftrag")}),e.jsx("span",{children:"Auftrag"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"infoTyp",value:"Lagemeldung",checked:y.infoTyp==="Lagemeldung",onChange:()=>O("infoTyp","Lagemeldung")}),e.jsx("span",{children:"Lage"})]})]})]})]})}),e.jsx("div",{className:"col-span-12 border-y-2 p-2",children:e.jsxs("div",{className:"grid grid-cols-12 gap-0 items-end",children:[e.jsxs("div",{className:"col-span-6 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"An/Von"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{ref:D,name:"anvonName",className:"border rounded px-2 h-9 w-full flex-1",placeholder:"Name / Stelle",list:"dl-anvon",value:y.anvon.name,onChange:n=>{let l=n.target.value;const b=l.trim();/^an\s*:/i.test(b)?(O(["anvon","richtung"],"an"),l=b.replace(/^an\s*:/i,"").trim()):/^von\s*:/i.test(b)&&(O(["anvon","richtung"],"von"),l=b.replace(/^von\s*:/i,"").trim()),O(["anvon","name"],l)},title:'Optional mit Präfix "an: …" oder "von: …"'}),e.jsxs("div",{className:"flex items-center gap-4 pl-2 min-w-[140px] shrink-0",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"anvonDir",value:"an",checked:y.anvon.richtung==="an",onChange:()=>O(["anvon","richtung"],"an")}),e.jsx("span",{children:"An"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"anvonDir",value:"von",checked:y.anvon.richtung==="von",onChange:()=>O(["anvon","richtung"],"von")}),e.jsx("span",{children:"Von"})]})]})]}),e.jsx("datalist",{id:"dl-anvon",children:G.map(n=>e.jsx("option",{value:n},n))})]}),e.jsxs("div",{className:"col-span-3 border-r-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Kanal"}),e.jsx("input",{name:"kanalNr",className:"border rounded px-2 h-9 w-full",list:"dl-kanal",value:y.uebermittlungsart.kanalNr,onChange:n=>O(["uebermittlungsart","kanalNr"],n.target.value),title:"z. B. Funkkanal, Telefonnummer, E-Mail-Kürzel …"}),e.jsx("datalist",{id:"dl-kanal",children:H.map(n=>e.jsx("option",{value:n},n))})]}),e.jsxs("div",{className:"col-span-3 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Richtung"}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-6 h-9 items-center",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",title:"Meldung wurde empfangen",children:[e.jsx("input",{type:"radio",name:"richtung",value:"ein",checked:y.uebermittlungsart.richtung==="ein",onChange:()=>O(["uebermittlungsart","richtung"],"ein")}),e.jsx("span",{children:"Eingang"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",title:"Meldung wurde gesendet",children:[e.jsx("input",{type:"radio",name:"richtung",value:"aus",checked:y.uebermittlungsart.richtung==="aus",onChange:()=>O(["uebermittlungsart","richtung"],"aus")}),e.jsx("span",{children:"Ausgang"})]})]})]})]})}),e.jsxs("div",{className:"col-span-12 border-y-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Information/Auftrag"}),e.jsx("textarea",{name:"information",className:"border rounded px-2 py-2 w-full min-h-[160px]",value:y.information,onChange:n=>O("information",n.target.value),title:"Sachverhalt / Meldetext"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Rückmeldung 1"}),e.jsx("input",{name:"rueckmeldung1",className:"border rounded px-2 h-9 w-full",value:y.rueckmeldung1,onChange:n=>O("rueckmeldung1",n.target.value),title:"erste Rückmeldung"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Rückmeldung 2"}),e.jsx("input",{name:"rueckmeldung2",className:"border rounded px-2 h-9 w-full",value:y.rueckmeldung2,onChange:n=>O("rueckmeldung2",n.target.value),title:"zweite Rückmeldung"})]}),e.jsxs("div",{className:"col-span-12 border-t-2 p-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-2",children:"ergeht an:"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 mr-3",title:"Alle Empfänger auswählen / abwählen",children:[e.jsx("input",{type:"checkbox",checked:P,onChange:n=>v(n.target.checked)}),e.jsx("span",{children:"Alle"})]}),He.map(n=>e.jsxs("label",{className:"inline-flex items-center gap-2 mr-3",children:[e.jsx("input",{tabIndex:-1,type:"checkbox",name:"ergehtAn",value:n,checked:y.ergehtAn.includes(n),onChange:()=>{const l=new Set(y.ergehtAn);l.has(n)?l.delete(n):l.add(n),O("ergehtAn",[...l])},title:`Empfänger ${n} ${y.ergehtAn.includes(n)?"entfernen":"hinzufügen"}`}),e.jsx("span",{children:n})]},n)),e.jsx("span",{className:"ml-2 text-xs text-gray-600",children:"sonstiger Empfänger:"}),e.jsx("input",{name:"ergehtAnText",className:"border rounded px-2 h-9",value:y.ergehtAnText,onChange:n=>O("ergehtAnText",n.target.value),placeholder:"Name/Gruppe"})]})]}),e.jsxs("div",{className:"col-span-12 border-t-2",children:[e.jsxs("div",{className:"grid grid-cols-12 bg-gray-50 border-b-2",children:[e.jsx("div",{className:"col-span-6 p-2 font-semibold border-r",children:"Maßnahme"}),e.jsx("div",{className:"col-span-5 p-2 font-semibold border-r",children:"Verantwortlich"}),e.jsx("div",{className:"col-span-1 p-2 font-semibold text-center",children:"Erledigt"})]}),y.massnahmen.map((n,l)=>e.jsxs("div",{className:"grid grid-cols-12 border-t",children:[e.jsx("div",{className:"col-span-6 p-2 border-r",children:e.jsx("input",{name:`m_massnahme_${l}`,className:"w-full border rounded px-2 h-9",value:n.massnahme,onChange:b=>{const N=[...y.massnahmen];N[l]={...n,massnahme:b.target.value},O("massnahmen",N)},title:`Maßnahme ${l+1}`})}),e.jsx("div",{className:"col-span-5 p-2 border-r",children:e.jsx("input",{name:`m_verantwortlich_${l}`,className:"w-full border rounded px-2 h-9",list:"dl-ver",value:n.verantwortlich,onChange:b=>{const N=[...y.massnahmen];N[l]={...n,verantwortlich:b.target.value},O("massnahmen",N)},title:`Verantwortlich ${l+1}`})}),e.jsx("div",{className:"col-span-1 p-2 flex items-center justify-center",children:e.jsx("input",{tabIndex:-1,type:"checkbox",name:`m_done_${l}`,value:"1",checked:!!n.done,onChange:b=>{const N=[...y.massnahmen];N[l]={...n,done:b.target.checked},O("massnahmen",N)},title:"Erledigt umschalten"})})]},l)),e.jsx("datalist",{id:"dl-ver",children:Z.map(n=>e.jsx("option",{value:n},n))})]})]}),e.jsx("button",{type:"submit",className:"hidden",children:"submit"})]})]})}function Jn({disabled:s=!1}){const[a,o]=r.useState(!1),[c,h]=r.useState(!1),[g,m]=r.useState(""),[p,I]=r.useState({remainingMin:null,idleMinutes:null,lastActivityIso:null,autoStopMin:null}),[j,_]=r.useState({lastLoadedIso:null,file:"list_filtered.json"}),[C,$]=r.useState(!1),[D,z]=r.useState(30),[U,q]=r.useState(null),V=r.useRef(!1),X=async()=>{try{const[k,E,G]=await Promise.all([fetch("/api/ff/status",{credentials:"include",cache:"no-store"}).then(A=>A.json()).catch(()=>({running:!1})),fetch("/api/ff/creds",{credentials:"include",cache:"no-store"}).then(A=>A.json()).catch(()=>({has:!1})),fetch("/api/import/auto-config",{credentials:"include",cache:"no-store"}).then(A=>A.json()).catch(()=>({enabled:!1,intervalSec:30}))]);o(!!k.running),h(!!E.has),$(!!G.enabled),z(Number(G.intervalSec||30)),V.current||(V.current=!0,E.has||m("Keine globalen Fetcher-Zugangsdaten. Bitte als Admin unter /user-admin setzen."))}catch{}};return r.useEffect(()=>{X();const k=setInterval(X,3e3);return()=>clearInterval(k)},[]),r.useEffect(()=>{let k;const E=async()=>{try{const G=await fetch("/api/activity/status",{credentials:"include",cache:"no-store"});if(G.ok){const A=await G.json(),H=Number(A.idleMinutes),ee=Number(A.autoStopMin),Z=Math.max(0,Math.ceil(ee-H));I({remainingMin:Z,idleMinutes:H,lastActivityIso:A.lastActivityIso,autoStopMin:ee}),o(!!A.fetcher?.running),_({lastLoadedIso:A.import?.lastLoadedIso??null,file:A.import?.file||"list_filtered.json"})}}catch{}};return E(),k=setInterval(E,1e3),()=>clearInterval(k)},[]),r.useEffect(()=>{let k;const E=()=>{if(!C||!j.lastLoadedIso){q(null);return}const A=new Date(j.lastLoadedIso).getTime()+D*1e3,H=Math.max(0,Math.ceil((A-Date.now())/1e3));q(H)};return E(),k=setInterval(E,1e3),()=>clearInterval(k)},[C,D,j.lastLoadedIso]),e.jsxs("div",{className:`flex items-center h-9 gap-2 ${s?"opacity-60 pointer-events-none":""}`,style:{alignItems:"center"},children:[e.jsx("span",{className:`sync-chip ${C?"active":""}`,title:C?"Auto-Import Countdown":"Auto-Import ist deaktiviert",style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:"110px",minWidth:"110px",textAlign:"center"},children:C?`⟳ in ${U??"–"}s`:"⏸ manuell"}),g&&e.jsx("span",{style:{color:"#dc2626",fontSize:12,marginLeft:8},children:g}),a&&p.remainingMin!=null&&p.remainingMin<=15&&e.jsxs("div",{title:`Letzte Aktivität: ${p.lastActivityIso?new Date(p.lastActivityIso).toLocaleString():"–"} • Inaktiv: ${p.idleMinutes?.toFixed?.(1)} min • Limit: ${p.autoStopMin} min`,className:"ml-2 inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border "+(p.remainingMin<=5?"bg-red-50 text-red-700 border-red-300":p.remainingMin<=15?"bg-amber-50 text-amber-700 border-amber-300":"bg-blue-50 text-blue-700 border-blue-300"),children:[e.jsx("span",{className:"mr-2 h-2 w-2 rounded-full bg-current",style:{animation:"pulse 1.5s ease-in-out infinite"}}),e.jsxs("span",{children:["Auto-Import stoppt in ",e.jsxs("b",{children:[p.remainingMin," min"]})]})]}),e.jsx("div",{title:`Quelle: ${j.file}`,className:"ml-2 inline-flex items-center h-9 rounded-full px-3 py-1.5 text-sm border bg-white text-gray-700",style:{borderColor:"#cbd5e1"},children:e.jsxs("span",{children:["Zuletzt geladen:"," ",e.jsx("b",{children:j.lastLoadedIso?new Date(j.lastLoadedIso).toLocaleTimeString("de-AT",{hour12:!1}):"–"})]})})]})}function Hn(){const[s]=r.useState(.9);return s}const Zn=s=>`card:${s}`,Ne=!0;async function qn(s){if(!s||!window.google?.maps?.Geocoder)return null;const a=new google.maps.Geocoder;return new Promise(o=>{a.geocode({address:s,region:"AT"},(c,h)=>{if(h==="OK"&&c&&c[0]){const g=c[0],m=g.geometry?.location;o({lat:m?.lat?.(),lng:m?.lng?.(),formatted:g.formatted_address||s})}else o(null)})})}function Yn(){Hn();const s=typeof window<"u"&&window.__USER__||null,[a,o]=r.useState(!1);r.useEffect(()=>{Qe().then(()=>o(!0))},[]);const c=a&&Ye("einsatzboard"),h=!c,[g,m]=r.useState(null),[p,I]=r.useState([]),[j,_]=r.useState([]),[C,$]=r.useState(""),[D,z]=r.useState(""),[U,q]=r.useState(""),[V,X]=r.useState(null),[k,E]=r.useState(null),[G,A]=r.useState(""),[H,ee]=r.useState(!1),[Z,ae]=r.useState(!1),[y,ue]=r.useState(!1),[O,ie]=r.useState(30),[ge,be]=r.useState(!1),[x,F]=r.useState(!1),[te,W]=r.useState(!1),[B,Q]=r.useState(null),Y=t=>{Q(t),W(!0)},[w,P]=r.useState(window.location.hash);r.useEffect(()=>{const t=()=>P(window.location.hash);return window.addEventListener("hashchange",t),()=>window.removeEventListener("hashchange",t)},[]);const v=w.replace(/^#/,""),[n,l]=r.useState(()=>new Set),[b,N]=r.useState(0),L=r.useRef(0),R=r.useRef(new Set),[J,K]=r.useState(0);r.useEffect(()=>{document.title="Einsatzstellen-Übersicht-Feuerwehr",Mt()},[]);const{logout:ne}=fn?.()||{},me=async()=>{try{await ne?.()}finally{window.location.href="/user-login"}};r.useEffect(()=>{if(!c)return;if(!y){K(0);return}const t=setInterval(()=>K(i=>i+1),1e3);return()=>clearInterval(t)},[Ne,y]);const Pe=y?Math.max(0,O-J%Math.max(1,O)):0,{query:Ie,setQuery:Ae,predictions:Xe,getDetailsByPlaceId:$t,resetSession:Te,loading:Dt,error:et}=Tt({country:"at",debounceMs:300,minLength:3}),Me=r.useRef(null);r.useEffect(()=>{document.title="Einsatzstellen-Übersicht-Feuerwehr"},[]),r.useEffect(()=>{(async()=>{const[t,i,d]=await Promise.all([oe(),mt(),Pn()]);m(t),I(i),_(Array.isArray(d)?d:[]);try{const u=await Mn();ue(!!u.enabled),ie(Number(u.intervalSec)||30),$e.current=nt(t)}catch{}K(0)})()},[Ne]),r.useEffect(()=>{y&&(async()=>{try{(await fetch("/api/ff/status",{credentials:"include",cache:"no-store"}).then(i=>i.json()).catch(()=>({running:!1}))).running||await fetch("/api/ff/start",{method:"POST",credentials:"include"})}catch{}})()},[Ne,y,O]),r.useEffect(()=>{z(Ie||"")},[Ie]),r.useEffect(()=>{let t;const i=Math.max(5,Math.min(60,y?8:15)),d=async()=>{try{const u=new Set($e.current),f=await oe();m(f),st({oldIds:u,newBoard:f,pulseMs:8e3})}catch{}t=setTimeout(d,i*1e3)};return t=setTimeout(d,i*1e3),()=>clearTimeout(t)},[Ne,y]),r.useEffect(()=>{const t=i=>{i.altKey&&(i.key==="e"||i.key==="E")&&(i.preventDefault(),F(!0),Te())};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[Ne,Te]);const ce=g??{columns:{neu:{items:[]},"in-bearbeitung":{items:[]},erledigt:{items:[]}}},Ot=10;function Rt(t){try{const i=t?.columns||{};return[(i.neu?.items||[]).length,(i["in-bearbeitung"]?.items||[]).length,(i.erledigt?.items||[]).length].some(u=>u>=Ot)}catch{return!1}}r.useEffect(()=>{const t=Rt(ce);document.documentElement.classList.toggle("ui-dense",t)},[ce]);const[_e,tt]=r.useState(new Set),$e=r.useRef(new Set);r.useEffect(()=>{if(!_e.size)return;const t=setTimeout(()=>tt(new Set),9e3);return()=>clearTimeout(t)},[_e]);function nt(t){const i=new Set;if(!t?.columns)return i;for(const d of Object.keys(t.columns))for(const u of t.columns[d].items||[])i.add(String(u.id));return i}function st({oldIds:t,newBoard:i,pulseMs:d=8e3}){const u=Date.now(),f=nt(i),S=new Set;for(const M of f)t.has(M)||S.add(M);const T=new Set([...S].filter(M=>!R.current.has(String(M))));for(const M of S)R.current.delete(String(M));if(T.size>0&&(tt(T),N(u+d),u>=L.current))try{Un()}catch{}$e.current=f}const[ze,rt]=r.useState(!1),Lt=async()=>{if(!ze){rt(!0);try{const t=new Set($e.current),i=await fetch("/api/import/trigger",{method:"POST"});if(!i.ok){const u=await i.text().catch(()=>"");throw new Error(`Import fehlgeschlagen (HTTP ${i.status}) ${u}`)}const d=await oe();m(d),st({oldIds:t,newBoard:d,pulseMs:8e3}),K(0)}catch(t){alert(t.message||"Import fehlgeschlagen.")}finally{rt(!1)}}},[_t,at]=r.useState(!1),zt=t=>String(t).replace(/[.*+?^${}()|[\]\\]/g,"\\$&");function Ft(t,i){const d=String(i).match(/^(.*?)-(\d+)$/),u=d?d[1]:String(i);let f=d?parseInt(d[2],10):1;for(const S of t){const T=String(S.label||"").match(new RegExp("^"+zt(u)+"-(\\d+)$"));if(!T)continue;const M=parseInt(T[1],10);Number.isFinite(M)&&M>f&&(f=M)}return`${u}-${f+1}`}async function Bt(t,i){if(_t)return;const d=ve.get(t);if(d){at(!0);try{const u=Ft(p,d.label||d.id),f=await fetch("/api/vehicles",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ort:d.ort||"",label:u,mannschaft:0})}),S=await f.json().catch(()=>({}));if(!f.ok||S?.error)throw new Error(S?.error||"Clone fehlgeschlagen");const M=await(await fetch("/api/vehicles")).json();I(M);let re=S?.vehicle?.id;re||(re=M.find(we=>we.label===u&&we.ort===(d.ort||"")&&Number(we.mannschaft)===0)?.id),i&&re&&await We(i,re),m(await oe())}catch(u){alert(u.message||"Clone fehlgeschlagen")}finally{at(!1)}}}const ve=r.useMemo(()=>new Map(p.map(t=>[t.id,t])),[p]),[it,ot]=r.useState(new Map),Vt=r.useMemo(()=>{const t={};for(const[i,d]of ve.entries())t[i]=d;return t},[ve]),lt=r.useMemo(()=>{const t=new Set,i=ce?.columns||{};for(const d of Object.keys(i))for(const u of i[d].items||[])for(const f of u.assignedVehicles||[])t.add(f);return t},[ce]),je=r.useMemo(()=>p.filter(t=>t&&typeof t.id<"u"&&!lt.has(t.id)),[p,lt]),pe=r.useMemo(()=>{const t={};for(const i of je){const d=i.ort||"Unbekannt";(t[d]??=[]).push(i)}for(const i of Object.keys(t))t[i].sort((d,u)=>(d.label||d.id).localeCompare(u.label||u.id));return Object.entries(t).sort((i,d)=>i[0].localeCompare(d[0]))},[je]);r.useEffect(()=>{if(localStorage.getItem("ff_collapsed_groups")||!pe.length)return;const i=pe.map(([d])=>d);De(new Set(i)),localStorage.setItem("ff_collapsed_groups",JSON.stringify(i))},[Ne,pe]),r.useEffect(()=>{let t=setInterval(async()=>{try{const i=await fetch("/api/activity/status",{cache:"no-store"}).then(d=>d.json());typeof i?.auto?.enabled=="boolean"&&i.auto.enabled!==y&&ue(!!i.auto.enabled)}catch{}},3e3);return()=>clearInterval(t)},[Ne,y]);function Fe(t,i){for(const d of["neu","in-bearbeitung","erledigt"])if((t.columns[d].items||[]).some(u=>u?.id===i))return d;return null}function Kt(t,i){for(const d of["neu","in-bearbeitung","erledigt"]){const u=(t.columns[d].items||[]).find(f=>f?.id===i);if(u)return u}return null}function Be(t){const i=ce?.columns?.[t]?.items||[];if(t==="erledigt"){const f=i.reduce((T,M)=>T+(M.everVehicles?.length||0),0),S=i.reduce((T,M)=>T+(Number.isFinite(M?.everPersonnel)?M.everPersonnel:0),0);return{cards:i.length,units:f,persons:S}}const d=i.reduce((f,S)=>f+(S.assignedVehicles?.length||0),0),u=i.reduce((f,S)=>Number.isFinite(S?.manualPersonnel)?f+S.manualPersonnel:f+(S.assignedVehicles||[]).reduce((T,M)=>T+(ve.get(M)?.mannschaft??0),0),0);return{cards:i.length,units:d,persons:u}}const Ut=Be("neu"),Gt=Be("in-bearbeitung"),Wt=Be("erledigt"),Jt=async()=>{const t=U.replace(/^T\d+\s*,?\s*/i,"").trim(),i=(C||t).trim();if(!i){alert("Bitte Typ oder Titel angeben.");return}const d={id:`tmp-${Math.random().toString(36).slice(2,10)}`,content:i,createdAt:new Date().toISOString(),statusSince:new Date().toISOString(),assignedVehicles:[],everVehicles:[],everPersonnel:0,ort:(D||"").trim(),typ:U.trim()};ee(!0),m(u=>{if(!u)return u;const f=structuredClone(u);return f.columns.neu.items.unshift(d),f});try{let u=null;const f=Me.current;if(f?.geometry?.location?.lat&&f?.geometry?.location?.lng)u={lat:f.geometry.location.lat(),lng:f.geometry.location.lng()};else if(d.ort){const T=await qn(d.ort);T&&(u={lat:T.lat,lng:T.lng})}const S=await ht(i,"neu",0,d.ort,d.typ,u??void 0);L.current=Date.now(),S?.card?.id!=null&&R.current.add(String(S.card.id)),m(T=>{if(!T)return T;const M=structuredClone(T),re=M.columns.neu.items,ke=re.findIndex(we=>we?.id===d.id);return ke>=0?re[ke]=S.card:re.unshift(S.card),M}),$(""),Ae(""),z(""),q(""),Me.current=null,Te()}catch{m(u=>{if(!u)return u;const f=structuredClone(u);return f.columns.neu.items=f.columns.neu.items.filter(S=>S?.id!==d.id),f}),alert("Einsatz konnte nicht angelegt werden.")}finally{ee(!1)}},Ht=async t=>{try{const i=await $t(t.place_id,["formatted_address","geometry","address_components","place_id"]);Me.current=i||null;const d=i?.formatted_address||t.description;Ae(d),z(d)}catch(i){console.error("Place details failed:",i),Me.current=null,Ae(t.description),z(t.description)}finally{Te()}},Ve=t=>String(t||"").split(/[;,\n]/).map(i=>i.trim()).filter(Boolean),he=t=>String(t||"").normalize?.("NFD").replace?.(new RegExp("\\p{Diacritic}","gu"),"").replace(/^\s*FF\s+/i,"").replace(/[._\-\/]+/g," ").replace(/\s+/g," ").toLowerCase().trim();function Zt(t,i,d,u){const f=Ve(t?.alerted).map(he);if(f.length)for(const S of i){const T=f.some(re=>he(S?.ort)===re),M=f.some(re=>he(S?.label)===re);if(T||M){const re=String(S.id);d.add(re),u.has(re)||u.set(re,null)}}}async function qt(t,i){if(!(i!=="neu"||!t?.id))try{const d=await Dn(t.id),u=new Set((d?.units||[]).map(se=>String(se.unitId)));if(t?.alerted){const se=Ve(t.alerted).map(he);for(const fe of je){const Ue=se.some(Ge=>he(fe.ort)===he(Ge)),Ce=se.some(Ge=>he(fe.label)===he(Ge));(Ue||Ce)&&u.add(String(fe.id))}}l(u),N(Date.now()+3e3);const f=new Map;for(const se of d?.units||[]){const fe=Number(se?.distanceKm);f.set(String(se.unitId),Number.isFinite(fe)?fe:null)}u.size===0&&t?.alerted&&Zt(t,je,u,f),ot(f);const S=new Set((d?.units||[]).filter(se=>!se.assigned).map(se=>String(se.unitId))),T=new Set(je.map(se=>String(se.id))),M=new Set([...S,...[...u].filter(se=>T.has(se))]),re=Ve(t?.alerted).map(he),ke=new Set;if(re.length&&je.length>0)for(const[se,fe]of pe){if(fe.length===0)continue;re.some(Ce=>he(se)===he(Ce))&&ke.add(se)}const we=[];for(const[se,fe]of pe)(fe.some(Ce=>M.has(String(Ce.id)))||ke.has(se))&&we.push(se);Xt(we),clearTimeout(pulseTimerRef.current),pulseTimerRef.current=setTimeout(()=>{l(new Set),N(0),ot(new Map)},3200)}catch(d){console.error("fetchNearby failed:",d)}}const[ct,De]=r.useState(()=>{try{const t=localStorage.getItem("ff_collapsed_groups");return new Set(t?JSON.parse(t):[])}catch{return new Set}}),Qt=t=>ct.has(t),Yt=(t,i)=>{De(d=>{const u=new Set(d);return i?u.add(t):u.delete(t),localStorage.setItem("ff_collapsed_groups",JSON.stringify([...u])),u})},Xt=(t=[])=>{De(()=>{const i=pe.map(([u])=>u),d=new Set(i);for(const u of t)d.delete(u);return localStorage.setItem("ff_collapsed_groups",JSON.stringify([...d])),d})},en=(t=!0)=>{De(()=>{const i=pe.map(([u])=>u),d=t?new Set(i):new Set;return localStorage.setItem("ff_collapsed_groups",JSON.stringify([...d])),d})},tn=()=>{const t=pe.map(([d])=>d),i=t.length>0&&t.every(d=>ct.has(d));en(!i)},[Oe,Ke]=r.useState(null),[nn,Se]=r.useState(null),sn=xn(dt(kn,{activationConstraint:{distance:4}}),dt(Sn,{activationConstraint:{delay:80,tolerance:6}})),rn=t=>{const i=t?.over;if(!i){Se(null);return}const d=String(i.id||"");if(d.startsWith("col:"))Se(d.slice(4));else if(d.startsWith("card:")){const u=Fe(ce,d.slice(5));Se(u)}else Se(null)},an=async t=>{if(h){Se(null),Ke(null);return}Se(null);const{active:i,over:d}=t;if(Ke(null),!i||!d)return;const u=String(i.id||""),f=String(d.id||"");if(u.startsWith("ass:")&&f.startsWith("card:")){const[,S,T]=u.split(":"),M=f.slice(5);if(S&&T&&M&&S!==M)try{await gt(S,T);try{await xt(T)}catch{}await We(M,T),m(await oe())}catch{alert("Einheit konnte nicht umgehängt werden.")}return}if(u.startsWith("veh:")&&f.startsWith("card:")){try{await We(f.slice(5),u.slice(4)),m(await oe())}catch{alert("Einheit konnte nicht zugewiesen werden.")}return}if(u.startsWith("card:")){const S=u.slice(5),T=Fe(ce,S);if(!T)return;if(f.startsWith("col:")){const M=f.slice(4);if(T!==M)try{await Re({cardId:S,from:T,to:M,toIndex:0}),m(await oe())}catch{alert("Statuswechsel konnte nicht gespeichert werden.")}return}if(f.startsWith("card:")){const M=Fe(ce,f.slice(5));if(M)try{await Re({cardId:S,from:T,to:M,toIndex:0}),m(await oe())}catch{alert("Statuswechsel konnte nicht gespeichert werden.")}}}},on=async()=>{if(confirm("Board wirklich zurücksetzen?")){ae(!0);try{await Tn(),m(await oe())}catch{alert("Reset fehlgeschlagen.")}finally{ae(!1)}}},ln=()=>window.open($n(),"_blank","noopener,noreferrer"),cn=async()=>{try{const t=await pt({enabled:!y,intervalSec:O});ue(!!t.enabled),ie(Number(t.intervalSec)||30),K(0)}catch{alert("Konnte Auto-Import nicht ändern.")}},dn=async t=>{const i=Math.max(5,Math.min(3600,Number(t)||30));ie(i);try{await pt({enabled:y,intervalSec:i}),K(0)}catch{}},un=async({title:t,ort:i,typ:d})=>{const u=await ht(t,"neu",0,i,d);L.current=Date.now(),u?.card?.id!=null&&R.current.add(String(u.card.id)),m(f=>{if(!f)return f;const S=structuredClone(f);return S.columns.neu.items.unshift(u.card),S})},mn=t=>{q(t);const i=t.replace(/^T\d+\s*,?\s*/i,"").trim();C.trim()||$(i)};if(v.startsWith("/protokoll/edit/")){const t=v.split("/")[3],i=Number(t);return e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Protokoll – Bearbeiten"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"Zur Übersicht"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(Et,{mode:"edit",editNr:i})})]})}return v.startsWith("/protokoll/neu")?e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Protokoll – Eintrag anlegen"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"Zur Übersicht"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(Et,{mode:"create"})})]}):v.startsWith("/protokoll")?e.jsxs("div",{className:"h-screen w-screen bg-gray-100 flex flex-col",children:[e.jsxs("header",{className:"flex items-center justify-between p-3 border-b bg-white shadow",children:[e.jsx("h1",{className:"text-xl font-bold",children:"Protokoll"}),e.jsx("button",{onClick:()=>{window.location.hash="/"},className:"px-3 py-1.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white",children:"← Zurück"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3",children:e.jsx(Wn,{})})]}):e.jsxs("div",{className:"h-screen w-screen bg-gray-100 p-2 md:p-3 overflow-hidden flex flex-col",style:{fontSize:"var(--ui-scale)"},children:[!g&&e.jsx("div",{className:"fixed inset-0 z-10 bg-black/10 backdrop-blur-sm flex items-center justify-center",children:e.jsx("div",{className:"px-4 py-2 rounded-lg bg-white shadow",children:"Lade…"})}),e.jsxs("header",{className:"flex flex-wrap items-center justify-between gap-2 mb-2",children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold",children:"Einsatzstellen-Übersicht-Feuerwehr"}),e.jsxs("div",{className:"toolbar flex flex-wrap items-center gap-2",children:[e.jsx("button",{onClick:ln,className:"px-3 py-1.5 rounded-md bg-purple-600 hover:bg-purple-700 text-white",children:"PDF"}),e.jsx("button",{onClick:me,className:"px-3 py-1.5 rounded-md border border-gray-300 hover:bg-gray-100",title:s?.displayName?`Logout (${s.displayName})`:"Logout",children:"Logout"}),e.jsx("button",{onClick:()=>window.open("/api/log.csv","_blank"),className:"px-3 py-1.5 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white",title:"log.csv herunterladen",children:"Log (CSV)"}),e.jsx("button",{onClick:()=>{window.location.hash="/protokoll"},className:"px-3 py-1.5 rounded-md bg-gray-500 hover:bg-gray-600 text-white",children:"Protokoll"}),e.jsx("button",{onClick:Lt,disabled:h||ze,className:"px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-60",title:"Import sofort ausführen",children:ze?"Import…":"Import"}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm px-2 py-1 rounded-md bg-white border",children:[e.jsx("input",{type:"checkbox",checked:y,onChange:cn,disabled:h})," Auto-Import"]}),e.jsxs("label",{className:"interval-capsule flex items-center text-sm text-gray-700 bg-gray-50 border border-gray-300 rounded-md overflow-hidden",children:[e.jsx("span",{className:"pl-3 pr-2 select-none",children:"Intervall (s):"}),e.jsx("input",{type:"number",min:"5",max:"3600",value:O,onChange:t=>dn(t.target.value),disabled:h,className:`h-9 w-20 bg-white border-0 rounded-none text-center text-gray-800 
               focus:outline-none focus:ring-0 focus:border-0`})]}),e.jsx(Jn,{autoEnabled:y,remaining:Pe,disabled:h}),e.jsx("button",{onClick:on,disabled:h||Z,className:`px-3 py-1.5 rounded-md text-white ${Z?"bg-gray-400":"bg-gray-700 hover:bg-gray-800"}`,children:Z?"Reset…":"Reset"})]})]}),e.jsxs("section",{className:"mb-2 grid grid-cols-1 md:grid-cols-7 gap-2",children:[e.jsxs("select",{className:"border rounded px-2 py-1 md:col-span-2",value:U,onChange:t=>mn(t.target.value),children:[e.jsx("option",{value:"",children:"— Typ auswählen —"}),j.map(t=>e.jsx("option",{value:t,children:t},t))]}),e.jsx("input",{className:"border rounded px-2 py-1 md:col-span-2",placeholder:"Titel (wird aus Typ übernommen)",value:C,onChange:t=>$(t.target.value)}),e.jsxs("div",{className:"relative md:col-span-2",children:[e.jsx("input",{className:"border rounded px-2 py-1 w-full",placeholder:"Ort (nur Österreich)",autoComplete:"off",value:Ie,onChange:t=>Ae(t.target.value)}),Dt&&e.jsx("div",{className:"absolute z-10 mt-1 text-xs text-gray-500 bg-white border rounded px-2 py-1",children:"Suche…"}),et&&e.jsxs("div",{className:"absolute z-10 mt-1 text-xs text-red-600 bg-white border rounded px-2 py-1",children:["Fehler: ",String(et)]}),!!Xe.length&&e.jsx("ul",{className:"absolute z-10 mt-1 w-full max-h-52 overflow-auto bg-white border rounded shadow",children:Xe.map(t=>e.jsx("li",{className:"px-2 py-1 hover:bg-gray-100 cursor-pointer text-sm",onClick:()=>Ht(t),title:t.description,children:t.description},t.place_id))})]}),e.jsx("button",{className:"px-3 py-1 rounded bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60",disabled:h||H,onClick:Jt,children:H?"Wird angelegt…":"Einsatz anlegen"})]}),e.jsxs(bn,{sensors:sn,collisionDetection:t=>t?.active?.data?.current?.type==="vehicle"?yn(t):wn(t),onDragStart:t=>Ke({type:t?.active?.data?.current?.type,id:t.active.id,data:t?.active?.data?.current}),onDragOver:rn,onDragEnd:an,children:[e.jsxs("main",{className:"grid grid-cols-1 md:[grid-template-columns:minmax(180px,220px)_repeat(3,minmax(0,1fr))] gap-2 min-h-0 flex-1 overflow-hidden",children:[e.jsxs("section",{className:"bg-white rounded-xl shadow p-3 h-full flex flex-col min-h-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-semibold",children:e.jsx("button",{type:"button",onClick:tn,title:"Alle Gruppen auf/zu klappen",className:"underline decoration-dotted hover:opacity-80 focus:outline-none",children:"Einheiten (frei)"})}),c&&e.jsx("button",{onClick:()=>be(!0),className:"px-2 py-1 text-sm rounded bg-emerald-600 text-white",children:"+ Einheit"})]}),e.jsxs("div",{className:"overflow-auto pr-1 flex-1 min-h-0 space-y-3",children:[pe.length===0&&e.jsx("div",{className:"text-[0.85rem] text-gray-500 italic",children:"— alle Einheiten sind zugewiesen —"}),pe.map(([t,i])=>{const d=Qt(t);return e.jsxs("div",{className:"border border-blue-400 rounded-md",children:[e.jsxs("button",{type:"button",onClick:()=>Yt(t,!d),className:"w-full flex items-center justify-between px-2 py-2 text-left",title:d?"aufklappen":"zuklappen",children:[e.jsx("span",{className:"text-xs font-semibold text-gray-700",children:t}),e.jsx("span",{className:"group-chip",children:i.length})]}),!d&&e.jsx("div",{className:"px-2 pb-2 grid grid-cols-1 gap-1.5",children:i.map(u=>e.jsx(Cn,{editable:c,vehicle:u,pillWidthPx:160,near:n.has(String(u.id))&&Date.now()<b,distKm:it.get(String(u.id))},u.id))})]},t)})]})]}),[{id:"neu",title:"Neu",bg:"bg-red-100",totals:Ut},{id:"in-bearbeitung",title:"In Bearbeitung",bg:"bg-yellow-100",totals:Gt},{id:"erledigt",title:"Erledigt",bg:"bg-green-100",totals:Wt}].map(({id:t,title:i,bg:d,totals:u})=>e.jsx("div",{className:nn===t?"drag-over":"",children:e.jsx(Vn,{editable:c,colId:t,bg:d,title:e.jsxs("span",{className:"column-header flex items-center justify-between",children:[e.jsx("span",{className:"font-semibold",children:i}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsxs("span",{className:"kpi-badge","data-variant":"units",children:["🚒 ",u.units]}),e.jsxs("span",{className:"kpi-badge","data-variant":"persons",children:["👥 ",u.persons]}),e.jsxs("span",{className:"kpi-badge","data-variant":"cards",children:["⬛ ",u.cards]})]})]}),children:e.jsx("ul",{className:"space-y-2 overflow-y-auto overflow-x-hidden pl-1 pr-2 py-2",style:{maxHeight:"calc(100vh - 260px)"},children:e.jsx(vn,{items:(ce.columns[t].items||[]).map(f=>Zn(f.id)),strategy:Nn,children:(ce.columns[t].items||[]).map(f=>e.jsx(In,{editable:c,card:f,colId:t,vehiclesById:ve,distById:it,pillWidthPx:160,pulse:_e.has(String(f.id))&&Date.now()<b,onUnassign:async(S,T)=>{await gt(S,T);try{await xt(T)}catch{}m(await oe())},onOpenMap:S=>X({address:f.ort,card:f,board:ce,vehiclesById:Vt}),onAdvance:c?async S=>{t==="neu"?(await Re({cardId:S.id,from:"neu",to:"in-bearbeitung",toIndex:0}),m(await oe())):t==="in-bearbeitung"&&(await Re({cardId:S.id,from:"in-bearbeitung",to:"erledigt",toIndex:0}),m(await oe()))}:void 0,onEditPersonnelStart:c?(S,T)=>{E({cardId:S.id}),A(T)}:void 0,editing:k,editingValue:G,setEditingValue:A,onEditPersonnelSave:c?async S=>{try{await An(S.id,G===""?null:Number(G)),m(await oe())}finally{E(null),A("")}}:void 0,onEditPersonnelCancel:c?()=>{E(null),A("")}:void 0,onClone:Bt,onVehiclesIconClick:qt,nearIds:n,nearUntilMs:b,onShowInfo:Y},f.id))})})})},t))]}),e.jsxs(jn,{dropAnimation:{duration:180,easing:"ease-out"},children:[Oe?.type==="vehicle"&&(()=>{const t=ve.get(Oe?.data?.vehicleId);return t?e.jsx("div",{className:"pointer-events-none",children:e.jsxs("div",{style:{width:160},className:"max-w-full select-none border-2 border-red-300 rounded-2xl bg-white px-2 py-1 shadow-lg",children:[e.jsx("div",{className:"text-[13px] font-semibold leading-5 truncate",children:t.label||t.id}),e.jsxs("div",{className:"text-[12px] text-gray-600 leading-4 truncate",children:[t.ort||"—"," · 👥 ",t.mannschaft??0]})]})}):null})(),Oe?.type==="card"&&(()=>{const t=String(Oe?.id||"").replace(/^card:/,""),i=Kt(ce,t);return i?e.jsx("div",{className:"pointer-events-none w-[280px]",children:e.jsxs("div",{className:"rounded-lg bg-white shadow-xl border p-3",children:[e.jsx("div",{className:"font-semibold text-sm mb-1 truncate",children:i.content}),e.jsxs("div",{className:"text-xs text-gray-600",children:[i.assignedVehicles?.length||0," Einheiten •"," ","👥 ",Number.isFinite(i?.manualPersonnel)?i.manualPersonnel:(i.assignedVehicles||[]).reduce((d,u)=>d+(ve.get(u)?.mannschaft??0),0)]})]})}):null})()]})]}),c&&e.jsx("button",{className:"fab",title:"Einsatz anlegen",onClick:()=>F(!0),children:"＋"}),e.jsx("a",{href:"/Hilfe.pdf",target:"_blank",rel:"noopener noreferrer",className:"fixed bottom-4 right-4 px-4 py-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-lg",children:"Hilfe"}),ge&&e.jsx(zn,{onClose:()=>be(!1),onCreate:async t=>{const i=await fetch("/api/vehicles",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!i.ok){const d=await i.text().catch(()=>String(i.status));throw new Error(`HTTP ${i.status} ${d}`)}I(await mt())}}),x&&e.jsx(Bn,{onClose:()=>F(!1),onCreate:un,types:j}),V&&e.jsx(_n,{context:V,onClose:()=>X(null)}),e.jsx(Kn,{open:te,info:B||{},onClose:()=>{W(!1),Q(null)}})]})}export{Yn as default};
